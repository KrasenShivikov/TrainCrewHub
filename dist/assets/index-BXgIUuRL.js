(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();async function se(e,t){const r=new URL(e,t),s=await fetch(r);if(!s.ok)throw new Error(`Failed to load HTML from ${r.pathname}`);return s.text()}function Jr(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(r[s[n]]=e[s[n]]);return r}function Wi(e,t,r,s){function n(a){return a instanceof r?a:new r(function(i){i(a)})}return new(r||(r=Promise))(function(a,i){function o(d){try{c(s.next(d))}catch(h){i(h)}}function l(d){try{c(s.throw(d))}catch(h){i(h)}}function c(d){d.done?a(d.value):n(d.value).then(o,l)}c((s=s.apply(e,t||[])).next())})}const zi=e=>e?(...t)=>e(...t):(...t)=>fetch(...t);class Zs extends Error{constructor(t,r="FunctionsError",s){super(t),this.name=r,this.context=s}}class Vi extends Zs{constructor(t){super("Failed to send a request to the Edge Function","FunctionsFetchError",t)}}class _n extends Zs{constructor(t){super("Relay Error invoking the Edge Function","FunctionsRelayError",t)}}class wn extends Zs{constructor(t){super("Edge Function returned a non-2xx status code","FunctionsHttpError",t)}}var ks;(function(e){e.Any="any",e.ApNortheast1="ap-northeast-1",e.ApNortheast2="ap-northeast-2",e.ApSouth1="ap-south-1",e.ApSoutheast1="ap-southeast-1",e.ApSoutheast2="ap-southeast-2",e.CaCentral1="ca-central-1",e.EuCentral1="eu-central-1",e.EuWest1="eu-west-1",e.EuWest2="eu-west-2",e.EuWest3="eu-west-3",e.SaEast1="sa-east-1",e.UsEast1="us-east-1",e.UsWest1="us-west-1",e.UsWest2="us-west-2"})(ks||(ks={}));class Gi{constructor(t,{headers:r={},customFetch:s,region:n=ks.Any}={}){this.url=t,this.headers=r,this.region=n,this.fetch=zi(s)}setAuth(t){this.headers.Authorization=`Bearer ${t}`}invoke(t){return Wi(this,arguments,void 0,function*(r,s={}){var n;let a,i;try{const{headers:o,method:l,body:c,signal:d,timeout:h}=s;let u={},{region:f}=s;f||(f=this.region);const p=new URL(`${this.url}/${r}`);f&&f!=="any"&&(u["x-region"]=f,p.searchParams.set("forceFunctionRegion",f));let y;c&&(o&&!Object.prototype.hasOwnProperty.call(o,"Content-Type")||!o)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(u["Content-Type"]="application/octet-stream",y=c):typeof c=="string"?(u["Content-Type"]="text/plain",y=c):typeof FormData<"u"&&c instanceof FormData?y=c:(u["Content-Type"]="application/json",y=JSON.stringify(c)):c&&typeof c!="string"&&!(typeof Blob<"u"&&c instanceof Blob)&&!(c instanceof ArrayBuffer)&&!(typeof FormData<"u"&&c instanceof FormData)?y=JSON.stringify(c):y=c;let _=d;h&&(i=new AbortController,a=setTimeout(()=>i.abort(),h),d?(_=i.signal,d.addEventListener("abort",()=>i.abort())):_=i.signal);const g=yield this.fetch(p.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},u),this.headers),o),body:y,signal:_}).catch(k=>{throw new Vi(k)}),v=g.headers.get("x-relay-error");if(v&&v==="true")throw new _n(g);if(!g.ok)throw new wn(g);let m=((n=g.headers.get("Content-Type"))!==null&&n!==void 0?n:"text/plain").split(";")[0].trim(),w;return m==="application/json"?w=yield g.json():m==="application/octet-stream"||m==="application/pdf"?w=yield g.blob():m==="text/event-stream"?w=g:m==="multipart/form-data"?w=yield g.formData():w=yield g.text(),{data:w,error:null,response:g}}catch(o){return{data:null,error:o,response:o instanceof wn||o instanceof _n?o.context:void 0}}finally{a&&clearTimeout(a)}})}}var Ji=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}},Qi=class{constructor(e){var t,r,s;this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=new Headers(e.headers),this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=(t=e.shouldThrowOnError)!==null&&t!==void 0?t:!1,this.signal=e.signal,this.isMaybeSingle=(r=e.isMaybeSingle)!==null&&r!==void 0?r:!1,this.urlLengthLimit=(s=e.urlLengthLimit)!==null&&s!==void 0?s:8e3,e.fetch?this.fetch=e.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=new Headers(this.headers),this.headers.set(e,t),this}then(e,t){var r=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const s=this.fetch;let n=s(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async a=>{let i=null,o=null,l=null,c=a.status,d=a.statusText;if(a.ok){var h,u;if(r.method!=="HEAD"){var f;const g=await a.text();g===""||(r.headers.get("Accept")==="text/csv"||r.headers.get("Accept")&&(!((f=r.headers.get("Accept"))===null||f===void 0)&&f.includes("application/vnd.pgrst.plan+text"))?o=g:o=JSON.parse(g))}const y=(h=r.headers.get("Prefer"))===null||h===void 0?void 0:h.match(/count=(exact|planned|estimated)/),_=(u=a.headers.get("content-range"))===null||u===void 0?void 0:u.split("/");y&&_&&_.length>1&&(l=parseInt(_[1])),r.isMaybeSingle&&r.method==="GET"&&Array.isArray(o)&&(o.length>1?(i={code:"PGRST116",details:`Results contain ${o.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},o=null,l=null,c=406,d="Not Acceptable"):o.length===1?o=o[0]:o=null)}else{var p;const y=await a.text();try{i=JSON.parse(y),Array.isArray(i)&&a.status===404&&(o=[],i=null,c=200,d="OK")}catch{a.status===404&&y===""?(c=204,d="No Content"):i={message:y}}if(i&&r.isMaybeSingle&&(!(i==null||(p=i.details)===null||p===void 0)&&p.includes("0 rows"))&&(i=null,c=200,d="OK"),i&&r.shouldThrowOnError)throw new Ji(i)}return{error:i,data:o,count:l,status:c,statusText:d}});return this.shouldThrowOnError||(n=n.catch(a=>{var i;let o="",l="",c="";const d=a==null?void 0:a.cause;if(d){var h,u,f,p;const g=(h=d==null?void 0:d.message)!==null&&h!==void 0?h:"",v=(u=d==null?void 0:d.code)!==null&&u!==void 0?u:"";o=`${(f=a==null?void 0:a.name)!==null&&f!==void 0?f:"FetchError"}: ${a==null?void 0:a.message}`,o+=`

Caused by: ${(p=d==null?void 0:d.name)!==null&&p!==void 0?p:"Error"}: ${g}`,v&&(o+=` (${v})`),d!=null&&d.stack&&(o+=`
${d.stack}`)}else{var y;o=(y=a==null?void 0:a.stack)!==null&&y!==void 0?y:""}const _=this.url.toString().length;return(a==null?void 0:a.name)==="AbortError"||(a==null?void 0:a.code)==="ABORT_ERR"?(c="",l="Request was aborted (timeout or manual cancellation)",_>this.urlLengthLimit&&(l+=`. Note: Your request URL is ${_} characters, which may exceed server limits. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [many IDs])), consider using an RPC function to pass values server-side.`)):((d==null?void 0:d.name)==="HeadersOverflowError"||(d==null?void 0:d.code)==="UND_ERR_HEADERS_OVERFLOW")&&(c="",l="HTTP headers exceeded server limits (typically 16KB)",_>this.urlLengthLimit&&(l+=`. Your request URL is ${_} characters. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [200+ IDs])), consider using an RPC function instead.`)),{error:{message:`${(i=a==null?void 0:a.name)!==null&&i!==void 0?i:"FetchError"}: ${a==null?void 0:a.message}`,details:o,hint:l,code:c},data:null,count:null,status:0,statusText:""}})),n.then(e,t)}returns(){return this}overrideTypes(){return this}},Yi=class extends Qi{select(e){let t=!1;const r=(e??"*").split("").map(s=>/\s/.test(s)&&!t?"":(s==='"'&&(t=!t),s)).join("");return this.url.searchParams.set("select",r),this.headers.append("Prefer","return=representation"),this}order(e,{ascending:t=!0,nullsFirst:r,foreignTable:s,referencedTable:n=s}={}){const a=n?`${n}.order`:"order",i=this.url.searchParams.get(a);return this.url.searchParams.set(a,`${i?`${i},`:""}${e}.${t?"asc":"desc"}${r===void 0?"":r?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:r=t}={}){const s=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(s,`${e}`),this}range(e,t,{foreignTable:r,referencedTable:s=r}={}){const n=typeof s>"u"?"offset":`${s}.offset`,a=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(n,`${e}`),this.url.searchParams.set(a,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:e=!1,verbose:t=!1,settings:r=!1,buffers:s=!1,wal:n=!1,format:a="text"}={}){var i;const o=[e?"analyze":null,t?"verbose":null,r?"settings":null,s?"buffers":null,n?"wal":null].filter(Boolean).join("|"),l=(i=this.headers.get("Accept"))!==null&&i!==void 0?i:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${a}; for="${l}"; options=${o};`),a==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(e){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${e}`),this}};const Sn=new RegExp("[,()]");var ct=class extends Yi{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}regexMatch(e,t){return this.url.searchParams.append(e,`match.${t}`),this}regexIMatch(e,t){return this.url.searchParams.append(e,`imatch.${t}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}isDistinct(e,t){return this.url.searchParams.append(e,`isdistinct.${t}`),this}in(e,t){const r=Array.from(new Set(t)).map(s=>typeof s=="string"&&Sn.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`in.(${r})`),this}notIn(e,t){const r=Array.from(new Set(t)).map(s=>typeof s=="string"&&Sn.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`not.in.(${r})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:r,type:s}={}){let n="";s==="plain"?n="pl":s==="phrase"?n="ph":s==="websearch"&&(n="w");const a=r===void 0?"":`(${r})`;return this.url.searchParams.append(e,`${n}fts${a}.${t}`),this}match(e){return Object.entries(e).forEach(([t,r])=>{this.url.searchParams.append(t,`eq.${r}`)}),this}not(e,t,r){return this.url.searchParams.append(e,`not.${t}.${r}`),this}or(e,{foreignTable:t,referencedTable:r=t}={}){const s=r?`${r}.or`:"or";return this.url.searchParams.append(s,`(${e})`),this}filter(e,t,r){return this.url.searchParams.append(e,`${t}.${r}`),this}},Xi=class{constructor(e,{headers:t={},schema:r,fetch:s,urlLengthLimit:n=8e3}){this.url=e,this.headers=new Headers(t),this.schema=r,this.fetch=s,this.urlLengthLimit=n}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(e,t){const{head:r=!1,count:s}=t??{},n=r?"HEAD":"GET";let a=!1;const i=(e??"*").split("").map(c=>/\s/.test(c)&&!a?"":(c==='"'&&(a=!a),c)).join(""),{url:o,headers:l}=this.cloneRequestState();return o.searchParams.set("select",i),s&&l.append("Prefer",`count=${s}`),new ct({method:n,url:o,headers:l,schema:this.schema,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}insert(e,{count:t,defaultToNull:r=!0}={}){var s;const n="POST",{url:a,headers:i}=this.cloneRequestState();if(t&&i.append("Prefer",`count=${t}`),r||i.append("Prefer","missing=default"),Array.isArray(e)){const o=e.reduce((l,c)=>l.concat(Object.keys(c)),[]);if(o.length>0){const l=[...new Set(o)].map(c=>`"${c}"`);a.searchParams.set("columns",l.join(","))}}return new ct({method:n,url:a,headers:i,schema:this.schema,body:e,fetch:(s=this.fetch)!==null&&s!==void 0?s:fetch,urlLengthLimit:this.urlLengthLimit})}upsert(e,{onConflict:t,ignoreDuplicates:r=!1,count:s,defaultToNull:n=!0}={}){var a;const i="POST",{url:o,headers:l}=this.cloneRequestState();if(l.append("Prefer",`resolution=${r?"ignore":"merge"}-duplicates`),t!==void 0&&o.searchParams.set("on_conflict",t),s&&l.append("Prefer",`count=${s}`),n||l.append("Prefer","missing=default"),Array.isArray(e)){const c=e.reduce((d,h)=>d.concat(Object.keys(h)),[]);if(c.length>0){const d=[...new Set(c)].map(h=>`"${h}"`);o.searchParams.set("columns",d.join(","))}}return new ct({method:i,url:o,headers:l,schema:this.schema,body:e,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch,urlLengthLimit:this.urlLengthLimit})}update(e,{count:t}={}){var r;const s="PATCH",{url:n,headers:a}=this.cloneRequestState();return t&&a.append("Prefer",`count=${t}`),new ct({method:s,url:n,headers:a,schema:this.schema,body:e,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch,urlLengthLimit:this.urlLengthLimit})}delete({count:e}={}){var t;const r="DELETE",{url:s,headers:n}=this.cloneRequestState();return e&&n.append("Prefer",`count=${e}`),new ct({method:r,url:s,headers:n,schema:this.schema,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch,urlLengthLimit:this.urlLengthLimit})}};function Zt(e){"@babel/helpers - typeof";return Zt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Zt(e)}function Zi(e,t){if(Zt(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var s=r.call(e,t);if(Zt(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function eo(e){var t=Zi(e,"string");return Zt(t)=="symbol"?t:t+""}function to(e,t,r){return(t=eo(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function kn(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,s)}return r}function mr(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?kn(Object(r),!0).forEach(function(s){to(e,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):kn(Object(r)).forEach(function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s))})}return e}var ro=class Na{constructor(t,{headers:r={},schema:s,fetch:n,timeout:a,urlLengthLimit:i=8e3}={}){this.url=t,this.headers=new Headers(r),this.schemaName=s,this.urlLengthLimit=i;const o=n??globalThis.fetch;a!==void 0&&a>0?this.fetch=(l,c)=>{const d=new AbortController,h=setTimeout(()=>d.abort(),a),u=c==null?void 0:c.signal;if(u){if(u.aborted)return clearTimeout(h),o(l,c);const f=()=>{clearTimeout(h),d.abort()};return u.addEventListener("abort",f,{once:!0}),o(l,mr(mr({},c),{},{signal:d.signal})).finally(()=>{clearTimeout(h),u.removeEventListener("abort",f)})}return o(l,mr(mr({},c),{},{signal:d.signal})).finally(()=>clearTimeout(h))}:this.fetch=o}from(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new Xi(new URL(`${this.url}/${t}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}schema(t){return new Na(this.url,{headers:this.headers,schema:t,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}rpc(t,r={},{head:s=!1,get:n=!1,count:a}={}){var i;let o;const l=new URL(`${this.url}/rpc/${t}`);let c;const d=f=>f!==null&&typeof f=="object"&&(!Array.isArray(f)||f.some(d)),h=s&&Object.values(r).some(d);h?(o="POST",c=r):s||n?(o=s?"HEAD":"GET",Object.entries(r).filter(([f,p])=>p!==void 0).map(([f,p])=>[f,Array.isArray(p)?`{${p.join(",")}}`:`${p}`]).forEach(([f,p])=>{l.searchParams.append(f,p)})):(o="POST",c=r);const u=new Headers(this.headers);return h?u.set("Prefer",a?`count=${a},return=minimal`:"return=minimal"):a&&u.set("Prefer",`count=${a}`),new ct({method:o,url:l,headers:u,schema:this.schemaName,body:c,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch,urlLengthLimit:this.urlLengthLimit})}};class so{constructor(){}static detectEnvironment(){var t;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((t=navigator.userAgent)===null||t===void 0)&&t.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const r=globalThis.process;if(r){const s=r.versions;if(s&&s.node){const n=s.node,a=parseInt(n.replace(/^v/,"").split(".")[0]);return a>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${a} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${a} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const t=this.detectEnvironment();if(t.constructor)return t.constructor;let r=t.error||"WebSocket not supported in this environment.";throw t.workaround&&(r+=`

Suggested solution: ${t.workaround}`),new Error(r)}static createWebSocket(t,r){const s=this.getWebSocketConstructor();return new s(t,r)}static isWebSocketSupported(){try{const t=this.detectEnvironment();return t.type==="native"||t.type==="ws"}catch{return!1}}}const no="2.95.3",ao=`realtime-js/${no}`,io="1.0.0",Ha="2.0.0",En=Ha,Es=1e4,oo=1e3,lo=100;var Ce;(function(e){e[e.connecting=0]="connecting",e[e.open=1]="open",e[e.closing=2]="closing",e[e.closed=3]="closed"})(Ce||(Ce={}));var X;(function(e){e.closed="closed",e.errored="errored",e.joined="joined",e.joining="joining",e.leaving="leaving"})(X||(X={}));var Se;(function(e){e.close="phx_close",e.error="phx_error",e.join="phx_join",e.reply="phx_reply",e.leave="phx_leave",e.access_token="access_token"})(Se||(Se={}));var Ts;(function(e){e.websocket="websocket"})(Ts||(Ts={}));var Ge;(function(e){e.Connecting="connecting",e.Open="open",e.Closing="closing",e.Closed="closed"})(Ge||(Ge={}));class co{constructor(t){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=t??[]}encode(t,r){if(t.event===this.BROADCAST_EVENT&&!(t.payload instanceof ArrayBuffer)&&typeof t.payload.event=="string")return r(this._binaryEncodeUserBroadcastPush(t));let s=[t.join_ref,t.ref,t.topic,t.event,t.payload];return r(JSON.stringify(s))}_binaryEncodeUserBroadcastPush(t){var r;return this._isArrayBuffer((r=t.payload)===null||r===void 0?void 0:r.payload)?this._encodeBinaryUserBroadcastPush(t):this._encodeJsonUserBroadcastPush(t)}_encodeBinaryUserBroadcastPush(t){var r,s;const n=(s=(r=t.payload)===null||r===void 0?void 0:r.payload)!==null&&s!==void 0?s:new ArrayBuffer(0);return this._encodeUserBroadcastPush(t,this.BINARY_ENCODING,n)}_encodeJsonUserBroadcastPush(t){var r,s;const n=(s=(r=t.payload)===null||r===void 0?void 0:r.payload)!==null&&s!==void 0?s:{},i=new TextEncoder().encode(JSON.stringify(n)).buffer;return this._encodeUserBroadcastPush(t,this.JSON_ENCODING,i)}_encodeUserBroadcastPush(t,r,s){var n,a;const i=t.topic,o=(n=t.ref)!==null&&n!==void 0?n:"",l=(a=t.join_ref)!==null&&a!==void 0?a:"",c=t.payload.event,d=this.allowedMetadataKeys?this._pick(t.payload,this.allowedMetadataKeys):{},h=Object.keys(d).length===0?"":JSON.stringify(d);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`ref length ${o.length} exceeds maximum of 255`);if(i.length>255)throw new Error(`topic length ${i.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(h.length>255)throw new Error(`metadata length ${h.length} exceeds maximum of 255`);const u=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+o.length+i.length+c.length+h.length,f=new ArrayBuffer(this.HEADER_LENGTH+u);let p=new DataView(f),y=0;p.setUint8(y++,this.KINDS.userBroadcastPush),p.setUint8(y++,l.length),p.setUint8(y++,o.length),p.setUint8(y++,i.length),p.setUint8(y++,c.length),p.setUint8(y++,h.length),p.setUint8(y++,r),Array.from(l,g=>p.setUint8(y++,g.charCodeAt(0))),Array.from(o,g=>p.setUint8(y++,g.charCodeAt(0))),Array.from(i,g=>p.setUint8(y++,g.charCodeAt(0))),Array.from(c,g=>p.setUint8(y++,g.charCodeAt(0))),Array.from(h,g=>p.setUint8(y++,g.charCodeAt(0)));var _=new Uint8Array(f.byteLength+s.byteLength);return _.set(new Uint8Array(f),0),_.set(new Uint8Array(s),f.byteLength),_.buffer}decode(t,r){if(this._isArrayBuffer(t)){let s=this._binaryDecode(t);return r(s)}if(typeof t=="string"){const s=JSON.parse(t),[n,a,i,o,l]=s;return r({join_ref:n,ref:a,topic:i,event:o,payload:l})}return r({})}_binaryDecode(t){const r=new DataView(t),s=r.getUint8(0),n=new TextDecoder;switch(s){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(t,r,n)}}_decodeUserBroadcast(t,r,s){const n=r.getUint8(1),a=r.getUint8(2),i=r.getUint8(3),o=r.getUint8(4);let l=this.HEADER_LENGTH+4;const c=s.decode(t.slice(l,l+n));l=l+n;const d=s.decode(t.slice(l,l+a));l=l+a;const h=s.decode(t.slice(l,l+i));l=l+i;const u=t.slice(l,t.byteLength),f=o===this.JSON_ENCODING?JSON.parse(s.decode(u)):u,p={type:this.BROADCAST_EVENT,event:d,payload:f};return i>0&&(p.meta=JSON.parse(h)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:p}}_isArrayBuffer(t){var r;return t instanceof ArrayBuffer||((r=t==null?void 0:t.constructor)===null||r===void 0?void 0:r.name)==="ArrayBuffer"}_pick(t,r){return!t||typeof t!="object"?{}:Object.fromEntries(Object.entries(t).filter(([s])=>r.includes(s)))}}class Ua{constructor(t,r){this.callback=t,this.timerCalc=r,this.timer=void 0,this.tries=0,this.callback=t,this.timerCalc=r}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var V;(function(e){e.abstime="abstime",e.bool="bool",e.date="date",e.daterange="daterange",e.float4="float4",e.float8="float8",e.int2="int2",e.int4="int4",e.int4range="int4range",e.int8="int8",e.int8range="int8range",e.json="json",e.jsonb="jsonb",e.money="money",e.numeric="numeric",e.oid="oid",e.reltime="reltime",e.text="text",e.time="time",e.timestamp="timestamp",e.timestamptz="timestamptz",e.timetz="timetz",e.tsrange="tsrange",e.tstzrange="tstzrange"})(V||(V={}));const Tn=(e,t,r={})=>{var s;const n=(s=r.skipTypes)!==null&&s!==void 0?s:[];return t?Object.keys(t).reduce((a,i)=>(a[i]=uo(i,e,t,n),a),{}):{}},uo=(e,t,r,s)=>{const n=t.find(o=>o.name===e),a=n==null?void 0:n.type,i=r[e];return a&&!s.includes(a)?Fa(a,i):qs(i)},Fa=(e,t)=>{if(e.charAt(0)==="_"){const r=e.slice(1,e.length);return yo(t,r)}switch(e){case V.bool:return ho(t);case V.float4:case V.float8:case V.int2:case V.int4:case V.int8:case V.numeric:case V.oid:return fo(t);case V.json:case V.jsonb:return po(t);case V.timestamp:return mo(t);case V.abstime:case V.date:case V.daterange:case V.int4range:case V.int8range:case V.money:case V.reltime:case V.text:case V.time:case V.timestamptz:case V.timetz:case V.tsrange:case V.tstzrange:return qs(t);default:return qs(t)}},qs=e=>e,ho=e=>{switch(e){case"t":return!0;case"f":return!1;default:return e}},fo=e=>{if(typeof e=="string"){const t=parseFloat(e);if(!Number.isNaN(t))return t}return e},po=e=>{if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e},yo=(e,t)=>{if(typeof e!="string")return e;const r=e.length-1,s=e[r];if(e[0]==="{"&&s==="}"){let a;const i=e.slice(1,r);try{a=JSON.parse("["+i+"]")}catch{a=i?i.split(","):[]}return a.map(o=>Fa(t,o))}return e},mo=e=>typeof e=="string"?e.replace(" ","T"):e,Ba=e=>{const t=new URL(e);return t.protocol=t.protocol.replace(/^ws/i,"http"),t.pathname=t.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),t.pathname===""||t.pathname==="/"?t.pathname="/api/broadcast":t.pathname=t.pathname+"/api/broadcast",t.href};class as{constructor(t,r,s={},n=Es){this.channel=t,this.event=r,this.payload=s,this.timeout=n,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(t){this.timeout=t,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(t){this.payload=Object.assign(Object.assign({},this.payload),t)}receive(t,r){var s;return this._hasReceived(t)&&r((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:t,callback:r}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const t=r=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=r,this._matchReceive(r)};this.channel._on(this.refEvent,{},t),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(t,r){this.refEvent&&this.channel._trigger(this.refEvent,{status:t,response:r})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:t,response:r}){this.recHooks.filter(s=>s.status===t).forEach(s=>s.callback(r))}_hasReceived(t){return this.receivedResp&&this.receivedResp.status===t}}var qn;(function(e){e.SYNC="sync",e.JOIN="join",e.LEAVE="leave"})(qn||(qn={}));class Jt{constructor(t,r){this.channel=t,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(r==null?void 0:r.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},n=>{const{onJoin:a,onLeave:i,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Jt.syncState(this.state,n,a,i),this.pendingDiffs.forEach(l=>{this.state=Jt.syncDiff(this.state,l,a,i)}),this.pendingDiffs=[],o()}),this.channel._on(s.diff,{},n=>{const{onJoin:a,onLeave:i,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(n):(this.state=Jt.syncDiff(this.state,n,a,i),o())}),this.onJoin((n,a,i)=>{this.channel._trigger("presence",{event:"join",key:n,currentPresences:a,newPresences:i})}),this.onLeave((n,a,i)=>{this.channel._trigger("presence",{event:"leave",key:n,currentPresences:a,leftPresences:i})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(t,r,s,n){const a=this.cloneDeep(t),i=this.transformState(r),o={},l={};return this.map(a,(c,d)=>{i[c]||(l[c]=d)}),this.map(i,(c,d)=>{const h=a[c];if(h){const u=d.map(_=>_.presence_ref),f=h.map(_=>_.presence_ref),p=d.filter(_=>f.indexOf(_.presence_ref)<0),y=h.filter(_=>u.indexOf(_.presence_ref)<0);p.length>0&&(o[c]=p),y.length>0&&(l[c]=y)}else o[c]=d}),this.syncDiff(a,{joins:o,leaves:l},s,n)}static syncDiff(t,r,s,n){const{joins:a,leaves:i}={joins:this.transformState(r.joins),leaves:this.transformState(r.leaves)};return s||(s=()=>{}),n||(n=()=>{}),this.map(a,(o,l)=>{var c;const d=(c=t[o])!==null&&c!==void 0?c:[];if(t[o]=this.cloneDeep(l),d.length>0){const h=t[o].map(f=>f.presence_ref),u=d.filter(f=>h.indexOf(f.presence_ref)<0);t[o].unshift(...u)}s(o,d,l)}),this.map(i,(o,l)=>{let c=t[o];if(!c)return;const d=l.map(h=>h.presence_ref);c=c.filter(h=>d.indexOf(h.presence_ref)<0),t[o]=c,n(o,c,l),c.length===0&&delete t[o]}),t}static map(t,r){return Object.getOwnPropertyNames(t).map(s=>r(s,t[s]))}static transformState(t){return t=this.cloneDeep(t),Object.getOwnPropertyNames(t).reduce((r,s)=>{const n=t[s];return"metas"in n?r[s]=n.metas.map(a=>(a.presence_ref=a.phx_ref,delete a.phx_ref,delete a.phx_ref_prev,a)):r[s]=n,r},{})}static cloneDeep(t){return JSON.parse(JSON.stringify(t))}onJoin(t){this.caller.onJoin=t}onLeave(t){this.caller.onLeave=t}onSync(t){this.caller.onSync=t}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Ln;(function(e){e.ALL="*",e.INSERT="INSERT",e.UPDATE="UPDATE",e.DELETE="DELETE"})(Ln||(Ln={}));var Qt;(function(e){e.BROADCAST="broadcast",e.PRESENCE="presence",e.POSTGRES_CHANGES="postgres_changes",e.SYSTEM="system"})(Qt||(Qt={}));var Le;(function(e){e.SUBSCRIBED="SUBSCRIBED",e.TIMED_OUT="TIMED_OUT",e.CLOSED="CLOSED",e.CHANNEL_ERROR="CHANNEL_ERROR"})(Le||(Le={}));class ft{constructor(t,r={config:{}},s){var n,a;if(this.topic=t,this.params=r,this.socket=s,this.bindings={},this.state=X.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=t.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},r.config),this.timeout=this.socket.timeout,this.joinPush=new as(this,Se.join,this.params,this.timeout),this.rejoinTimer=new Ua(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=X.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(i=>i.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=X.closed,this.socket._remove(this)}),this._onError(i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=X.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=X.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=X.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Se.reply,{},(i,o)=>{this._trigger(this._replyEventName(o),i)}),this.presence=new Jt(this),this.broadcastEndpointURL=Ba(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((a=(n=this.params.config)===null||n===void 0?void 0:n.broadcast)===null||a===void 0)&&a.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(t,r=this.timeout){var s,n,a;if(this.socket.isConnected()||this.socket.connect(),this.state==X.closed){const{config:{broadcast:i,presence:o,private:l}}=this.params,c=(n=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(f=>f.filter))!==null&&n!==void 0?n:[],d=!!this.bindings[Qt.PRESENCE]&&this.bindings[Qt.PRESENCE].length>0||((a=this.params.config.presence)===null||a===void 0?void 0:a.enabled)===!0,h={},u={broadcast:i,presence:Object.assign(Object.assign({},o),{enabled:d}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(h.access_token=this.socket.accessTokenValue),this._onError(f=>t==null?void 0:t(Le.CHANNEL_ERROR,f)),this._onClose(()=>t==null?void 0:t(Le.CLOSED)),this.updateJoinPayload(Object.assign({config:u},h)),this.joinedOnce=!0,this._rejoin(r),this.joinPush.receive("ok",async({postgres_changes:f})=>{var p;if(this.socket._isManualToken()||this.socket.setAuth(),f===void 0){t==null||t(Le.SUBSCRIBED);return}else{const y=this.bindings.postgres_changes,_=(p=y==null?void 0:y.length)!==null&&p!==void 0?p:0,g=[];for(let v=0;v<_;v++){const m=y[v],{filter:{event:w,schema:k,table:E,filter:q}}=m,L=f&&f[v];if(L&&L.event===w&&ft.isFilterValueEqual(L.schema,k)&&ft.isFilterValueEqual(L.table,E)&&ft.isFilterValueEqual(L.filter,q))g.push(Object.assign(Object.assign({},m),{id:L.id}));else{this.unsubscribe(),this.state=X.errored,t==null||t(Le.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=g,t&&t(Le.SUBSCRIBED);return}}).receive("error",f=>{this.state=X.errored,t==null||t(Le.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(f).join(", ")||"error")))}).receive("timeout",()=>{t==null||t(Le.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(t,r={}){return await this.send({type:"presence",event:"track",payload:t},r.timeout||this.timeout)}async untrack(t={}){return await this.send({type:"presence",event:"untrack"},t)}on(t,r,s){return this.state===X.joined&&t===Qt.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(t,r,s)}async httpSend(t,r,s={}){var n;if(r==null)return Promise.reject("Payload is required for httpSend()");const a={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(a.Authorization=`Bearer ${this.socket.accessTokenValue}`);const i={method:"POST",headers:a,body:JSON.stringify({messages:[{topic:this.subTopic,event:t,payload:r,private:this.private}]})},o=await this._fetchWithTimeout(this.broadcastEndpointURL,i,(n=s.timeout)!==null&&n!==void 0?n:this.timeout);if(o.status===202)return{success:!0};let l=o.statusText;try{const c=await o.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(t,r={}){var s,n;if(!this._canPush()&&t.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:a,payload:i}=t,o={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(o.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:o,body:JSON.stringify({messages:[{topic:this.subTopic,event:a,payload:i,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(s=r.timeout)!==null&&s!==void 0?s:this.timeout);return await((n=c.body)===null||n===void 0?void 0:n.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(a=>{var i,o,l;const c=this._push(t.type,t,r.timeout||this.timeout);t.type==="broadcast"&&!(!((l=(o=(i=this.params)===null||i===void 0?void 0:i.config)===null||o===void 0?void 0:o.broadcast)===null||l===void 0)&&l.ack)&&a("ok"),c.receive("ok",()=>a("ok")),c.receive("error",()=>a("error")),c.receive("timeout",()=>a("timed out"))})}updateJoinPayload(t){this.joinPush.updatePayload(t)}unsubscribe(t=this.timeout){this.state=X.leaving;const r=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Se.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(n=>{s=new as(this,Se.leave,{},t),s.receive("ok",()=>{r(),n("ok")}).receive("timeout",()=>{r(),n("timed out")}).receive("error",()=>{n("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{s==null||s.destroy()})}teardown(){this.pushBuffer.forEach(t=>t.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=X.closed,this.bindings={}}async _fetchWithTimeout(t,r,s){const n=new AbortController,a=setTimeout(()=>n.abort(),s),i=await this.socket.fetch(t,Object.assign(Object.assign({},r),{signal:n.signal}));return clearTimeout(a),i}_push(t,r,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${t}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let n=new as(this,t,r,s);return this._canPush()?n.send():this._addToPushBuffer(n),n}_addToPushBuffer(t){if(t.startTimeout(),this.pushBuffer.push(t),this.pushBuffer.length>lo){const r=this.pushBuffer.shift();r&&(r.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${r.event}`,r.payload))}}_onMessage(t,r,s){return r}_isMember(t){return this.topic===t}_joinRef(){return this.joinPush.ref}_trigger(t,r,s){var n,a;const i=t.toLocaleLowerCase(),{close:o,error:l,leave:c,join:d}=Se;if(s&&[o,l,c,d].indexOf(i)>=0&&s!==this._joinRef())return;let u=this._onMessage(i,r,s);if(r&&!u)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(i)?(n=this.bindings.postgres_changes)===null||n===void 0||n.filter(f=>{var p,y,_;return((p=f.filter)===null||p===void 0?void 0:p.event)==="*"||((_=(y=f.filter)===null||y===void 0?void 0:y.event)===null||_===void 0?void 0:_.toLocaleLowerCase())===i}).map(f=>f.callback(u,s)):(a=this.bindings[i])===null||a===void 0||a.filter(f=>{var p,y,_,g,v,m;if(["broadcast","presence","postgres_changes"].includes(i))if("id"in f){const w=f.id,k=(p=f.filter)===null||p===void 0?void 0:p.event;return w&&((y=r.ids)===null||y===void 0?void 0:y.includes(w))&&(k==="*"||(k==null?void 0:k.toLocaleLowerCase())===((_=r.data)===null||_===void 0?void 0:_.type.toLocaleLowerCase()))}else{const w=(v=(g=f==null?void 0:f.filter)===null||g===void 0?void 0:g.event)===null||v===void 0?void 0:v.toLocaleLowerCase();return w==="*"||w===((m=r==null?void 0:r.event)===null||m===void 0?void 0:m.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===i}).map(f=>{if(typeof u=="object"&&"ids"in u){const p=u.data,{schema:y,table:_,commit_timestamp:g,type:v,errors:m}=p;u=Object.assign(Object.assign({},{schema:y,table:_,commit_timestamp:g,eventType:v,new:{},old:{},errors:m}),this._getPayloadRecords(p))}f.callback(u,s)})}_isClosed(){return this.state===X.closed}_isJoined(){return this.state===X.joined}_isJoining(){return this.state===X.joining}_isLeaving(){return this.state===X.leaving}_replyEventName(t){return`chan_reply_${t}`}_on(t,r,s){const n=t.toLocaleLowerCase(),a={type:n,filter:r,callback:s};return this.bindings[n]?this.bindings[n].push(a):this.bindings[n]=[a],this}_off(t,r){const s=t.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(n=>{var a;return!(((a=n.type)===null||a===void 0?void 0:a.toLocaleLowerCase())===s&&ft.isEqual(n.filter,r))})),this}static isEqual(t,r){if(Object.keys(t).length!==Object.keys(r).length)return!1;for(const s in t)if(t[s]!==r[s])return!1;return!0}static isFilterValueEqual(t,r){return(t??void 0)===(r??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(t){this._on(Se.close,{},t)}_onError(t){this._on(Se.error,{},r=>t(r))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(t=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=X.joining,this.joinPush.resend(t))}_getPayloadRecords(t){const r={new:{},old:{}};return(t.type==="INSERT"||t.type==="UPDATE")&&(r.new=Tn(t.columns,t.record)),(t.type==="UPDATE"||t.type==="DELETE")&&(r.old=Tn(t.columns,t.old_record)),r}}const is=()=>{},gr={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},go=[1e3,2e3,5e3,1e4],bo=1e4,vo=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class _o{constructor(t,r){var s;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Es,this.transport=null,this.heartbeatIntervalMs=gr.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=is,this.ref=0,this.reconnectTimer=null,this.vsn=En,this.logger=is,this.conn=null,this.sendBuffer=[],this.serializer=new co,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=n=>n?(...a)=>n(...a):(...a)=>fetch(...a),!(!((s=r==null?void 0:r.params)===null||s===void 0)&&s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=r.params.apikey,this.endPoint=`${t}/${Ts.websocket}`,this.httpEndpoint=Ba(t),this._initializeOptions(r),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(r==null?void 0:r.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=so.createWebSocket(this.endpointURL())}catch(t){this._setConnectionState("disconnected");const r=t.message;throw r.includes("Node.js")?new Error(`${r}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${r}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(t,r){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(t?this.conn.close(t,r??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(t){const r=await t.unsubscribe();return r==="ok"&&this._remove(t),this.channels.length===0&&this.disconnect(),r}async removeAllChannels(){const t=await Promise.all(this.channels.map(r=>r.unsubscribe()));return this.channels=[],this.disconnect(),t}log(t,r,s){this.logger(t,r,s)}connectionState(){switch(this.conn&&this.conn.readyState){case Ce.connecting:return Ge.Connecting;case Ce.open:return Ge.Open;case Ce.closing:return Ge.Closing;default:return Ge.Closed}}isConnected(){return this.connectionState()===Ge.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(t,r={config:{}}){const s=`realtime:${t}`,n=this.getChannels().find(a=>a.topic===s);if(n)return n;{const a=new ft(`realtime:${t}`,r,this);return this.channels.push(a),a}}push(t){const{topic:r,event:s,payload:n,ref:a}=t,i=()=>{this.encode(t,o=>{var l;(l=this.conn)===null||l===void 0||l.send(o)})};this.log("push",`${r} ${s} (${a})`,n),this.isConnected()?i():this.sendBuffer.push(i)}async setAuth(t=null){this._authPromise=this._performAuth(t);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var t;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(r){this.log("error","error in heartbeat callback",r)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(r){this.log("error","error in heartbeat callback",r)}this._wasManualDisconnect=!1,(t=this.conn)===null||t===void 0||t.close(oo,"heartbeat timeout"),setTimeout(()=>{var r;this.isConnected()||(r=this.reconnectTimer)===null||r===void 0||r.scheduleTimeout()},gr.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(r){this.log("error","error in heartbeat callback",r)}this._setAuthSafely("heartbeat")}onHeartbeat(t){this.heartbeatCallback=t}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(t=>t()),this.sendBuffer=[])}_makeRef(){let t=this.ref+1;return t===this.ref?this.ref=0:this.ref=t,this.ref.toString()}_leaveOpenTopic(t){let r=this.channels.find(s=>s.topic===t&&(s._isJoined()||s._isJoining()));r&&(this.log("transport",`leaving duplicate topic "${t}"`),r.unsubscribe())}_remove(t){this.channels=this.channels.filter(r=>r.topic!==t.topic)}_onConnMessage(t){this.decode(t.data,r=>{if(r.topic==="phoenix"&&r.event==="phx_reply"&&r.ref&&r.ref===this.pendingHeartbeatRef){const c=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(r.payload.status==="ok"?"ok":"error",c)}catch(d){this.log("error","error in heartbeat callback",d)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:s,event:n,payload:a,ref:i}=r,o=i?`(${i})`:"",l=a.status||"";this.log("receive",`${l} ${s} ${n} ${o}`.trim(),a),this.channels.filter(c=>c._isMember(s)).forEach(c=>c._trigger(n,a,i)),this._triggerStateCallbacks("message",r)})}_clearTimer(t){var r;t==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):t==="reconnect"&&((r=this.reconnectTimer)===null||r===void 0||r.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=t=>this._onConnError(t),this.conn.onmessage=t=>this._onConnMessage(t),this.conn.onclose=t=>this._onConnClose(t),this.conn.readyState===Ce.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===Ce.open||this.conn.readyState===Ce.connecting)try{this.conn.close()}catch(t){this.log("error","Error closing connection",t)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(t=>t.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(r=>{this.log("error","error waiting for auth on connect",r),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const t=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(t),this.workerRef.onerror=r=>{this.log("worker","worker error",r.message),this._terminateWorker()},this.workerRef.onmessage=r=>{r.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(t){var r;this._setConnectionState("disconnected"),this.log("transport","close",t),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(r=this.reconnectTimer)===null||r===void 0||r.scheduleTimeout(),this._triggerStateCallbacks("close",t)}_onConnError(t){this._setConnectionState("disconnected"),this.log("transport",`${t}`),this._triggerChanError(),this._triggerStateCallbacks("error",t);try{this.heartbeatCallback("error")}catch(r){this.log("error","error in heartbeat callback",r)}}_triggerChanError(){this.channels.forEach(t=>t._trigger(Se.error))}_appendParams(t,r){if(Object.keys(r).length===0)return t;const s=t.match(/\?/)?"&":"?",n=new URLSearchParams(r);return`${t}${s}${n}`}_workerObjectUrl(t){let r;if(t)r=t;else{const s=new Blob([vo],{type:"application/javascript"});r=URL.createObjectURL(s)}return r}_setConnectionState(t,r=!1){this._connectionState=t,t==="connecting"?this._wasManualDisconnect=!1:t==="disconnecting"&&(this._wasManualDisconnect=r)}async _performAuth(t=null){let r,s=!1;if(t)r=t,s=!0;else if(this.accessToken)try{r=await this.accessToken()}catch(n){this.log("error","Error fetching access token from callback",n),r=this.accessTokenValue}else r=this.accessTokenValue;s?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=r&&(this.accessTokenValue=r,this.channels.forEach(n=>{const a={access_token:r,version:ao};r&&n.updateJoinPayload(a),n.joinedOnce&&n._isJoined()&&n._push(Se.access_token,{access_token:r})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(t="general"){this._isManualToken()||this.setAuth().catch(r=>{this.log("error",`Error setting auth in ${t}`,r)})}_triggerStateCallbacks(t,r){try{this.stateChangeCallbacks[t].forEach(s=>{try{s(r)}catch(n){this.log("error",`error in ${t} callback`,n)}})}catch(s){this.log("error",`error triggering ${t} callbacks`,s)}}_setupReconnectionTimer(){this.reconnectTimer=new Ua(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},gr.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(t){var r,s,n,a,i,o,l,c,d,h,u,f;switch(this.transport=(r=t==null?void 0:t.transport)!==null&&r!==void 0?r:null,this.timeout=(s=t==null?void 0:t.timeout)!==null&&s!==void 0?s:Es,this.heartbeatIntervalMs=(n=t==null?void 0:t.heartbeatIntervalMs)!==null&&n!==void 0?n:gr.HEARTBEAT_INTERVAL,this.worker=(a=t==null?void 0:t.worker)!==null&&a!==void 0?a:!1,this.accessToken=(i=t==null?void 0:t.accessToken)!==null&&i!==void 0?i:null,this.heartbeatCallback=(o=t==null?void 0:t.heartbeatCallback)!==null&&o!==void 0?o:is,this.vsn=(l=t==null?void 0:t.vsn)!==null&&l!==void 0?l:En,t!=null&&t.params&&(this.params=t.params),t!=null&&t.logger&&(this.logger=t.logger),(t!=null&&t.logLevel||t!=null&&t.log_level)&&(this.logLevel=t.logLevel||t.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=t==null?void 0:t.reconnectAfterMs)!==null&&c!==void 0?c:p=>go[p-1]||bo,this.vsn){case io:this.encode=(d=t==null?void 0:t.encode)!==null&&d!==void 0?d:(p,y)=>y(JSON.stringify(p)),this.decode=(h=t==null?void 0:t.decode)!==null&&h!==void 0?h:(p,y)=>y(JSON.parse(p));break;case Ha:this.encode=(u=t==null?void 0:t.encode)!==null&&u!==void 0?u:this.serializer.encode.bind(this.serializer),this.decode=(f=t==null?void 0:t.decode)!==null&&f!==void 0?f:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=t==null?void 0:t.workerUrl}}}var er=class extends Error{constructor(e,t){var r;super(e),this.name="IcebergError",this.status=t.status,this.icebergType=t.icebergType,this.icebergCode=t.icebergCode,this.details=t.details,this.isCommitStateUnknown=t.icebergType==="CommitStateUnknownException"||[500,502,504].includes(t.status)&&((r=t.icebergType)==null?void 0:r.includes("CommitState"))===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function wo(e,t,r){const s=new URL(t,e);if(r)for(const[n,a]of Object.entries(r))a!==void 0&&s.searchParams.set(n,a);return s.toString()}async function So(e){return!e||e.type==="none"?{}:e.type==="bearer"?{Authorization:`Bearer ${e.token}`}:e.type==="header"?{[e.name]:e.value}:e.type==="custom"?await e.getHeaders():{}}function ko(e){const t=e.fetchImpl??globalThis.fetch;return{async request({method:r,path:s,query:n,body:a,headers:i}){const o=wo(e.baseUrl,s,n),l=await So(e.auth),c=await t(o,{method:r,headers:{...a?{"Content-Type":"application/json"}:{},...l,...i},body:a?JSON.stringify(a):void 0}),d=await c.text(),h=(c.headers.get("content-type")||"").includes("application/json"),u=h&&d?JSON.parse(d):d;if(!c.ok){const f=h?u:void 0,p=f==null?void 0:f.error;throw new er((p==null?void 0:p.message)??`Request failed with status ${c.status}`,{status:c.status,icebergType:p==null?void 0:p.type,icebergCode:p==null?void 0:p.code,details:f})}return{status:c.status,headers:c.headers,data:u}}}}function br(e){return e.join("")}var Eo=class{constructor(e,t=""){this.client=e,this.prefix=t}async listNamespaces(e){const t=e?{parent:br(e.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:t})).data.namespaces.map(s=>({namespace:s}))}async createNamespace(e,t){const r={namespace:e.namespace,properties:t==null?void 0:t.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:r})).data}async dropNamespace(e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${br(e.namespace)}`})}async loadNamespaceMetadata(e){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${br(e.namespace)}`})).data.properties}}async namespaceExists(e){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${br(e.namespace)}`}),!0}catch(t){if(t instanceof er&&t.status===404)return!1;throw t}}async createNamespaceIfNotExists(e,t){try{return await this.createNamespace(e,t)}catch(r){if(r instanceof er&&r.status===409)return;throw r}}};function rt(e){return e.join("")}var To=class{constructor(e,t="",r){this.client=e,this.prefix=t,this.accessDelegation=r}async listTables(e){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${rt(e.namespace)}/tables`})).data.identifiers}async createTable(e,t){const r={};return this.accessDelegation&&(r["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${rt(e.namespace)}/tables`,body:t,headers:r})).data.metadata}async updateTable(e,t){const r=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${rt(e.namespace)}/tables/${e.name}`,body:t});return{"metadata-location":r.data["metadata-location"],metadata:r.data.metadata}}async dropTable(e,t){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${rt(e.namespace)}/tables/${e.name}`,query:{purgeRequested:String((t==null?void 0:t.purge)??!1)}})}async loadTable(e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${rt(e.namespace)}/tables/${e.name}`,headers:t})).data.metadata}async tableExists(e){const t={};this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${rt(e.namespace)}/tables/${e.name}`,headers:t}),!0}catch(r){if(r instanceof er&&r.status===404)return!1;throw r}}async createTableIfNotExists(e,t){try{return await this.createTable(e,t)}catch(r){if(r instanceof er&&r.status===409)return await this.loadTable({namespace:e.namespace,name:t.name});throw r}}},qo=class{constructor(e){var s;let t="v1";e.catalogName&&(t+=`/${e.catalogName}`);const r=e.baseUrl.endsWith("/")?e.baseUrl:`${e.baseUrl}/`;this.client=ko({baseUrl:r,auth:e.auth,fetchImpl:e.fetch}),this.accessDelegation=(s=e.accessDelegation)==null?void 0:s.join(","),this.namespaceOps=new Eo(this.client,t),this.tableOps=new To(this.client,t,this.accessDelegation)}async listNamespaces(e){return this.namespaceOps.listNamespaces(e)}async createNamespace(e,t){return this.namespaceOps.createNamespace(e,t)}async dropNamespace(e){await this.namespaceOps.dropNamespace(e)}async loadNamespaceMetadata(e){return this.namespaceOps.loadNamespaceMetadata(e)}async listTables(e){return this.tableOps.listTables(e)}async createTable(e,t){return this.tableOps.createTable(e,t)}async updateTable(e,t){return this.tableOps.updateTable(e,t)}async dropTable(e,t){await this.tableOps.dropTable(e,t)}async loadTable(e){return this.tableOps.loadTable(e)}async namespaceExists(e){return this.namespaceOps.namespaceExists(e)}async tableExists(e){return this.tableOps.tableExists(e)}async createNamespaceIfNotExists(e,t){return this.namespaceOps.createNamespaceIfNotExists(e,t)}async createTableIfNotExists(e,t){return this.tableOps.createTableIfNotExists(e,t)}},Qr=class extends Error{constructor(e,t="storage",r,s){super(e),this.__isStorageError=!0,this.namespace=t,this.name=t==="vectors"?"StorageVectorsError":"StorageError",this.status=r,this.statusCode=s}};function Yr(e){return typeof e=="object"&&e!==null&&"__isStorageError"in e}var vr=class extends Qr{constructor(e,t,r,s="storage"){super(e,s,t,r),this.name=s==="vectors"?"StorageVectorsApiError":"StorageApiError",this.status=t,this.statusCode=r}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},Ka=class extends Qr{constructor(e,t,r="storage"){super(e,r),this.name=r==="vectors"?"StorageVectorsUnknownError":"StorageUnknownError",this.originalError=t}};const Lo=e=>e?(...t)=>e(...t):(...t)=>fetch(...t),$o=e=>{if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},Ls=e=>{if(Array.isArray(e))return e.map(r=>Ls(r));if(typeof e=="function"||e!==Object(e))return e;const t={};return Object.entries(e).forEach(([r,s])=>{const n=r.replace(/([-_][a-z])/gi,a=>a.toUpperCase().replace(/[-_]/g,""));t[n]=Ls(s)}),t},Ao=e=>!e||typeof e!="string"||e.length===0||e.length>100||e.trim()!==e||e.includes("/")||e.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(e);function tr(e){"@babel/helpers - typeof";return tr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},tr(e)}function xo(e,t){if(tr(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var s=r.call(e,t);if(tr(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function Ro(e){var t=xo(e,"string");return tr(t)=="symbol"?t:t+""}function Io(e,t,r){return(t=Ro(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function $n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,s)}return r}function N(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?$n(Object(r),!0).forEach(function(s){Io(e,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):$n(Object(r)).forEach(function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s))})}return e}const An=e=>{var t;return e.msg||e.message||e.error_description||(typeof e.error=="string"?e.error:(t=e.error)===null||t===void 0?void 0:t.message)||JSON.stringify(e)},Co=async(e,t,r,s)=>{if(e&&typeof e=="object"&&"status"in e&&"ok"in e&&typeof e.status=="number"&&!(r!=null&&r.noResolveJson)){const n=e,a=n.status||500;if(typeof n.json=="function")n.json().then(i=>{const o=(i==null?void 0:i.statusCode)||(i==null?void 0:i.code)||a+"";t(new vr(An(i),a,o,s))}).catch(()=>{if(s==="vectors"){const i=a+"";t(new vr(n.statusText||`HTTP ${a} error`,a,i,s))}else{const i=a+"";t(new vr(n.statusText||`HTTP ${a} error`,a,i,s))}});else{const i=a+"";t(new vr(n.statusText||`HTTP ${a} error`,a,i,s))}}else t(new Ka(An(e),e,s))},Oo=(e,t,r,s)=>{const n={method:e,headers:(t==null?void 0:t.headers)||{}};return e==="GET"||e==="HEAD"||!s?N(N({},n),r):($o(s)?(n.headers=N({"Content-Type":"application/json"},t==null?void 0:t.headers),n.body=JSON.stringify(s)):n.body=s,t!=null&&t.duplex&&(n.duplex=t.duplex),N(N({},n),r))};async function Mt(e,t,r,s,n,a,i){return new Promise((o,l)=>{e(r,Oo(t,s,n,a)).then(c=>{if(!c.ok)throw c;if(s!=null&&s.noResolveJson)return c;if(i==="vectors"){const d=c.headers.get("content-type");if(c.headers.get("content-length")==="0"||c.status===204)return{};if(!d||!d.includes("application/json"))return{}}return c.json()}).then(c=>o(c)).catch(c=>Co(c,l,s,i))})}function Wa(e="storage"){return{get:async(t,r,s,n)=>Mt(t,"GET",r,s,n,void 0,e),post:async(t,r,s,n,a)=>Mt(t,"POST",r,n,a,s,e),put:async(t,r,s,n,a)=>Mt(t,"PUT",r,n,a,s,e),head:async(t,r,s,n)=>Mt(t,"HEAD",r,N(N({},s),{},{noResolveJson:!0}),n,void 0,e),remove:async(t,r,s,n,a)=>Mt(t,"DELETE",r,n,a,s,e)}}const Po=Wa("storage"),{get:rr,post:we,put:$s,head:Do,remove:en}=Po,pe=Wa("vectors");var Ot=class{constructor(e,t={},r,s="storage"){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.fetch=Lo(r),this.namespace=s}throwOnError(){return this.shouldThrowOnError=!0,this}async handleOperation(e){var t=this;try{return{data:await e(),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Yr(r))return{data:null,error:r};throw r}}},Mo=class{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t}then(e,t){return this.execute().then(e,t)}async execute(){var e=this;try{return{data:(await e.downloadFn()).body,error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Yr(t))return{data:null,error:t};throw t}}};let za;za=Symbol.toStringTag;var jo=class{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t,this[za]="BlobDownloadBuilder",this.promise=null}asStream(){return new Mo(this.downloadFn,this.shouldThrowOnError)}then(e,t){return this.getPromise().then(e,t)}catch(e){return this.getPromise().catch(e)}finally(e){return this.getPromise().finally(e)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var e=this;try{return{data:await(await e.downloadFn()).blob(),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Yr(t))return{data:null,error:t};throw t}}};const No={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},xn={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var Ho=class extends Ot{constructor(e,t={},r,s){super(e,t,s,"storage"),this.bucketId=r}async uploadOrUpdate(e,t,r,s){var n=this;return n.handleOperation(async()=>{let a;const i=N(N({},xn),s);let o=N(N({},n.headers),e==="POST"&&{"x-upsert":String(i.upsert)});const l=i.metadata;typeof Blob<"u"&&r instanceof Blob?(a=new FormData,a.append("cacheControl",i.cacheControl),l&&a.append("metadata",n.encodeMetadata(l)),a.append("",r)):typeof FormData<"u"&&r instanceof FormData?(a=r,a.has("cacheControl")||a.append("cacheControl",i.cacheControl),l&&!a.has("metadata")&&a.append("metadata",n.encodeMetadata(l))):(a=r,o["cache-control"]=`max-age=${i.cacheControl}`,o["content-type"]=i.contentType,l&&(o["x-metadata"]=n.toBase64(n.encodeMetadata(l))),(typeof ReadableStream<"u"&&a instanceof ReadableStream||a&&typeof a=="object"&&"pipe"in a&&typeof a.pipe=="function")&&!i.duplex&&(i.duplex="half")),s!=null&&s.headers&&(o=N(N({},o),s.headers));const c=n._removeEmptyFolders(t),d=n._getFinalPath(c),h=await(e=="PUT"?$s:we)(n.fetch,`${n.url}/object/${d}`,a,N({headers:o},i!=null&&i.duplex?{duplex:i.duplex}:{}));return{path:c,id:h.Id,fullPath:h.Key}})}async upload(e,t,r){return this.uploadOrUpdate("POST",e,t,r)}async uploadToSignedUrl(e,t,r,s){var n=this;const a=n._removeEmptyFolders(e),i=n._getFinalPath(a),o=new URL(n.url+`/object/upload/sign/${i}`);return o.searchParams.set("token",t),n.handleOperation(async()=>{let l;const c=N({upsert:xn.upsert},s),d=N(N({},n.headers),{"x-upsert":String(c.upsert)});return typeof Blob<"u"&&r instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",r)):typeof FormData<"u"&&r instanceof FormData?(l=r,l.append("cacheControl",c.cacheControl)):(l=r,d["cache-control"]=`max-age=${c.cacheControl}`,d["content-type"]=c.contentType),{path:a,fullPath:(await $s(n.fetch,o.toString(),l,{headers:d})).Key}})}async createSignedUploadUrl(e,t){var r=this;return r.handleOperation(async()=>{let s=r._getFinalPath(e);const n=N({},r.headers);t!=null&&t.upsert&&(n["x-upsert"]="true");const a=await we(r.fetch,`${r.url}/object/upload/sign/${s}`,{},{headers:n}),i=new URL(r.url+a.url),o=i.searchParams.get("token");if(!o)throw new Qr("No token returned by API");return{signedUrl:i.toString(),path:e,token:o}})}async update(e,t,r){return this.uploadOrUpdate("PUT",e,t,r)}async move(e,t,r){var s=this;return s.handleOperation(async()=>await we(s.fetch,`${s.url}/object/move`,{bucketId:s.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r==null?void 0:r.destinationBucket},{headers:s.headers}))}async copy(e,t,r){var s=this;return s.handleOperation(async()=>({path:(await we(s.fetch,`${s.url}/object/copy`,{bucketId:s.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r==null?void 0:r.destinationBucket},{headers:s.headers})).Key}))}async createSignedUrl(e,t,r){var s=this;return s.handleOperation(async()=>{let n=s._getFinalPath(e),a=await we(s.fetch,`${s.url}/object/sign/${n}`,N({expiresIn:t},r!=null&&r.transform?{transform:r.transform}:{}),{headers:s.headers});const i=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return{signedUrl:encodeURI(`${s.url}${a.signedURL}${i}`)}})}async createSignedUrls(e,t,r){var s=this;return s.handleOperation(async()=>{const n=await we(s.fetch,`${s.url}/object/sign/${s.bucketId}`,{expiresIn:t,paths:e},{headers:s.headers}),a=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return n.map(i=>N(N({},i),{},{signedUrl:i.signedURL?encodeURI(`${s.url}${i.signedURL}${a}`):null}))})}download(e,t,r){const s=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",n=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),a=n?`?${n}`:"",i=this._getFinalPath(e),o=()=>rr(this.fetch,`${this.url}/${s}/${i}${a}`,{headers:this.headers,noResolveJson:!0},r);return new jo(o,this.shouldThrowOnError)}async info(e){var t=this;const r=t._getFinalPath(e);return t.handleOperation(async()=>Ls(await rr(t.fetch,`${t.url}/object/info/${r}`,{headers:t.headers})))}async exists(e){var t=this;const r=t._getFinalPath(e);try{return await Do(t.fetch,`${t.url}/object/${r}`,{headers:t.headers}),{data:!0,error:null}}catch(s){if(t.shouldThrowOnError)throw s;if(Yr(s)&&s instanceof Ka){const n=s.originalError;if([400,404].includes(n==null?void 0:n.status))return{data:!1,error:s}}throw s}}getPublicUrl(e,t){const r=this._getFinalPath(e),s=[],n=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";n!==""&&s.push(n);const a=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});i!==""&&s.push(i);let o=s.join("&");return o!==""&&(o=`?${o}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${r}${o}`)}}}async remove(e){var t=this;return t.handleOperation(async()=>await en(t.fetch,`${t.url}/object/${t.bucketId}`,{prefixes:e},{headers:t.headers}))}async list(e,t,r){var s=this;return s.handleOperation(async()=>{const n=N(N(N({},No),t),{},{prefix:e||""});return await we(s.fetch,`${s.url}/object/list/${s.bucketId}`,n,{headers:s.headers},r)})}async listV2(e,t){var r=this;return r.handleOperation(async()=>{const s=N({},e);return await we(r.fetch,`${r.url}/object/list-v2/${r.bucketId}`,s,{headers:r.headers},t)})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}};const Uo="2.95.3",dr={"X-Client-Info":`storage-js/${Uo}`};var Fo=class extends Ot{constructor(e,t={},r,s){const n=new URL(e);s!=null&&s.useNewHostname&&/supabase\.(co|in|red)$/.test(n.hostname)&&!n.hostname.includes("storage.supabase.")&&(n.hostname=n.hostname.replace("supabase.","storage.supabase."));const a=n.href.replace(/\/$/,""),i=N(N({},dr),t);super(a,i,r,"storage")}async listBuckets(e){var t=this;return t.handleOperation(async()=>{const r=t.listBucketOptionsToQueryString(e);return await rr(t.fetch,`${t.url}/bucket${r}`,{headers:t.headers})})}async getBucket(e){var t=this;return t.handleOperation(async()=>await rr(t.fetch,`${t.url}/bucket/${e}`,{headers:t.headers}))}async createBucket(e,t={public:!1}){var r=this;return r.handleOperation(async()=>await we(r.fetch,`${r.url}/bucket`,{id:e,name:e,type:t.type,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:r.headers}))}async updateBucket(e,t){var r=this;return r.handleOperation(async()=>await $s(r.fetch,`${r.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:r.headers}))}async emptyBucket(e){var t=this;return t.handleOperation(async()=>await we(t.fetch,`${t.url}/bucket/${e}/empty`,{},{headers:t.headers}))}async deleteBucket(e){var t=this;return t.handleOperation(async()=>await en(t.fetch,`${t.url}/bucket/${e}`,{},{headers:t.headers}))}listBucketOptionsToQueryString(e){const t={};return e&&("limit"in e&&(t.limit=String(e.limit)),"offset"in e&&(t.offset=String(e.offset)),e.search&&(t.search=e.search),e.sortColumn&&(t.sortColumn=e.sortColumn),e.sortOrder&&(t.sortOrder=e.sortOrder)),Object.keys(t).length>0?"?"+new URLSearchParams(t).toString():""}},Bo=class extends Ot{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=N(N({},dr),t);super(s,n,r,"storage")}async createBucket(e){var t=this;return t.handleOperation(async()=>await we(t.fetch,`${t.url}/bucket`,{name:e},{headers:t.headers}))}async listBuckets(e){var t=this;return t.handleOperation(async()=>{const r=new URLSearchParams;(e==null?void 0:e.limit)!==void 0&&r.set("limit",e.limit.toString()),(e==null?void 0:e.offset)!==void 0&&r.set("offset",e.offset.toString()),e!=null&&e.sortColumn&&r.set("sortColumn",e.sortColumn),e!=null&&e.sortOrder&&r.set("sortOrder",e.sortOrder),e!=null&&e.search&&r.set("search",e.search);const s=r.toString(),n=s?`${t.url}/bucket?${s}`:`${t.url}/bucket`;return await rr(t.fetch,n,{headers:t.headers})})}async deleteBucket(e){var t=this;return t.handleOperation(async()=>await en(t.fetch,`${t.url}/bucket/${e}`,{},{headers:t.headers}))}from(e){var t=this;if(!Ao(e))throw new Qr("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const r=new qo({baseUrl:this.url,catalogName:e,auth:{type:"custom",getHeaders:async()=>t.headers},fetch:this.fetch}),s=this.shouldThrowOnError;return new Proxy(r,{get(n,a){const i=n[a];return typeof i!="function"?i:async(...o)=>{try{return{data:await i.apply(n,o),error:null}}catch(l){if(s)throw l;return{data:null,error:l}}}}})}},Ko=class extends Ot{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=N(N({},dr),{},{"Content-Type":"application/json"},t);super(s,n,r,"vectors")}async createIndex(e){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/CreateIndex`,e,{headers:t.headers})||{})}async getIndex(e,t){var r=this;return r.handleOperation(async()=>await pe.post(r.fetch,`${r.url}/GetIndex`,{vectorBucketName:e,indexName:t},{headers:r.headers}))}async listIndexes(e){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/ListIndexes`,e,{headers:t.headers}))}async deleteIndex(e,t){var r=this;return r.handleOperation(async()=>await pe.post(r.fetch,`${r.url}/DeleteIndex`,{vectorBucketName:e,indexName:t},{headers:r.headers})||{})}},Wo=class extends Ot{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=N(N({},dr),{},{"Content-Type":"application/json"},t);super(s,n,r,"vectors")}async putVectors(e){var t=this;if(e.vectors.length<1||e.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/PutVectors`,e,{headers:t.headers})||{})}async getVectors(e){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/GetVectors`,e,{headers:t.headers}))}async listVectors(e){var t=this;if(e.segmentCount!==void 0){if(e.segmentCount<1||e.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(e.segmentIndex!==void 0&&(e.segmentIndex<0||e.segmentIndex>=e.segmentCount))throw new Error(`segmentIndex must be between 0 and ${e.segmentCount-1}`)}return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/ListVectors`,e,{headers:t.headers}))}async queryVectors(e){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/QueryVectors`,e,{headers:t.headers}))}async deleteVectors(e){var t=this;if(e.keys.length<1||e.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/DeleteVectors`,e,{headers:t.headers})||{})}},zo=class extends Ot{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=N(N({},dr),{},{"Content-Type":"application/json"},t);super(s,n,r,"vectors")}async createBucket(e){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/CreateVectorBucket`,{vectorBucketName:e},{headers:t.headers})||{})}async getBucket(e){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/GetVectorBucket`,{vectorBucketName:e},{headers:t.headers}))}async listBuckets(e={}){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/ListVectorBuckets`,e,{headers:t.headers}))}async deleteBucket(e){var t=this;return t.handleOperation(async()=>await pe.post(t.fetch,`${t.url}/DeleteVectorBucket`,{vectorBucketName:e},{headers:t.headers})||{})}},Vo=class extends zo{constructor(e,t={}){super(e,t.headers||{},t.fetch)}from(e){return new Go(this.url,this.headers,e,this.fetch)}async createBucket(e){var t=()=>super.createBucket,r=this;return t().call(r,e)}async getBucket(e){var t=()=>super.getBucket,r=this;return t().call(r,e)}async listBuckets(e={}){var t=()=>super.listBuckets,r=this;return t().call(r,e)}async deleteBucket(e){var t=()=>super.deleteBucket,r=this;return t().call(r,e)}},Go=class extends Ko{constructor(e,t,r,s){super(e,t,s),this.vectorBucketName=r}async createIndex(e){var t=()=>super.createIndex,r=this;return t().call(r,N(N({},e),{},{vectorBucketName:r.vectorBucketName}))}async listIndexes(e={}){var t=()=>super.listIndexes,r=this;return t().call(r,N(N({},e),{},{vectorBucketName:r.vectorBucketName}))}async getIndex(e){var t=()=>super.getIndex,r=this;return t().call(r,r.vectorBucketName,e)}async deleteIndex(e){var t=()=>super.deleteIndex,r=this;return t().call(r,r.vectorBucketName,e)}index(e){return new Jo(this.url,this.headers,this.vectorBucketName,e,this.fetch)}},Jo=class extends Wo{constructor(e,t,r,s,n){super(e,t,n),this.vectorBucketName=r,this.indexName=s}async putVectors(e){var t=()=>super.putVectors,r=this;return t().call(r,N(N({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async getVectors(e){var t=()=>super.getVectors,r=this;return t().call(r,N(N({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async listVectors(e={}){var t=()=>super.listVectors,r=this;return t().call(r,N(N({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async queryVectors(e){var t=()=>super.queryVectors,r=this;return t().call(r,N(N({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async deleteVectors(e){var t=()=>super.deleteVectors,r=this;return t().call(r,N(N({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}},Qo=class extends Fo{constructor(e,t={},r,s){super(e,t,r,s)}from(e){return new Ho(this.url,this.headers,e,this.fetch)}get vectors(){return new Vo(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new Bo(this.url+"/iceberg",this.headers,this.fetch)}};const Va="2.95.3",dt=30*1e3,As=3,os=As*dt,Yo="http://localhost:9999",Xo="supabase.auth.token",Zo={"X-Client-Info":`gotrue-js/${Va}`},xs="X-Supabase-Api-Version",Ga={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},el=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,tl=10*60*1e3;class sr extends Error{constructor(t,r,s){super(t),this.__isAuthError=!0,this.name="AuthError",this.status=r,this.code=s}}function R(e){return typeof e=="object"&&e!==null&&"__isAuthError"in e}class rl extends sr{constructor(t,r,s){super(t,r,s),this.name="AuthApiError",this.status=r,this.code=s}}function sl(e){return R(e)&&e.name==="AuthApiError"}class Je extends sr{constructor(t,r){super(t),this.name="AuthUnknownError",this.originalError=r}}class Ie extends sr{constructor(t,r,s,n){super(t,s,n),this.name=r,this.status=s}}class ue extends Ie{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function ls(e){return R(e)&&e.name==="AuthSessionMissingError"}class st extends Ie{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class _r extends Ie{constructor(t){super(t,"AuthInvalidCredentialsError",400,void 0)}}class wr extends Ie{constructor(t,r=null){super(t,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=r}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function nl(e){return R(e)&&e.name==="AuthImplicitGrantRedirectError"}class Rn extends Ie{constructor(t,r=null){super(t,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=r}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class al extends Ie{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class Rs extends Ie{constructor(t,r){super(t,"AuthRetryableFetchError",r,void 0)}}function cs(e){return R(e)&&e.name==="AuthRetryableFetchError"}class In extends Ie{constructor(t,r,s){super(t,"AuthWeakPasswordError",r,"weak_password"),this.reasons=s}}class Is extends Ie{constructor(t){super(t,"AuthInvalidJwtError",400,"invalid_jwt")}}const Hr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Cn=` 	
\r=`.split(""),il=(()=>{const e=new Array(128);for(let t=0;t<e.length;t+=1)e[t]=-1;for(let t=0;t<Cn.length;t+=1)e[Cn[t].charCodeAt(0)]=-2;for(let t=0;t<Hr.length;t+=1)e[Hr[t].charCodeAt(0)]=t;return e})();function On(e,t,r){if(e!==null)for(t.queue=t.queue<<8|e,t.queuedBits+=8;t.queuedBits>=6;){const s=t.queue>>t.queuedBits-6&63;r(Hr[s]),t.queuedBits-=6}else if(t.queuedBits>0)for(t.queue=t.queue<<6-t.queuedBits,t.queuedBits=6;t.queuedBits>=6;){const s=t.queue>>t.queuedBits-6&63;r(Hr[s]),t.queuedBits-=6}}function Ja(e,t,r){const s=il[e];if(s>-1)for(t.queue=t.queue<<6|s,t.queuedBits+=6;t.queuedBits>=8;)r(t.queue>>t.queuedBits-8&255),t.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(e)}"`)}}function Pn(e){const t=[],r=i=>{t.push(String.fromCodePoint(i))},s={utf8seq:0,codepoint:0},n={queue:0,queuedBits:0},a=i=>{cl(i,s,r)};for(let i=0;i<e.length;i+=1)Ja(e.charCodeAt(i),n,a);return t.join("")}function ol(e,t){if(e<=127){t(e);return}else if(e<=2047){t(192|e>>6),t(128|e&63);return}else if(e<=65535){t(224|e>>12),t(128|e>>6&63),t(128|e&63);return}else if(e<=1114111){t(240|e>>18),t(128|e>>12&63),t(128|e>>6&63),t(128|e&63);return}throw new Error(`Unrecognized Unicode codepoint: ${e.toString(16)}`)}function ll(e,t){for(let r=0;r<e.length;r+=1){let s=e.charCodeAt(r);if(s>55295&&s<=56319){const n=(s-55296)*1024&65535;s=(e.charCodeAt(r+1)-56320&65535|n)+65536,r+=1}ol(s,t)}}function cl(e,t,r){if(t.utf8seq===0){if(e<=127){r(e);return}for(let s=1;s<6;s+=1)if(!(e>>7-s&1)){t.utf8seq=s;break}if(t.utf8seq===2)t.codepoint=e&31;else if(t.utf8seq===3)t.codepoint=e&15;else if(t.utf8seq===4)t.codepoint=e&7;else throw new Error("Invalid UTF-8 sequence");t.utf8seq-=1}else if(t.utf8seq>0){if(e<=127)throw new Error("Invalid UTF-8 sequence");t.codepoint=t.codepoint<<6|e&63,t.utf8seq-=1,t.utf8seq===0&&r(t.codepoint)}}function wt(e){const t=[],r={queue:0,queuedBits:0},s=n=>{t.push(n)};for(let n=0;n<e.length;n+=1)Ja(e.charCodeAt(n),r,s);return new Uint8Array(t)}function dl(e){const t=[];return ll(e,r=>t.push(r)),new Uint8Array(t)}function Xe(e){const t=[],r={queue:0,queuedBits:0},s=n=>{t.push(n)};return e.forEach(n=>On(n,r,s)),On(null,r,s),t.join("")}function ul(e){return Math.round(Date.now()/1e3)+e}function hl(){return Symbol("auth-callback")}const ae=()=>typeof window<"u"&&typeof document<"u",Be={tested:!1,writable:!1},Qa=()=>{if(!ae())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Be.tested)return Be.writable;const e=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(e,e),globalThis.localStorage.removeItem(e),Be.tested=!0,Be.writable=!0}catch{Be.tested=!0,Be.writable=!1}return Be.writable};function fl(e){const t={},r=new URL(e);if(r.hash&&r.hash[0]==="#")try{new URLSearchParams(r.hash.substring(1)).forEach((n,a)=>{t[a]=n})}catch{}return r.searchParams.forEach((s,n)=>{t[n]=s}),t}const Ya=e=>e?(...t)=>e(...t):(...t)=>fetch(...t),pl=e=>typeof e=="object"&&e!==null&&"status"in e&&"ok"in e&&"json"in e&&typeof e.json=="function",ut=async(e,t,r)=>{await e.setItem(t,JSON.stringify(r))},Ke=async(e,t)=>{const r=await e.getItem(t);if(!r)return null;try{return JSON.parse(r)}catch{return r}},ne=async(e,t)=>{await e.removeItem(t)};class Xr{constructor(){this.promise=new Xr.promiseConstructor((t,r)=>{this.resolve=t,this.reject=r})}}Xr.promiseConstructor=Promise;function Sr(e){const t=e.split(".");if(t.length!==3)throw new Is("Invalid JWT structure");for(let s=0;s<t.length;s++)if(!el.test(t[s]))throw new Is("JWT not in base64url format");return{header:JSON.parse(Pn(t[0])),payload:JSON.parse(Pn(t[1])),signature:wt(t[2]),raw:{header:t[0],payload:t[1]}}}async function yl(e){return await new Promise(t=>{setTimeout(()=>t(null),e)})}function ml(e,t){return new Promise((s,n)=>{(async()=>{for(let a=0;a<1/0;a++)try{const i=await e(a);if(!t(a,null,i)){s(i);return}}catch(i){if(!t(a,i)){n(i);return}}})()})}function gl(e){return("0"+e.toString(16)).substr(-2)}function bl(){const t=new Uint32Array(56);if(typeof crypto>"u"){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=r.length;let n="";for(let a=0;a<56;a++)n+=r.charAt(Math.floor(Math.random()*s));return n}return crypto.getRandomValues(t),Array.from(t,gl).join("")}async function vl(e){const r=new TextEncoder().encode(e),s=await crypto.subtle.digest("SHA-256",r),n=new Uint8Array(s);return Array.from(n).map(a=>String.fromCharCode(a)).join("")}async function _l(e){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),e;const r=await vl(e);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function nt(e,t,r=!1){const s=bl();let n=s;r&&(n+="/PASSWORD_RECOVERY"),await ut(e,`${t}-code-verifier`,n);const a=await _l(s);return[a,s===a?"plain":"s256"]}const wl=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Sl(e){const t=e.headers.get(xs);if(!t||!t.match(wl))return null;try{return new Date(`${t}T00:00:00.0Z`)}catch{return null}}function kl(e){if(!e)throw new Error("Missing exp claim");const t=Math.floor(Date.now()/1e3);if(e<=t)throw new Error("JWT has expired")}function El(e){switch(e){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Tl=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function at(e){if(!Tl.test(e))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function ds(){const e={};return new Proxy(e,{get:(t,r)=>{if(r==="__isUserNotAvailableProxy")return!0;if(typeof r=="symbol"){const s=r.toString();if(s==="Symbol(Symbol.toPrimitive)"||s==="Symbol(Symbol.toStringTag)"||s==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${r}" property of the session object is not supported. Please use getUser() instead.`)},set:(t,r)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${r}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(t,r)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${r}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function ql(e,t){return new Proxy(e,{get:(r,s,n)=>{if(s==="__isInsecureUserWarningProxy")return!0;if(typeof s=="symbol"){const a=s.toString();if(a==="Symbol(Symbol.toPrimitive)"||a==="Symbol(Symbol.toStringTag)"||a==="Symbol(util.inspect.custom)"||a==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(r,s,n)}return!t.value&&typeof s=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),t.value=!0),Reflect.get(r,s,n)}})}function Dn(e){return JSON.parse(JSON.stringify(e))}const We=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),Ll=[502,503,504];async function Mn(e){var t;if(!pl(e))throw new Rs(We(e),0);if(Ll.includes(e.status))throw new Rs(We(e),e.status);let r;try{r=await e.json()}catch(a){throw new Je(We(a),a)}let s;const n=Sl(e);if(n&&n.getTime()>=Ga["2024-01-01"].timestamp&&typeof r=="object"&&r&&typeof r.code=="string"?s=r.code:typeof r=="object"&&r&&typeof r.error_code=="string"&&(s=r.error_code),s){if(s==="weak_password")throw new In(We(r),e.status,((t=r.weak_password)===null||t===void 0?void 0:t.reasons)||[]);if(s==="session_not_found")throw new ue}else if(typeof r=="object"&&r&&typeof r.weak_password=="object"&&r.weak_password&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.reasons.reduce((a,i)=>a&&typeof i=="string",!0))throw new In(We(r),e.status,r.weak_password.reasons);throw new rl(We(r),e.status||500,s)}const $l=(e,t,r,s)=>{const n={method:e,headers:(t==null?void 0:t.headers)||{}};return e==="GET"?n:(n.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},t==null?void 0:t.headers),n.body=JSON.stringify(s),Object.assign(Object.assign({},n),r))};async function D(e,t,r,s){var n;const a=Object.assign({},s==null?void 0:s.headers);a[xs]||(a[xs]=Ga["2024-01-01"].name),s!=null&&s.jwt&&(a.Authorization=`Bearer ${s.jwt}`);const i=(n=s==null?void 0:s.query)!==null&&n!==void 0?n:{};s!=null&&s.redirectTo&&(i.redirect_to=s.redirectTo);const o=Object.keys(i).length?"?"+new URLSearchParams(i).toString():"",l=await Al(e,t,r+o,{headers:a,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(l):{data:Object.assign({},l),error:null}}async function Al(e,t,r,s,n,a){const i=$l(t,s,n,a);let o;try{o=await e(r,Object.assign({},i))}catch(l){throw console.error(l),new Rs(We(l),0)}if(o.ok||await Mn(o),s!=null&&s.noResolveJson)return o;try{return await o.json()}catch(l){await Mn(l)}}function _e(e){var t;let r=null;Il(e)&&(r=Object.assign({},e),e.expires_at||(r.expires_at=ul(e.expires_in)));const s=(t=e.user)!==null&&t!==void 0?t:e;return{data:{session:r,user:s},error:null}}function jn(e){const t=_e(e);return!t.error&&e.weak_password&&typeof e.weak_password=="object"&&Array.isArray(e.weak_password.reasons)&&e.weak_password.reasons.length&&e.weak_password.message&&typeof e.weak_password.message=="string"&&e.weak_password.reasons.reduce((r,s)=>r&&typeof s=="string",!0)&&(t.data.weak_password=e.weak_password),t}function Ne(e){var t;return{data:{user:(t=e.user)!==null&&t!==void 0?t:e},error:null}}function xl(e){return{data:e,error:null}}function Rl(e){const{action_link:t,email_otp:r,hashed_token:s,redirect_to:n,verification_type:a}=e,i=Jr(e,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:t,email_otp:r,hashed_token:s,redirect_to:n,verification_type:a},l=Object.assign({},i);return{data:{properties:o,user:l},error:null}}function Nn(e){return e}function Il(e){return e.access_token&&e.refresh_token&&e.expires_in}const us=["global","local","others"];class Cl{constructor({url:t="",headers:r={},fetch:s}){this.url=t,this.headers=r,this.fetch=Ya(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(t,r=us[0]){if(us.indexOf(r)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${us.join(", ")}`);try{return await D(this.fetch,"POST",`${this.url}/logout?scope=${r}`,{headers:this.headers,jwt:t,noResolveJson:!0}),{data:null,error:null}}catch(s){if(R(s))return{data:null,error:s};throw s}}async inviteUserByEmail(t,r={}){try{return await D(this.fetch,"POST",`${this.url}/invite`,{body:{email:t,data:r.data},headers:this.headers,redirectTo:r.redirectTo,xform:Ne})}catch(s){if(R(s))return{data:{user:null},error:s};throw s}}async generateLink(t){try{const{options:r}=t,s=Jr(t,["options"]),n=Object.assign(Object.assign({},s),r);return"newEmail"in s&&(n.new_email=s==null?void 0:s.newEmail,delete n.newEmail),await D(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:n,headers:this.headers,xform:Rl,redirectTo:r==null?void 0:r.redirectTo})}catch(r){if(R(r))return{data:{properties:null,user:null},error:r};throw r}}async createUser(t){try{return await D(this.fetch,"POST",`${this.url}/admin/users`,{body:t,headers:this.headers,xform:Ne})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async listUsers(t){var r,s,n,a,i,o,l;try{const c={nextPage:null,lastPage:0,total:0},d=await D(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(r=t==null?void 0:t.page)===null||r===void 0?void 0:r.toString())!==null&&s!==void 0?s:"",per_page:(a=(n=t==null?void 0:t.perPage)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:""},xform:Nn});if(d.error)throw d.error;const h=await d.json(),u=(i=d.headers.get("x-total-count"))!==null&&i!==void 0?i:0,f=(l=(o=d.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(p=>{const y=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),_=JSON.parse(p.split(";")[1].split("=")[1]);c[`${_}Page`]=y}),c.total=parseInt(u)),{data:Object.assign(Object.assign({},h),c),error:null}}catch(c){if(R(c))return{data:{users:[]},error:c};throw c}}async getUserById(t){at(t);try{return await D(this.fetch,"GET",`${this.url}/admin/users/${t}`,{headers:this.headers,xform:Ne})}catch(r){if(R(r))return{data:{user:null},error:r};throw r}}async updateUserById(t,r){at(t);try{return await D(this.fetch,"PUT",`${this.url}/admin/users/${t}`,{body:r,headers:this.headers,xform:Ne})}catch(s){if(R(s))return{data:{user:null},error:s};throw s}}async deleteUser(t,r=!1){at(t);try{return await D(this.fetch,"DELETE",`${this.url}/admin/users/${t}`,{headers:this.headers,body:{should_soft_delete:r},xform:Ne})}catch(s){if(R(s))return{data:{user:null},error:s};throw s}}async _listFactors(t){at(t.userId);try{const{data:r,error:s}=await D(this.fetch,"GET",`${this.url}/admin/users/${t.userId}/factors`,{headers:this.headers,xform:n=>({data:{factors:n},error:null})});return{data:r,error:s}}catch(r){if(R(r))return{data:null,error:r};throw r}}async _deleteFactor(t){at(t.userId),at(t.id);try{return{data:await D(this.fetch,"DELETE",`${this.url}/admin/users/${t.userId}/factors/${t.id}`,{headers:this.headers}),error:null}}catch(r){if(R(r))return{data:null,error:r};throw r}}async _listOAuthClients(t){var r,s,n,a,i,o,l;try{const c={nextPage:null,lastPage:0,total:0},d=await D(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(r=t==null?void 0:t.page)===null||r===void 0?void 0:r.toString())!==null&&s!==void 0?s:"",per_page:(a=(n=t==null?void 0:t.perPage)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:""},xform:Nn});if(d.error)throw d.error;const h=await d.json(),u=(i=d.headers.get("x-total-count"))!==null&&i!==void 0?i:0,f=(l=(o=d.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&l!==void 0?l:[];return f.length>0&&(f.forEach(p=>{const y=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),_=JSON.parse(p.split(";")[1].split("=")[1]);c[`${_}Page`]=y}),c.total=parseInt(u)),{data:Object.assign(Object.assign({},h),c),error:null}}catch(c){if(R(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(t){try{return await D(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(R(r))return{data:null,error:r};throw r}}async _getOAuthClient(t){try{return await D(this.fetch,"GET",`${this.url}/admin/oauth/clients/${t}`,{headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(R(r))return{data:null,error:r};throw r}}async _updateOAuthClient(t,r){try{return await D(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${t}`,{body:r,headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(R(s))return{data:null,error:s};throw s}}async _deleteOAuthClient(t){try{return await D(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${t}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(r){if(R(r))return{data:null,error:r};throw r}}async _regenerateOAuthClientSecret(t){try{return await D(this.fetch,"POST",`${this.url}/admin/oauth/clients/${t}/regenerate_secret`,{headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(R(r))return{data:null,error:r};throw r}}}function Hn(e={}){return{getItem:t=>e[t]||null,setItem:(t,r)=>{e[t]=r},removeItem:t=>{delete e[t]}}}const it={debug:!!(globalThis&&Qa()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class Xa extends Error{constructor(t){super(t),this.isAcquireTimeout=!0}}class Ol extends Xa{}async function Pl(e,t,r){it.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",e,t);const s=new globalThis.AbortController;return t>0&&setTimeout(()=>{s.abort(),it.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",e)},t),await Promise.resolve().then(()=>globalThis.navigator.locks.request(e,t===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async n=>{if(n){it.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",e,n.name);try{return await r()}finally{it.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",e,n.name)}}else{if(t===0)throw it.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",e),new Ol(`Acquiring an exclusive Navigator LockManager lock "${e}" immediately failed`);if(it.debug)try{const a=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(a,null,"  "))}catch(a){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",a)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await r()}}))}function Dl(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function Za(e){if(!/^0x[a-fA-F0-9]{40}$/.test(e))throw new Error(`@supabase/auth-js: Address "${e}" is invalid.`);return e.toLowerCase()}function Ml(e){return parseInt(e,16)}function jl(e){const t=new TextEncoder().encode(e);return"0x"+Array.from(t,s=>s.toString(16).padStart(2,"0")).join("")}function Nl(e){var t;const{chainId:r,domain:s,expirationTime:n,issuedAt:a=new Date,nonce:i,notBefore:o,requestId:l,resources:c,scheme:d,uri:h,version:u}=e;{if(!Number.isInteger(r))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${r}`);if(!s)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(i&&i.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${i}`);if(!h)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(u!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${u}`);if(!((t=e.statement)===null||t===void 0)&&t.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${e.statement}`)}const f=Za(e.address),p=d?`${d}://${s}`:s,y=e.statement?`${e.statement}
`:"",_=`${p} wants you to sign in with your Ethereum account:
${f}

${y}`;let g=`URI: ${h}
Version: ${u}
Chain ID: ${r}${i?`
Nonce: ${i}`:""}
Issued At: ${a.toISOString()}`;if(n&&(g+=`
Expiration Time: ${n.toISOString()}`),o&&(g+=`
Not Before: ${o.toISOString()}`),l&&(g+=`
Request ID: ${l}`),c){let v=`
Resources:`;for(const m of c){if(!m||typeof m!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${m}`);v+=`
- ${m}`}g+=v}return`${_}
${g}`}class Y extends Error{constructor({message:t,code:r,cause:s,name:n}){var a;super(t,{cause:s}),this.__isWebAuthnError=!0,this.name=(a=n??(s instanceof Error?s.name:void 0))!==null&&a!==void 0?a:"Unknown Error",this.code=r}}class Ur extends Y{constructor(t,r){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r,message:t}),this.name="WebAuthnUnknownError",this.originalError=r}}function Hl({error:e,options:t}){var r,s,n;const{publicKey:a}=t;if(!a)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(t.signal instanceof AbortSignal)return new Y({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else if(e.name==="ConstraintError"){if(((r=a.authenticatorSelection)===null||r===void 0?void 0:r.requireResidentKey)===!0)return new Y({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:e});if(t.mediation==="conditional"&&((s=a.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new Y({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:e});if(((n=a.authenticatorSelection)===null||n===void 0?void 0:n.userVerification)==="required")return new Y({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:e})}else{if(e.name==="InvalidStateError")return new Y({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:e});if(e.name==="NotAllowedError")return new Y({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="NotSupportedError")return a.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new Y({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:e}):new Y({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:e});if(e.name==="SecurityError"){const i=window.location.hostname;if(ei(i)){if(a.rp.id!==i)return new Y({message:`The RP ID "${a.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new Y({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="TypeError"){if(a.user.id.byteLength<1||a.user.id.byteLength>64)return new Y({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:e})}else if(e.name==="UnknownError")return new Y({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return new Y({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e})}function Ul({error:e,options:t}){const{publicKey:r}=t;if(!r)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(t.signal instanceof AbortSignal)return new Y({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else{if(e.name==="NotAllowedError")return new Y({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="SecurityError"){const s=window.location.hostname;if(ei(s)){if(r.rpId!==s)return new Y({message:`The RP ID "${r.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new Y({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="UnknownError")return new Y({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return new Y({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e})}class Fl{createNewAbortSignal(){if(this.controller){const r=new Error("Cancelling existing WebAuthn API call for new one");r.name="AbortError",this.controller.abort(r)}const t=new AbortController;return this.controller=t,t.signal}cancelCeremony(){if(this.controller){const t=new Error("Manually cancelling existing WebAuthn API call");t.name="AbortError",this.controller.abort(t),this.controller=void 0}}}const Bl=new Fl;function Kl(e){if(!e)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(e);const{challenge:t,user:r,excludeCredentials:s}=e,n=Jr(e,["challenge","user","excludeCredentials"]),a=wt(t).buffer,i=Object.assign(Object.assign({},r),{id:wt(r.id).buffer}),o=Object.assign(Object.assign({},n),{challenge:a,user:i});if(s&&s.length>0){o.excludeCredentials=new Array(s.length);for(let l=0;l<s.length;l++){const c=s[l];o.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:wt(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return o}function Wl(e){if(!e)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(e);const{challenge:t,allowCredentials:r}=e,s=Jr(e,["challenge","allowCredentials"]),n=wt(t).buffer,a=Object.assign(Object.assign({},s),{challenge:n});if(r&&r.length>0){a.allowCredentials=new Array(r.length);for(let i=0;i<r.length;i++){const o=r[i];a.allowCredentials[i]=Object.assign(Object.assign({},o),{id:wt(o.id).buffer,type:o.type||"public-key",transports:o.transports})}}return a}function zl(e){var t;if("toJSON"in e&&typeof e.toJSON=="function")return e.toJSON();const r=e;return{id:e.id,rawId:e.id,response:{attestationObject:Xe(new Uint8Array(e.response.attestationObject)),clientDataJSON:Xe(new Uint8Array(e.response.clientDataJSON))},type:"public-key",clientExtensionResults:e.getClientExtensionResults(),authenticatorAttachment:(t=r.authenticatorAttachment)!==null&&t!==void 0?t:void 0}}function Vl(e){var t;if("toJSON"in e&&typeof e.toJSON=="function")return e.toJSON();const r=e,s=e.getClientExtensionResults(),n=e.response;return{id:e.id,rawId:e.id,response:{authenticatorData:Xe(new Uint8Array(n.authenticatorData)),clientDataJSON:Xe(new Uint8Array(n.clientDataJSON)),signature:Xe(new Uint8Array(n.signature)),userHandle:n.userHandle?Xe(new Uint8Array(n.userHandle)):void 0},type:"public-key",clientExtensionResults:s,authenticatorAttachment:(t=r.authenticatorAttachment)!==null&&t!==void 0?t:void 0}}function ei(e){return e==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(e)}function Un(){var e,t;return!!(ae()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.create)=="function"&&typeof((t=navigator==null?void 0:navigator.credentials)===null||t===void 0?void 0:t.get)=="function")}async function Gl(e){try{const t=await navigator.credentials.create(e);return t?t instanceof PublicKeyCredential?{data:t,error:null}:{data:null,error:new Ur("Browser returned unexpected credential type",t)}:{data:null,error:new Ur("Empty credential response",t)}}catch(t){return{data:null,error:Hl({error:t,options:e})}}}async function Jl(e){try{const t=await navigator.credentials.get(e);return t?t instanceof PublicKeyCredential?{data:t,error:null}:{data:null,error:new Ur("Browser returned unexpected credential type",t)}:{data:null,error:new Ur("Empty credential response",t)}}catch(t){return{data:null,error:Ul({error:t,options:e})}}}const Ql={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},Yl={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Fr(...e){const t=n=>n!==null&&typeof n=="object"&&!Array.isArray(n),r=n=>n instanceof ArrayBuffer||ArrayBuffer.isView(n),s={};for(const n of e)if(n)for(const a in n){const i=n[a];if(i!==void 0)if(Array.isArray(i))s[a]=i;else if(r(i))s[a]=i;else if(t(i)){const o=s[a];t(o)?s[a]=Fr(o,i):s[a]=Fr(i)}else s[a]=i}return s}function Xl(e,t){return Fr(Ql,e,t||{})}function Zl(e,t){return Fr(Yl,e,t||{})}class ec{constructor(t){this.client=t,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(t){return this.client.mfa.enroll(Object.assign(Object.assign({},t),{factorType:"webauthn"}))}async _challenge({factorId:t,webauthn:r,friendlyName:s,signal:n},a){var i;try{const{data:o,error:l}=await this.client.mfa.challenge({factorId:t,webauthn:r});if(!o)return{data:null,error:l};const c=n??Bl.createNewAbortSignal();if(o.webauthn.type==="create"){const{user:d}=o.webauthn.credential_options.publicKey;if(!d.name){const h=s;if(h)d.name=`${d.id}:${h}`;else{const f=(await this.client.getUser()).data.user,p=((i=f==null?void 0:f.user_metadata)===null||i===void 0?void 0:i.name)||(f==null?void 0:f.email)||(f==null?void 0:f.id)||"User";d.name=`${d.id}:${p}`}}d.displayName||(d.displayName=d.name)}switch(o.webauthn.type){case"create":{const d=Xl(o.webauthn.credential_options.publicKey,a==null?void 0:a.create),{data:h,error:u}=await Gl({publicKey:d,signal:c});return h?{data:{factorId:t,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:h}},error:null}:{data:null,error:u}}case"request":{const d=Zl(o.webauthn.credential_options.publicKey,a==null?void 0:a.request),{data:h,error:u}=await Jl(Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:d,signal:c}));return h?{data:{factorId:t,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:h}},error:null}:{data:null,error:u}}}}catch(o){return R(o)?{data:null,error:o}:{data:null,error:new Je("Unexpected error in challenge",o)}}}async _verify({challengeId:t,factorId:r,webauthn:s}){return this.client.mfa.verify({factorId:r,challengeId:t,webauthn:s})}async _authenticate({factorId:t,webauthn:{rpId:r=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:n}={}},a){if(!r)return{data:null,error:new sr("rpId is required for WebAuthn authentication")};try{if(!Un())return{data:null,error:new Je("Browser does not support WebAuthn",null)};const{data:i,error:o}=await this.challenge({factorId:t,webauthn:{rpId:r,rpOrigins:s},signal:n},{request:a});if(!i)return{data:null,error:o};const{webauthn:l}=i;return this._verify({factorId:t,challengeId:i.challengeId,webauthn:{type:l.type,rpId:r,rpOrigins:s,credential_response:l.credential_response}})}catch(i){return R(i)?{data:null,error:i}:{data:null,error:new Je("Unexpected error in authenticate",i)}}}async _register({friendlyName:t,webauthn:{rpId:r=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:n}={}},a){if(!r)return{data:null,error:new sr("rpId is required for WebAuthn registration")};try{if(!Un())return{data:null,error:new Je("Browser does not support WebAuthn",null)};const{data:i,error:o}=await this._enroll({friendlyName:t});if(!i)return await this.client.mfa.listFactors().then(d=>{var h;return(h=d.data)===null||h===void 0?void 0:h.all.find(u=>u.factor_type==="webauthn"&&u.friendly_name===t&&u.status!=="unverified")}).then(d=>d?this.client.mfa.unenroll({factorId:d==null?void 0:d.id}):void 0),{data:null,error:o};const{data:l,error:c}=await this._challenge({factorId:i.id,friendlyName:i.friendly_name,webauthn:{rpId:r,rpOrigins:s},signal:n},{create:a});return l?this._verify({factorId:i.id,challengeId:l.challengeId,webauthn:{rpId:r,rpOrigins:s,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(i){return R(i)?{data:null,error:i}:{data:null,error:new Je("Unexpected error in register",i)}}}}Dl();const tc={url:Yo,storageKey:Xo,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Zo,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function Fn(e,t,r){return await r()}const ot={};class nr{get jwks(){var t,r;return(r=(t=ot[this.storageKey])===null||t===void 0?void 0:t.jwks)!==null&&r!==void 0?r:{keys:[]}}set jwks(t){ot[this.storageKey]=Object.assign(Object.assign({},ot[this.storageKey]),{jwks:t})}get jwks_cached_at(){var t,r;return(r=(t=ot[this.storageKey])===null||t===void 0?void 0:t.cachedAt)!==null&&r!==void 0?r:Number.MIN_SAFE_INTEGER}set jwks_cached_at(t){ot[this.storageKey]=Object.assign(Object.assign({},ot[this.storageKey]),{cachedAt:t})}constructor(t){var r,s,n;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const a=Object.assign(Object.assign({},tc),t);if(this.storageKey=a.storageKey,this.instanceID=(r=nr.nextInstanceID[this.storageKey])!==null&&r!==void 0?r:0,nr.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!a.debug,typeof a.debug=="function"&&(this.logger=a.debug),this.instanceID>0&&ae()){const i=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(i),this.logDebugMessages&&console.trace(i)}if(this.persistSession=a.persistSession,this.autoRefreshToken=a.autoRefreshToken,this.admin=new Cl({url:a.url,headers:a.headers,fetch:a.fetch}),this.url=a.url,this.headers=a.headers,this.fetch=Ya(a.fetch),this.lock=a.lock||Fn,this.detectSessionInUrl=a.detectSessionInUrl,this.flowType=a.flowType,this.hasCustomAuthorizationHeader=a.hasCustomAuthorizationHeader,this.throwOnError=a.throwOnError,this.lockAcquireTimeout=a.lockAcquireTimeout,a.lock?this.lock=a.lock:this.persistSession&&ae()&&(!((s=globalThis==null?void 0:globalThis.navigator)===null||s===void 0)&&s.locks)?this.lock=Pl:this.lock=Fn,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new ec(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(a.storage?this.storage=a.storage:Qa()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Hn(this.memoryStorage)),a.userStorage&&(this.userStorage=a.userStorage)):(this.memoryStorage={},this.storage=Hn(this.memoryStorage)),ae()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(n=this.broadcastChannel)===null||n===void 0||n.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i);try{await this._notifyAllSubscribers(i.data.event,i.data.session,!1)}catch(o){this._debug("#broadcastChannel","error",o)}})}this.initialize().catch(i=>{this._debug("#initialize()","error",i)})}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(t){if(this.throwOnError&&t&&t.error)throw t.error;return t}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${Va}) ${new Date().toISOString()}`}_debug(...t){return this.logDebugMessages&&this.logger(this._logPrefix(),...t),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var t;try{let r={},s="none";if(ae()&&(r=fl(window.location.href),this._isImplicitGrantCallback(r)?s="implicit":await this._isPKCECallback(r)&&(s="pkce")),ae()&&this.detectSessionInUrl&&s!=="none"){const{data:n,error:a}=await this._getSessionFromURL(r,s);if(a){if(this._debug("#_initialize()","error detecting session from URL",a),nl(a)){const l=(t=a.details)===null||t===void 0?void 0:t.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:a}}return{error:a}}const{session:i,redirectType:o}=n;return this._debug("#_initialize()","detected session in URL",i,"redirect type",o),await this._saveSession(i),setTimeout(async()=>{o==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",i):await this._notifyAllSubscribers("SIGNED_IN",i)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(r){return R(r)?this._returnResult({error:r}):this._returnResult({error:new Je("Unexpected error during initialization",r)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(t){var r,s,n;try{const a=await D(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(r=t==null?void 0:t.options)===null||r===void 0?void 0:r.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(n=t==null?void 0:t.options)===null||n===void 0?void 0:n.captchaToken}},xform:_e}),{data:i,error:o}=a;if(o||!i)return this._returnResult({data:{user:null,session:null},error:o});const l=i.session,c=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(a){if(R(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signUp(t){var r,s,n;try{let a;if("email"in t){const{email:d,password:h,options:u}=t;let f=null,p=null;this.flowType==="pkce"&&([f,p]=await nt(this.storage,this.storageKey)),a=await D(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:u==null?void 0:u.emailRedirectTo,body:{email:d,password:h,data:(r=u==null?void 0:u.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken},code_challenge:f,code_challenge_method:p},xform:_e})}else if("phone"in t){const{phone:d,password:h,options:u}=t;a=await D(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:h,data:(s=u==null?void 0:u.data)!==null&&s!==void 0?s:{},channel:(n=u==null?void 0:u.channel)!==null&&n!==void 0?n:"sms",gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken}},xform:_e})}else throw new _r("You must provide either an email or phone number and a password");const{data:i,error:o}=a;if(o||!i)return await ne(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:o});const l=i.session,c=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(a){if(await ne(this.storage,`${this.storageKey}-code-verifier`),R(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signInWithPassword(t){try{let r;if("email"in t){const{email:a,password:i,options:o}=t;r=await D(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:a,password:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:jn})}else if("phone"in t){const{phone:a,password:i,options:o}=t;r=await D(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:a,password:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:jn})}else throw new _r("You must provide either an email or phone number and a password");const{data:s,error:n}=r;if(n)return this._returnResult({data:{user:null,session:null},error:n});if(!s||!s.session||!s.user){const a=new st;return this._returnResult({data:{user:null,session:null},error:a})}return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),this._returnResult({data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:n})}catch(r){if(R(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async signInWithOAuth(t){var r,s,n,a;return await this._handleProviderSignIn(t.provider,{redirectTo:(r=t.options)===null||r===void 0?void 0:r.redirectTo,scopes:(s=t.options)===null||s===void 0?void 0:s.scopes,queryParams:(n=t.options)===null||n===void 0?void 0:n.queryParams,skipBrowserRedirect:(a=t.options)===null||a===void 0?void 0:a.skipBrowserRedirect})}async exchangeCodeForSession(t){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(t))}async signInWithWeb3(t){const{chain:r}=t;switch(r){case"ethereum":return await this.signInWithEthereum(t);case"solana":return await this.signInWithSolana(t);default:throw new Error(`@supabase/auth-js: Unsupported chain "${r}"`)}}async signInWithEthereum(t){var r,s,n,a,i,o,l,c,d,h,u;let f,p;if("message"in t)f=t.message,p=t.signature;else{const{chain:y,wallet:_,statement:g,options:v}=t;let m;if(ae())if(typeof _=="object")m=_;else{const T=window;if("ethereum"in T&&typeof T.ethereum=="object"&&"request"in T.ethereum&&typeof T.ethereum.request=="function")m=T.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof _!="object"||!(v!=null&&v.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");m=_}const w=new URL((r=v==null?void 0:v.url)!==null&&r!==void 0?r:window.location.href),k=await m.request({method:"eth_requestAccounts"}).then(T=>T).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!k||k.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const E=Za(k[0]);let q=(s=v==null?void 0:v.signInWithEthereum)===null||s===void 0?void 0:s.chainId;if(!q){const T=await m.request({method:"eth_chainId"});q=Ml(T)}const L={domain:w.host,address:E,statement:g,uri:w.href,version:"1",chainId:q,nonce:(n=v==null?void 0:v.signInWithEthereum)===null||n===void 0?void 0:n.nonce,issuedAt:(i=(a=v==null?void 0:v.signInWithEthereum)===null||a===void 0?void 0:a.issuedAt)!==null&&i!==void 0?i:new Date,expirationTime:(o=v==null?void 0:v.signInWithEthereum)===null||o===void 0?void 0:o.expirationTime,notBefore:(l=v==null?void 0:v.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=v==null?void 0:v.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(d=v==null?void 0:v.signInWithEthereum)===null||d===void 0?void 0:d.resources};f=Nl(L),p=await m.request({method:"personal_sign",params:[jl(f),E]})}try{const{data:y,error:_}=await D(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:f,signature:p},!((h=t.options)===null||h===void 0)&&h.captchaToken?{gotrue_meta_security:{captcha_token:(u=t.options)===null||u===void 0?void 0:u.captchaToken}}:null),xform:_e});if(_)throw _;if(!y||!y.session||!y.user){const g=new st;return this._returnResult({data:{user:null,session:null},error:g})}return y.session&&(await this._saveSession(y.session),await this._notifyAllSubscribers("SIGNED_IN",y.session)),this._returnResult({data:Object.assign({},y),error:_})}catch(y){if(R(y))return this._returnResult({data:{user:null,session:null},error:y});throw y}}async signInWithSolana(t){var r,s,n,a,i,o,l,c,d,h,u,f;let p,y;if("message"in t)p=t.message,y=t.signature;else{const{chain:_,wallet:g,statement:v,options:m}=t;let w;if(ae())if(typeof g=="object")w=g;else{const E=window;if("solana"in E&&typeof E.solana=="object"&&("signIn"in E.solana&&typeof E.solana.signIn=="function"||"signMessage"in E.solana&&typeof E.solana.signMessage=="function"))w=E.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof g!="object"||!(m!=null&&m.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");w=g}const k=new URL((r=m==null?void 0:m.url)!==null&&r!==void 0?r:window.location.href);if("signIn"in w&&w.signIn){const E=await w.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},m==null?void 0:m.signInWithSolana),{version:"1",domain:k.host,uri:k.href}),v?{statement:v}:null));let q;if(Array.isArray(E)&&E[0]&&typeof E[0]=="object")q=E[0];else if(E&&typeof E=="object"&&"signedMessage"in E&&"signature"in E)q=E;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in q&&"signature"in q&&(typeof q.signedMessage=="string"||q.signedMessage instanceof Uint8Array)&&q.signature instanceof Uint8Array)p=typeof q.signedMessage=="string"?q.signedMessage:new TextDecoder().decode(q.signedMessage),y=q.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in w)||typeof w.signMessage!="function"||!("publicKey"in w)||typeof w!="object"||!w.publicKey||!("toBase58"in w.publicKey)||typeof w.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");p=[`${k.host} wants you to sign in with your Solana account:`,w.publicKey.toBase58(),...v?["",v,""]:[""],"Version: 1",`URI: ${k.href}`,`Issued At: ${(n=(s=m==null?void 0:m.signInWithSolana)===null||s===void 0?void 0:s.issuedAt)!==null&&n!==void 0?n:new Date().toISOString()}`,...!((a=m==null?void 0:m.signInWithSolana)===null||a===void 0)&&a.notBefore?[`Not Before: ${m.signInWithSolana.notBefore}`]:[],...!((i=m==null?void 0:m.signInWithSolana)===null||i===void 0)&&i.expirationTime?[`Expiration Time: ${m.signInWithSolana.expirationTime}`]:[],...!((o=m==null?void 0:m.signInWithSolana)===null||o===void 0)&&o.chainId?[`Chain ID: ${m.signInWithSolana.chainId}`]:[],...!((l=m==null?void 0:m.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${m.signInWithSolana.nonce}`]:[],...!((c=m==null?void 0:m.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${m.signInWithSolana.requestId}`]:[],...!((h=(d=m==null?void 0:m.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||h===void 0)&&h.length?["Resources",...m.signInWithSolana.resources.map(q=>`- ${q}`)]:[]].join(`
`);const E=await w.signMessage(new TextEncoder().encode(p),"utf8");if(!E||!(E instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");y=E}}try{const{data:_,error:g}=await D(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:p,signature:Xe(y)},!((u=t.options)===null||u===void 0)&&u.captchaToken?{gotrue_meta_security:{captcha_token:(f=t.options)===null||f===void 0?void 0:f.captchaToken}}:null),xform:_e});if(g)throw g;if(!_||!_.session||!_.user){const v=new st;return this._returnResult({data:{user:null,session:null},error:v})}return _.session&&(await this._saveSession(_.session),await this._notifyAllSubscribers("SIGNED_IN",_.session)),this._returnResult({data:Object.assign({},_),error:g})}catch(_){if(R(_))return this._returnResult({data:{user:null,session:null},error:_});throw _}}async _exchangeCodeForSession(t){const r=await Ke(this.storage,`${this.storageKey}-code-verifier`),[s,n]=(r??"").split("/");try{if(!s&&this.flowType==="pkce")throw new al;const{data:a,error:i}=await D(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:t,code_verifier:s},xform:_e});if(await ne(this.storage,`${this.storageKey}-code-verifier`),i)throw i;if(!a||!a.session||!a.user){const o=new st;return this._returnResult({data:{user:null,session:null,redirectType:null},error:o})}return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),this._returnResult({data:Object.assign(Object.assign({},a),{redirectType:n??null}),error:i})}catch(a){if(await ne(this.storage,`${this.storageKey}-code-verifier`),R(a))return this._returnResult({data:{user:null,session:null,redirectType:null},error:a});throw a}}async signInWithIdToken(t){try{const{options:r,provider:s,token:n,access_token:a,nonce:i}=t,o=await D(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:n,access_token:a,nonce:i,gotrue_meta_security:{captcha_token:r==null?void 0:r.captchaToken}},xform:_e}),{data:l,error:c}=o;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){const d=new st;return this._returnResult({data:{user:null,session:null},error:d})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(r){if(R(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async signInWithOtp(t){var r,s,n,a,i;try{if("email"in t){const{email:o,options:l}=t;let c=null,d=null;this.flowType==="pkce"&&([c,d]=await nt(this.storage,this.storageKey));const{error:h}=await D(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(r=l==null?void 0:l.data)!==null&&r!==void 0?r:{},create_user:(s=l==null?void 0:l.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:c,code_challenge_method:d},redirectTo:l==null?void 0:l.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:h})}if("phone"in t){const{phone:o,options:l}=t,{data:c,error:d}=await D(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(n=l==null?void 0:l.data)!==null&&n!==void 0?n:{},create_user:(a=l==null?void 0:l.shouldCreateUser)!==null&&a!==void 0?a:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(i=l==null?void 0:l.channel)!==null&&i!==void 0?i:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c==null?void 0:c.message_id},error:d})}throw new _r("You must provide either an email or phone number.")}catch(o){if(await ne(this.storage,`${this.storageKey}-code-verifier`),R(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async verifyOtp(t){var r,s;try{let n,a;"options"in t&&(n=(r=t.options)===null||r===void 0?void 0:r.redirectTo,a=(s=t.options)===null||s===void 0?void 0:s.captchaToken);const{data:i,error:o}=await D(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},t),{gotrue_meta_security:{captcha_token:a}}),redirectTo:n,xform:_e});if(o)throw o;if(!i)throw new Error("An error occurred on token verification.");const l=i.session,c=i.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(t.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(n){if(R(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithSSO(t){var r,s,n,a,i;try{let o=null,l=null;this.flowType==="pkce"&&([o,l]=await nt(this.storage,this.storageKey));const c=await D(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in t?{provider_id:t.providerId}:null),"domain"in t?{domain:t.domain}:null),{redirect_to:(s=(r=t.options)===null||r===void 0?void 0:r.redirectTo)!==null&&s!==void 0?s:void 0}),!((n=t==null?void 0:t.options)===null||n===void 0)&&n.captchaToken?{gotrue_meta_security:{captcha_token:t.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:o,code_challenge_method:l}),headers:this.headers,xform:xl});return!((a=c.data)===null||a===void 0)&&a.url&&ae()&&!(!((i=t.options)===null||i===void 0)&&i.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(o){if(await ne(this.storage,`${this.storageKey}-code-verifier`),R(o))return this._returnResult({data:null,error:o});throw o}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;if(s)throw s;if(!r)throw new ue;const{error:n}=await D(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:r.access_token});return this._returnResult({data:{user:null,session:null},error:n})})}catch(t){if(R(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async resend(t){try{const r=`${this.url}/resend`;if("email"in t){const{email:s,type:n,options:a}=t,{error:i}=await D(this.fetch,"POST",r,{headers:this.headers,body:{email:s,type:n,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},redirectTo:a==null?void 0:a.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:i})}else if("phone"in t){const{phone:s,type:n,options:a}=t,{data:i,error:o}=await D(this.fetch,"POST",r,{headers:this.headers,body:{phone:s,type:n,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:i==null?void 0:i.message_id},error:o})}throw new _r("You must provide either an email or phone number and a type")}catch(r){if(R(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async r=>r))}async _acquireLock(t,r){this._debug("#_acquireLock","begin",t);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),n=(async()=>(await s,await r()))();return this.pendingInLock.push((async()=>{try{await n}catch{}})()),n}return await this.lock(`lock:${this.storageKey}`,t,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=r();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const n=[...this.pendingInLock];await Promise.all(n),this.pendingInLock.splice(0,n.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(t){this._debug("#_useSession","begin");try{const r=await this.__loadSession();return await t(r)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let t=null;const r=await Ke(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",r),r!==null&&(this._isValidSession(r)?t=r:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!t)return{data:{session:null},error:null};const s=t.expires_at?t.expires_at*1e3-Date.now()<os:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",t.expires_at),!s){if(this.userStorage){const i=await Ke(this.userStorage,this.storageKey+"-user");i!=null&&i.user?t.user=i.user:t.user=ds()}if(this.storage.isServer&&t.user&&!t.user.__isUserNotAvailableProxy){const i={value:this.suppressGetSessionWarning};t.user=ql(t.user,i),i.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:t},error:null}}const{data:n,error:a}=await this._callRefreshToken(t.refresh_token);return a?this._returnResult({data:{session:null},error:a}):this._returnResult({data:{session:n},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(t){if(t)return await this._getUser(t);await this.initializePromise;const r=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return r.data.user&&(this.suppressGetSessionWarning=!0),r}async _getUser(t){try{return t?await D(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:t,xform:Ne}):await this._useSession(async r=>{var s,n,a;const{data:i,error:o}=r;if(o)throw o;return!(!((s=i.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new ue}:await D(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(a=(n=i.session)===null||n===void 0?void 0:n.access_token)!==null&&a!==void 0?a:void 0,xform:Ne})})}catch(r){if(R(r))return ls(r)&&(await this._removeSession(),await ne(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:r});throw r}}async updateUser(t,r={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(t,r))}async _updateUser(t,r={}){try{return await this._useSession(async s=>{const{data:n,error:a}=s;if(a)throw a;if(!n.session)throw new ue;const i=n.session;let o=null,l=null;this.flowType==="pkce"&&t.email!=null&&([o,l]=await nt(this.storage,this.storageKey));const{data:c,error:d}=await D(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:r==null?void 0:r.emailRedirectTo,body:Object.assign(Object.assign({},t),{code_challenge:o,code_challenge_method:l}),jwt:i.access_token,xform:Ne});if(d)throw d;return i.user=c.user,await this._saveSession(i),await this._notifyAllSubscribers("USER_UPDATED",i),this._returnResult({data:{user:i.user},error:null})})}catch(s){if(await ne(this.storage,`${this.storageKey}-code-verifier`),R(s))return this._returnResult({data:{user:null},error:s});throw s}}async setSession(t){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(t))}async _setSession(t){try{if(!t.access_token||!t.refresh_token)throw new ue;const r=Date.now()/1e3;let s=r,n=!0,a=null;const{payload:i}=Sr(t.access_token);if(i.exp&&(s=i.exp,n=s<=r),n){const{data:o,error:l}=await this._callRefreshToken(t.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!o)return{data:{user:null,session:null},error:null};a=o}else{const{data:o,error:l}=await this._getUser(t.access_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});a={access_token:t.access_token,refresh_token:t.refresh_token,user:o.user,token_type:"bearer",expires_in:s-r,expires_at:s},await this._saveSession(a),await this._notifyAllSubscribers("SIGNED_IN",a)}return this._returnResult({data:{user:a.user,session:a},error:null})}catch(r){if(R(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}}async refreshSession(t){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(t))}async _refreshSession(t){try{return await this._useSession(async r=>{var s;if(!t){const{data:i,error:o}=r;if(o)throw o;t=(s=i.session)!==null&&s!==void 0?s:void 0}if(!(t!=null&&t.refresh_token))throw new ue;const{data:n,error:a}=await this._callRefreshToken(t.refresh_token);return a?this._returnResult({data:{user:null,session:null},error:a}):n?this._returnResult({data:{user:n.user,session:n},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(r){if(R(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async _getSessionFromURL(t,r){try{if(!ae())throw new wr("No browser detected.");if(t.error||t.error_description||t.error_code)throw new wr(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});switch(r){case"implicit":if(this.flowType==="pkce")throw new Rn("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new wr("Not a valid implicit grant flow url.");break;default:}if(r==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!t.code)throw new Rn("No code detected.");const{data:v,error:m}=await this._exchangeCodeForSession(t.code);if(m)throw m;const w=new URL(window.location.href);return w.searchParams.delete("code"),window.history.replaceState(window.history.state,"",w.toString()),{data:{session:v.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:n,access_token:a,refresh_token:i,expires_in:o,expires_at:l,token_type:c}=t;if(!a||!o||!i||!c)throw new wr("No session defined in URL");const d=Math.round(Date.now()/1e3),h=parseInt(o);let u=d+h;l&&(u=parseInt(l));const f=u-d;f*1e3<=dt&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${h}s`);const p=u-h;d-p>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",p,u,d):d-p<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",p,u,d);const{data:y,error:_}=await this._getUser(a);if(_)throw _;const g={provider_token:s,provider_refresh_token:n,access_token:a,expires_in:h,expires_at:u,refresh_token:i,token_type:c,user:y.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:g,redirectType:t.type},error:null})}catch(s){if(R(s))return this._returnResult({data:{session:null,redirectType:null},error:s});throw s}}_isImplicitGrantCallback(t){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),t):!!(t.access_token||t.error_description)}async _isPKCECallback(t){const r=await Ke(this.storage,`${this.storageKey}-code-verifier`);return!!(t.code&&r)}async signOut(t={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(t))}async _signOut({scope:t}={scope:"global"}){return await this._useSession(async r=>{var s;const{data:n,error:a}=r;if(a&&!ls(a))return this._returnResult({error:a});const i=(s=n.session)===null||s===void 0?void 0:s.access_token;if(i){const{error:o}=await this.admin.signOut(i,t);if(o&&!(sl(o)&&(o.status===404||o.status===401||o.status===403)||ls(o)))return this._returnResult({error:o})}return t!=="others"&&(await this._removeSession(),await ne(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(t){const r=hl(),s={id:r,callback:t,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",r),this.stateChangeEmitters.delete(r)}};return this._debug("#onAuthStateChange()","registered callback with id",r),this.stateChangeEmitters.set(r,s),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(r)})))(),{data:{subscription:s}}}async _emitInitialSession(t){return await this._useSession(async r=>{var s,n;try{const{data:{session:a},error:i}=r;if(i)throw i;await((s=this.stateChangeEmitters.get(t))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",a)),this._debug("INITIAL_SESSION","callback id",t,"session",a)}catch(a){await((n=this.stateChangeEmitters.get(t))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",t,"error",a),console.error(a)}})}async resetPasswordForEmail(t,r={}){let s=null,n=null;this.flowType==="pkce"&&([s,n]=await nt(this.storage,this.storageKey,!0));try{return await D(this.fetch,"POST",`${this.url}/recover`,{body:{email:t,code_challenge:s,code_challenge_method:n,gotrue_meta_security:{captcha_token:r.captchaToken}},headers:this.headers,redirectTo:r.redirectTo})}catch(a){if(await ne(this.storage,`${this.storageKey}-code-verifier`),R(a))return this._returnResult({data:null,error:a});throw a}}async getUserIdentities(){var t;try{const{data:r,error:s}=await this.getUser();if(s)throw s;return this._returnResult({data:{identities:(t=r.user.identities)!==null&&t!==void 0?t:[]},error:null})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}}async linkIdentity(t){return"token"in t?this.linkIdentityIdToken(t):this.linkIdentityOAuth(t)}async linkIdentityOAuth(t){var r;try{const{data:s,error:n}=await this._useSession(async a=>{var i,o,l,c,d;const{data:h,error:u}=a;if(u)throw u;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,t.provider,{redirectTo:(i=t.options)===null||i===void 0?void 0:i.redirectTo,scopes:(o=t.options)===null||o===void 0?void 0:o.scopes,queryParams:(l=t.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await D(this.fetch,"GET",f,{headers:this.headers,jwt:(d=(c=h.session)===null||c===void 0?void 0:c.access_token)!==null&&d!==void 0?d:void 0})});if(n)throw n;return ae()&&!(!((r=t.options)===null||r===void 0)&&r.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),this._returnResult({data:{provider:t.provider,url:s==null?void 0:s.url},error:null})}catch(s){if(R(s))return this._returnResult({data:{provider:t.provider,url:null},error:s});throw s}}async linkIdentityIdToken(t){return await this._useSession(async r=>{var s;try{const{error:n,data:{session:a}}=r;if(n)throw n;const{options:i,provider:o,token:l,access_token:c,nonce:d}=t,h=await D(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(s=a==null?void 0:a.access_token)!==null&&s!==void 0?s:void 0,body:{provider:o,id_token:l,access_token:c,nonce:d,link_identity:!0,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},xform:_e}),{data:u,error:f}=h;return f?this._returnResult({data:{user:null,session:null},error:f}):!u||!u.session||!u.user?this._returnResult({data:{user:null,session:null},error:new st}):(u.session&&(await this._saveSession(u.session),await this._notifyAllSubscribers("USER_UPDATED",u.session)),this._returnResult({data:u,error:f}))}catch(n){if(await ne(this.storage,`${this.storageKey}-code-verifier`),R(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}})}async unlinkIdentity(t){try{return await this._useSession(async r=>{var s,n;const{data:a,error:i}=r;if(i)throw i;return await D(this.fetch,"DELETE",`${this.url}/user/identities/${t.identity_id}`,{headers:this.headers,jwt:(n=(s=a.session)===null||s===void 0?void 0:s.access_token)!==null&&n!==void 0?n:void 0})})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}}async _refreshAccessToken(t){const r=`#_refreshAccessToken(${t.substring(0,5)}...)`;this._debug(r,"begin");try{const s=Date.now();return await ml(async n=>(n>0&&await yl(200*Math.pow(2,n-1)),this._debug(r,"refreshing attempt",n),await D(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:t},headers:this.headers,xform:_e})),(n,a)=>{const i=200*Math.pow(2,n);return a&&cs(a)&&Date.now()+i-s<dt})}catch(s){if(this._debug(r,"error",s),R(s))return this._returnResult({data:{session:null,user:null},error:s});throw s}finally{this._debug(r,"end")}}_isValidSession(t){return typeof t=="object"&&t!==null&&"access_token"in t&&"refresh_token"in t&&"expires_at"in t}async _handleProviderSignIn(t,r){const s=await this._getUrlForProvider(`${this.url}/authorize`,t,{redirectTo:r.redirectTo,scopes:r.scopes,queryParams:r.queryParams});return this._debug("#_handleProviderSignIn()","provider",t,"options",r,"url",s),ae()&&!r.skipBrowserRedirect&&window.location.assign(s),{data:{provider:t,url:s},error:null}}async _recoverAndRefresh(){var t,r;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const n=await Ke(this.storage,this.storageKey);if(n&&this.userStorage){let i=await Ke(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!i&&(i={user:n.user},await ut(this.userStorage,this.storageKey+"-user",i)),n.user=(t=i==null?void 0:i.user)!==null&&t!==void 0?t:ds()}else if(n&&!n.user&&!n.user){const i=await Ke(this.storage,this.storageKey+"-user");i&&(i!=null&&i.user)?(n.user=i.user,await ne(this.storage,this.storageKey+"-user"),await ut(this.storage,this.storageKey,n)):n.user=ds()}if(this._debug(s,"session from storage",n),!this._isValidSession(n)){this._debug(s,"session is not valid"),n!==null&&await this._removeSession();return}const a=((r=n.expires_at)!==null&&r!==void 0?r:1/0)*1e3-Date.now()<os;if(this._debug(s,`session has${a?"":" not"} expired with margin of ${os}s`),a){if(this.autoRefreshToken&&n.refresh_token){const{error:i}=await this._callRefreshToken(n.refresh_token);i&&(console.error(i),cs(i)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",i),await this._removeSession()))}}else if(n.user&&n.user.__isUserNotAvailableProxy===!0)try{const{data:i,error:o}=await this._getUser(n.access_token);!o&&(i!=null&&i.user)?(n.user=i.user,await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(i){console.error("Error getting user data:",i),this._debug(s,"error getting user data, skipping SIGNED_IN notification",i)}else await this._notifyAllSubscribers("SIGNED_IN",n)}catch(n){this._debug(s,"error",n),console.error(n);return}finally{this._debug(s,"end")}}async _callRefreshToken(t){var r,s;if(!t)throw new ue;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const n=`#_callRefreshToken(${t.substring(0,5)}...)`;this._debug(n,"begin");try{this.refreshingDeferred=new Xr;const{data:a,error:i}=await this._refreshAccessToken(t);if(i)throw i;if(!a.session)throw new ue;await this._saveSession(a.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",a.session);const o={data:a.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(a){if(this._debug(n,"error",a),R(a)){const i={data:null,error:a};return cs(a)||await this._removeSession(),(r=this.refreshingDeferred)===null||r===void 0||r.resolve(i),i}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(a),a}finally{this.refreshingDeferred=null,this._debug(n,"end")}}async _notifyAllSubscribers(t,r,s=!0){const n=`#_notifyAllSubscribers(${t})`;this._debug(n,"begin",r,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:t,session:r});const a=[],i=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(t,r)}catch(l){a.push(l)}});if(await Promise.all(i),a.length>0){for(let o=0;o<a.length;o+=1)console.error(a[o]);throw a[0]}}finally{this._debug(n,"end")}}async _saveSession(t){this._debug("#_saveSession()",t),this.suppressGetSessionWarning=!0,await ne(this.storage,`${this.storageKey}-code-verifier`);const r=Object.assign({},t),s=r.user&&r.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!s&&r.user&&await ut(this.userStorage,this.storageKey+"-user",{user:r.user});const n=Object.assign({},r);delete n.user;const a=Dn(n);await ut(this.storage,this.storageKey,a)}else{const n=Dn(r);await ut(this.storage,this.storageKey,n)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await ne(this.storage,this.storageKey),await ne(this.storage,this.storageKey+"-code-verifier"),await ne(this.storage,this.storageKey+"-user"),this.userStorage&&await ne(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const t=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{t&&ae()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",t)}catch(r){console.error("removing visibilitychange callback failed",r)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const t=setInterval(()=>this._autoRefreshTokenTick(),dt);this.autoRefreshTicker=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t);const r=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=r,r&&typeof r=="object"&&typeof r.unref=="function"?r.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(r)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const t=this.autoRefreshTicker;this.autoRefreshTicker=null,t&&clearInterval(t);const r=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,r&&clearTimeout(r)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const t=Date.now();try{return await this._useSession(async r=>{const{data:{session:s}}=r;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const n=Math.floor((s.expires_at*1e3-t)/dt);this._debug("#_autoRefreshTokenTick()",`access token expires in ${n} ticks, a tick lasts ${dt}ms, refresh threshold is ${As} ticks`),n<=As&&await this._callRefreshToken(s.refresh_token)})}catch(r){console.error("Auto refresh tick failed with error. This is likely a transient error.",r)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(t){if(t.isAcquireTimeout||t instanceof Xa)this._debug("auto refresh token tick lock not available");else throw t}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!ae()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>{try{await this._onVisibilityChanged(!1)}catch(t){this._debug("#visibilityChangedCallback","error",t)}},window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(t){console.error("_handleVisibilityChange",t)}}async _onVisibilityChanged(t){const r=`#_onVisibilityChanged(${t})`;this._debug(r,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),t||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(r,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(t,r,s){const n=[`provider=${encodeURIComponent(r)}`];if(s!=null&&s.redirectTo&&n.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&n.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[a,i]=await nt(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(a)}`,code_challenge_method:`${encodeURIComponent(i)}`});n.push(o.toString())}if(s!=null&&s.queryParams){const a=new URLSearchParams(s.queryParams);n.push(a.toString())}return s!=null&&s.skipBrowserRedirect&&n.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${t}?${n.join("&")}`}async _unenroll(t){try{return await this._useSession(async r=>{var s;const{data:n,error:a}=r;return a?this._returnResult({data:null,error:a}):await D(this.fetch,"DELETE",`${this.url}/factors/${t.factorId}`,{headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token})})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}}async _enroll(t){try{return await this._useSession(async r=>{var s,n;const{data:a,error:i}=r;if(i)return this._returnResult({data:null,error:i});const o=Object.assign({friendly_name:t.friendlyName,factor_type:t.factorType},t.factorType==="phone"?{phone:t.phone}:t.factorType==="totp"?{issuer:t.issuer}:{}),{data:l,error:c}=await D(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(s=a==null?void 0:a.session)===null||s===void 0?void 0:s.access_token});return c?this._returnResult({data:null,error:c}):(t.factorType==="totp"&&l.type==="totp"&&(!((n=l==null?void 0:l.totp)===null||n===void 0)&&n.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}}async _verify(t){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async r=>{var s;const{data:n,error:a}=r;if(a)return this._returnResult({data:null,error:a});const i=Object.assign({challenge_id:t.challengeId},"webauthn"in t?{webauthn:Object.assign(Object.assign({},t.webauthn),{credential_response:t.webauthn.type==="create"?zl(t.webauthn.credential_response):Vl(t.webauthn.credential_response)})}:{code:t.code}),{data:o,error:l}=await D(this.fetch,"POST",`${this.url}/factors/${t.factorId}/verify`,{body:i,headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),this._returnResult({data:o,error:l}))})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}})}async _challenge(t){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async r=>{var s;const{data:n,error:a}=r;if(a)return this._returnResult({data:null,error:a});const i=await D(this.fetch,"POST",`${this.url}/factors/${t.factorId}/challenge`,{body:t,headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});if(i.error)return i;const{data:o}=i;if(o.type!=="webauthn")return{data:o,error:null};switch(o.webauthn.type){case"create":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:Kl(o.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:Wl(o.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}})}async _challengeAndVerify(t){const{data:r,error:s}=await this._challenge({factorId:t.factorId});return s?this._returnResult({data:null,error:s}):await this._verify({factorId:t.factorId,challengeId:r.id,code:t.code})}async _listFactors(){var t;const{data:{user:r},error:s}=await this.getUser();if(s)return{data:null,error:s};const n={all:[],phone:[],totp:[],webauthn:[]};for(const a of(t=r==null?void 0:r.factors)!==null&&t!==void 0?t:[])n.all.push(a),a.status==="verified"&&n[a.factor_type].push(a);return{data:n,error:null}}async _getAuthenticatorAssuranceLevel(t){var r,s,n,a;if(t)try{const{payload:f}=Sr(t);let p=null;f.aal&&(p=f.aal);let y=p;const{data:{user:_},error:g}=await this.getUser(t);if(g)return this._returnResult({data:null,error:g});((s=(r=_==null?void 0:_.factors)===null||r===void 0?void 0:r.filter(w=>w.status==="verified"))!==null&&s!==void 0?s:[]).length>0&&(y="aal2");const m=f.amr||[];return{data:{currentLevel:p,nextLevel:y,currentAuthenticationMethods:m},error:null}}catch(f){if(R(f))return this._returnResult({data:null,error:f});throw f}const{data:{session:i},error:o}=await this.getSession();if(o)return this._returnResult({data:null,error:o});if(!i)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:l}=Sr(i.access_token);let c=null;l.aal&&(c=l.aal);let d=c;((a=(n=i.user.factors)===null||n===void 0?void 0:n.filter(f=>f.status==="verified"))!==null&&a!==void 0?a:[]).length>0&&(d="aal2");const u=l.amr||[];return{data:{currentLevel:c,nextLevel:d,currentAuthenticationMethods:u},error:null}}async _getAuthorizationDetails(t){try{return await this._useSession(async r=>{const{data:{session:s},error:n}=r;return n?this._returnResult({data:null,error:n}):s?await D(this.fetch,"GET",`${this.url}/oauth/authorizations/${t}`,{headers:this.headers,jwt:s.access_token,xform:a=>({data:a,error:null})}):this._returnResult({data:null,error:new ue})})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}}async _approveAuthorization(t,r){try{return await this._useSession(async s=>{const{data:{session:n},error:a}=s;if(a)return this._returnResult({data:null,error:a});if(!n)return this._returnResult({data:null,error:new ue});const i=await D(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:n.access_token,body:{action:"approve"},xform:o=>({data:o,error:null})});return i.data&&i.data.redirect_url&&ae()&&!(r!=null&&r.skipBrowserRedirect)&&window.location.assign(i.data.redirect_url),i})}catch(s){if(R(s))return this._returnResult({data:null,error:s});throw s}}async _denyAuthorization(t,r){try{return await this._useSession(async s=>{const{data:{session:n},error:a}=s;if(a)return this._returnResult({data:null,error:a});if(!n)return this._returnResult({data:null,error:new ue});const i=await D(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:n.access_token,body:{action:"deny"},xform:o=>({data:o,error:null})});return i.data&&i.data.redirect_url&&ae()&&!(r!=null&&r.skipBrowserRedirect)&&window.location.assign(i.data.redirect_url),i})}catch(s){if(R(s))return this._returnResult({data:null,error:s});throw s}}async _listOAuthGrants(){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?await D(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,xform:n=>({data:n,error:null})}):this._returnResult({data:null,error:new ue})})}catch(t){if(R(t))return this._returnResult({data:null,error:t});throw t}}async _revokeOAuthGrant(t){try{return await this._useSession(async r=>{const{data:{session:s},error:n}=r;return n?this._returnResult({data:null,error:n}):s?(await D(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:s.access_token,query:{client_id:t.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new ue})})}catch(r){if(R(r))return this._returnResult({data:null,error:r});throw r}}async fetchJwk(t,r={keys:[]}){let s=r.keys.find(o=>o.kid===t);if(s)return s;const n=Date.now();if(s=this.jwks.keys.find(o=>o.kid===t),s&&this.jwks_cached_at+tl>n)return s;const{data:a,error:i}=await D(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(i)throw i;return!a.keys||a.keys.length===0||(this.jwks=a,this.jwks_cached_at=n,s=a.keys.find(o=>o.kid===t),!s)?null:s}async getClaims(t,r={}){try{let s=t;if(!s){const{data:f,error:p}=await this.getSession();if(p||!f.session)return this._returnResult({data:null,error:p});s=f.session.access_token}const{header:n,payload:a,signature:i,raw:{header:o,payload:l}}=Sr(s);r!=null&&r.allowExpired||kl(a.exp);const c=!n.alg||n.alg.startsWith("HS")||!n.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(n.kid,r!=null&&r.keys?{keys:r.keys}:r==null?void 0:r.jwks);if(!c){const{error:f}=await this.getUser(s);if(f)throw f;return{data:{claims:a,header:n,signature:i},error:null}}const d=El(n.alg),h=await crypto.subtle.importKey("jwk",c,d,!0,["verify"]);if(!await crypto.subtle.verify(d,h,i,dl(`${o}.${l}`)))throw new Is("Invalid JWT signature");return{data:{claims:a,header:n,signature:i},error:null}}catch(s){if(R(s))return this._returnResult({data:null,error:s});throw s}}}nr.nextInstanceID={};const rc=nr,sc="2.95.3";let zt="";typeof Deno<"u"?zt="deno":typeof document<"u"?zt="web":typeof navigator<"u"&&navigator.product==="ReactNative"?zt="react-native":zt="node";const nc={"X-Client-Info":`supabase-js-${zt}/${sc}`},ac={headers:nc},ic={schema:"public"},oc={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},lc={};function ar(e){"@babel/helpers - typeof";return ar=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ar(e)}function cc(e,t){if(ar(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var s=r.call(e,t);if(ar(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function dc(e){var t=cc(e,"string");return ar(t)=="symbol"?t:t+""}function uc(e,t,r){return(t=dc(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Bn(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,s)}return r}function Q(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?Bn(Object(r),!0).forEach(function(s){uc(e,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Bn(Object(r)).forEach(function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s))})}return e}const hc=e=>e?(...t)=>e(...t):(...t)=>fetch(...t),fc=()=>Headers,pc=(e,t,r)=>{const s=hc(r),n=fc();return async(a,i)=>{var o;const l=(o=await t())!==null&&o!==void 0?o:e;let c=new n(i==null?void 0:i.headers);return c.has("apikey")||c.set("apikey",e),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),s(a,Q(Q({},i),{},{headers:c}))}};function yc(e){return e.endsWith("/")?e:e+"/"}function mc(e,t){var r,s;const{db:n,auth:a,realtime:i,global:o}=e,{db:l,auth:c,realtime:d,global:h}=t,u={db:Q(Q({},l),n),auth:Q(Q({},c),a),realtime:Q(Q({},d),i),storage:{},global:Q(Q(Q({},h),o),{},{headers:Q(Q({},(r=h==null?void 0:h.headers)!==null&&r!==void 0?r:{}),(s=o==null?void 0:o.headers)!==null&&s!==void 0?s:{})}),accessToken:async()=>""};return e.accessToken?u.accessToken=e.accessToken:delete u.accessToken,u}function gc(e){const t=e==null?void 0:e.trim();if(!t)throw new Error("supabaseUrl is required.");if(!t.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(yc(t))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var bc=class extends rc{constructor(e){super(e)}},vc=class{constructor(e,t,r){var s,n;this.supabaseUrl=e,this.supabaseKey=t;const a=gc(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",a),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",a),this.storageUrl=new URL("storage/v1",a),this.functionsUrl=new URL("functions/v1",a);const i=`sb-${a.hostname.split(".")[0]}-auth-token`,o={db:ic,realtime:lc,auth:Q(Q({},oc),{},{storageKey:i}),global:ac},l=mc(r??{},o);if(this.storageKey=(s=l.auth.storageKey)!==null&&s!==void 0?s:"",this.headers=(n=l.global.headers)!==null&&n!==void 0?n:{},l.accessToken)this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(d,h)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(h)} is not possible`)}});else{var c;this.auth=this._initSupabaseAuthClient((c=l.auth)!==null&&c!==void 0?c:{},this.headers,l.global.fetch)}this.fetch=pc(t,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(Q({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(d=>this.realtime.setAuth(d)).catch(d=>console.warn("Failed to set initial Realtime auth token:",d)),this.rest=new ro(new URL("rest/v1",a).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch,timeout:l.db.timeout,urlLengthLimit:l.db.urlLengthLimit}),this.storage=new Qo(this.storageUrl.href,this.headers,this.fetch,r==null?void 0:r.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new Gi(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},r={head:!1,get:!1,count:void 0}){return this.rest.rpc(e,t,r)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var e=this,t,r;if(e.accessToken)return await e.accessToken();const{data:s}=await e.auth.getSession();return(t=(r=s.session)===null||r===void 0?void 0:r.access_token)!==null&&t!==void 0?t:e.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,userStorage:n,storageKey:a,flowType:i,lock:o,debug:l,throwOnError:c},d,h){const u={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new bc({url:this.authUrl.href,headers:Q(Q({},u),d),storageKey:a,autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,userStorage:n,flowType:i,lock:o,debug:l,throwOnError:c,fetch:h,hasCustomAuthorizationHeader:Object.keys(this.headers).some(f=>f.toLowerCase()==="authorization")})}_initRealtimeClient(e){return new _o(this.realtimeUrl.href,Q(Q({},e),{},{params:Q(Q({},{apikey:this.supabaseKey}),e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((e,t)=>{this._handleTokenChanged(e,"CLIENT",t==null?void 0:t.access_token)})}_handleTokenChanged(e,t,r){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==r?(this.changedAccessToken=r,this.realtime.setAuth(r)):e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const _c=(e,t,r)=>new vc(e,t,r);function wc(){if(typeof window<"u")return!1;const e=globalThis.process;if(!e)return!1;const t=e.version;if(t==null)return!1;const r=t.match(/^v(\d+)\./);return r?parseInt(r[1],10)<=18:!1}wc()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const Sc="https://ujxczpaupfqaiqrcoykl.supabase.co",kc="sb_publishable_EJ7wzzBh1hnKE0j_j7E1mQ_9TAJvRoO",S=_c(Sc,kc),Kn="app-toast-container";function Ec(){let e=document.getElementById(Kn);return e||(e=document.createElement("div"),e.id=Kn,e.className="toast-container position-fixed top-0 end-0 p-3",e.style.zIndex="1080",document.body.appendChild(e)),e}function Tc(e){return e==="success"?"text-bg-success":e==="error"?"text-bg-danger":e==="warning"?"text-bg-warning":"text-bg-primary"}function qc(e){const t=String(e||"").trim(),r=t.toLowerCase();return t?r.includes("row-level security")||r.includes("violates row-level security policy")?"     .":r.includes("foreign key constraint")||r.includes("violates foreign key constraint")?"     ,       .":r.includes("duplicate key value")||r.includes("unique constraint")||r.includes("already exists")?"     .":r.includes("violates not-null constraint")?"  .   .":r.includes("invalid input syntax")||r.includes("invalid uuid")||r.includes("date/time field value out of range")?"    .":r.includes("permission denied")||r.includes("not authorized")||r.includes("unauthorized")?"    .":r.includes("jwt")||r.includes("token")||r.includes("session")?"  .    .":r.includes("failed to fetch")||r.includes("networkerror")||r.includes("network request failed")?"  .     .":t:"  ."}function b(e,t="info"){const r=Ec(),s=document.createElement("div"),n=t==="error"?qc(e):String(e??"");s.className=`toast align-items-center border-0 ${Tc(t)} show`,s.setAttribute("role","alert"),s.setAttribute("aria-live","assertive"),s.setAttribute("aria-atomic","true"),s.innerHTML=`
    <div class="d-flex">
      <div class="toast-body">${n}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
    </div>
  `;const a=s.querySelector("button");a==null||a.addEventListener("click",()=>{s.remove()}),r.appendChild(s),window.setTimeout(()=>{s.remove()},4e3)}async function Wn(){const{data:e,error:t}=await S.auth.getSession();return t?null:e.session||null}async function ti(e){if(!e)return!1;const{data:t,error:r}=await S.from("user_roles").select("id").eq("user_id",e).eq("role","admin").limit(1);return r?!1:Array.isArray(t)&&t.length>0}const ri="traincrewhub_permission_banner_enabled",Lc={page_plan_schedule:" -",page_schedule:" ",schedule_keys:"-",duties:"",duty_types:" ",trains:"",employees:"",employee_absences:"",planned_duties:" ",actual_duties:" ",user_roles:"  ",user_profiles:" ",role_permissions:"  ",schedule_key_duties:"  -",positions:"",absence_reasons:"  ",duty_trains:"  "},Cs={none:0,own:1,role_attached_employees:2,all:3};let ze="",Qe=new Map,Ve=!1,Ze=null;function pt(e){const t=String(e||"").trim();return Object.hasOwn(Cs,t)?t:"none"}function kr(e,t){const r=pt(e),s=pt(t);return Cs[r]>=Cs[s]?r:s}async function $c(){var l,c;const{data:e}=await S.auth.getSession(),t=((c=(l=e==null?void 0:e.session)==null?void 0:l.user)==null?void 0:c.id)||"";if(!t){ze="",Qe=new Map,Ve=!0;return}if(Ve&&ze===t)return;const{data:r,error:s}=await S.from("user_roles").select("role").eq("user_id",t);if(s){ze=t,Qe=new Map,Ve=!0;return}const n=[...new Set((r||[]).map(d=>String((d==null?void 0:d.role)||"").trim()).filter(Boolean))];if(!n.length){ze=t,Qe=new Map,Ve=!0;return}const{data:a,error:i}=await S.from("role_permissions").select("resource, view_screen_scope, view_records_scope, edit_records_scope, delete_records_scope").in("role",n);if(i){ze=t,Qe=new Map,Ve=!0;return}const o=new Map;(a||[]).forEach(d=>{const h=String((d==null?void 0:d.resource)||"").trim();if(!h)return;const u=o.get(h)||{view_screen_scope:"none",view_records_scope:"none",edit_records_scope:"none",delete_records_scope:"none"};o.set(h,{view_screen_scope:kr(u.view_screen_scope,d==null?void 0:d.view_screen_scope),view_records_scope:kr(u.view_records_scope,d==null?void 0:d.view_records_scope),edit_records_scope:kr(u.edit_records_scope,d==null?void 0:d.edit_records_scope),delete_records_scope:kr(u.delete_records_scope,d==null?void 0:d.delete_records_scope)})}),ze=t,Qe=o,Ve=!0}async function et(e,t){await $c();const r=String(e||"").trim(),s=String(t||"").trim();if(!r||!s)return"none";const n=Qe.get(r);return n?s==="view_screen"?pt(n.view_screen_scope):s==="view_records"?pt(n.view_records_scope):s==="edit_records"?pt(n.edit_records_scope):s==="delete_records"?pt(n.delete_records_scope):"none":"none"}async function si(e){return await et(e,"view_screen")!=="none"}async function Ac(e){const t=String(e||"").trim();if(!t)return{view_screen:"none",view_records:"none",edit_records:"none",delete_records:"none"};const[r,s,n,a]=await Promise.all([et(t,"view_screen"),et(t,"view_records"),et(t,"edit_records"),et(t,"delete_records")]);return{view_screen:r,view_records:s,edit_records:n,delete_records:a}}function zn(e,t){e&&(e.disabled=t,e.classList.toggle("disabled",t))}async function xc(e,t){Ze&&(Ze(),Ze=null);const r=String(t||"").trim();if(!e||!r)return;const s=await et(r,"edit_records"),n=await et(r,"delete_records"),a=s==="none",i=n==="none",o=['[data-action="edit"]','[data-duty-action="edit"]','[data-action="duplicate"]','[data-duty-action="duplicate"]','button[id^="open-create-"]','button[id^="open-add-"]'],l=['[data-action="delete"]','[data-duty-action="delete"]'],c=()=>{a&&e.querySelectorAll(o.join(",")).forEach(u=>zn(u,!0)),i&&e.querySelectorAll(l.join(",")).forEach(u=>zn(u,!0))},d=u=>{const f=u.target;if(f){if(a&&f.closest(o.join(","))){u.preventDefault(),u.stopPropagation(),b("   .","warning");return}i&&f.closest(l.join(","))&&(u.preventDefault(),u.stopPropagation(),b("   .","warning"))}},h=new MutationObserver(()=>{c()});c(),e.addEventListener("click",d,!0),h.observe(e,{childList:!0,subtree:!0}),Ze=()=>{e.removeEventListener("click",d,!0),h.disconnect()}}function Rc(){Ze&&(Ze(),Ze=null)}function ni(){ze="",Qe=new Map,Ve=!1}function Zr(e){const t=String(e||"").trim();return t?Lc[t]||t:"-"}function ai(){try{const e=localStorage.getItem(ri);return e===null?!0:e==="true"}catch{return!0}}function Ic(e){try{localStorage.setItem(ri,String(!!e))}catch{}}let hs,Er,Tr,qr;async function Cc(e){const t=await se("./header.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("nav.navbar"),s=e.querySelector("#nav-sign-in"),n=e.querySelector("#nav-register"),a=e.querySelector("#nav-logout"),i=e.querySelector("#nav-admin"),o=a==null?void 0:a.querySelector("button"),l=e.querySelector("#mainNav"),c=e.querySelector(".navbar-toggler"),d=()=>{e.querySelectorAll(".nav-item.dropdown").forEach(p=>{var _;p.classList.remove("show"),(_=p.querySelector(".dropdown-menu"))==null||_.classList.remove("show");const y=p.querySelector(".dropdown-toggle");y&&y.setAttribute("aria-expanded","false")})},h=()=>{const p=window.location.pathname;e.querySelectorAll("a[data-link]").forEach(g=>{const m=g.getAttribute("href")===p;g.classList.toggle("active",m),g.setAttribute("aria-current",m?"page":"false")}),e.querySelectorAll(".nav-item.dropdown").forEach(g=>{const v=g.querySelector(".dropdown-toggle"),m=!!g.querySelector(".dropdown-item.active");v==null||v.classList.toggle("active",m),v&&v.setAttribute("aria-current",m?"page":"false")})},u=async()=>{var m;const{data:p}=await S.auth.getSession(),y=p.session,_=!!y;r==null||r.classList.toggle("d-none",!_),s==null||s.classList.toggle("d-none",_),n==null||n.classList.toggle("d-none",_),a==null||a.classList.toggle("d-none",!_);let g=!1;(m=y==null?void 0:y.user)!=null&&m.id&&(g=await ti(y.user.id)),i==null||i.classList.toggle("d-none",!g);const v={"/schedule-keys":"schedule_keys","/duties":"duties","/duty-types":"duty_types","/trains":"trains","/employees":"employees","/employee-absences":"employee_absences","/planned-duties":"planned_duties","/actual-duties":"actual_duties","/plan-schedule":"page_plan_schedule","/schedule":"page_schedule","/schedule-key-duties":"duties"};await Promise.all(Object.entries(v).map(async([w,k])=>{const E=e.querySelector(`a[data-link][href="${w}"]`),q=E==null?void 0:E.closest("li");if(!E||!q)return;if(!_){q.classList.add("d-none");return}const L=await si(k);q.classList.toggle("d-none",!L)}))};e.addEventListener("click",p=>{const y=p.target.closest(".dropdown-toggle");if(y&&e.contains(y)){p.preventDefault();const g=y.closest(".nav-item.dropdown"),v=g==null?void 0:g.querySelector(".dropdown-menu"),m=g==null?void 0:g.classList.contains("show");d(),!m&&g&&v&&(g.classList.add("show"),v.classList.add("show"),y.setAttribute("aria-expanded","true"));return}p.target.closest("a[data-link]")&&(d(),l!=null&&l.classList.contains("show")&&(l.classList.remove("show"),c==null||c.setAttribute("aria-expanded","false")))}),o==null||o.addEventListener("click",async()=>{const{error:p}=await S.auth.signOut();if(p){b(p.message,"error");return}b("Logged out successfully.","success"),window.history.pushState({},"","/login"),window.dispatchEvent(new PopStateEvent("popstate"))}),hs&&hs.unsubscribe(),Er&&window.removeEventListener("route:changed",Er),Tr&&document.removeEventListener("click",Tr),qr&&document.removeEventListener("keydown",qr),Er=h,window.addEventListener("route:changed",Er),Tr=p=>{e.contains(p.target)||d()},document.addEventListener("click",Tr),qr=p=>{p.key==="Escape"&&d()},document.addEventListener("keydown",qr);const{data:f}=S.auth.onAuthStateChange(()=>{ni(),u()});hs=f.subscription,await u(),h()}async function Oc(e){const t=await se("./footer.html",import.meta.url);e.innerHTML=t}async function Pc(e){const t=await se("./page.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("#app-header"),s=e.querySelector("#app-footer");await Promise.all([Cc(r),Oc(s)])}const de={groups:[],selectedKey:""},F={visibleMonth:"",selectedDate:"",plannedRows:[],actualRows:[],absenceRows:[]},Dc={:"text-bg-warning",:"text-bg-danger",:"text-bg-primary",:"text-bg-dark",:"text-bg-info",:"text-bg-secondary"};function Pt(){return new Date().toISOString().slice(0,10)}function es(e){return new Intl.DateTimeFormat("bg-BG",{dateStyle:"medium",timeStyle:"short"}).format(e)}function St(e){return e?new Intl.DateTimeFormat("bg-BG",{dateStyle:"medium"}).format(new Date(`${e}T00:00:00`)):"-"}function G(e){return String(e??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Dt(e){return String(e||"").trim().toLowerCase()}function Mc(e){return(e||[]).map(r=>Dt(r)).includes("admin")}function jc(e){return(e||[]).map(r=>Dt(r)).includes("crew_manager")}function Nc(e){return(e||[]).map(r=>Dt(r)).includes("head_of_transport")}function Hc(e){const t=(e||[]).map(r=>Dt(r));return t.includes("crew_instructor")||t.includes("instructor")}function ii(e){const t=(e||[]).map(r=>Dt(r));return t.includes("crew")||t.includes("crew_member")||t.includes("user")}function Uc(e){return Mc(e)?"admin":Nc(e)||Hc(e)?"head_of_transport":jc(e)?"manager":ii(e)?"crew":"default"}function Fc(e,t,r){return!e||!t?"-":r?`${e} - ${t} (+1)`:`${e} - ${t}`}function Vn(e){const t=Dt(e);return t==="driver"?"":t==="assistant_driver"?". ":""}function z(e,t,r){const s=e.querySelector(t);s&&(s.textContent=r)}function Gn(e,{username:t="",employeeName:r="",employeeId:s=""}={}){const n=e.querySelector("#index-open-employee-profile");n&&(s?(n.classList.remove("d-none"),n.setAttribute("href",`/employees?profile=${encodeURIComponent(s)}`)):(n.classList.add("d-none"),n.setAttribute("href","/employees")))}async function Bc(e){const{data:t}=await S.auth.getSession(),r=(t==null?void 0:t.session)||null,s=(r==null?void 0:r.user)||null;if(!(s!=null&&s.id))return z(e,"#index-welcome-title","   TrainCrewHub"),z(e,"#index-welcome-subtitle","   ,     ."),Gn(e,{username:"",employeeName:"",employeeId:""}),{userId:"",employeeId:"",roles:[],crew:!1,mode:"default"};const[{data:n},{data:a}]=await Promise.all([S.from("user_profiles").select("username, employee_id, employees(first_name, last_name)").eq("id",s.id).maybeSingle(),S.from("user_roles").select("role").eq("user_id",s.id)]),i=(n==null?void 0:n.username)||s.email||s.id,o=n!=null&&n.employees?`${n.employees.first_name||""} ${n.employees.last_name||""}`.trim():"",l=[...new Set((a||[]).map(c=>String((c==null?void 0:c.role)||"").trim()).filter(Boolean))];return z(e,"#index-welcome-title",`, ${i}${o?` | ${o}`:""}`),z(e,"#index-welcome-subtitle","         ."),Gn(e,{username:i,employeeName:o||"",employeeId:(n==null?void 0:n.employee_id)||""}),{userId:s.id,employeeId:(n==null?void 0:n.employee_id)||"",roles:l,crew:ii(l),mode:Uc(l)}}function Jn(e,t){const[r,s,n,a]=t;z(e,"#index-kpi-label-1",r),z(e,"#index-kpi-label-2",s),z(e,"#index-kpi-label-3",n),z(e,"#index-kpi-label-4",a)}function Lr(e,t,r,s){const n=e.querySelector(t);if(n){if(!r.length){n.innerHTML=`<tr><td colspan="3" class="text-secondary">${s}</td></tr>`;return}n.innerHTML=r.map(a=>`
      <tr>
        <td>${G(a.employeeName)}</td>
        <td>${G(a.certificateLabel)}</td>
        <td>${G(St(a.date))}</td>
      </tr>
    `).join("")}}function Kc(e){const t=new Date;t.setHours(0,0,0,0);const r=new Date(t);r.setDate(r.getDate()+30);const s=[{key:"psychological_assessment_expiry",label:" "},{key:"medical_certificate_expiry",label:""},{key:"license_expiry",label:""}],n=[],a=[];(e||[]).forEach(o=>{const l=`${(o==null?void 0:o.first_name)||""} ${(o==null?void 0:o.last_name)||""}`.trim()||"-";s.forEach(c=>{const d=o==null?void 0:o[c.key];if(!d)return;const h=new Date(`${d}T00:00:00`);if(Number.isNaN(h.getTime()))return;const u={employeeName:l,certificateLabel:c.label,date:d};if(h<t){a.push(u);return}h<=r&&n.push(u)})});const i=(o,l)=>{const c=String((o==null?void 0:o.date)||"").localeCompare(String((l==null?void 0:l.date)||""),"bg");return c!==0?c:String((o==null?void 0:o.employeeName)||"").localeCompare(String((l==null?void 0:l.employeeName)||""),"bg")};return n.sort(i),a.sort(i),{soon:n,expired:a}}function Qn(e,t){const r=String(e||"").trim().toLowerCase();return Number(t||0)<=0?"text-bg-secondary":{soon:"text-bg-warning",expired:"text-bg-danger"}[r]||"text-bg-primary"}function oi(e){const t=["text-bg-primary","text-bg-success","text-bg-warning","text-bg-danger","text-bg-info","text-bg-dark"],r=String(e||"").trim().toLowerCase();if(!r)return t[0];const s={:"text-bg-warning",do:"text-bg-danger",:"text-bg-danger",:"text-bg-warning",:"text-bg-primary",:"text-bg-info"};if(s[r])return s[r];let n=0;for(let a=0;a<r.length;a+=1)n=(n*31+r.charCodeAt(a))%2147483647;return t[Math.abs(n)%t.length]}function Yn(e,t){const r=e.querySelector("#index-certificates-soon-details"),s=e.querySelector("#index-certificates-expired-details");if(!(!r||!s)){if(t==="soon"){r.classList.toggle("d-none"),s.classList.add("d-none");return}t==="expired"&&(s.classList.toggle("d-none"),r.classList.add("d-none"))}}async function Wc(e){const t=e.querySelector("#index-certificates-panel"),r=e.querySelector("#index-certificates-soon-toggle"),s=e.querySelector("#index-certificates-expired-toggle");if(!t||!r||!s)return;const{data:n,error:a}=await S.from("employees").select("first_name, last_name, psychological_assessment_expiry, medical_certificate_expiry, license_expiry").eq("is_active",!0).order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(a){b("     .","warning"),r.textContent="0",s.textContent="0",r.className="badge text-bg-secondary border-0",s.className="badge text-bg-secondary border-0",Lr(e,"#index-certificates-soon-body",[]," ."),Lr(e,"#index-certificates-expired-body",[]," .");return}const i=Kc(n||[]);r.textContent=String(i.soon.length),s.textContent=String(i.expired.length),r.className=`badge ${Qn("soon",i.soon.length)} border-0`,s.className=`badge ${Qn("expired",i.expired.length)} border-0`,Lr(e,"#index-certificates-soon-body",i.soon,"    ."),Lr(e,"#index-certificates-expired-body",i.expired,"    .")}function zc(e){const t=new Map;(e||[]).forEach(s=>{var c,d,h;const n=String(((c=s==null?void 0:s.absence_reasons)==null?void 0:c.name)||"").trim()||"  ",a=`${((d=s==null?void 0:s.employees)==null?void 0:d.first_name)||""} ${((h=s==null?void 0:s.employees)==null?void 0:h.last_name)||""}`.trim()||"-",i=(s==null?void 0:s.start_date)||"",o=(s==null?void 0:s.end_date)||"",l=t.get(n)||{reason:n,details:[]};l.details.push({employeeName:a,startDate:i,endDate:o}),t.set(n,l)});const r=Array.from(t.values()).map(s=>({...s,details:s.details.sort((n,a)=>String(n.employeeName).localeCompare(String(a.employeeName),"bg")),count:s.details.length}));return r.sort((s,n)=>n.count!==s.count?n.count-s.count:String(s.reason).localeCompare(String(n.reason),"bg")),r}function Yt(e,t){const r=e.querySelector("#index-absence-reasons-body");if(r){if(!t.length){r.innerHTML='<p class="text-secondary mb-0">  .</p>';return}r.innerHTML=t.map((s,n)=>{const a=oi(s.reason),i=String(n),o=i===de.selectedKey,l=s.details.map(c=>{const d=`${St(c.startDate)} - ${St(c.endDate)}`;return`
            <tr>
              <td>${G(c.employeeName)}</td>
              <td>${G(d)}</td>
            </tr>
          `}).join("");return`
        <div class="d-flex justify-content-between align-items-center border rounded p-2">
          <span>${G(s.reason)}</span>
          <button
            type="button"
            class="badge ${a} border-0"
            data-index-absence-action="toggle-reason"
            data-index-absence-key="${i}"
            aria-expanded="${o?"true":"false"}"
          >
            ${G(String(s.count))}
          </button>
        </div>
        ${o?`
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead>
                <tr>
                  <th></th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${l}
              </tbody>
            </table>
          </div>
        `:""}
      `}).join("")}}function Vc(e,t){if(t===""||t===de.selectedKey){de.selectedKey="",Yt(e,de.groups);return}if(!(de.groups[Number(t)]||null)){de.selectedKey="",Yt(e,de.groups);return}de.selectedKey=String(t),Yt(e,de.groups)}async function Gc(e){const t=Pt(),{data:r,error:s}=await S.from("employee_absences").select("start_date, end_date, employees(first_name, last_name), absence_reasons(name)").lte("start_date",t).gte("end_date",t).order("start_date",{ascending:!0});if(s){b("     .","warning"),de.groups=[],de.selectedKey="",Yt(e,[]);return}de.groups=zc(r||[]),de.selectedKey="",Yt(e,de.groups)}async function li(e){await Promise.all([tn(e),Wc(e),Gc(e)])}function Re(e){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0");return`${t}-${r}`}function Os(e){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${s}`}function ur(e){const[t,r]=String(e||"").split("-"),s=Number(t),n=Number(r);if(!Number.isInteger(s)||!Number.isInteger(n)||n<1||n>12){const a=new Date;return new Date(a.getFullYear(),a.getMonth(),1)}return new Date(s,n-1,1)}function Xn(e,t){const r=ur(e);return r.setMonth(r.getMonth()+t),Re(r)}function Jc(e){const t=ur(e);return new Intl.DateTimeFormat("bg-BG",{month:"long",year:"numeric"}).format(t)}function Qc(e){const t=ur(e),r=new Date(t.getFullYear(),t.getMonth()+1,0);return{startDate:Os(t),endDate:Os(r)}}function Yc(e){if(Array.isArray(e))return e.map((r,s)=>fs(r,s)).filter(r=>r.url);const t=String(e||"").trim();if(!t)return[];if(t.startsWith("["))try{const r=JSON.parse(t);if(Array.isArray(r))return r.map((s,n)=>fs(s,n)).filter(s=>s.url)}catch{return[{url:t,label:" 1"}]}return t.split(`
`).map((r,s)=>fs(r,s)).filter(r=>r.url)}function fs(e,t){if(e&&typeof e=="object"&&!Array.isArray(e)){const s=String(e.url||"").trim(),n=String(e.label||"").trim()||` ${t+1}`;return{url:s,label:n}}return{url:String(e||"").trim(),label:` ${t+1}`}}function Xc(e){const t=String(e||"").trim();if(!t)return"";const r=t.toLowerCase(),s={:"",:""," ":"",:""," ":"",:""," ":"",:""," ":"",:""};if(s[r])return s[r];if(t.length<=4&&/^[\p{L}\p{N}]+$/u.test(t))return t.toUpperCase();const n=t.split(/\s+/).map(a=>a.trim()).filter(Boolean);return n.length>=2?n.slice(0,3).map(a=>a.charAt(0).toUpperCase()).join(""):t.slice(0,2).toUpperCase()}function ci(e){const t=Xc(e);return Dc[t]||oi(e)}function di(e,t){const r=new Date(`${e}T00:00:00`),s=new Date(`${t}T00:00:00`);if(Number.isNaN(r.getTime())||Number.isNaN(s.getTime())||r>s)return[];const n=[],a=new Date(r);for(;a<=s;)n.push(Os(a)),a.setDate(a.getDate()+1);return n}function Pr(e){var t;return String(((t=e==null?void 0:e.absence_reasons)==null?void 0:t.name)||"").trim()||""}function ui(e){const t=String(e||"").trim();if(!t)return"";try{const s=new URL(t).pathname.split("/").pop()||"",n=s.includes(".")?s.split(".").pop():"";return String(n||"").toLowerCase()}catch{return""}}function Zc(e){const t=ui(e);return["doc","docx","xls","xlsx","ppt","pptx"].includes(t)?`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(e)}`:e}function ed(e,t,r){const s=e.querySelector("#index-timetable-preview-modal"),n=e.querySelector("#index-timetable-preview-frame"),a=e.querySelector("#index-timetable-preview-title"),i=e.querySelector("#index-timetable-preview-fallback"),o=e.querySelector("#index-timetable-preview-open");if(!s||!n||!a||!i||!o)return;const l=String(t||"").trim();if(!l){b("   .","warning");return}const c=Zc(l);a.textContent=r?`: ${r}`:"  ",o.setAttribute("href",l),i.classList.add("d-none"),n.src="about:blank",n.src=c,n.onload=()=>{if(c!==l){i.classList.add("d-none");return}const d=ui(l),h=["doc","docx","xls","xlsx","ppt","pptx"].includes(d);i.classList.toggle("d-none",!h)},n.onerror=()=>{i.classList.remove("d-none")},s.classList.remove("d-none")}function Zn(e){const t=e.querySelector("#index-timetable-preview-modal"),r=e.querySelector("#index-timetable-preview-frame"),s=e.querySelector("#index-timetable-preview-fallback"),n=e.querySelector("#index-timetable-preview-open");!t||!r||!s||!n||(r.src="about:blank",n.setAttribute("href","#"),s.classList.add("d-none"),t.classList.add("d-none"))}function td(e){const t=ur(e),r=Re(t),s=Pt(),n=s.startsWith(r);if(F.selectedDate&&F.selectedDate.startsWith(r))return;const a=[...new Set([...F.plannedRows.map(i=>i==null?void 0:i.date).filter(Boolean),...F.actualRows.map(i=>i==null?void 0:i.date).filter(Boolean),...F.absenceRows.flatMap(i=>di(i==null?void 0:i.start_date,i==null?void 0:i.end_date))])].sort((i,o)=>String(i).localeCompare(String(o),"bg"));if(n){F.selectedDate=s;return}if(a.length){F.selectedDate=a[0];return}F.selectedDate=`${r}-01`}function rd(){const e=new Map;return F.plannedRows.forEach(t=>{const r=t==null?void 0:t.date;if(!r)return;const s=e.get(r)||{planned:0,actual:0};s.planned+=1,e.set(r,s)}),F.actualRows.forEach(t=>{const r=t==null?void 0:t.date;if(!r)return;const s=e.get(r)||{planned:0,actual:0};s.actual+=1,e.set(r,s)}),F.absenceRows.forEach(t=>{const r=Pr(t),s=ci(r);di(t==null?void 0:t.start_date,t==null?void 0:t.end_date).forEach(n=>{const a=e.get(n)||{planned:0,actual:0,absences:[]};Array.isArray(a.absences)||(a.absences=[]),a.absences.some(o=>(o==null?void 0:o.reason)===r)||a.absences.push({reason:r,className:s}),e.set(n,a)})}),e}function sd(e){const t=e.querySelector("#index-crew-calendar-days");if(!t)return;const r=F.visibleMonth||Re(new Date),s=ur(r),n=new Date(s.getFullYear(),s.getMonth(),1),a=n.getDay(),i=a===0?6:a-1,o=new Date(n);o.setDate(n.getDate()-i);const l=rd(),c=Pt();z(e,"#index-crew-month-label",Jc(r));const d=[];for(let h=0;h<42;h+=1){const u=new Date(o);u.setDate(o.getDate()+h);const p=`${Re(u)}-${String(u.getDate()).padStart(2,"0")}`,y=u.getMonth()!==s.getMonth(),_=p===F.selectedDate,g=p===c,v=l.get(p)||{planned:0,actual:0,absences:[]},m=Array.isArray(v.absences)?v.absences.map(w=>`<span class="badge ${G(w.className||"text-bg-danger")}" title="${G(w.reason||"")}">${G(w.reason||"")}</span>`).join(""):"";d.push(`
      <button
        type="button"
        class="index-crew-calendar-day ${y?"is-other-month":""} ${_?"is-selected":""} ${g?"is-today":""}"
        data-index-crew-action="select-day"
        data-date="${p}"
      >
        <span class="index-crew-calendar-day-number">${u.getDate()}</span>
        <span class="index-crew-calendar-day-flags">
          ${v.planned?`<span class="badge text-bg-primary">${v.planned}</span>`:""}
          ${v.actual?`<span class="badge text-bg-success">${v.actual}</span>`:""}
          ${m}
        </span>
      </button>
    `)}t.innerHTML=d.join("")}function nd(e){const t=F.selectedDate,r=e.querySelector("#index-crew-planned-body"),s=e.querySelector("#index-crew-actual-body"),n=e.querySelector("#index-crew-absence-body");if(!r||!s||!n)return;z(e,"#index-crew-selected-date-label",`  ${St(t)}`);const a=F.plannedRows.filter(l=>(l==null?void 0:l.date)===t).sort((l,c)=>{var d,h;return String(((d=l==null?void 0:l.duties)==null?void 0:d.start_time)||"").localeCompare(String(((h=c==null?void 0:c.duties)==null?void 0:h.start_time)||""),"bg")});a.length?r.innerHTML=a.map(l=>{var u,f,p,y;const c=((u=l==null?void 0:l.duties)==null?void 0:u.name)||"-",d=Vn(l==null?void 0:l.assignment_role),h=Fc((f=l==null?void 0:l.duties)==null?void 0:f.start_time,(p=l==null?void 0:l.duties)==null?void 0:p.end_time,(y=l==null?void 0:l.duties)==null?void 0:y.second_day);return`
          <article class="border rounded p-2">
            <div class="fw-semibold">${G(c)}</div>
            <div class="small text-secondary">${G(d)}  ${G(h)}</div>
          </article>
        `}).join(""):r.innerHTML='<p class="text-secondary mb-0">  .</p>';const i=F.actualRows.filter(l=>(l==null?void 0:l.date)===t).sort((l,c)=>String((c==null?void 0:c.reported_at)||"").localeCompare(String((l==null?void 0:l.reported_at)||""),"bg"));i.length?s.innerHTML=i.map(l=>{var p,y,_;const c=((p=l==null?void 0:l.duties)==null?void 0:p.name)||"-",d=Vn(l==null?void 0:l.assignment_role),h=l!=null&&l.reported_at?es(new Date(l.reported_at)):"-",f=(Array.isArray((y=l==null?void 0:l.duties)==null?void 0:y.duty_trains)?[...l.duties.duty_trains].sort((g,v)=>Number((g==null?void 0:g.sequence_order)||0)-Number((v==null?void 0:v.sequence_order)||0)):(_=l==null?void 0:l.duties)!=null&&_.duty_trains?[l.duties.duty_trains]:[]).map(g=>{var k,E;const v=(k=g==null?void 0:g.trains)!=null&&k.number?` ${g.trains.number}`:"",m=Yc((E=g==null?void 0:g.trains)==null?void 0:E.timetable_url);if(!m.length)return`<div class="small">${G(v)}: <span class="text-secondary"> </span></div>`;const w=m.map(q=>{const L=encodeURIComponent(q.url),T=encodeURIComponent(q.label||"");return`
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary py-0 px-2"
                    data-index-crew-action="preview-timetable"
                    data-preview-url="${G(L)}"
                    data-preview-label="${G(T)}"
                  >
                    ${G(q.label)}  
                  </button>
                `}).join(" ");return`<div class="small">${G(v)}: ${w}</div>`}).join("");return`
          <article class="border rounded p-2">
            <div class="fw-semibold">${G(c)}</div>
            <div class="small text-secondary mb-1">${G(d)}  : ${G(h)}</div>
            ${f?`<div class="small"><span class="fw-semibold">:</span> ${f}</div>`:""}
          </article>
        `}).join(""):s.innerHTML='<p class="text-secondary mb-0">  .</p>';const o=F.absenceRows.filter(l=>{const c=String((l==null?void 0:l.start_date)||""),d=String((l==null?void 0:l.end_date)||"");return!!(c&&d&&t>=c&&t<=d)}).sort((l,c)=>{const d=String((l==null?void 0:l.start_date)||"").localeCompare(String((c==null?void 0:c.start_date)||""),"bg");return d!==0?d:Pr(l).localeCompare(Pr(c),"bg")});if(!o.length){n.innerHTML='<p class="text-secondary mb-0">    .</p>';return}n.innerHTML=o.map(l=>{const c=Pr(l),d=ci(c),h=`${St(l==null?void 0:l.start_date)} - ${St(l==null?void 0:l.end_date)}`;return`
        <article class="border rounded p-2">
          <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
            <span class="badge ${G(d)}">${G(c)}</span>
          </div>
          <div class="small text-secondary">: ${G(h)}</div>
        </article>
      `}).join("")}function Ps(e){td(F.visibleMonth),sd(e),nd(e)}async function Vt(e,t,r){const s=r||F.visibleMonth||Re(new Date);if(F.visibleMonth=s,!t){F.plannedRows=[],F.actualRows=[],F.absenceRows=[],F.selectedDate="",Ps(e),z(e,"#index-crew-last-updated","    .");return}const{startDate:n,endDate:a}=Qc(s),[i,o,l]=await Promise.all([S.from("planned_duties").select("date, assignment_role, duties(name, start_time, end_time, second_day)").eq("employee_id",t).gte("date",n).lte("date",a).order("date",{ascending:!0}).order("duty_id",{ascending:!0}),S.from("actual_duties").select("date, assignment_role, reported_at, duties(name, start_time, end_time, second_day, duty_trains(sequence_order, trains(number, timetable_url)))").eq("employee_id",t).gte("date",n).lte("date",a).order("date",{ascending:!0}).order("reported_at",{ascending:!1}),S.from("employee_absences").select("start_date, end_date, absence_reasons(name)").eq("employee_id",t).lte("start_date",a).gte("end_date",n).order("start_date",{ascending:!0})]);(i.error||o.error||l.error)&&b("          .","warning"),F.plannedRows=i.data||[],F.actualRows=o.data||[],F.absenceRows=l.data||[],Ps(e),z(e,"#index-crew-last-updated",` : ${es(new Date)}`)}async function tn(e){const t=Pt(),[r,s,n,a]=await Promise.all([S.from("planned_duties").select("id",{count:"exact",head:!0}).eq("date",t),S.from("actual_duties").select("id",{count:"exact",head:!0}).eq("date",t),S.from("employee_absences").select("id",{count:"exact",head:!0}).lte("start_date",t).gte("end_date",t),S.from("employees").select("id",{count:"exact",head:!0}).eq("is_active",!0)]);[r,s,n,a].some(o=>o.error)&&b("          .","warning"),z(e,"#index-kpi-planned",String(r.count??0)),z(e,"#index-kpi-actual",String(s.count??0)),z(e,"#index-kpi-absences",String(n.count??0)),z(e,"#index-kpi-employees",String(a.count??0)),z(e,"#index-last-updated",` : ${es(new Date)}`)}async function hi(e){const[t,r,s,n]=await Promise.all([S.from("user_profiles").select("id",{count:"exact",head:!0}),S.from("user_roles").select("user_id"),S.from("roles").select("name",{count:"exact",head:!0}),S.from("user_profiles").select("id",{count:"exact",head:!0}).not("employee_id","is",null)]);[t,r,s,n].some(o=>o.error)&&b("           .","warning");const i=new Set((r.data||[]).map(o=>o.user_id).filter(Boolean));z(e,"#index-kpi-planned",String(t.count??0)),z(e,"#index-kpi-actual",String(i.size)),z(e,"#index-kpi-absences",String(n.count??0)),z(e,"#index-kpi-employees",String(s.count??0)),z(e,"#index-last-updated",` : ${es(new Date)}`)}function ad(e){const t=e.querySelector("#index-refresh"),r=e.querySelector("#index-refresh-crew"),s=e.querySelector("#index-crew-prev-month"),n=e.querySelector("#index-crew-next-month"),a=e.querySelector("#index-crew-today-month"),i=e.querySelector("#index-crew-calendar-days"),o=e.querySelector("#index-crew-actual-body"),l=e.querySelector("#index-timetable-preview-modal"),c=e.querySelector("#index-timetable-preview-close"),d=e.querySelector("#index-certificates-panel"),h=e.querySelector("#index-absences-panel");t==null||t.addEventListener("click",async()=>{const u=e.dataset.indexMode||"default";if(u==="admin"){t.disabled=!0,await hi(e),t.disabled=!1;return}if(u==="head_of_transport"){t.disabled=!0,await li(e),t.disabled=!1;return}u!=="crew"&&(t.disabled=!0,await tn(e),t.disabled=!1)}),r==null||r.addEventListener("click",async()=>{const u=e.dataset.indexMode||"default",f=e.dataset.indexEmployeeId||"";u==="crew"&&(r.disabled=!0,await Vt(e,f,F.visibleMonth),r.disabled=!1)}),s==null||s.addEventListener("click",async()=>{const u=e.dataset.indexMode||"default",f=e.dataset.indexEmployeeId||"";if(u!=="crew")return;const p=F.visibleMonth||Re(new Date),y=Xn(p,-1);await Vt(e,f,y)}),n==null||n.addEventListener("click",async()=>{const u=e.dataset.indexMode||"default",f=e.dataset.indexEmployeeId||"";if(u!=="crew")return;const p=F.visibleMonth||Re(new Date),y=Xn(p,1);await Vt(e,f,y)}),a==null||a.addEventListener("click",async()=>{const u=e.dataset.indexMode||"default",f=e.dataset.indexEmployeeId||"";if(u!=="crew")return;const p=new Date;F.visibleMonth=Re(p),F.selectedDate=Pt(),await Vt(e,f,F.visibleMonth)}),i==null||i.addEventListener("click",u=>{const f=u.target.closest('button[data-index-crew-action="select-day"]');if(!f||(e.dataset.indexMode||"default")!=="crew")return;const y=f.getAttribute("data-date")||"";y&&(F.selectedDate=y,Ps(e))}),o==null||o.addEventListener("click",u=>{const f=u.target.closest('button[data-index-crew-action="preview-timetable"]');if(!f||(e.dataset.indexMode||"default")!=="crew")return;const y=decodeURIComponent(f.getAttribute("data-preview-url")||""),_=decodeURIComponent(f.getAttribute("data-preview-label")||"");ed(e,y,_)}),c==null||c.addEventListener("click",()=>{Zn(e)}),l==null||l.addEventListener("click",u=>{u.target===l&&Zn(e)}),d==null||d.addEventListener("click",u=>{const f=u.target.closest("button[data-index-cert-action]");if(!f||(e.dataset.indexMode||"default")!=="head_of_transport")return;const y=f.getAttribute("data-index-cert-action")||"";if(y==="toggle-soon"){Yn(e,"soon");return}y==="toggle-expired"&&Yn(e,"expired")}),h==null||h.addEventListener("click",u=>{const f=u.target.closest("button[data-index-absence-action]");if(!f||(e.dataset.indexMode||"default")!=="head_of_transport"||(f.getAttribute("data-index-absence-action")||"")!=="toggle-reason")return;const _=f.getAttribute("data-index-absence-key")||"";Vc(e,_)})}function id(e,t){const r=e.querySelector("#index-management-section"),s=e.querySelector("#index-crew-section"),n=e.querySelector("#index-kpi-card-planned"),a=e.querySelector("#index-kpi-card-actual"),i=e.querySelector("#index-kpi-card-absences"),o=e.querySelector("#index-kpi-card-employees"),l=e.querySelector("#index-certificates-panel"),c=e.querySelector("#index-absences-panel"),d=e.querySelector("#index-certificates-soon-details"),h=e.querySelector("#index-certificates-expired-details"),u=e.querySelector("#index-quick-actions"),f=(t==null?void 0:t.mode)||"default";if(z(e,"#index-management-title","   "),Jn(e,[" "," "," "," "]),f!=="crew"){e.dataset.indexMode=f,r==null||r.classList.remove("d-none"),s==null||s.classList.add("d-none"),n==null||n.classList.remove("d-none"),a==null||a.classList.remove("d-none"),i==null||i.classList.remove("col-xl-6"),i==null||i.classList.add("col-xl-3"),o==null||o.classList.remove("col-xl-6"),o==null||o.classList.add("col-xl-3"),l==null||l.classList.add("d-none"),c==null||c.classList.add("d-none"),d==null||d.classList.add("d-none"),h==null||h.classList.add("d-none"),u&&(f==="admin"?(u.innerHTML=`
          <a href="/admin" data-link class="btn btn-outline-danger"> </a>
          <a href="/employees" data-link class="btn btn-outline-primary"></a>
          <a href="/schedule-keys" data-link class="btn btn-outline-primary">-</a>
        `,z(e,"#index-welcome-subtitle","   ,    ."),z(e,"#index-management-title"," "),Jn(e,["","  ","  ",""])):f==="manager"?(u.innerHTML=`
          <a href="/plan-schedule" data-link class="btn btn-outline-primary">-</a>
          <a href="/schedule" data-link class="btn btn-outline-primary"></a>
          <a href="/planned-duties" data-link class="btn btn-outline-primary"> </a>
          <a href="/actual-duties" data-link class="btn btn-outline-primary"> </a>
        `,z(e,"#index-welcome-subtitle","        .")):f==="head_of_transport"&&(u.innerHTML=`
          <a href="/plan-schedule" data-link class="btn btn-outline-primary">-</a>
          <a href="/schedule" data-link class="btn btn-outline-primary"></a>
          <a href="/planned-duties" data-link class="btn btn-outline-primary"> </a>
          <a href="/actual-duties" data-link class="btn btn-outline-primary"> </a>
        `,z(e,"#index-welcome-subtitle","      ,   ."),n==null||n.classList.add("d-none"),a==null||a.classList.add("d-none"),i==null||i.classList.remove("col-xl-3"),i==null||i.classList.add("col-xl-6"),o==null||o.classList.remove("col-xl-3"),o==null||o.classList.add("col-xl-6"),l==null||l.classList.remove("d-none"),c==null||c.classList.remove("d-none")));return}e.dataset.indexMode="crew",e.dataset.indexEmployeeId=t.employeeId||"",r==null||r.classList.add("d-none"),s==null||s.classList.remove("d-none"),z(e,"#index-welcome-subtitle","        ."),u&&(u.innerHTML=`
      <a href="/planned-duties" data-link class="btn btn-outline-primary"> </a>
      <a href="/actual-duties" data-link class="btn btn-outline-primary"> </a>
    `)}async function od(e){const t=await se("../index.html",import.meta.url);e.innerHTML=t,ad(e);const r=await Bc(e);if(id(e,r),(r==null?void 0:r.mode)==="crew"){const s=Re(new Date);F.visibleMonth=s,F.selectedDate=Pt(),await Vt(e,r.employeeId||"",s);return}if((r==null?void 0:r.mode)==="admin"){await hi(e);return}if((r==null?void 0:r.mode)==="head_of_transport"){await li(e);return}await tn(e)}async function ld({attempts:e=10,delayMs:t=120}={}){var r,s;for(let n=0;n<e;n+=1){const{data:a}=await S.auth.getSession();if((s=(r=a==null?void 0:a.session)==null?void 0:r.user)!=null&&s.id)return!0;await new Promise(i=>{window.setTimeout(i,t)})}return!1}async function cd(e){const t=await se("../login.html",import.meta.url);e.innerHTML=t,dd(e)}function dd(e){const t=e.querySelector("#login-form");t&&t.addEventListener("submit",async r=>{var d,h;r.preventDefault();const s=t.querySelector('input[name="email"]').value.trim(),n=t.querySelector('input[name="password"]').value,a=t.querySelector('button[type="submit"]'),i=a.innerHTML;a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading...';const{data:o,error:l}=await S.auth.signInWithPassword({email:s,password:n});if(a.disabled=!1,a.innerHTML=i,l){b(l.message,"error");return}if(b("Login successful.","success"),!(!!((h=(d=o==null?void 0:o.session)==null?void 0:d.user)!=null&&h.id)||await ld())){b("  ,     .  .","warning");return}window.history.pushState({},"","/"),window.dispatchEvent(new PopStateEvent("popstate"))})}async function ud(e){const t=await se("../register.html",import.meta.url);e.innerHTML=t,hd(e)}function hd(e){const t=e.querySelector("#register-form");t&&t.addEventListener("submit",async r=>{var u;r.preventDefault();const s=t.querySelector('input[name="email"]').value.trim(),n=t.querySelector('input[name="password"]').value,a=t.querySelector('input[name="confirm-password"]').value;if(n!==a){b("Passwords do not match","warning");return}const i=t.querySelector('button[type="submit"]'),o=i.innerHTML;i.disabled=!0,i.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Loading...';const{data:l,error:c}=await S.auth.signUp({email:s,password:n});if(c){i.disabled=!1,i.innerHTML=o,b(c.message,"error");return}const d=(u=l.user)==null?void 0:u.id;if(d){const f=s.split("@")[0],{error:p}=await S.from("user_profiles").upsert({id:d,username:f,created_from:s},{onConflict:"id"});if(p){i.disabled=!1,i.innerHTML=o,b(p.message,"error");return}}if(!!!l.session){const{error:f}=await S.auth.signInWithPassword({email:s,password:n});if(f){i.disabled=!1,i.innerHTML=o,b("Registration successful, but automatic login is not available until email confirmation is completed.","warning"),window.history.pushState({},"","/login"),window.dispatchEvent(new PopStateEvent("popstate"));return}}i.disabled=!1,i.innerHTML=o,b("Registration successful. You are now signed in.","success"),window.history.pushState({},"","/"),window.dispatchEvent(new PopStateEvent("popstate"))})}function ps(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const ea=new Map;function fd(e,t){const r=ea.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){kt(a);return}}};ea.set(e,s),document.addEventListener("keydown",s)}function kt(e){var t,r;e.classList.add("d-none"),(t=document.querySelector("#schedule-key-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#schedule-key-delete-modal"))!=null&&r.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function ve(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const J={rows:[],filters:{name:"",type:"",crewRole:"",isActive:"",validFrom:"",validTo:""}};async function rn(e){const{data:t,error:r}=await S.from("schedule_keys").select("id, name, is_active, type, crew_role, valid_from, valid_to").order("valid_from",{ascending:!1});if(r){b(r.message,"error"),J.rows=[],$e(e,"    -.");return}J.rows=t||[],$e(e)}function $e(e,t){const r=e.querySelector("#schedule-keys-table-body"),s=e.querySelector("#schedule-keys-empty"),n=J.rows.filter(a=>{const i=!J.filters.name||(a.name||"").toLowerCase().includes(J.filters.name),o=!J.filters.type||a.type===J.filters.type,l=!J.filters.crewRole||a.crew_role===J.filters.crewRole,c=!J.filters.isActive||String(!!a.is_active)===J.filters.isActive,d=!J.filters.validFrom||a.valid_from===J.filters.validFrom,h=!J.filters.validTo||a.valid_to===J.filters.validTo;return i&&o&&l&&c&&d&&h});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"    .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>`
        <tr>
          <td>${ve(a.name??"-")}</td>
          <td>${ve(a.type??"-")}</td>
          <td>${ve(a.crew_role??"-")}</td>
          <td>${a.is_active?"":""}</td>
          <td>${ve(a.valid_from??"-")}</td>
          <td>${ve(a.valid_to??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-name="${ve(a.name??"")}"
                data-type="${ve(a.type??"seasonal")}"
                data-crew-role="${ve(a.crew_role??"")}"
                data-active="${a.is_active?"true":"false"}"
                data-valid-from="${ve(a.valid_from??"")}"
                data-valid-to="${ve(a.valid_to??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="duties"
                data-id="${a.id}"
                data-name="${ve(a.name??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `).join("")}async function pd(e){const t=await se("../schedule-keys.html",import.meta.url);e.innerHTML=t,yd(e),await rn(e)}function yd(e){const t=e.querySelector("#open-create-schedule-key"),r=e.querySelector("#schedule-keys-form"),s=e.querySelector("#schedule-key-cancel-btn"),n=e.querySelector("#schedule-keys-table-body"),a=e.querySelector("#schedule-key-modal"),i=e.querySelector("#schedule-key-delete-modal"),o=e.querySelector("#schedule-key-modal-close"),l=e.querySelector("#schedule-key-delete-confirm"),c=e.querySelector("#schedule-key-delete-cancel"),d=e.querySelector("#filter-name"),h=e.querySelector("#filter-type"),u=e.querySelector("#filter-crew-role"),f=e.querySelector("#filter-active"),p=e.querySelector("#filter-valid-from"),y=e.querySelector("#filter-valid-to"),_=e.querySelector("#filter-reset");t==null||t.addEventListener("click",()=>{sn(e),ps(a)}),r==null||r.addEventListener("submit",async g=>{g.preventDefault(),await md(e)}),s==null||s.addEventListener("click",()=>{kt(a)}),o==null||o.addEventListener("click",()=>{kt(a)}),c==null||c.addEventListener("click",()=>{kt(i)}),d==null||d.addEventListener("input",g=>{J.filters.name=g.target.value.trim().toLowerCase(),$e(e)}),h==null||h.addEventListener("change",g=>{J.filters.type=g.target.value,$e(e)}),u==null||u.addEventListener("change",g=>{J.filters.crewRole=g.target.value,$e(e)}),f==null||f.addEventListener("change",g=>{J.filters.isActive=g.target.value,$e(e)}),p==null||p.addEventListener("change",g=>{J.filters.validFrom=g.target.value,$e(e)}),y==null||y.addEventListener("change",g=>{J.filters.validTo=g.target.value,$e(e)}),_==null||_.addEventListener("click",()=>{J.filters={name:"",type:"",crewRole:"",isActive:"",validFrom:"",validTo:""},d&&(d.value=""),h&&(h.value=""),u&&(u.value=""),f&&(f.value=""),p&&(p.value=""),y&&(y.value=""),$e(e)}),fd("schedule-keys",[i,a]),l==null||l.addEventListener("click",async()=>{const g=e.querySelector("#schedule-key-delete-id").value;await bd(g,e)}),n==null||n.addEventListener("click",async g=>{const v=g.target.closest("button[data-action]");if(!v)return;const m=v.getAttribute("data-action");if(m==="edit"){gd(e,{id:v.getAttribute("data-id"),name:v.getAttribute("data-name"),type:v.getAttribute("data-type"),crewRole:v.getAttribute("data-crew-role")||"",isActive:v.getAttribute("data-active")==="true",validFrom:v.getAttribute("data-valid-from"),validTo:v.getAttribute("data-valid-to")}),ps(a);return}if(m==="delete"){const w=v.getAttribute("data-id");e.querySelector("#schedule-key-delete-id").value=w,ps(i);return}if(m==="duties"){const w=v.getAttribute("data-id"),k=v.getAttribute("data-name")||"",E=new URLSearchParams({scheduleKeyId:w,scheduleKeyName:k});window.history.pushState({},"",`/schedule-key-duties?${E.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}})}async function md(e){var m;const t=e.querySelector("#schedule-key-id"),r=e.querySelector("#schedule-key-name"),s=e.querySelector("#schedule-key-type"),n=e.querySelector("#schedule-key-crew-role"),a=e.querySelector("#schedule-key-active"),i=e.querySelector("#schedule-key-valid-from"),o=e.querySelector("#schedule-key-valid-to"),l=e.querySelector("#schedule-key-save-btn"),c=r.value.trim(),d=s.value,h=n.value,u=a.checked,f=i.value,p=o.value,y=t.value;if(!c||!d||!h||!f||!p){b(",    .","warning");return}if(![" ",""].includes(h)){b("   .","warning");return}if(p<f){b(' " "     " ".',"warning");return}const _=l.innerHTML;l.disabled=!0,l.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const g={name:c,type:d,crew_role:h,is_active:u,valid_from:f,valid_to:p};let v;if(y)({error:v}=await S.from("schedule_keys").update(g).eq("id",y));else{const{data:w}=await S.auth.getUser(),k=((m=w==null?void 0:w.user)==null?void 0:m.email)??"web_app";({error:v}=await S.from("schedule_keys").insert({...g,created_from:k}))}if(l.disabled=!1,l.innerHTML=_,v){b(fi(v),"error");return}b(y?"  .":"  .","success"),kt(e.querySelector("#schedule-key-modal")),sn(e),await rn(e)}function gd(e,t){e.querySelector("#schedule-key-id").value=t.id,e.querySelector("#schedule-key-name").value=t.name??"",e.querySelector("#schedule-key-type").value=t.type??"seasonal",e.querySelector("#schedule-key-crew-role").value=t.crewRole??"",e.querySelector("#schedule-key-active").checked=!!t.isActive,e.querySelector("#schedule-key-valid-from").value=t.validFrom??"",e.querySelector("#schedule-key-valid-to").value=t.validTo??"",e.querySelector("#schedule-keys-form-title").textContent="  -",e.querySelector("#schedule-key-save-btn").textContent="",e.querySelector("#schedule-key-cancel-btn").classList.remove("d-none")}function sn(e){e.querySelector("#schedule-key-id").value="",e.querySelector("#schedule-key-name").value="",e.querySelector("#schedule-key-type").value="seasonal",e.querySelector("#schedule-key-crew-role").value="",e.querySelector("#schedule-key-active").checked=!0,e.querySelector("#schedule-key-valid-from").value="",e.querySelector("#schedule-key-valid-to").value="",e.querySelector("#schedule-keys-form-title").textContent=" -",e.querySelector("#schedule-key-save-btn").textContent="",e.querySelector("#schedule-key-cancel-btn").classList.add("d-none")}async function bd(e,t){const r=t.querySelector("#schedule-key-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await S.from("schedule_keys").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){b(fi(n),"error");return}b("  .","success"),kt(t.querySelector("#schedule-key-delete-modal")),sn(t),await rn(t)}function fi(e){const t=String((e==null?void 0:e.message)||"").trim(),r=t.toLowerCase();return String((e==null?void 0:e.code)||"").trim()==="23503"||r.includes("foreign key constraint")||r.includes("duties_schedule_key_id_fkey")?" -       ,     .":t||"  ."}function $t(e){if(!e)return"00:00";const t=String(e).match(/(\d{1,2}):(\d{2})(?::\d{2})?/);if(!t)return"00:00";const[,r,s]=t;return`${r.padStart(2,"0")}:${s}`}function ta(e){if(!e)return 0;const[t,r]=e.split(":"),s=Number(t),n=Number(r);return!Number.isFinite(s)||!Number.isFinite(n)?0:s*60+n}function At(e,t){const r=ta(e),s=ta(t);return s>=r?s-r:24*60-r+s}function pi({duty:e,scheduleKeyNames:t,trainNumbers:r,escapeHtml:s,intervalToTimeInput:n,formatInterval:a}){var d;const i=((e==null?void 0:e.start_time)||"-").slice(0,5)||"-",o=((e==null?void 0:e.end_time)||"-").slice(0,5)||"-",l=(n((e==null?void 0:e.break_start_time)||"00:00:00")||"-").slice(0,5)||"-",c=(n((e==null?void 0:e.break_end_time)||"00:00:00")||"-").slice(0,5)||"-";return`
    <div class="row g-3">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${s((e==null?void 0:e.name)||"-")}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${s(((d=e==null?void 0:e.duty_types)==null?void 0:d.name)||"-")}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">-</div>
          <div class="fw-semibold">${s(t!=null&&t.length?t.join(", "):"-")}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${s(r!=null&&r.length?r.join(", "):"-")}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${s(i)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${s(o)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"> </div>
          <div class="fw-semibold">${e!=null&&e.second_day?"":""}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">  </div>
          <div class="fw-semibold">${s(l)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">  </div>
          <div class="fw-semibold">${s(c)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${s(a(e==null?void 0:e.break_duration_interval))}</div>
        </div>
      </div>
      <div class="col-md-12">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${s(a(e==null?void 0:e.duration_interval))}</div>
        </div>
      </div>
    </div>
  `}function Ds({idPrefix:e}){return`
    <div class="col-md-6">
      <label for="${e}-name" class="form-label"></label>
      <input id="${e}-name" class="form-control" type="text" required />
    </div>

    <div class="col-md-6">
      <label for="${e}-type" class="form-label">  </label>
      <select id="${e}-type" class="form-select" required>
        <option value=""> </option>
      </select>
    </div>

    <div class="col-md-6">
      <label for="${e}-schedule-keys" class="form-label">-</label>
      <select id="${e}-schedule-keys" class="form-select" multiple required size="5"></select>
      <div class="form-text">      -.</div>
    </div>

    <div class="col-md-6">
      <label for="${e}-trains" class="form-label"></label>
      <select id="${e}-trains" class="form-select" multiple size="5"></select>
      <div class="form-text">       .</div>
    </div>

    <div class="col-md-6">
      <label for="${e}-start" class="form-label"></label>
      <input id="${e}-start" class="form-control" type="time" required />
    </div>

    <div class="col-md-6">
      <label for="${e}-end" class="form-label"></label>
      <input id="${e}-end" class="form-control" type="time" required />
    </div>

    <div class="col-md-6 d-flex align-items-end">
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="${e}-second-day" />
        <label class="form-check-label" for="${e}-second-day"> </label>
      </div>
    </div>

    <div class="col-md-6">
      <label for="${e}-break-start" class="form-label">  </label>
      <input id="${e}-break-start" class="form-control" type="time" value="00:00" required />
    </div>

    <div class="col-md-6">
      <label for="${e}-break-end" class="form-label">  </label>
      <input id="${e}-break-end" class="form-control" type="time" value="00:00" required />
    </div>

    <div class="col-12">
      <label for="${e}-notes" class="form-label"></label>
      <textarea id="${e}-notes" class="form-control" rows="3" placeholder="  ( )"></textarea>
    </div>
  `}function xt(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const ra=new Map;function vd(e,t){const r=ra.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Te(a);return}}};ra.set(e,s),document.addEventListener("keydown",s)}function Te(e){var t,r,s;e.classList.add("d-none"),(t=document.querySelector("#duty-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#duty-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#duty-profile-modal"))!=null&&s.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function sa(e){return e?typeof e=="string"?e.replace(".000000",""):String(e):"-"}function ie(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const $r=8,H={allDuties:[],searchQuery:"",scheduleKeyFilter:"",dutyTypeFilter:"",currentPage:1,draggedDutyId:null};async function ts(e){const{data:t,error:r}=await S.from("duties").select("id, name, notes, duty_type_id, start_time, end_time, second_day, break_start_time, break_end_time, break_duration_interval, duration_interval, display_order, duty_types(name), schedule_key_duties(schedule_key_id, schedule_keys(name)), duty_trains(train_id, sequence_order, trains(number))").order("display_order",{ascending:!0}).order("name",{ascending:!0});if(r){b(r.message,"error"),H.allDuties=[],Ae(e,"    .");return}H.allDuties=t||[],Ae(e)}async function _d(){const e=H.allDuties.map((s,n)=>S.from("duties").update({display_order:n+1}).eq("id",s.id)),r=(await Promise.all(e)).find(s=>s.error);return r!=null&&r.error?(b(r.error.message,"error"),!1):(H.allDuties=H.allDuties.map((s,n)=>({...s,display_order:n+1})),!0)}function Ae(e,t){const r=e.querySelector("#duties-table-body"),s=e.querySelector("#duties-empty"),n=e.querySelector("#duties-pagination"),a=e.querySelector("#duties-page-info"),i=e.querySelector("#duties-prev-page"),o=e.querySelector("#duties-next-page");Ed(e),Td(e);const l=H.allDuties.filter(f=>{var k;const p=(f.name||"").toLowerCase(),y=(((k=f.duty_types)==null?void 0:k.name)||"").toLowerCase(),_=Ms(f).map(E=>E.toLowerCase()),g=Sd(f).join(" ").toLowerCase(),v=!H.searchQuery||p.includes(H.searchQuery)||g.includes(H.searchQuery),m=!H.scheduleKeyFilter||_.includes(H.scheduleKeyFilter),w=!H.dutyTypeFilter||y===H.dutyTypeFilter;return v&&m&&w});if(!l.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .",n.classList.add("d-none");return}s.classList.add("d-none");const c=Math.max(1,Math.ceil(l.length/$r));H.currentPage>c&&(H.currentPage=c),H.currentPage<1&&(H.currentPage=1);const d=(H.currentPage-1)*$r,h=d+$r,u=l.slice(d,h);if(r.innerHTML=u.map(f=>{var g;const p=Ms(f),y=wd(f);kd(f);const _=`<span class="badge text-bg-info" title="${ie(p.join(", "))}">${y.length} -</span>`;return`
        <tr data-duty-id="${f.id}" draggable="true">
          <td class="text-secondary"></td>
          <td>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              ${_}
              <span class="duties-name-ellipsis" title="${ie(f.name??"-")}">${ie(f.name??"-")}</span>
            </div>
          </td>
          <td>${ie(((g=f.duty_types)==null?void 0:g.name)??"-")}</td>
          <td>${ie(f.start_time??"-")}</td>
          <td>${ie(f.end_time??"-")}</td>
          <td>${ie(sa(f.break_duration_interval))}</td>
          <td>${ie(sa(f.duration_interval))}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="profile"
                data-id="${f.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${f.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="duplicate"
                data-id="${f.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${f.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join(""),l.length<=$r){n.classList.add("d-none");return}n.classList.remove("d-none"),a.textContent=` ${H.currentPage}  ${c}`,i.disabled=H.currentPage<=1,o.disabled=H.currentPage>=c}function yi(e){return Array.isArray(e.schedule_key_duties)?e.schedule_key_duties:e.schedule_key_duties?[e.schedule_key_duties]:[]}function mi(e){return Array.isArray(e.duty_trains)?e.duty_trains:e.duty_trains?[e.duty_trains]:[]}function Ms(e){const t=yi(e).map(r=>{var s;return(s=r==null?void 0:r.schedule_keys)==null?void 0:s.name}).filter(Boolean);return[...new Set(t)]}function wd(e){const t=yi(e).map(r=>r==null?void 0:r.schedule_key_id).filter(Boolean);return[...new Set(t)]}function Sd(e){const t=mi(e).map(r=>{var s;return(s=r==null?void 0:r.trains)==null?void 0:s.number}).filter(Boolean);return[...new Set(t)]}function kd(e){const t=mi(e).map(r=>({trainId:r==null?void 0:r.train_id,sequenceOrder:Number.isFinite(Number(r==null?void 0:r.sequence_order))?Number(r.sequence_order):Number.MAX_SAFE_INTEGER})).filter(r=>!!r.trainId).sort((r,s)=>r.sequenceOrder-s.sequenceOrder);return[...new Set(t.map(r=>r.trainId))]}function Ed(e){const t=e.querySelector("#duties-type-filter");if(!t)return;const r=H.dutyTypeFilter||"",s=[...new Set(H.allDuties.map(n=>{var a;return String(((a=n==null?void 0:n.duty_types)==null?void 0:a.name)||"").trim()}).filter(Boolean))].sort((n,a)=>n.localeCompare(a,"bg"));t.innerHTML=`
    <option value=""></option>
    ${s.map(n=>`<option value="${ie(n.toLowerCase())}">${ie(n)}</option>`).join("")}
  `,t.value=r}function Td(e){const t=e.querySelector("#duties-schedule-key-filter");if(!t)return;const r=H.scheduleKeyFilter||"",s=[...new Set(H.allDuties.flatMap(n=>Ms(n)).map(n=>String(n||"").trim()).filter(Boolean))].sort((n,a)=>n.localeCompare(a,"bg"));t.innerHTML=`
    <option value=""></option>
    ${s.map(n=>`<option value="${ie(n.toLowerCase())}">${ie(n)}</option>`).join("")}
  `,t.value=r}async function qd(e){const t=await se("../duties.html",import.meta.url);e.innerHTML=t,Ld(e),xd(e),await Ad(e),await Rd(e),await $d(e),await ts(e)}function Ld(e){const t=e.querySelector("#duty-form-fields");t&&(t.innerHTML=Ds({idPrefix:"duty"}))}async function $d(e){const t=e.querySelector("#duty-trains"),{data:r,error:s}=await S.from("trains").select("id, number, origin_station, destination_station").order("number",{ascending:!0});if(s){b(Dd(s),"error");return}const n=(r||[]).map(a=>{const i=`${a.origin_station||"-"} - ${a.destination_station||"-"}`;return`<option value="${a.id}">${ie(a.number||"-")} (${ie(i)})</option>`}).join("");t.innerHTML=n}async function Ad(e){const t=e.querySelector("#duty-type"),{data:r,error:s}=await S.from("duty_types").select("id, name").order("name",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${ie(a.name)}</option>`).join("");t.innerHTML='<option value=""> </option>'+n}function xd(e){const t=e.querySelector("#open-create-duty"),r=e.querySelector("#duty-form"),s=e.querySelector("#duty-cancel-btn"),n=e.querySelector("#duties-table-body"),a=e.querySelector("#duty-modal"),i=e.querySelector("#duty-delete-modal"),o=e.querySelector("#duty-profile-modal"),l=e.querySelector("#duty-modal-close"),c=e.querySelector("#duty-delete-confirm"),d=e.querySelector("#duty-delete-cancel"),h=e.querySelector("#duty-profile-close"),u=e.querySelector("#duty-profile-close-secondary"),f=e.querySelector("#duty-profile-duplicate"),p=e.querySelector("#duty-profile-edit"),y=e.querySelector("#duties-search"),_=e.querySelector("#duties-schedule-key-filter"),g=e.querySelector("#duties-type-filter"),v=e.querySelector("#duties-filter-reset"),m=e.querySelector("#duties-prev-page"),w=e.querySelector("#duties-next-page");t==null||t.addEventListener("click",()=>{nn(e),xt(a)}),r==null||r.addEventListener("submit",async k=>{k.preventDefault(),await Id(e)}),s==null||s.addEventListener("click",()=>{Te(a)}),l==null||l.addEventListener("click",()=>{Te(a)}),d==null||d.addEventListener("click",()=>{Te(i)}),h==null||h.addEventListener("click",()=>{Te(o)}),u==null||u.addEventListener("click",()=>{Te(o)}),p==null||p.addEventListener("click",()=>{var E;const k=((E=o==null?void 0:o.dataset)==null?void 0:E.dutyId)||"";k&&(Te(o),na(e,k))}),f==null||f.addEventListener("click",()=>{var E;const k=((E=o==null?void 0:o.dataset)==null?void 0:E.dutyId)||"";k&&(Te(o),aa(e,k))}),y==null||y.addEventListener("input",k=>{H.searchQuery=k.target.value.trim().toLowerCase(),H.currentPage=1,Ae(e)}),g==null||g.addEventListener("change",k=>{H.dutyTypeFilter=k.target.value||"",H.currentPage=1,Ae(e)}),_==null||_.addEventListener("change",k=>{H.scheduleKeyFilter=k.target.value||"",H.currentPage=1,Ae(e)}),v==null||v.addEventListener("click",()=>{H.searchQuery="",H.scheduleKeyFilter="",H.dutyTypeFilter="",H.currentPage=1,y&&(y.value=""),_&&(_.value=""),g&&(g.value=""),Ae(e)}),m==null||m.addEventListener("click",()=>{H.currentPage-=1,Ae(e)}),w==null||w.addEventListener("click",()=>{H.currentPage+=1,Ae(e)}),vd("duties",[o,i,a]),c==null||c.addEventListener("click",async()=>{const k=e.querySelector("#duty-delete-id").value;await Cd(k,e)}),n==null||n.addEventListener("click",async k=>{const E=k.target.closest("button[data-action]");if(!E)return;const q=E.getAttribute("data-action");if(q==="profile"){const L=E.getAttribute("data-id");Md(e,L);return}if(q==="edit"){const L=E.getAttribute("data-id");na(e,L);return}if(q==="duplicate"){const L=E.getAttribute("data-id");aa(e,L);return}if(q==="delete"){const L=E.getAttribute("data-id");e.querySelector("#duty-delete-id").value=L,xt(i)}}),n==null||n.addEventListener("dragstart",k=>{const E=k.target.closest("tr[data-duty-id]");E&&(H.draggedDutyId=E.getAttribute("data-duty-id"),E.classList.add("table-active"))}),n==null||n.addEventListener("dragend",k=>{const E=k.target.closest("tr[data-duty-id]");E&&E.classList.remove("table-active"),H.draggedDutyId=null}),n==null||n.addEventListener("dragover",k=>{k.preventDefault()}),n==null||n.addEventListener("drop",async k=>{k.preventDefault();const E=k.target.closest("tr[data-duty-id]"),q=H.draggedDutyId;if(!E||!q)return;const L=E.getAttribute("data-duty-id");if(!L||L===q)return;const T=H.allDuties.findIndex(O=>O.id===q),A=H.allDuties.findIndex(O=>O.id===L);if(T<0||A<0)return;const[x]=H.allDuties.splice(T,1);if(H.allDuties.splice(A,0,x),Ae(e),!await _d()){await ts(e);return}b("    .","success")})}async function Rd(e){const t=e.querySelector("#duty-schedule-keys"),{data:r,error:s}=await S.from("schedule_keys").select("id, name").order("name",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${ie(a.name)}</option>`).join("");t.innerHTML=n}async function Id(e){var M;const t=e.querySelector("#duty-id"),r=e.querySelector("#duty-name"),s=e.querySelector("#duty-type"),n=e.querySelector("#duty-schedule-keys"),a=e.querySelector("#duty-trains"),i=e.querySelector("#duty-start-time"),o=e.querySelector("#duty-end-time"),l=e.querySelector("#duty-second-day"),c=e.querySelector("#duty-break-start-time"),d=e.querySelector("#duty-break-end-time"),h=e.querySelector("#duty-notes"),u=e.querySelector("#duty-save-btn"),f=r.value.trim(),p=s.value||null,y=Array.from(n.selectedOptions||[]).map(j=>j.value).filter(Boolean),_=Array.from(a.selectedOptions||[]).map(j=>j.value).filter(Boolean),g=y[0]||null,v=i.value,m=o.value,w=l.checked,k=c.value,E=d.value,q=h.value.trim()||null,L=t.value;if(!f||!p||!v||!m){b(",    .","warning");return}if(!y.length){b("   -.","warning");return}const T=At(v,m);if(At(k,E)>T){b("     -    .","warning");return}const x=u.innerHTML;u.disabled=!0,u.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const C={name:f,duty_type_id:p,schedule_key_id:g,start_time:v,end_time:m,second_day:w,break_start_time:k,break_end_time:E,notes:q};let O,K=L||null;if(L)({error:O}=await S.from("duties").update(C).eq("id",L));else{const{data:j}=await S.auth.getUser(),U=((M=j==null?void 0:j.user)==null?void 0:M.email)??"web_app",W=H.allDuties.reduce((Fe,Ki)=>Math.max(Fe,Number(Ki.display_order)||0),0),{data:Ue,error:yr}=await S.from("duties").insert({...C,created_from:U,display_order:W+1}).select("id").single();O=yr,K=(Ue==null?void 0:Ue.id)??null}if(!O&&K&&(O=await Od(K,y)),!O&&K&&(O=await Pd(K,_)),u.disabled=!1,u.innerHTML=x,O){b(O.message,"error");return}b(L?"  .":"  .","success"),Te(e.querySelector("#duty-modal")),nn(e),await ts(e)}function gi(e,t){e.querySelector("#duty-id").value=t.id,e.querySelector("#duty-name").value=t.name??"",e.querySelector("#duty-type").value=t.dutyTypeId??"";const r=e.querySelector("#duty-schedule-keys"),s=t.scheduleKeyIds||[];Array.from(r.options).forEach(i=>{i.selected=s.includes(i.value)});const n=e.querySelector("#duty-trains"),a=t.trainIds||[];Array.from(n.options).forEach(i=>{i.selected=a.includes(i.value)}),e.querySelector("#duty-start-time").value=t.startTime??"",e.querySelector("#duty-end-time").value=t.endTime??"",e.querySelector("#duty-second-day").checked=!!t.secondDay,e.querySelector("#duty-break-start-time").value=$t(t.breakStartTime),e.querySelector("#duty-break-end-time").value=$t(t.breakEndTime),e.querySelector("#duty-notes").value=t.notes??"",e.querySelector("#duty-form-title").textContent="  ",e.querySelector("#duty-save-btn").textContent=""}function nn(e){e.querySelector("#duty-id").value="",e.querySelector("#duty-name").value="",e.querySelector("#duty-type").value="";const t=e.querySelector("#duty-schedule-keys");Array.from(t.options).forEach(s=>{s.selected=!1});const r=e.querySelector("#duty-trains");Array.from(r.options).forEach(s=>{s.selected=!1}),e.querySelector("#duty-start-time").value="",e.querySelector("#duty-end-time").value="",e.querySelector("#duty-second-day").checked=!1,e.querySelector("#duty-break-start-time").value="00:00",e.querySelector("#duty-break-end-time").value="00:00",e.querySelector("#duty-notes").value="",e.querySelector("#duty-form-title").textContent=" ",e.querySelector("#duty-save-btn").textContent=""}async function Cd(e,t){const r=t.querySelector("#duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await S.from("duties").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){b(n.message,"error");return}b("  .","success"),Te(t.querySelector("#duty-delete-modal")),nn(t),await ts(t)}async function Od(e,t){const{error:r}=await S.from("schedule_key_duties").delete().eq("duty_id",e);if(r)return r;const s=t.map(a=>({duty_id:e,schedule_key_id:a})),{error:n}=await S.from("schedule_key_duties").insert(s);return n}async function Pd(e,t){const{error:r}=await S.from("duty_trains").delete().eq("duty_id",e);if(r)return r;if(!t.length)return null;const s=t.map((a,i)=>({duty_id:e,train_id:a,sequence_order:i+1})),{error:n}=await S.from("duty_trains").insert(s);return n}function Dd(e){const t=String((e==null?void 0:e.message)||"").trim(),r=t.toLowerCase(),s=r.includes("row-level security")||r.includes("violates row-level security policy")||String((e==null?void 0:e.code)||"")==="42501";return s&&r.includes("duty_trains")?"      .    .":s&&r.includes("duties")?"      .    .":s?"       (RLS).":t||"  ."}function Md(e,t){const r=H.allDuties.find(c=>c.id===t),s=e.querySelector("#duty-profile-content"),n=e.querySelector("#duty-profile-modal"),a=e.querySelector("#duty-profile-duplicate"),i=e.querySelector("#duty-profile-edit");if(!s||!n)return;if(!r){n.dataset.dutyId="",i&&(i.disabled=!0),a&&(a.disabled=!0),s.innerHTML='<p class="text-secondary mb-0">    .</p>',xt(n);return}n.dataset.dutyId=r.id,i&&(i.disabled=!1),a&&(a.disabled=!1);const o=jd(r),l=Nd(r);s.innerHTML=pi({duty:r,scheduleKeyNames:o,trainNumbers:l,escapeHtml:ie,intervalToTimeInput:$t,formatInterval:Hd}),xt(n)}function na(e,t){const r=H.allDuties.find(s=>s.id===t);if(!r){b("     .","warning");return}gi(e,{id:r.id,name:r.name||"",dutyTypeId:r.duty_type_id||"",scheduleKeyIds:bi(r),trainIds:vi(r),startTime:Br(r.start_time),endTime:Br(r.end_time),secondDay:!!r.second_day,breakStartTime:r.break_start_time||"00:00:00",breakEndTime:r.break_end_time||"00:00:00",notes:r.notes||""}),xt(e.querySelector("#duty-modal"))}function aa(e,t){const r=H.allDuties.find(s=>s.id===t);if(!r){b("     .","warning");return}gi(e,{id:"",name:r.name?`${r.name} ()`:"",dutyTypeId:r.duty_type_id||"",scheduleKeyIds:bi(r),trainIds:vi(r),startTime:Br(r.start_time),endTime:Br(r.end_time),secondDay:!!r.second_day,breakStartTime:r.break_start_time||"00:00:00",breakEndTime:r.break_end_time||"00:00:00",notes:r.notes||""}),e.querySelector("#duty-id").value="",e.querySelector("#duty-form-title").textContent="  ()",e.querySelector("#duty-save-btn").textContent="",xt(e.querySelector("#duty-modal"))}function jd(e){const r=(Array.isArray(e==null?void 0:e.schedule_key_duties)?e.schedule_key_duties:e!=null&&e.schedule_key_duties?[e.schedule_key_duties]:[]).map(s=>{var n;return(n=s==null?void 0:s.schedule_keys)==null?void 0:n.name}).filter(Boolean);return[...new Set(r)]}function bi(e){const r=(Array.isArray(e==null?void 0:e.schedule_key_duties)?e.schedule_key_duties:e!=null&&e.schedule_key_duties?[e.schedule_key_duties]:[]).map(s=>s==null?void 0:s.schedule_key_id).filter(Boolean);return[...new Set(r)]}function Nd(e){return(Array.isArray(e==null?void 0:e.duty_trains)?e.duty_trains:e!=null&&e.duty_trains?[e.duty_trains]:[]).map(r=>{var s;return{number:(s=r==null?void 0:r.trains)==null?void 0:s.number,sequenceOrder:Number.isFinite(Number(r==null?void 0:r.sequence_order))?Number(r.sequence_order):Number.MAX_SAFE_INTEGER}}).filter(r=>!!r.number).sort((r,s)=>r.sequenceOrder-s.sequenceOrder).map(r=>r.number).filter((r,s,n)=>n.indexOf(r)===s)}function vi(e){return(Array.isArray(e==null?void 0:e.duty_trains)?e.duty_trains:e!=null&&e.duty_trains?[e.duty_trains]:[]).map(r=>({id:r==null?void 0:r.train_id,sequenceOrder:Number.isFinite(Number(r==null?void 0:r.sequence_order))?Number(r.sequence_order):Number.MAX_SAFE_INTEGER})).filter(r=>!!r.id).sort((r,s)=>r.sequenceOrder-s.sequenceOrder).map(r=>r.id).filter((r,s,n)=>n.indexOf(r)===s)}function Br(e){return e?String(e).slice(0,5):""}function Hd(e){return e?String(e).replace(".000000",""):"-"}function Dr(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const ia=new Map;function Ud(e,t){const r=ia.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){He(a);return}}};ia.set(e,s),document.addEventListener("keydown",s)}function He(e){var t,r,s;e.classList.add("d-none"),(t=document.querySelector("#employee-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#employee-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#employee-profile-modal"))!=null&&s.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function he(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const re={rows:[],searchQuery:"",positionFilter:"",activeFilter:""};async function an(e){const{data:t,error:r}=await S.from("employees").select("id, first_name, last_name, position_id, is_active, photo_url, psychological_assessment_expiry, medical_certificate_expiry, license_expiry, positions(title), user_profiles(id, username)").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(r){b(r.message,"error"),re.rows=[],yt(e,"    .");return}re.rows=t||[],yt(e)}function yt(e,t){const r=e.querySelector("#employees-table-body"),s=e.querySelector("#employees-empty");Fd(e);const n=re.rows.filter(a=>{var h;const i=`${a.first_name||""} ${a.last_name||""}`.toLowerCase(),o=(((h=a.positions)==null?void 0:h.title)||"").toLowerCase(),l=!re.searchQuery||i.includes(re.searchQuery)||o.includes(re.searchQuery),c=!re.positionFilter||o===re.positionFilter,d=!re.activeFilter||String(!!a.is_active)===re.activeFilter;return l&&c&&d});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{var l;const i=Array.isArray(a.user_profiles)?a.user_profiles:a.user_profiles?[a.user_profiles]:[],o=i.length?i.map(c=>{const d=(c==null?void 0:c.username)||(c==null?void 0:c.id)||"";return d||""}).filter(Boolean).join(", "):"-";return`
        <tr data-employee-id="${a.id}">
          <td>${he(a.first_name??"")} ${he(a.last_name??"")}</td>
          <td>${he(o)}</td>
          <td>${he(((l=a.positions)==null?void 0:l.title)??"-")}</td>
          <td>${a.is_active?"":""}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="profile"
                data-id="${a.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-first-name="${he(a.first_name??"")}"
                data-last-name="${he(a.last_name??"")}"
                data-position-id="${a.position_id??""}"
                data-active="${a.is_active?"true":"false"}"
                data-photo-url="${he(a.photo_url??"")}"
                data-psych-expiry="${he(a.psychological_assessment_expiry??"")}"
                data-medical-expiry="${he(a.medical_certificate_expiry??"")}"
                data-license-expiry="${he(a.license_expiry??"")}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}function Fd(e){const t=e.querySelector("#employees-position-filter");if(!t)return;const r=re.positionFilter||"",s=[...new Set(re.rows.map(n=>{var a;return String(((a=n==null?void 0:n.positions)==null?void 0:a.title)||"").trim()}).filter(Boolean))].sort((n,a)=>n.localeCompare(a,"bg"));t.innerHTML=`
    <option value=""></option>
    ${s.map(n=>`<option value="${he(n.toLowerCase())}">${he(n)}</option>`).join("")}
  `,t.value=r}const oa="employee-photos";let jt=null;async function Bd(e){const t=await se("../employees.html",import.meta.url);e.innerHTML=t,Wd(e),await zd(e),await an(e);const r=Kd();r&&await _i(e,r)}function Kd(){return new URLSearchParams(window.location.search).get("profile")||""}function Wd(e){const t=e.querySelector("#open-create-employee"),r=e.querySelector("#employee-form"),s=e.querySelector("#employee-cancel-btn"),n=e.querySelector("#employees-table-body"),a=e.querySelector("#employee-modal"),i=e.querySelector("#employee-delete-modal"),o=e.querySelector("#employee-profile-modal"),l=e.querySelector("#employee-modal-close"),c=e.querySelector("#employee-profile-close"),d=e.querySelector("#employee-profile-close-btn"),h=e.querySelector("#employee-delete-confirm"),u=e.querySelector("#employee-delete-cancel"),f=e.querySelector("#employees-search"),p=e.querySelector("#employees-position-filter"),y=e.querySelector("#employees-active-filter"),_=e.querySelector("#employees-filter-reset"),g=e.querySelector("#employee-photo-file"),v=e.querySelector("#employee-photo-remove-btn");t==null||t.addEventListener("click",()=>{on(e),Dr(a)}),r==null||r.addEventListener("submit",async m=>{m.preventDefault(),await Vd(e)}),s==null||s.addEventListener("click",()=>{He(a)}),l==null||l.addEventListener("click",()=>{He(a)}),u==null||u.addEventListener("click",()=>{He(i)}),c==null||c.addEventListener("click",()=>{He(o)}),d==null||d.addEventListener("click",()=>{He(o)}),f==null||f.addEventListener("input",m=>{re.searchQuery=m.target.value.trim().toLowerCase(),yt(e)}),p==null||p.addEventListener("change",m=>{re.positionFilter=m.target.value||"",yt(e)}),y==null||y.addEventListener("change",m=>{re.activeFilter=m.target.value||"",yt(e)}),_==null||_.addEventListener("click",()=>{re.searchQuery="",re.positionFilter="",re.activeFilter="",f&&(f.value=""),p&&(p.value=""),y&&(y.value=""),yt(e)}),g==null||g.addEventListener("change",()=>{var w,k,E,q;const m=((w=g.files)==null?void 0:w[0])??null;if(!m){const L=((k=e.querySelector("#employee-photo-path"))==null?void 0:k.value)||"";mt(e,L);return}if(!((E=m.type)!=null&&E.startsWith("image/"))){b("    .","warning"),g.value="";const L=((q=e.querySelector("#employee-photo-path"))==null?void 0:q.value)||"";mt(e,L);return}mt(e,m)}),v==null||v.addEventListener("click",()=>{const m=e.querySelector("#employee-photo-path");m&&(m.value=""),g&&(g.value=""),mt(e,null)}),Ud("employees",[i,o,a]),h==null||h.addEventListener("click",async()=>{const m=e.querySelector("#employee-delete-id").value;await Jd(m,e)}),n==null||n.addEventListener("click",async m=>{const w=m.target.closest("button[data-action]");if(!w)return;const k=w.getAttribute("data-action");if(k==="profile"){const E=w.getAttribute("data-id");await _i(e,E);return}if(k==="edit"){Gd(e,{id:w.getAttribute("data-id"),firstName:w.getAttribute("data-first-name"),lastName:w.getAttribute("data-last-name"),positionId:w.getAttribute("data-position-id"),isActive:w.getAttribute("data-active")==="true",psychExpiry:w.getAttribute("data-psych-expiry"),medicalExpiry:w.getAttribute("data-medical-expiry"),licenseExpiry:w.getAttribute("data-license-expiry"),photoUrl:w.getAttribute("data-photo-url")}),Dr(a);return}if(k==="delete"){const E=w.getAttribute("data-id");e.querySelector("#employee-delete-id").value=E,Dr(i)}})}async function _i(e,t){var d;const{data:r,error:s}=await S.from("employees").select("id, first_name, last_name, is_active, photo_url, psychological_assessment_expiry, medical_certificate_expiry, license_expiry, other_certificates, positions(title), user_profiles(id, username)").eq("id",t).maybeSingle();if(s||!r){b((s==null?void 0:s.message)||"   .","error");return}const n=Array.isArray(r.user_profiles)?r.user_profiles:r.user_profiles?[r.user_profiles]:[],a=n.length?n.map(h=>{const u=(h==null?void 0:h.username)||(h==null?void 0:h.id)||"";return u||""}).filter(Boolean).join(", "):"-",i=r.other_certificates?JSON.stringify(r.other_certificates,null,2):"-",o=wi(r.photo_url),l=e.querySelector("#employee-profile-photo"),c=e.querySelector("#employee-profile-photo-empty");l&&c&&(o?(l.src=o,l.classList.remove("d-none"),c.classList.add("d-none")):(l.src="",l.classList.add("d-none"),c.classList.remove("d-none"))),e.querySelector("#employee-profile-name").textContent=`${r.first_name??""} ${r.last_name??""}`.trim()||"-",e.querySelector("#employee-profile-position").textContent=((d=r.positions)==null?void 0:d.title)||"-",e.querySelector("#employee-profile-active").textContent=r.is_active?"":"",e.querySelector("#employee-profile-linked-profiles").textContent=a,e.querySelector("#employee-profile-psych").textContent=r.psychological_assessment_expiry||"-",e.querySelector("#employee-profile-medical").textContent=r.medical_certificate_expiry||"-",e.querySelector("#employee-profile-license").textContent=r.license_expiry||"-",e.querySelector("#employee-profile-certificates").textContent=i,Dr(e.querySelector("#employee-profile-modal"))}function wi(e){if(!e)return null;const t=String(e).trim();if(!t)return null;if(/^https?:\/\//i.test(t))return t;const r=t.replace(/^\/+/,""),s=["employee-photos","employees","employee_photos"],n=[],a=r.split("/");if(a.length>1){const o=a[0],l=a.slice(1).join("/");n.push({bucket:o,objectPath:l})}s.forEach(o=>{n.push({bucket:o,objectPath:r})});const i=new Set;for(const o of n){const l=`${o.bucket}/${o.objectPath}`;if(i.has(l)||!o.bucket||!o.objectPath)continue;i.add(l);const{data:c}=S.storage.from(o.bucket).getPublicUrl(o.objectPath);if(c!=null&&c.publicUrl)return c.publicUrl}return null}async function zd(e){const t=e.querySelector("#employee-position"),{data:r,error:s}=await S.from("positions").select("id, title").order("title",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${he(a.title)}</option>`).join("");t.innerHTML='<option value=""> </option>'+n}async function Vd(e){var x,C,O;const t=e.querySelector("#employee-id"),r=e.querySelector("#employee-first-name"),s=e.querySelector("#employee-last-name"),n=e.querySelector("#employee-position"),a=e.querySelector("#employee-active"),i=e.querySelector("#employee-psych-expiry"),o=e.querySelector("#employee-medical-expiry"),l=e.querySelector("#employee-license-expiry"),c=e.querySelector("#employee-photo-file"),d=e.querySelector("#employee-photo-path"),h=e.querySelector("#employee-save-btn"),u=r.value.trim(),f=s.value.trim(),p=n.value||null,y=a.checked,_=i.value||null,g=o.value||null,v=l.value||null,m=((x=c.files)==null?void 0:x[0])??null,w=d.value.trim()||null,k=t.value;if(!u||!f){b(",    .","warning");return}const E=h.innerHTML;h.disabled=!0,h.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const q={first_name:u,last_name:f,position_id:p,is_active:y,psychological_assessment_expiry:_,medical_certificate_expiry:g,license_expiry:v,updated_at:new Date().toISOString()};if(m&&!((C=m.type)!=null&&C.startsWith("image/"))){h.disabled=!1,h.innerHTML=E,b("    .","warning");return}let L,T=k||null,A=w;if(k){if(m){const K=await la(m,k);if(!K){h.disabled=!1,h.innerHTML=E;return}A=K}q.photo_url=A,{error:L}=await S.from("employees").update(q).eq("id",k)}else{const{data:K}=await S.auth.getUser(),M=((O=K==null?void 0:K.user)==null?void 0:O.email)??"web_app",{data:j,error:U}=await S.from("employees").insert({...q,created_from:M}).select("id").single();if(L=U,T=(j==null?void 0:j.id)??null,!L&&T&&m){const W=await la(m,T);if(!W){h.disabled=!1,h.innerHTML=E;return}const{error:Ue}=await S.from("employees").update({photo_url:W,updated_at:new Date().toISOString()}).eq("id",T);L=Ue,A=W}}if(h.disabled=!1,h.innerHTML=E,L){b(L.message,"error");return}b(k?"  .":"  .","success"),He(e.querySelector("#employee-modal")),on(e),await an(e)}function Gd(e,t){e.querySelector("#employee-id").value=t.id,e.querySelector("#employee-first-name").value=t.firstName??"",e.querySelector("#employee-last-name").value=t.lastName??"",e.querySelector("#employee-position").value=t.positionId??"",e.querySelector("#employee-active").checked=!!t.isActive,e.querySelector("#employee-psych-expiry").value=t.psychExpiry??"",e.querySelector("#employee-medical-expiry").value=t.medicalExpiry??"",e.querySelector("#employee-license-expiry").value=t.licenseExpiry??"",e.querySelector("#employee-photo-path").value=t.photoUrl??"",e.querySelector("#employee-photo-file").value="",mt(e,t.photoUrl??null),e.querySelector("#employee-form-title").textContent="  ",e.querySelector("#employee-save-btn").textContent=""}function on(e){e.querySelector("#employee-id").value="",e.querySelector("#employee-first-name").value="",e.querySelector("#employee-last-name").value="",e.querySelector("#employee-position").value="",e.querySelector("#employee-active").checked=!0,e.querySelector("#employee-psych-expiry").value="",e.querySelector("#employee-medical-expiry").value="",e.querySelector("#employee-license-expiry").value="",e.querySelector("#employee-photo-path").value="",e.querySelector("#employee-photo-file").value="",mt(e,null),e.querySelector("#employee-form-title").textContent=" ",e.querySelector("#employee-save-btn").textContent=""}async function Jd(e,t){const r=t.querySelector("#employee-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await S.from("employees").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){b(n.message,"error");return}b("  .","success"),He(t.querySelector("#employee-delete-modal")),on(t),await an(t)}async function la(e,t){var o;if(!e||!t)return null;const s=(((o=e.name)==null?void 0:o.split(".").pop())||"jpg").toLowerCase().replace(/[^a-z0-9]/g,"")||"jpg",n=Math.random().toString(36).slice(2,10),a=`${t}/${Date.now()}-${n}.${s}`,{error:i}=await S.storage.from(oa).upload(a,e,{upsert:!0,contentType:e.type||void 0});return i?(b(i.message,"error"),null):`${oa}/${a}`}function mt(e,t){const r=e.querySelector("#employee-photo-preview"),s=e.querySelector("#employee-photo-preview-empty");if(!r||!s)return;if(jt&&(URL.revokeObjectURL(jt),jt=null),!t){r.src="",r.classList.add("d-none"),s.classList.remove("d-none");return}if(t instanceof File){jt=URL.createObjectURL(t),r.src=jt,r.classList.remove("d-none"),s.classList.add("d-none");return}const n=wi(t);if(!n){r.src="",r.classList.add("d-none"),s.classList.remove("d-none");return}r.src=n,r.classList.remove("d-none"),s.classList.add("d-none")}function ys(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const ca=new Map;function Qd(e,t){const r=ca.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Et(a);return}}};ca.set(e,s),document.addEventListener("keydown",s)}function Et(e){var t,r;e.classList.add("d-none"),(t=document.querySelector("#employee-absence-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#employee-absence-delete-modal"))!=null&&r.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function Ee(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const ee={rows:[],searchQuery:"",dateFrom:"",dateTo:""};function da(e){return e&&`${e.first_name??""} ${e.last_name??""}`.trim()||"-"}async function ln(e){const{data:t,error:r}=await S.from("employee_absences").select("id, employee_id, reason_id, start_date, end_date, notes, employees(first_name, last_name), absence_reasons(name)").order("start_date",{ascending:!1}).order("end_date",{ascending:!1});if(r){b(r.message,"error"),ee.rows=[],gt(e,"    .");return}ee.rows=t||[],gt(e)}function gt(e,t){const r=e.querySelector("#employee-absences-table-body"),s=e.querySelector("#employee-absences-empty"),n=ee.rows.filter(a=>{var p;const i=da(a.employees).toLowerCase(),o=(((p=a.absence_reasons)==null?void 0:p.name)||"").toLowerCase(),l=String(a.start_date||"").toLowerCase(),c=String(a.end_date||"").toLowerCase(),d=String(a.notes||"").toLowerCase(),h=!ee.searchQuery||i.includes(ee.searchQuery)||o.includes(ee.searchQuery)||l.includes(ee.searchQuery)||c.includes(ee.searchQuery)||d.includes(ee.searchQuery),u=!ee.dateFrom||String(a.end_date||"")>=ee.dateFrom,f=!ee.dateTo||String(a.start_date||"")<=ee.dateTo;return h&&u&&f});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{var i;return`
        <tr>
          <td>${Ee(da(a.employees))}</td>
          <td>${Ee(((i=a.absence_reasons)==null?void 0:i.name)??"-")}</td>
          <td>${Ee(a.start_date??"-")}</td>
          <td>${Ee(a.end_date??"-")}</td>
          <td>${Ee(a.notes??"")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-employee-id="${a.employee_id??""}"
                data-reason-id="${a.reason_id??""}"
                data-start-date="${Ee(a.start_date??"")}"
                data-end-date="${Ee(a.end_date??"")}"
                data-notes="${Ee(a.notes??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}async function Yd(e){const t=await se("../employee-absences.html",import.meta.url);e.innerHTML=t,Xd(e),await Zd(e),await eu(e),await ln(e)}function Xd(e){const t=e.querySelector("#open-create-employee-absence"),r=e.querySelector("#employee-absence-form"),s=e.querySelector("#employee-absence-cancel-btn"),n=e.querySelector("#employee-absences-table-body"),a=e.querySelector("#employee-absence-modal"),i=e.querySelector("#employee-absence-delete-modal"),o=e.querySelector("#employee-absence-modal-close"),l=e.querySelector("#employee-absence-delete-confirm"),c=e.querySelector("#employee-absence-delete-cancel"),d=e.querySelector("#employee-absences-search"),h=e.querySelector("#employee-absences-date-from"),u=e.querySelector("#employee-absences-date-to"),f=e.querySelector("#employee-absences-filter-reset");t==null||t.addEventListener("click",()=>{cn(e),ys(a)}),r==null||r.addEventListener("submit",async p=>{p.preventDefault(),await tu(e)}),s==null||s.addEventListener("click",()=>{Et(a)}),o==null||o.addEventListener("click",()=>{Et(a)}),c==null||c.addEventListener("click",()=>{Et(i)}),d==null||d.addEventListener("input",p=>{ee.searchQuery=p.target.value.trim().toLowerCase(),gt(e)}),h==null||h.addEventListener("change",p=>{ee.dateFrom=p.target.value||"",gt(e)}),u==null||u.addEventListener("change",p=>{ee.dateTo=p.target.value||"",gt(e)}),f==null||f.addEventListener("click",()=>{ee.searchQuery="",ee.dateFrom="",ee.dateTo="",d&&(d.value=""),h&&(h.value=""),u&&(u.value=""),gt(e)}),Qd("employee-absences",[i,a]),l==null||l.addEventListener("click",async()=>{const p=e.querySelector("#employee-absence-delete-id").value;await su(p,e)}),n==null||n.addEventListener("click",p=>{const y=p.target.closest("button[data-action]");if(!y)return;const _=y.getAttribute("data-action");if(_==="edit"){ru(e,{id:y.getAttribute("data-id"),employeeId:y.getAttribute("data-employee-id"),reasonId:y.getAttribute("data-reason-id"),startDate:y.getAttribute("data-start-date"),endDate:y.getAttribute("data-end-date"),notes:y.getAttribute("data-notes")}),ys(a);return}if(_==="delete"){const g=y.getAttribute("data-id");e.querySelector("#employee-absence-delete-id").value=g,ys(i)}})}async function Zd(e){const t=e.querySelector("#employee-absence-employee"),{data:r,error:s}=await S.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>{const i=`${a.first_name??""} ${a.last_name??""}`.trim()||"-";return`<option value="${a.id}">${Ee(i)}</option>`}).join("");t.innerHTML='<option value=""> </option>'+n}async function eu(e){const t=e.querySelector("#employee-absence-reason"),{data:r,error:s}=await S.from("absence_reasons").select("id, name").order("name",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${Ee(a.name??"-")}</option>`).join("");t.innerHTML='<option value=""> </option>'+n}async function tu(e){var g;const t=e.querySelector("#employee-absence-id"),r=e.querySelector("#employee-absence-employee"),s=e.querySelector("#employee-absence-reason"),n=e.querySelector("#employee-absence-start-date"),a=e.querySelector("#employee-absence-end-date"),i=e.querySelector("#employee-absence-notes"),o=e.querySelector("#employee-absence-save-btn"),l=r.value||null,c=s.value||null,d=n.value,h=a.value,u=i.value.trim()||null,f=t.value;if(!l||!c||!d||!h){b(",    .","warning");return}if(h<d){b(' " "        " ".',"warning");return}const p=o.innerHTML;o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const y={employee_id:l,reason_id:c,start_date:d,end_date:h,notes:u};let _;if(f)({error:_}=await S.from("employee_absences").update(y).eq("id",f));else{const{data:v}=await S.auth.getUser(),m=((g=v==null?void 0:v.user)==null?void 0:g.email)??"web_app";({error:_}=await S.from("employee_absences").insert({...y,created_from:m}))}if(o.disabled=!1,o.innerHTML=p,_){b(_.message,"error");return}b(f?"  .":"  .","success"),Et(e.querySelector("#employee-absence-modal")),cn(e),await ln(e)}function ru(e,t){e.querySelector("#employee-absence-id").value=t.id,e.querySelector("#employee-absence-employee").value=t.employeeId??"",e.querySelector("#employee-absence-reason").value=t.reasonId??"",e.querySelector("#employee-absence-start-date").value=t.startDate??"",e.querySelector("#employee-absence-end-date").value=t.endDate??"",e.querySelector("#employee-absence-notes").value=t.notes??"",e.querySelector("#employee-absence-form-title").textContent="  ",e.querySelector("#employee-absence-save-btn").textContent=""}function cn(e){e.querySelector("#employee-absence-id").value="",e.querySelector("#employee-absence-employee").value="",e.querySelector("#employee-absence-reason").value="",e.querySelector("#employee-absence-start-date").value="",e.querySelector("#employee-absence-end-date").value="",e.querySelector("#employee-absence-notes").value="",e.querySelector("#employee-absence-form-title").textContent=" ",e.querySelector("#employee-absence-save-btn").textContent=""}async function su(e,t){const r=t.querySelector("#employee-absence-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await S.from("employee_absences").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){b(n.message,"error");return}b("  .","success"),Et(t.querySelector("#employee-absence-delete-modal")),cn(t),await ln(t)}function Gt(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const ua=new Map;function nu(e,t){const r=ua.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){me(a);return}}};ua.set(e,s),document.addEventListener("keydown",s)}function me(e){var t,r,s,n;e.classList.add("d-none"),(t=document.querySelector("#planned-duty-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#planned-duty-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#planned-duty-auto-modal"))!=null&&s.classList.contains("d-none"))&&((n=document.querySelector("#planned-duty-bulk-delete-modal"))!=null&&n.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function xe(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const I={rows:[],searchQuery:"",dateFilter:"",roleFilter:"",selectedIds:[],visibleRowIds:[]};function ha(e){return e&&`${e.first_name??""} ${e.last_name??""}`.trim()||"-"}async function Tt(e){const{data:t,error:r}=await S.from("planned_duties").select("id, date, employee_id, duty_id, assignment_role, employees(first_name, last_name), duties(name, schedule_key_duties(schedule_key_id))").order("date",{ascending:!1});if(r){b(r.message,"error"),I.rows=[],Oe(e,"     .");return}I.rows=t||[],Oe(e)}function Oe(e,t){const r=e.querySelector("#planned-duties-table-body"),s=e.querySelector("#planned-duties-empty"),n=e.querySelector("#planned-duties-select-all"),a=e.querySelector("#open-bulk-delete-planned-duty"),i=e.querySelector("#add-selected-to-actual-duty");I.selectedIds=I.selectedIds.filter(c=>I.rows.some(d=>d.id===c));const o=I.rows.filter(c=>{var _;const d=ha(c.employees).toLowerCase(),h=(((_=c.duties)==null?void 0:_.name)||"").toLowerCase(),u=(c.date||"").toLowerCase(),f=!I.searchQuery||d.includes(I.searchQuery)||h.includes(I.searchQuery)||u.includes(I.searchQuery),p=!I.dateFilter||c.date===I.dateFilter,y=!I.roleFilter||c.assignment_role===I.roleFilter;return f&&p&&y});if(!o.length){I.visibleRowIds=[],r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .",n&&(n.checked=!1,n.indeterminate=!1,n.disabled=!0),a&&(a.disabled=I.selectedIds.length===0,a.textContent=I.selectedIds.length?`  (${I.selectedIds.length})`:" "),i&&(i.disabled=I.selectedIds.length===0,i.textContent=I.selectedIds.length?`  (${I.selectedIds.length})`:" ");return}I.visibleRowIds=o.map(c=>c.id),s.classList.add("d-none"),r.innerHTML=o.map(c=>{var u;const d=au(c),h=I.selectedIds.includes(c.id);return`
        <tr>
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              data-select-id="${c.id}"
              ${h?"checked":""}
              aria-label=" "
            />
          </td>
          <td>${xe(c.date??"-")}</td>
          <td>${xe(ha(c.employees))}</td>
          <td>${xe(iu(c.assignment_role))}</td>
          <td>${xe(((u=c.duties)==null?void 0:u.name)??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${c.id}"
                data-date="${xe(c.date??"")}"
                data-employee-id="${c.employee_id??""}"
                data-duty-id="${c.duty_id??""}"
                data-assignment-role="${c.assignment_role??"conductor"}"
                data-duty-schedule-key-id="${d}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${c.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("");const l=o.filter(c=>I.selectedIds.includes(c.id)).length;n&&(n.disabled=!1,n.checked=l>0&&l===o.length,n.indeterminate=l>0&&l<o.length),a&&(a.disabled=I.selectedIds.length===0,a.textContent=I.selectedIds.length?`  (${I.selectedIds.length})`:" "),i&&(i.disabled=I.selectedIds.length===0,i.textContent=I.selectedIds.length?`  (${I.selectedIds.length})`:" ")}function au(e){var r,s,n;return((n=(Array.isArray((r=e==null?void 0:e.duties)==null?void 0:r.schedule_key_duties)?e.duties.schedule_key_duties:(s=e==null?void 0:e.duties)!=null&&s.schedule_key_duties?[e.duties.schedule_key_duties]:[]).find(a=>a==null?void 0:a.schedule_key_id))==null?void 0:n.schedule_key_id)||""}function iu(e){return e==="chief"?" ":""}let dn=[];async function ou(e){const t=e.querySelector("#planned-duty-employee"),r=e.querySelector("#planned-duty-auto-employee"),{data:s,error:n}=await S.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(n){b(n.message,"error");return}const i='<option value=""> </option>'+(s||[]).map(o=>{const l=`${o.first_name??""} ${o.last_name??""}`.trim()||"-";return`<option value="${o.id}">${xe(l)}</option>`}).join("");t.innerHTML=i,r.innerHTML=i}async function lu(e){const t=e.querySelector("#planned-duty-schedule-key"),r=e.querySelector("#planned-duty-auto-schedule-key"),{data:s,error:n}=await S.from("schedule_keys").select("id, name, crew_role").order("name",{ascending:!0});if(n){b(n.message,"error");return}const i='<option value=""> -</option>'+(s||[]).map(o=>{const l=cu(o.crew_role),c=l?`${o.name??"-"} (${l})`:o.name??"-";return`<option value="${o.id}">${xe(c)}</option>`}).join("");t.innerHTML=i,r.innerHTML=i}function cu(e){return e===" "?" ":e===""?"":""}async function du(e){const{data:t,error:r}=await S.from("schedule_key_duties").select("schedule_key_id, duty_id, duties(id, name)");if(r){b(r.message,"error");return}const s=new Map;(t||[]).forEach(n=>{const a=n==null?void 0:n.duties;if(!(a!=null&&a.id))return;const i=s.get(a.id)||{id:a.id,name:a.name||"-",scheduleKeyIds:[]};n.schedule_key_id&&!i.scheduleKeyIds.includes(n.schedule_key_id)&&i.scheduleKeyIds.push(n.schedule_key_id),s.set(a.id,i)}),dn=Array.from(s.values()).sort((n,a)=>String(n.name||"").localeCompare(String(a.name||""),"bg")),rs(e,"","")}function rs(e,t,r){const s=e.querySelector("#planned-duty-duty");if(!s)return;if(!t){s.innerHTML='<option value="">  -</option>',s.value="";return}const n=dn.filter(a=>{var i;return(i=a.scheduleKeyIds)==null?void 0:i.includes(t)}).map(a=>{const i=a.id===r?"selected":"";return`<option value="${a.id}" ${i}>${xe(a.name??"-")}</option>`}).join("");s.innerHTML='<option value=""> </option>'+n,r&&(s.value=r)}function uu(e,t){var s;const r=dn.find(n=>n.id===e);return!!(r&&((s=r.scheduleKeyIds)!=null&&s.includes(t)))}const ms=new Map;async function fa(e,t,r){const s=e.querySelector("#planned-duty-auto-start-duty");if(!s)return;if(!t){s.innerHTML='<option value="">  -</option>',s.value="";return}const n=await ki(t);if(!n.length){s.innerHTML='<option value="">    -</option>',s.value="";return}const a=n.map(i=>{const o=i.id===r?"selected":"";return`<option value="${i.id}" ${o}>${xe(i.name??"-")}</option>`}).join("");s.innerHTML='<option value="">  </option>'+a}function Si(e){e.querySelector("#planned-duty-auto-employee").value="",e.querySelector("#planned-duty-auto-assignment-role").value="conductor",e.querySelector("#planned-duty-auto-date-from").value="",e.querySelector("#planned-duty-auto-date-to").value="",e.querySelector("#planned-duty-auto-schedule-key").value="",e.querySelector("#planned-duty-auto-overwrite").checked=!1,e.querySelector("#planned-duty-auto-start-duty").innerHTML='<option value="">  -</option>'}async function hu(e,t){var L;const r=e.querySelector("#planned-duty-auto-employee").value||null,s=e.querySelector("#planned-duty-auto-assignment-role").value||"",n=e.querySelector("#planned-duty-auto-date-from").value,a=e.querySelector("#planned-duty-auto-date-to").value,i=e.querySelector("#planned-duty-auto-schedule-key").value||null,o=e.querySelector("#planned-duty-auto-start-duty").value||null,l=e.querySelector("#planned-duty-auto-overwrite").checked,c=e.querySelector("#planned-duty-auto-save-btn");if(!r||!s||!n||!a||!i||!o){b(",      .","warning");return}if(!["chief","conductor"].includes(s)){b(" .     .","warning");return}if(a<n){b(' " "        " ".',"warning");return}const d=await ki(i);if(!d.length){b("    -.","warning");return}const h=d.findIndex(T=>T.id===o);if(h<0){b("   .","warning");return}const u=fu(n,a);if(!u.length){b(" .","warning");return}const f=c.innerHTML;c.disabled=!0,c.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:p}=await S.auth.getUser(),y=((L=p==null?void 0:p.user)==null?void 0:L.email)??"web_app",{data:_,error:g}=await S.from("planned_duties").select("date").eq("employee_id",r).gte("date",n).lte("date",a);if(g){c.disabled=!1,c.innerHTML=f,b(g.message,"error");return}const v=new Set((_||[]).map(T=>T.date)),m=v.size,w=[];let k=0;if(u.forEach((T,A)=>{if(!l&&v.has(T)){k+=1;return}const x=d[(h+A)%d.length];w.push({date:T,employee_id:r,assignment_role:s,duty_id:x.id,created_from:y})}),!w.length){c.disabled=!1,c.innerHTML=f,b("    .       .","warning");return}if(l){const{error:T}=await S.from("planned_duties").delete().eq("employee_id",r).gte("date",n).lte("date",a);if(T){c.disabled=!1,c.innerHTML=f,b(T.message,"error");return}}let E=null;for(let T=0;T<w.length;T+=200){const A=w.slice(T,T+200),{error:x}=await S.from("planned_duties").insert(A);if(x){E=x;break}}if(c.disabled=!1,c.innerHTML=f,E){b(E.message,"error");return}me(e.querySelector("#planned-duty-auto-modal")),Si(e),await t();const q=w.length;if(l){b(` : ${q}.  : ${m}.`,"success");return}if(k>0){b(`: ${q}.  (   ): ${k}.`,"success");return}b(` : ${q}.`,"success")}async function ki(e){if(!e)return[];if(ms.has(e))return ms.get(e);const{data:t,error:r}=await S.from("schedule_key_duties").select("duty_id, duties(id, name, display_order)").eq("schedule_key_id",e);if(r)return b(r.message,"error"),[];const s=(t||[]).map(n=>{var a,i,o;return{id:(a=n==null?void 0:n.duties)==null?void 0:a.id,name:((i=n==null?void 0:n.duties)==null?void 0:i.name)||"-",displayOrder:Number((o=n==null?void 0:n.duties)==null?void 0:o.display_order)||0}}).filter(n=>n.id).sort((n,a)=>n.displayOrder!==a.displayOrder?n.displayOrder-a.displayOrder:String(n.name||"").localeCompare(String(a.name||""),"bg"));return ms.set(e,s),s}function fu(e,t){const r=[],s=new Date(`${e}T00:00:00`),n=new Date(`${t}T00:00:00`);if(Number.isNaN(s.getTime())||Number.isNaN(n.getTime())||s>n)return r;for(let a=new Date(s);a<=n;a.setDate(a.getDate()+1)){const i=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),l=String(a.getDate()).padStart(2,"0");r.push(`${i}-${o}-${l}`)}return r}function pu(e){if(!I.selectedIds.length){b("     .","warning");return}const t=e.querySelector("#planned-duty-bulk-delete-count");t&&(t.textContent=String(I.selectedIds.length)),Gt(e.querySelector("#planned-duty-bulk-delete-modal"))}function yu(e){const t=I.visibleRowIds||[];if(e){const r=new Set(I.selectedIds);t.forEach(s=>r.add(s)),I.selectedIds=Array.from(r);return}I.selectedIds=I.selectedIds.filter(r=>!t.includes(r))}function mu(e,t){if(e){if(t){I.selectedIds.includes(e)||(I.selectedIds=[...I.selectedIds,e]);return}I.selectedIds=I.selectedIds.filter(r=>r!==e)}}async function gu(e,t){const r=e.querySelector("#planned-duty-bulk-delete-confirm"),s=[...I.selectedIds];if(!s.length){me(e.querySelector("#planned-duty-bulk-delete-modal"));return}const n=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let a=null;for(let o=0;o<s.length;o+=200){const l=s.slice(o,o+200),{error:c}=await S.from("planned_duties").delete().in("id",l);if(c){a=c;break}}if(r.disabled=!1,r.innerHTML=n,a){b(a.message,"error");return}const i=s.length;I.selectedIds=[],me(e.querySelector("#planned-duty-bulk-delete-modal")),await t(),b(` : ${i}.`,"success")}async function bu(e,t){const r=e.querySelector("#add-selected-to-actual-duty"),s=[...I.selectedIds];if(!s.length){b("       .","warning");return}const n=new Set(s),a=I.rows.filter(d=>n.has(d.id));if(!a.length){b("     .","warning");return}const i=a.filter(d=>(d==null?void 0:d.date)&&(d==null?void 0:d.employee_id)&&(d==null?void 0:d.duty_id)).map(d=>({date:d.date,employee_id:d.employee_id,duty_id:d.duty_id,assignment_role:d.assignment_role||"conductor"}));if(!i.length){b("     .","warning");return}const o=(r==null?void 0:r.innerHTML)||" ";r&&(r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');let l=null;for(let d=0;d<i.length;d+=200){const h=i.slice(d,d+200),{error:u}=await S.from("actual_duties").upsert(h,{onConflict:"date,employee_id,duty_id",ignoreDuplicates:!0});if(u){l=u;break}}if(r&&(r.disabled=!1,r.innerHTML=o),l){b(l.message,"error");return}const c=i.length;I.selectedIds=[],await t(),b(`  : ${c}.   .`,"success")}async function vu(e){const t=await se("../planned-duties.html",import.meta.url);e.innerHTML=t,_u(e),await ou(e),await lu(e),await du(e),await Tt(e)}function _u(e){const t=e.querySelector("#open-create-planned-duty"),r=e.querySelector("#open-bulk-delete-planned-duty"),s=e.querySelector("#add-selected-to-actual-duty"),n=e.querySelector("#go-to-plan-schedule"),a=e.querySelector("#open-auto-plan-duty"),i=e.querySelector("#planned-duty-form"),o=e.querySelector("#planned-duty-auto-form"),l=e.querySelector("#planned-duty-cancel-btn"),c=e.querySelector("#planned-duty-auto-cancel-btn"),d=e.querySelector("#planned-duties-table-body"),h=e.querySelector("#planned-duty-modal"),u=e.querySelector("#planned-duty-auto-modal"),f=e.querySelector("#planned-duty-delete-modal"),p=e.querySelector("#planned-duty-bulk-delete-modal"),y=e.querySelector("#planned-duty-modal-close"),_=e.querySelector("#planned-duty-auto-modal-close"),g=e.querySelector("#planned-duty-delete-confirm"),v=e.querySelector("#planned-duty-delete-cancel"),m=e.querySelector("#planned-duty-bulk-delete-confirm"),w=e.querySelector("#planned-duty-bulk-delete-cancel"),k=e.querySelector("#planned-duties-select-all"),E=e.querySelector("#planned-duties-search"),q=e.querySelector("#planned-duties-date-filter"),L=e.querySelector("#planned-duties-role-filter"),T=e.querySelector("#planned-duties-filter-reset"),A=e.querySelector("#planned-duty-schedule-key"),x=e.querySelector("#planned-duty-auto-schedule-key");t==null||t.addEventListener("click",()=>{un(e),Gt(h)}),r==null||r.addEventListener("click",()=>{pu(e)}),s==null||s.addEventListener("click",async()=>{await bu(e,async()=>{await Tt(e)})}),a==null||a.addEventListener("click",async()=>{Si(e),Gt(u),await fa(e,(x==null?void 0:x.value)||"","")}),i==null||i.addEventListener("submit",async C=>{C.preventDefault(),await wu(e)}),o==null||o.addEventListener("submit",async C=>{C.preventDefault(),await hu(e,async()=>{await Tt(e)})}),l==null||l.addEventListener("click",()=>{me(h)}),y==null||y.addEventListener("click",()=>{me(h)}),_==null||_.addEventListener("click",()=>{me(u)}),c==null||c.addEventListener("click",()=>{me(u)}),v==null||v.addEventListener("click",()=>{me(f)}),w==null||w.addEventListener("click",()=>{me(p)}),E==null||E.addEventListener("input",C=>{I.searchQuery=C.target.value.trim().toLowerCase(),Oe(e)}),q==null||q.addEventListener("change",C=>{I.dateFilter=C.target.value||"",gs(n,I.dateFilter),Oe(e)}),L==null||L.addEventListener("change",C=>{I.roleFilter=C.target.value||"",Oe(e)}),T==null||T.addEventListener("click",()=>{I.searchQuery="",I.dateFilter="",I.roleFilter="",E&&(E.value=""),q&&(q.value=""),L&&(L.value=""),gs(n,I.dateFilter),Oe(e)}),n==null||n.addEventListener("click",()=>{const C=I.dateFilter||(q==null?void 0:q.value)||"";if(!C){b("   ,    -.","warning");return}const O=new URLSearchParams({date:C});window.history.pushState({},"",`/plan-schedule?${O.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}),gs(n,I.dateFilter||(q==null?void 0:q.value)||""),A==null||A.addEventListener("change",()=>{rs(e,A.value||"","")}),x==null||x.addEventListener("change",async()=>{await fa(e,x.value||"","")}),k==null||k.addEventListener("change",()=>{yu(k.checked),Oe(e)}),nu("planned-duties",[f,p,u,h]),g==null||g.addEventListener("click",async()=>{const C=e.querySelector("#planned-duty-delete-id").value;await ku(C,e)}),m==null||m.addEventListener("click",async()=>{await gu(e,async()=>{await Tt(e)})}),d==null||d.addEventListener("change",C=>{const O=C.target.closest("input[data-select-id]");if(!O)return;const K=O.getAttribute("data-select-id");mu(K,O.checked),Oe(e)}),d==null||d.addEventListener("click",C=>{const O=C.target.closest("button[data-action]");if(!O)return;const K=O.getAttribute("data-action");if(K==="edit"){Su(e,{id:O.getAttribute("data-id"),date:O.getAttribute("data-date"),employeeId:O.getAttribute("data-employee-id"),assignmentRole:O.getAttribute("data-assignment-role")||"conductor",dutyId:O.getAttribute("data-duty-id"),dutyScheduleKeyId:O.getAttribute("data-duty-schedule-key-id")}),Gt(h);return}if(K==="delete"){const M=O.getAttribute("data-id");e.querySelector("#planned-duty-delete-id").value=M,Gt(f)}})}async function wu(e){var g;const t=e.querySelector("#planned-duty-id"),r=e.querySelector("#planned-duty-date"),s=e.querySelector("#planned-duty-employee"),n=e.querySelector("#planned-duty-assignment-role"),a=e.querySelector("#planned-duty-schedule-key"),i=e.querySelector("#planned-duty-duty"),o=e.querySelector("#planned-duty-save-btn"),l=r.value,c=s.value||null,d=n.value||"",h=a.value||null,u=i.value||null,f=t.value;if(!l||!c||!d||!h||!u){b(",   .","warning");return}if(!["chief","conductor"].includes(d)){b(" .     .","warning");return}if(!uu(u,h)){b("    -.","warning");return}const p=o.innerHTML;o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const y={date:l,employee_id:c,assignment_role:d,duty_id:u};let _;if(f)({error:_}=await S.from("planned_duties").update(y).eq("id",f));else{const{data:v}=await S.auth.getUser(),m=((g=v==null?void 0:v.user)==null?void 0:g.email)??"web_app";({error:_}=await S.from("planned_duties").insert({...y,created_from:m}))}if(o.disabled=!1,o.innerHTML=p,_){if(_.code==="23505"){b("      .","warning");return}b(_.message,"error");return}b(f?"  .":"  .","success"),me(e.querySelector("#planned-duty-modal")),un(e),await Tt(e)}function Su(e,t){e.querySelector("#planned-duty-id").value=t.id,e.querySelector("#planned-duty-date").value=t.date??"",e.querySelector("#planned-duty-employee").value=t.employeeId??"",e.querySelector("#planned-duty-assignment-role").value=t.assignmentRole??"conductor",e.querySelector("#planned-duty-schedule-key").value=t.dutyScheduleKeyId??"",rs(e,t.dutyScheduleKeyId??"",t.dutyId??""),e.querySelector("#planned-duty-form-title").textContent="  ",e.querySelector("#planned-duty-save-btn").textContent=""}function un(e){e.querySelector("#planned-duty-id").value="",e.querySelector("#planned-duty-date").value="",e.querySelector("#planned-duty-employee").value="",e.querySelector("#planned-duty-assignment-role").value="conductor",e.querySelector("#planned-duty-schedule-key").value="",rs(e,"",""),e.querySelector("#planned-duty-form-title").textContent=" ",e.querySelector("#planned-duty-save-btn").textContent=""}async function ku(e,t){const r=t.querySelector("#planned-duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await S.from("planned_duties").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){b(n.message,"error");return}b("  .","success"),I.selectedIds=I.selectedIds.filter(a=>a!==e),me(t.querySelector("#planned-duty-delete-modal")),un(t),await Tt(t)}function gs(e,t){e&&(e.disabled=!t)}function Nt(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const pa=new Map;function Eu(e,t){const r=pa.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){ge(a);return}}};pa.set(e,s),document.addEventListener("keydown",s)}function ge(e){var t,r,s,n;e.classList.add("d-none"),(t=document.querySelector("#actual-duty-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#actual-duty-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#actual-duty-bulk-delete-modal"))!=null&&s.classList.contains("d-none"))&&((n=document.querySelector("#actual-duty-bulk-add-modal"))!=null&&n.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function be(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const $={rows:[],searchQuery:"",dateFilter:"",roleFilter:"",selectedIds:[],visibleRowIds:[],plannedRows:[],plannedSearchQuery:"",plannedDateFilter:"",plannedSelectedIds:[],plannedVisibleRowIds:[]};function ya(e){return e&&`${e.first_name??""} ${e.last_name??""}`.trim()||"-"}async function hr(e){const{data:t,error:r}=await S.from("actual_duties").select("id, date, employee_id, duty_id, assignment_role, employees(first_name, last_name), duties(name, schedule_key_duties(schedule_key_id))").order("date",{ascending:!1});if(r){b(r.message,"error"),$.rows=[],Pe(e,"     .");return}$.rows=t||[],Pe(e)}function Pe(e,t){const r=e.querySelector("#actual-duties-table-body"),s=e.querySelector("#actual-duties-empty"),n=e.querySelector("#actual-duties-select-all"),a=e.querySelector("#open-bulk-delete-actual-duty");$.selectedIds=$.selectedIds.filter(l=>$.rows.some(c=>c.id===l));const i=$.rows.filter(l=>{var y;const c=ya(l.employees).toLowerCase(),d=(((y=l.duties)==null?void 0:y.name)||"").toLowerCase(),h=(l.date||"").toLowerCase(),u=!$.searchQuery||c.includes($.searchQuery)||d.includes($.searchQuery)||h.includes($.searchQuery),f=!$.dateFilter||l.date===$.dateFilter,p=!$.roleFilter||l.assignment_role===$.roleFilter;return u&&f&&p});if(!i.length){$.visibleRowIds=[],r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"    .",n&&(n.checked=!1,n.indeterminate=!1,n.disabled=!0),a&&(a.disabled=$.selectedIds.length===0,a.textContent=$.selectedIds.length?`  (${$.selectedIds.length})`:" ");return}$.visibleRowIds=i.map(l=>l.id),s.classList.add("d-none"),r.innerHTML=i.map(l=>{var h;const c=Tu(l),d=$.selectedIds.includes(l.id);return`
        <tr>
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              data-select-id="${l.id}"
              ${d?"checked":""}
              aria-label=" "
            />
          </td>
          <td>${be(l.date??"-")}</td>
          <td>${be(ya(l.employees))}</td>
          <td>${be(qu(l.assignment_role))}</td>
          <td>${be(((h=l.duties)==null?void 0:h.name)??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${l.id}"
                data-date="${be(l.date??"")}"
                data-employee-id="${l.employee_id??""}"
                data-duty-id="${l.duty_id??""}"
                data-assignment-role="${l.assignment_role??"conductor"}"
                data-duty-schedule-key-id="${c}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${l.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("");const o=i.filter(l=>$.selectedIds.includes(l.id)).length;n&&(n.disabled=!1,n.checked=o>0&&o===i.length,n.indeterminate=o>0&&o<i.length),a&&(a.disabled=$.selectedIds.length===0,a.textContent=$.selectedIds.length?`  (${$.selectedIds.length})`:" ")}function Tu(e){var r,s,n;return((n=(Array.isArray((r=e==null?void 0:e.duties)==null?void 0:r.schedule_key_duties)?e.duties.schedule_key_duties:(s=e==null?void 0:e.duties)!=null&&s.schedule_key_duties?[e.duties.schedule_key_duties]:[]).find(a=>a==null?void 0:a.schedule_key_id))==null?void 0:n.schedule_key_id)||""}function qu(e){return e==="chief"?" ":""}let hn=[];async function Lu(e){const t=await se("../actual-duties.html",import.meta.url);e.innerHTML=t;const r=Nu(),s=e.querySelector("#actual-duties-date-filter");r&&s&&(s.value=r,$.dateFilter=r),$u(e),await Au(e),await xu(e),await Ru(e),await hr(e)}function $u(e){const t=e.querySelector("#open-create-actual-duty"),r=e.querySelector("#go-to-schedule"),s=e.querySelector("#open-bulk-delete-actual-duty"),n=e.querySelector("#open-bulk-add-actual-duty"),a=e.querySelector("#actual-duty-form"),i=e.querySelector("#actual-duties-table-body"),o=e.querySelector("#actual-duty-modal"),l=e.querySelector("#actual-duty-delete-modal"),c=e.querySelector("#actual-duty-bulk-delete-modal"),d=e.querySelector("#actual-duty-bulk-add-modal"),h=e.querySelector("#actual-duty-modal-close"),u=e.querySelector("#actual-duty-cancel-btn"),f=e.querySelector("#actual-duty-delete-confirm"),p=e.querySelector("#actual-duty-delete-cancel"),y=e.querySelector("#actual-duty-bulk-delete-confirm"),_=e.querySelector("#actual-duty-bulk-delete-cancel"),g=e.querySelector("#actual-duty-bulk-add-modal-close"),v=e.querySelector("#actual-duty-bulk-add-cancel"),m=e.querySelector("#actual-duty-bulk-add-confirm"),w=e.querySelector("#actual-duty-bulk-add-search"),k=e.querySelector("#actual-duty-bulk-add-date-filter"),E=e.querySelector("#actual-duty-bulk-add-filter-reset"),q=e.querySelector("#actual-duty-bulk-add-select-all"),L=e.querySelector("#actual-duty-bulk-add-table-body"),T=e.querySelector("#actual-duties-search"),A=e.querySelector("#actual-duties-date-filter"),x=e.querySelector("#actual-duties-role-filter"),C=e.querySelector("#actual-duties-filter-reset"),O=e.querySelector("#actual-duty-schedule-key"),K=e.querySelector("#actual-duties-select-all");t==null||t.addEventListener("click",()=>{Ei(e),Nt(o)}),s==null||s.addEventListener("click",()=>{if(!$.selectedIds.length){b("     .","warning");return}const M=e.querySelector("#actual-duty-bulk-delete-count");M&&(M.textContent=String($.selectedIds.length)),Nt(c)}),n==null||n.addEventListener("click",async()=>{ma(e),await Mu(e),Nt(d)}),a==null||a.addEventListener("submit",async M=>{M.preventDefault(),await Cu(e)}),h==null||h.addEventListener("click",()=>{ge(o)}),u==null||u.addEventListener("click",()=>{ge(o)}),p==null||p.addEventListener("click",()=>{ge(l)}),_==null||_.addEventListener("click",()=>{ge(c)}),g==null||g.addEventListener("click",()=>{ge(d)}),v==null||v.addEventListener("click",()=>{ge(d)}),T==null||T.addEventListener("input",M=>{$.searchQuery=M.target.value.trim().toLowerCase(),Pe(e)}),A==null||A.addEventListener("change",M=>{$.dateFilter=M.target.value||"",bs(r,$.dateFilter),Pe(e)}),x==null||x.addEventListener("change",M=>{$.roleFilter=M.target.value||"",Pe(e)}),C==null||C.addEventListener("click",()=>{$.searchQuery="",$.dateFilter="",$.roleFilter="",T&&(T.value=""),A&&(A.value=""),x&&(x.value=""),bs(r,$.dateFilter),Pe(e)}),r==null||r.addEventListener("click",()=>{const M=$.dateFilter||(A==null?void 0:A.value)||"";if(!M){b("   ,    .","warning");return}const j=new URLSearchParams({date:M});window.history.pushState({},"",`/schedule?${j.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}),bs(r,$.dateFilter||(A==null?void 0:A.value)||""),O==null||O.addEventListener("change",()=>{ss(e,O.value||"","")}),K==null||K.addEventListener("change",()=>{const M=$.visibleRowIds||[];if(K.checked){const j=new Set($.selectedIds);M.forEach(U=>j.add(U)),$.selectedIds=Array.from(j)}else $.selectedIds=$.selectedIds.filter(j=>!M.includes(j));Pe(e)}),f==null||f.addEventListener("click",async()=>{const M=e.querySelector("#actual-duty-delete-id").value;await Pu(M,e)}),y==null||y.addEventListener("click",async()=>{await Du(e)}),m==null||m.addEventListener("click",async()=>{await ju(e)}),w==null||w.addEventListener("input",M=>{$.plannedSearchQuery=M.target.value.trim().toLowerCase(),Ye(e)}),k==null||k.addEventListener("change",M=>{$.plannedDateFilter=M.target.value||"",Ye(e)}),E==null||E.addEventListener("click",()=>{ma(e),Ye(e)}),q==null||q.addEventListener("change",()=>{const M=$.plannedVisibleRowIds||[];if(q.checked){const j=new Set($.plannedSelectedIds);M.forEach(U=>j.add(U)),$.plannedSelectedIds=Array.from(j)}else $.plannedSelectedIds=$.plannedSelectedIds.filter(j=>!M.includes(j));Ye(e)}),L==null||L.addEventListener("change",M=>{const j=M.target.closest("input[data-planned-select-id]");if(!j)return;const U=j.getAttribute("data-planned-select-id");U&&(j.checked?$.plannedSelectedIds.includes(U)||($.plannedSelectedIds=[...$.plannedSelectedIds,U]):$.plannedSelectedIds=$.plannedSelectedIds.filter(W=>W!==U),Ye(e))}),i==null||i.addEventListener("change",M=>{const j=M.target.closest("input[data-select-id]");if(!j)return;const U=j.getAttribute("data-select-id");U&&(j.checked?$.selectedIds.includes(U)||($.selectedIds=[...$.selectedIds,U]):$.selectedIds=$.selectedIds.filter(W=>W!==U),Pe(e))}),i==null||i.addEventListener("click",M=>{const j=M.target.closest("button[data-action]");if(!j)return;const U=j.getAttribute("data-action");if(U==="edit"){Ou(e,{id:j.getAttribute("data-id"),date:j.getAttribute("data-date"),employeeId:j.getAttribute("data-employee-id"),assignmentRole:j.getAttribute("data-assignment-role")||"conductor",dutyId:j.getAttribute("data-duty-id"),dutyScheduleKeyId:j.getAttribute("data-duty-schedule-key-id")}),Nt(o);return}if(U==="delete"){const W=j.getAttribute("data-id");e.querySelector("#actual-duty-delete-id").value=W,Nt(l)}}),Eu("actual-duties",[l,c,d,o])}async function Au(e){const t=e.querySelector("#actual-duty-employee"),{data:r,error:s}=await S.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>{const i=`${a.first_name??""} ${a.last_name??""}`.trim()||"-";return`<option value="${a.id}">${be(i)}</option>`}).join("");t.innerHTML='<option value=""> </option>'+n}async function xu(e){const t=e.querySelector("#actual-duty-schedule-key"),{data:r,error:s}=await S.from("schedule_keys").select("id, name").order("name",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${be(a.name??"-")}</option>`).join("");t.innerHTML='<option value=""> -</option>'+n}async function Ru(e){const{data:t,error:r}=await S.from("schedule_key_duties").select("schedule_key_id, duty_id, duties(id, name)");if(r){b(r.message,"error");return}const s=new Map;(t||[]).forEach(n=>{const a=n==null?void 0:n.duties;if(!(a!=null&&a.id))return;const i=s.get(a.id)||{id:a.id,name:a.name||"-",scheduleKeyIds:[]};n.schedule_key_id&&!i.scheduleKeyIds.includes(n.schedule_key_id)&&i.scheduleKeyIds.push(n.schedule_key_id),s.set(a.id,i)}),hn=Array.from(s.values()).sort((n,a)=>String(n.name||"").localeCompare(String(a.name||""),"bg")),ss(e,"","")}function ss(e,t,r){const s=e.querySelector("#actual-duty-duty");if(!s)return;if(!t){s.innerHTML='<option value="">  -</option>',s.value="";return}const n=hn.filter(a=>{var i;return(i=a.scheduleKeyIds)==null?void 0:i.includes(t)}).map(a=>{const i=a.id===r?"selected":"";return`<option value="${a.id}" ${i}>${be(a.name??"-")}</option>`}).join("");s.innerHTML='<option value=""> </option>'+n,r&&(s.value=r)}function Iu(e,t){var s;const r=hn.find(n=>n.id===e);return!!(r&&((s=r.scheduleKeyIds)!=null&&s.includes(t)))}async function Cu(e){const t=e.querySelector("#actual-duty-id"),r=e.querySelector("#actual-duty-date"),s=e.querySelector("#actual-duty-employee"),n=e.querySelector("#actual-duty-schedule-key"),a=e.querySelector("#actual-duty-duty"),i=e.querySelector("#actual-duty-assignment-role"),o=e.querySelector("#actual-duty-save-btn"),l=r.value,c=s.value||null,d=n.value||null,h=a.value||null,u=i.value||"conductor",f=t.value;if(!l||!c||!d||!h){b(",   .","warning");return}if(!Iu(h,d)){b("    -.","warning");return}if(!["chief","conductor"].includes(u)){b(" .     .","warning");return}const p=o.innerHTML;o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const y={date:l,employee_id:c,duty_id:h,assignment_role:u};let _;if(f?{error:_}=await S.from("actual_duties").update(y).eq("id",f):{error:_}=await S.from("actual_duties").insert(y),o.disabled=!1,o.innerHTML=p,_){if(_.code==="23505"){b("      .","warning");return}b(_.message,"error");return}b(f?"  .":"  .","success"),ge(e.querySelector("#actual-duty-modal")),Ei(e),await hr(e)}function Ou(e,t){e.querySelector("#actual-duty-id").value=t.id,e.querySelector("#actual-duty-date").value=t.date??"",e.querySelector("#actual-duty-employee").value=t.employeeId??"",e.querySelector("#actual-duty-assignment-role").value=t.assignmentRole??"conductor",e.querySelector("#actual-duty-schedule-key").value=t.dutyScheduleKeyId??"",ss(e,t.dutyScheduleKeyId??"",t.dutyId??""),e.querySelector("#actual-duty-form-title").textContent="  ",e.querySelector("#actual-duty-save-btn").textContent=""}function Ei(e){e.querySelector("#actual-duty-id").value="",e.querySelector("#actual-duty-date").value="",e.querySelector("#actual-duty-employee").value="",e.querySelector("#actual-duty-assignment-role").value="conductor",e.querySelector("#actual-duty-schedule-key").value="",ss(e,"",""),e.querySelector("#actual-duty-form-title").textContent=" ",e.querySelector("#actual-duty-save-btn").textContent=""}async function Pu(e,t){const r=t.querySelector("#actual-duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await S.from("actual_duties").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){b(n.message,"error");return}$.selectedIds=$.selectedIds.filter(a=>a!==e),ge(t.querySelector("#actual-duty-delete-modal")),await hr(t),b("  .","success")}async function Du(e){const t=e.querySelector("#actual-duty-bulk-delete-confirm"),r=[...$.selectedIds];if(!r.length){ge(e.querySelector("#actual-duty-bulk-delete-modal"));return}const s=t.innerHTML;t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let n=null;for(let i=0;i<r.length;i+=200){const o=r.slice(i,i+200),{error:l}=await S.from("actual_duties").delete().in("id",o);if(l){n=l;break}}if(t.disabled=!1,t.innerHTML=s,n){b(n.message,"error");return}const a=r.length;$.selectedIds=[],ge(e.querySelector("#actual-duty-bulk-delete-modal")),await hr(e),b(` : ${a}.`,"success")}async function Mu(e){const{data:t,error:r}=await S.from("planned_duties").select("id, date, employee_id, duty_id, assignment_role, employees(first_name, last_name), duties(name)").order("date",{ascending:!1});if(r){b(r.message,"error"),$.plannedRows=[],Ye(e,"     .");return}$.plannedRows=t||[],$.plannedSelectedIds=[],Ye(e)}function Ye(e,t){const r=e.querySelector("#actual-duty-bulk-add-table-body"),s=e.querySelector("#actual-duty-bulk-add-empty"),n=e.querySelector("#actual-duty-bulk-add-select-all"),a=e.querySelector("#actual-duty-bulk-add-confirm");$.plannedSelectedIds=$.plannedSelectedIds.filter(l=>$.plannedRows.some(c=>c.id===l));const i=$.plannedRows.filter(l=>{var p,y,_;const c=`${((p=l.employees)==null?void 0:p.first_name)??""} ${((y=l.employees)==null?void 0:y.last_name)??""}`.trim().toLowerCase(),d=(((_=l.duties)==null?void 0:_.name)||"").toLowerCase(),h=(l.date||"").toLowerCase(),u=!$.plannedSearchQuery||c.includes($.plannedSearchQuery)||d.includes($.plannedSearchQuery)||h.includes($.plannedSearchQuery),f=!$.plannedDateFilter||l.date===$.plannedDateFilter;return u&&f});if(!i.length){$.plannedVisibleRowIds=[],r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"   .",n.checked=!1,n.indeterminate=!1,n.disabled=!0,a.disabled=$.plannedSelectedIds.length===0,a.textContent=$.plannedSelectedIds.length?`  (${$.plannedSelectedIds.length})`:" ";return}$.plannedVisibleRowIds=i.map(l=>l.id),s.classList.add("d-none"),r.innerHTML=i.map(l=>{var h,u,f;const c=$.plannedSelectedIds.includes(l.id),d=`${((h=l.employees)==null?void 0:h.first_name)??""} ${((u=l.employees)==null?void 0:u.last_name)??""}`.trim()||"-";return`
        <tr>
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              data-planned-select-id="${l.id}"
              ${c?"checked":""}
              aria-label=" "
            />
          </td>
          <td>${be(l.date??"-")}</td>
          <td>${be(d)}</td>
          <td>${be(Hu(l.assignment_role))}</td>
          <td>${be(((f=l.duties)==null?void 0:f.name)??"-")}</td>
        </tr>
      `}).join("");const o=i.filter(l=>$.plannedSelectedIds.includes(l.id)).length;n.disabled=!1,n.checked=o>0&&o===i.length,n.indeterminate=o>0&&o<i.length,a.disabled=$.plannedSelectedIds.length===0,a.textContent=$.plannedSelectedIds.length?`  (${$.plannedSelectedIds.length})`:" "}function ma(e){$.plannedSearchQuery="",$.plannedDateFilter="";const t=e.querySelector("#actual-duty-bulk-add-search"),r=e.querySelector("#actual-duty-bulk-add-date-filter");t&&(t.value=""),r&&(r.value="")}async function ju(e){const t=e.querySelector("#actual-duty-bulk-add-confirm"),r=[...$.plannedSelectedIds];if(!r.length){b("      .","warning");return}const s=new Set(r),n=$.plannedRows.filter(c=>s.has(c.id));if(!n.length){b("    .","warning");return}const a=n.map(c=>({date:c.date,employee_id:c.employee_id,duty_id:c.duty_id,assignment_role:c.assignment_role||"conductor"})),i=t.innerHTML;t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let o=null;for(let c=0;c<a.length;c+=200){const d=a.slice(c,c+200),{error:h}=await S.from("actual_duties").upsert(d,{onConflict:"date,employee_id,duty_id",ignoreDuplicates:!0});if(h){o=h;break}}if(t.disabled=!1,t.innerHTML=i,o){b(o.message,"error");return}const l=a.length;ge(e.querySelector("#actual-duty-bulk-add-modal")),await hr(e),b(` : ${l}.   .`,"success")}function bs(e,t){e&&(e.disabled=!t)}function Nu(){const t=new URLSearchParams(window.location.search).get("date")||"";return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:""}function Hu(e){return e==="chief"?" ":""}const Uu=" -  ";function Ti(e,t){const r=e==null?void 0:e.querySelector(t);r&&(r.textContent=Uu)}const ga="id, name, notes, schedule_key_id, display_order, start_time, end_time, second_day, duty_types(name)";async function qi(e){const{data:t,error:r}=await S.from("schedule_keys").select("id").lte("valid_from",e).gte("valid_to",e);if(r)return{data:[],error:r};const s=(t||[]).map(u=>u==null?void 0:u.id).filter(Boolean);if(!s.length)return{data:[],error:null};const{data:n,error:a}=await S.from("duties").select(ga).in("schedule_key_id",s);if(a)return{data:[],error:a};const{data:i,error:o}=await S.from("schedule_key_duties").select("duty_id").in("schedule_key_id",s);if(o)return{data:[],error:o};const l=new Set((n||[]).map(u=>u==null?void 0:u.id).filter(Boolean)),c=[...new Set((i||[]).map(u=>u==null?void 0:u.duty_id).filter(Boolean))].filter(u=>!l.has(u));if(!c.length)return{data:n||[],error:null};const{data:d,error:h}=await S.from("duties").select(ga).in("id",c);return h?{data:[],error:h}:{data:[...n||[],...d||[]],error:null}}function Fu(e){const t=String(e||"").trim().toLowerCase();return t==="chief"||t==="conductor"?t:""}function Li(e){const t=(e==null?void 0:e.first_name)??"",r=(e==null?void 0:e.last_name)??"";return`${t} ${r}`.trim()}function Bu(e){var r;const t=e==null?void 0:e.positions;return Array.isArray(t)?((r=t[0])==null?void 0:r.title)??"":t&&typeof t=="object"?t.title??"":""}function Ku(e){var r;const t=e==null?void 0:e.duty_types;return Array.isArray(t)?((r=t[0])==null?void 0:r.name)??"":t&&typeof t=="object"?t.name??"":""}function Wu(e){var r;const t=Array.isArray(e)?(r=e[0])==null?void 0:r.name:e&&typeof e=="object"?e.name:"";return String(t||"").trim()}function zu(e){const t=e==null?void 0:e.duties;return Array.isArray(t)?t[0]||null:t&&typeof t=="object"?t:null}function ba(e){const t=String(e||"").trim();if(!t)return"99:99:99";const r=t.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);if(!r)return"99:99:99";const s=String(Number(r[1])).padStart(2,"0"),n=r[2],a=r[3]||"00";return`${s}:${n}:${a}`}function Vu(){const t=new URLSearchParams(window.location.search).get("date")||"";return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:""}function le(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const va=96/25.4;function Gu(e,{orientation:t,compact:r,fitOnePage:s}){const n=document.documentElement,a=e.querySelector(".plan-schedule-sheet");if(n.classList.add("print-preparing"),n.classList.toggle("print-compact",r),n.classList.toggle("print-fit-one-page",s),a&&(a.classList.toggle("print-landscape-page",t==="landscape"),a.classList.toggle("print-portrait-page",t==="portrait")),!s||!a){n.style.setProperty("--plan-print-scale","1");return}n.style.setProperty("--plan-print-scale","1");const i=a.getBoundingClientRect(),o=t==="portrait"?210:297,l=t==="portrait"?297:210,c=(o-20)*va,d=(l-20)*va,h=c/Math.max(i.width,1),u=d/Math.max(i.height,1),f=Math.min(h,u,1);n.style.setProperty("--plan-print-scale",String(Math.max(.6,f)))}function Ju(){const e=document.documentElement;e.classList.remove("print-preparing","print-compact","print-fit-one-page","print-hide-second-day"),e.style.setProperty("--plan-print-scale","1"),document.querySelectorAll(".plan-schedule-sheet").forEach(t=>{t.classList.remove("print-landscape-page","print-portrait-page")})}function Qu(e){const t=new Map;return(e||[]).forEach(r=>{const s=r==null?void 0:r.employee_id;if(!s)return;const n=t.get(s)||{employeeId:s,employeeName:Li(r.employees),reasons:[]},a=Wu(r.absence_reasons);a&&!n.reasons.includes(a)&&n.reasons.push(a),t.set(s,n)}),t}function Yu(e){const t={train:[],businessTrip:[],dayOff:[]},r=new Map;return(e||[]).forEach(s=>{const n=zu(s);n!=null&&n.id&&(r.has(n.id)||r.set(n.id,n))}),Array.from(r.values()).forEach(s=>{const n=Ku(s).toLowerCase();if(n.includes(" ")){t.train.push(s);return}if(n.includes("")){t.businessTrip.push(s);return}n.includes(" ")&&t.dayOff.push(s)}),t.train.sort(rh),t.businessTrip.sort(js),t.dayOff.sort(js),t}function Xu(e,t){const r=new Map,s=new Map;return e.forEach(n=>{if(!(n!=null&&n.duty_id)||!(n!=null&&n.employees))return;if(n!=null&&n.employee_id&&(t!=null&&t.has(n.employee_id))){const l=t.get(n.employee_id);l&&!s.has(n.employee_id)&&s.set(n.employee_id,{employeeId:l.employeeId,employeeName:l.employeeName,reason:l.reasons.join(", ")});return}const a=r.get(n.duty_id)||{chiefs:[],conductors:[]},i=Li(n.employees),o=Fu(n.assignment_role);if(o==="chief"&&i&&!a.chiefs.includes(i)&&a.chiefs.push(i),o==="conductor"&&i&&!a.conductors.includes(i)&&a.conductors.push(i),!o){const l=Bu(n.employees).toLowerCase();l.includes("")&&l.includes("")&&i&&!a.chiefs.includes(i)&&a.chiefs.push(i),l.includes("")&&i&&!a.conductors.includes(i)&&a.conductors.push(i)}r.set(n.duty_id,a)}),{assignmentsByDuty:r,absentAssignments:Array.from(s.values()).sort((n,a)=>String((n==null?void 0:n.employeeName)||"").localeCompare(String((a==null?void 0:a.employeeName)||""),"bg"))}}function Ht(e,t,r){vs(e.querySelector("#plan-schedule-train"),t.train,r,{conductorRows:2,showHours:!0,separateSecondDay:!0,minPanels:2,printAsCards:!0}),vs(e.querySelector("#plan-schedule-business-trip"),t.businessTrip,r,{conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0,printAsCards:!0}),vs(e.querySelector("#plan-schedule-day-off"),t.dayOff,r,{conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0,printAsCards:!0})}function Ut(e,t){if(!e)return;if(!t.length){e.innerHTML='<p class="text-secondary mb-0">   .</p>';return}const r=t.map(s=>`
      <tr>
        <td>${le(s.employeeName||"")}</td>
        <td>${le(s.reason||"")}</td>
      </tr>
    `).join("");e.innerHTML=`
    <table class="table table-bordered align-middle mb-0 plan-schedule-table">
      <thead>
        <tr>
          <th scope="col"></th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        ${r}
      </tbody>
    </table>
  `}function Ft(e,{hint:t,error:r,empty:s}){const n=e.querySelector("#plan-schedule-hint"),a=e.querySelector("#plan-schedule-error"),i=e.querySelector("#plan-schedule-empty");n&&(n.textContent=t||"",n.classList.toggle("d-none",!t)),a&&(a.textContent=r||"",a.classList.toggle("d-none",!r)),i&&(i.textContent=s||"",i.classList.toggle("d-none",!s))}function Zu(e){const t=new Date(`${e}T00:00:00`);return Number.isNaN(t.getTime())?e:new Intl.DateTimeFormat("bg-BG",{day:"2-digit",month:"long",year:"numeric"}).format(t)}function vs(e,t,r,s={}){if(!e)return;if(!t.length){e.innerHTML='<p class="text-secondary mb-0">    .</p>';return}const n=s.separateSecondDay?sh(t):t,a=Number.isInteger(s.conductorRows)&&s.conductorRows>=0?s.conductorRows:3,i=5,o=th(n,i),l=Number.isInteger(s.minPanels)&&s.minPanels>0?s.minPanels:1;for(;o.length<l;)o.push([]);e.innerHTML=o.map(c=>{const d=[...c];for(;d.length<i;)d.push(null);const h=d.map(m=>{const w=xr(m,"text-center"),k=De(m)?"":(m==null?void 0:m.name)??"";if(!k)return`<th scope="col"${w}></th>`;const E=String((m==null?void 0:m.notes)||"").trim(),q=E?`<div class="schedule-duty-note" title="${le(E)}">${le(E)}</div>`:"";return`<th scope="col"${w}><span class="schedule-duty-name-wrap">${Ar("","train")}<span class="schedule-duty-name-ellipsis" title="${le(k)}">${le(k)}</span></span>${q}</th>`}).join(""),u=d.map(m=>{const w=xr(m),k=m&&!De(m)?$i(m):"";return!m||De(m)?`<td${w}></td>`:`<td${w}>${Ar("","hours")}${le(k)}</td>`}).join(""),f=d.map(m=>{if(!m)return"<td></td>";const w=xr(m);if(De(m))return`<td${w}></td>`;const k=r.get(m.id)||{chiefs:[]},E=k.chiefs.length?k.chiefs.join(", "):"";return`<td${w}>${Ar("","chief")}${le(E)}</td>`}).join("");let p=a;if(s.hideEmptyConductorRows){const m=d.reduce((w,k)=>{if(!k||De(k))return w;const E=r.get(k.id)||{conductors:[]},q=Array.isArray(E.conductors)?E.conductors.length:0;return Math.max(w,q)},0);p=Math.min(a,m)}const y=p>0?Array.from({length:p},(m,w)=>`
            <tr>
              ${d.map(E=>{if(!E)return"<td></td>";const q=xr(E);if(De(E))return`<td${q}></td>`;const T=(r.get(E.id)||{conductors:[]}).conductors[w]||"";return`<td${q}>${Ar("-","conductor")}${le(T)}</td>`}).join("")}
            </tr>
          `).join(""):"",_=s.showHours===!1?"":`
            <tr>
              ${u}
            </tr>
          `,g=`
        <table class="table table-bordered align-middle mb-3 plan-schedule-table">
          <thead>
            <tr>
              ${h}
            </tr>
          </thead>
          <tbody>
            ${_}
            <tr>
              ${f}
            </tr>
            ${y}
          </tbody>
        </table>
      `;if(!s.printAsCards)return g;const v=eh(d,r,p,s);return`
        <div class="print-as-cards">
          ${g}
          <div class="print-only-duty-cards mb-3">${v}</div>
        </div>
      `}).join("")}function eh(e,t,r,s={}){return`<div class="print-duty-cards-grid">${e.map(a=>{const i=s.showHours!==!1,o=i?`
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
          `:"";if(!a||De(a)){const h=Array.from({length:r},()=>`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value"></span>
          </div>
        `).join("");return`
          <article class="print-duty-card">
            <div class="print-duty-card-title"></div>
            <div class="print-duty-card-note"></div>
            ${o}
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
            ${h}
          </article>
        `}const l=t.get(a.id)||{chiefs:[],conductors:[]},c=Array.isArray(l.chiefs)?l.chiefs.join(", "):"",d=Array.from({length:r},(h,u)=>{const f=Array.isArray(l.conductors)&&l.conductors[u]||"";return`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value">${le(f)}</span>
          </div>
        `}).join("");return`
        <article class="print-duty-card">
          <div class="print-duty-card-title">${le(a.name||"")}</div>
          <div class="print-duty-card-note">${le(String(a.notes||"").trim())}</div>
          ${i?`
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value">${le($i(a))}</span>
            </div>
          `:""}
          <div class="print-duty-card-line">
            <span class="print-duty-card-key"></span>
            <span class="print-duty-card-value">${le(c)}</span>
          </div>
          ${d}
        </article>
      `}).join("")}</div>`}function th(e,t){const r=[];for(let s=0;s<e.length;s+=t)r.push(e.slice(s,s+t));return r}function $i(e){const t=((e==null?void 0:e.start_time)||"").slice(0,5),r=((e==null?void 0:e.end_time)||"").slice(0,5);return!t&&!r?"":t&&r?`${t} - ${r}`:t||r}function Ar(e,t){return`<span class="${t?`schedule-cell-key-badge schedule-cell-key-badge-${t}`:"schedule-cell-key-badge"}">${le(e)}</span>`}function js(e,t){const r=(e==null?void 0:e.schedule_key_id)||"",s=(t==null?void 0:t.schedule_key_id)||"";if(r!==s)return String(r).localeCompare(String(s),"bg");const n=Number.isFinite(Number(e==null?void 0:e.display_order))?Number(e.display_order):Number.MAX_SAFE_INTEGER,a=Number.isFinite(Number(t==null?void 0:t.display_order))?Number(t.display_order):Number.MAX_SAFE_INTEGER;return n!==a?n-a:String((e==null?void 0:e.name)||"").localeCompare(String((t==null?void 0:t.name)||""),"bg")}function rh(e,t){const r=!!(e!=null&&e.second_day),s=!!(t!=null&&t.second_day);if(r!==s)return r?1:-1;const n=ba(e==null?void 0:e.start_time),a=ba(t==null?void 0:t.start_time);return n!==a?n.localeCompare(a,"bg"):js(e,t)}function sh(e){const t=[],r=[];return e.forEach(a=>{if(a!=null&&a.second_day){r.push(a);return}t.push(a)}),!t.length||!r.length?e:t.length%5!==0?[...t,{__separator:!0},...r]:[...t,...r]}function De(e){return!!(e&&e.__separator)}function xr(e,t=""){const r=[];return t&&r.push(t),De(e)?r.push("separator-col"):e!=null&&e.second_day&&r.push("second-day-col"),r.length?` class="${r.join(" ")}"`:""}async function nh(e){const t=await se("../plan-schedule.html",import.meta.url);e.innerHTML=t,Ti(e,"#plan-schedule-print-left-label");const r=e.querySelector("#plan-schedule-date"),s=e.querySelector("#plan-schedule-print"),n=e.querySelector("#plan-schedule-print-orientation"),a=e.querySelector("#plan-schedule-print-compact"),i=e.querySelector("#plan-schedule-print-fit-one-page"),o=Vu();r&&o?r.value=o:r&&!r.value&&(r.value=new Date().toISOString().split("T")[0]),r==null||r.addEventListener("change",async()=>{await _a(e)}),s==null||s.addEventListener("click",()=>{const l=(n==null?void 0:n.value)==="portrait"?"portrait":"landscape",c=(a==null?void 0:a.checked)??!0,d=(i==null?void 0:i.checked)??!0;Gu(e,{orientation:l,compact:c,fitOnePage:d}),window.addEventListener("afterprint",Ju,{once:!0}),window.print()}),await _a(e)}async function _a(e){const t=e.querySelector("#plan-schedule-date"),r=t==null?void 0:t.value,s=e.querySelector("#plan-schedule-sheet-date");if(s&&(s.textContent=r?Zu(r):""),!r){Ht(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ut(e.querySelector("#plan-schedule-absence"),[]),Ft(e,{hint:" .",error:"",empty:""});return}const{data:n,error:a}=await S.from("planned_duties").select("employee_id, duty_id, assignment_role, employees(first_name, last_name, positions(title)), duties(id, name, schedule_key_id, display_order, start_time, end_time, second_day, duty_types(name))").eq("date",r);if(a){b(a.message,"error"),Ht(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ut(e.querySelector("#plan-schedule-absence"),[]),Ft(e,{hint:"",error:"     .",empty:""});return}const{data:i,error:o}=await qi(r);if(o){b(o.message,"error"),Ht(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ut(e.querySelector("#plan-schedule-absence"),[]),Ft(e,{hint:"",error:"    .",empty:""});return}const{data:l,error:c}=await S.from("employee_absences").select("employee_id, start_date, end_date, employees(first_name, last_name), absence_reasons(name)").lte("start_date",r).gte("end_date",r);if(c){b(c.message,"error"),Ht(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ut(e.querySelector("#plan-schedule-absence"),[]),Ft(e,{hint:"",error:"    .",empty:""});return}const d=Qu(l||[]),h=Yu((i||[]).map(y=>({duties:y}))),{assignmentsByDuty:u,absentAssignments:f}=Xu(n||[],d);Ht(e,h,u),Ut(e.querySelector("#plan-schedule-absence"),f);const p=h.train.length+h.businessTrip.length+h.dayOff.length;Ft(e,{hint:"",error:"",empty:p||f.length?"":"      ."})}const wa=new Map;function Sa(e){const t=String(e||"").trim();if(!t)return"99:99:99";const r=t.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);if(!r)return"99:99:99";const s=String(Number(r[1])).padStart(2,"0"),n=r[2],a=r[3]||"00";return`${s}:${n}:${a}`}function ah(e){const t=(e==null?void 0:e.first_name)??"",r=(e==null?void 0:e.last_name)??"";return`${t} ${r}`.trim()}function ih(e){var r;const t=e==null?void 0:e.positions;return Array.isArray(t)?((r=t[0])==null?void 0:r.title)??"":t&&typeof t=="object"?t.title??"":""}function Ns(e){const t=String((e==null?void 0:e.assignment_role)||"").trim().toLowerCase();if(t==="chief"||t==="conductor")return t;const r=ih(e==null?void 0:e.employees).toLowerCase();return r.includes("")&&r.includes("")?"chief":"conductor"}function Rt(e){var r;const t=e==null?void 0:e.duty_types;return Array.isArray(t)?((r=t[0])==null?void 0:r.name)??"":t&&typeof t=="object"?t.name??"":""}function Hs(e){const t=e==null?void 0:e.duties;return Array.isArray(t)?t[0]||null:t&&typeof t=="object"?t:null}function oh(){const t=new URLSearchParams(window.location.search).get("date")||"";return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:""}function oe(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function lh(e){e==null||e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}function Mr(e){e==null||e.classList.add("d-none"),!!document.querySelector("#schedule-actual-edit-modal:not(.d-none)")||document.body.classList.remove("overflow-hidden")}function ch(e,t){const r=wa.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Mr(a);return}}};wa.set(e,s),document.addEventListener("keydown",s)}const ka=96/25.4;function dh(e,{orientation:t,compact:r,fitOnePage:s}){const n=document.documentElement,a=e.querySelector(".plan-schedule-sheet");if(n.classList.add("print-preparing"),n.classList.add("print-hide-second-day"),n.classList.toggle("print-compact",r),n.classList.toggle("print-fit-one-page",s),a&&(a.classList.toggle("print-landscape-page",t==="landscape"),a.classList.toggle("print-portrait-page",t==="portrait")),!s||!a){n.style.setProperty("--plan-print-scale","1");return}n.style.setProperty("--plan-print-scale","1");const i=a.getBoundingClientRect(),o=t==="portrait"?210:297,l=t==="portrait"?297:210,c=(o-20)*ka,d=(l-20)*ka,h=c/Math.max(i.width,1),u=d/Math.max(i.height,1),f=Math.min(h,u,1);n.style.setProperty("--plan-print-scale",String(Math.max(.6,f)))}function uh(){const e=document.documentElement;e.classList.remove("print-preparing","print-compact","print-fit-one-page","print-hide-second-day"),e.style.setProperty("--plan-print-scale","1"),document.querySelectorAll(".plan-schedule-sheet").forEach(t=>{t.classList.remove("print-landscape-page","print-portrait-page")})}function hh(e,t){const r=new Map;return e.forEach(s=>{var l;if(!(s!=null&&s.duty_id)||!(s!=null&&s.employees)||!(s!=null&&s.id)||s!=null&&s.employee_id&&(t!=null&&t.has(s.employee_id)))return;const n=r.get(s.duty_id)||{chiefs:[],conductors:[]},a=ah(s.employees),i=Ns(s),o={id:s.id,employeeId:s.employee_id,role:i,name:a,dutyName:((l=Hs(s))==null?void 0:l.name)||"",date:s.date||""};i==="chief"?a&&!n.chiefs.some(c=>c.id===o.id)&&n.chiefs.push(o):i==="conductor"&&a&&!n.conductors.some(c=>c.id===o.id)&&n.conductors.push(o),r.set(s.duty_id,n)}),r}function Bt(e,t,r,s){_s(e.querySelector("#schedule-train"),t.train,r,s,{allowAdd:!0,allowEdit:!0,conductorRows:2,printConductorRows:3,printExtraCardRows:1,showHours:!0,separateSecondDay:!0,minPanels:2,printAsCards:!0,printHideSecondDay:!0}),_s(e.querySelector("#schedule-business-trip"),t.businessTrip,r,s,{allowAdd:!0,allowEdit:!0,conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0}),_s(e.querySelector("#schedule-day-off"),t.dayOff,r,s,{allowAdd:!0,allowEdit:!0,conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0})}function Kt(e,{hint:t,error:r,empty:s}){const n=e.querySelector("#schedule-hint"),a=e.querySelector("#schedule-error"),i=e.querySelector("#schedule-empty");n&&(n.textContent=t||"",n.classList.toggle("d-none",!t)),a&&(a.textContent=r||"",a.classList.toggle("d-none",!r)),i&&(i.textContent=s||"",i.classList.toggle("d-none",!s))}function fh(e){const t=new Date(`${e}T00:00:00`);return Number.isNaN(t.getTime())?e:new Intl.DateTimeFormat("bg-BG",{day:"2-digit",month:"long",year:"numeric"}).format(t)}function Us(e,t){const r=(e==null?void 0:e.schedule_key_id)||"",s=(t==null?void 0:t.schedule_key_id)||"";if(r!==s)return String(r).localeCompare(String(s),"bg");const n=Number.isFinite(Number(e==null?void 0:e.display_order))?Number(e.display_order):Number.MAX_SAFE_INTEGER,a=Number.isFinite(Number(t==null?void 0:t.display_order))?Number(t.display_order):Number.MAX_SAFE_INTEGER;return n!==a?n-a:String((e==null?void 0:e.name)||"").localeCompare(String((t==null?void 0:t.name)||""),"bg")}function ph(e,t){const r=!!(e!=null&&e.second_day),s=!!(t!=null&&t.second_day);if(r!==s)return r?1:-1;const n=Sa(e==null?void 0:e.start_time),a=Sa(t==null?void 0:t.start_time);return n!==a?n.localeCompare(a,"bg"):Us(e,t)}function _s(e,t,r,s,n={}){if(!e)return;if(!t.length){e.innerHTML='<p class="text-secondary mb-0">    .</p>';return}const a=n.separateSecondDay?mh(t):t,i=Number.isInteger(n.conductorRows)&&n.conductorRows>=0?n.conductorRows:3,o=5,l=gh(a,o),c=Number.isInteger(n.minPanels)&&n.minPanels>0?n.minPanels:1,d=Number.isInteger(n.printConductorRows)&&n.printConductorRows>0?n.printConductorRows:i;for(;l.length<c;)l.push([]);const h=l.map(p=>{const y=[...p];for(;y.length<o;)y.push(null);const _=y.map(L=>{const T=Ir(L,"text-center"),A=Me(L)?"":(L==null?void 0:L.name)??"";if(!A)return`<th scope="col"${T}></th>`;const x=String((L==null?void 0:L.notes)||"").trim(),C=x?`<div class="schedule-duty-note" title="${oe(x)}">${oe(x)}</div>`:"";return`<th scope="col"${T}><span class="schedule-duty-name-wrap">${Rr("","train")}<span class="schedule-duty-name-ellipsis" title="${oe(A)}">${oe(A)}</span></span>${C}</th>`}).join(""),g=y.map(L=>{const T=Ir(L),A=L&&!Me(L)?Ri(L):"";return!L||Me(L)?`<td${T}></td>`:`<td${T}>${Rr("","hours")}${oe(A)}</td>`}).join(""),v=y.map(L=>{if(!L)return"<td></td>";const T=Ir(L);if(Me(L))return`<td${T}></td>`;const A=r.get(L.id)||{chiefs:[]},x=Rt(L).toLowerCase();return`<td${T} data-drop-duty-id="${L.id}" data-drop-date="${s}" data-drop-role="chief" data-drop-duty-type="${oe(x)}">${Rr("","chief")}${yh(A.chiefs,L,s,n)}</td>`}).join("");let m=i;if(n.hideEmptyConductorRows){const L=y.reduce((T,A)=>{if(!A||Me(A))return T;const x=r.get(A.id)||{conductors:[]},C=Array.isArray(x.conductors)?x.conductors.length:0;return Math.max(T,C)},0);m=Math.min(i,L)}const w=m>0?Array.from({length:m},(L,T)=>`
          <tr>
            ${y.map(x=>{if(!x)return"<td></td>";const C=Ir(x);if(Me(x))return`<td${C}></td>`;const O=r.get(x.id)||{conductors:[]},K=Number.isInteger(n.conductorRowOffset)&&n.conductorRowOffset>0?n.conductorRowOffset:0,M=T-K,j=M>=0&&Array.isArray(O.conductors)?O.conductors[M]:void 0,U=Rt(x).toLowerCase();return`<td${C} data-drop-duty-id="${x.id}" data-drop-date="${s}" data-drop-role="conductor" data-drop-duty-type="${oe(U)}">${Rr("-","conductor")}${Ai(j,x,s,n)}</td>`}).join("")}
          </tr>
        `).join(""):"",k=n.showHours===!1?"":`
            <tr>
              ${g}
            </tr>
          `,E=`
        <table class="table table-bordered align-middle mb-3 plan-schedule-table">
          <thead>
            <tr>
              ${_}
            </tr>
          </thead>
          <tbody>
            ${k}
            <tr>
              ${v}
            </tr>
            ${w}
          </tbody>
        </table>
      `;if(!n.printAsCards)return E;const q=Ea(y,r,d,n);return`
        <div class="print-as-cards">
          ${E}
          <div class="print-only-duty-cards mb-3">${q}</div>
        </div>
      `}).join(""),u=Number.isInteger(n.printExtraCardRows)&&n.printExtraCardRows>0?n.printExtraCardRows:0,f=n.printAsCards&&u>0?Array.from({length:u},()=>`
        <div class="print-as-cards">
          <div class="print-only-duty-cards mb-3">${Ea(Array.from({length:o},()=>null),new Map,d,n)}</div>
        </div>
      `).join(""):"";e.innerHTML=h+f}function Ea(e,t,r,s={}){return`<div class="print-duty-cards-grid">${e.map(a=>{const i=s.printHideSecondDay&&(a!=null&&a.second_day)?null:a;if(!i||Me(i))return`
          <article class="print-duty-card">
            <div class="print-duty-card-title"></div>
            <div class="print-duty-card-note"></div>
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
            ${Array.from({length:r},()=>`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value"></span>
          </div>
        `).join("")}
          </article>
        `;const o=t.get(i.id)||{chiefs:[],conductors:[]},l=Array.isArray(o.chiefs)?o.chiefs.map(d=>(d==null?void 0:d.name)||"").filter(Boolean).join(", "):"",c=Array.from({length:r},(d,h)=>{var y;const u=Number.isInteger(s.conductorRowOffset)&&s.conductorRowOffset>0?s.conductorRowOffset:0,f=h-u,p=Array.isArray(o.conductors)&&f>=0&&((y=o.conductors[f])==null?void 0:y.name)||"";return`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value">${oe(p)}</span>
          </div>
        `}).join("");return`
        <article class="print-duty-card">
          <div class="print-duty-card-title">${oe(i.name||"")}</div>
          <div class="print-duty-card-note">${oe(String(i.notes||"").trim())}</div>
          <div class="print-duty-card-line">
            <span class="print-duty-card-key"></span>
            <span class="print-duty-card-value">${oe(Ri(i))}</span>
          </div>
          <div class="print-duty-card-line">
            <span class="print-duty-card-key"></span>
            <span class="print-duty-card-value">${oe(l)}</span>
          </div>
          ${c}
        </article>
      `}).join("")}</div>`}function yh(e,t,r,s={}){return e!=null&&e.length?e.map(n=>Ai(n,t,r,s)).join("<br>"):xi(t,r,s)}function Ai(e,t,r,s={}){return e!=null&&e.id?s.allowEdit!==!1?`<button type="button" class="btn btn-link p-0 text-decoration-none align-baseline" draggable="true" data-actual-edit-id="${e.id}" data-actual-drag-id="${e.id}">${oe(e.name||"")}</button>`:oe(e.name||""):xi(t,r,s)}function xi(e,t,r={}){return!(r.allowAdd!==!1)||!(e!=null&&e.id)||!t?"":`<button type="button" class="btn btn-link p-0 text-decoration-none no-print" data-actual-add-duty-id="${e.id}" data-actual-add-date="${t}" data-actual-add-duty-name="${oe(e.name||"")}"></button>`}function Rr(e,t){return`<span class="${t?`schedule-cell-key-badge schedule-cell-key-badge-${t}`:"schedule-cell-key-badge"}">${oe(e)}</span>`}function Ri(e){const t=((e==null?void 0:e.start_time)||"").slice(0,5),r=((e==null?void 0:e.end_time)||"").slice(0,5);return!t&&!r?"":t&&r?`${t} - ${r}`:t||r}function mh(e){const t=[],r=[];return e.forEach(a=>{if(a!=null&&a.second_day){r.push(a);return}t.push(a)}),!t.length||!r.length?e:t.length%5!==0?[...t,{__separator:!0},...r]:[...t,...r]}function Me(e){return!!(e&&e.__separator)}function Ir(e,t=""){const r=[];return t&&r.push(t),Me(e)?r.push("separator-col"):e!=null&&e.second_day&&r.push("second-day-col"),r.length?` class="${r.join(" ")}"`:""}function gh(e,t){const r=[];for(let s=0;s<e.length;s+=t)r.push(e.slice(s,s+t));return r}function bh({actualRowsById:e,supabase:t,showToast:r,getDutyFromRow:s,resolveActualDutyRole:n,openModal:a,closeModal:i,loadScheduleData:o,removeEmployeeTripAndDayOffEntries:l}){function c(u,f){const p=e.get(f);if(!p){r("   .","warning");return}const y=s(p);u.querySelector("#schedule-actual-edit-title").textContent="   ",u.querySelector("#schedule-actual-edit-id").value=p.id,u.querySelector("#schedule-actual-edit-duty-id").value=p.duty_id||(y==null?void 0:y.id)||"",u.querySelector("#schedule-actual-edit-date-value").value=p.date||"",u.querySelector("#schedule-actual-edit-date").value=p.date||"",u.querySelector("#schedule-actual-edit-duty").value=(y==null?void 0:y.name)||"",u.querySelector("#schedule-actual-edit-employee").value=p.employee_id||"",u.querySelector("#schedule-actual-edit-assignment-role").value=n(p),u.querySelector("#schedule-actual-edit-save").textContent="",a(u.querySelector("#schedule-actual-edit-modal"))}function d(u,{dutyId:f,date:p,dutyName:y}){u.querySelector("#schedule-actual-edit-title").textContent="  ",u.querySelector("#schedule-actual-edit-id").value="",u.querySelector("#schedule-actual-edit-duty-id").value=f,u.querySelector("#schedule-actual-edit-date-value").value=p,u.querySelector("#schedule-actual-edit-date").value=p,u.querySelector("#schedule-actual-edit-duty").value=y||"",u.querySelector("#schedule-actual-edit-employee").value="",u.querySelector("#schedule-actual-edit-assignment-role").value="conductor",u.querySelector("#schedule-actual-edit-save").textContent="",a(u.querySelector("#schedule-actual-edit-modal"))}async function h(u){const f=u.querySelector("#schedule-actual-edit-id"),p=u.querySelector("#schedule-actual-edit-duty-id"),y=u.querySelector("#schedule-actual-edit-date-value"),_=u.querySelector("#schedule-actual-edit-employee"),g=u.querySelector("#schedule-actual-edit-assignment-role"),v=u.querySelector("#schedule-actual-edit-save"),m=(f==null?void 0:f.value)||"",w=(p==null?void 0:p.value)||"",k=(y==null?void 0:y.value)||"",E=(_==null?void 0:_.value)||"",q=(g==null?void 0:g.value)||"conductor";if(!E){r(" .","warning");return}if(!m&&(!w||!k)){r("      .","warning");return}if(!["chief","conductor"].includes(q)){r(" .     .","warning");return}const L=v.innerHTML;v.disabled=!0,v.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let T,A=m;if(m)({error:T}=await t.from("actual_duties").update({employee_id:E,assignment_role:q}).eq("id",m));else{const{data:C,error:O}=await t.from("actual_duties").insert({date:k,duty_id:w,employee_id:E,assignment_role:q}).select("id").single();T=O,A=(C==null?void 0:C.id)||""}if(v.disabled=!1,v.innerHTML=L,T){if(T.code==="23505"){r("       .","warning");return}r(T.message,"error");return}const x=await l(E,k,w,A);if(x){r(x.message,"error");return}i(u.querySelector("#schedule-actual-edit-modal")),r(m?"   .":"   .","success"),await o(u)}return{openEditActualDutyModal:c,openCreateActualDutyModal:d,saveEditedActualDuty:h}}let qe=null;function vh({actualRowsById:e,supabase:t,showToast:r,resolveActualDutyRole:s,getDutyFromRow:n,getDutyTypeName:a,loadScheduleData:i,removeEmployeeTripAndDayOffEntries:o}){function l(f){const p=String(f||"").toLowerCase();return p.includes(" ")?"train":p.includes("")?"business-trip":p.includes(" ")?"day-off":""}function c(f){f.querySelectorAll(".schedule-drop-target, .schedule-drop-target-business-trip, .schedule-drop-target-preferred, .schedule-drop-target-hover").forEach(p=>{p.classList.remove("schedule-drop-target","schedule-drop-target-business-trip","schedule-drop-target-preferred","schedule-drop-target-hover")}),qe=null}function d(f,p){if(c(f),!p)return;const y=e.get(p),_=n(y),g=l(a(_));f.querySelectorAll("td[data-drop-duty-id]").forEach(v=>{const m=l(v.getAttribute("data-drop-duty-type")||"");v.classList.add("schedule-drop-target"),m==="business-trip"&&v.classList.add("schedule-drop-target-business-trip"),g&&m===g&&v.classList.add("schedule-drop-target-preferred")})}function h(f){const p=f.target.closest("td[data-drop-duty-id]");if(!p){qe&&(qe.classList.remove("schedule-drop-target-hover"),qe=null);return}f.preventDefault(),qe&&qe!==p&&qe.classList.remove("schedule-drop-target-hover"),qe=p,qe.classList.add("schedule-drop-target-hover"),f.dataTransfer&&(f.dataTransfer.dropEffect="move")}async function u(f,p,y,_,g){const v=e.get(p);if(!v)return;const m=v.duty_id===y,w=v.date===_,k=g==="chief"||g==="conductor"?g:"",E=s(v);if(m&&w&&(!k||E===k))return;const L={duty_id:y,date:_};k&&(L.assignment_role=k);const{error:T}=await t.from("actual_duties").update(L).eq("id",p);if(T){if(T.code==="23505"){r("       .","warning");return}r(T.message,"error");return}const A=await o(v.employee_id,_,y,p);if(A){r(A.message,"error");return}await i(f),r("   .","success")}return{applyDropTargetHighlights:d,clearDropTargetHighlights:c,handleDragOver:h,moveDraggedActualDuty:u}}const je=new Map;let lt="";async function _h(e){const t=await se("../schedule.html",import.meta.url);e.innerHTML=t,Ti(e,"#schedule-print-left-label");const r=e.querySelector("#schedule-date"),s=e.querySelector("#schedule-go-to-actual"),n=e.querySelector("#schedule-print"),a=e.querySelector("#schedule-print-orientation"),i=e.querySelector("#schedule-print-compact"),o=e.querySelector("#schedule-print-fit-one-page"),l=oh();r&&l?r.value=l:r&&!r.value&&(r.value=new Date().toISOString().split("T")[0]),wh(e),await Sh(e),r==null||r.addEventListener("change",async()=>{await Kr(e)}),s==null||s.addEventListener("click",()=>{const c=(r==null?void 0:r.value)||"";if(!c){b(" ,     .","warning");return}const d=new URLSearchParams({date:c});window.history.pushState({},"",`/actual-duties?${d.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}),n==null||n.addEventListener("click",()=>{const c=(a==null?void 0:a.value)==="portrait"?"portrait":"landscape",d=(i==null?void 0:i.checked)??!0,h=(o==null?void 0:o.checked)??!0;dh(e,{orientation:c,compact:d,fitOnePage:h}),window.addEventListener("afterprint",uh,{once:!0}),window.print()}),await Kr(e)}function wh(e){const t=e.querySelector("#schedule-actual-edit-modal"),r=e.querySelector("#schedule-actual-edit-modal-close"),s=e.querySelector("#schedule-actual-edit-cancel"),n=e.querySelector("#schedule-actual-edit-form"),a=bh({actualRowsById:je,supabase:S,showToast:b,getDutyFromRow:Hs,resolveActualDutyRole:Ns,openModal:lh,closeModal:Mr,loadScheduleData:Kr,removeEmployeeTripAndDayOffEntries:Ta}),i=vh({actualRowsById:je,supabase:S,showToast:b,resolveActualDutyRole:Ns,getDutyFromRow:Hs,getDutyTypeName:Rt,loadScheduleData:Kr,removeEmployeeTripAndDayOffEntries:Ta});r==null||r.addEventListener("click",()=>Mr(t)),s==null||s.addEventListener("click",()=>Mr(t)),n==null||n.addEventListener("submit",async o=>{o.preventDefault(),await a.saveEditedActualDuty(e)}),e.addEventListener("click",o=>{const l=o.target.closest("button[data-actual-edit-id]");if(l){const f=l.getAttribute("data-actual-edit-id")||"";if(!f)return;a.openEditActualDutyModal(e,f);return}const c=o.target.closest("button[data-actual-add-duty-id]");if(!c)return;const d=c.getAttribute("data-actual-add-duty-id")||"",h=c.getAttribute("data-actual-add-date")||"",u=c.getAttribute("data-actual-add-duty-name")||"";!d||!h||a.openCreateActualDutyModal(e,{dutyId:d,date:h,dutyName:u})}),e.addEventListener("dragstart",o=>{const l=o.target.closest("button[data-actual-drag-id]");l&&(lt=l.getAttribute("data-actual-drag-id")||"",lt&&(Wt(!0),l.classList.add("opacity-50"),o.dataTransfer&&(o.dataTransfer.effectAllowed="move",o.dataTransfer.setData("text/plain",lt)),i.applyDropTargetHighlights(e,lt)))}),e.addEventListener("dragend",o=>{const l=o.target.closest("button[data-actual-drag-id]");l==null||l.classList.remove("opacity-50"),i.clearDropTargetHighlights(e),lt="",Wt(!1)}),e.addEventListener("dragover",o=>{i.handleDragOver(o)}),e.addEventListener("drop",async o=>{var p;const l=o.target.closest("td[data-drop-duty-id]");if(!l){i.clearDropTargetHighlights(e),Wt(!1);return}o.preventDefault();const c=l.getAttribute("data-drop-duty-id")||"",d=l.getAttribute("data-drop-date")||"",h=l.getAttribute("data-drop-role")||"",f=((p=o.dataTransfer)==null?void 0:p.getData("text/plain"))||""||lt;if(!c||!d||!f){i.clearDropTargetHighlights(e),Wt(!1);return}i.clearDropTargetHighlights(e),await i.moveDraggedActualDuty(e,f,c,d,h),Wt(!1)}),ch("schedule",[t])}async function Sh(e){const t=e.querySelector("#schedule-actual-edit-employee"),{data:r,error:s}=await S.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(s){b(s.message,"error");return}const n=(r||[]).map(a=>{const i=`${a.first_name??""} ${a.last_name??""}`.trim()||"-";return`<option value="${a.id}">${oe(i)}</option>`}).join("");t&&(t.innerHTML='<option value=""> </option>'+n)}async function Kr(e){const t=e.querySelector("#schedule-date"),r=t==null?void 0:t.value,s=e.querySelector("#schedule-sheet-date");if(s&&(s.textContent=r?fh(r):""),!r){je.clear(),Bt(e,{train:[],businessTrip:[],dayOff:[]},new Map),Kt(e,{hint:" .",error:"",empty:""});return}const{data:n,error:a}=await S.from("actual_duties").select("id, date, duty_id, employee_id, assignment_role, employees(first_name, last_name, positions(title)), duties(id, name, schedule_key_id, display_order, start_time, end_time, second_day, duty_types(name))").eq("date",r);if(a){b(a.message,"error"),je.clear(),Bt(e,{train:[],businessTrip:[],dayOff:[]},new Map),Kt(e,{hint:"",error:"     .",empty:""});return}const{data:i,error:o}=await S.from("employee_absences").select("employee_id").lte("start_date",r).gte("end_date",r);if(o){b(o.message,"error"),je.clear(),Bt(e,{train:[],businessTrip:[],dayOff:[]},new Map),Kt(e,{hint:"",error:"    .",empty:""});return}const{data:l,error:c}=await qi(r);if(c){b(c.message,"error"),je.clear(),Bt(e,{train:[],businessTrip:[],dayOff:[]},new Map),Kt(e,{hint:"",error:"    .",empty:""});return}const d=new Set((i||[]).map(p=>p==null?void 0:p.employee_id).filter(Boolean));je.clear(),(n||[]).forEach(p=>{p!=null&&p.id&&je.set(p.id,p)});const h={train:[],businessTrip:[],dayOff:[]};(l||[]).forEach(p=>{const y=Rt(p).toLowerCase();if(y.includes(" ")){h.train.push(p);return}if(y.includes("")){h.businessTrip.push(p);return}y.includes(" ")&&h.dayOff.push(p)}),h.train.sort(ph),h.businessTrip.sort(Us),h.dayOff.sort(Us);const u=hh(n||[],d);Bt(e,h,u,r);const f=h.train.length+h.businessTrip.length+h.dayOff.length;Kt(e,{hint:"",error:"",empty:f?"":"      ."})}async function Ta(e,t,r,s){if(!e||!t||!r)return null;const{data:n,error:a}=await S.from("duties").select("id, duty_types(name)").eq("id",r).single();if(a)return a;if(!Rt(n).toLowerCase().includes(" "))return null;const{data:o,error:l}=await S.from("duties").select("id, duty_types(name)");if(l)return l;const c=(o||[]).filter(u=>{const f=Rt(u).toLowerCase();return f.includes("")||f.includes(" ")}).map(u=>u.id).filter(Boolean);if(!c.length)return null;let d=S.from("actual_duties").delete().eq("employee_id",e).eq("date",t).in("duty_id",c);s&&(d=d.neq("id",s));const{error:h}=await d;return h}function Wt(e){document.body.classList.toggle("schedule-dragging",!!e)}function ws(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const qa=new Map;function kh(e,t){const r=qa.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){qt(a);return}}};qa.set(e,s),document.addEventListener("keydown",s)}function qt(e){var t,r;e.classList.add("d-none"),(t=document.querySelector("#duty-type-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#duty-type-delete-modal"))!=null&&r.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function La(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const Lt={rows:[],searchQuery:""};async function fn(e){const{data:t,error:r}=await S.from("duty_types").select("id, name").order("name",{ascending:!0});if(r){b(r.message,"error"),Lt.rows=[],Fs(e,"     .");return}Lt.rows=t||[],Fs(e)}function Fs(e,t){const r=e.querySelector("#duty-types-table-body"),s=e.querySelector("#duty-types-empty"),n=Lt.rows.filter(a=>Lt.searchQuery?(a.name||"").toLowerCase().includes(Lt.searchQuery):!0);if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"   .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>`
        <tr>
          <td>${La(a.name??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-name="${La(a.name??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `).join("")}async function Eh(e){const t=await se("../duty-types.html",import.meta.url);e.innerHTML=t,Th(e),await fn(e)}function Th(e){const t=e.querySelector("#open-create-duty-type"),r=e.querySelector("#duty-type-form"),s=e.querySelector("#duty-type-cancel-btn"),n=e.querySelector("#duty-types-table-body"),a=e.querySelector("#duty-type-modal"),i=e.querySelector("#duty-type-delete-modal"),o=e.querySelector("#duty-type-modal-close"),l=e.querySelector("#duty-type-delete-confirm"),c=e.querySelector("#duty-type-delete-cancel"),d=e.querySelector("#duty-types-search");t==null||t.addEventListener("click",()=>{pn(e),ws(a)}),r==null||r.addEventListener("submit",async h=>{h.preventDefault(),await qh(e)}),s==null||s.addEventListener("click",()=>{qt(a)}),o==null||o.addEventListener("click",()=>{qt(a)}),c==null||c.addEventListener("click",()=>{qt(i)}),d==null||d.addEventListener("input",h=>{Lt.searchQuery=h.target.value.trim().toLowerCase(),Fs(e)}),kh("duty-types",[i,a]),l==null||l.addEventListener("click",async()=>{const h=e.querySelector("#duty-type-delete-id").value;await $h(h,e)}),n==null||n.addEventListener("click",h=>{const u=h.target.closest("button[data-action]");if(!u)return;const f=u.getAttribute("data-action");if(f==="edit"){Lh(e,{id:u.getAttribute("data-id"),name:u.getAttribute("data-name")}),ws(a);return}if(f==="delete"){const p=u.getAttribute("data-id");e.querySelector("#duty-type-delete-id").value=p,ws(i)}})}async function qh(e){var l;const t=e.querySelector("#duty-type-id"),r=e.querySelector("#duty-type-name"),s=e.querySelector("#duty-type-save-btn"),n=r.value.trim(),a=t.value;if(!n){b(",  .","warning");return}const i=s.innerHTML;s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let o;if(a)({error:o}=await S.from("duty_types").update({name:n}).eq("id",a));else{const{data:c}=await S.auth.getUser(),d=((l=c==null?void 0:c.user)==null?void 0:l.email)??"web_app";({error:o}=await S.from("duty_types").insert({name:n,created_from:d}))}if(s.disabled=!1,s.innerHTML=i,o){if(o.code==="23505"){b("   .","warning");return}b(o.message,"error");return}b(a?"  .":"  .","success"),qt(e.querySelector("#duty-type-modal")),pn(e),await fn(e)}function Lh(e,t){e.querySelector("#duty-type-id").value=t.id,e.querySelector("#duty-type-name").value=t.name??"",e.querySelector("#duty-type-form-title").textContent="  ",e.querySelector("#duty-type-save-btn").textContent=""}function pn(e){e.querySelector("#duty-type-id").value="",e.querySelector("#duty-type-name").value="",e.querySelector("#duty-type-form-title").textContent=" ",e.querySelector("#duty-type-save-btn").textContent=""}async function $h(e,t){const r=t.querySelector("#duty-type-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{count:n,error:a}=await S.from("duties").select("id",{count:"exact",head:!0}).eq("duty_type_id",e);if(a){r.disabled=!1,r.innerHTML=s,b(a.message,"error");return}if((n||0)>0){r.disabled=!1,r.innerHTML=s,b("     ,     .","warning");return}const{error:i}=await S.from("duty_types").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,i){if(i.code==="23503"){b("     ,     .","warning");return}b(i.message,"error");return}b("  .","success"),qt(t.querySelector("#duty-type-delete-modal")),pn(t),await fn(t)}function ke(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function $a(e){return e?typeof e=="string"?e.replace(".000000",""):String(e):"-"}function Ah(){return new URLSearchParams(window.location.search).get("scheduleKeyId")||""}function xh(){return new URLSearchParams(window.location.search).get("scheduleKeyName")||""}function ir(e){e==null||e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const Aa=new Map;function Rh(e,t){const r=Aa.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){ye(a);return}}};Aa.set(e,s),document.addEventListener("keydown",s)}function ye(e){var a,i,o,l;e==null||e.classList.add("d-none");const t=(a=document.querySelector("#schedule-key-duty-create-modal"))==null?void 0:a.classList.contains("d-none"),r=(i=document.querySelector("#schedule-key-duty-edit-modal"))==null?void 0:i.classList.contains("d-none"),s=(o=document.querySelector("#schedule-key-duty-delete-modal"))==null?void 0:o.classList.contains("d-none"),n=(l=document.querySelector("#schedule-key-duty-profile-modal"))==null?void 0:l.classList.contains("d-none");t&&r&&s&&n&&document.body.classList.remove("overflow-hidden")}const B={scheduleKeyId:"",scheduleKeyName:"",duties:[],draggedDutyId:null,lastCreatedDutyTypeId:"",lastCreatedScheduleKeyIds:[]},xa="id, name, notes, duty_type_id, schedule_key_id, start_time, end_time, second_day, break_start_time, break_end_time, break_duration_interval, duration_interval, display_order, duty_types(name), schedule_key_duties(schedule_key_id, schedule_keys(name)), duty_trains(train_id, sequence_order, trains(number))";async function fr(e){const t=B.scheduleKeyId,{data:r,error:s}=await S.from("duties").select(xa).eq("schedule_key_id",t).order("display_order",{ascending:!0}).order("name",{ascending:!0});if(s){B.duties=[],bt(e,"    ."),b(s.message,"error");return}const{data:n,error:a}=await S.from("schedule_key_duties").select("duty_id").eq("schedule_key_id",t);if(a){B.duties=[],bt(e,"    ."),b(a.message,"error");return}const i=r||[],o=new Set(i.map(d=>d==null?void 0:d.id).filter(Boolean)),l=[...new Set((n||[]).map(d=>d==null?void 0:d.duty_id).filter(Boolean))].filter(d=>!o.has(d));let c=[];if(l.length){const{data:d,error:h}=await S.from("duties").select(xa).in("id",l);if(h){B.duties=[],bt(e,"    ."),b(h.message,"error");return}c=d||[]}B.duties=[...i,...c].sort((d,h)=>{const u=Number.isFinite(Number(d==null?void 0:d.display_order))?Number(d.display_order):Number.MAX_SAFE_INTEGER,f=Number.isFinite(Number(h==null?void 0:h.display_order))?Number(h.display_order):Number.MAX_SAFE_INTEGER;return u!==f?u-f:String((d==null?void 0:d.name)||"").localeCompare(String((h==null?void 0:h.name)||""),"bg")}),bt(e)}function bt(e,t){const r=e.querySelector("#schedule-key-duties-body"),s=e.querySelector("#schedule-key-duties-empty");if(!B.duties.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"    -.";return}s.classList.add("d-none"),r.innerHTML=B.duties.map(n=>{const a=Ch(n),i=Oh(n),o=`<span class="badge text-bg-info" title="${ke(i.join(", "))}">${a.length} -</span>`;return`
        <tr data-duty-id="${n.id}" draggable="true">
          <td class="text-secondary"></td>
          <td>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              ${o}
              <span>${ke(n.name??"-")}</span>           
            </div>
          </td>
          <td>${ke(n.start_time??"-")}</td>
          <td>${ke(n.end_time??"-")}</td>
          <td>${n.second_day?"":""}</td>
          <td>${ke($a(n.break_duration_interval))}</td>
          <td>${ke($a(n.duration_interval))}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-duty-action="profile"
                data-id="${n.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-duty-action="edit"
                data-id="${n.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-duty-action="delete"
                data-id="${n.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}async function Ih(){const e=B.duties.map((s,n)=>S.from("duties").update({display_order:n+1}).eq("id",s.id)),r=(await Promise.all(e)).find(s=>s.error);return r!=null&&r.error?(b(r.error.message,"error"),!1):(B.duties=B.duties.map((s,n)=>({...s,display_order:n+1})),!0)}function Ii(e){return Array.isArray(e.schedule_key_duties)?e.schedule_key_duties:e.schedule_key_duties?[e.schedule_key_duties]:[]}function Ch(e){const t=Ii(e).map(s=>s==null?void 0:s.schedule_key_id).filter(Boolean),r=t.length?t:e.schedule_key_id?[e.schedule_key_id]:[];return[...new Set(r)]}function Oh(e){const t=Ii(e).map(r=>{var s;return(s=r==null?void 0:r.schedule_keys)==null?void 0:s.name}).filter(Boolean);return[...new Set(t)]}async function Ph(e){const t=await se("../schedule-key-duties.html",import.meta.url);e.innerHTML=t,Dh(e),Mh(e),await Nh(e),await Hh(e),await Uh(e),await jh(e)}function Dh(e){const t=e.querySelector("#schedule-key-duty-create-form-fields");t&&(t.innerHTML=Ds({idPrefix:"schedule-key-duty-create"}));const r=e.querySelector("#schedule-key-duty-edit-form-fields");r&&(r.innerHTML=Ds({idPrefix:"schedule-key-duty-edit"}))}function Mh(e){const t=e.querySelector("#open-create-schedule-key-duty"),r=e.querySelector("#schedule-key-duty-create-modal"),s=e.querySelector("#schedule-key-duty-create-form"),n=e.querySelector("#schedule-key-duty-create-modal-close"),a=e.querySelector("#schedule-key-duty-create-cancel"),i=e.querySelector("#schedule-key-duties-body"),o=e.querySelector("#schedule-key-duty-edit-modal"),l=e.querySelector("#schedule-key-duty-delete-modal"),c=e.querySelector("#schedule-key-duty-edit-form"),d=e.querySelector("#schedule-key-duty-edit-modal-close"),h=e.querySelector("#schedule-key-duty-edit-cancel"),u=e.querySelector("#schedule-key-duty-delete-cancel"),f=e.querySelector("#schedule-key-duty-delete-confirm"),p=e.querySelector("#schedule-key-duty-profile-modal"),y=e.querySelector("#schedule-key-duty-profile-close"),_=e.querySelector("#schedule-key-duty-profile-close-secondary"),g=e.querySelector("#schedule-key-duty-profile-edit");t==null||t.addEventListener("click",()=>{yn(e),ir(r)}),n==null||n.addEventListener("click",()=>{ye(r)}),a==null||a.addEventListener("click",()=>{ye(r)}),s==null||s.addEventListener("submit",async v=>{v.preventDefault(),await Fh(e)}),c==null||c.addEventListener("submit",async v=>{v.preventDefault(),await Bh(e)}),d==null||d.addEventListener("click",()=>{ye(o)}),h==null||h.addEventListener("click",()=>{ye(o)}),u==null||u.addEventListener("click",()=>{ye(l)}),f==null||f.addEventListener("click",async()=>{const v=e.querySelector("#schedule-key-duty-delete-id").value;await Yh(e,v)}),y==null||y.addEventListener("click",()=>{ye(p)}),_==null||_.addEventListener("click",()=>{ye(p)}),g==null||g.addEventListener("click",()=>{var m;const v=((m=p==null?void 0:p.dataset)==null?void 0:m.dutyId)||"";v&&(ye(p),Ra(e,v))}),Rh("schedule-key-duties",[p,l,o,r]),i==null||i.addEventListener("dragstart",v=>{const m=v.target.closest("tr[data-duty-id]");m&&(B.draggedDutyId=m.getAttribute("data-duty-id"),m.classList.add("table-active"))}),i==null||i.addEventListener("dragend",v=>{const m=v.target.closest("tr[data-duty-id]");m&&m.classList.remove("table-active"),B.draggedDutyId=null}),i==null||i.addEventListener("dragover",v=>{v.preventDefault()}),i==null||i.addEventListener("drop",async v=>{v.preventDefault();const m=v.target.closest("tr[data-duty-id]"),w=B.draggedDutyId;if(!m||!w)return;const k=m.getAttribute("data-duty-id");if(!k||k===w)return;const E=B.duties.findIndex(A=>A.id===w),q=B.duties.findIndex(A=>A.id===k);if(E<0||q<0)return;const[L]=B.duties.splice(E,1);if(B.duties.splice(q,0,L),bt(e),!await Ih()){await fr(e);return}b("    .","success")}),i==null||i.addEventListener("click",async v=>{const m=v.target.closest("button[data-duty-action]");if(!m)return;const w=m.getAttribute("data-duty-action");if(w==="profile"){const k=m.getAttribute("data-id");Kh(e,k);return}if(w==="edit"){const k=m.getAttribute("data-id");Ra(e,k);return}if(w==="delete"){const k=m.getAttribute("data-id");Qh(e,k)}})}async function jh(e){if(B.scheduleKeyId=Ah(),B.scheduleKeyName=xh(),!B.scheduleKeyId){bt(e,"  -.     ."),e.querySelector("#open-create-schedule-key-duty").classList.add("d-none");return}if(!B.scheduleKeyName){const{data:t,error:r}=await S.from("schedule_keys").select("name").eq("id",B.scheduleKeyId).single();r&&b(r.message,"error"),B.scheduleKeyName=(t==null?void 0:t.name)||B.scheduleKeyId}e.querySelector("#schedule-key-duties-title").textContent=B.scheduleKeyName,yn(e),await fr(e)}async function Nh(e){const t=e.querySelector("#schedule-key-duty-create-type"),r=e.querySelector("#schedule-key-duty-edit-type"),{data:s,error:n}=await S.from("duty_types").select("id, name").order("name",{ascending:!0});if(n){b(n.message,"error");return}const a=(s||[]).map(i=>`<option value="${i.id}">${ke(i.name)}</option>`).join("");t.innerHTML='<option value=""> </option>'+a,r.innerHTML='<option value=""> </option>'+a}async function Hh(e){const t=e.querySelector("#schedule-key-duty-create-schedule-keys"),r=e.querySelector("#schedule-key-duty-edit-schedule-keys"),{data:s,error:n}=await S.from("schedule_keys").select("id, name").order("name",{ascending:!0});if(n){b(n.message,"error");return}const a=(s||[]).map(i=>`<option value="${i.id}">${ke(i.name)}</option>`).join("");t.innerHTML=a,r.innerHTML=a}async function Uh(e){const t=e.querySelector("#schedule-key-duty-create-trains"),r=e.querySelector("#schedule-key-duty-edit-trains"),{data:s,error:n}=await S.from("trains").select("id, number, origin_station, destination_station").order("number",{ascending:!0});if(n){b(n.message,"error");return}const a=(s||[]).map(i=>{const o=`${i.origin_station||"-"} - ${i.destination_station||"-"}`;return`<option value="${i.id}">${ke(i.number||"-")} (${ke(o)})</option>`}).join("");t&&(t.innerHTML=a),r&&(r.innerHTML=a)}async function Fh(e){var j;const t=e.querySelector("#schedule-key-duty-create-name"),r=e.querySelector("#schedule-key-duty-create-type"),s=e.querySelector("#schedule-key-duty-create-schedule-keys"),n=e.querySelector("#schedule-key-duty-create-start"),a=e.querySelector("#schedule-key-duty-create-end"),i=e.querySelector("#schedule-key-duty-create-second-day"),o=e.querySelector("#schedule-key-duty-create-break-start"),l=e.querySelector("#schedule-key-duty-create-break-end"),c=e.querySelector("#schedule-key-duty-create-trains"),d=e.querySelector("#schedule-key-duty-create-save"),h=t.value.trim(),u=r.value||null,f=Array.from(s.selectedOptions||[]).map(U=>U.value).filter(Boolean),p=f[0]||null,y=n.value,_=a.value,g=i.checked,v=o.value,m=l.value,w=e.querySelector("#schedule-key-duty-create-notes").value.trim()||null,k=Array.from(c.selectedOptions||[]).map(U=>U.value).filter(Boolean);if(!B.scheduleKeyId||!h||!u||!y||!_){b(",     .","warning");return}if(!f.length){b("   -.","warning");return}const E=At(y,_);if(At(v,m)>E){b("     -    .","warning");return}const L=d.innerHTML;d.disabled=!0,d.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:T}=await S.auth.getUser(),A=((j=T==null?void 0:T.user)==null?void 0:j.email)??"web_app",x=B.duties.reduce((U,W)=>Math.max(U,Number(W.display_order)||0),0),{data:C,error:O}=await S.from("duties").insert({schedule_key_id:p,duty_type_id:u,name:h,start_time:y,end_time:_,second_day:g,break_start_time:v,break_end_time:m,notes:w,created_from:A,display_order:x+1}).select("id").single(),K=O?null:await Ci(C==null?void 0:C.id,f),M=O||K?null:await Oi(C==null?void 0:C.id,k);if(d.disabled=!1,d.innerHTML=L,O||K||M){b((O||K||M).message,"error");return}B.lastCreatedDutyTypeId=u,B.lastCreatedScheduleKeyIds=[...f],ye(e.querySelector("#schedule-key-duty-create-modal")),yn(e),b("    -.","success"),await fr(e)}function Ra(e,t){const r=B.duties.find(o=>o.id===t);if(!r){b("   .","warning");return}e.querySelector("#schedule-key-duty-edit-id").value=r.id,e.querySelector("#schedule-key-duty-edit-name").value=r.name??"",e.querySelector("#schedule-key-duty-edit-type").value=r.duty_type_id??"";const s=e.querySelector("#schedule-key-duty-edit-schedule-keys"),n=zh(r);Array.from(s.options).forEach(o=>{o.selected=n.includes(o.value)});const a=e.querySelector("#schedule-key-duty-edit-trains"),i=Gh(r);Array.from(a.options).forEach(o=>{o.selected=i.includes(o.value)}),e.querySelector("#schedule-key-duty-edit-start").value=(r.start_time||"").slice(0,5),e.querySelector("#schedule-key-duty-edit-end").value=(r.end_time||"").slice(0,5),e.querySelector("#schedule-key-duty-edit-second-day").checked=!!r.second_day,e.querySelector("#schedule-key-duty-edit-break-start").value=$t(r.break_start_time),e.querySelector("#schedule-key-duty-edit-break-end").value=$t(r.break_end_time),e.querySelector("#schedule-key-duty-edit-notes").value=r.notes??"",ir(e.querySelector("#schedule-key-duty-edit-modal"))}function yn(e){var n;e.querySelector("#schedule-key-duty-create-name").value="",e.querySelector("#schedule-key-duty-create-type").value=B.lastCreatedDutyTypeId||"";const t=(n=B.lastCreatedScheduleKeyIds)!=null&&n.length?B.lastCreatedScheduleKeyIds:[B.scheduleKeyId],r=e.querySelector("#schedule-key-duty-create-schedule-keys");Array.from(r.options).forEach(a=>{a.selected=t.includes(a.value)}),e.querySelector("#schedule-key-duty-create-start").value="",e.querySelector("#schedule-key-duty-create-end").value="",e.querySelector("#schedule-key-duty-create-second-day").checked=!1,e.querySelector("#schedule-key-duty-create-break-start").value="00:00",e.querySelector("#schedule-key-duty-create-break-end").value="00:00",e.querySelector("#schedule-key-duty-create-notes").value="";const s=e.querySelector("#schedule-key-duty-create-trains");Array.from(s.options).forEach(a=>{a.selected=!1})}async function Bh(e){const t=e.querySelector("#schedule-key-duty-edit-id").value,r=e.querySelector("#schedule-key-duty-edit-name").value.trim(),s=e.querySelector("#schedule-key-duty-edit-type").value||null,n=Array.from(e.querySelector("#schedule-key-duty-edit-schedule-keys").selectedOptions||[]).map(w=>w.value).filter(Boolean),a=n[0]||null,i=e.querySelector("#schedule-key-duty-edit-start").value,o=e.querySelector("#schedule-key-duty-edit-end").value,l=e.querySelector("#schedule-key-duty-edit-second-day").checked,c=e.querySelector("#schedule-key-duty-edit-break-start").value,d=e.querySelector("#schedule-key-duty-edit-break-end").value,h=e.querySelector("#schedule-key-duty-edit-notes").value.trim()||null,u=Array.from(e.querySelector("#schedule-key-duty-edit-trains").selectedOptions||[]).map(w=>w.value).filter(Boolean),f=e.querySelector("#schedule-key-duty-edit-save");if(!t||!r||!s||!i||!o){b(",     .","warning");return}if(!n.length){b("   -.","warning");return}const p=At(i,o);if(At(c,d)>p){b("     -    .","warning");return}const _=f.innerHTML;f.disabled=!0,f.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:g}=await S.from("duties").update({name:r,duty_type_id:s,schedule_key_id:a,start_time:i,end_time:o,second_day:l,break_start_time:c,break_end_time:d,notes:h}).eq("id",t),v=g?null:await Ci(t,n),m=g||v?null:await Oi(t,u);if(f.disabled=!1,f.innerHTML=_,g||v||m){b((g||v||m).message,"error");return}ye(e.querySelector("#schedule-key-duty-edit-modal")),b("  .","success"),await fr(e)}async function Ci(e,t){if(!e)return{message:"       -."};const{error:r}=await S.from("schedule_key_duties").delete().eq("duty_id",e);if(r)return r;const s=t.map(a=>({duty_id:e,schedule_key_id:a})),{error:n}=await S.from("schedule_key_duties").insert(s);return n}async function Oi(e,t){if(!e)return{message:"       ."};const{error:r}=await S.from("duty_trains").delete().eq("duty_id",e);if(r)return r;if(!t.length)return null;const s=t.map((a,i)=>({duty_id:e,train_id:a,sequence_order:i+1})),{error:n}=await S.from("duty_trains").insert(s);return n}function Kh(e,t){const r=B.duties.find(l=>l.id===t),s=e.querySelector("#schedule-key-duty-profile-content"),n=e.querySelector("#schedule-key-duty-profile-modal"),a=e.querySelector("#schedule-key-duty-profile-edit");if(!s||!n)return;if(!r){n.dataset.dutyId="",a&&(a.disabled=!0),s.innerHTML='<p class="text-secondary mb-0">    .</p>',ir(n);return}n.dataset.dutyId=r.id,a&&(a.disabled=!1);const i=Vh(r),o=Jh(r);s.innerHTML=pi({duty:r,scheduleKeyNames:i,trainNumbers:o,escapeHtml:ke,intervalToTimeInput:$t,formatInterval:Wh}),ir(n)}function Wh(e){return e?String(e).replace(".000000",""):"-"}function Pi(e){return Array.isArray(e==null?void 0:e.schedule_key_duties)?e.schedule_key_duties:e!=null&&e.schedule_key_duties?[e.schedule_key_duties]:[]}function zh(e){const t=Pi(e).map(s=>s==null?void 0:s.schedule_key_id).filter(Boolean),r=t.length?t:e!=null&&e.schedule_key_id?[e.schedule_key_id]:[];return[...new Set(r)]}function Vh(e){const t=Pi(e).map(r=>{var s;return(s=r==null?void 0:r.schedule_keys)==null?void 0:s.name}).filter(Boolean);return[...new Set(t)]}function Di(e){return Array.isArray(e==null?void 0:e.duty_trains)?e.duty_trains:e!=null&&e.duty_trains?[e.duty_trains]:[]}function Gh(e){return Di(e).map(t=>({id:t==null?void 0:t.train_id,sequenceOrder:Number.isFinite(Number(t==null?void 0:t.sequence_order))?Number(t.sequence_order):Number.MAX_SAFE_INTEGER})).filter(t=>!!t.id).sort((t,r)=>t.sequenceOrder-r.sequenceOrder).map(t=>t.id).filter((t,r,s)=>s.indexOf(t)===r)}function Jh(e){return Di(e).map(t=>{var r;return{number:(r=t==null?void 0:t.trains)==null?void 0:r.number,sequenceOrder:Number.isFinite(Number(t==null?void 0:t.sequence_order))?Number(t.sequence_order):Number.MAX_SAFE_INTEGER}}).filter(t=>!!t.number).sort((t,r)=>t.sequenceOrder-r.sequenceOrder).map(t=>t.number).filter((t,r,s)=>s.indexOf(t)===r)}function Qh(e,t){e.querySelector("#schedule-key-duty-delete-id").value=t,ir(e.querySelector("#schedule-key-duty-delete-modal"))}async function Yh(e,t){const r=e.querySelector("#schedule-key-duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await S.from("duties").delete().eq("id",t).eq("schedule_key_id",B.scheduleKeyId);if(r.disabled=!1,r.innerHTML=s,n){b(n.message,"error");return}ye(e.querySelector("#schedule-key-duty-delete-modal")),b("  .","success"),await fr(e)}function jr(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const Ia=new Map;function Xh(e,t){const r=Ia.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){tt(a);return}}};Ia.set(e,s),document.addEventListener("keydown",s)}function tt(e){var t,r,s;e.classList.add("d-none"),(t=document.querySelector("#train-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#train-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#train-timetable-preview-modal"))!=null&&s.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function Z(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Ca(e){const t=String(e||"").trim();if(!t)return"";const r=t.match(/^(\d{1,2}:\d{2})/);return r?r[1]:t.slice(0,5)}const te={rows:[],searchQuery:"",originFilter:"",destinationFilter:""};async function mn(e){const{data:t,error:r}=await S.from("trains").select("id, number, origin_station, destination_station, departure_time, arrival_time, timetable_url").order("number",{ascending:!0});if(r){b(r.message,"error"),te.rows=[],vt(e,"    .");return}te.rows=t||[],vt(e)}function vt(e,t){const r=e.querySelector("#trains-table-body"),s=e.querySelector("#trains-empty");ef(e);const n=te.rows.filter(a=>{const i=`${a.number||""} ${a.origin_station||""} ${a.destination_station||""}`.toLowerCase(),o=String(a.origin_station||"").trim().toLowerCase(),l=String(a.destination_station||"").trim().toLowerCase(),c=!te.searchQuery||i.includes(te.searchQuery),d=!te.originFilter||o===te.originFilter,h=!te.destinationFilter||l===te.destinationFilter;return c&&d&&h});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{const i=Zh(a.timetable_url),o=i.length?`<div class="d-flex flex-column gap-0">${i.map((l,c)=>{const d=l.label||` ${c+1}`,h=encodeURIComponent(l.url),u=encodeURIComponent(d);return`
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <a class="text-decoration-none" href="${Z(l.url)}" target="_blank" rel="noopener noreferrer">${Z(d)}</a>
                <button
                  type="button"
                  class="btn btn-link btn-sm p-0 lh-1 text-decoration-none"
                  data-action="preview-timetable"
                  data-preview-url="${Z(h)}"
                  data-preview-label="${Z(u)}"
                  title=""
                  aria-label=""
                >
                  
                </button>
              </div>
            `}).join("")}</div>`:'<span class="text-secondary">-</span>';return`
        <tr>
          <td>${Z(a.number??"-")}</td>
          <td>${Z(a.origin_station??"-")}</td>
          <td>${Z(a.destination_station??"-")}</td>
          <td>${Z((a.departure_time||"").slice(0,5)||"-")}</td>
          <td>${Z((a.arrival_time||"").slice(0,5)||"-")}</td>
          <td>${o}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-number="${Z(a.number??"")}"
                data-origin-station="${Z(a.origin_station??"")}"
                data-destination-station="${Z(a.destination_station??"")}"
                data-departure-time="${Z(a.departure_time??"")}"
                data-arrival-time="${Z(a.arrival_time??"")}"
                data-timetable-url="${Z(encodeURIComponent(a.timetable_url??""))}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}function Zh(e){if(Array.isArray(e))return e.map((r,s)=>Ss(r,s)).filter(r=>r.url);const t=String(e||"").trim();if(!t)return[];if(t.startsWith("["))try{const r=JSON.parse(t);if(Array.isArray(r))return r.map((s,n)=>Ss(s,n)).filter(s=>s.url)}catch{return[{url:t,label:Bs(t,0)}]}return t.split(`
`).map((r,s)=>Ss(r,s)).filter(r=>r.url)}function ef(e){const t=e.querySelector("#trains-origin-filter"),r=e.querySelector("#trains-destination-filter");if(!t||!r)return;const s=te.originFilter||"",n=te.destinationFilter||"",a=[...new Set(te.rows.map(o=>String((o==null?void 0:o.origin_station)||"").trim()).filter(Boolean))].sort((o,l)=>o.localeCompare(l,"bg")),i=[...new Set(te.rows.map(o=>String((o==null?void 0:o.destination_station)||"").trim()).filter(Boolean))].sort((o,l)=>o.localeCompare(l,"bg"));t.innerHTML=`
    <option value=""></option>
    ${a.map(o=>`<option value="${Z(o.toLowerCase())}">${Z(o)}</option>`).join("")}
  `,r.innerHTML=`
    <option value=""></option>
    ${i.map(o=>`<option value="${Z(o.toLowerCase())}">${Z(o)}</option>`).join("")}
  `,t.value=s,r.value=n}function Ss(e,t){if(e&&typeof e=="object"&&!Array.isArray(e)){const s=String(e.url||"").trim(),n=String(e.label||"").trim()||Bs(s,t);return{url:s,label:n}}const r=String(e||"").trim();return{url:r,label:Bs(r,t)}}function Bs(e,t){const r=String(e||"").trim();if(!r)return` ${t+1}`;try{const n=new URL(r).pathname.split("/").pop()||"",a=decodeURIComponent(n);if(a)return a}catch{}return` ${t+1}`}const or="train-timetables",Wr=5;async function tf(e){const t=await se("../trains.html",import.meta.url);e.innerHTML=t,rf(e),await mn(e)}function rf(e){const t=e.querySelector("#open-create-train"),r=e.querySelector("#train-form"),s=e.querySelector("#train-cancel-btn"),n=e.querySelector("#trains-table-body"),a=e.querySelector("#train-modal"),i=e.querySelector("#train-delete-modal"),o=e.querySelector("#train-timetable-preview-modal"),l=e.querySelector("#train-modal-close"),c=e.querySelector("#train-delete-confirm"),d=e.querySelector("#train-delete-cancel"),h=e.querySelector("#train-timetable-preview-close"),u=e.querySelector("#trains-search"),f=e.querySelector("#trains-origin-filter"),p=e.querySelector("#trains-destination-filter"),y=e.querySelector("#trains-filter-reset"),_=e.querySelector("#train-timetable-url"),g=e.querySelector("#train-timetable-label"),v=e.querySelector("#train-timetable-file"),m=e.querySelector("#train-current-timetable-links");t==null||t.addEventListener("click",()=>{gn(e),jr(a)}),r==null||r.addEventListener("submit",async w=>{w.preventDefault(),await sf(e)}),s==null||s.addEventListener("click",()=>{tt(a)}),l==null||l.addEventListener("click",()=>{tt(a)}),d==null||d.addEventListener("click",()=>{tt(i)}),h==null||h.addEventListener("click",()=>{lf(e)}),u==null||u.addEventListener("input",w=>{te.searchQuery=w.target.value.trim().toLowerCase(),vt(e)}),f==null||f.addEventListener("change",w=>{te.originFilter=w.target.value||"",vt(e)}),p==null||p.addEventListener("change",w=>{te.destinationFilter=w.target.value||"",vt(e)}),y==null||y.addEventListener("click",()=>{te.searchQuery="",te.originFilter="",te.destinationFilter="",u&&(u.value=""),f&&(f.value=""),p&&(p.value=""),vt(e)}),_==null||_.addEventListener("input",()=>{}),g==null||g.addEventListener("input",()=>{}),v==null||v.addEventListener("change",()=>{var w;if((w=v.files)!=null&&w.length&&v.files.length>Wr){b(`    ${Wr}  .`,"warning"),v.value="";return}}),m==null||m.addEventListener("input",w=>{const k=w.target.closest(".train-existing-timetable-label");if(!k)return;const E=Number(k.getAttribute("data-index"));if(!Number.isInteger(E)||E<0)return;const q=e.querySelector("#train-draft-timetable-url"),L=It((q==null?void 0:q.value)||"");L[E]&&(L[E].label=k.value,q&&(q.value=cr(L)||""))}),m==null||m.addEventListener("click",w=>{const k=w.target.closest(".train-existing-timetable-preview");if(k){const A=String(k.getAttribute("data-url")||"").trim(),x=String(k.getAttribute("data-label")||"").trim();Oa(e,A,x);return}const E=w.target.closest(".train-existing-timetable-remove");if(!E)return;const q=Number(E.getAttribute("data-index"));if(!Number.isInteger(q)||q<0)return;const L=e.querySelector("#train-draft-timetable-url"),T=It((L==null?void 0:L.value)||"");T[q]&&(T.splice(q,1),bn(e,T))}),Xh("trains",[o,i,a]),c==null||c.addEventListener("click",async()=>{const w=e.querySelector("#train-delete-id").value;await of(w,e)}),n==null||n.addEventListener("click",w=>{const k=w.target.closest("button[data-action]");if(!k)return;const E=k.getAttribute("data-action");if(E==="edit"){nf(e,{id:k.getAttribute("data-id"),number:k.getAttribute("data-number"),originStation:k.getAttribute("data-origin-station"),destinationStation:k.getAttribute("data-destination-station"),departureTime:k.getAttribute("data-departure-time"),arrivalTime:k.getAttribute("data-arrival-time"),timetableUrl:decodeURIComponent(k.getAttribute("data-timetable-url")||"")}),jr(a);return}if(E==="delete"){const q=k.getAttribute("data-id");e.querySelector("#train-delete-id").value=q,jr(i);return}if(E==="preview-timetable"){const q=decodeURIComponent(k.getAttribute("data-preview-url")||""),L=decodeURIComponent(k.getAttribute("data-preview-label")||"");Oa(e,q,L)}})}async function sf(e){var j;const t=e.querySelector("#train-id"),r=e.querySelector("#train-number"),s=e.querySelector("#train-origin-station"),n=e.querySelector("#train-destination-station"),a=e.querySelector("#train-departure-time"),i=e.querySelector("#train-arrival-time"),o=e.querySelector("#train-timetable-url"),l=e.querySelector("#train-timetable-label"),c=e.querySelector("#train-timetable-file"),d=e.querySelector("#train-existing-timetable-url"),h=e.querySelector("#train-draft-timetable-url"),u=e.querySelector("#train-save-btn"),f=r.value.trim(),p=s.value.trim(),y=n.value.trim(),_=a.value,g=i.value,v=It(d.value),m=It(h.value),w=o.value.trim()||"",k=l.value.trim()||"",E=Array.from((c==null?void 0:c.files)||[]),q=t.value;if(!f||!p||!y||!_||!g){b(",    .","warning");return}if(k&&!w){b("   ,   .","warning");return}const L=u.innerHTML;u.disabled=!0,u.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const T=q||crypto.randomUUID(),A=zr(m),x=[];if(w&&A.push({url:w,label:k||Ct(w,A.length)}),A.length+E.length>Wr){u.disabled=!1,u.innerHTML=L,b(` ${Wr} /   .`,"warning");return}if(E.length){const U=await af(E,T);if(!U){u.disabled=!1,u.innerHTML=L;return}U.forEach(W=>{W!=null&&W.url&&A.push({url:W.url,label:W.label||Ct(W.url,A.length)}),W!=null&&W.objectPath&&x.push(W.objectPath)})}const O=zr(A),K={number:f,origin_station:p,destination_station:y,departure_time:_,arrival_time:g,timetable_url:cr(O)};let M;if(q)({error:M}=await S.from("trains").update(K).eq("id",q));else{const{data:U}=await S.auth.getUser(),W=((j=U==null?void 0:U.user)==null?void 0:j.email)??"web_app";({error:M}=await S.from("trains").insert({...K,id:T,created_from:W}))}if(u.disabled=!1,u.innerHTML=L,M){x.length&&await lr(x),b(M.message,"error");return}if(q){const U=v.map(Fe=>Ks(Fe.url)).filter(Boolean),W=O.map(Fe=>Ks(Fe.url)).filter(Boolean),Ue=new Set(W),yr=U.filter(Fe=>!Ue.has(Fe));yr.length&&await lr(yr)}b(q?"  .":"  .","success"),tt(e.querySelector("#train-modal")),gn(e),await mn(e)}function nf(e,t){const r=It(t.timetableUrl);e.querySelector("#train-id").value=t.id,e.querySelector("#train-existing-timetable-url").value=cr(r)||"",e.querySelector("#train-draft-timetable-url").value=cr(r)||"",e.querySelector("#train-number").value=t.number??"",e.querySelector("#train-origin-station").value=t.originStation??"",e.querySelector("#train-destination-station").value=t.destinationStation??"",e.querySelector("#train-departure-time").value=Ca(t.departureTime),e.querySelector("#train-arrival-time").value=Ca(t.arrivalTime),e.querySelector("#train-timetable-file").value="",e.querySelector("#train-timetable-url").value="",e.querySelector("#train-timetable-label").value="",bn(e,r),e.querySelector("#train-form-title").textContent="  ",e.querySelector("#train-save-btn").textContent=""}function gn(e){e.querySelector("#train-id").value="",e.querySelector("#train-existing-timetable-url").value="",e.querySelector("#train-draft-timetable-url").value="",e.querySelector("#train-number").value="",e.querySelector("#train-origin-station").value="",e.querySelector("#train-destination-station").value="",e.querySelector("#train-departure-time").value="",e.querySelector("#train-arrival-time").value="",e.querySelector("#train-timetable-file").value="",e.querySelector("#train-timetable-url").value="",e.querySelector("#train-timetable-label").value="",bn(e,[]),e.querySelector("#train-form-title").textContent=" ",e.querySelector("#train-save-btn").textContent=""}async function af(e,t){var s;if(!Array.isArray(e)||!e.length||!t)return[];const r=[];for(const n of e){const i=(((s=n.name)==null?void 0:s.split(".").pop())||"pdf").toLowerCase().replace(/[^a-z0-9]/g,"")||"pdf",o=Math.random().toString(36).slice(2,10),l=`${t}/${Date.now()}-${o}.${i}`,{error:c}=await S.storage.from(or).upload(l,n,{upsert:!0,contentType:n.type||void 0});if(c)return r.length&&await lr(r.map(h=>h.objectPath)),b(c.message,"error"),null;const{data:d}=S.storage.from(or).getPublicUrl(l);if(!(d!=null&&d.publicUrl))return await lr([l,...r.map(h=>h.objectPath)]),b("  ,       .","error"),null;r.push({url:d.publicUrl,label:n.name||"",objectPath:l})}return r}function Ks(e){const t=String(e||"").trim();if(!t)return"";if(!/^https?:\/\//i.test(t)){const r=t.replace(/^\/+/,""),s=`${or}/`;return r.startsWith(s)?r.slice(s.length):""}try{const r=new URL(t),s=`/storage/v1/object/public/${or}/`,n=r.pathname.indexOf(s);return n===-1?"":decodeURIComponent(r.pathname.slice(n+s.length))}catch{return""}}async function lr(e){const t=Array.from(new Set((e||[]).filter(Boolean)));t.length&&await S.storage.from(or).remove(t)}async function of(e,t){const r=t.querySelector("#train-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{count:n,error:a}=await S.from("duty_trains").select("duty_id",{count:"exact",head:!0}).eq("train_id",e);if(a){r.disabled=!1,r.innerHTML=s,b(a.message,"error");return}if((n||0)>0){r.disabled=!1,r.innerHTML=s,b("     ,     .","warning");return}const{data:i,error:o}=await S.from("trains").select("timetable_url").eq("id",e).maybeSingle();if(o){r.disabled=!1,r.innerHTML=s,b(o.message,"error");return}const{error:l}=await S.from("trains").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,l){if(l.code==="23503"){b("     ,     .","warning");return}b(l.message,"error");return}const d=It(i==null?void 0:i.timetable_url).map(h=>Ks(h.url)).filter(Boolean);d.length&&await lr(d),b("  .","success"),tt(t.querySelector("#train-delete-modal")),gn(t),await mn(t)}function bn(e,t){const r=e.querySelector("#train-current-timetable-wrap"),s=e.querySelector("#train-current-timetable-links"),n=e.querySelector("#train-draft-timetable-url");if(!r||!s||!n)return;const a=zr(t);if(n.value=cr(a)||"",!a.length){r.classList.add("d-none"),s.innerHTML="";return}r.classList.remove("d-none"),s.innerHTML=a.map((i,o)=>{const l=i.label||Ct(i.url,o);return`
        <div class="border rounded p-2 w-100">
          <div class="mb-2 d-flex align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <a href="${_t(i.url)}" target="_blank" rel="noopener noreferrer"></a>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary py-0 px-2 train-existing-timetable-preview"
                data-url="${_t(i.url)}"
                data-label="${_t(l)}"
              >
                
              </button>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger train-existing-timetable-remove"
              data-index="${o}"
            >
              
            </button>
          </div>
          <input
            type="text"
            class="form-control form-control-sm train-existing-timetable-label"
            data-index="${o}"
            value="${_t(l)}"
            placeholder="  /"
          />
        </div>
      `}).join("")}function It(e){if(Array.isArray(e))return e.map((r,s)=>Nr(r,s)).filter(r=>r.url);const t=String(e||"").trim();if(!t)return[];if(t.startsWith("["))try{const r=JSON.parse(t);if(Array.isArray(r))return r.map((s,n)=>Nr(s,n)).filter(s=>s.url)}catch{return[{url:t,label:Ct(t,0)}]}return t.split(`
`).map((r,s)=>Nr(r,s)).filter(r=>r.url)}function Nr(e,t){if(e&&typeof e=="object"&&!Array.isArray(e)){const s=String(e.url||"").trim(),n=String(e.label||"").trim()||Ct(s,t);return{url:s,label:n}}const r=String(e||"").trim();return{url:r,label:Ct(r,t)}}function zr(e){const t=new Set;return(e||[]).map((r,s)=>Nr(r,s)).filter(r=>!r.url||t.has(r.url)?!1:(t.add(r.url),!0))}function cr(e){const t=zr(e);return t.length?JSON.stringify(t):null}function Ct(e,t){const r=String(e||"").trim();if(!r)return` ${t+1}`;try{const n=new URL(r).pathname.split("/").pop()||"",a=decodeURIComponent(n);if(a)return a}catch{}return` ${t+1}`}function _t(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Oa(e,t,r){const s=e.querySelector("#train-timetable-preview-modal"),n=e.querySelector("#train-timetable-preview-frame"),a=e.querySelector("#train-timetable-preview-text-wrap"),i=e.querySelector("#train-timetable-preview-text"),o=e.querySelector("#train-timetable-preview-csv-wrap"),l=e.querySelector("#train-timetable-preview-csv-note"),c=e.querySelector("#train-timetable-preview-csv-head"),d=e.querySelector("#train-timetable-preview-csv-body"),h=e.querySelector("#train-timetable-preview-title"),u=e.querySelector("#train-timetable-preview-fallback"),f=e.querySelector("#train-timetable-preview-open");if(!s||!n||!a||!i||!o||!l||!c||!d||!h||!u||!f)return;const p=String(t||"").trim();if(!p){b("   .","warning");return}const y=hf(p),_=Ws(p),g=_==="csv",v=["txt","csv","json"].includes(_);h.textContent=r?`: ${r}`:"  ",f.setAttribute("href",p),u.classList.add("d-none"),a.classList.add("d-none"),o.classList.add("d-none"),l.textContent="",c.innerHTML="",d.innerHTML="",i.textContent="",n.classList.remove("d-none"),n.src="about:blank",g?(o.classList.remove("d-none"),n.classList.add("d-none"),cf(p,c,d,l,u)):v?(a.classList.remove("d-none"),n.classList.add("d-none"),i.textContent="...",uf(p,i,u)):(n.src=y,n.onload=()=>{if(y!==p){u.classList.add("d-none");return}const m=Ws(p),w=["doc","docx","xls","xlsx","ppt","pptx"].includes(m);u.classList.toggle("d-none",!w)},n.onerror=()=>{u.classList.remove("d-none")}),jr(s)}function lf(e){const t=e.querySelector("#train-timetable-preview-modal"),r=e.querySelector("#train-timetable-preview-frame"),s=e.querySelector("#train-timetable-preview-text-wrap"),n=e.querySelector("#train-timetable-preview-text"),a=e.querySelector("#train-timetable-preview-csv-wrap"),i=e.querySelector("#train-timetable-preview-csv-note"),o=e.querySelector("#train-timetable-preview-csv-head"),l=e.querySelector("#train-timetable-preview-csv-body"),c=e.querySelector("#train-timetable-preview-fallback"),d=e.querySelector("#train-timetable-preview-open");!t||!r||!s||!n||!a||!i||!o||!l||!c||!d||(r.src="about:blank",r.classList.remove("d-none"),s.classList.add("d-none"),a.classList.add("d-none"),n.textContent="",i.textContent="",o.innerHTML="",l.innerHTML="",d.setAttribute("href","#"),c.classList.add("d-none"),tt(t))}async function cf(e,t,r,s,n){try{const a=await fetch(e,{cache:"no-store"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const i=await a.text(),o=df(i);if(!o.length){t.innerHTML="",r.innerHTML="",s.textContent="  .",n.classList.add("d-none");return}const l=200,c=o.slice(0,l),d=c[0]||[],h=c.slice(1);t.innerHTML=`
      <tr>${d.map(u=>`<th>${_t(u)}</th>`).join("")}</tr>
    `,r.innerHTML=h.map(u=>`<tr>${u.map(f=>`<td>${_t(f)}</td>`).join("")}</tr>`).join(""),o.length>l?s.textContent=`   ${l}    ${o.length}.`:s.textContent=`: ${o.length}.`,n.classList.add("d-none")}catch{t.innerHTML="",r.innerHTML="",s.textContent="",n.classList.remove("d-none")}}function df(e){const t=[];let r=[],s="",n=!1;for(let a=0;a<e.length;a+=1){const i=e[a],o=e[a+1];if(i==='"'){n&&o==='"'?(s+='"',a+=1):n=!n;continue}if(!n&&i===","){r.push(s),s="";continue}if(!n&&(i===`
`||i==="\r")){i==="\r"&&o===`
`&&(a+=1),r.push(s),t.push(r),r=[],s="";continue}s+=i}return(s.length||r.length)&&(r.push(s),t.push(r)),t}async function uf(e,t,r){try{const s=await fetch(e,{cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);const n=await s.text();t.textContent=n||"( )",r.classList.add("d-none")}catch{t.textContent="    .",r.classList.remove("d-none")}}function hf(e){const t=Ws(e);return["doc","docx","xls","xlsx","ppt","pptx"].includes(t)?`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(e)}`:e}function Ws(e){const t=String(e||"").trim();if(!t)return"";try{const s=new URL(t).pathname.split("/").pop()||"",n=s.includes(".")?s.split(".").pop():"";return String(n||"").toLowerCase()}catch{return""}}const P={profiles:[],employees:[],roleCatalog:[],availableRoles:[],roles:[],permissionsRole:"admin",permissions:[]},ff={admin:"",crew_manager:" ",head_of_transport:" ",crew_instructor:" ",instructor:"",crew:"",crew_member:" ",user:""};function ce(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}function Mi(e){const t=String((e==null?void 0:e.username)||"").trim(),r=String((e==null?void 0:e.id)||"").trim();return t&&r?`${t} (${r})`:t||r||"-"}function ji(e){const t=String((e==null?void 0:e.first_name)||"").trim(),r=String((e==null?void 0:e.last_name)||"").trim(),s=`${t} ${r}`.trim();return s?(e==null?void 0:e.is_active)===!1?`${s} ()`:s:"-"}function Vr(e){const t=String(e||"").trim().toLowerCase();return t?ff[t]||e:"-"}const Ni=[{value:"none",label:" "},{value:"all",label:""},{value:"own",label:""},{value:"role_attached_employees",label:"    "}],pf=[{value:"none",label:""},{value:"all",label:""}];function zs(e){const t=e.querySelector("#admin-role-profile-id"),r=e.querySelector("#admin-profile-link-id"),s=e.querySelector("#admin-profile-link-employee-id"),n=(t==null?void 0:t.value)||"",a=(r==null?void 0:r.value)||"",i=(s==null?void 0:s.value)||"",o=P.profiles.map(c=>{const d=Mi(c);return`<option value="${c.id}">${ce(d)}</option>`}).join("");t&&(t.innerHTML=`<option value=""> </option>${o}`,t.value=P.profiles.some(c=>c.id===n)?n:""),r&&(r.innerHTML=`<option value=""> </option>${o}`,r.value=P.profiles.some(c=>c.id===a)?a:"");const l=P.employees.map(c=>{const d=ji(c);return`<option value="${c.id}">${ce(d)}</option>`}).join("");s&&(s.innerHTML=`<option value=""> </option>${l}`,s.value=P.employees.some(c=>c.id===i)?i:"")}function Vs(e,t){const r=e.querySelector("#admin-roles-body"),s=e.querySelector("#admin-roles-empty");if(!(!r||!s)){if(!P.roles.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=P.roles.map(n=>{const a=(n==null?void 0:n.username)||(n==null?void 0:n.user_id)||"-",i=n!=null&&n.role?yf(n.role):"-",o=(n==null?void 0:n.user_id)||"",l=!!(n!=null&&n.role);return`
        <tr>
          <td>${ce(a)}</td>
          <td>${l?`<span class="badge text-bg-secondary">${ce(i)}</span>`:'<span class="text-secondary">-</span>'}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-admin-action="add-role"
                data-user-id="${o}"
                data-username="${ce(a)}"
              >
                 
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-admin-action="remove-role"
                data-role-id="${n.id||""}"
                ${l?"":"disabled"}
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}}function Gs(e,t){const r=e.querySelector("#admin-role-catalog-body"),s=e.querySelector("#admin-role-catalog-empty");if(!(!r||!s)){if(!P.roleCatalog.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=P.roleCatalog.map(n=>{const a=String((n==null?void 0:n.name)||"").trim(),i=String((n==null?void 0:n.display_name_bg)||"").trim()||Vr(a),o=a==="admin";return`
        <tr>
          <td>${ce(a)}</td>
          <td>${ce(i)}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-admin-action="edit-catalog-role"
                data-role-name="${ce(a)}"
                data-role-bg="${ce(i)}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-admin-action="delete-catalog-role"
                data-role-name="${ce(a)}"
                ${o?"disabled":""}
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}}function Js(e,t){const r=e.querySelector("#admin-profiles-body"),s=e.querySelector("#admin-profiles-empty");if(!(!r||!s)){if(!P.profiles.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=P.profiles.map(n=>{const a=Mi(n),i=n!=null&&n.employees?ji(n.employees):"-",o=!!(n!=null&&n.employee_id);return`
        <tr>
          <td>${ce(a)}</td>
          <td>${ce(i)}</td>
          <td class="text-end">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary me-2"
              data-admin-action="link-profile"
              data-profile-id="${n.id}"
            >
              
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              data-admin-action="unlink-profile"
              data-profile-id="${n.id}"
              ${o?"":"disabled"}
            >
              
            </button>
          </td>
        </tr>
      `}).join("")}}function Qs(e,t){const r=e.querySelector("#admin-permissions-body"),s=e.querySelector("#admin-permissions-empty");if(!(!r||!s)){if(!P.permissions.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"   .";return}s.classList.add("d-none"),r.innerHTML=P.permissions.map(n=>{const a=String((n==null?void 0:n.resource)||"-"),i=String((n==null?void 0:n.display_name_bg)||"").trim()||Zr(a),o=Or(n==null?void 0:n.view_screen_scope),l=Or(n==null?void 0:n.view_records_scope),c=Or(n==null?void 0:n.edit_records_scope),d=Or(n==null?void 0:n.delete_records_scope);return`
        <tr data-resource="${ce(a)}">
          <td>${ce(i)}</td>
          <td class="text-center">
            ${Cr("view_screen_scope",o)}
          </td>
          <td class="text-center">
            ${Cr("view_records_scope",l)}
          </td>
          <td class="text-center">
            ${Cr("edit_records_scope",c)}
          </td>
          <td class="text-center">
            ${Cr("delete_records_scope",d)}
          </td>
        </tr>
      `}).join("")}}function Cr(e,t){const s=(e==="view_screen_scope"?pf:Ni).map(n=>{const a=n.value===t?"selected":"";return`<option value="${n.value}" ${a}>${ce(n.label)}</option>`}).join("");return`<select class="form-select form-select-sm" data-permission-field="${e}">${s}</select>`}function Or(e){const t=String(e||"").trim();return Ni.some(r=>r.value===t)?t:"none"}function yf(e){const t=String(e||"").trim();if(!t)return"-";const r=P.roleCatalog.find(n=>(n==null?void 0:n.name)===t);return r&&String((r==null?void 0:r.display_name_bg)||"").trim()||Vr(t)}const mf=["admin","head_of_transport","instructor","crew","user"],Pa={admin:10,crew_manager:20,head_of_transport:30,crew_instructor:40,instructor:50,crew:60,crew_member:70,user:80};let ht=null;async function gf(e){const t=await se("../admin.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("#admin-permissions-banner-toggle"),s=e.querySelector("#admin-permissions-role");r&&(r.checked=ai()),s&&(s.value=P.permissionsRole),Gr(e),xf(e),bf(e),await wf(e),await pr(e,P.permissionsRole)}function bf(e){const t=e.querySelector("#admin-assign-role-modal"),r=e.querySelector("#admin-assign-role-modal-close"),s=e.querySelector("#admin-assign-role-modal-cancel"),n=e.querySelector("#admin-profile-link-modal"),a=e.querySelector("#admin-profile-link-modal-close"),i=e.querySelector("#admin-profile-link-modal-cancel"),o=e.querySelector("#open-admin-role-modal"),l=e.querySelector("#admin-role-modal"),c=e.querySelector("#admin-role-modal-form"),d=e.querySelector("#admin-role-modal-close"),h=e.querySelector("#admin-role-modal-cancel"),u=e.querySelector("#admin-role-warning-modal"),f=e.querySelector("#admin-role-warning-close"),p=e.querySelector("#admin-role-warning-cancel"),y=e.querySelector("#admin-role-warning-confirm"),_=e.querySelector("#admin-role-form"),g=e.querySelector("#admin-profile-link-form"),v=e.querySelector("#admin-profile-link-clear"),m=e.querySelector("#admin-permissions-form"),w=e.querySelector("#admin-permissions-role"),k=e.querySelector("#admin-permissions-banner-toggle"),E=e.querySelector("#admin-roles-body"),q=e.querySelector("#admin-role-catalog-body"),L=e.querySelector("#admin-profiles-body");r==null||r.addEventListener("click",()=>{fe(t)}),s==null||s.addEventListener("click",()=>{fe(t)}),a==null||a.addEventListener("click",()=>{fe(n)}),i==null||i.addEventListener("click",()=>{fe(n)}),o==null||o.addEventListener("click",()=>{Da(e,{mode:"create"})}),c==null||c.addEventListener("submit",async T=>{T.preventDefault(),await Sf(e)}),d==null||d.addEventListener("click",()=>{fe(l),Gr(e)}),h==null||h.addEventListener("click",()=>{fe(l),Gr(e)}),f==null||f.addEventListener("click",()=>{fe(u),ht=null}),p==null||p.addEventListener("click",()=>{fe(u),ht=null}),y==null||y.addEventListener("click",async()=>{if(!ht){fe(u);return}const T=ht;ht=null,fe(u),await T()}),_==null||_.addEventListener("submit",async T=>{T.preventDefault(),await kf(e)}),g==null||g.addEventListener("submit",async T=>{T.preventDefault(),await Tf(e)}),v==null||v.addEventListener("click",async()=>{var A;const T=((A=e.querySelector("#admin-profile-link-id"))==null?void 0:A.value)||"";if(!T){b("   .","warning");return}Xt(e,{message:"  ,       ?",confirmLabel:"",onConfirm:()=>Ys(e,T,null)})}),m==null||m.addEventListener("submit",async T=>{T.preventDefault(),await If(e)}),w==null||w.addEventListener("change",async T=>{const A=T.target.value||"admin";P.permissionsRole=A,await pr(e,A)}),k==null||k.addEventListener("change",T=>{var A;Ic(!!((A=T.target)!=null&&A.checked)),b("    .","success")}),E==null||E.addEventListener("click",async T=>{const A=T.target.closest('button[data-admin-action="add-role"]');if(A){const O=A.getAttribute("data-user-id")||"";if(!O)return;_f(e,O);return}const x=T.target.closest('button[data-admin-action="remove-role"]');if(!x)return;const C=x.getAttribute("data-role-id")||"";C&&Xt(e,{message:"  ,        ?",confirmLabel:"",onConfirm:()=>Ef(e,C)})}),q==null||q.addEventListener("click",async T=>{const A=T.target.closest('button[data-admin-action="edit-catalog-role"]');if(A){const O=A.getAttribute("data-role-name")||"",K=A.getAttribute("data-role-bg")||"";Da(e,{mode:"edit",roleName:O,roleNameBg:K});return}const x=T.target.closest('button[data-admin-action="delete-catalog-role"]');if(!x)return;const C=x.getAttribute("data-role-name")||"";C&&await Af(e,C)}),L==null||L.addEventListener("click",async T=>{const A=T.target.closest('button[data-admin-action="link-profile"]');if(A){const O=A.getAttribute("data-profile-id")||"";O&&vf(e,O);return}const x=T.target.closest('button[data-admin-action="unlink-profile"]');if(!x)return;const C=x.getAttribute("data-profile-id")||"";C&&Xt(e,{message:"  ,       ?",confirmLabel:"",onConfirm:()=>Ys(e,C,null)})})}function vf(e,t){const r=e.querySelector("#admin-profile-link-modal"),s=e.querySelector("#admin-profile-link-id"),n=e.querySelector("#admin-profile-link-employee-id"),a=P.profiles.find(i=>i.id===t);s&&(s.value=t),n&&(n.value=(a==null?void 0:a.employee_id)||""),ns(r)}function _f(e,t){const r=e.querySelector("#admin-assign-role-modal"),s=e.querySelector("#admin-role-profile-id"),n=e.querySelector("#admin-role-value");s&&(s.value=t),n&&(n.value=""),ns(r)}async function wf(e){const[{data:t,error:r},{data:s,error:n},{data:a,error:i},{data:o,error:l}]=await Promise.all([S.from("user_profiles").select("id, username, employee_id, employees(id, first_name, last_name, is_active)").order("username",{ascending:!0}),S.from("employees").select("id, first_name, last_name, is_active").order("last_name",{ascending:!0}).order("first_name",{ascending:!0}),S.from("user_roles").select("id, user_id, role").order("role",{ascending:!0}).order("created_at",{ascending:!1}),S.from("roles").select("name, display_name_bg").order("name",{ascending:!0})]);if(r||n||i||l){b((r==null?void 0:r.message)||(n==null?void 0:n.message)||(i==null?void 0:i.message)||(l==null?void 0:l.message)||"     .","error"),P.profiles=[],P.employees=[],P.roleCatalog=[],P.availableRoles=[],P.roles=[],zs(e),Gs(e,"  ."),Vs(e,"   ."),Js(e,"   .");return}P.profiles=t||[],P.employees=s||[],P.roleCatalog=o||[],P.roles=Lf(a||[],P.profiles),P.availableRoles=Hi(o||[],a||[]),Ui(e),zs(e),Gs(e),Vs(e),Js(e)}async function Sf(e){var y,_;const t=e.querySelector("#admin-role-modal-original-name"),r=e.querySelector("#admin-role-modal-name"),s=e.querySelector("#admin-role-modal-name-bg"),n=e.querySelector("#admin-role-modal-save"),a=((y=t==null?void 0:t.value)==null?void 0:y.trim())||"",i=(r==null?void 0:r.value)||"",o=(s==null?void 0:s.value)||"",l=i.trim().toLowerCase(),c=o.trim();if(!l){b("   .","warning");return}if(!c){b("     .","warning");return}if(!/^[a-z0-9_]+$/.test(l)){b("       ,   _.","warning");return}const d=(n==null?void 0:n.innerHTML)||"";n&&(n.disabled=!0,n.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{data:h}=await S.auth.getUser();let u=null;if(a){const{error:g}=await S.from("roles").update({name:l,display_name_bg:c||l}).eq("name",a);u=g}else{const{error:g}=await S.from("roles").insert({name:l,display_name_bg:c||l,created_from:((_=h==null?void 0:h.user)==null?void 0:_.email)||"admin_panel"});u=g}if(u){n&&(n.disabled=!1,n.innerHTML=d),b(u.message,"error");return}const f=[...new Map(P.permissions.map(g=>[g.resource,g]).filter(([g])=>!!g)).values()];if(f.length){const g=f.map(m=>({role:l,resource:m.resource,display_name_bg:m.display_name_bg||Zr(m.resource),view_screen_scope:"none",view_records_scope:"none",edit_records_scope:"none",delete_records_scope:"none"})),{error:v}=await S.from("role_permissions").upsert(g,{onConflict:"role,resource"});if(v){n&&(n.disabled=!1,n.innerHTML=d),b(v.message,"error");return}}r&&(r.value=""),s&&(s.value=""),t&&(t.value=""),n&&(n.disabled=!1,n.innerHTML=d),b(a?"  .":"  .","success"),await Fi(e);const p=e.querySelector("#admin-permissions-role");p&&(p.value=l),P.permissionsRole=l,await pr(e,l),fe(e.querySelector("#admin-role-modal")),Gr(e)}async function kf(e){var c,d,h;const t=((c=e.querySelector("#admin-role-profile-id"))==null?void 0:c.value)||"",r=((d=e.querySelector("#admin-role-value"))==null?void 0:d.value)||"",s=e.querySelector("#admin-role-add");if(!t||!r){b("   .","warning");return}const n=(s==null?void 0:s.innerHTML)||"";s&&(s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{data:a}=await S.auth.getUser(),{error:i}=await S.from("user_roles").insert({user_id:t,role:r,created_from:((h=a==null?void 0:a.user)==null?void 0:h.email)||"admin_panel"});if(s&&(s.disabled=!1,s.innerHTML=n),i){b(i.message,"error");return}b("  .","success"),fe(e.querySelector("#admin-assign-role-modal"));const o=e.querySelector("#admin-role-profile-id"),l=e.querySelector("#admin-role-value");o&&(o.value=""),l&&(l.value=""),await vn(e)}async function Ef(e,t){const{error:r}=await S.from("user_roles").delete().eq("id",t);if(r){b(r.message,"error");return}b("  .","success"),await vn(e)}async function Tf(e){var s,n;const t=((s=e.querySelector("#admin-profile-link-id"))==null?void 0:s.value)||"",r=((n=e.querySelector("#admin-profile-link-employee-id"))==null?void 0:n.value)||"";if(!t||!r){b("   .","warning");return}await Ys(e,t,r)}async function Ys(e,t,r){const s=e.querySelector("#admin-profile-link-save"),n=(s==null?void 0:s.innerHTML)||"";if(s&&(s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...'),r){const{error:l}=await S.from("user_profiles").update({employee_id:null,updated_at:new Date().toISOString()}).eq("employee_id",r).neq("id",t);if(l){s&&(s.disabled=!1,s.innerHTML=n),b(l.message,"error");return}}const{error:a}=await S.from("user_profiles").update({employee_id:r,updated_at:new Date().toISOString()}).eq("id",t);if(s&&(s.disabled=!1,s.innerHTML=n),a){b(a.message,"error");return}b(r?"    .":"    .","success"),fe(e.querySelector("#admin-profile-link-modal"));const i=e.querySelector("#admin-profile-link-id"),o=e.querySelector("#admin-profile-link-employee-id");i&&(i.value=""),o&&(o.value=""),await Rf(e)}async function vn(e){const{data:t,error:r}=await S.from("user_roles").select("id, user_id, role").order("created_at",{ascending:!1});if(r){b(r.message,"error");return}P.roles=qf(t||[],P.profiles),Vs(e)}function qf(e,t){const r=new Map((t||[]).map(s=>[s.id,s]));return(e||[]).map(s=>{var n;return{...s,username:((n=r.get(s.user_id))==null?void 0:n.username)||""}})}function Lf(e,t){new Map((t||[]).map(n=>[n.id,n]));const r=new Map;(e||[]).forEach(n=>{r.has(n.user_id)||r.set(n.user_id,[]),r.get(n.user_id).push(n)});const s=[];return(t||[]).forEach(n=>{const a=r.get(n.id)||[];a.length>0?a.forEach(i=>{s.push({...i,username:n.username,user_id:n.id})}):s.push({id:null,user_id:n.id,role:null,username:n.username})}),s}function Hi(e,t){const r=(e||[]).map(a=>String((a==null?void 0:a.name)||"").trim()).filter(Boolean),s=(t||[]).map(a=>String((a==null?void 0:a.role)||"").trim()).filter(Boolean);return[...new Set([...mf,...r,...s])].sort((a,i)=>{const o=String(a||"").trim().toLowerCase(),l=String(i||"").trim().toLowerCase(),c=Pa[o]??999,d=Pa[l]??999;return c!==d?c-d:o.localeCompare(l,"en")})}function Ui(e){const t=e.querySelector("#admin-role-value"),r=e.querySelector("#admin-permissions-role"),s=(t==null?void 0:t.value)||"",n=(r==null?void 0:r.value)||P.permissionsRole||"",a=P.availableRoles.map(i=>{const o=Bi(i);return`<option value="${i}">${o}</option>`}).join("");if(t&&(t.innerHTML=`<option value=""> </option>${a}`,t.value=P.availableRoles.includes(s)?s:""),r){r.innerHTML=a;const i=P.availableRoles.includes("admin")?"admin":P.availableRoles[0]||"",o=P.availableRoles.includes(n)?n:i;r.value=o,P.permissionsRole=o}}async function Fi(e){const{data:t,error:r}=await S.from("roles").select("name, display_name_bg").order("name",{ascending:!0});if(r){b(r.message,"error");return}P.roleCatalog=t||[],P.availableRoles=Hi(t||[],P.roles),Ui(e),Gs(e)}function Bi(e){const t=P.roleCatalog.find(s=>(s==null?void 0:s.name)===e),r=String((t==null?void 0:t.display_name_bg)||"").trim();return r||Vr(e)}async function $f(e,t){if(!t)return;if(t==="admin"){b(" admin     .","warning");return}const{error:r}=await S.from("role_permissions").delete().eq("role",t);if(r){b(r.message,"error");return}const{error:s}=await S.from("roles").delete().eq("name",t);if(s){b(s.message,"error");return}if(b("  .","success"),await Fi(e),await vn(e),P.permissionsRole===t){const n=P.availableRoles.includes("admin")?"admin":P.availableRoles[0]||"";P.permissionsRole=n,n?await pr(e,n):(P.permissions=[],Qs(e,"   ."))}}function Da(e,{mode:t,roleName:r="",roleNameBg:s=""}){const n=e.querySelector("#admin-role-modal"),a=e.querySelector("#admin-role-modal-title"),i=e.querySelector("#admin-role-modal-original-name"),o=e.querySelector("#admin-role-modal-name"),l=e.querySelector("#admin-role-modal-name-bg"),c=e.querySelector("#admin-role-modal-save");i&&(i.value=t==="edit"?r:""),o&&(o.value=t==="edit"?r:""),l&&(l.value=t==="edit"?s||r:""),a&&(a.textContent=t==="edit"?"  ":" "),c&&(c.textContent=t==="edit"?"":""),ns(n)}function Gr(e){const t=e.querySelector("#admin-role-modal-original-name"),r=e.querySelector("#admin-role-modal-name"),s=e.querySelector("#admin-role-modal-name-bg"),n=e.querySelector("#admin-role-modal-title"),a=e.querySelector("#admin-role-modal-save");t&&(t.value=""),r&&(r.value=""),s&&(s.value=""),n&&(n.textContent=" "),a&&(a.textContent="")}function Xt(e,{message:t,confirmLabel:r,onConfirm:s}){const n=e.querySelector("#admin-role-warning-modal"),a=e.querySelector("#admin-role-warning-message"),i=e.querySelector("#admin-role-warning-confirm");ht=typeof s=="function"?s:null,a&&(a.textContent=t||"  ?"),i&&(i.textContent=r||""),ns(n)}async function Af(e,t){const{count:r,error:s}=await S.from("user_roles").select("id",{count:"exact",head:!0}).eq("role",t);if(s){b(s.message,"error");return}const n=Bi(t),a=Number(r||0);if(a>0){Xt(e,{message:` "${n}"     ,     ${a} ().      .`,confirmLabel:"",onConfirm:null});return}Xt(e,{message:`  ,      "${n}"?         .`,confirmLabel:"",onConfirm:()=>$f(e,t)})}function ns(e){e&&e.classList.remove("d-none")}function fe(e){e&&e.classList.add("d-none")}function xf(e){var a,i;const t=[...e.querySelectorAll("[data-admin-tab]")],r=[...e.querySelectorAll("[data-admin-tab-pane]")];if(!t.length||!r.length)return;const s=o=>{t.forEach(l=>{const c=l.getAttribute("data-admin-tab")===o;l.classList.toggle("active",c),l.setAttribute("aria-selected",c?"true":"false")}),r.forEach(l=>{const c=l.getAttribute("data-admin-tab-pane")===o;l.classList.toggle("active",c),l.classList.toggle("d-none",!c)})};t.forEach(o=>{o.addEventListener("click",()=>{const l=o.getAttribute("data-admin-tab")||"";l&&s(l)})});const n=((a=t.find(o=>o.classList.contains("active")))==null?void 0:a.getAttribute("data-admin-tab"))||((i=t[0])==null?void 0:i.getAttribute("data-admin-tab"))||"";n&&s(n)}async function Rf(e){const{data:t,error:r}=await S.from("user_profiles").select("id, username, employee_id, employees(id, first_name, last_name, is_active)").order("username",{ascending:!0});if(r){b(r.message,"error");return}P.profiles=t||[],zs(e),Js(e)}async function pr(e,t){const r=t||"admin",{data:s,error:n}=await S.from("role_permissions").select("role, resource, display_name_bg, view_screen_scope, view_records_scope, edit_records_scope, delete_records_scope").eq("role",r).order("resource",{ascending:!0});if(n){b(n.message,"error"),P.permissions=[],Qs(e,"   .");return}P.permissions=s||[],Qs(e)}async function If(e){const t=e.querySelector("#admin-permissions-save"),r=e.querySelector("#admin-permissions-role"),s=(r==null?void 0:r.value)||"admin",n=[...e.querySelectorAll("#admin-permissions-body tr[data-resource]")];if(!n.length){b("   .","warning");return}const a=n.map(l=>{const c=l.getAttribute("data-resource")||"",d=P.permissions.find(u=>u.resource===c),h=u=>{var p;const f=((p=l.querySelector(`[data-permission-field="${u}"]`))==null?void 0:p.value)||"none";return u==="view_screen_scope"?["none","all"].includes(f)?f:"none":["none","all","own","role_attached_employees"].includes(f)?f:"none"};return{role:s,resource:c,display_name_bg:(d==null?void 0:d.display_name_bg)||Zr(c),view_screen_scope:h("view_screen_scope"),view_records_scope:h("view_records_scope"),edit_records_scope:h("edit_records_scope"),delete_records_scope:h("delete_records_scope"),updated_at:new Date().toISOString()}}),i=(t==null?void 0:t.innerHTML)||"";t&&(t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{error:o}=await S.from("role_permissions").upsert(a,{onConflict:"role,resource"});if(t&&(t.disabled=!1,t.innerHTML=i),o){b(o.message,"error");return}b("  .","success"),await pr(e,s)}const Ma={"/":{render:od,title:"TrainCrewHub"},"/login":{render:cd,title:"TrainCrewHub / Sign In"},"/register":{render:ud,title:"TrainCrewHub / Register"},"/schedule-keys":{render:pd,title:"TrainCrewHub / -",resource:"schedule_keys"},"/duties":{render:qd,title:"TrainCrewHub / ",resource:"duties"},"/duty-types":{render:Eh,title:"TrainCrewHub /  ",resource:"duty_types"},"/trains":{render:tf,title:"TrainCrewHub / ",resource:"trains"},"/employees":{render:Bd,title:"TrainCrewHub / ",resource:"employees"},"/employee-absences":{render:Yd,title:"TrainCrewHub / ",resource:"employee_absences"},"/planned-duties":{render:vu,title:"TrainCrewHub /  ",resource:"planned_duties"},"/actual-duties":{render:Lu,title:"TrainCrewHub /  ",resource:"actual_duties"},"/plan-schedule":{render:nh,title:"TrainCrewHub /  ",screenResource:"page_plan_schedule",resource:"planned_duties"},"/schedule":{render:_h,title:"TrainCrewHub / ",screenResource:"page_schedule",resource:"actual_duties"},"/schedule-key-duties":{render:Ph,title:"TrainCrewHub /   -",resource:"duties"},"/admin":{render:gf,title:"TrainCrewHub /  ",requiresAdmin:!0}},Cf="page-content",Of={none:" ",all:"",own:"",role_attached_employees:"    "};function Pf(e){return e==="all"?"text-bg-success":e==="own"||e==="role_attached_employees"?"text-bg-warning":"text-bg-secondary"}async function Df(e,t){if(!e||!t||!ai())return;const r=await Ac(t),s=Zr(t),a=[{label:"",key:"view_screen"},{label:" ",key:"view_records"},{label:"",key:"edit_records"},{label:"",key:"delete_records"}].map(({label:o,key:l})=>{const c=r[l]||"none",d=Of[c]||c,h=Pf(c);return`
        <span class="me-3 mb-2 d-inline-flex align-items-center gap-2">
          <span class="text-secondary small">${o}:</span>
          <span class="badge ${h}">${d}</span>
        </span>
      `}).join(""),i=document.createElement("div");i.className="alert alert-light border d-flex flex-wrap align-items-center gap-1 mb-3",i.innerHTML=`
    <span class="fw-semibold me-2">  ${s}</span>
    ${a}
  `,e.prepend(i)}function ja(e){return Ma[e]??Ma["/"]}async function Mf(e,t){var a,i;if(!new Set(["/login","/register"]).has(e)){const o=await Wn();if(!((a=o==null?void 0:o.user)!=null&&a.id))return"/login"}if(!(t!=null&&t.requiresAdmin)){const o=(t==null?void 0:t.screenResource)||(t==null?void 0:t.resource)||"";return!o||await si(o)?e:(b("      .","warning"),"/")}const s=await Wn();return(i=s==null?void 0:s.user)!=null&&i.id?await ti(s.user.id)?e:(b("      .","warning"),"/"):"/login"}async function Xs(){const e=document.getElementById(Cf);Rc();const t=window.location.pathname,r=ja(t),s=await Mf(t,r);s!==t&&window.history.replaceState({},"",s);const n=ja(s);document.title=n.title,await n.render(e),n.resource&&(await Df(e,n.resource),await xc(e,n.resource)),window.dispatchEvent(new CustomEvent("route:changed",{detail:{pathname:s}}))}function jf(e){const t=e.target.closest("a[data-link]");if(!t)return;e.preventDefault();const r=t.getAttribute("href");r!==window.location.pathname&&(window.history.pushState({},"",r),Xs())}function Nf(){ni(),window.addEventListener("popstate",Xs),document.addEventListener("click",jf),Xs()}const Hf=document.getElementById("app");async function Uf(){await Pc(Hf),Nf()}Uf();
