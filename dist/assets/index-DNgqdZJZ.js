(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();async function ue(e,t){const r=new URL(e,t),s=await fetch(r);if(!s.ok)throw new Error(`Failed to load HTML from ${r.pathname}`);return s.text()}function Ys(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(r[s[n]]=e[s[n]]);return r}function $l(e,t,r,s){function n(a){return a instanceof r?a:new r(function(i){i(a)})}return new(r||(r=Promise))(function(a,i){function o(d){try{c(s.next(d))}catch(u){i(u)}}function l(d){try{c(s.throw(d))}catch(u){i(u)}}function c(d){d.done?a(d.value):n(d.value).then(o,l)}c((s=s.apply(e,t||[])).next())})}const Al=e=>e?(...t)=>e(...t):(...t)=>fetch(...t);class pa extends Error{constructor(t,r="FunctionsError",s){super(t),this.name=r,this.context=s}}class xl extends pa{constructor(t){super("Failed to send a request to the Edge Function","FunctionsFetchError",t)}}class Ka extends pa{constructor(t){super("Relay Error invoking the Edge Function","FunctionsRelayError",t)}}class Wa extends pa{constructor(t){super("Edge Function returned a non-2xx status code","FunctionsHttpError",t)}}var Cn;(function(e){e.Any="any",e.ApNortheast1="ap-northeast-1",e.ApNortheast2="ap-northeast-2",e.ApSouth1="ap-south-1",e.ApSoutheast1="ap-southeast-1",e.ApSoutheast2="ap-southeast-2",e.CaCentral1="ca-central-1",e.EuCentral1="eu-central-1",e.EuWest1="eu-west-1",e.EuWest2="eu-west-2",e.EuWest3="eu-west-3",e.SaEast1="sa-east-1",e.UsEast1="us-east-1",e.UsWest1="us-west-1",e.UsWest2="us-west-2"})(Cn||(Cn={}));class Cl{constructor(t,{headers:r={},customFetch:s,region:n=Cn.Any}={}){this.url=t,this.headers=r,this.region=n,this.fetch=Al(s)}setAuth(t){this.headers.Authorization=`Bearer ${t}`}invoke(t){return $l(this,arguments,void 0,function*(r,s={}){var n;let a,i;try{const{headers:o,method:l,body:c,signal:d,timeout:u}=s;let h={},{region:m}=s;m||(m=this.region);const f=new URL(`${this.url}/${r}`);m&&m!=="any"&&(h["x-region"]=m,f.searchParams.set("forceFunctionRegion",m));let p;c&&(o&&!Object.prototype.hasOwnProperty.call(o,"Content-Type")||!o)?typeof Blob<"u"&&c instanceof Blob||c instanceof ArrayBuffer?(h["Content-Type"]="application/octet-stream",p=c):typeof c=="string"?(h["Content-Type"]="text/plain",p=c):typeof FormData<"u"&&c instanceof FormData?p=c:(h["Content-Type"]="application/json",p=JSON.stringify(c)):c&&typeof c!="string"&&!(typeof Blob<"u"&&c instanceof Blob)&&!(c instanceof ArrayBuffer)&&!(typeof FormData<"u"&&c instanceof FormData)?p=JSON.stringify(c):p=c;let _=d;u&&(i=new AbortController,a=setTimeout(()=>i.abort(),u),d?(_=i.signal,d.addEventListener("abort",()=>i.abort())):_=i.signal);const y=yield this.fetch(f.toString(),{method:l||"POST",headers:Object.assign(Object.assign(Object.assign({},h),this.headers),o),body:p,signal:_}).catch(k=>{throw new xl(k)}),b=y.headers.get("x-relay-error");if(b&&b==="true")throw new Ka(y);if(!y.ok)throw new Wa(y);let g=((n=y.headers.get("Content-Type"))!==null&&n!==void 0?n:"text/plain").split(";")[0].trim(),S;return g==="application/json"?S=yield y.json():g==="application/octet-stream"||g==="application/pdf"?S=yield y.blob():g==="text/event-stream"?S=y:g==="multipart/form-data"?S=yield y.formData():S=yield y.text(),{data:S,error:null,response:y}}catch(o){return{data:null,error:o,response:o instanceof Wa||o instanceof Ka?o.context:void 0}}finally{a&&clearTimeout(a)}})}}var Rl=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}},Il=class{constructor(e){var t,r,s;this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=new Headers(e.headers),this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=(t=e.shouldThrowOnError)!==null&&t!==void 0?t:!1,this.signal=e.signal,this.isMaybeSingle=(r=e.isMaybeSingle)!==null&&r!==void 0?r:!1,this.urlLengthLimit=(s=e.urlLengthLimit)!==null&&s!==void 0?s:8e3,e.fetch?this.fetch=e.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=new Headers(this.headers),this.headers.set(e,t),this}then(e,t){var r=this;this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const s=this.fetch;let n=s(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async a=>{let i=null,o=null,l=null,c=a.status,d=a.statusText;if(a.ok){var u,h;if(r.method!=="HEAD"){var m;const y=await a.text();y===""||(r.headers.get("Accept")==="text/csv"||r.headers.get("Accept")&&(!((m=r.headers.get("Accept"))===null||m===void 0)&&m.includes("application/vnd.pgrst.plan+text"))?o=y:o=JSON.parse(y))}const p=(u=r.headers.get("Prefer"))===null||u===void 0?void 0:u.match(/count=(exact|planned|estimated)/),_=(h=a.headers.get("content-range"))===null||h===void 0?void 0:h.split("/");p&&_&&_.length>1&&(l=parseInt(_[1])),r.isMaybeSingle&&r.method==="GET"&&Array.isArray(o)&&(o.length>1?(i={code:"PGRST116",details:`Results contain ${o.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},o=null,l=null,c=406,d="Not Acceptable"):o.length===1?o=o[0]:o=null)}else{var f;const p=await a.text();try{i=JSON.parse(p),Array.isArray(i)&&a.status===404&&(o=[],i=null,c=200,d="OK")}catch{a.status===404&&p===""?(c=204,d="No Content"):i={message:p}}if(i&&r.isMaybeSingle&&(!(i==null||(f=i.details)===null||f===void 0)&&f.includes("0 rows"))&&(i=null,c=200,d="OK"),i&&r.shouldThrowOnError)throw new Rl(i)}return{error:i,data:o,count:l,status:c,statusText:d}});return this.shouldThrowOnError||(n=n.catch(a=>{var i;let o="",l="",c="";const d=a==null?void 0:a.cause;if(d){var u,h,m,f;const y=(u=d==null?void 0:d.message)!==null&&u!==void 0?u:"",b=(h=d==null?void 0:d.code)!==null&&h!==void 0?h:"";o=`${(m=a==null?void 0:a.name)!==null&&m!==void 0?m:"FetchError"}: ${a==null?void 0:a.message}`,o+=`

Caused by: ${(f=d==null?void 0:d.name)!==null&&f!==void 0?f:"Error"}: ${y}`,b&&(o+=` (${b})`),d!=null&&d.stack&&(o+=`
${d.stack}`)}else{var p;o=(p=a==null?void 0:a.stack)!==null&&p!==void 0?p:""}const _=this.url.toString().length;return(a==null?void 0:a.name)==="AbortError"||(a==null?void 0:a.code)==="ABORT_ERR"?(c="",l="Request was aborted (timeout or manual cancellation)",_>this.urlLengthLimit&&(l+=`. Note: Your request URL is ${_} characters, which may exceed server limits. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [many IDs])), consider using an RPC function to pass values server-side.`)):((d==null?void 0:d.name)==="HeadersOverflowError"||(d==null?void 0:d.code)==="UND_ERR_HEADERS_OVERFLOW")&&(c="",l="HTTP headers exceeded server limits (typically 16KB)",_>this.urlLengthLimit&&(l+=`. Your request URL is ${_} characters. If selecting many fields, consider using views. If filtering with large arrays (e.g., .in('id', [200+ IDs])), consider using an RPC function instead.`)),{error:{message:`${(i=a==null?void 0:a.name)!==null&&i!==void 0?i:"FetchError"}: ${a==null?void 0:a.message}`,details:o,hint:l,code:c},data:null,count:null,status:0,statusText:""}})),n.then(e,t)}returns(){return this}overrideTypes(){return this}},Dl=class extends Il{select(e){let t=!1;const r=(e??"*").split("").map(s=>/\s/.test(s)&&!t?"":(s==='"'&&(t=!t),s)).join("");return this.url.searchParams.set("select",r),this.headers.append("Prefer","return=representation"),this}order(e,{ascending:t=!0,nullsFirst:r,foreignTable:s,referencedTable:n=s}={}){const a=n?`${n}.order`:"order",i=this.url.searchParams.get(a);return this.url.searchParams.set(a,`${i?`${i},`:""}${e}.${t?"asc":"desc"}${r===void 0?"":r?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:r=t}={}){const s=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(s,`${e}`),this}range(e,t,{foreignTable:r,referencedTable:s=r}={}){const n=typeof s>"u"?"offset":`${s}.offset`,a=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(n,`${e}`),this.url.searchParams.set(a,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:e=!1,verbose:t=!1,settings:r=!1,buffers:s=!1,wal:n=!1,format:a="text"}={}){var i;const o=[e?"analyze":null,t?"verbose":null,r?"settings":null,s?"buffers":null,n?"wal":null].filter(Boolean).join("|"),l=(i=this.headers.get("Accept"))!==null&&i!==void 0?i:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${a}; for="${l}"; options=${o};`),a==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(e){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${e}`),this}};const za=new RegExp("[,()]");var Qt=class extends Dl{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}regexMatch(e,t){return this.url.searchParams.append(e,`match.${t}`),this}regexIMatch(e,t){return this.url.searchParams.append(e,`imatch.${t}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}isDistinct(e,t){return this.url.searchParams.append(e,`isdistinct.${t}`),this}in(e,t){const r=Array.from(new Set(t)).map(s=>typeof s=="string"&&za.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`in.(${r})`),this}notIn(e,t){const r=Array.from(new Set(t)).map(s=>typeof s=="string"&&za.test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`not.in.(${r})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:r,type:s}={}){let n="";s==="plain"?n="pl":s==="phrase"?n="ph":s==="websearch"&&(n="w");const a=r===void 0?"":`(${r})`;return this.url.searchParams.append(e,`${n}fts${a}.${t}`),this}match(e){return Object.entries(e).forEach(([t,r])=>{this.url.searchParams.append(t,`eq.${r}`)}),this}not(e,t,r){return this.url.searchParams.append(e,`not.${t}.${r}`),this}or(e,{foreignTable:t,referencedTable:r=t}={}){const s=r?`${r}.or`:"or";return this.url.searchParams.append(s,`(${e})`),this}filter(e,t,r){return this.url.searchParams.append(e,`${t}.${r}`),this}},Ol=class{constructor(e,{headers:t={},schema:r,fetch:s,urlLengthLimit:n=8e3}){this.url=e,this.headers=new Headers(t),this.schema=r,this.fetch=s,this.urlLengthLimit=n}cloneRequestState(){return{url:new URL(this.url.toString()),headers:new Headers(this.headers)}}select(e,t){const{head:r=!1,count:s}=t??{},n=r?"HEAD":"GET";let a=!1;const i=(e??"*").split("").map(c=>/\s/.test(c)&&!a?"":(c==='"'&&(a=!a),c)).join(""),{url:o,headers:l}=this.cloneRequestState();return o.searchParams.set("select",i),s&&l.append("Prefer",`count=${s}`),new Qt({method:n,url:o,headers:l,schema:this.schema,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}insert(e,{count:t,defaultToNull:r=!0}={}){var s;const n="POST",{url:a,headers:i}=this.cloneRequestState();if(t&&i.append("Prefer",`count=${t}`),r||i.append("Prefer","missing=default"),Array.isArray(e)){const o=e.reduce((l,c)=>l.concat(Object.keys(c)),[]);if(o.length>0){const l=[...new Set(o)].map(c=>`"${c}"`);a.searchParams.set("columns",l.join(","))}}return new Qt({method:n,url:a,headers:i,schema:this.schema,body:e,fetch:(s=this.fetch)!==null&&s!==void 0?s:fetch,urlLengthLimit:this.urlLengthLimit})}upsert(e,{onConflict:t,ignoreDuplicates:r=!1,count:s,defaultToNull:n=!0}={}){var a;const i="POST",{url:o,headers:l}=this.cloneRequestState();if(l.append("Prefer",`resolution=${r?"ignore":"merge"}-duplicates`),t!==void 0&&o.searchParams.set("on_conflict",t),s&&l.append("Prefer",`count=${s}`),n||l.append("Prefer","missing=default"),Array.isArray(e)){const c=e.reduce((d,u)=>d.concat(Object.keys(u)),[]);if(c.length>0){const d=[...new Set(c)].map(u=>`"${u}"`);o.searchParams.set("columns",d.join(","))}}return new Qt({method:i,url:o,headers:l,schema:this.schema,body:e,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch,urlLengthLimit:this.urlLengthLimit})}update(e,{count:t}={}){var r;const s="PATCH",{url:n,headers:a}=this.cloneRequestState();return t&&a.append("Prefer",`count=${t}`),new Qt({method:s,url:n,headers:a,schema:this.schema,body:e,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch,urlLengthLimit:this.urlLengthLimit})}delete({count:e}={}){var t;const r="DELETE",{url:s,headers:n}=this.cloneRequestState();return e&&n.append("Prefer",`count=${e}`),new Qt({method:r,url:s,headers:n,schema:this.schema,fetch:(t=this.fetch)!==null&&t!==void 0?t:fetch,urlLengthLimit:this.urlLengthLimit})}};function Br(e){"@babel/helpers - typeof";return Br=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Br(e)}function Pl(e,t){if(Br(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var s=r.call(e,t);if(Br(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function Ml(e){var t=Pl(e,"string");return Br(t)=="symbol"?t:t+""}function Nl(e,t,r){return(t=Ml(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Va(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,s)}return r}function ms(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?Va(Object(r),!0).forEach(function(s){Nl(e,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Va(Object(r)).forEach(function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s))})}return e}var jl=class _o{constructor(t,{headers:r={},schema:s,fetch:n,timeout:a,urlLengthLimit:i=8e3}={}){this.url=t,this.headers=new Headers(r),this.schemaName=s,this.urlLengthLimit=i;const o=n??globalThis.fetch;a!==void 0&&a>0?this.fetch=(l,c)=>{const d=new AbortController,u=setTimeout(()=>d.abort(),a),h=c==null?void 0:c.signal;if(h){if(h.aborted)return clearTimeout(u),o(l,c);const m=()=>{clearTimeout(u),d.abort()};return h.addEventListener("abort",m,{once:!0}),o(l,ms(ms({},c),{},{signal:d.signal})).finally(()=>{clearTimeout(u),h.removeEventListener("abort",m)})}return o(l,ms(ms({},c),{},{signal:d.signal})).finally(()=>clearTimeout(u))}:this.fetch=o}from(t){if(!t||typeof t!="string"||t.trim()==="")throw new Error("Invalid relation name: relation must be a non-empty string.");return new Ol(new URL(`${this.url}/${t}`),{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}schema(t){return new _o(this.url,{headers:this.headers,schema:t,fetch:this.fetch,urlLengthLimit:this.urlLengthLimit})}rpc(t,r={},{head:s=!1,get:n=!1,count:a}={}){var i;let o;const l=new URL(`${this.url}/rpc/${t}`);let c;const d=m=>m!==null&&typeof m=="object"&&(!Array.isArray(m)||m.some(d)),u=s&&Object.values(r).some(d);u?(o="POST",c=r):s||n?(o=s?"HEAD":"GET",Object.entries(r).filter(([m,f])=>f!==void 0).map(([m,f])=>[m,Array.isArray(f)?`{${f.join(",")}}`:`${f}`]).forEach(([m,f])=>{l.searchParams.append(m,f)})):(o="POST",c=r);const h=new Headers(this.headers);return u?h.set("Prefer",a?`count=${a},return=minimal`:"return=minimal"):a&&h.set("Prefer",`count=${a}`),new Qt({method:o,url:l,headers:h,schema:this.schemaName,body:c,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch,urlLengthLimit:this.urlLengthLimit})}};class Hl{constructor(){}static detectEnvironment(){var t;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((t=navigator.userAgent)===null||t===void 0)&&t.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};const r=globalThis.process;if(r){const s=r.versions;if(s&&s.node){const n=s.node,a=parseInt(n.replace(/^v/,"").split(".")[0]);return a>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${a} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${a} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const t=this.detectEnvironment();if(t.constructor)return t.constructor;let r=t.error||"WebSocket not supported in this environment.";throw t.workaround&&(r+=`

Suggested solution: ${t.workaround}`),new Error(r)}static createWebSocket(t,r){const s=this.getWebSocketConstructor();return new s(t,r)}static isWebSocketSupported(){try{const t=this.detectEnvironment();return t.type==="native"||t.type==="ws"}catch{return!1}}}const Ul="2.95.3",Fl=`realtime-js/${Ul}`,Bl="1.0.0",So="2.0.0",Ga=So,Rn=1e4,Kl=1e3,Wl=100;var ot;(function(e){e[e.connecting=0]="connecting",e[e.open=1]="open",e[e.closing=2]="closing",e[e.closed=3]="closed"})(ot||(ot={}));var ge;(function(e){e.closed="closed",e.errored="errored",e.joined="joined",e.joining="joining",e.leaving="leaving"})(ge||(ge={}));var ze;(function(e){e.close="phx_close",e.error="phx_error",e.join="phx_join",e.reply="phx_reply",e.leave="phx_leave",e.access_token="access_token"})(ze||(ze={}));var In;(function(e){e.websocket="websocket"})(In||(In={}));var $t;(function(e){e.Connecting="connecting",e.Open="open",e.Closing="closing",e.Closed="closed"})($t||($t={}));class zl{constructor(t){this.HEADER_LENGTH=1,this.USER_BROADCAST_PUSH_META_LENGTH=6,this.KINDS={userBroadcastPush:3,userBroadcast:4},this.BINARY_ENCODING=0,this.JSON_ENCODING=1,this.BROADCAST_EVENT="broadcast",this.allowedMetadataKeys=[],this.allowedMetadataKeys=t??[]}encode(t,r){if(t.event===this.BROADCAST_EVENT&&!(t.payload instanceof ArrayBuffer)&&typeof t.payload.event=="string")return r(this._binaryEncodeUserBroadcastPush(t));let s=[t.join_ref,t.ref,t.topic,t.event,t.payload];return r(JSON.stringify(s))}_binaryEncodeUserBroadcastPush(t){var r;return this._isArrayBuffer((r=t.payload)===null||r===void 0?void 0:r.payload)?this._encodeBinaryUserBroadcastPush(t):this._encodeJsonUserBroadcastPush(t)}_encodeBinaryUserBroadcastPush(t){var r,s;const n=(s=(r=t.payload)===null||r===void 0?void 0:r.payload)!==null&&s!==void 0?s:new ArrayBuffer(0);return this._encodeUserBroadcastPush(t,this.BINARY_ENCODING,n)}_encodeJsonUserBroadcastPush(t){var r,s;const n=(s=(r=t.payload)===null||r===void 0?void 0:r.payload)!==null&&s!==void 0?s:{},i=new TextEncoder().encode(JSON.stringify(n)).buffer;return this._encodeUserBroadcastPush(t,this.JSON_ENCODING,i)}_encodeUserBroadcastPush(t,r,s){var n,a;const i=t.topic,o=(n=t.ref)!==null&&n!==void 0?n:"",l=(a=t.join_ref)!==null&&a!==void 0?a:"",c=t.payload.event,d=this.allowedMetadataKeys?this._pick(t.payload,this.allowedMetadataKeys):{},u=Object.keys(d).length===0?"":JSON.stringify(d);if(l.length>255)throw new Error(`joinRef length ${l.length} exceeds maximum of 255`);if(o.length>255)throw new Error(`ref length ${o.length} exceeds maximum of 255`);if(i.length>255)throw new Error(`topic length ${i.length} exceeds maximum of 255`);if(c.length>255)throw new Error(`userEvent length ${c.length} exceeds maximum of 255`);if(u.length>255)throw new Error(`metadata length ${u.length} exceeds maximum of 255`);const h=this.USER_BROADCAST_PUSH_META_LENGTH+l.length+o.length+i.length+c.length+u.length,m=new ArrayBuffer(this.HEADER_LENGTH+h);let f=new DataView(m),p=0;f.setUint8(p++,this.KINDS.userBroadcastPush),f.setUint8(p++,l.length),f.setUint8(p++,o.length),f.setUint8(p++,i.length),f.setUint8(p++,c.length),f.setUint8(p++,u.length),f.setUint8(p++,r),Array.from(l,y=>f.setUint8(p++,y.charCodeAt(0))),Array.from(o,y=>f.setUint8(p++,y.charCodeAt(0))),Array.from(i,y=>f.setUint8(p++,y.charCodeAt(0))),Array.from(c,y=>f.setUint8(p++,y.charCodeAt(0))),Array.from(u,y=>f.setUint8(p++,y.charCodeAt(0)));var _=new Uint8Array(m.byteLength+s.byteLength);return _.set(new Uint8Array(m),0),_.set(new Uint8Array(s),m.byteLength),_.buffer}decode(t,r){if(this._isArrayBuffer(t)){let s=this._binaryDecode(t);return r(s)}if(typeof t=="string"){const s=JSON.parse(t),[n,a,i,o,l]=s;return r({join_ref:n,ref:a,topic:i,event:o,payload:l})}return r({})}_binaryDecode(t){const r=new DataView(t),s=r.getUint8(0),n=new TextDecoder;switch(s){case this.KINDS.userBroadcast:return this._decodeUserBroadcast(t,r,n)}}_decodeUserBroadcast(t,r,s){const n=r.getUint8(1),a=r.getUint8(2),i=r.getUint8(3),o=r.getUint8(4);let l=this.HEADER_LENGTH+4;const c=s.decode(t.slice(l,l+n));l=l+n;const d=s.decode(t.slice(l,l+a));l=l+a;const u=s.decode(t.slice(l,l+i));l=l+i;const h=t.slice(l,t.byteLength),m=o===this.JSON_ENCODING?JSON.parse(s.decode(h)):h,f={type:this.BROADCAST_EVENT,event:d,payload:m};return i>0&&(f.meta=JSON.parse(u)),{join_ref:null,ref:null,topic:c,event:this.BROADCAST_EVENT,payload:f}}_isArrayBuffer(t){var r;return t instanceof ArrayBuffer||((r=t==null?void 0:t.constructor)===null||r===void 0?void 0:r.name)==="ArrayBuffer"}_pick(t,r){return!t||typeof t!="object"?{}:Object.fromEntries(Object.entries(t).filter(([s])=>r.includes(s)))}}class wo{constructor(t,r){this.callback=t,this.timerCalc=r,this.timer=void 0,this.tries=0,this.callback=t,this.timerCalc=r}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var le;(function(e){e.abstime="abstime",e.bool="bool",e.date="date",e.daterange="daterange",e.float4="float4",e.float8="float8",e.int2="int2",e.int4="int4",e.int4range="int4range",e.int8="int8",e.int8range="int8range",e.json="json",e.jsonb="jsonb",e.money="money",e.numeric="numeric",e.oid="oid",e.reltime="reltime",e.text="text",e.time="time",e.timestamp="timestamp",e.timestamptz="timestamptz",e.timetz="timetz",e.tsrange="tsrange",e.tstzrange="tstzrange"})(le||(le={}));const Ja=(e,t,r={})=>{var s;const n=(s=r.skipTypes)!==null&&s!==void 0?s:[];return t?Object.keys(t).reduce((a,i)=>(a[i]=Vl(i,e,t,n),a),{}):{}},Vl=(e,t,r,s)=>{const n=t.find(o=>o.name===e),a=n==null?void 0:n.type,i=r[e];return a&&!s.includes(a)?ko(a,i):Dn(i)},ko=(e,t)=>{if(e.charAt(0)==="_"){const r=e.slice(1,e.length);return Yl(t,r)}switch(e){case le.bool:return Gl(t);case le.float4:case le.float8:case le.int2:case le.int4:case le.int8:case le.numeric:case le.oid:return Jl(t);case le.json:case le.jsonb:return Ql(t);case le.timestamp:return Xl(t);case le.abstime:case le.date:case le.daterange:case le.int4range:case le.int8range:case le.money:case le.reltime:case le.text:case le.time:case le.timestamptz:case le.timetz:case le.tsrange:case le.tstzrange:return Dn(t);default:return Dn(t)}},Dn=e=>e,Gl=e=>{switch(e){case"t":return!0;case"f":return!1;default:return e}},Jl=e=>{if(typeof e=="string"){const t=parseFloat(e);if(!Number.isNaN(t))return t}return e},Ql=e=>{if(typeof e=="string")try{return JSON.parse(e)}catch{return e}return e},Yl=(e,t)=>{if(typeof e!="string")return e;const r=e.length-1,s=e[r];if(e[0]==="{"&&s==="}"){let a;const i=e.slice(1,r);try{a=JSON.parse("["+i+"]")}catch{a=i?i.split(","):[]}return a.map(o=>ko(t,o))}return e},Xl=e=>typeof e=="string"?e.replace(" ","T"):e,Lo=e=>{const t=new URL(e);return t.protocol=t.protocol.replace(/^ws/i,"http"),t.pathname=t.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),t.pathname===""||t.pathname==="/"?t.pathname="/api/broadcast":t.pathname=t.pathname+"/api/broadcast",t.href};class un{constructor(t,r,s={},n=Rn){this.channel=t,this.event=r,this.payload=s,this.timeout=n,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(t){this.timeout=t,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(t){this.payload=Object.assign(Object.assign({},this.payload),t)}receive(t,r){var s;return this._hasReceived(t)&&r((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:t,callback:r}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const t=r=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=r,this._matchReceive(r)};this.channel._on(this.refEvent,{},t),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(t,r){this.refEvent&&this.channel._trigger(this.refEvent,{status:t,response:r})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:t,response:r}){this.recHooks.filter(s=>s.status===t).forEach(s=>s.callback(r))}_hasReceived(t){return this.receivedResp&&this.receivedResp.status===t}}var Qa;(function(e){e.SYNC="sync",e.JOIN="join",e.LEAVE="leave"})(Qa||(Qa={}));class jr{constructor(t,r){this.channel=t,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(r==null?void 0:r.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},n=>{const{onJoin:a,onLeave:i,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=jr.syncState(this.state,n,a,i),this.pendingDiffs.forEach(l=>{this.state=jr.syncDiff(this.state,l,a,i)}),this.pendingDiffs=[],o()}),this.channel._on(s.diff,{},n=>{const{onJoin:a,onLeave:i,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(n):(this.state=jr.syncDiff(this.state,n,a,i),o())}),this.onJoin((n,a,i)=>{this.channel._trigger("presence",{event:"join",key:n,currentPresences:a,newPresences:i})}),this.onLeave((n,a,i)=>{this.channel._trigger("presence",{event:"leave",key:n,currentPresences:a,leftPresences:i})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(t,r,s,n){const a=this.cloneDeep(t),i=this.transformState(r),o={},l={};return this.map(a,(c,d)=>{i[c]||(l[c]=d)}),this.map(i,(c,d)=>{const u=a[c];if(u){const h=d.map(_=>_.presence_ref),m=u.map(_=>_.presence_ref),f=d.filter(_=>m.indexOf(_.presence_ref)<0),p=u.filter(_=>h.indexOf(_.presence_ref)<0);f.length>0&&(o[c]=f),p.length>0&&(l[c]=p)}else o[c]=d}),this.syncDiff(a,{joins:o,leaves:l},s,n)}static syncDiff(t,r,s,n){const{joins:a,leaves:i}={joins:this.transformState(r.joins),leaves:this.transformState(r.leaves)};return s||(s=()=>{}),n||(n=()=>{}),this.map(a,(o,l)=>{var c;const d=(c=t[o])!==null&&c!==void 0?c:[];if(t[o]=this.cloneDeep(l),d.length>0){const u=t[o].map(m=>m.presence_ref),h=d.filter(m=>u.indexOf(m.presence_ref)<0);t[o].unshift(...h)}s(o,d,l)}),this.map(i,(o,l)=>{let c=t[o];if(!c)return;const d=l.map(u=>u.presence_ref);c=c.filter(u=>d.indexOf(u.presence_ref)<0),t[o]=c,n(o,c,l),c.length===0&&delete t[o]}),t}static map(t,r){return Object.getOwnPropertyNames(t).map(s=>r(s,t[s]))}static transformState(t){return t=this.cloneDeep(t),Object.getOwnPropertyNames(t).reduce((r,s)=>{const n=t[s];return"metas"in n?r[s]=n.metas.map(a=>(a.presence_ref=a.phx_ref,delete a.phx_ref,delete a.phx_ref_prev,a)):r[s]=n,r},{})}static cloneDeep(t){return JSON.parse(JSON.stringify(t))}onJoin(t){this.caller.onJoin=t}onLeave(t){this.caller.onLeave=t}onSync(t){this.caller.onSync=t}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var Ya;(function(e){e.ALL="*",e.INSERT="INSERT",e.UPDATE="UPDATE",e.DELETE="DELETE"})(Ya||(Ya={}));var Hr;(function(e){e.BROADCAST="broadcast",e.PRESENCE="presence",e.POSTGRES_CHANGES="postgres_changes",e.SYSTEM="system"})(Hr||(Hr={}));var Ze;(function(e){e.SUBSCRIBED="SUBSCRIBED",e.TIMED_OUT="TIMED_OUT",e.CLOSED="CLOSED",e.CHANNEL_ERROR="CHANNEL_ERROR"})(Ze||(Ze={}));class tr{constructor(t,r={config:{}},s){var n,a;if(this.topic=t,this.params=r,this.socket=s,this.bindings={},this.state=ge.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=t.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},r.config),this.timeout=this.socket.timeout,this.joinPush=new un(this,ze.join,this.params,this.timeout),this.rejoinTimer=new wo(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=ge.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(i=>i.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=ge.closed,this.socket._remove(this)}),this._onError(i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=ge.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=ge.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=ge.errored,this.rejoinTimer.scheduleTimeout())}),this._on(ze.reply,{},(i,o)=>{this._trigger(this._replyEventName(o),i)}),this.presence=new jr(this),this.broadcastEndpointURL=Lo(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((a=(n=this.params.config)===null||n===void 0?void 0:n.broadcast)===null||a===void 0)&&a.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(t,r=this.timeout){var s,n,a;if(this.socket.isConnected()||this.socket.connect(),this.state==ge.closed){const{config:{broadcast:i,presence:o,private:l}}=this.params,c=(n=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(m=>m.filter))!==null&&n!==void 0?n:[],d=!!this.bindings[Hr.PRESENCE]&&this.bindings[Hr.PRESENCE].length>0||((a=this.params.config.presence)===null||a===void 0?void 0:a.enabled)===!0,u={},h={broadcast:i,presence:Object.assign(Object.assign({},o),{enabled:d}),postgres_changes:c,private:l};this.socket.accessTokenValue&&(u.access_token=this.socket.accessTokenValue),this._onError(m=>t==null?void 0:t(Ze.CHANNEL_ERROR,m)),this._onClose(()=>t==null?void 0:t(Ze.CLOSED)),this.updateJoinPayload(Object.assign({config:h},u)),this.joinedOnce=!0,this._rejoin(r),this.joinPush.receive("ok",async({postgres_changes:m})=>{var f;if(this.socket._isManualToken()||this.socket.setAuth(),m===void 0){t==null||t(Ze.SUBSCRIBED);return}else{const p=this.bindings.postgres_changes,_=(f=p==null?void 0:p.length)!==null&&f!==void 0?f:0,y=[];for(let b=0;b<_;b++){const g=p[b],{filter:{event:S,schema:k,table:E,filter:L}}=g,$=m&&m[b];if($&&$.event===S&&tr.isFilterValueEqual($.schema,k)&&tr.isFilterValueEqual($.table,E)&&tr.isFilterValueEqual($.filter,L))y.push(Object.assign(Object.assign({},g),{id:$.id}));else{this.unsubscribe(),this.state=ge.errored,t==null||t(Ze.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=y,t&&t(Ze.SUBSCRIBED);return}}).receive("error",m=>{this.state=ge.errored,t==null||t(Ze.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(m).join(", ")||"error")))}).receive("timeout",()=>{t==null||t(Ze.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(t,r={}){return await this.send({type:"presence",event:"track",payload:t},r.timeout||this.timeout)}async untrack(t={}){return await this.send({type:"presence",event:"untrack"},t)}on(t,r,s){return this.state===ge.joined&&t===Hr.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(async()=>await this.subscribe())),this._on(t,r,s)}async httpSend(t,r,s={}){var n;if(r==null)return Promise.reject("Payload is required for httpSend()");const a={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(a.Authorization=`Bearer ${this.socket.accessTokenValue}`);const i={method:"POST",headers:a,body:JSON.stringify({messages:[{topic:this.subTopic,event:t,payload:r,private:this.private}]})},o=await this._fetchWithTimeout(this.broadcastEndpointURL,i,(n=s.timeout)!==null&&n!==void 0?n:this.timeout);if(o.status===202)return{success:!0};let l=o.statusText;try{const c=await o.json();l=c.error||c.message||l}catch{}return Promise.reject(new Error(l))}async send(t,r={}){var s,n;if(!this._canPush()&&t.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:a,payload:i}=t,o={apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"};this.socket.accessTokenValue&&(o.Authorization=`Bearer ${this.socket.accessTokenValue}`);const l={method:"POST",headers:o,body:JSON.stringify({messages:[{topic:this.subTopic,event:a,payload:i,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,l,(s=r.timeout)!==null&&s!==void 0?s:this.timeout);return await((n=c.body)===null||n===void 0?void 0:n.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(a=>{var i,o,l;const c=this._push(t.type,t,r.timeout||this.timeout);t.type==="broadcast"&&!(!((l=(o=(i=this.params)===null||i===void 0?void 0:i.config)===null||o===void 0?void 0:o.broadcast)===null||l===void 0)&&l.ack)&&a("ok"),c.receive("ok",()=>a("ok")),c.receive("error",()=>a("error")),c.receive("timeout",()=>a("timed out"))})}updateJoinPayload(t){this.joinPush.updatePayload(t)}unsubscribe(t=this.timeout){this.state=ge.leaving;const r=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(ze.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(n=>{s=new un(this,ze.leave,{},t),s.receive("ok",()=>{r(),n("ok")}).receive("timeout",()=>{r(),n("timed out")}).receive("error",()=>{n("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{s==null||s.destroy()})}teardown(){this.pushBuffer.forEach(t=>t.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=ge.closed,this.bindings={}}async _fetchWithTimeout(t,r,s){const n=new AbortController,a=setTimeout(()=>n.abort(),s),i=await this.socket.fetch(t,Object.assign(Object.assign({},r),{signal:n.signal}));return clearTimeout(a),i}_push(t,r,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${t}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let n=new un(this,t,r,s);return this._canPush()?n.send():this._addToPushBuffer(n),n}_addToPushBuffer(t){if(t.startTimeout(),this.pushBuffer.push(t),this.pushBuffer.length>Wl){const r=this.pushBuffer.shift();r&&(r.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${r.event}`,r.payload))}}_onMessage(t,r,s){return r}_isMember(t){return this.topic===t}_joinRef(){return this.joinPush.ref}_trigger(t,r,s){var n,a;const i=t.toLocaleLowerCase(),{close:o,error:l,leave:c,join:d}=ze;if(s&&[o,l,c,d].indexOf(i)>=0&&s!==this._joinRef())return;let h=this._onMessage(i,r,s);if(r&&!h)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(i)?(n=this.bindings.postgres_changes)===null||n===void 0||n.filter(m=>{var f,p,_;return((f=m.filter)===null||f===void 0?void 0:f.event)==="*"||((_=(p=m.filter)===null||p===void 0?void 0:p.event)===null||_===void 0?void 0:_.toLocaleLowerCase())===i}).map(m=>m.callback(h,s)):(a=this.bindings[i])===null||a===void 0||a.filter(m=>{var f,p,_,y,b,g;if(["broadcast","presence","postgres_changes"].includes(i))if("id"in m){const S=m.id,k=(f=m.filter)===null||f===void 0?void 0:f.event;return S&&((p=r.ids)===null||p===void 0?void 0:p.includes(S))&&(k==="*"||(k==null?void 0:k.toLocaleLowerCase())===((_=r.data)===null||_===void 0?void 0:_.type.toLocaleLowerCase()))}else{const S=(b=(y=m==null?void 0:m.filter)===null||y===void 0?void 0:y.event)===null||b===void 0?void 0:b.toLocaleLowerCase();return S==="*"||S===((g=r==null?void 0:r.event)===null||g===void 0?void 0:g.toLocaleLowerCase())}else return m.type.toLocaleLowerCase()===i}).map(m=>{if(typeof h=="object"&&"ids"in h){const f=h.data,{schema:p,table:_,commit_timestamp:y,type:b,errors:g}=f;h=Object.assign(Object.assign({},{schema:p,table:_,commit_timestamp:y,eventType:b,new:{},old:{},errors:g}),this._getPayloadRecords(f))}m.callback(h,s)})}_isClosed(){return this.state===ge.closed}_isJoined(){return this.state===ge.joined}_isJoining(){return this.state===ge.joining}_isLeaving(){return this.state===ge.leaving}_replyEventName(t){return`chan_reply_${t}`}_on(t,r,s){const n=t.toLocaleLowerCase(),a={type:n,filter:r,callback:s};return this.bindings[n]?this.bindings[n].push(a):this.bindings[n]=[a],this}_off(t,r){const s=t.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(n=>{var a;return!(((a=n.type)===null||a===void 0?void 0:a.toLocaleLowerCase())===s&&tr.isEqual(n.filter,r))})),this}static isEqual(t,r){if(Object.keys(t).length!==Object.keys(r).length)return!1;for(const s in t)if(t[s]!==r[s])return!1;return!0}static isFilterValueEqual(t,r){return(t??void 0)===(r??void 0)}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(t){this._on(ze.close,{},t)}_onError(t){this._on(ze.error,{},r=>t(r))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(t=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=ge.joining,this.joinPush.resend(t))}_getPayloadRecords(t){const r={new:{},old:{}};return(t.type==="INSERT"||t.type==="UPDATE")&&(r.new=Ja(t.columns,t.record)),(t.type==="UPDATE"||t.type==="DELETE")&&(r.old=Ja(t.columns,t.old_record)),r}}const hn=()=>{},ps={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Zl=[1e3,2e3,5e3,1e4],ec=1e4,tc=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class rc{constructor(t,r){var s;if(this.accessTokenValue=null,this.apiKey=null,this._manuallySetToken=!1,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Rn,this.transport=null,this.heartbeatIntervalMs=ps.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=hn,this.ref=0,this.reconnectTimer=null,this.vsn=Ga,this.logger=hn,this.conn=null,this.sendBuffer=[],this.serializer=new zl,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._heartbeatSentAt=null,this._resolveFetch=n=>n?(...a)=>n(...a):(...a)=>fetch(...a),!(!((s=r==null?void 0:r.params)===null||s===void 0)&&s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=r.params.apikey,this.endPoint=`${t}/${In.websocket}`,this.httpEndpoint=Lo(t),this._initializeOptions(r),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(r==null?void 0:r.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this.accessToken&&!this._authPromise&&this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Hl.createWebSocket(this.endpointURL())}catch(t){this._setConnectionState("disconnected");const r=t.message;throw r.includes("Node.js")?new Error(`${r}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${r}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:this.vsn}))}disconnect(t,r){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},typeof this.conn.close=="function"&&(t?this.conn.close(t,r??""):this.conn.close()),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(t){const r=await t.unsubscribe();return r==="ok"&&this._remove(t),this.channels.length===0&&this.disconnect(),r}async removeAllChannels(){const t=await Promise.all(this.channels.map(r=>r.unsubscribe()));return this.channels=[],this.disconnect(),t}log(t,r,s){this.logger(t,r,s)}connectionState(){switch(this.conn&&this.conn.readyState){case ot.connecting:return $t.Connecting;case ot.open:return $t.Open;case ot.closing:return $t.Closing;default:return $t.Closed}}isConnected(){return this.connectionState()===$t.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(t,r={config:{}}){const s=`realtime:${t}`,n=this.getChannels().find(a=>a.topic===s);if(n)return n;{const a=new tr(`realtime:${t}`,r,this);return this.channels.push(a),a}}push(t){const{topic:r,event:s,payload:n,ref:a}=t,i=()=>{this.encode(t,o=>{var l;(l=this.conn)===null||l===void 0||l.send(o)})};this.log("push",`${r} ${s} (${a})`,n),this.isConnected()?i():this.sendBuffer.push(i)}async setAuth(t=null){this._authPromise=this._performAuth(t);try{await this._authPromise}finally{this._authPromise=null}}_isManualToken(){return this._manuallySetToken}async sendHeartbeat(){var t;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(r){this.log("error","error in heartbeat callback",r)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this._heartbeatSentAt=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(r){this.log("error","error in heartbeat callback",r)}this._wasManualDisconnect=!1,(t=this.conn)===null||t===void 0||t.close(Kl,"heartbeat timeout"),setTimeout(()=>{var r;this.isConnected()||(r=this.reconnectTimer)===null||r===void 0||r.scheduleTimeout()},ps.HEARTBEAT_TIMEOUT_FALLBACK);return}this._heartbeatSentAt=Date.now(),this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(r){this.log("error","error in heartbeat callback",r)}this._setAuthSafely("heartbeat")}onHeartbeat(t){this.heartbeatCallback=t}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(t=>t()),this.sendBuffer=[])}_makeRef(){let t=this.ref+1;return t===this.ref?this.ref=0:this.ref=t,this.ref.toString()}_leaveOpenTopic(t){let r=this.channels.find(s=>s.topic===t&&(s._isJoined()||s._isJoining()));r&&(this.log("transport",`leaving duplicate topic "${t}"`),r.unsubscribe())}_remove(t){this.channels=this.channels.filter(r=>r.topic!==t.topic)}_onConnMessage(t){this.decode(t.data,r=>{if(r.topic==="phoenix"&&r.event==="phx_reply"&&r.ref&&r.ref===this.pendingHeartbeatRef){const c=this._heartbeatSentAt?Date.now()-this._heartbeatSentAt:void 0;try{this.heartbeatCallback(r.payload.status==="ok"?"ok":"error",c)}catch(d){this.log("error","error in heartbeat callback",d)}this._heartbeatSentAt=null,this.pendingHeartbeatRef=null}const{topic:s,event:n,payload:a,ref:i}=r,o=i?`(${i})`:"",l=a.status||"";this.log("receive",`${l} ${s} ${n} ${o}`.trim(),a),this.channels.filter(c=>c._isMember(s)).forEach(c=>c._trigger(n,a,i)),this._triggerStateCallbacks("message",r)})}_clearTimer(t){var r;t==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):t==="reconnect"&&((r=this.reconnectTimer)===null||r===void 0||r.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=t=>this._onConnError(t),this.conn.onmessage=t=>this._onConnMessage(t),this.conn.onclose=t=>this._onConnClose(t),this.conn.readyState===ot.open&&this._onConnOpen())}_teardownConnection(){if(this.conn){if(this.conn.readyState===ot.open||this.conn.readyState===ot.connecting)try{this.conn.close()}catch(t){this.log("error","Error closing connection",t)}this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null}this._clearAllTimers(),this._terminateWorker(),this.channels.forEach(t=>t.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),(this._authPromise||(this.accessToken&&!this.accessTokenValue?this.setAuth():Promise.resolve())).then(()=>{this.flushSendBuffer()}).catch(r=>{this.log("error","error waiting for auth on connect",r),this.flushSendBuffer()}),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const t=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(t),this.workerRef.onerror=r=>{this.log("worker","worker error",r.message),this._terminateWorker()},this.workerRef.onmessage=r=>{r.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_terminateWorker(){this.workerRef&&(this.log("worker","terminating worker"),this.workerRef.terminate(),this.workerRef=void 0)}_onConnClose(t){var r;this._setConnectionState("disconnected"),this.log("transport","close",t),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(r=this.reconnectTimer)===null||r===void 0||r.scheduleTimeout(),this._triggerStateCallbacks("close",t)}_onConnError(t){this._setConnectionState("disconnected"),this.log("transport",`${t}`),this._triggerChanError(),this._triggerStateCallbacks("error",t);try{this.heartbeatCallback("error")}catch(r){this.log("error","error in heartbeat callback",r)}}_triggerChanError(){this.channels.forEach(t=>t._trigger(ze.error))}_appendParams(t,r){if(Object.keys(r).length===0)return t;const s=t.match(/\?/)?"&":"?",n=new URLSearchParams(r);return`${t}${s}${n}`}_workerObjectUrl(t){let r;if(t)r=t;else{const s=new Blob([tc],{type:"application/javascript"});r=URL.createObjectURL(s)}return r}_setConnectionState(t,r=!1){this._connectionState=t,t==="connecting"?this._wasManualDisconnect=!1:t==="disconnecting"&&(this._wasManualDisconnect=r)}async _performAuth(t=null){let r,s=!1;if(t)r=t,s=!0;else if(this.accessToken)try{r=await this.accessToken()}catch(n){this.log("error","Error fetching access token from callback",n),r=this.accessTokenValue}else r=this.accessTokenValue;s?this._manuallySetToken=!0:this.accessToken&&(this._manuallySetToken=!1),this.accessTokenValue!=r&&(this.accessTokenValue=r,this.channels.forEach(n=>{const a={access_token:r,version:Fl};r&&n.updateJoinPayload(a),n.joinedOnce&&n._isJoined()&&n._push(ze.access_token,{access_token:r})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(t="general"){this._isManualToken()||this.setAuth().catch(r=>{this.log("error",`Error setting auth in ${t}`,r)})}_triggerStateCallbacks(t,r){try{this.stateChangeCallbacks[t].forEach(s=>{try{s(r)}catch(n){this.log("error",`error in ${t} callback`,n)}})}catch(s){this.log("error",`error triggering ${t} callbacks`,s)}}_setupReconnectionTimer(){this.reconnectTimer=new wo(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},ps.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(t){var r,s,n,a,i,o,l,c,d,u,h,m;switch(this.transport=(r=t==null?void 0:t.transport)!==null&&r!==void 0?r:null,this.timeout=(s=t==null?void 0:t.timeout)!==null&&s!==void 0?s:Rn,this.heartbeatIntervalMs=(n=t==null?void 0:t.heartbeatIntervalMs)!==null&&n!==void 0?n:ps.HEARTBEAT_INTERVAL,this.worker=(a=t==null?void 0:t.worker)!==null&&a!==void 0?a:!1,this.accessToken=(i=t==null?void 0:t.accessToken)!==null&&i!==void 0?i:null,this.heartbeatCallback=(o=t==null?void 0:t.heartbeatCallback)!==null&&o!==void 0?o:hn,this.vsn=(l=t==null?void 0:t.vsn)!==null&&l!==void 0?l:Ga,t!=null&&t.params&&(this.params=t.params),t!=null&&t.logger&&(this.logger=t.logger),(t!=null&&t.logLevel||t!=null&&t.log_level)&&(this.logLevel=t.logLevel||t.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=t==null?void 0:t.reconnectAfterMs)!==null&&c!==void 0?c:f=>Zl[f-1]||ec,this.vsn){case Bl:this.encode=(d=t==null?void 0:t.encode)!==null&&d!==void 0?d:(f,p)=>p(JSON.stringify(f)),this.decode=(u=t==null?void 0:t.decode)!==null&&u!==void 0?u:(f,p)=>p(JSON.parse(f));break;case So:this.encode=(h=t==null?void 0:t.encode)!==null&&h!==void 0?h:this.serializer.encode.bind(this.serializer),this.decode=(m=t==null?void 0:t.decode)!==null&&m!==void 0?m:this.serializer.decode.bind(this.serializer);break;default:throw new Error(`Unsupported serializer version: ${this.vsn}`)}if(this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=t==null?void 0:t.workerUrl}}}var Kr=class extends Error{constructor(e,t){var r;super(e),this.name="IcebergError",this.status=t.status,this.icebergType=t.icebergType,this.icebergCode=t.icebergCode,this.details=t.details,this.isCommitStateUnknown=t.icebergType==="CommitStateUnknownException"||[500,502,504].includes(t.status)&&((r=t.icebergType)==null?void 0:r.includes("CommitState"))===!0}isNotFound(){return this.status===404}isConflict(){return this.status===409}isAuthenticationTimeout(){return this.status===419}};function sc(e,t,r){const s=new URL(t,e);if(r)for(const[n,a]of Object.entries(r))a!==void 0&&s.searchParams.set(n,a);return s.toString()}async function nc(e){return!e||e.type==="none"?{}:e.type==="bearer"?{Authorization:`Bearer ${e.token}`}:e.type==="header"?{[e.name]:e.value}:e.type==="custom"?await e.getHeaders():{}}function ac(e){const t=e.fetchImpl??globalThis.fetch;return{async request({method:r,path:s,query:n,body:a,headers:i}){const o=sc(e.baseUrl,s,n),l=await nc(e.auth),c=await t(o,{method:r,headers:{...a?{"Content-Type":"application/json"}:{},...l,...i},body:a?JSON.stringify(a):void 0}),d=await c.text(),u=(c.headers.get("content-type")||"").includes("application/json"),h=u&&d?JSON.parse(d):d;if(!c.ok){const m=u?h:void 0,f=m==null?void 0:m.error;throw new Kr((f==null?void 0:f.message)??`Request failed with status ${c.status}`,{status:c.status,icebergType:f==null?void 0:f.type,icebergCode:f==null?void 0:f.code,details:m})}return{status:c.status,headers:c.headers,data:h}}}}function ys(e){return e.join("")}var ic=class{constructor(e,t=""){this.client=e,this.prefix=t}async listNamespaces(e){const t=e?{parent:ys(e.namespace)}:void 0;return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces`,query:t})).data.namespaces.map(s=>({namespace:s}))}async createNamespace(e,t){const r={namespace:e.namespace,properties:t==null?void 0:t.properties};return(await this.client.request({method:"POST",path:`${this.prefix}/namespaces`,body:r})).data}async dropNamespace(e){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${ys(e.namespace)}`})}async loadNamespaceMetadata(e){return{properties:(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${ys(e.namespace)}`})).data.properties}}async namespaceExists(e){try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${ys(e.namespace)}`}),!0}catch(t){if(t instanceof Kr&&t.status===404)return!1;throw t}}async createNamespaceIfNotExists(e,t){try{return await this.createNamespace(e,t)}catch(r){if(r instanceof Kr&&r.status===409)return;throw r}}};function Bt(e){return e.join("")}var oc=class{constructor(e,t="",r){this.client=e,this.prefix=t,this.accessDelegation=r}async listTables(e){return(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Bt(e.namespace)}/tables`})).data.identifiers}async createTable(e,t){const r={};return this.accessDelegation&&(r["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Bt(e.namespace)}/tables`,body:t,headers:r})).data.metadata}async updateTable(e,t){const r=await this.client.request({method:"POST",path:`${this.prefix}/namespaces/${Bt(e.namespace)}/tables/${e.name}`,body:t});return{"metadata-location":r.data["metadata-location"],metadata:r.data.metadata}}async dropTable(e,t){await this.client.request({method:"DELETE",path:`${this.prefix}/namespaces/${Bt(e.namespace)}/tables/${e.name}`,query:{purgeRequested:String((t==null?void 0:t.purge)??!1)}})}async loadTable(e){const t={};return this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation),(await this.client.request({method:"GET",path:`${this.prefix}/namespaces/${Bt(e.namespace)}/tables/${e.name}`,headers:t})).data.metadata}async tableExists(e){const t={};this.accessDelegation&&(t["X-Iceberg-Access-Delegation"]=this.accessDelegation);try{return await this.client.request({method:"HEAD",path:`${this.prefix}/namespaces/${Bt(e.namespace)}/tables/${e.name}`,headers:t}),!0}catch(r){if(r instanceof Kr&&r.status===404)return!1;throw r}}async createTableIfNotExists(e,t){try{return await this.createTable(e,t)}catch(r){if(r instanceof Kr&&r.status===409)return await this.loadTable({namespace:e.namespace,name:t.name});throw r}}},lc=class{constructor(e){var s;let t="v1";e.catalogName&&(t+=`/${e.catalogName}`);const r=e.baseUrl.endsWith("/")?e.baseUrl:`${e.baseUrl}/`;this.client=ac({baseUrl:r,auth:e.auth,fetchImpl:e.fetch}),this.accessDelegation=(s=e.accessDelegation)==null?void 0:s.join(","),this.namespaceOps=new ic(this.client,t),this.tableOps=new oc(this.client,t,this.accessDelegation)}async listNamespaces(e){return this.namespaceOps.listNamespaces(e)}async createNamespace(e,t){return this.namespaceOps.createNamespace(e,t)}async dropNamespace(e){await this.namespaceOps.dropNamespace(e)}async loadNamespaceMetadata(e){return this.namespaceOps.loadNamespaceMetadata(e)}async listTables(e){return this.tableOps.listTables(e)}async createTable(e,t){return this.tableOps.createTable(e,t)}async updateTable(e,t){return this.tableOps.updateTable(e,t)}async dropTable(e,t){await this.tableOps.dropTable(e,t)}async loadTable(e){return this.tableOps.loadTable(e)}async namespaceExists(e){return this.namespaceOps.namespaceExists(e)}async tableExists(e){return this.tableOps.tableExists(e)}async createNamespaceIfNotExists(e,t){return this.namespaceOps.createNamespaceIfNotExists(e,t)}async createTableIfNotExists(e,t){return this.tableOps.createTableIfNotExists(e,t)}},Xs=class extends Error{constructor(e,t="storage",r,s){super(e),this.__isStorageError=!0,this.namespace=t,this.name=t==="vectors"?"StorageVectorsError":"StorageError",this.status=r,this.statusCode=s}};function Zs(e){return typeof e=="object"&&e!==null&&"__isStorageError"in e}var gs=class extends Xs{constructor(e,t,r,s="storage"){super(e,s,t,r),this.name=s==="vectors"?"StorageVectorsApiError":"StorageApiError",this.status=t,this.statusCode=r}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}},qo=class extends Xs{constructor(e,t,r="storage"){super(e,r),this.name=r==="vectors"?"StorageVectorsUnknownError":"StorageUnknownError",this.originalError=t}};const cc=e=>e?(...t)=>e(...t):(...t)=>fetch(...t),dc=e=>{if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},On=e=>{if(Array.isArray(e))return e.map(r=>On(r));if(typeof e=="function"||e!==Object(e))return e;const t={};return Object.entries(e).forEach(([r,s])=>{const n=r.replace(/([-_][a-z])/gi,a=>a.toUpperCase().replace(/[-_]/g,""));t[n]=On(s)}),t},uc=e=>!e||typeof e!="string"||e.length===0||e.length>100||e.trim()!==e||e.includes("/")||e.includes("\\")?!1:/^[\w!.\*'() &$@=;:+,?-]+$/.test(e);function Wr(e){"@babel/helpers - typeof";return Wr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Wr(e)}function hc(e,t){if(Wr(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var s=r.call(e,t);if(Wr(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function fc(e){var t=hc(e,"string");return Wr(t)=="symbol"?t:t+""}function mc(e,t,r){return(t=fc(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Xa(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,s)}return r}function X(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?Xa(Object(r),!0).forEach(function(s){mc(e,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Xa(Object(r)).forEach(function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s))})}return e}const Za=e=>{var t;return e.msg||e.message||e.error_description||(typeof e.error=="string"?e.error:(t=e.error)===null||t===void 0?void 0:t.message)||JSON.stringify(e)},pc=async(e,t,r,s)=>{if(e&&typeof e=="object"&&"status"in e&&"ok"in e&&typeof e.status=="number"&&!(r!=null&&r.noResolveJson)){const n=e,a=n.status||500;if(typeof n.json=="function")n.json().then(i=>{const o=(i==null?void 0:i.statusCode)||(i==null?void 0:i.code)||a+"";t(new gs(Za(i),a,o,s))}).catch(()=>{if(s==="vectors"){const i=a+"";t(new gs(n.statusText||`HTTP ${a} error`,a,i,s))}else{const i=a+"";t(new gs(n.statusText||`HTTP ${a} error`,a,i,s))}});else{const i=a+"";t(new gs(n.statusText||`HTTP ${a} error`,a,i,s))}}else t(new qo(Za(e),e,s))},yc=(e,t,r,s)=>{const n={method:e,headers:(t==null?void 0:t.headers)||{}};return e==="GET"||e==="HEAD"||!s?X(X({},n),r):(dc(s)?(n.headers=X({"Content-Type":"application/json"},t==null?void 0:t.headers),n.body=JSON.stringify(s)):n.body=s,t!=null&&t.duplex&&(n.duplex=t.duplex),X(X({},n),r))};async function wr(e,t,r,s,n,a,i){return new Promise((o,l)=>{e(r,yc(t,s,n,a)).then(c=>{if(!c.ok)throw c;if(s!=null&&s.noResolveJson)return c;if(i==="vectors"){const d=c.headers.get("content-type");if(c.headers.get("content-length")==="0"||c.status===204)return{};if(!d||!d.includes("application/json"))return{}}return c.json()}).then(c=>o(c)).catch(c=>pc(c,l,s,i))})}function To(e="storage"){return{get:async(t,r,s,n)=>wr(t,"GET",r,s,n,void 0,e),post:async(t,r,s,n,a)=>wr(t,"POST",r,n,a,s,e),put:async(t,r,s,n,a)=>wr(t,"PUT",r,n,a,s,e),head:async(t,r,s,n)=>wr(t,"HEAD",r,X(X({},s),{},{noResolveJson:!0}),n,void 0,e),remove:async(t,r,s,n,a)=>wr(t,"DELETE",r,n,a,s,e)}}const gc=To("storage"),{get:zr,post:We,put:Pn,head:vc,remove:ya}=gc,Me=To("vectors");var _r=class{constructor(e,t={},r,s="storage"){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.fetch=cc(r),this.namespace=s}throwOnError(){return this.shouldThrowOnError=!0,this}async handleOperation(e){var t=this;try{return{data:await e(),error:null}}catch(r){if(t.shouldThrowOnError)throw r;if(Zs(r))return{data:null,error:r};throw r}}},bc=class{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t}then(e,t){return this.execute().then(e,t)}async execute(){var e=this;try{return{data:(await e.downloadFn()).body,error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Zs(t))return{data:null,error:t};throw t}}};let Eo;Eo=Symbol.toStringTag;var _c=class{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t,this[Eo]="BlobDownloadBuilder",this.promise=null}asStream(){return new bc(this.downloadFn,this.shouldThrowOnError)}then(e,t){return this.getPromise().then(e,t)}catch(e){return this.getPromise().catch(e)}finally(e){return this.getPromise().finally(e)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}async execute(){var e=this;try{return{data:await(await e.downloadFn()).blob(),error:null}}catch(t){if(e.shouldThrowOnError)throw t;if(Zs(t))return{data:null,error:t};throw t}}};const Sc={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},ei={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};var wc=class extends _r{constructor(e,t={},r,s){super(e,t,s,"storage"),this.bucketId=r}async uploadOrUpdate(e,t,r,s){var n=this;return n.handleOperation(async()=>{let a;const i=X(X({},ei),s);let o=X(X({},n.headers),e==="POST"&&{"x-upsert":String(i.upsert)});const l=i.metadata;typeof Blob<"u"&&r instanceof Blob?(a=new FormData,a.append("cacheControl",i.cacheControl),l&&a.append("metadata",n.encodeMetadata(l)),a.append("",r)):typeof FormData<"u"&&r instanceof FormData?(a=r,a.has("cacheControl")||a.append("cacheControl",i.cacheControl),l&&!a.has("metadata")&&a.append("metadata",n.encodeMetadata(l))):(a=r,o["cache-control"]=`max-age=${i.cacheControl}`,o["content-type"]=i.contentType,l&&(o["x-metadata"]=n.toBase64(n.encodeMetadata(l))),(typeof ReadableStream<"u"&&a instanceof ReadableStream||a&&typeof a=="object"&&"pipe"in a&&typeof a.pipe=="function")&&!i.duplex&&(i.duplex="half")),s!=null&&s.headers&&(o=X(X({},o),s.headers));const c=n._removeEmptyFolders(t),d=n._getFinalPath(c),u=await(e=="PUT"?Pn:We)(n.fetch,`${n.url}/object/${d}`,a,X({headers:o},i!=null&&i.duplex?{duplex:i.duplex}:{}));return{path:c,id:u.Id,fullPath:u.Key}})}async upload(e,t,r){return this.uploadOrUpdate("POST",e,t,r)}async uploadToSignedUrl(e,t,r,s){var n=this;const a=n._removeEmptyFolders(e),i=n._getFinalPath(a),o=new URL(n.url+`/object/upload/sign/${i}`);return o.searchParams.set("token",t),n.handleOperation(async()=>{let l;const c=X({upsert:ei.upsert},s),d=X(X({},n.headers),{"x-upsert":String(c.upsert)});return typeof Blob<"u"&&r instanceof Blob?(l=new FormData,l.append("cacheControl",c.cacheControl),l.append("",r)):typeof FormData<"u"&&r instanceof FormData?(l=r,l.append("cacheControl",c.cacheControl)):(l=r,d["cache-control"]=`max-age=${c.cacheControl}`,d["content-type"]=c.contentType),{path:a,fullPath:(await Pn(n.fetch,o.toString(),l,{headers:d})).Key}})}async createSignedUploadUrl(e,t){var r=this;return r.handleOperation(async()=>{let s=r._getFinalPath(e);const n=X({},r.headers);t!=null&&t.upsert&&(n["x-upsert"]="true");const a=await We(r.fetch,`${r.url}/object/upload/sign/${s}`,{},{headers:n}),i=new URL(r.url+a.url),o=i.searchParams.get("token");if(!o)throw new Xs("No token returned by API");return{signedUrl:i.toString(),path:e,token:o}})}async update(e,t,r){return this.uploadOrUpdate("PUT",e,t,r)}async move(e,t,r){var s=this;return s.handleOperation(async()=>await We(s.fetch,`${s.url}/object/move`,{bucketId:s.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r==null?void 0:r.destinationBucket},{headers:s.headers}))}async copy(e,t,r){var s=this;return s.handleOperation(async()=>({path:(await We(s.fetch,`${s.url}/object/copy`,{bucketId:s.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r==null?void 0:r.destinationBucket},{headers:s.headers})).Key}))}async createSignedUrl(e,t,r){var s=this;return s.handleOperation(async()=>{let n=s._getFinalPath(e),a=await We(s.fetch,`${s.url}/object/sign/${n}`,X({expiresIn:t},r!=null&&r.transform?{transform:r.transform}:{}),{headers:s.headers});const i=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return{signedUrl:encodeURI(`${s.url}${a.signedURL}${i}`)}})}async createSignedUrls(e,t,r){var s=this;return s.handleOperation(async()=>{const n=await We(s.fetch,`${s.url}/object/sign/${s.bucketId}`,{expiresIn:t,paths:e},{headers:s.headers}),a=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return n.map(i=>X(X({},i),{},{signedUrl:i.signedURL?encodeURI(`${s.url}${i.signedURL}${a}`):null}))})}download(e,t,r){const s=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",n=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),a=n?`?${n}`:"",i=this._getFinalPath(e),o=()=>zr(this.fetch,`${this.url}/${s}/${i}${a}`,{headers:this.headers,noResolveJson:!0},r);return new _c(o,this.shouldThrowOnError)}async info(e){var t=this;const r=t._getFinalPath(e);return t.handleOperation(async()=>On(await zr(t.fetch,`${t.url}/object/info/${r}`,{headers:t.headers})))}async exists(e){var t=this;const r=t._getFinalPath(e);try{return await vc(t.fetch,`${t.url}/object/${r}`,{headers:t.headers}),{data:!0,error:null}}catch(s){if(t.shouldThrowOnError)throw s;if(Zs(s)&&s instanceof qo){const n=s.originalError;if([400,404].includes(n==null?void 0:n.status))return{data:!1,error:s}}throw s}}getPublicUrl(e,t){const r=this._getFinalPath(e),s=[],n=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";n!==""&&s.push(n);const a=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});i!==""&&s.push(i);let o=s.join("&");return o!==""&&(o=`?${o}`),{data:{publicUrl:encodeURI(`${this.url}/${a}/public/${r}${o}`)}}}async remove(e){var t=this;return t.handleOperation(async()=>await ya(t.fetch,`${t.url}/object/${t.bucketId}`,{prefixes:e},{headers:t.headers}))}async list(e,t,r){var s=this;return s.handleOperation(async()=>{const n=X(X(X({},Sc),t),{},{prefix:e||""});return await We(s.fetch,`${s.url}/object/list/${s.bucketId}`,n,{headers:s.headers},r)})}async listV2(e,t){var r=this;return r.handleOperation(async()=>{const s=X({},e);return await We(r.fetch,`${r.url}/object/list-v2/${r.bucketId}`,s,{headers:r.headers},t)})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}};const kc="2.95.3",ls={"X-Client-Info":`storage-js/${kc}`};var Lc=class extends _r{constructor(e,t={},r,s){const n=new URL(e);s!=null&&s.useNewHostname&&/supabase\.(co|in|red)$/.test(n.hostname)&&!n.hostname.includes("storage.supabase.")&&(n.hostname=n.hostname.replace("supabase.","storage.supabase."));const a=n.href.replace(/\/$/,""),i=X(X({},ls),t);super(a,i,r,"storage")}async listBuckets(e){var t=this;return t.handleOperation(async()=>{const r=t.listBucketOptionsToQueryString(e);return await zr(t.fetch,`${t.url}/bucket${r}`,{headers:t.headers})})}async getBucket(e){var t=this;return t.handleOperation(async()=>await zr(t.fetch,`${t.url}/bucket/${e}`,{headers:t.headers}))}async createBucket(e,t={public:!1}){var r=this;return r.handleOperation(async()=>await We(r.fetch,`${r.url}/bucket`,{id:e,name:e,type:t.type,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:r.headers}))}async updateBucket(e,t){var r=this;return r.handleOperation(async()=>await Pn(r.fetch,`${r.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:r.headers}))}async emptyBucket(e){var t=this;return t.handleOperation(async()=>await We(t.fetch,`${t.url}/bucket/${e}/empty`,{},{headers:t.headers}))}async deleteBucket(e){var t=this;return t.handleOperation(async()=>await ya(t.fetch,`${t.url}/bucket/${e}`,{},{headers:t.headers}))}listBucketOptionsToQueryString(e){const t={};return e&&("limit"in e&&(t.limit=String(e.limit)),"offset"in e&&(t.offset=String(e.offset)),e.search&&(t.search=e.search),e.sortColumn&&(t.sortColumn=e.sortColumn),e.sortOrder&&(t.sortOrder=e.sortOrder)),Object.keys(t).length>0?"?"+new URLSearchParams(t).toString():""}},qc=class extends _r{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=X(X({},ls),t);super(s,n,r,"storage")}async createBucket(e){var t=this;return t.handleOperation(async()=>await We(t.fetch,`${t.url}/bucket`,{name:e},{headers:t.headers}))}async listBuckets(e){var t=this;return t.handleOperation(async()=>{const r=new URLSearchParams;(e==null?void 0:e.limit)!==void 0&&r.set("limit",e.limit.toString()),(e==null?void 0:e.offset)!==void 0&&r.set("offset",e.offset.toString()),e!=null&&e.sortColumn&&r.set("sortColumn",e.sortColumn),e!=null&&e.sortOrder&&r.set("sortOrder",e.sortOrder),e!=null&&e.search&&r.set("search",e.search);const s=r.toString(),n=s?`${t.url}/bucket?${s}`:`${t.url}/bucket`;return await zr(t.fetch,n,{headers:t.headers})})}async deleteBucket(e){var t=this;return t.handleOperation(async()=>await ya(t.fetch,`${t.url}/bucket/${e}`,{},{headers:t.headers}))}from(e){var t=this;if(!uc(e))throw new Xs("Invalid bucket name: File, folder, and bucket names must follow AWS object key naming guidelines and should avoid the use of any other characters.");const r=new lc({baseUrl:this.url,catalogName:e,auth:{type:"custom",getHeaders:async()=>t.headers},fetch:this.fetch}),s=this.shouldThrowOnError;return new Proxy(r,{get(n,a){const i=n[a];return typeof i!="function"?i:async(...o)=>{try{return{data:await i.apply(n,o),error:null}}catch(l){if(s)throw l;return{data:null,error:l}}}}})}},Tc=class extends _r{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=X(X({},ls),{},{"Content-Type":"application/json"},t);super(s,n,r,"vectors")}async createIndex(e){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/CreateIndex`,e,{headers:t.headers})||{})}async getIndex(e,t){var r=this;return r.handleOperation(async()=>await Me.post(r.fetch,`${r.url}/GetIndex`,{vectorBucketName:e,indexName:t},{headers:r.headers}))}async listIndexes(e){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/ListIndexes`,e,{headers:t.headers}))}async deleteIndex(e,t){var r=this;return r.handleOperation(async()=>await Me.post(r.fetch,`${r.url}/DeleteIndex`,{vectorBucketName:e,indexName:t},{headers:r.headers})||{})}},Ec=class extends _r{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=X(X({},ls),{},{"Content-Type":"application/json"},t);super(s,n,r,"vectors")}async putVectors(e){var t=this;if(e.vectors.length<1||e.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/PutVectors`,e,{headers:t.headers})||{})}async getVectors(e){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/GetVectors`,e,{headers:t.headers}))}async listVectors(e){var t=this;if(e.segmentCount!==void 0){if(e.segmentCount<1||e.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(e.segmentIndex!==void 0&&(e.segmentIndex<0||e.segmentIndex>=e.segmentCount))throw new Error(`segmentIndex must be between 0 and ${e.segmentCount-1}`)}return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/ListVectors`,e,{headers:t.headers}))}async queryVectors(e){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/QueryVectors`,e,{headers:t.headers}))}async deleteVectors(e){var t=this;if(e.keys.length<1||e.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/DeleteVectors`,e,{headers:t.headers})||{})}},$c=class extends _r{constructor(e,t={},r){const s=e.replace(/\/$/,""),n=X(X({},ls),{},{"Content-Type":"application/json"},t);super(s,n,r,"vectors")}async createBucket(e){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/CreateVectorBucket`,{vectorBucketName:e},{headers:t.headers})||{})}async getBucket(e){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/GetVectorBucket`,{vectorBucketName:e},{headers:t.headers}))}async listBuckets(e={}){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/ListVectorBuckets`,e,{headers:t.headers}))}async deleteBucket(e){var t=this;return t.handleOperation(async()=>await Me.post(t.fetch,`${t.url}/DeleteVectorBucket`,{vectorBucketName:e},{headers:t.headers})||{})}},Ac=class extends $c{constructor(e,t={}){super(e,t.headers||{},t.fetch)}from(e){return new xc(this.url,this.headers,e,this.fetch)}async createBucket(e){var t=()=>super.createBucket,r=this;return t().call(r,e)}async getBucket(e){var t=()=>super.getBucket,r=this;return t().call(r,e)}async listBuckets(e={}){var t=()=>super.listBuckets,r=this;return t().call(r,e)}async deleteBucket(e){var t=()=>super.deleteBucket,r=this;return t().call(r,e)}},xc=class extends Tc{constructor(e,t,r,s){super(e,t,s),this.vectorBucketName=r}async createIndex(e){var t=()=>super.createIndex,r=this;return t().call(r,X(X({},e),{},{vectorBucketName:r.vectorBucketName}))}async listIndexes(e={}){var t=()=>super.listIndexes,r=this;return t().call(r,X(X({},e),{},{vectorBucketName:r.vectorBucketName}))}async getIndex(e){var t=()=>super.getIndex,r=this;return t().call(r,r.vectorBucketName,e)}async deleteIndex(e){var t=()=>super.deleteIndex,r=this;return t().call(r,r.vectorBucketName,e)}index(e){return new Cc(this.url,this.headers,this.vectorBucketName,e,this.fetch)}},Cc=class extends Ec{constructor(e,t,r,s,n){super(e,t,n),this.vectorBucketName=r,this.indexName=s}async putVectors(e){var t=()=>super.putVectors,r=this;return t().call(r,X(X({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async getVectors(e){var t=()=>super.getVectors,r=this;return t().call(r,X(X({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async listVectors(e={}){var t=()=>super.listVectors,r=this;return t().call(r,X(X({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async queryVectors(e){var t=()=>super.queryVectors,r=this;return t().call(r,X(X({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}async deleteVectors(e){var t=()=>super.deleteVectors,r=this;return t().call(r,X(X({},e),{},{vectorBucketName:r.vectorBucketName,indexName:r.indexName}))}},Rc=class extends Lc{constructor(e,t={},r,s){super(e,t,r,s)}from(e){return new wc(this.url,this.headers,e,this.fetch)}get vectors(){return new Ac(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new qc(this.url+"/iceberg",this.headers,this.fetch)}};const $o="2.95.3",Yt=30*1e3,Mn=3,fn=Mn*Yt,Ic="http://localhost:9999",Dc="supabase.auth.token",Oc={"X-Client-Info":`gotrue-js/${$o}`},Nn="X-Supabase-Api-Version",Ao={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Pc=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Mc=10*60*1e3;class Vr extends Error{constructor(t,r,s){super(t),this.__isAuthError=!0,this.name="AuthError",this.status=r,this.code=s}}function V(e){return typeof e=="object"&&e!==null&&"__isAuthError"in e}class Nc extends Vr{constructor(t,r,s){super(t,r,s),this.name="AuthApiError",this.status=r,this.code=s}}function jc(e){return V(e)&&e.name==="AuthApiError"}class At extends Vr{constructor(t,r){super(t),this.name="AuthUnknownError",this.originalError=r}}class at extends Vr{constructor(t,r,s,n){super(t,s,n),this.name=r,this.status=s}}class De extends at{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function mn(e){return V(e)&&e.name==="AuthSessionMissingError"}class Kt extends at{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class vs extends at{constructor(t){super(t,"AuthInvalidCredentialsError",400,void 0)}}class bs extends at{constructor(t,r=null){super(t,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=r}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Hc(e){return V(e)&&e.name==="AuthImplicitGrantRedirectError"}class ti extends at{constructor(t,r=null){super(t,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=r}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Uc extends at{constructor(){super("PKCE code verifier not found in storage. This can happen if the auth flow was initiated in a different browser or device, or if the storage was cleared. For SSR frameworks (Next.js, SvelteKit, etc.), use @supabase/ssr on both the server and client to store the code verifier in cookies.","AuthPKCECodeVerifierMissingError",400,"pkce_code_verifier_not_found")}}class jn extends at{constructor(t,r){super(t,"AuthRetryableFetchError",r,void 0)}}function pn(e){return V(e)&&e.name==="AuthRetryableFetchError"}class ri extends at{constructor(t,r,s){super(t,"AuthWeakPasswordError",r,"weak_password"),this.reasons=s}}class Hn extends at{constructor(t){super(t,"AuthInvalidJwtError",400,"invalid_jwt")}}const js="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),si=` 	
\r=`.split(""),Fc=(()=>{const e=new Array(128);for(let t=0;t<e.length;t+=1)e[t]=-1;for(let t=0;t<si.length;t+=1)e[si[t].charCodeAt(0)]=-2;for(let t=0;t<js.length;t+=1)e[js[t].charCodeAt(0)]=t;return e})();function ni(e,t,r){if(e!==null)for(t.queue=t.queue<<8|e,t.queuedBits+=8;t.queuedBits>=6;){const s=t.queue>>t.queuedBits-6&63;r(js[s]),t.queuedBits-=6}else if(t.queuedBits>0)for(t.queue=t.queue<<6-t.queuedBits,t.queuedBits=6;t.queuedBits>=6;){const s=t.queue>>t.queuedBits-6&63;r(js[s]),t.queuedBits-=6}}function xo(e,t,r){const s=Fc[e];if(s>-1)for(t.queue=t.queue<<6|s,t.queuedBits+=6;t.queuedBits>=8;)r(t.queue>>t.queuedBits-8&255),t.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(e)}"`)}}function ai(e){const t=[],r=i=>{t.push(String.fromCodePoint(i))},s={utf8seq:0,codepoint:0},n={queue:0,queuedBits:0},a=i=>{Wc(i,s,r)};for(let i=0;i<e.length;i+=1)xo(e.charCodeAt(i),n,a);return t.join("")}function Bc(e,t){if(e<=127){t(e);return}else if(e<=2047){t(192|e>>6),t(128|e&63);return}else if(e<=65535){t(224|e>>12),t(128|e>>6&63),t(128|e&63);return}else if(e<=1114111){t(240|e>>18),t(128|e>>12&63),t(128|e>>6&63),t(128|e&63);return}throw new Error(`Unrecognized Unicode codepoint: ${e.toString(16)}`)}function Kc(e,t){for(let r=0;r<e.length;r+=1){let s=e.charCodeAt(r);if(s>55295&&s<=56319){const n=(s-55296)*1024&65535;s=(e.charCodeAt(r+1)-56320&65535|n)+65536,r+=1}Bc(s,t)}}function Wc(e,t,r){if(t.utf8seq===0){if(e<=127){r(e);return}for(let s=1;s<6;s+=1)if(!(e>>7-s&1)){t.utf8seq=s;break}if(t.utf8seq===2)t.codepoint=e&31;else if(t.utf8seq===3)t.codepoint=e&15;else if(t.utf8seq===4)t.codepoint=e&7;else throw new Error("Invalid UTF-8 sequence");t.utf8seq-=1}else if(t.utf8seq>0){if(e<=127)throw new Error("Invalid UTF-8 sequence");t.codepoint=t.codepoint<<6|e&63,t.utf8seq-=1,t.utf8seq===0&&r(t.codepoint)}}function ur(e){const t=[],r={queue:0,queuedBits:0},s=n=>{t.push(n)};for(let n=0;n<e.length;n+=1)xo(e.charCodeAt(n),r,s);return new Uint8Array(t)}function zc(e){const t=[];return Kc(e,r=>t.push(r)),new Uint8Array(t)}function Ot(e){const t=[],r={queue:0,queuedBits:0},s=n=>{t.push(n)};return e.forEach(n=>ni(n,r,s)),ni(null,r,s),t.join("")}function Vc(e){return Math.round(Date.now()/1e3)+e}function Gc(){return Symbol("auth-callback")}const qe=()=>typeof window<"u"&&typeof document<"u",wt={tested:!1,writable:!1},Co=()=>{if(!qe())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(wt.tested)return wt.writable;const e=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(e,e),globalThis.localStorage.removeItem(e),wt.tested=!0,wt.writable=!0}catch{wt.tested=!0,wt.writable=!1}return wt.writable};function Jc(e){const t={},r=new URL(e);if(r.hash&&r.hash[0]==="#")try{new URLSearchParams(r.hash.substring(1)).forEach((n,a)=>{t[a]=n})}catch{}return r.searchParams.forEach((s,n)=>{t[n]=s}),t}const Ro=e=>e?(...t)=>e(...t):(...t)=>fetch(...t),Qc=e=>typeof e=="object"&&e!==null&&"status"in e&&"ok"in e&&"json"in e&&typeof e.json=="function",Xt=async(e,t,r)=>{await e.setItem(t,JSON.stringify(r))},kt=async(e,t)=>{const r=await e.getItem(t);if(!r)return null;try{return JSON.parse(r)}catch{return r}},Le=async(e,t)=>{await e.removeItem(t)};class en{constructor(){this.promise=new en.promiseConstructor((t,r)=>{this.resolve=t,this.reject=r})}}en.promiseConstructor=Promise;function _s(e){const t=e.split(".");if(t.length!==3)throw new Hn("Invalid JWT structure");for(let s=0;s<t.length;s++)if(!Pc.test(t[s]))throw new Hn("JWT not in base64url format");return{header:JSON.parse(ai(t[0])),payload:JSON.parse(ai(t[1])),signature:ur(t[2]),raw:{header:t[0],payload:t[1]}}}async function Yc(e){return await new Promise(t=>{setTimeout(()=>t(null),e)})}function Xc(e,t){return new Promise((s,n)=>{(async()=>{for(let a=0;a<1/0;a++)try{const i=await e(a);if(!t(a,null,i)){s(i);return}}catch(i){if(!t(a,i)){n(i);return}}})()})}function Zc(e){return("0"+e.toString(16)).substr(-2)}function ed(){const t=new Uint32Array(56);if(typeof crypto>"u"){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=r.length;let n="";for(let a=0;a<56;a++)n+=r.charAt(Math.floor(Math.random()*s));return n}return crypto.getRandomValues(t),Array.from(t,Zc).join("")}async function td(e){const r=new TextEncoder().encode(e),s=await crypto.subtle.digest("SHA-256",r),n=new Uint8Array(s);return Array.from(n).map(a=>String.fromCharCode(a)).join("")}async function rd(e){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),e;const r=await td(e);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Wt(e,t,r=!1){const s=ed();let n=s;r&&(n+="/PASSWORD_RECOVERY"),await Xt(e,`${t}-code-verifier`,n);const a=await rd(s);return[a,s===a?"plain":"s256"]}const sd=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function nd(e){const t=e.headers.get(Nn);if(!t||!t.match(sd))return null;try{return new Date(`${t}T00:00:00.0Z`)}catch{return null}}function ad(e){if(!e)throw new Error("Missing exp claim");const t=Math.floor(Date.now()/1e3);if(e<=t)throw new Error("JWT has expired")}function id(e){switch(e){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const od=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function zt(e){if(!od.test(e))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function yn(){const e={};return new Proxy(e,{get:(t,r)=>{if(r==="__isUserNotAvailableProxy")return!0;if(typeof r=="symbol"){const s=r.toString();if(s==="Symbol(Symbol.toPrimitive)"||s==="Symbol(Symbol.toStringTag)"||s==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${r}" property of the session object is not supported. Please use getUser() instead.`)},set:(t,r)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${r}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(t,r)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${r}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function ld(e,t){return new Proxy(e,{get:(r,s,n)=>{if(s==="__isInsecureUserWarningProxy")return!0;if(typeof s=="symbol"){const a=s.toString();if(a==="Symbol(Symbol.toPrimitive)"||a==="Symbol(Symbol.toStringTag)"||a==="Symbol(util.inspect.custom)"||a==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(r,s,n)}return!t.value&&typeof s=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),t.value=!0),Reflect.get(r,s,n)}})}function ii(e){return JSON.parse(JSON.stringify(e))}const Lt=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),cd=[502,503,504];async function oi(e){var t;if(!Qc(e))throw new jn(Lt(e),0);if(cd.includes(e.status))throw new jn(Lt(e),e.status);let r;try{r=await e.json()}catch(a){throw new At(Lt(a),a)}let s;const n=nd(e);if(n&&n.getTime()>=Ao["2024-01-01"].timestamp&&typeof r=="object"&&r&&typeof r.code=="string"?s=r.code:typeof r=="object"&&r&&typeof r.error_code=="string"&&(s=r.error_code),s){if(s==="weak_password")throw new ri(Lt(r),e.status,((t=r.weak_password)===null||t===void 0?void 0:t.reasons)||[]);if(s==="session_not_found")throw new De}else if(typeof r=="object"&&r&&typeof r.weak_password=="object"&&r.weak_password&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.reasons.reduce((a,i)=>a&&typeof i=="string",!0))throw new ri(Lt(r),e.status,r.weak_password.reasons);throw new Nc(Lt(r),e.status||500,s)}const dd=(e,t,r,s)=>{const n={method:e,headers:(t==null?void 0:t.headers)||{}};return e==="GET"?n:(n.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},t==null?void 0:t.headers),n.body=JSON.stringify(s),Object.assign(Object.assign({},n),r))};async function Q(e,t,r,s){var n;const a=Object.assign({},s==null?void 0:s.headers);a[Nn]||(a[Nn]=Ao["2024-01-01"].name),s!=null&&s.jwt&&(a.Authorization=`Bearer ${s.jwt}`);const i=(n=s==null?void 0:s.query)!==null&&n!==void 0?n:{};s!=null&&s.redirectTo&&(i.redirect_to=s.redirectTo);const o=Object.keys(i).length?"?"+new URLSearchParams(i).toString():"",l=await ud(e,t,r+o,{headers:a,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(l):{data:Object.assign({},l),error:null}}async function ud(e,t,r,s,n,a){const i=dd(t,s,n,a);let o;try{o=await e(r,Object.assign({},i))}catch(l){throw console.error(l),new jn(Lt(l),0)}if(o.ok||await oi(o),s!=null&&s.noResolveJson)return o;try{return await o.json()}catch(l){await oi(l)}}function Ke(e){var t;let r=null;md(e)&&(r=Object.assign({},e),e.expires_at||(r.expires_at=Vc(e.expires_in)));const s=(t=e.user)!==null&&t!==void 0?t:e;return{data:{session:r,user:s},error:null}}function li(e){const t=Ke(e);return!t.error&&e.weak_password&&typeof e.weak_password=="object"&&Array.isArray(e.weak_password.reasons)&&e.weak_password.reasons.length&&e.weak_password.message&&typeof e.weak_password.message=="string"&&e.weak_password.reasons.reduce((r,s)=>r&&typeof s=="string",!0)&&(t.data.weak_password=e.weak_password),t}function mt(e){var t;return{data:{user:(t=e.user)!==null&&t!==void 0?t:e},error:null}}function hd(e){return{data:e,error:null}}function fd(e){const{action_link:t,email_otp:r,hashed_token:s,redirect_to:n,verification_type:a}=e,i=Ys(e,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:t,email_otp:r,hashed_token:s,redirect_to:n,verification_type:a},l=Object.assign({},i);return{data:{properties:o,user:l},error:null}}function ci(e){return e}function md(e){return e.access_token&&e.refresh_token&&e.expires_in}const gn=["global","local","others"];class pd{constructor({url:t="",headers:r={},fetch:s}){this.url=t,this.headers=r,this.fetch=Ro(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(t,r=gn[0]){if(gn.indexOf(r)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${gn.join(", ")}`);try{return await Q(this.fetch,"POST",`${this.url}/logout?scope=${r}`,{headers:this.headers,jwt:t,noResolveJson:!0}),{data:null,error:null}}catch(s){if(V(s))return{data:null,error:s};throw s}}async inviteUserByEmail(t,r={}){try{return await Q(this.fetch,"POST",`${this.url}/invite`,{body:{email:t,data:r.data},headers:this.headers,redirectTo:r.redirectTo,xform:mt})}catch(s){if(V(s))return{data:{user:null},error:s};throw s}}async generateLink(t){try{const{options:r}=t,s=Ys(t,["options"]),n=Object.assign(Object.assign({},s),r);return"newEmail"in s&&(n.new_email=s==null?void 0:s.newEmail,delete n.newEmail),await Q(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:n,headers:this.headers,xform:fd,redirectTo:r==null?void 0:r.redirectTo})}catch(r){if(V(r))return{data:{properties:null,user:null},error:r};throw r}}async createUser(t){try{return await Q(this.fetch,"POST",`${this.url}/admin/users`,{body:t,headers:this.headers,xform:mt})}catch(r){if(V(r))return{data:{user:null},error:r};throw r}}async listUsers(t){var r,s,n,a,i,o,l;try{const c={nextPage:null,lastPage:0,total:0},d=await Q(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(r=t==null?void 0:t.page)===null||r===void 0?void 0:r.toString())!==null&&s!==void 0?s:"",per_page:(a=(n=t==null?void 0:t.perPage)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:""},xform:ci});if(d.error)throw d.error;const u=await d.json(),h=(i=d.headers.get("x-total-count"))!==null&&i!==void 0?i:0,m=(l=(o=d.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&l!==void 0?l:[];return m.length>0&&(m.forEach(f=>{const p=parseInt(f.split(";")[0].split("=")[1].substring(0,1)),_=JSON.parse(f.split(";")[1].split("=")[1]);c[`${_}Page`]=p}),c.total=parseInt(h)),{data:Object.assign(Object.assign({},u),c),error:null}}catch(c){if(V(c))return{data:{users:[]},error:c};throw c}}async getUserById(t){zt(t);try{return await Q(this.fetch,"GET",`${this.url}/admin/users/${t}`,{headers:this.headers,xform:mt})}catch(r){if(V(r))return{data:{user:null},error:r};throw r}}async updateUserById(t,r){zt(t);try{return await Q(this.fetch,"PUT",`${this.url}/admin/users/${t}`,{body:r,headers:this.headers,xform:mt})}catch(s){if(V(s))return{data:{user:null},error:s};throw s}}async deleteUser(t,r=!1){zt(t);try{return await Q(this.fetch,"DELETE",`${this.url}/admin/users/${t}`,{headers:this.headers,body:{should_soft_delete:r},xform:mt})}catch(s){if(V(s))return{data:{user:null},error:s};throw s}}async _listFactors(t){zt(t.userId);try{const{data:r,error:s}=await Q(this.fetch,"GET",`${this.url}/admin/users/${t.userId}/factors`,{headers:this.headers,xform:n=>({data:{factors:n},error:null})});return{data:r,error:s}}catch(r){if(V(r))return{data:null,error:r};throw r}}async _deleteFactor(t){zt(t.userId),zt(t.id);try{return{data:await Q(this.fetch,"DELETE",`${this.url}/admin/users/${t.userId}/factors/${t.id}`,{headers:this.headers}),error:null}}catch(r){if(V(r))return{data:null,error:r};throw r}}async _listOAuthClients(t){var r,s,n,a,i,o,l;try{const c={nextPage:null,lastPage:0,total:0},d=await Q(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(r=t==null?void 0:t.page)===null||r===void 0?void 0:r.toString())!==null&&s!==void 0?s:"",per_page:(a=(n=t==null?void 0:t.perPage)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:""},xform:ci});if(d.error)throw d.error;const u=await d.json(),h=(i=d.headers.get("x-total-count"))!==null&&i!==void 0?i:0,m=(l=(o=d.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&l!==void 0?l:[];return m.length>0&&(m.forEach(f=>{const p=parseInt(f.split(";")[0].split("=")[1].substring(0,1)),_=JSON.parse(f.split(";")[1].split("=")[1]);c[`${_}Page`]=p}),c.total=parseInt(h)),{data:Object.assign(Object.assign({},u),c),error:null}}catch(c){if(V(c))return{data:{clients:[]},error:c};throw c}}async _createOAuthClient(t){try{return await Q(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:t,headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(V(r))return{data:null,error:r};throw r}}async _getOAuthClient(t){try{return await Q(this.fetch,"GET",`${this.url}/admin/oauth/clients/${t}`,{headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(V(r))return{data:null,error:r};throw r}}async _updateOAuthClient(t,r){try{return await Q(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${t}`,{body:r,headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(V(s))return{data:null,error:s};throw s}}async _deleteOAuthClient(t){try{return await Q(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${t}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(r){if(V(r))return{data:null,error:r};throw r}}async _regenerateOAuthClientSecret(t){try{return await Q(this.fetch,"POST",`${this.url}/admin/oauth/clients/${t}/regenerate_secret`,{headers:this.headers,xform:r=>({data:r,error:null})})}catch(r){if(V(r))return{data:null,error:r};throw r}}}function di(e={}){return{getItem:t=>e[t]||null,setItem:(t,r)=>{e[t]=r},removeItem:t=>{delete e[t]}}}const Vt={debug:!!(globalThis&&Co()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class Io extends Error{constructor(t){super(t),this.isAcquireTimeout=!0}}class yd extends Io{}async function gd(e,t,r){Vt.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",e,t);const s=new globalThis.AbortController;return t>0&&setTimeout(()=>{s.abort(),Vt.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",e)},t),await Promise.resolve().then(()=>globalThis.navigator.locks.request(e,t===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async n=>{if(n){Vt.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",e,n.name);try{return await r()}finally{Vt.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",e,n.name)}}else{if(t===0)throw Vt.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",e),new yd(`Acquiring an exclusive Navigator LockManager lock "${e}" immediately failed`);if(Vt.debug)try{const a=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(a,null,"  "))}catch(a){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",a)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await r()}}))}function vd(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function Do(e){if(!/^0x[a-fA-F0-9]{40}$/.test(e))throw new Error(`@supabase/auth-js: Address "${e}" is invalid.`);return e.toLowerCase()}function bd(e){return parseInt(e,16)}function _d(e){const t=new TextEncoder().encode(e);return"0x"+Array.from(t,s=>s.toString(16).padStart(2,"0")).join("")}function Sd(e){var t;const{chainId:r,domain:s,expirationTime:n,issuedAt:a=new Date,nonce:i,notBefore:o,requestId:l,resources:c,scheme:d,uri:u,version:h}=e;{if(!Number.isInteger(r))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${r}`);if(!s)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(i&&i.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${i}`);if(!u)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(h!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${h}`);if(!((t=e.statement)===null||t===void 0)&&t.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${e.statement}`)}const m=Do(e.address),f=d?`${d}://${s}`:s,p=e.statement?`${e.statement}
`:"",_=`${f} wants you to sign in with your Ethereum account:
${m}

${p}`;let y=`URI: ${u}
Version: ${h}
Chain ID: ${r}${i?`
Nonce: ${i}`:""}
Issued At: ${a.toISOString()}`;if(n&&(y+=`
Expiration Time: ${n.toISOString()}`),o&&(y+=`
Not Before: ${o.toISOString()}`),l&&(y+=`
Request ID: ${l}`),c){let b=`
Resources:`;for(const g of c){if(!g||typeof g!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${g}`);b+=`
- ${g}`}y+=b}return`${_}
${y}`}class ye extends Error{constructor({message:t,code:r,cause:s,name:n}){var a;super(t,{cause:s}),this.__isWebAuthnError=!0,this.name=(a=n??(s instanceof Error?s.name:void 0))!==null&&a!==void 0?a:"Unknown Error",this.code=r}}class Hs extends ye{constructor(t,r){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r,message:t}),this.name="WebAuthnUnknownError",this.originalError=r}}function wd({error:e,options:t}){var r,s,n;const{publicKey:a}=t;if(!a)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(t.signal instanceof AbortSignal)return new ye({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else if(e.name==="ConstraintError"){if(((r=a.authenticatorSelection)===null||r===void 0?void 0:r.requireResidentKey)===!0)return new ye({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:e});if(t.mediation==="conditional"&&((s=a.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new ye({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:e});if(((n=a.authenticatorSelection)===null||n===void 0?void 0:n.userVerification)==="required")return new ye({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:e})}else{if(e.name==="InvalidStateError")return new ye({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:e});if(e.name==="NotAllowedError")return new ye({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="NotSupportedError")return a.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new ye({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:e}):new ye({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:e});if(e.name==="SecurityError"){const i=window.location.hostname;if(Oo(i)){if(a.rp.id!==i)return new ye({message:`The RP ID "${a.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new ye({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="TypeError"){if(a.user.id.byteLength<1||a.user.id.byteLength>64)return new ye({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:e})}else if(e.name==="UnknownError")return new ye({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return new ye({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e})}function kd({error:e,options:t}){const{publicKey:r}=t;if(!r)throw Error("options was missing required publicKey property");if(e.name==="AbortError"){if(t.signal instanceof AbortSignal)return new ye({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:e})}else{if(e.name==="NotAllowedError")return new ye({message:e.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e});if(e.name==="SecurityError"){const s=window.location.hostname;if(Oo(s)){if(r.rpId!==s)return new ye({message:`The RP ID "${r.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:e})}else return new ye({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:e})}else if(e.name==="UnknownError")return new ye({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:e})}return new ye({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:e})}class Ld{createNewAbortSignal(){if(this.controller){const r=new Error("Cancelling existing WebAuthn API call for new one");r.name="AbortError",this.controller.abort(r)}const t=new AbortController;return this.controller=t,t.signal}cancelCeremony(){if(this.controller){const t=new Error("Manually cancelling existing WebAuthn API call");t.name="AbortError",this.controller.abort(t),this.controller=void 0}}}const qd=new Ld;function Td(e){if(!e)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(e);const{challenge:t,user:r,excludeCredentials:s}=e,n=Ys(e,["challenge","user","excludeCredentials"]),a=ur(t).buffer,i=Object.assign(Object.assign({},r),{id:ur(r.id).buffer}),o=Object.assign(Object.assign({},n),{challenge:a,user:i});if(s&&s.length>0){o.excludeCredentials=new Array(s.length);for(let l=0;l<s.length;l++){const c=s[l];o.excludeCredentials[l]=Object.assign(Object.assign({},c),{id:ur(c.id).buffer,type:c.type||"public-key",transports:c.transports})}}return o}function Ed(e){if(!e)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(e);const{challenge:t,allowCredentials:r}=e,s=Ys(e,["challenge","allowCredentials"]),n=ur(t).buffer,a=Object.assign(Object.assign({},s),{challenge:n});if(r&&r.length>0){a.allowCredentials=new Array(r.length);for(let i=0;i<r.length;i++){const o=r[i];a.allowCredentials[i]=Object.assign(Object.assign({},o),{id:ur(o.id).buffer,type:o.type||"public-key",transports:o.transports})}}return a}function $d(e){var t;if("toJSON"in e&&typeof e.toJSON=="function")return e.toJSON();const r=e;return{id:e.id,rawId:e.id,response:{attestationObject:Ot(new Uint8Array(e.response.attestationObject)),clientDataJSON:Ot(new Uint8Array(e.response.clientDataJSON))},type:"public-key",clientExtensionResults:e.getClientExtensionResults(),authenticatorAttachment:(t=r.authenticatorAttachment)!==null&&t!==void 0?t:void 0}}function Ad(e){var t;if("toJSON"in e&&typeof e.toJSON=="function")return e.toJSON();const r=e,s=e.getClientExtensionResults(),n=e.response;return{id:e.id,rawId:e.id,response:{authenticatorData:Ot(new Uint8Array(n.authenticatorData)),clientDataJSON:Ot(new Uint8Array(n.clientDataJSON)),signature:Ot(new Uint8Array(n.signature)),userHandle:n.userHandle?Ot(new Uint8Array(n.userHandle)):void 0},type:"public-key",clientExtensionResults:s,authenticatorAttachment:(t=r.authenticatorAttachment)!==null&&t!==void 0?t:void 0}}function Oo(e){return e==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(e)}function ui(){var e,t;return!!(qe()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.create)=="function"&&typeof((t=navigator==null?void 0:navigator.credentials)===null||t===void 0?void 0:t.get)=="function")}async function xd(e){try{const t=await navigator.credentials.create(e);return t?t instanceof PublicKeyCredential?{data:t,error:null}:{data:null,error:new Hs("Browser returned unexpected credential type",t)}:{data:null,error:new Hs("Empty credential response",t)}}catch(t){return{data:null,error:wd({error:t,options:e})}}}async function Cd(e){try{const t=await navigator.credentials.get(e);return t?t instanceof PublicKeyCredential?{data:t,error:null}:{data:null,error:new Hs("Browser returned unexpected credential type",t)}:{data:null,error:new Hs("Empty credential response",t)}}catch(t){return{data:null,error:kd({error:t,options:e})}}}const Rd={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"direct"},Id={userVerification:"preferred",hints:["security-key"],attestation:"direct"};function Us(...e){const t=n=>n!==null&&typeof n=="object"&&!Array.isArray(n),r=n=>n instanceof ArrayBuffer||ArrayBuffer.isView(n),s={};for(const n of e)if(n)for(const a in n){const i=n[a];if(i!==void 0)if(Array.isArray(i))s[a]=i;else if(r(i))s[a]=i;else if(t(i)){const o=s[a];t(o)?s[a]=Us(o,i):s[a]=Us(i)}else s[a]=i}return s}function Dd(e,t){return Us(Rd,e,t||{})}function Od(e,t){return Us(Id,e,t||{})}class Pd{constructor(t){this.client=t,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(t){return this.client.mfa.enroll(Object.assign(Object.assign({},t),{factorType:"webauthn"}))}async _challenge({factorId:t,webauthn:r,friendlyName:s,signal:n},a){var i;try{const{data:o,error:l}=await this.client.mfa.challenge({factorId:t,webauthn:r});if(!o)return{data:null,error:l};const c=n??qd.createNewAbortSignal();if(o.webauthn.type==="create"){const{user:d}=o.webauthn.credential_options.publicKey;if(!d.name){const u=s;if(u)d.name=`${d.id}:${u}`;else{const m=(await this.client.getUser()).data.user,f=((i=m==null?void 0:m.user_metadata)===null||i===void 0?void 0:i.name)||(m==null?void 0:m.email)||(m==null?void 0:m.id)||"User";d.name=`${d.id}:${f}`}}d.displayName||(d.displayName=d.name)}switch(o.webauthn.type){case"create":{const d=Dd(o.webauthn.credential_options.publicKey,a==null?void 0:a.create),{data:u,error:h}=await xd({publicKey:d,signal:c});return u?{data:{factorId:t,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:h}}case"request":{const d=Od(o.webauthn.credential_options.publicKey,a==null?void 0:a.request),{data:u,error:h}=await Cd(Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:d,signal:c}));return u?{data:{factorId:t,challengeId:o.id,webauthn:{type:o.webauthn.type,credential_response:u}},error:null}:{data:null,error:h}}}}catch(o){return V(o)?{data:null,error:o}:{data:null,error:new At("Unexpected error in challenge",o)}}}async _verify({challengeId:t,factorId:r,webauthn:s}){return this.client.mfa.verify({factorId:r,challengeId:t,webauthn:s})}async _authenticate({factorId:t,webauthn:{rpId:r=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:n}={}},a){if(!r)return{data:null,error:new Vr("rpId is required for WebAuthn authentication")};try{if(!ui())return{data:null,error:new At("Browser does not support WebAuthn",null)};const{data:i,error:o}=await this.challenge({factorId:t,webauthn:{rpId:r,rpOrigins:s},signal:n},{request:a});if(!i)return{data:null,error:o};const{webauthn:l}=i;return this._verify({factorId:t,challengeId:i.challengeId,webauthn:{type:l.type,rpId:r,rpOrigins:s,credential_response:l.credential_response}})}catch(i){return V(i)?{data:null,error:i}:{data:null,error:new At("Unexpected error in authenticate",i)}}}async _register({friendlyName:t,webauthn:{rpId:r=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:n}={}},a){if(!r)return{data:null,error:new Vr("rpId is required for WebAuthn registration")};try{if(!ui())return{data:null,error:new At("Browser does not support WebAuthn",null)};const{data:i,error:o}=await this._enroll({friendlyName:t});if(!i)return await this.client.mfa.listFactors().then(d=>{var u;return(u=d.data)===null||u===void 0?void 0:u.all.find(h=>h.factor_type==="webauthn"&&h.friendly_name===t&&h.status!=="unverified")}).then(d=>d?this.client.mfa.unenroll({factorId:d==null?void 0:d.id}):void 0),{data:null,error:o};const{data:l,error:c}=await this._challenge({factorId:i.id,friendlyName:i.friendly_name,webauthn:{rpId:r,rpOrigins:s},signal:n},{create:a});return l?this._verify({factorId:i.id,challengeId:l.challengeId,webauthn:{rpId:r,rpOrigins:s,type:l.webauthn.type,credential_response:l.webauthn.credential_response}}):{data:null,error:c}}catch(i){return V(i)?{data:null,error:i}:{data:null,error:new At("Unexpected error in register",i)}}}}vd();const Md={url:Ic,storageKey:Dc,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Oc,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1,lockAcquireTimeout:1e4};async function hi(e,t,r){return await r()}const Gt={};class Gr{get jwks(){var t,r;return(r=(t=Gt[this.storageKey])===null||t===void 0?void 0:t.jwks)!==null&&r!==void 0?r:{keys:[]}}set jwks(t){Gt[this.storageKey]=Object.assign(Object.assign({},Gt[this.storageKey]),{jwks:t})}get jwks_cached_at(){var t,r;return(r=(t=Gt[this.storageKey])===null||t===void 0?void 0:t.cachedAt)!==null&&r!==void 0?r:Number.MIN_SAFE_INTEGER}set jwks_cached_at(t){Gt[this.storageKey]=Object.assign(Object.assign({},Gt[this.storageKey]),{cachedAt:t})}constructor(t){var r,s,n;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.autoRefreshTickTimeout=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const a=Object.assign(Object.assign({},Md),t);if(this.storageKey=a.storageKey,this.instanceID=(r=Gr.nextInstanceID[this.storageKey])!==null&&r!==void 0?r:0,Gr.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!a.debug,typeof a.debug=="function"&&(this.logger=a.debug),this.instanceID>0&&qe()){const i=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(i),this.logDebugMessages&&console.trace(i)}if(this.persistSession=a.persistSession,this.autoRefreshToken=a.autoRefreshToken,this.admin=new pd({url:a.url,headers:a.headers,fetch:a.fetch}),this.url=a.url,this.headers=a.headers,this.fetch=Ro(a.fetch),this.lock=a.lock||hi,this.detectSessionInUrl=a.detectSessionInUrl,this.flowType=a.flowType,this.hasCustomAuthorizationHeader=a.hasCustomAuthorizationHeader,this.throwOnError=a.throwOnError,this.lockAcquireTimeout=a.lockAcquireTimeout,a.lock?this.lock=a.lock:this.persistSession&&qe()&&(!((s=globalThis==null?void 0:globalThis.navigator)===null||s===void 0)&&s.locks)?this.lock=gd:this.lock=hi,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new Pd(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this),listGrants:this._listOAuthGrants.bind(this),revokeGrant:this._revokeOAuthGrant.bind(this)},this.persistSession?(a.storage?this.storage=a.storage:Co()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=di(this.memoryStorage)),a.userStorage&&(this.userStorage=a.userStorage)):(this.memoryStorage={},this.storage=di(this.memoryStorage)),qe()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(n=this.broadcastChannel)===null||n===void 0||n.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i);try{await this._notifyAllSubscribers(i.data.event,i.data.session,!1)}catch(o){this._debug("#broadcastChannel","error",o)}})}this.initialize().catch(i=>{this._debug("#initialize()","error",i)})}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(t){if(this.throwOnError&&t&&t.error)throw t.error;return t}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${$o}) ${new Date().toISOString()}`}_debug(...t){return this.logDebugMessages&&this.logger(this._logPrefix(),...t),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(this.lockAcquireTimeout,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var t;try{let r={},s="none";if(qe()&&(r=Jc(window.location.href),this._isImplicitGrantCallback(r)?s="implicit":await this._isPKCECallback(r)&&(s="pkce")),qe()&&this.detectSessionInUrl&&s!=="none"){const{data:n,error:a}=await this._getSessionFromURL(r,s);if(a){if(this._debug("#_initialize()","error detecting session from URL",a),Hc(a)){const l=(t=a.details)===null||t===void 0?void 0:t.code;if(l==="identity_already_exists"||l==="identity_not_found"||l==="single_identity_not_deletable")return{error:a}}return{error:a}}const{session:i,redirectType:o}=n;return this._debug("#_initialize()","detected session in URL",i,"redirect type",o),await this._saveSession(i),setTimeout(async()=>{o==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",i):await this._notifyAllSubscribers("SIGNED_IN",i)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(r){return V(r)?this._returnResult({error:r}):this._returnResult({error:new At("Unexpected error during initialization",r)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(t){var r,s,n;try{const a=await Q(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(r=t==null?void 0:t.options)===null||r===void 0?void 0:r.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(n=t==null?void 0:t.options)===null||n===void 0?void 0:n.captchaToken}},xform:Ke}),{data:i,error:o}=a;if(o||!i)return this._returnResult({data:{user:null,session:null},error:o});const l=i.session,c=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(a){if(V(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signUp(t){var r,s,n;try{let a;if("email"in t){const{email:d,password:u,options:h}=t;let m=null,f=null;this.flowType==="pkce"&&([m,f]=await Wt(this.storage,this.storageKey)),a=await Q(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:h==null?void 0:h.emailRedirectTo,body:{email:d,password:u,data:(r=h==null?void 0:h.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken},code_challenge:m,code_challenge_method:f},xform:Ke})}else if("phone"in t){const{phone:d,password:u,options:h}=t;a=await Q(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:u,data:(s=h==null?void 0:h.data)!==null&&s!==void 0?s:{},channel:(n=h==null?void 0:h.channel)!==null&&n!==void 0?n:"sms",gotrue_meta_security:{captcha_token:h==null?void 0:h.captchaToken}},xform:Ke})}else throw new vs("You must provide either an email or phone number and a password");const{data:i,error:o}=a;if(o||!i)return await Le(this.storage,`${this.storageKey}-code-verifier`),this._returnResult({data:{user:null,session:null},error:o});const l=i.session,c=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(a){if(await Le(this.storage,`${this.storageKey}-code-verifier`),V(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signInWithPassword(t){try{let r;if("email"in t){const{email:a,password:i,options:o}=t;r=await Q(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:a,password:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:li})}else if("phone"in t){const{phone:a,password:i,options:o}=t;r=await Q(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:a,password:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:li})}else throw new vs("You must provide either an email or phone number and a password");const{data:s,error:n}=r;if(n)return this._returnResult({data:{user:null,session:null},error:n});if(!s||!s.session||!s.user){const a=new Kt;return this._returnResult({data:{user:null,session:null},error:a})}return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),this._returnResult({data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:n})}catch(r){if(V(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async signInWithOAuth(t){var r,s,n,a;return await this._handleProviderSignIn(t.provider,{redirectTo:(r=t.options)===null||r===void 0?void 0:r.redirectTo,scopes:(s=t.options)===null||s===void 0?void 0:s.scopes,queryParams:(n=t.options)===null||n===void 0?void 0:n.queryParams,skipBrowserRedirect:(a=t.options)===null||a===void 0?void 0:a.skipBrowserRedirect})}async exchangeCodeForSession(t){return await this.initializePromise,this._acquireLock(this.lockAcquireTimeout,async()=>this._exchangeCodeForSession(t))}async signInWithWeb3(t){const{chain:r}=t;switch(r){case"ethereum":return await this.signInWithEthereum(t);case"solana":return await this.signInWithSolana(t);default:throw new Error(`@supabase/auth-js: Unsupported chain "${r}"`)}}async signInWithEthereum(t){var r,s,n,a,i,o,l,c,d,u,h;let m,f;if("message"in t)m=t.message,f=t.signature;else{const{chain:p,wallet:_,statement:y,options:b}=t;let g;if(qe())if(typeof _=="object")g=_;else{const q=window;if("ethereum"in q&&typeof q.ethereum=="object"&&"request"in q.ethereum&&typeof q.ethereum.request=="function")g=q.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof _!="object"||!(b!=null&&b.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");g=_}const S=new URL((r=b==null?void 0:b.url)!==null&&r!==void 0?r:window.location.href),k=await g.request({method:"eth_requestAccounts"}).then(q=>q).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!k||k.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const E=Do(k[0]);let L=(s=b==null?void 0:b.signInWithEthereum)===null||s===void 0?void 0:s.chainId;if(!L){const q=await g.request({method:"eth_chainId"});L=bd(q)}const $={domain:S.host,address:E,statement:y,uri:S.href,version:"1",chainId:L,nonce:(n=b==null?void 0:b.signInWithEthereum)===null||n===void 0?void 0:n.nonce,issuedAt:(i=(a=b==null?void 0:b.signInWithEthereum)===null||a===void 0?void 0:a.issuedAt)!==null&&i!==void 0?i:new Date,expirationTime:(o=b==null?void 0:b.signInWithEthereum)===null||o===void 0?void 0:o.expirationTime,notBefore:(l=b==null?void 0:b.signInWithEthereum)===null||l===void 0?void 0:l.notBefore,requestId:(c=b==null?void 0:b.signInWithEthereum)===null||c===void 0?void 0:c.requestId,resources:(d=b==null?void 0:b.signInWithEthereum)===null||d===void 0?void 0:d.resources};m=Sd($),f=await g.request({method:"personal_sign",params:[_d(m),E]})}try{const{data:p,error:_}=await Q(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:m,signature:f},!((u=t.options)===null||u===void 0)&&u.captchaToken?{gotrue_meta_security:{captcha_token:(h=t.options)===null||h===void 0?void 0:h.captchaToken}}:null),xform:Ke});if(_)throw _;if(!p||!p.session||!p.user){const y=new Kt;return this._returnResult({data:{user:null,session:null},error:y})}return p.session&&(await this._saveSession(p.session),await this._notifyAllSubscribers("SIGNED_IN",p.session)),this._returnResult({data:Object.assign({},p),error:_})}catch(p){if(V(p))return this._returnResult({data:{user:null,session:null},error:p});throw p}}async signInWithSolana(t){var r,s,n,a,i,o,l,c,d,u,h,m;let f,p;if("message"in t)f=t.message,p=t.signature;else{const{chain:_,wallet:y,statement:b,options:g}=t;let S;if(qe())if(typeof y=="object")S=y;else{const E=window;if("solana"in E&&typeof E.solana=="object"&&("signIn"in E.solana&&typeof E.solana.signIn=="function"||"signMessage"in E.solana&&typeof E.solana.signMessage=="function"))S=E.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof y!="object"||!(g!=null&&g.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");S=y}const k=new URL((r=g==null?void 0:g.url)!==null&&r!==void 0?r:window.location.href);if("signIn"in S&&S.signIn){const E=await S.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},g==null?void 0:g.signInWithSolana),{version:"1",domain:k.host,uri:k.href}),b?{statement:b}:null));let L;if(Array.isArray(E)&&E[0]&&typeof E[0]=="object")L=E[0];else if(E&&typeof E=="object"&&"signedMessage"in E&&"signature"in E)L=E;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in L&&"signature"in L&&(typeof L.signedMessage=="string"||L.signedMessage instanceof Uint8Array)&&L.signature instanceof Uint8Array)f=typeof L.signedMessage=="string"?L.signedMessage:new TextDecoder().decode(L.signedMessage),p=L.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in S)||typeof S.signMessage!="function"||!("publicKey"in S)||typeof S!="object"||!S.publicKey||!("toBase58"in S.publicKey)||typeof S.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");f=[`${k.host} wants you to sign in with your Solana account:`,S.publicKey.toBase58(),...b?["",b,""]:[""],"Version: 1",`URI: ${k.href}`,`Issued At: ${(n=(s=g==null?void 0:g.signInWithSolana)===null||s===void 0?void 0:s.issuedAt)!==null&&n!==void 0?n:new Date().toISOString()}`,...!((a=g==null?void 0:g.signInWithSolana)===null||a===void 0)&&a.notBefore?[`Not Before: ${g.signInWithSolana.notBefore}`]:[],...!((i=g==null?void 0:g.signInWithSolana)===null||i===void 0)&&i.expirationTime?[`Expiration Time: ${g.signInWithSolana.expirationTime}`]:[],...!((o=g==null?void 0:g.signInWithSolana)===null||o===void 0)&&o.chainId?[`Chain ID: ${g.signInWithSolana.chainId}`]:[],...!((l=g==null?void 0:g.signInWithSolana)===null||l===void 0)&&l.nonce?[`Nonce: ${g.signInWithSolana.nonce}`]:[],...!((c=g==null?void 0:g.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${g.signInWithSolana.requestId}`]:[],...!((u=(d=g==null?void 0:g.signInWithSolana)===null||d===void 0?void 0:d.resources)===null||u===void 0)&&u.length?["Resources",...g.signInWithSolana.resources.map(L=>`- ${L}`)]:[]].join(`
`);const E=await S.signMessage(new TextEncoder().encode(f),"utf8");if(!E||!(E instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");p=E}}try{const{data:_,error:y}=await Q(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:f,signature:Ot(p)},!((h=t.options)===null||h===void 0)&&h.captchaToken?{gotrue_meta_security:{captcha_token:(m=t.options)===null||m===void 0?void 0:m.captchaToken}}:null),xform:Ke});if(y)throw y;if(!_||!_.session||!_.user){const b=new Kt;return this._returnResult({data:{user:null,session:null},error:b})}return _.session&&(await this._saveSession(_.session),await this._notifyAllSubscribers("SIGNED_IN",_.session)),this._returnResult({data:Object.assign({},_),error:y})}catch(_){if(V(_))return this._returnResult({data:{user:null,session:null},error:_});throw _}}async _exchangeCodeForSession(t){const r=await kt(this.storage,`${this.storageKey}-code-verifier`),[s,n]=(r??"").split("/");try{if(!s&&this.flowType==="pkce")throw new Uc;const{data:a,error:i}=await Q(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:t,code_verifier:s},xform:Ke});if(await Le(this.storage,`${this.storageKey}-code-verifier`),i)throw i;if(!a||!a.session||!a.user){const o=new Kt;return this._returnResult({data:{user:null,session:null,redirectType:null},error:o})}return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),this._returnResult({data:Object.assign(Object.assign({},a),{redirectType:n??null}),error:i})}catch(a){if(await Le(this.storage,`${this.storageKey}-code-verifier`),V(a))return this._returnResult({data:{user:null,session:null,redirectType:null},error:a});throw a}}async signInWithIdToken(t){try{const{options:r,provider:s,token:n,access_token:a,nonce:i}=t,o=await Q(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:n,access_token:a,nonce:i,gotrue_meta_security:{captcha_token:r==null?void 0:r.captchaToken}},xform:Ke}),{data:l,error:c}=o;if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!l||!l.session||!l.user){const d=new Kt;return this._returnResult({data:{user:null,session:null},error:d})}return l.session&&(await this._saveSession(l.session),await this._notifyAllSubscribers("SIGNED_IN",l.session)),this._returnResult({data:l,error:c})}catch(r){if(V(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async signInWithOtp(t){var r,s,n,a,i;try{if("email"in t){const{email:o,options:l}=t;let c=null,d=null;this.flowType==="pkce"&&([c,d]=await Wt(this.storage,this.storageKey));const{error:u}=await Q(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(r=l==null?void 0:l.data)!==null&&r!==void 0?r:{},create_user:(s=l==null?void 0:l.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},code_challenge:c,code_challenge_method:d},redirectTo:l==null?void 0:l.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:u})}if("phone"in t){const{phone:o,options:l}=t,{data:c,error:d}=await Q(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(n=l==null?void 0:l.data)!==null&&n!==void 0?n:{},create_user:(a=l==null?void 0:l.shouldCreateUser)!==null&&a!==void 0?a:!0,gotrue_meta_security:{captcha_token:l==null?void 0:l.captchaToken},channel:(i=l==null?void 0:l.channel)!==null&&i!==void 0?i:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:c==null?void 0:c.message_id},error:d})}throw new vs("You must provide either an email or phone number.")}catch(o){if(await Le(this.storage,`${this.storageKey}-code-verifier`),V(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async verifyOtp(t){var r,s;try{let n,a;"options"in t&&(n=(r=t.options)===null||r===void 0?void 0:r.redirectTo,a=(s=t.options)===null||s===void 0?void 0:s.captchaToken);const{data:i,error:o}=await Q(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},t),{gotrue_meta_security:{captcha_token:a}}),redirectTo:n,xform:Ke});if(o)throw o;if(!i)throw new Error("An error occurred on token verification.");const l=i.session,c=i.user;return l!=null&&l.access_token&&(await this._saveSession(l),await this._notifyAllSubscribers(t.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",l)),this._returnResult({data:{user:c,session:l},error:null})}catch(n){if(V(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithSSO(t){var r,s,n,a,i;try{let o=null,l=null;this.flowType==="pkce"&&([o,l]=await Wt(this.storage,this.storageKey));const c=await Q(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in t?{provider_id:t.providerId}:null),"domain"in t?{domain:t.domain}:null),{redirect_to:(s=(r=t.options)===null||r===void 0?void 0:r.redirectTo)!==null&&s!==void 0?s:void 0}),!((n=t==null?void 0:t.options)===null||n===void 0)&&n.captchaToken?{gotrue_meta_security:{captcha_token:t.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:o,code_challenge_method:l}),headers:this.headers,xform:hd});return!((a=c.data)===null||a===void 0)&&a.url&&qe()&&!(!((i=t.options)===null||i===void 0)&&i.skipBrowserRedirect)&&window.location.assign(c.data.url),this._returnResult(c)}catch(o){if(await Le(this.storage,`${this.storageKey}-code-verifier`),V(o))return this._returnResult({data:null,error:o});throw o}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;if(s)throw s;if(!r)throw new De;const{error:n}=await Q(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:r.access_token});return this._returnResult({data:{user:null,session:null},error:n})})}catch(t){if(V(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async resend(t){try{const r=`${this.url}/resend`;if("email"in t){const{email:s,type:n,options:a}=t,{error:i}=await Q(this.fetch,"POST",r,{headers:this.headers,body:{email:s,type:n,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},redirectTo:a==null?void 0:a.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:i})}else if("phone"in t){const{phone:s,type:n,options:a}=t,{data:i,error:o}=await Q(this.fetch,"POST",r,{headers:this.headers,body:{phone:s,type:n,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:i==null?void 0:i.message_id},error:o})}throw new vs("You must provide either an email or phone number and a type")}catch(r){if(V(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async getSession(){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>this._useSession(async r=>r))}async _acquireLock(t,r){this._debug("#_acquireLock","begin",t);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),n=(async()=>(await s,await r()))();return this.pendingInLock.push((async()=>{try{await n}catch{}})()),n}return await this.lock(`lock:${this.storageKey}`,t,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=r();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const n=[...this.pendingInLock];await Promise.all(n),this.pendingInLock.splice(0,n.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(t){this._debug("#_useSession","begin");try{const r=await this.__loadSession();return await t(r)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let t=null;const r=await kt(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",r),r!==null&&(this._isValidSession(r)?t=r:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!t)return{data:{session:null},error:null};const s=t.expires_at?t.expires_at*1e3-Date.now()<fn:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",t.expires_at),!s){if(this.userStorage){const i=await kt(this.userStorage,this.storageKey+"-user");i!=null&&i.user?t.user=i.user:t.user=yn()}if(this.storage.isServer&&t.user&&!t.user.__isUserNotAvailableProxy){const i={value:this.suppressGetSessionWarning};t.user=ld(t.user,i),i.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:t},error:null}}const{data:n,error:a}=await this._callRefreshToken(t.refresh_token);return a?this._returnResult({data:{session:null},error:a}):this._returnResult({data:{session:n},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(t){if(t)return await this._getUser(t);await this.initializePromise;const r=await this._acquireLock(this.lockAcquireTimeout,async()=>await this._getUser());return r.data.user&&(this.suppressGetSessionWarning=!0),r}async _getUser(t){try{return t?await Q(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:t,xform:mt}):await this._useSession(async r=>{var s,n,a;const{data:i,error:o}=r;if(o)throw o;return!(!((s=i.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new De}:await Q(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(a=(n=i.session)===null||n===void 0?void 0:n.access_token)!==null&&a!==void 0?a:void 0,xform:mt})})}catch(r){if(V(r))return mn(r)&&(await this._removeSession(),await Le(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:r});throw r}}async updateUser(t,r={}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._updateUser(t,r))}async _updateUser(t,r={}){try{return await this._useSession(async s=>{const{data:n,error:a}=s;if(a)throw a;if(!n.session)throw new De;const i=n.session;let o=null,l=null;this.flowType==="pkce"&&t.email!=null&&([o,l]=await Wt(this.storage,this.storageKey));const{data:c,error:d}=await Q(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:r==null?void 0:r.emailRedirectTo,body:Object.assign(Object.assign({},t),{code_challenge:o,code_challenge_method:l}),jwt:i.access_token,xform:mt});if(d)throw d;return i.user=c.user,await this._saveSession(i),await this._notifyAllSubscribers("USER_UPDATED",i),this._returnResult({data:{user:i.user},error:null})})}catch(s){if(await Le(this.storage,`${this.storageKey}-code-verifier`),V(s))return this._returnResult({data:{user:null},error:s});throw s}}async setSession(t){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._setSession(t))}async _setSession(t){try{if(!t.access_token||!t.refresh_token)throw new De;const r=Date.now()/1e3;let s=r,n=!0,a=null;const{payload:i}=_s(t.access_token);if(i.exp&&(s=i.exp,n=s<=r),n){const{data:o,error:l}=await this._callRefreshToken(t.refresh_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!o)return{data:{user:null,session:null},error:null};a=o}else{const{data:o,error:l}=await this._getUser(t.access_token);if(l)return this._returnResult({data:{user:null,session:null},error:l});a={access_token:t.access_token,refresh_token:t.refresh_token,user:o.user,token_type:"bearer",expires_in:s-r,expires_at:s},await this._saveSession(a),await this._notifyAllSubscribers("SIGNED_IN",a)}return this._returnResult({data:{user:a.user,session:a},error:null})}catch(r){if(V(r))return this._returnResult({data:{session:null,user:null},error:r});throw r}}async refreshSession(t){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._refreshSession(t))}async _refreshSession(t){try{return await this._useSession(async r=>{var s;if(!t){const{data:i,error:o}=r;if(o)throw o;t=(s=i.session)!==null&&s!==void 0?s:void 0}if(!(t!=null&&t.refresh_token))throw new De;const{data:n,error:a}=await this._callRefreshToken(t.refresh_token);return a?this._returnResult({data:{user:null,session:null},error:a}):n?this._returnResult({data:{user:n.user,session:n},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(r){if(V(r))return this._returnResult({data:{user:null,session:null},error:r});throw r}}async _getSessionFromURL(t,r){try{if(!qe())throw new bs("No browser detected.");if(t.error||t.error_description||t.error_code)throw new bs(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});switch(r){case"implicit":if(this.flowType==="pkce")throw new ti("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new bs("Not a valid implicit grant flow url.");break;default:}if(r==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!t.code)throw new ti("No code detected.");const{data:b,error:g}=await this._exchangeCodeForSession(t.code);if(g)throw g;const S=new URL(window.location.href);return S.searchParams.delete("code"),window.history.replaceState(window.history.state,"",S.toString()),{data:{session:b.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:n,access_token:a,refresh_token:i,expires_in:o,expires_at:l,token_type:c}=t;if(!a||!o||!i||!c)throw new bs("No session defined in URL");const d=Math.round(Date.now()/1e3),u=parseInt(o);let h=d+u;l&&(h=parseInt(l));const m=h-d;m*1e3<=Yt&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${m}s, should have been closer to ${u}s`);const f=h-u;d-f>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",f,h,d):d-f<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",f,h,d);const{data:p,error:_}=await this._getUser(a);if(_)throw _;const y={provider_token:s,provider_refresh_token:n,access_token:a,expires_in:u,expires_at:h,refresh_token:i,token_type:c,user:p.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:y,redirectType:t.type},error:null})}catch(s){if(V(s))return this._returnResult({data:{session:null,redirectType:null},error:s});throw s}}_isImplicitGrantCallback(t){return typeof this.detectSessionInUrl=="function"?this.detectSessionInUrl(new URL(window.location.href),t):!!(t.access_token||t.error_description)}async _isPKCECallback(t){const r=await kt(this.storage,`${this.storageKey}-code-verifier`);return!!(t.code&&r)}async signOut(t={scope:"global"}){return await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>await this._signOut(t))}async _signOut({scope:t}={scope:"global"}){return await this._useSession(async r=>{var s;const{data:n,error:a}=r;if(a&&!mn(a))return this._returnResult({error:a});const i=(s=n.session)===null||s===void 0?void 0:s.access_token;if(i){const{error:o}=await this.admin.signOut(i,t);if(o&&!(jc(o)&&(o.status===404||o.status===401||o.status===403)||mn(o)))return this._returnResult({error:o})}return t!=="others"&&(await this._removeSession(),await Le(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(t){const r=Gc(),s={id:r,callback:t,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",r),this.stateChangeEmitters.delete(r)}};return this._debug("#onAuthStateChange()","registered callback with id",r),this.stateChangeEmitters.set(r,s),(async()=>(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{this._emitInitialSession(r)})))(),{data:{subscription:s}}}async _emitInitialSession(t){return await this._useSession(async r=>{var s,n;try{const{data:{session:a},error:i}=r;if(i)throw i;await((s=this.stateChangeEmitters.get(t))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",a)),this._debug("INITIAL_SESSION","callback id",t,"session",a)}catch(a){await((n=this.stateChangeEmitters.get(t))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",t,"error",a),console.error(a)}})}async resetPasswordForEmail(t,r={}){let s=null,n=null;this.flowType==="pkce"&&([s,n]=await Wt(this.storage,this.storageKey,!0));try{return await Q(this.fetch,"POST",`${this.url}/recover`,{body:{email:t,code_challenge:s,code_challenge_method:n,gotrue_meta_security:{captcha_token:r.captchaToken}},headers:this.headers,redirectTo:r.redirectTo})}catch(a){if(await Le(this.storage,`${this.storageKey}-code-verifier`),V(a))return this._returnResult({data:null,error:a});throw a}}async getUserIdentities(){var t;try{const{data:r,error:s}=await this.getUser();if(s)throw s;return this._returnResult({data:{identities:(t=r.user.identities)!==null&&t!==void 0?t:[]},error:null})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}}async linkIdentity(t){return"token"in t?this.linkIdentityIdToken(t):this.linkIdentityOAuth(t)}async linkIdentityOAuth(t){var r;try{const{data:s,error:n}=await this._useSession(async a=>{var i,o,l,c,d;const{data:u,error:h}=a;if(h)throw h;const m=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,t.provider,{redirectTo:(i=t.options)===null||i===void 0?void 0:i.redirectTo,scopes:(o=t.options)===null||o===void 0?void 0:o.scopes,queryParams:(l=t.options)===null||l===void 0?void 0:l.queryParams,skipBrowserRedirect:!0});return await Q(this.fetch,"GET",m,{headers:this.headers,jwt:(d=(c=u.session)===null||c===void 0?void 0:c.access_token)!==null&&d!==void 0?d:void 0})});if(n)throw n;return qe()&&!(!((r=t.options)===null||r===void 0)&&r.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),this._returnResult({data:{provider:t.provider,url:s==null?void 0:s.url},error:null})}catch(s){if(V(s))return this._returnResult({data:{provider:t.provider,url:null},error:s});throw s}}async linkIdentityIdToken(t){return await this._useSession(async r=>{var s;try{const{error:n,data:{session:a}}=r;if(n)throw n;const{options:i,provider:o,token:l,access_token:c,nonce:d}=t,u=await Q(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(s=a==null?void 0:a.access_token)!==null&&s!==void 0?s:void 0,body:{provider:o,id_token:l,access_token:c,nonce:d,link_identity:!0,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},xform:Ke}),{data:h,error:m}=u;return m?this._returnResult({data:{user:null,session:null},error:m}):!h||!h.session||!h.user?this._returnResult({data:{user:null,session:null},error:new Kt}):(h.session&&(await this._saveSession(h.session),await this._notifyAllSubscribers("USER_UPDATED",h.session)),this._returnResult({data:h,error:m}))}catch(n){if(await Le(this.storage,`${this.storageKey}-code-verifier`),V(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}})}async unlinkIdentity(t){try{return await this._useSession(async r=>{var s,n;const{data:a,error:i}=r;if(i)throw i;return await Q(this.fetch,"DELETE",`${this.url}/user/identities/${t.identity_id}`,{headers:this.headers,jwt:(n=(s=a.session)===null||s===void 0?void 0:s.access_token)!==null&&n!==void 0?n:void 0})})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}}async _refreshAccessToken(t){const r=`#_refreshAccessToken(${t.substring(0,5)}...)`;this._debug(r,"begin");try{const s=Date.now();return await Xc(async n=>(n>0&&await Yc(200*Math.pow(2,n-1)),this._debug(r,"refreshing attempt",n),await Q(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:t},headers:this.headers,xform:Ke})),(n,a)=>{const i=200*Math.pow(2,n);return a&&pn(a)&&Date.now()+i-s<Yt})}catch(s){if(this._debug(r,"error",s),V(s))return this._returnResult({data:{session:null,user:null},error:s});throw s}finally{this._debug(r,"end")}}_isValidSession(t){return typeof t=="object"&&t!==null&&"access_token"in t&&"refresh_token"in t&&"expires_at"in t}async _handleProviderSignIn(t,r){const s=await this._getUrlForProvider(`${this.url}/authorize`,t,{redirectTo:r.redirectTo,scopes:r.scopes,queryParams:r.queryParams});return this._debug("#_handleProviderSignIn()","provider",t,"options",r,"url",s),qe()&&!r.skipBrowserRedirect&&window.location.assign(s),{data:{provider:t,url:s},error:null}}async _recoverAndRefresh(){var t,r;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const n=await kt(this.storage,this.storageKey);if(n&&this.userStorage){let i=await kt(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!i&&(i={user:n.user},await Xt(this.userStorage,this.storageKey+"-user",i)),n.user=(t=i==null?void 0:i.user)!==null&&t!==void 0?t:yn()}else if(n&&!n.user&&!n.user){const i=await kt(this.storage,this.storageKey+"-user");i&&(i!=null&&i.user)?(n.user=i.user,await Le(this.storage,this.storageKey+"-user"),await Xt(this.storage,this.storageKey,n)):n.user=yn()}if(this._debug(s,"session from storage",n),!this._isValidSession(n)){this._debug(s,"session is not valid"),n!==null&&await this._removeSession();return}const a=((r=n.expires_at)!==null&&r!==void 0?r:1/0)*1e3-Date.now()<fn;if(this._debug(s,`session has${a?"":" not"} expired with margin of ${fn}s`),a){if(this.autoRefreshToken&&n.refresh_token){const{error:i}=await this._callRefreshToken(n.refresh_token);i&&(console.error(i),pn(i)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",i),await this._removeSession()))}}else if(n.user&&n.user.__isUserNotAvailableProxy===!0)try{const{data:i,error:o}=await this._getUser(n.access_token);!o&&(i!=null&&i.user)?(n.user=i.user,await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(i){console.error("Error getting user data:",i),this._debug(s,"error getting user data, skipping SIGNED_IN notification",i)}else await this._notifyAllSubscribers("SIGNED_IN",n)}catch(n){this._debug(s,"error",n),console.error(n);return}finally{this._debug(s,"end")}}async _callRefreshToken(t){var r,s;if(!t)throw new De;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const n=`#_callRefreshToken(${t.substring(0,5)}...)`;this._debug(n,"begin");try{this.refreshingDeferred=new en;const{data:a,error:i}=await this._refreshAccessToken(t);if(i)throw i;if(!a.session)throw new De;await this._saveSession(a.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",a.session);const o={data:a.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(a){if(this._debug(n,"error",a),V(a)){const i={data:null,error:a};return pn(a)||await this._removeSession(),(r=this.refreshingDeferred)===null||r===void 0||r.resolve(i),i}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(a),a}finally{this.refreshingDeferred=null,this._debug(n,"end")}}async _notifyAllSubscribers(t,r,s=!0){const n=`#_notifyAllSubscribers(${t})`;this._debug(n,"begin",r,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:t,session:r});const a=[],i=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(t,r)}catch(l){a.push(l)}});if(await Promise.all(i),a.length>0){for(let o=0;o<a.length;o+=1)console.error(a[o]);throw a[0]}}finally{this._debug(n,"end")}}async _saveSession(t){this._debug("#_saveSession()",t),this.suppressGetSessionWarning=!0,await Le(this.storage,`${this.storageKey}-code-verifier`);const r=Object.assign({},t),s=r.user&&r.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!s&&r.user&&await Xt(this.userStorage,this.storageKey+"-user",{user:r.user});const n=Object.assign({},r);delete n.user;const a=ii(n);await Xt(this.storage,this.storageKey,a)}else{const n=ii(r);await Xt(this.storage,this.storageKey,n)}}async _removeSession(){this._debug("#_removeSession()"),this.suppressGetSessionWarning=!1,await Le(this.storage,this.storageKey),await Le(this.storage,this.storageKey+"-code-verifier"),await Le(this.storage,this.storageKey+"-user"),this.userStorage&&await Le(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const t=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{t&&qe()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",t)}catch(r){console.error("removing visibilitychange callback failed",r)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const t=setInterval(()=>this._autoRefreshTokenTick(),Yt);this.autoRefreshTicker=t,t&&typeof t=="object"&&typeof t.unref=="function"?t.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(t);const r=setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0);this.autoRefreshTickTimeout=r,r&&typeof r=="object"&&typeof r.unref=="function"?r.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(r)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const t=this.autoRefreshTicker;this.autoRefreshTicker=null,t&&clearInterval(t);const r=this.autoRefreshTickTimeout;this.autoRefreshTickTimeout=null,r&&clearTimeout(r)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const t=Date.now();try{return await this._useSession(async r=>{const{data:{session:s}}=r;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const n=Math.floor((s.expires_at*1e3-t)/Yt);this._debug("#_autoRefreshTokenTick()",`access token expires in ${n} ticks, a tick lasts ${Yt}ms, refresh threshold is ${Mn} ticks`),n<=Mn&&await this._callRefreshToken(s.refresh_token)})}catch(r){console.error("Auto refresh tick failed with error. This is likely a transient error.",r)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(t){if(t.isAcquireTimeout||t instanceof Io)this._debug("auto refresh token tick lock not available");else throw t}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!qe()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>{try{await this._onVisibilityChanged(!1)}catch(t){this._debug("#visibilityChangedCallback","error",t)}},window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(t){console.error("_handleVisibilityChange",t)}}async _onVisibilityChanged(t){const r=`#_onVisibilityChanged(${t})`;this._debug(r,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),t||(await this.initializePromise,await this._acquireLock(this.lockAcquireTimeout,async()=>{if(document.visibilityState!=="visible"){this._debug(r,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(t,r,s){const n=[`provider=${encodeURIComponent(r)}`];if(s!=null&&s.redirectTo&&n.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&n.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[a,i]=await Wt(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(a)}`,code_challenge_method:`${encodeURIComponent(i)}`});n.push(o.toString())}if(s!=null&&s.queryParams){const a=new URLSearchParams(s.queryParams);n.push(a.toString())}return s!=null&&s.skipBrowserRedirect&&n.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${t}?${n.join("&")}`}async _unenroll(t){try{return await this._useSession(async r=>{var s;const{data:n,error:a}=r;return a?this._returnResult({data:null,error:a}):await Q(this.fetch,"DELETE",`${this.url}/factors/${t.factorId}`,{headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token})})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}}async _enroll(t){try{return await this._useSession(async r=>{var s,n;const{data:a,error:i}=r;if(i)return this._returnResult({data:null,error:i});const o=Object.assign({friendly_name:t.friendlyName,factor_type:t.factorType},t.factorType==="phone"?{phone:t.phone}:t.factorType==="totp"?{issuer:t.issuer}:{}),{data:l,error:c}=await Q(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(s=a==null?void 0:a.session)===null||s===void 0?void 0:s.access_token});return c?this._returnResult({data:null,error:c}):(t.factorType==="totp"&&l.type==="totp"&&(!((n=l==null?void 0:l.totp)===null||n===void 0)&&n.qr_code)&&(l.totp.qr_code=`data:image/svg+xml;utf-8,${l.totp.qr_code}`),this._returnResult({data:l,error:null}))})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}}async _verify(t){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async r=>{var s;const{data:n,error:a}=r;if(a)return this._returnResult({data:null,error:a});const i=Object.assign({challenge_id:t.challengeId},"webauthn"in t?{webauthn:Object.assign(Object.assign({},t.webauthn),{credential_response:t.webauthn.type==="create"?$d(t.webauthn.credential_response):Ad(t.webauthn.credential_response)})}:{code:t.code}),{data:o,error:l}=await Q(this.fetch,"POST",`${this.url}/factors/${t.factorId}/verify`,{body:i,headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});return l?this._returnResult({data:null,error:l}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),this._returnResult({data:o,error:l}))})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}})}async _challenge(t){return this._acquireLock(this.lockAcquireTimeout,async()=>{try{return await this._useSession(async r=>{var s;const{data:n,error:a}=r;if(a)return this._returnResult({data:null,error:a});const i=await Q(this.fetch,"POST",`${this.url}/factors/${t.factorId}/challenge`,{body:t,headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});if(i.error)return i;const{data:o}=i;if(o.type!=="webauthn")return{data:o,error:null};switch(o.webauthn.type){case"create":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:Td(o.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:Ed(o.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}})}async _challengeAndVerify(t){const{data:r,error:s}=await this._challenge({factorId:t.factorId});return s?this._returnResult({data:null,error:s}):await this._verify({factorId:t.factorId,challengeId:r.id,code:t.code})}async _listFactors(){var t;const{data:{user:r},error:s}=await this.getUser();if(s)return{data:null,error:s};const n={all:[],phone:[],totp:[],webauthn:[]};for(const a of(t=r==null?void 0:r.factors)!==null&&t!==void 0?t:[])n.all.push(a),a.status==="verified"&&n[a.factor_type].push(a);return{data:n,error:null}}async _getAuthenticatorAssuranceLevel(t){var r,s,n,a;if(t)try{const{payload:m}=_s(t);let f=null;m.aal&&(f=m.aal);let p=f;const{data:{user:_},error:y}=await this.getUser(t);if(y)return this._returnResult({data:null,error:y});((s=(r=_==null?void 0:_.factors)===null||r===void 0?void 0:r.filter(S=>S.status==="verified"))!==null&&s!==void 0?s:[]).length>0&&(p="aal2");const g=m.amr||[];return{data:{currentLevel:f,nextLevel:p,currentAuthenticationMethods:g},error:null}}catch(m){if(V(m))return this._returnResult({data:null,error:m});throw m}const{data:{session:i},error:o}=await this.getSession();if(o)return this._returnResult({data:null,error:o});if(!i)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:l}=_s(i.access_token);let c=null;l.aal&&(c=l.aal);let d=c;((a=(n=i.user.factors)===null||n===void 0?void 0:n.filter(m=>m.status==="verified"))!==null&&a!==void 0?a:[]).length>0&&(d="aal2");const h=l.amr||[];return{data:{currentLevel:c,nextLevel:d,currentAuthenticationMethods:h},error:null}}async _getAuthorizationDetails(t){try{return await this._useSession(async r=>{const{data:{session:s},error:n}=r;return n?this._returnResult({data:null,error:n}):s?await Q(this.fetch,"GET",`${this.url}/oauth/authorizations/${t}`,{headers:this.headers,jwt:s.access_token,xform:a=>({data:a,error:null})}):this._returnResult({data:null,error:new De})})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}}async _approveAuthorization(t,r){try{return await this._useSession(async s=>{const{data:{session:n},error:a}=s;if(a)return this._returnResult({data:null,error:a});if(!n)return this._returnResult({data:null,error:new De});const i=await Q(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:n.access_token,body:{action:"approve"},xform:o=>({data:o,error:null})});return i.data&&i.data.redirect_url&&qe()&&!(r!=null&&r.skipBrowserRedirect)&&window.location.assign(i.data.redirect_url),i})}catch(s){if(V(s))return this._returnResult({data:null,error:s});throw s}}async _denyAuthorization(t,r){try{return await this._useSession(async s=>{const{data:{session:n},error:a}=s;if(a)return this._returnResult({data:null,error:a});if(!n)return this._returnResult({data:null,error:new De});const i=await Q(this.fetch,"POST",`${this.url}/oauth/authorizations/${t}/consent`,{headers:this.headers,jwt:n.access_token,body:{action:"deny"},xform:o=>({data:o,error:null})});return i.data&&i.data.redirect_url&&qe()&&!(r!=null&&r.skipBrowserRedirect)&&window.location.assign(i.data.redirect_url),i})}catch(s){if(V(s))return this._returnResult({data:null,error:s});throw s}}async _listOAuthGrants(){try{return await this._useSession(async t=>{const{data:{session:r},error:s}=t;return s?this._returnResult({data:null,error:s}):r?await Q(this.fetch,"GET",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:r.access_token,xform:n=>({data:n,error:null})}):this._returnResult({data:null,error:new De})})}catch(t){if(V(t))return this._returnResult({data:null,error:t});throw t}}async _revokeOAuthGrant(t){try{return await this._useSession(async r=>{const{data:{session:s},error:n}=r;return n?this._returnResult({data:null,error:n}):s?(await Q(this.fetch,"DELETE",`${this.url}/user/oauth/grants`,{headers:this.headers,jwt:s.access_token,query:{client_id:t.clientId},noResolveJson:!0}),{data:{},error:null}):this._returnResult({data:null,error:new De})})}catch(r){if(V(r))return this._returnResult({data:null,error:r});throw r}}async fetchJwk(t,r={keys:[]}){let s=r.keys.find(o=>o.kid===t);if(s)return s;const n=Date.now();if(s=this.jwks.keys.find(o=>o.kid===t),s&&this.jwks_cached_at+Mc>n)return s;const{data:a,error:i}=await Q(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(i)throw i;return!a.keys||a.keys.length===0||(this.jwks=a,this.jwks_cached_at=n,s=a.keys.find(o=>o.kid===t),!s)?null:s}async getClaims(t,r={}){try{let s=t;if(!s){const{data:m,error:f}=await this.getSession();if(f||!m.session)return this._returnResult({data:null,error:f});s=m.session.access_token}const{header:n,payload:a,signature:i,raw:{header:o,payload:l}}=_s(s);r!=null&&r.allowExpired||ad(a.exp);const c=!n.alg||n.alg.startsWith("HS")||!n.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(n.kid,r!=null&&r.keys?{keys:r.keys}:r==null?void 0:r.jwks);if(!c){const{error:m}=await this.getUser(s);if(m)throw m;return{data:{claims:a,header:n,signature:i},error:null}}const d=id(n.alg),u=await crypto.subtle.importKey("jwk",c,d,!0,["verify"]);if(!await crypto.subtle.verify(d,u,i,zc(`${o}.${l}`)))throw new Hn("Invalid JWT signature");return{data:{claims:a,header:n,signature:i},error:null}}catch(s){if(V(s))return this._returnResult({data:null,error:s});throw s}}}Gr.nextInstanceID={};const Nd=Gr,jd="2.95.3";let Ir="";typeof Deno<"u"?Ir="deno":typeof document<"u"?Ir="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Ir="react-native":Ir="node";const Hd={"X-Client-Info":`supabase-js-${Ir}/${jd}`},Ud={headers:Hd},Fd={schema:"public"},Bd={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},Kd={};function Jr(e){"@babel/helpers - typeof";return Jr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Jr(e)}function Wd(e,t){if(Jr(e)!="object"||!e)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var s=r.call(e,t);if(Jr(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function zd(e){var t=Wd(e,"string");return Jr(t)=="symbol"?t:t+""}function Vd(e,t,r){return(t=zd(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function fi(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),r.push.apply(r,s)}return r}function fe(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};t%2?fi(Object(r),!0).forEach(function(s){Vd(e,s,r[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):fi(Object(r)).forEach(function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(r,s))})}return e}const Gd=e=>e?(...t)=>e(...t):(...t)=>fetch(...t),Jd=()=>Headers,Qd=(e,t,r)=>{const s=Gd(r),n=Jd();return async(a,i)=>{var o;const l=(o=await t())!==null&&o!==void 0?o:e;let c=new n(i==null?void 0:i.headers);return c.has("apikey")||c.set("apikey",e),c.has("Authorization")||c.set("Authorization",`Bearer ${l}`),s(a,fe(fe({},i),{},{headers:c}))}};function Yd(e){return e.endsWith("/")?e:e+"/"}function Xd(e,t){var r,s;const{db:n,auth:a,realtime:i,global:o}=e,{db:l,auth:c,realtime:d,global:u}=t,h={db:fe(fe({},l),n),auth:fe(fe({},c),a),realtime:fe(fe({},d),i),storage:{},global:fe(fe(fe({},u),o),{},{headers:fe(fe({},(r=u==null?void 0:u.headers)!==null&&r!==void 0?r:{}),(s=o==null?void 0:o.headers)!==null&&s!==void 0?s:{})}),accessToken:async()=>""};return e.accessToken?h.accessToken=e.accessToken:delete h.accessToken,h}function Zd(e){const t=e==null?void 0:e.trim();if(!t)throw new Error("supabaseUrl is required.");if(!t.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Yd(t))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}var eu=class extends Nd{constructor(e){super(e)}},tu=class{constructor(e,t,r){var s,n;this.supabaseUrl=e,this.supabaseKey=t;const a=Zd(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",a),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",a),this.storageUrl=new URL("storage/v1",a),this.functionsUrl=new URL("functions/v1",a);const i=`sb-${a.hostname.split(".")[0]}-auth-token`,o={db:Fd,realtime:Kd,auth:fe(fe({},Bd),{},{storageKey:i}),global:Ud},l=Xd(r??{},o);if(this.storageKey=(s=l.auth.storageKey)!==null&&s!==void 0?s:"",this.headers=(n=l.global.headers)!==null&&n!==void 0?n:{},l.accessToken)this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(d,u)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(u)} is not possible`)}});else{var c;this.auth=this._initSupabaseAuthClient((c=l.auth)!==null&&c!==void 0?c:{},this.headers,l.global.fetch)}this.fetch=Qd(t,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(fe({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.accessToken&&Promise.resolve(this.accessToken()).then(d=>this.realtime.setAuth(d)).catch(d=>console.warn("Failed to set initial Realtime auth token:",d)),this.rest=new jl(new URL("rest/v1",a).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch,timeout:l.db.timeout,urlLengthLimit:l.db.urlLengthLimit}),this.storage=new Rc(this.storageUrl.href,this.headers,this.fetch,r==null?void 0:r.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new Cl(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},r={head:!1,get:!1,count:void 0}){return this.rest.rpc(e,t,r)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var e=this,t,r;if(e.accessToken)return await e.accessToken();const{data:s}=await e.auth.getSession();return(t=(r=s.session)===null||r===void 0?void 0:r.access_token)!==null&&t!==void 0?t:e.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,userStorage:n,storageKey:a,flowType:i,lock:o,debug:l,throwOnError:c},d,u){const h={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new eu({url:this.authUrl.href,headers:fe(fe({},h),d),storageKey:a,autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,userStorage:n,flowType:i,lock:o,debug:l,throwOnError:c,fetch:u,hasCustomAuthorizationHeader:Object.keys(this.headers).some(m=>m.toLowerCase()==="authorization")})}_initRealtimeClient(e){return new rc(this.realtimeUrl.href,fe(fe({},e),{},{params:fe(fe({},{apikey:this.supabaseKey}),e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((e,t)=>{this._handleTokenChanged(e,"CLIENT",t==null?void 0:t.access_token)})}_handleTokenChanged(e,t,r){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==r?(this.changedAccessToken=r,this.realtime.setAuth(r)):e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}};const ru=(e,t,r)=>new tu(e,t,r);function su(){if(typeof window<"u")return!1;const e=globalThis.process;if(!e)return!1;const t=e.version;if(t==null)return!1;const r=t.match(/^v(\d+)\./);return r?parseInt(r[1],10)<=18:!1}su()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const nu="https://ujxczpaupfqaiqrcoykl.supabase.co",au="sb_publishable_EJ7wzzBh1hnKE0j_j7E1mQ_9TAJvRoO",w=ru(nu,au),mi="app-toast-container";function iu(){let e=document.getElementById(mi);return e||(e=document.createElement("div"),e.id=mi,e.className="toast-container position-fixed top-0 end-0 p-3",e.style.zIndex="1080",document.body.appendChild(e)),e}function ou(e){return e==="success"?"text-bg-success":e==="error"?"text-bg-danger":e==="warning"?"text-bg-warning":"text-bg-primary"}function lu(e){const t=String(e||"").trim(),r=t.toLowerCase();return t?r.includes("row-level security")||r.includes("violates row-level security policy")?"     .":r.includes("foreign key constraint")||r.includes("violates foreign key constraint")?"     ,       .":r.includes("duplicate key value")||r.includes("unique constraint")||r.includes("already exists")?"     .":r.includes("violates not-null constraint")?"  .   .":r.includes("invalid input syntax")||r.includes("invalid uuid")||r.includes("date/time field value out of range")?"    .":r.includes("permission denied")||r.includes("not authorized")||r.includes("unauthorized")?"    .":r.includes("jwt")||r.includes("token")||r.includes("session")?"  .    .":r.includes("failed to fetch")||r.includes("networkerror")||r.includes("network request failed")?"  .     .":t:"  ."}function v(e,t="info"){const r=iu(),s=document.createElement("div"),n=t==="error"?lu(e):String(e??"");s.className=`toast align-items-center border-0 ${ou(t)} show`,s.setAttribute("role","alert"),s.setAttribute("aria-live","assertive"),s.setAttribute("aria-atomic","true"),s.innerHTML=`
    <div class="d-flex">
      <div class="toast-body">${n}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
    </div>
  `;const a=s.querySelector("button");a==null||a.addEventListener("click",()=>{s.remove()}),r.appendChild(s),window.setTimeout(()=>{s.remove()},4e3)}async function hr(){const{data:e,error:t}=await w.auth.getSession();return t?null:e.session||null}async function ga(e){if(!e)return!1;const{data:t,error:r}=await w.from("user_roles").select("id").eq("user_id",e).eq("role","admin").limit(1);return r?!1:Array.isArray(t)&&t.length>0}async function cu(){var r;const e=await hr(),t=((r=e==null?void 0:e.user)==null?void 0:r.id)||"";return t?ga(t):!1}async function Un(e){if(!e)return!1;const{data:t,error:r}=await w.from("user_roles").select("id").eq("user_id",e).limit(1);return r?!1:Array.isArray(t)&&t.length>0}async function Po(e){if(!e)return!1;const{data:t,error:r}=await w.from("user_profiles").select("is_active").eq("id",e).maybeSingle();return r?!1:t?t.is_active!==!1:!0}async function pi(){var s;const e=await hr(),t=((s=e==null?void 0:e.user)==null?void 0:s.id)||"";return t?await Po(t)?{allowed:!0,reason:""}:(await w.auth.signOut(),{allowed:!1,reason:"inactive-profile"}):{allowed:!1,reason:"no-session"}}const Mo="traincrewhub_permission_banner_enabled",du={page_plan_schedule:" -",page_schedule:" ",schedule_keys:"-",duties:"",duty_types:" ",trains:"",employees:"",employee_absences:"",planned_duties:" ",actual_duties:" ",user_roles:"  ",user_profiles:" ",role_permissions:"  ",schedule_key_duties:"  -",positions:"",absence_reasons:"  ",duty_trains:"  ",documents:""},Fn={none:0,own:1,role_attached_employees:2,all:3};let qt="",xt=new Map,Tt=!1,Pt=null;function Ct(e){const t=String(e||"").trim();return Object.hasOwn(Fn,t)?t:"none"}function kr(e,t){const r=Ct(e),s=Ct(t);return Fn[r]>=Fn[s]?r:s}async function uu(){var l,c;const{data:e}=await w.auth.getSession(),t=((c=(l=e==null?void 0:e.session)==null?void 0:l.user)==null?void 0:c.id)||"";if(!t){qt="",xt=new Map,Tt=!0;return}if(Tt&&qt===t)return;const{data:r,error:s}=await w.from("user_roles").select("role").eq("user_id",t);if(s){qt=t,xt=new Map,Tt=!0;return}const n=[...new Set((r||[]).map(d=>String((d==null?void 0:d.role)||"").trim()).filter(Boolean))];if(!n.length){qt=t,xt=new Map,Tt=!0;return}const{data:a,error:i}=await w.from("role_permissions").select("resource, view_screen_scope, view_records_scope, create_records_scope, edit_records_scope, delete_records_scope").in("role",n);if(i){qt=t,xt=new Map,Tt=!0;return}const o=new Map;(a||[]).forEach(d=>{const u=String((d==null?void 0:d.resource)||"").trim();if(!u)return;const h=o.get(u)||{view_screen_scope:"none",view_records_scope:"none",create_records_scope:"none",edit_records_scope:"none",delete_records_scope:"none"};o.set(u,{view_screen_scope:kr(h.view_screen_scope,d==null?void 0:d.view_screen_scope),view_records_scope:kr(h.view_records_scope,d==null?void 0:d.view_records_scope),create_records_scope:kr(h.create_records_scope,d==null?void 0:d.create_records_scope),edit_records_scope:kr(h.edit_records_scope,d==null?void 0:d.edit_records_scope),delete_records_scope:kr(h.delete_records_scope,d==null?void 0:d.delete_records_scope)})}),qt=t,xt=o,Tt=!0}async function rt(e,t){await uu();const r=String(e||"").trim(),s=String(t||"").trim();if(!r||!s)return"none";const n=xt.get(r);return n?s==="view_screen"?Ct(n.view_screen_scope):s==="view_records"?Ct(n.view_records_scope):s==="edit_records"?Ct(n.edit_records_scope):s==="create_records"?Ct(n.create_records_scope):s==="delete_records"?Ct(n.delete_records_scope):"none":"none"}async function No(e){return await rt(e,"view_screen")!=="none"}async function hu(e){const t=String(e||"").trim();if(!t)return{view_screen:"none",view_records:"none",create_records:"none",edit_records:"none",delete_records:"none"};const[r,s,n,a,i]=await Promise.all([rt(t,"view_screen"),rt(t,"view_records"),rt(t,"create_records"),rt(t,"edit_records"),rt(t,"delete_records")]);return{view_screen:r,view_records:s,create_records:n,edit_records:a,delete_records:i}}function vn(e,t){e&&(e.disabled=t,e.classList.toggle("disabled",t))}async function fu(e,t){Pt&&(Pt(),Pt=null);const r=String(t||"").trim();if(!e||!r)return;const s=await rt(r,"edit_records"),n=await rt(r,"create_records"),a=await rt(r,"delete_records"),i=n==="none",o=s==="none",l=a==="none",c=['button[id^="open-create-"]','button[id^="open-add-"]'],d=['[data-action="edit"]','[data-duty-action="edit"]','[data-action="duplicate"]','[data-duty-action="duplicate"]'],u=['[data-action="delete"]','[data-duty-action="delete"]'],h=()=>{i&&e.querySelectorAll(c.join(",")).forEach(p=>vn(p,!0)),o&&e.querySelectorAll(d.join(",")).forEach(p=>vn(p,!0)),l&&e.querySelectorAll(u.join(",")).forEach(p=>vn(p,!0))},m=p=>{const _=p.target;if(_){if(i&&_.closest(c.join(","))){p.preventDefault(),p.stopPropagation(),v("   .","warning");return}if(o&&_.closest(d.join(","))){p.preventDefault(),p.stopPropagation(),v("   .","warning");return}l&&_.closest(u.join(","))&&(p.preventDefault(),p.stopPropagation(),v("   .","warning"))}},f=new MutationObserver(()=>{h()});h(),e.addEventListener("click",m,!0),f.observe(e,{childList:!0,subtree:!0}),Pt=()=>{e.removeEventListener("click",m,!0),f.disconnect()}}function mu(){Pt&&(Pt(),Pt=null)}function jo(){qt="",xt=new Map,Tt=!1}function tn(e){const t=String(e||"").trim();return t?du[t]||t:"-"}function Ho(){try{const e=localStorage.getItem(Mo);return e===null?!0:e==="true"}catch{return!0}}function pu(e){try{localStorage.setItem(Mo,String(!!e))}catch{}}let bn,Ss,ws,ks;async function yu(e){const t=await ue("./header.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("nav.navbar"),s=e.querySelector("#nav-sign-in"),n=e.querySelector("#nav-register"),a=e.querySelector("#nav-my-profile"),i=e.querySelector("#nav-logout"),o=e.querySelector("#nav-admin"),l=i==null?void 0:i.querySelector("button"),c=e.querySelector("#mainNav"),d=e.querySelector(".navbar-toggler"),u=()=>{e.querySelectorAll(".nav-item.dropdown").forEach(p=>{var y;p.classList.remove("show"),(y=p.querySelector(".dropdown-menu"))==null||y.classList.remove("show");const _=p.querySelector(".dropdown-toggle");_&&_.setAttribute("aria-expanded","false")})},h=()=>{const p=window.location.pathname;e.querySelectorAll("a[data-link]").forEach(b=>{const S=b.getAttribute("href")===p;b.classList.toggle("active",S),b.setAttribute("aria-current",S?"page":"false")}),e.querySelectorAll(".nav-item.dropdown").forEach(b=>{const g=b.querySelector(".dropdown-toggle"),S=!!b.querySelector(".dropdown-item.active");g==null||g.classList.toggle("active",S),g&&g.setAttribute("aria-current",S?"page":"false")})},m=async()=>{var L;const{data:p}=await w.auth.getSession(),_=p.session,y=!!_,b=((L=_==null?void 0:_.user)==null?void 0:L.id)||"",g=b?await Un(b):!1,S=y&&!g;if(r==null||r.classList.toggle("d-none",!y),s==null||s.classList.toggle("d-none",y),n==null||n.classList.toggle("d-none",y),i==null||i.classList.toggle("d-none",!y),S){e.querySelectorAll("#mainNav .navbar-nav > li").forEach($=>{$.classList.add("d-none")}),i==null||i.classList.remove("d-none"),o==null||o.classList.add("d-none"),a==null||a.classList.add("d-none");return}let k=!1;b&&(k=await ga(b)),o==null||o.classList.toggle("d-none",!k),a==null||a.classList.toggle("d-none",!k);const E={"/schedule-keys":"schedule_keys","/duties":"duties","/duty-types":"duty_types","/trains":"trains","/employees":"employees","/employee-absences":"employee_absences","/planned-duties":"planned_duties","/actual-duties":"actual_duties","/documents":"documents","/user-profiles":"user_profiles","/plan-schedule":"page_plan_schedule","/schedule":"page_schedule","/schedule-key-duties":"duties"};await Promise.all(Object.entries(E).map(async([$,q])=>{const T=e.querySelector(`a[data-link][href="${$}"]`),C=T==null?void 0:T.closest("li");if(!T||!C)return;if(!y){C.classList.add("d-none");return}const A=await No(q);C.classList.toggle("d-none",!A)}))};e.addEventListener("click",p=>{const _=p.target.closest(".dropdown-toggle");if(_&&e.contains(_)){p.preventDefault();const b=_.closest(".nav-item.dropdown"),g=b==null?void 0:b.querySelector(".dropdown-menu"),S=b==null?void 0:b.classList.contains("show");u(),!S&&b&&g&&(b.classList.add("show"),g.classList.add("show"),_.setAttribute("aria-expanded","true"));return}p.target.closest("a[data-link]")&&(u(),c!=null&&c.classList.contains("show")&&(c.classList.remove("show"),d==null||d.setAttribute("aria-expanded","false")))}),l==null||l.addEventListener("click",async()=>{const{error:p}=await w.auth.signOut();if(p){v(p.message,"error");return}v("Logged out successfully.","success"),window.history.pushState({},"","/login"),window.dispatchEvent(new PopStateEvent("popstate"))}),bn&&bn.unsubscribe(),Ss&&window.removeEventListener("route:changed",Ss),ws&&document.removeEventListener("click",ws),ks&&document.removeEventListener("keydown",ks),Ss=h,window.addEventListener("route:changed",Ss),ws=p=>{e.contains(p.target)||u()},document.addEventListener("click",ws),ks=p=>{p.key==="Escape"&&u()},document.addEventListener("keydown",ks);const{data:f}=w.auth.onAuthStateChange(()=>{jo(),m()});bn=f.subscription,await m(),h()}async function gu(e){const t=await ue("./footer.html",import.meta.url);e.innerHTML=t}async function vu(e){const t=await ue("./page.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("#app-header"),s=e.querySelector("#app-footer");await Promise.all([yu(r),gu(s)])}function jt(e){if(!e)return"00:00";const t=String(e).match(/(\d{1,2}):(\d{2})(?::\d{2})?/);if(!t)return"00:00";const[,r,s]=t;return`${r.padStart(2,"0")}:${s}`}function yi(e){if(!e)return 0;const[t,r]=e.split(":"),s=Number(t),n=Number(r);return!Number.isFinite(s)||!Number.isFinite(n)?0:s*60+n}function Ie(e,t){const r=yi(e),s=yi(t);return s>=r?s-r:24*60-r+s}async function bu(e,t){const{setText:r,formatDateTime:s,escapeHtml:n}=t,[a,i,o,l]=await Promise.all([w.from("user_profiles").select("id",{count:"exact",head:!0}),w.from("user_roles").select("user_id"),w.from("roles").select("name",{count:"exact",head:!0}),w.from("user_profiles").select("id",{count:"exact",head:!0}).not("employee_id","is",null)]);[a,i,o,l].some(u=>u.error)&&v("           .","warning");const d=new Set((i.data||[]).map(u=>u.user_id).filter(Boolean));r(e,"#index-kpi-planned",String(a.count??0)),r(e,"#index-kpi-actual",String(d.size)),r(e,"#index-kpi-absences",String(l.count??0)),r(e,"#index-kpi-employees",String(o.count??0)),await _u(e,{setText:r,formatDateTime:s,escapeHtml:n}),r(e,"#index-last-updated",` : ${s(new Date)}`)}async function _u(e,t){const{setText:r,formatDateTime:s,escapeHtml:n}=t,a=e.querySelector("#index-pending-users-panel"),i=e.querySelector("#index-pending-users-body");if(!a||!i)return;const[{data:o,error:l},{data:c,error:d}]=await Promise.all([w.from("user_profiles").select("id, username, created_at").order("created_at",{ascending:!0}),w.from("user_roles").select("user_id")]);if(l||d){v("        .","warning"),r(e,"#index-pending-users-count","0"),i.innerHTML='<tr><td colspan="3" class="text-secondary">  .</td></tr>';return}const u=new Set((c||[]).map(m=>String((m==null?void 0:m.user_id)||"").trim()).filter(Boolean)),h=(o||[]).filter(m=>!u.has(String((m==null?void 0:m.id)||"").trim()));if(r(e,"#index-pending-users-count",String(h.length)),!h.length){i.innerHTML='<tr><td colspan="3" class="text-secondary">  .</td></tr>';return}i.innerHTML=h.map(m=>{const f=String((m==null?void 0:m.username)||"").trim()||String((m==null?void 0:m.id)||"-"),p=(m==null?void 0:m.created_at)||"",_=p?new Date(p):null,y=_&&!Number.isNaN(_.getTime())?s(_):"-",b=Su(p);return`
        <tr>
          <td>${n(f)}</td>
          <td>${n(y)}</td>
          <td>${n(b)}</td>
        </tr>
      `}).join("")}function Su(e){if(!e)return"-";const t=new Date(e);if(Number.isNaN(t.getTime()))return"-";const r=Math.max(Date.now()-t.getTime(),0),s=Math.floor(r/6e4),n=Math.floor(s/(24*60)),a=Math.floor(s%(24*60)/60),i=s%60;return n>0?`${n}  ${a} `:a>0?`${a}  ${i} `:i>0?`${i} `:" 1 "}function wu(e){const{loadKpiSnapshot:t,getTodayIsoDate:r,formatDate:s,escapeHtml:n,formatMinutesAsClock:a,formatSignedMinutesAsClock:i,getDeviationClassByThreshold:o,parseIsoDateSafe:l,toMonthKey:c,getMonthBounds:d,countBulgarianWorkdays:u,getDutyTimingSummary:h,getActualDutyTimingSummary:m,getDistinctBadgeClassByReason:f}=e,p={groups:[],selectedKey:""};function _(A,x,D,P){const U=A.querySelector(x);if(U){if(!D.length){U.innerHTML=`<tr><td colspan="3" class="text-secondary">${P}</td></tr>`;return}U.innerHTML=D.map(W=>`
        <tr>
          <td>${n(W.employeeName)}</td>
          <td>${n(W.certificateLabel)}</td>
          <td>${n(s(W.date))}</td>
        </tr>
      `).join("")}}function y(A){const x=new Date;x.setHours(0,0,0,0);const D=new Date(x);D.setDate(D.getDate()+30);const P=[{key:"psychological_assessment_expiry",label:" "},{key:"medical_certificate_expiry",label:""},{key:"license_expiry",label:""}],U=[],W=[];(A||[]).forEach(H=>{const K=`${(H==null?void 0:H.first_name)||""} ${(H==null?void 0:H.last_name)||""}`.trim()||"-";P.forEach(ee=>{const R=H==null?void 0:H[ee.key];if(!R)return;const O=new Date(`${R}T00:00:00`);if(Number.isNaN(O.getTime()))return;const N={employeeName:K,certificateLabel:ee.label,date:R};if(O<x){W.push(N);return}O<=D&&U.push(N)})});const z=(H,K)=>{const ee=String(H.date).localeCompare(String(K.date));return ee!==0?ee:String(H.employeeName).localeCompare(String(K.employeeName),"bg")};return{soon:U.sort(z),expired:W.sort(z)}}function b(A,x){return x?A==="expired"?"text-bg-danger":"text-bg-warning":"text-bg-secondary"}function g(A,x){const D=A.querySelector("#index-certificates-soon-details"),P=A.querySelector("#index-certificates-expired-details");if(!(!D||!P)){if(x==="soon"){D.classList.toggle("d-none"),P.classList.add("d-none");return}x==="expired"&&(P.classList.toggle("d-none"),D.classList.add("d-none"))}}async function S(A){const x=A.querySelector("#index-certificates-panel"),D=A.querySelector("#index-certificates-soon-toggle"),P=A.querySelector("#index-certificates-expired-toggle");if(!x||!D||!P)return;const{data:U,error:W}=await w.from("employees").select("first_name, last_name, psychological_assessment_expiry, medical_certificate_expiry, license_expiry").eq("is_active",!0).order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(W){v("     .","warning"),D.textContent="0",P.textContent="0",D.className="badge text-bg-secondary border-0",P.className="badge text-bg-secondary border-0",_(A,"#index-certificates-soon-body",[]," ."),_(A,"#index-certificates-expired-body",[]," .");return}const z=y(U||[]);D.textContent=String(z.soon.length),P.textContent=String(z.expired.length),D.className=`badge ${b("soon",z.soon.length)} border-0`,P.className=`badge ${b("expired",z.expired.length)} border-0`,_(A,"#index-certificates-soon-body",z.soon,"    ."),_(A,"#index-certificates-expired-body",z.expired,"    .")}function k(A){const x=new Map;(A||[]).forEach(P=>{var ee,R,O;const U=String(((ee=P==null?void 0:P.absence_reasons)==null?void 0:ee.name)||"").trim()||"  ",W=`${((R=P==null?void 0:P.employees)==null?void 0:R.first_name)||""} ${((O=P==null?void 0:P.employees)==null?void 0:O.last_name)||""}`.trim()||"-",z=(P==null?void 0:P.start_date)||"",H=(P==null?void 0:P.end_date)||"",K=x.get(U)||{reason:U,details:[]};K.details.push({employeeName:W,startDate:z,endDate:H}),x.set(U,K)});const D=Array.from(x.values()).map(P=>({...P,details:P.details.sort((U,W)=>String(U.employeeName).localeCompare(String(W.employeeName),"bg")),count:P.details.length}));return D.sort((P,U)=>U.count!==P.count?U.count-P.count:String(P.reason).localeCompare(String(U.reason),"bg")),D}function E(A,x){const D=A.querySelector("#index-absence-reasons-body");if(D){if(!x.length){D.innerHTML='<p class="text-secondary mb-0">  .</p>';return}D.innerHTML=x.map((P,U)=>{const W=f(P.reason),z=String(U),H=z===p.selectedKey,K=P.details.map(ee=>{const R=`${s(ee.startDate)} - ${s(ee.endDate)}`;return`
              <tr>
                <td>${n(ee.employeeName)}</td>
                <td>${n(R)}</td>
              </tr>
            `}).join("");return`
          <div class="d-flex justify-content-between align-items-center border rounded p-2">
            <span>${n(P.reason)}</span>
            <button
              type="button"
              class="badge ${W} border-0"
              data-index-absence-action="toggle-reason"
              data-index-absence-key="${z}"
              aria-expanded="${H?"true":"false"}"
            >
              ${n(String(P.count))}
            </button>
          </div>
          ${H?`
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  ${K}
                </tbody>
              </table>
            </div>
          `:""}
        `}).join("")}}function L(A,x){if(x===""||x===p.selectedKey){p.selectedKey="",E(A,p.groups);return}if(!(p.groups[Number(x)]||null)){p.selectedKey="",E(A,p.groups);return}p.selectedKey=String(x),E(A,p.groups)}async function $(A){const x=r(),{data:D,error:P}=await w.from("employee_absences").select("start_date, end_date, employees(first_name, last_name), absence_reasons(name)").lte("start_date",x).gte("end_date",x).order("start_date",{ascending:!0});if(P){v("     .","warning"),p.groups=[],p.selectedKey="",E(A,[]);return}p.groups=k(D||[]),p.selectedKey="",E(A,p.groups)}function q(A,x){const D=A.querySelector("#index-workload-body");if(D){if(!x.length){D.innerHTML='<tr><td colspan="5" class="text-secondary"> .</td></tr>';return}D.innerHTML=x.map(P=>`
        <tr>
          <td>${n(P.employeeName)}</td>
          <td>${n(P.planned)}</td>
          <td>${n(P.actual)}</td>
          <td>${n(P.norm)}</td>
          <td><span class="badge ${n(P.deviationClass)}">${n(P.deviation)}</span></td>
        </tr>
      `).join("")}}async function T(A){const x=A.querySelector("#index-workload-date"),D=String((x==null?void 0:x.value)||r()),P=l(D);if(!P){q(A,[]);return}const U=c(P),{startDate:W}=d(U),z=u(W,D)*8*60,[H,K,ee]=await Promise.all([w.from("employees").select("id, first_name, last_name").eq("is_active",!0).order("last_name",{ascending:!0}).order("first_name",{ascending:!0}),w.from("planned_duties").select("employee_id, date, duties(start_time, end_time, break_start_time, break_end_time)").gte("date",W).lte("date",D),w.from("actual_duties").select("employee_id, date, start_time_override, end_time_override, break_start_time_override, break_end_time_override, duties(start_time, end_time, break_start_time, break_end_time)").gte("date",W).lte("date",D)]);if(H.error||K.error||ee.error){v("     .","warning"),q(A,[]);return}const R=H.data||[],O=K.data||[],N=ee.data||[],B=new Map;O.forEach(j=>{const J=String((j==null?void 0:j.employee_id)||"");if(!J)return;const ie=Number(h(j==null?void 0:j.duties).durationMinutes);Number.isFinite(ie)&&B.set(J,Number(B.get(J)||0)+ie)});const Y=new Map;N.forEach(j=>{const J=String((j==null?void 0:j.employee_id)||"");if(!J)return;const ie=Number(m(j).durationMinutes);Number.isFinite(ie)&&Y.set(J,Number(Y.get(J)||0)+ie)});const te=R.map(j=>{const J=String((j==null?void 0:j.id)||""),ie=`${(j==null?void 0:j.first_name)||""} ${(j==null?void 0:j.last_name)||""}`.trim()||"-",oe=Number(B.get(J)||0),me=Number(Y.get(J)||0),ke=me-z;return{employeeName:ie,planned:a(oe),actual:a(me),norm:a(z),deviation:i(ke),deviationClass:o(ke),deviationMinutes:ke}});te.sort((j,J)=>{const ie=Math.abs(Number(J.deviationMinutes||0))-Math.abs(Number(j.deviationMinutes||0));return ie!==0?ie:String(j.employeeName).localeCompare(String(J.employeeName),"bg")}),q(A,te)}async function C(A){await Promise.all([t(A),S(A),$(A),T(A)])}return{toggleCertificateDetails:g,toggleAbsenceReasonDetails:L,loadHeadOfTransportWorkload:T,loadHeadOfTransportSnapshot:C}}function ku(e){return String(e||"").trim().toLowerCase()}function Dr(e,t){const r=(e||[]).map(s=>ku(s));return t.some(s=>r.includes(s))}function Uo(e){return Dr(e,["crew","crew_member","user"])}function Lu(e){return Dr(e,["admin"])?"admin":Dr(e,["head_of_transport"])?"head_of_transport":Dr(e,["crew_instructor","instructor"])?"instructor":Dr(e,["crew_manager"])?"manager":Uo(e)?"crew":"default"}function Rt(e){return e==="head_of_transport"||e==="instructor"}function qu(e,t){const{loadCrewMonthlySnapshot:r,crewCalendarState:s,toMonthKey:n,shiftMonthKey:a,getTodayIsoDate:i,renderCrewCalendarAndDetails:o,openCrewActualDutyEditModal:l,openCrewTimetablePreview:c,closeCrewTimetablePreview:d,closeCrewActualDutyEditModal:u,saveCrewActualDutyEdits:h}=t,m=e.querySelector("#index-refresh-crew"),f=e.querySelector("#index-crew-prev-month"),p=e.querySelector("#index-crew-next-month"),_=e.querySelector("#index-crew-today-month"),y=e.querySelector("#index-crew-calendar-days"),b=e.querySelector("#index-crew-actual-body"),g=e.querySelector("#index-timetable-preview-modal"),S=e.querySelector("#index-timetable-preview-close"),k=e.querySelector("#index-actual-duty-edit-modal"),E=e.querySelector("#index-actual-duty-edit-close"),L=e.querySelector("#index-actual-duty-edit-cancel"),$=e.querySelector("#index-actual-duty-edit-form");m==null||m.addEventListener("click",async()=>{const q=e.dataset.indexMode||"default",T=e.dataset.indexEmployeeId||"";q==="crew"&&(m.disabled=!0,await r(e,T,s.visibleMonth),m.disabled=!1)}),f==null||f.addEventListener("click",async()=>{const q=e.dataset.indexMode||"default",T=e.dataset.indexEmployeeId||"";if(q!=="crew")return;const C=s.visibleMonth||n(new Date),A=a(C,-1);await r(e,T,A)}),p==null||p.addEventListener("click",async()=>{const q=e.dataset.indexMode||"default",T=e.dataset.indexEmployeeId||"";if(q!=="crew")return;const C=s.visibleMonth||n(new Date),A=a(C,1);await r(e,T,A)}),_==null||_.addEventListener("click",async()=>{const q=e.dataset.indexMode||"default",T=e.dataset.indexEmployeeId||"";if(q!=="crew")return;const C=new Date;s.visibleMonth=n(C),s.selectedDate=i(),await r(e,T,s.visibleMonth)}),y==null||y.addEventListener("click",q=>{const T=q.target.closest('button[data-index-crew-action="select-day"]');if(!T||(e.dataset.indexMode||"default")!=="crew")return;const A=T.getAttribute("data-date")||"";A&&(s.selectedDate=A,o(e))}),b==null||b.addEventListener("click",q=>{const T=q.target.closest('button[data-index-crew-action="edit-actual-duty"]');if(T){if((e.dataset.indexMode||"default")!=="crew")return;const U=T.getAttribute("data-actual-duty-id")||"";if(!U)return;l(e,U);return}const C=q.target.closest('button[data-index-crew-action="preview-timetable"]');if(!C||(e.dataset.indexMode||"default")!=="crew")return;const x=decodeURIComponent(C.getAttribute("data-preview-url")||""),D=decodeURIComponent(C.getAttribute("data-preview-label")||"");c(e,x,D)}),S==null||S.addEventListener("click",()=>{d(e)}),g==null||g.addEventListener("click",q=>{q.target===g&&d(e)}),E==null||E.addEventListener("click",()=>{u(e)}),L==null||L.addEventListener("click",()=>{u(e)}),k==null||k.addEventListener("click",q=>{q.target===k&&u(e)}),$==null||$.addEventListener("submit",async q=>{q.preventDefault(),await h(e)})}function Tu(e){const{crewCalendarState:t,ensureCrewSelectedDate:r,renderCrewCalendar:s,renderCrewHoursSummary:n,renderCrewSelectedDayDetails:a,toMonthKey:i,getMonthBounds:o,loadSchedulePublicationDates:l,loadScheduleChangesSummary:c,formatDateTime:d,setText:u}=e;function h(f){r(t.visibleMonth),s(f),n(f),a(f)}async function m(f,p,_){const y=_||t.visibleMonth||i(new Date);if(t.visibleMonth=y,!p){t.plannedRows=[],t.actualRows=[],t.actualRowsById=new Map,t.absenceRows=[],t.confirmedDates=new Set,t.pendingConfirmationDates=new Set,t.changeCountByDate=new Map,t.changeEventsByDate=new Map,t.selectedDate="",h(f),u(f,"#index-crew-last-updated","    .");return}const{startDate:b,endDate:g}=o(y),[S,k,E,L,$]=await Promise.all([w.from("planned_duties").select("date, assignment_role, duties(name, start_time, end_time, second_day, break_start_time, break_end_time)").eq("employee_id",p).gte("date",b).lte("date",g).order("date",{ascending:!0}).order("duty_id",{ascending:!0}),w.from("actual_duties").select("id, date, assignment_role, reported_at, start_time_override, end_time_override, break_start_time_override, break_end_time_override, duties(name, start_time, end_time, second_day, break_start_time, break_end_time, duty_files, duty_trains(sequence_order, trains(number, timetable_url)))").eq("employee_id",p).gte("date",b).lte("date",g).order("date",{ascending:!0}).order("reported_at",{ascending:!1}),w.from("employee_absences").select("start_date, end_date, absence_reasons(name)").eq("employee_id",p).lte("start_date",g).gte("end_date",b).order("start_date",{ascending:!0}),l(b,g),c(b,g)]);(S.error||k.error||E.error||L.error||$.error)&&v("          .","warning");const q=L.confirmedDateSet||new Set,T=L.pendingConfirmationDateSet||new Set,C=$.changeCountByDate||new Map,A=$.changeEventsByDate||new Map;t.plannedRows=S.data||[],t.actualRows=(k.data||[]).filter(x=>q.has(String((x==null?void 0:x.date)||""))),t.actualRowsById=new Map(t.actualRows.map(x=>[String((x==null?void 0:x.id)||""),x])),t.absenceRows=E.data||[],t.confirmedDates=q,t.pendingConfirmationDates=T,t.changeCountByDate=C,t.changeEventsByDate=A,h(f),u(f,"#index-crew-last-updated",` : ${d(new Date)}`)}return{loadCrewMonthlySnapshot:m,renderCrewCalendarAndDetails:h}}const Eu={:"text-bg-warning",:"text-bg-danger",:"text-bg-primary",:"text-bg-dark",:"text-bg-info",:"text-bg-secondary"};function $u(e){const{crewCalendarState:t,setText:r,getTodayIsoDate:s,toMonthKey:n,toIsoDateFromDate:a,parseMonthKey:i,formatMonthLabel:o,getMonthBounds:l,formatDate:c,formatDateTime:d,escapeHtml:u,countBulgarianWorkdays:h,getDutyTimingSummary:m,getActualDutyTimingSummary:f,formatMinutesAsClock:p,formatSignedMinutesAsClock:_,getDeviationClassByThreshold:y,formatRoleLabel:b,getDistinctBadgeClassByReason:g}=e;function S(R){return R&&t.actualRowsById.get(R)||null}function k(R,O){const N=R.querySelector("#index-actual-duty-edit-modal"),B=R.querySelector("#index-actual-duty-edit-id"),Y=R.querySelector("#index-actual-duty-start"),te=R.querySelector("#index-actual-duty-end"),j=R.querySelector("#index-actual-duty-break-start"),J=R.querySelector("#index-actual-duty-break-end"),ie=S(O);if(!N||!B||!Y||!te||!j||!J||!ie){v("      .","warning");return}B.value=O;const oe=f(ie);Y.value=oe.startTime==="-"?"":oe.startTime,te.value=oe.endTime==="-"?"":oe.endTime,j.value=oe.breakStartTime==="-"?"00:00":oe.breakStartTime,J.value=oe.breakEndTime==="-"?"00:00":oe.breakEndTime,t.editingActualDutyId=O,N.classList.remove("d-none")}function E(R){const O=R.querySelector("#index-actual-duty-edit-modal"),N=R.querySelector("#index-actual-duty-edit-form"),B=R.querySelector("#index-actual-duty-edit-id");N&&N.reset(),B&&(B.value=""),t.editingActualDutyId="",O==null||O.classList.add("d-none")}function L(R){if(Array.isArray(R))return R.map((N,B)=>$(N,B)).filter(N=>N.url);const O=String(R||"").trim();if(!O)return[];if(O.startsWith("["))try{const N=JSON.parse(O);if(Array.isArray(N))return N.map((B,Y)=>$(B,Y)).filter(B=>B.url)}catch{return[{url:O,label:" 1"}]}return O.split(`
`).map((N,B)=>$(N,B)).filter(N=>N.url)}function $(R,O){if(R&&typeof R=="object"&&!Array.isArray(R)){const B=String(R.url||"").trim(),Y=String(R.label||"").trim()||` ${O+1}`;return{url:B,label:Y}}return{url:String(R||"").trim(),label:` ${O+1}`}}function q(R){const O=String(R||"").trim();if(!O)return"";const N=O.toLowerCase(),B={:"",:""," ":"",:""," ":"",:""," ":"",:""," ":"",:""};if(B[N])return B[N];if(O.length<=4&&/^[\p{L}\p{N}]+$/u.test(O))return O.toUpperCase();const Y=O.split(/\s+/).map(te=>te.trim()).filter(Boolean);return Y.length>=2?Y.slice(0,3).map(te=>te.charAt(0).toUpperCase()).join(""):O.slice(0,2).toUpperCase()}function T(R){const O=q(R);return Eu[O]||g(R)}function C(R,O){const N=new Date(`${R}T00:00:00`),B=new Date(`${O}T00:00:00`);if(Number.isNaN(N.getTime())||Number.isNaN(B.getTime())||N>B)return[];const Y=[],te=new Date(N);for(;te<=B;)Y.push(a(te)),te.setDate(te.getDate()+1);return Y}function A(R){var O;return String(((O=R==null?void 0:R.absence_reasons)==null?void 0:O.name)||"").trim()||""}function x(R){const O=String(R||"").trim();if(!O)return"";try{const B=new URL(O).pathname.split("/").pop()||"",Y=B.includes(".")?B.split(".").pop():"";return String(Y||"").toLowerCase()}catch{return""}}function D(R){const O=x(R);return["doc","docx","xls","xlsx","ppt","pptx"].includes(O)?`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(R)}`:R}function P(R,O,N){const B=R.querySelector("#index-timetable-preview-modal"),Y=R.querySelector("#index-timetable-preview-frame"),te=R.querySelector("#index-timetable-preview-title"),j=R.querySelector("#index-timetable-preview-fallback"),J=R.querySelector("#index-timetable-preview-open");if(!B||!Y||!te||!j||!J)return;const ie=String(O||"").trim();if(!ie){v("   .","warning");return}const oe=D(ie);te.textContent=N?`: ${N}`:"  ",J.setAttribute("href",ie),j.classList.add("d-none"),Y.src="about:blank",Y.src=oe,Y.onload=()=>{if(oe!==ie){j.classList.add("d-none");return}const me=x(ie),ke=["doc","docx","xls","xlsx","ppt","pptx"].includes(me);j.classList.toggle("d-none",!ke)},Y.onerror=()=>{j.classList.remove("d-none")},B.classList.remove("d-none")}function U(R){const O=R.querySelector("#index-timetable-preview-modal"),N=R.querySelector("#index-timetable-preview-frame"),B=R.querySelector("#index-timetable-preview-fallback"),Y=R.querySelector("#index-timetable-preview-open");!O||!N||!B||!Y||(N.src="about:blank",Y.setAttribute("href","#"),B.classList.add("d-none"),O.classList.add("d-none"))}function W(R){const O=i(R),N=n(O),B=s(),Y=B.startsWith(N);if(t.selectedDate&&t.selectedDate.startsWith(N))return;const te=[...new Set([...t.plannedRows.map(j=>j==null?void 0:j.date).filter(Boolean),...t.actualRows.map(j=>j==null?void 0:j.date).filter(Boolean),...t.absenceRows.flatMap(j=>C(j==null?void 0:j.start_date,j==null?void 0:j.end_date))])].sort((j,J)=>String(j).localeCompare(String(J),"bg"));if(Y){t.selectedDate=B;return}if(te.length){t.selectedDate=te[0];return}t.selectedDate=`${N}-01`}function z(){const R=new Map;return t.plannedRows.forEach(O=>{const N=O==null?void 0:O.date;if(!N)return;const B=R.get(N)||{planned:0,actual:0};B.planned+=1,R.set(N,B)}),t.actualRows.forEach(O=>{const N=O==null?void 0:O.date;if(!N)return;const B=R.get(N)||{planned:0,actual:0};B.actual+=1,R.set(N,B)}),t.pendingConfirmationDates.forEach(O=>{const N=R.get(O)||{planned:0,actual:0,absences:[]};N.pendingConfirmation=!0,R.set(O,N)}),t.changeCountByDate.forEach((O,N)=>{const B=R.get(N)||{planned:0,actual:0,absences:[]};B.changeCount=Number(O||0),R.set(N,B)}),t.absenceRows.forEach(O=>{const N=A(O),B=T(N);C(O==null?void 0:O.start_date,O==null?void 0:O.end_date).forEach(Y=>{const te=R.get(Y)||{planned:0,actual:0,absences:[]};Array.isArray(te.absences)||(te.absences=[]),te.absences.some(J=>(J==null?void 0:J.reason)===N)||te.absences.push({reason:N,className:B}),R.set(Y,te)})}),R}function H(R){const O=R.querySelector("#index-crew-calendar-days");if(!O)return;const N=t.visibleMonth||n(new Date),B=i(N),Y=new Date(B.getFullYear(),B.getMonth(),1),te=Y.getDay(),j=te===0?6:te-1,J=new Date(Y);J.setDate(Y.getDate()-j);const ie=z(),oe=s();r(R,"#index-crew-month-label",o(N));const me=[];for(let ke=0;ke<42;ke+=1){const I=new Date(J);I.setDate(J.getDate()+ke);const ce=`${n(I)}-${String(I.getDate()).padStart(2,"0")}`,Je=I.getMonth()!==B.getMonth(),Ee=ce===t.selectedDate,Ft=ce===oe,Ce=ie.get(ce)||{planned:0,actual:0,absences:[]},St=Array.isArray(Ce.absences)?Ce.absences.map(Ye=>`<span class="badge ${u(Ye.className||"text-bg-danger")}" title="${u(Ye.reason||"")}">${u(Ye.reason||"")}</span>`).join(""):"";me.push(`
        <button
          type="button"
          class="index-crew-calendar-day ${Je?"is-other-month":""} ${Ee?"is-selected":""} ${Ft?"is-today":""}"
          data-index-crew-action="select-day"
          data-date="${ce}"
        >
          <span class="index-crew-calendar-day-number">${I.getDate()}</span>
          <span class="index-crew-calendar-day-flags">
            ${Ce.planned?`<span class="badge text-bg-primary">${Ce.planned}</span>`:""}
            ${Ce.actual?`<span class="badge text-bg-success">${Ce.actual}</span>`:""}
            ${Ce.pendingConfirmation?'<span class="badge text-bg-warning"></span>':""}
            ${Ce.changeCount?`<span class="badge text-bg-info" title="   ">${u(String(Ce.changeCount))}</span>`:""}
            ${St}
          </span>
        </button>
      `)}O.innerHTML=me.join("")}function K(R){const O=t.selectedDate,N=R.querySelector("#index-crew-planned-body"),B=R.querySelector("#index-crew-actual-body"),Y=R.querySelector("#index-crew-change-body"),te=R.querySelector("#index-crew-absence-body");if(!N||!B||!Y||!te)return;r(R,"#index-crew-selected-date-label",`  ${c(O)}`);const j=t.plannedRows.filter(I=>(I==null?void 0:I.date)===O).sort((I,re)=>{var ce,Je;return String(((ce=I==null?void 0:I.duties)==null?void 0:ce.start_time)||"").localeCompare(String(((Je=re==null?void 0:re.duties)==null?void 0:Je.start_time)||""),"bg")});j.length?N.innerHTML=j.map(I=>{var Ft,Ce,St,Ye;const re=((Ft=I==null?void 0:I.duties)==null?void 0:Ft.name)||"-",ce=b(I==null?void 0:I.assignment_role),Je=`${((Ce=I==null?void 0:I.duties)==null?void 0:Ce.start_time)||"-"} - ${((St=I==null?void 0:I.duties)==null?void 0:St.end_time)||"-"}${(Ye=I==null?void 0:I.duties)!=null&&Ye.second_day?" (+1)":""}`,Ee=m(I==null?void 0:I.duties);return`
            <article class="border rounded p-2">
              <div class="fw-semibold">${u(re)}</div>
              <div class="small text-secondary">${u(ce)}  ${u(Je)}</div>
              <div class="small mt-1">
                <div><span class="text-secondary">:</span> ${u(Ee.startTime)}</div>
                <div><span class="text-secondary">:</span> ${u(Ee.endTime)}</div>
                <div><span class="text-secondary">  :</span> ${u(Ee.breakStartTime)}</div>
                <div><span class="text-secondary">  :</span> ${u(Ee.breakEndTime)}</div>
                <div><span class="text-secondary">:</span> ${u(Ee.breakDuration)}</div>
                <div><span class="text-secondary">:</span> ${u(Ee.duration)}</div>
              </div>
            </article>
          `}).join(""):N.innerHTML='<p class="text-secondary mb-0">  .</p>';const J=t.actualRows.filter(I=>(I==null?void 0:I.date)===O).sort((I,re)=>String((re==null?void 0:re.reported_at)||"").localeCompare(String((I==null?void 0:I.reported_at)||""),"bg")),ie=t.confirmedDates.has(O),oe=t.pendingConfirmationDates.has(O);ie?J.length?B.innerHTML=J.map(I=>{var Na,ja,Ha,Ua;const re=((Na=I==null?void 0:I.duties)==null?void 0:Na.name)||"-",ce=b(I==null?void 0:I.assignment_role),Je=I!=null&&I.reported_at?d(new Date(I.reported_at)):"-",Ee=f(I),Ft=Array.isArray((ja=I==null?void 0:I.duties)==null?void 0:ja.duty_trains)?[...I.duties.duty_trains].sort(($e,it)=>Number(($e==null?void 0:$e.sequence_order)||0)-Number((it==null?void 0:it.sequence_order)||0)):(Ha=I==null?void 0:I.duties)!=null&&Ha.duty_trains?[I.duties.duty_trains]:[],Ce=L((Ua=I==null?void 0:I.duties)==null?void 0:Ua.duty_files),St=Ft.map($e=>{var Fa,Ba;const it=(Fa=$e==null?void 0:$e.trains)!=null&&Fa.number?` ${$e.trains.number}`:"",fs=L((Ba=$e==null?void 0:$e.trains)==null?void 0:Ba.timetable_url);if(!fs.length)return`<div class="small">${u(it)}: <span class="text-secondary"> </span></div>`;const Sr=fs.map(cn=>{const Tl=encodeURIComponent(cn.url),El=encodeURIComponent(cn.label||""),dn=cn.label||"";return`
                    <span class="d-inline-flex align-items-center gap-1 me-2">
                      <span>${u(dn)}</span>
                      <button
                        type="button"
                        class="btn btn-link btn-sm p-0 lh-1 text-decoration-none"
                        data-index-crew-action="preview-timetable"
                        data-preview-url="${u(Tl)}"
                        data-preview-label="${u(El)}"
                        title=": ${u(dn)}"
                        aria-label=": ${u(dn)}"
                      >
                        
                      </button>
                    </span>
                  `}).join(" ");return`<div class="small">${u(it)}: ${Sr}</div>`}).join(""),Ye=Ce.map($e=>{const it=encodeURIComponent($e.url),fs=encodeURIComponent($e.label||""),Sr=$e.label||"";return`
                <span class="d-inline-flex align-items-center gap-1 me-2 small">
                  <span>${u(Sr)}</span>
                  <button
                    type="button"
                    class="btn btn-link btn-sm p-0 lh-1 text-decoration-none"
                    data-index-crew-action="preview-timetable"
                    data-preview-url="${u(it)}"
                    data-preview-label="${u(fs)}"
                    title=": ${u(Sr)}"
                    aria-label=": ${u(Sr)}"
                  >
                    
                  </button>
                </span>
              `}).join("");return`
            <article class="border rounded p-2">
              <div class="d-flex align-items-start justify-content-between gap-2">
                <div class="fw-semibold">${u(re)}</div>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary py-0 px-2"
                  title="  "
                  aria-label="  "
                  data-index-crew-action="edit-actual-duty"
                  data-actual-duty-id="${u(String((I==null?void 0:I.id)||""))}"
                >
                  
                </button>
              </div>
              <div class="small text-secondary mb-1">${u(ce)}  : ${u(Je)}</div>
              <div class="small mb-1">
                <div><span class="text-secondary">:</span> ${u(Ee.startTime)}</div>
                <div><span class="text-secondary">:</span> ${u(Ee.endTime)}</div>
                <div><span class="text-secondary">  :</span> ${u(Ee.breakStartTime)}</div>
                <div><span class="text-secondary">  :</span> ${u(Ee.breakEndTime)}</div>
                <div><span class="text-secondary">:</span> ${u(Ee.breakDuration)}</div>
                <div><span class="text-secondary">:</span> ${u(Ee.duration)}</div>
              </div>
              ${St?`<div class="small"><span class="fw-semibold">:</span> ${St}</div>`:""}
              ${Ye?`<div class="small"><span class="fw-semibold">:</span> ${Ye}</div>`:""}
            </article>
          `}).join(""):B.innerHTML='<p class="text-secondary mb-0">  .</p>':B.innerHTML=oe?'<p class="text-warning mb-0">      .      .</p>':'<p class="text-secondary mb-0">       .</p>';const me=t.changeEventsByDate.get(O)||[];me.length?Y.innerHTML=me.map(I=>`
          <article class="border rounded p-2">
            <div class="small">${u(I.summary||"-")}</div>
            <div class="small text-secondary">${u(I.changedAt||"-")}</div>
          </article>
        `).join(""):Y.innerHTML='<p class="text-secondary mb-0">     .</p>';const ke=t.absenceRows.filter(I=>{const re=String((I==null?void 0:I.start_date)||""),ce=String((I==null?void 0:I.end_date)||"");return!!(re&&ce&&O>=re&&O<=ce)}).sort((I,re)=>{const ce=String((I==null?void 0:I.start_date)||"").localeCompare(String((re==null?void 0:re.start_date)||""),"bg");return ce!==0?ce:A(I).localeCompare(A(re),"bg")});if(!ke.length){te.innerHTML='<p class="text-secondary mb-0">    .</p>';return}te.innerHTML=ke.map(I=>{const re=A(I),ce=T(re),Je=`${c(I==null?void 0:I.start_date)} - ${c(I==null?void 0:I.end_date)}`;return`
          <article class="border rounded p-2">
            <div class="d-flex flex-wrap align-items-center gap-2 mb-1">
              <span class="badge ${u(ce)}">${u(re)}</span>
            </div>
            <div class="small text-secondary">: ${u(Je)}</div>
          </article>
        `}).join("")}function ee(R){const O=R.querySelector("#index-crew-planned-hours-total"),N=R.querySelector("#index-crew-actual-hours-total"),B=R.querySelector("#index-crew-norm-hours-total"),Y=R.querySelector("#index-crew-deviation-hours-total");if(!O||!N||!B||!Y)return;const te=String(t.selectedDate||"").trim();if(!te){O.textContent="00:00",N.textContent="00:00",B.textContent="00:00",Y.textContent="+00:00",Y.className="fw-semibold badge text-bg-success";return}const{startDate:j}=l(t.visibleMonth||n(new Date)),J=te>=j?te:j,ie=t.plannedRows.filter(I=>{const re=String((I==null?void 0:I.date)||"");return!!(re&&re>=j&&re<=J)}).reduce((I,re)=>{const ce=Number(m(re==null?void 0:re.duties).durationMinutes);return Number.isFinite(ce)?I+ce:I},0),oe=t.actualRows.filter(I=>{const re=String((I==null?void 0:I.date)||"");return!!(re&&re>=j&&re<=J)}).reduce((I,re)=>{const ce=Number(f(re).durationMinutes);return Number.isFinite(ce)?I+ce:I},0),me=h(j,J)*8*60,ke=oe-me;O.textContent=p(ie),N.textContent=p(oe),B.textContent=p(me),Y.textContent=_(ke),Y.className=`fw-semibold badge ${y(ke)}`}return{openCrewActualDutyEditModal:k,closeCrewActualDutyEditModal:E,openCrewTimetablePreview:P,closeCrewTimetablePreview:U,ensureCrewSelectedDate:W,renderCrewCalendar:H,renderCrewSelectedDayDetails:K,renderCrewHoursSummary:ee}}function rr(e){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0");return`${t}-${r}`}function _t(e){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${s}`}function rn(e){const[t,r]=String(e||"").split("-"),s=Number(t),n=Number(r);if(!Number.isInteger(s)||!Number.isInteger(n)||n<1||n>12){const a=new Date;return new Date(a.getFullYear(),a.getMonth(),1)}return new Date(s,n-1,1)}function Au(e,t){const r=rn(e);return r.setMonth(r.getMonth()+t),rr(r)}function xu(e){const t=rn(e);return new Intl.DateTimeFormat("bg-BG",{month:"long",year:"numeric"}).format(t)}function _n(e){const t=rn(e),r=new Date(t.getFullYear(),t.getMonth()+1,0);return{startDate:_t(t),endDate:_t(r)}}function Qr(e){const t=String(e||"").trim();if(!/^\d{4}-\d{2}-\d{2}$/.test(t))return null;const[r,s,n]=t.split("-"),a=Number(r),i=Number(s),o=Number(n);return!Number.isInteger(a)||!Number.isInteger(i)||!Number.isInteger(o)?null:new Date(a,i-1,o)}function Cu(e,t,r){return new Date(Date.UTC(e,t-1,r))}function Ru(e){const t=e%4,r=e%7,n=(19*(e%19)+15)%30,a=(2*t+4*r-n+34)%7,i=Math.floor((n+a+114)/31),o=(n+a+114)%31+1,l=Cu(e,i,o);return l.setUTCDate(l.getUTCDate()+13),new Date(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate())}function Iu(e,t){const r=_t(t);e.add(r);const s=t.getDay();if(s!==0&&s!==6)return;const n=new Date(t);for(n.setDate(n.getDate()+1);n.getDay()===0||n.getDay()===6||e.has(_t(n));)n.setDate(n.getDate()+1);e.add(_t(n))}function Du(e){const t=new Set;[[1,1],[3,3],[5,1],[5,6],[5,24],[9,6],[9,22],[12,24],[12,25],[12,26]].forEach(([a,i])=>{Iu(t,new Date(e,a-1,i))});const s=Ru(e);return[-2,-1,0,1].forEach(a=>{const i=new Date(s);i.setDate(i.getDate()+a),t.add(_t(i))}),t}function Ou(e,t){const r=Qr(e),s=Qr(t);if(!r||!s||r>s)return new Set;const n=new Set;for(let a=r.getFullYear();a<=s.getFullYear();a+=1)Du(a).forEach(o=>n.add(o));return n}function gi(e,t){const r=Qr(e),s=Qr(t);if(!r||!s||r>s)return 0;const n=Ou(e,t);let a=0;const i=new Date(r);for(;i<=s;){const o=i.getDay(),l=_t(i),c=o===0||o===6,d=n.has(l);!c&&!d&&(a+=1),i.setDate(i.getDate()+1)}return a}function vi(e){const t=String(e||"").trim().toLowerCase();return t==="chief"?" ":t==="conductor"?"":t||"-"}function Pu(e){const t=String((e==null?void 0:e.first_name)||"").trim(),r=String((e==null?void 0:e.last_name)||"").trim();return`${t} ${r}`.trim()||"-"}async function Mu(e,t,r){const{data:s,error:n}=await e.from("schedule_publications").select("schedule_date, is_confirmed").gte("schedule_date",t).lte("schedule_date",r);if(n)return{confirmedDateSet:new Set,pendingConfirmationDateSet:new Set,error:n};const a=new Set,i=new Set;return(s||[]).forEach(o=>{const l=String((o==null?void 0:o.schedule_date)||"").trim();if(l){if(o!=null&&o.is_confirmed){a.add(l);return}i.add(l)}}),{confirmedDateSet:a,pendingConfirmationDateSet:i,error:null}}async function Nu(e,t,r,s){const{data:n,error:a}=await e.from("schedule_change_events").select("schedule_date, action, old_duty_id, new_duty_id, old_employee_id, new_employee_id, old_assignment_role, new_assignment_role, changed_at").gte("schedule_date",t).lte("schedule_date",r).order("changed_at",{ascending:!1});if(a)return{changeCountByDate:new Map,changeEventsByDate:new Map,error:a};const i=new Set,o=new Set;(n||[]).forEach(f=>{f!=null&&f.old_duty_id&&i.add(f.old_duty_id),f!=null&&f.new_duty_id&&i.add(f.new_duty_id),f!=null&&f.old_employee_id&&o.add(f.old_employee_id),f!=null&&f.new_employee_id&&o.add(f.new_employee_id)});const[l,c]=await Promise.all([i.size?e.from("duties").select("id, name").in("id",Array.from(i)):Promise.resolve({data:[],error:null}),o.size?e.from("employees").select("id, first_name, last_name").in("id",Array.from(o)):Promise.resolve({data:[],error:null})]);if(l.error||c.error)return{changeCountByDate:new Map,changeEventsByDate:new Map,error:l.error||c.error};const d=new Map((l.data||[]).map(f=>[String((f==null?void 0:f.id)||""),String((f==null?void 0:f.name)||"").trim()||"-"]).filter(([f])=>f)),u=new Map((c.data||[]).map(f=>[String((f==null?void 0:f.id)||""),Pu(f)]).filter(([f])=>f)),h=new Map,m=new Map;return(n||[]).forEach(f=>{const p=String((f==null?void 0:f.schedule_date)||"").trim();if(!p)return;const _=Number(h.get(p)||0);h.set(p,_+1);const y=d.get(String((f==null?void 0:f.old_duty_id)||""))||"-",b=d.get(String((f==null?void 0:f.new_duty_id)||""))||"-",g=u.get(String((f==null?void 0:f.old_employee_id)||""))||"-",S=u.get(String((f==null?void 0:f.new_employee_id)||""))||"-",k=vi(f==null?void 0:f.old_assignment_role),E=vi(f==null?void 0:f.new_assignment_role),L=String((f==null?void 0:f.action)||"").trim().toLowerCase(),$=f!=null&&f.changed_at?s(new Date(f.changed_at)):"-";let q="";L==="insert"?q=`: ${S} | ${b} | ${E}`:L==="delete"?q=`: ${g} | ${y} | ${k}`:q=`: ${g} | ${y} | ${k}  ${S} | ${b} | ${E}`;const T=m.get(p)||[];T.push({summary:q,changedAt:$}),m.set(p,T)}),{changeCountByDate:h,changeEventsByDate:m,error:null}}function bi(e,t){t.forEach((r,s)=>{const n=e.querySelector(`#index-kpi-label-${s+1}`);n&&(n.textContent=r)})}function ju(e,t,r){const{setText:s,isTransportAnalyticsMode:n,getTodayIsoDate:a}=r,i=e.querySelector("#index-management-section"),o=e.querySelector("#index-crew-section"),l=e.querySelector("#index-kpi-card-planned"),c=e.querySelector("#index-kpi-card-actual"),d=e.querySelector("#index-kpi-card-absences"),u=e.querySelector("#index-kpi-card-employees"),h=e.querySelector("#index-certificates-panel"),m=e.querySelector("#index-absences-panel"),f=e.querySelector("#index-workload-panel"),p=e.querySelector("#index-pending-users-panel"),_=e.querySelector("#index-workload-date"),y=e.querySelector("#index-certificates-soon-details"),b=e.querySelector("#index-certificates-expired-details"),g=e.querySelector("#index-quick-actions"),S=(t==null?void 0:t.mode)||"default";if(s(e,"#index-management-title","   "),bi(e,[" "," "," "," "]),S!=="crew"){e.dataset.indexMode=S,i==null||i.classList.remove("d-none"),o==null||o.classList.add("d-none"),l==null||l.classList.remove("d-none"),c==null||c.classList.remove("d-none"),d==null||d.classList.remove("col-xl-6"),d==null||d.classList.add("col-xl-3"),u==null||u.classList.remove("col-xl-6"),u==null||u.classList.add("col-xl-3"),h==null||h.classList.add("d-none"),m==null||m.classList.add("d-none"),f==null||f.classList.add("d-none"),p==null||p.classList.add("d-none"),y==null||y.classList.add("d-none"),b==null||b.classList.add("d-none"),g&&(S==="admin"?(g.innerHTML=`
          <a href="/admin" data-link class="btn btn-outline-danger"> </a>
          <a href="/employees" data-link class="btn btn-outline-primary"></a>
        `,s(e,"#index-welcome-subtitle","   ,    ."),s(e,"#index-management-title"," "),bi(e,["","  ","  ",""]),p==null||p.classList.remove("d-none")):S==="manager"?(g.innerHTML=`
          <a href="/plan-schedule" data-link class="btn btn-outline-primary">-</a>
          <a href="/schedule" data-link class="btn btn-outline-primary"></a>
          <a href="/planned-duties" data-link class="btn btn-outline-primary"> </a>
          <a href="/actual-duties" data-link class="btn btn-outline-primary"> </a>
        `,s(e,"#index-welcome-subtitle","        .")):n(S)&&(g.innerHTML=`
          <a href="/plan-schedule" data-link class="btn btn-outline-primary">-</a>
          <a href="/schedule" data-link class="btn btn-outline-primary"></a>
          <a href="/planned-duties" data-link class="btn btn-outline-primary"> </a>
          <a href="/actual-duties" data-link class="btn btn-outline-primary"> </a>
        `,s(e,"#index-welcome-subtitle","      ,   ."),l==null||l.classList.add("d-none"),c==null||c.classList.add("d-none"),d==null||d.classList.remove("col-xl-3"),d==null||d.classList.add("col-xl-6"),u==null||u.classList.remove("col-xl-3"),u==null||u.classList.add("col-xl-6"),h==null||h.classList.remove("d-none"),m==null||m.classList.remove("d-none"),f==null||f.classList.remove("d-none"),_&&!_.value&&(_.value=a())));return}e.dataset.indexMode="crew",e.dataset.indexEmployeeId=t.employeeId||"",i==null||i.classList.add("d-none"),o==null||o.classList.remove("d-none"),s(e,"#index-welcome-subtitle","        ."),g&&(g.innerHTML=`
      <a href="/planned-duties" data-link class="btn btn-outline-primary"> </a>
      <a href="/actual-duties" data-link class="btn btn-outline-primary"> </a>
    `)}const sr={visibleMonth:"",selectedDate:"",plannedRows:[],actualRows:[],actualRowsById:new Map,absenceRows:[],confirmedDates:new Set,pendingConfirmationDates:new Set,changeCountByDate:new Map,changeEventsByDate:new Map,editingActualDutyId:""},Hu=-20*60,Uu=30*60;function nr(){return new Date().toISOString().slice(0,10)}function Ur(e){return new Intl.DateTimeFormat("bg-BG",{dateStyle:"medium",timeStyle:"short"}).format(e)}function _i(e){return e?new Intl.DateTimeFormat("bg-BG",{dateStyle:"medium"}).format(new Date(`${e}T00:00:00`)):"-"}function Bn(e){return String(e??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Or(e){return e==null||e===""?"":jt(String(e))||""}function Ls(e){const t=Or(e);return t?t.slice(0,5):"-"}function Fs(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"-";const r=Math.floor(t/60),s=t%60;return`${String(r).padStart(2,"0")}:${String(s).padStart(2,"0")}`}function Si(e){const t=Number(e);if(!Number.isFinite(t))return"-";const r=t<0?"-":"+",s=Math.abs(t),n=Math.floor(s/60),a=s%60;return`${r}${String(n).padStart(2,"0")}:${String(a).padStart(2,"0")}`}function wi(e){const t=Number(e||0);return Number.isFinite(t)?t<Hu||t>Uu?"text-bg-danger":"text-bg-success":"text-bg-secondary"}function Kn(e){const t=Or(e==null?void 0:e.start_time),r=Or(e==null?void 0:e.end_time),s=Or(e==null?void 0:e.break_start_time),n=Or(e==null?void 0:e.break_end_time),a=s&&n?Ie(s,n):null,i=t&&r?Ie(t,r):null,o=Number.isFinite(i)&&Number.isFinite(a)?Math.max(0,i-a):null;return{startTime:Ls(e==null?void 0:e.start_time),endTime:Ls(e==null?void 0:e.end_time),breakStartTime:Ls(e==null?void 0:e.break_start_time),breakEndTime:Ls(e==null?void 0:e.break_end_time),breakDuration:a===null?"-":Fs(a),duration:o===null?"-":Fs(o),breakDurationMinutes:a,durationMinutes:o}}function ki(e){const t=(e==null?void 0:e.duties)||{};return Kn({start_time:(e==null?void 0:e.start_time_override)??(t==null?void 0:t.start_time),end_time:(e==null?void 0:e.end_time_override)??(t==null?void 0:t.end_time),break_start_time:(e==null?void 0:e.break_start_time_override)??(t==null?void 0:t.break_start_time),break_end_time:(e==null?void 0:e.break_end_time_override)??(t==null?void 0:t.break_end_time)})}function qs(e){return e?`${String(e).slice(0,5)}:00`:null}async function Fu(e,t,r){var p,_,y,b,g;if((e.dataset.indexMode||"default")!=="crew")return;const n=e.dataset.indexEmployeeId||"",a=(((p=e.querySelector("#index-actual-duty-edit-id"))==null?void 0:p.value)||"").trim(),i=(((_=e.querySelector("#index-actual-duty-start"))==null?void 0:_.value)||"").trim(),o=(((y=e.querySelector("#index-actual-duty-end"))==null?void 0:y.value)||"").trim(),l=(((b=e.querySelector("#index-actual-duty-break-start"))==null?void 0:b.value)||"").trim(),c=(((g=e.querySelector("#index-actual-duty-break-end"))==null?void 0:g.value)||"").trim(),d=e.querySelector("#index-actual-duty-edit-save");if(!a||!i||!o||!l||!c){v("  .","warning");return}const u=Ie(i,o);if(Ie(l,c)>u){v("     -  .","warning");return}const m=(d==null?void 0:d.innerHTML)||"";d&&(d.disabled=!0,d.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{error:f}=await w.from("actual_duties").update({start_time_override:qs(i),end_time_override:qs(o),break_start_time_override:qs(l),break_end_time_override:qs(c)}).eq("id",a);if(d&&(d.disabled=!1,d.innerHTML=m),f){v(f.message||"   .","error");return}r(e),await t(e,n,sr.visibleMonth),v("   .","success")}function Bu(e){const t=normalizeRole(e);return t==="chief"?" ":t==="conductor"?"":t==="driver"?"":t==="assistant_driver"?". ":""}function Ne(e,t,r){const s=e.querySelector(t);s&&(s.textContent=r)}async function Ku(e){const{data:t}=await w.auth.getSession(),r=(t==null?void 0:t.session)||null,s=(r==null?void 0:r.user)||null;if(!(s!=null&&s.id))return Ne(e,"#index-welcome-title","   TrainCrewHub"),Ne(e,"#index-welcome-subtitle","   ,     ."),{userId:"",employeeId:"",roles:[],crew:!1,mode:"default"};const[{data:n},{data:a}]=await Promise.all([w.from("user_profiles").select("username, employee_id, employees(first_name, last_name)").eq("id",s.id).maybeSingle(),w.from("user_roles").select("role").eq("user_id",s.id)]),i=(n==null?void 0:n.username)||s.email||s.id,o=n!=null&&n.employees?`${n.employees.first_name||""} ${n.employees.last_name||""}`.trim():"",l=[...new Set((a||[]).map(d=>String((d==null?void 0:d.role)||"").trim()).filter(Boolean))],c=Lu(l);return Ne(e,"#index-welcome-title",`, ${i}${o?` | ${o}`:""}`),Ne(e,"#index-welcome-subtitle","         ."),{userId:s.id,employeeId:(n==null?void 0:n.employee_id)||"",roles:l,crew:Uo(l),mode:c}}function Li(e){const t=["text-bg-primary","text-bg-success","text-bg-warning","text-bg-danger","text-bg-info","text-bg-dark"],r=String(e||"").trim().toLowerCase();if(!r)return t[0];const s={:"text-bg-warning",do:"text-bg-danger",:"text-bg-danger",:"text-bg-warning",:"text-bg-primary",:"text-bg-info"};if(s[r])return s[r];let n=0;for(let a=0;a<r.length;a+=1)n=(n*31+r.charCodeAt(a))%2147483647;return t[Math.abs(n)%t.length]}async function Wn(e){var d;const t=nr(),[r,s,n,a,i]=await Promise.all([w.from("planned_duties").select("id",{count:"exact",head:!0}).eq("date",t),w.from("actual_duties").select("id",{count:"exact",head:!0}).eq("date",t),w.from("employee_absences").select("id",{count:"exact",head:!0}).lte("start_date",t).gte("end_date",t),w.from("employees").select("id",{count:"exact",head:!0}).eq("is_active",!0),w.from("schedule_publications").select("is_confirmed").eq("schedule_date",t).maybeSingle()]);[r,s,n,a,i].some(u=>u.error)&&v("          .","warning");const c=!!((d=i==null?void 0:i.data)!=null&&d.is_confirmed)?Number(s.count??0):0;Ne(e,"#index-kpi-planned",String(r.count??0)),Ne(e,"#index-kpi-actual",String(c)),Ne(e,"#index-kpi-absences",String(n.count??0)),Ne(e,"#index-kpi-employees",String(a.count??0)),Ne(e,"#index-last-updated",` : ${Ur(new Date)}`)}async function Fo(e){await bu(e,{setText:Ne,formatDateTime:Ur,escapeHtml:Bn})}function Wu(e,t,r,s){const n=e.querySelector("#index-refresh"),a=e.querySelector("#index-certificates-panel"),i=e.querySelector("#index-absences-panel"),o=e.querySelector("#index-workload-date"),l=e.querySelector("#index-workload-refresh"),{loadCrewMonthlySnapshot:c,renderCrewCalendarAndDetails:d}=r,{openCrewActualDutyEditModal:u,openCrewTimetablePreview:h,closeCrewTimetablePreview:m,closeCrewActualDutyEditModal:f}=s;qu(e,{loadCrewMonthlySnapshot:c,crewCalendarState:sr,toMonthKey:rr,shiftMonthKey:Au,getTodayIsoDate:nr,renderCrewCalendarAndDetails:d,openCrewActualDutyEditModal:u,openCrewTimetablePreview:h,closeCrewTimetablePreview:m,closeCrewActualDutyEditModal:f,saveCrewActualDutyEdits:p=>Fu(p,c,f)}),n==null||n.addEventListener("click",async()=>{const p=e.dataset.indexMode||"default";if(p==="admin"){n.disabled=!0,await Fo(e),n.disabled=!1;return}if(Rt(p)){n.disabled=!0,await t.loadHeadOfTransportSnapshot(e),n.disabled=!1;return}p!=="crew"&&(n.disabled=!0,await Wn(e),n.disabled=!1)}),a==null||a.addEventListener("click",p=>{const _=p.target.closest("button[data-index-cert-action]");if(!_)return;const y=e.dataset.indexMode||"default";if(!Rt(y))return;const b=_.getAttribute("data-index-cert-action")||"";if(b==="toggle-soon"){t.toggleCertificateDetails(e,"soon");return}b==="toggle-expired"&&t.toggleCertificateDetails(e,"expired")}),i==null||i.addEventListener("click",p=>{const _=p.target.closest("button[data-index-absence-action]");if(!_)return;const y=e.dataset.indexMode||"default";if(!Rt(y)||(_.getAttribute("data-index-absence-action")||"")!=="toggle-reason")return;const g=_.getAttribute("data-index-absence-key")||"";t.toggleAbsenceReasonDetails(e,g)}),o==null||o.addEventListener("change",async()=>{const p=e.dataset.indexMode||"default";Rt(p)&&await t.loadHeadOfTransportWorkload(e)}),l==null||l.addEventListener("click",async()=>{const p=e.dataset.indexMode||"default";Rt(p)&&(l.disabled=!0,await t.loadHeadOfTransportWorkload(e),l.disabled=!1)})}async function zu(e){const t=await ue("../index.html",import.meta.url);e.innerHTML=t;const r=wu({loadKpiSnapshot:Wn,getTodayIsoDate:nr,formatDate:_i,escapeHtml:Bn,formatMinutesAsClock:Fs,formatSignedMinutesAsClock:Si,getDeviationClassByThreshold:wi,parseIsoDateSafe:Qr,toMonthKey:rr,getMonthBounds:_n,countBulgarianWorkdays:gi,getDutyTimingSummary:Kn,getActualDutyTimingSummary:ki,getDistinctBadgeClassByReason:Li}),s=$u({crewCalendarState:sr,setText:Ne,getTodayIsoDate:nr,toMonthKey:rr,toIsoDateFromDate:_t,parseMonthKey:rn,formatMonthLabel:xu,getMonthBounds:_n,formatDate:_i,formatDateTime:Ur,escapeHtml:Bn,countBulgarianWorkdays:gi,getDutyTimingSummary:Kn,getActualDutyTimingSummary:ki,formatMinutesAsClock:Fs,formatSignedMinutesAsClock:Si,getDeviationClassByThreshold:wi,formatRoleLabel:Bu,getDistinctBadgeClassByReason:Li}),n=Tu({crewCalendarState:sr,ensureCrewSelectedDate:s.ensureCrewSelectedDate,renderCrewCalendar:s.renderCrewCalendar,renderCrewHoursSummary:s.renderCrewHoursSummary,renderCrewSelectedDayDetails:s.renderCrewSelectedDayDetails,toMonthKey:rr,getMonthBounds:_n,loadSchedulePublicationDates:(i,o)=>Mu(w,i,o),loadScheduleChangesSummary:(i,o)=>Nu(w,i,o,Ur),formatDateTime:Ur,setText:Ne});Wu(e,r,n,s);const a=await Ku(e);if(ju(e,a,{setText:Ne,isTransportAnalyticsMode:Rt,getTodayIsoDate:nr}),(a==null?void 0:a.mode)==="crew"){const i=rr(new Date);sr.visibleMonth=i,sr.selectedDate=nr(),await n.loadCrewMonthlySnapshot(e,a.employeeId||"",i);return}if((a==null?void 0:a.mode)==="admin"){await Fo(e);return}if(Rt((a==null?void 0:a.mode)||"default")){await r.loadHeadOfTransportSnapshot(e);return}await Wn(e)}async function Vu({attempts:e=10,delayMs:t=120}={}){var r,s;for(let n=0;n<e;n+=1){const{data:a}=await w.auth.getSession();if((s=(r=a==null?void 0:a.session)==null?void 0:r.user)!=null&&s.id)return!0;await new Promise(i=>{window.setTimeout(i,t)})}return!1}async function Gu(e){const t=await ue("../login.html",import.meta.url);e.innerHTML=t,Ju(e),Qu(e)}function Ju(e){e.querySelectorAll("button[data-toggle-password]").forEach(t=>{t.addEventListener("click",()=>{const r=t.getAttribute("data-toggle-password")||"",s=e.querySelector(`#${r}`);if(!s)return;const n=s.type==="password";s.type=n?"text":"password",t.textContent=n?"":"",t.setAttribute("aria-label",n?" ":" ")})})}function Qu(e){const t=e.querySelector("#login-form");t&&t.addEventListener("submit",async r=>{var h,m,f,p,_;r.preventDefault();const s=t.querySelector('input[name="identifier"]').value.trim(),n=t.querySelector('input[name="password"]').value;if(!s||!n){v(" /   .","warning");return}let a=s;if(!s.includes("@")){const{data:y}=await w.rpc("resolve_login_email",{input_username:s});y&&(a=String(y).trim())}const i=t.querySelector('button[type="submit"]'),o=i.innerHTML;i.disabled=!0,i.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:l,error:c}=await w.auth.signInWithPassword({email:a,password:n});if(i.disabled=!1,i.innerHTML=o,c){v("   .","error");return}const d=((h=l==null?void 0:l.user)==null?void 0:h.id)||((f=(m=l==null?void 0:l.session)==null?void 0:m.user)==null?void 0:f.id)||"";if(d&&!await Po(d)){await w.auth.signOut(),v("  .    .","warning");return}if(v(" .","success"),!(!!((_=(p=l==null?void 0:l.session)==null?void 0:p.user)!=null&&_.id)||await Vu())){v("  ,     .  .","warning");return}window.history.pushState({},"","/"),window.dispatchEvent(new PopStateEvent("popstate"))})}async function Yu(e){const t=await ue("../register.html",import.meta.url);e.innerHTML=t,Xu(e),Zu(e)}function Xu(e){e.querySelectorAll("button[data-toggle-password]").forEach(t=>{t.addEventListener("click",()=>{const r=t.getAttribute("data-toggle-password")||"",s=e.querySelector(`#${r}`);if(!s)return;const n=s.type==="password";s.type=n?"text":"password",t.textContent=n?"":"";const a=r.includes("confirm"),i=a?"   ":" ",o=a?"   ":" ";t.setAttribute("aria-label",n?o:i)})})}function Zu(e){const t=e.querySelector("#register-form");t&&t.addEventListener("submit",async r=>{var y;r.preventDefault();const s=t.querySelector('input[name="username"]').value.trim(),n=t.querySelector('input[name="email"]').value.trim(),a=t.querySelector('input[name="first_name"]').value.trim(),i=t.querySelector('input[name="last_name"]').value.trim(),o=t.querySelector('input[name="password"]').value,l=t.querySelector('input[name="confirm-password"]').value;if(!s||!n||!a||!i||!o||!l){v(",   .","warning");return}if(!/^[A-Za-z0-9_]{3,30}$/.test(s)){v("     3-30       ,   _.","warning");return}const d=/[\u0400-\u04FF]/;if(d.test(o)||d.test(l)){v("     .","warning");return}if(o!==l){v("  .","warning");return}const u=t.querySelector('button[type="submit"]'),h=u.innerHTML;u.disabled=!0,u.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:m,error:f}=await w.auth.signUp({email:n,password:o,options:{data:{username:s,first_name:a,last_name:i}}});if(f){u.disabled=!1,u.innerHTML=h,v(f.message,"error");return}const p=(y=m.user)==null?void 0:y.id;if(p){const{error:b}=await w.from("user_profiles").upsert({id:p,username:s,email:n,first_name:a,last_name:i,created_from:n},{onConflict:"id"});if(b){u.disabled=!1,u.innerHTML=h,v(b.message,"error");return}}if(!!!m.session){const{error:b}=await w.auth.signInWithPassword({email:n,password:o});if(b){u.disabled=!1,u.innerHTML=h,v("  ,        .","warning"),window.history.pushState({},"","/login"),window.dispatchEvent(new PopStateEvent("popstate"));return}}u.disabled=!1,u.innerHTML=h,v("  .     .","success"),window.history.pushState({},"","/"),window.dispatchEvent(new PopStateEvent("popstate"))})}function eh(){return`${window.location.origin}/reset-password`}async function th(e){if(e.includes("@"))return e;const{data:t}=await w.rpc("resolve_login_email",{input_username:e});return String(t||"").trim()}async function rh(e){const t=await ue("../forgot-password.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("#forgot-password-form");r&&r.addEventListener("submit",async s=>{var o;s.preventDefault();const n=(((o=r.querySelector('input[name="identifier"]'))==null?void 0:o.value)||"").trim();if(!n){v("    .","warning");return}const a=r.querySelector('button[type="submit"]'),i=(a==null?void 0:a.innerHTML)||" ";a&&(a.disabled=!0,a.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');try{const l=await th(n);l&&await w.auth.resetPasswordForEmail(l,{redirectTo:eh()})}catch{}a&&(a.disabled=!1,a.innerHTML=i),v("  ,      .","success"),r.reset()})}function sh(e){e.querySelectorAll("button[data-toggle-password]").forEach(t=>{t.addEventListener("click",()=>{const r=t.getAttribute("data-toggle-password")||"",s=e.querySelector(`#${r}`);if(!s)return;const n=s.type==="password";s.type=n?"text":"password",t.textContent=n?"":"";const a=r.includes("confirm"),i=a?"    ":"  ",o=a?"    ":"  ";t.setAttribute("aria-label",n?o:i)})})}function nh(){const e=String(window.location.hash||"").replace(/^#/,""),t=new URLSearchParams(e);return{accessToken:t.get("access_token")||"",refreshToken:t.get("refresh_token")||"",type:t.get("type")||""}}async function ah(){const t=new URLSearchParams(window.location.search).get("code")||"";if(t){const{error:n}=await w.auth.exchangeCodeForSession(t);if(!n)return!0}const r=nh();if(r.type!=="recovery"||!r.accessToken||!r.refreshToken)return!1;const{error:s}=await w.auth.setSession({access_token:r.accessToken,refresh_token:r.refreshToken});return s?!1:(window.history.replaceState({},"","/reset-password"),!0)}async function ih(e){var o,l;const t=await ue("../reset-password.html",import.meta.url);e.innerHTML=t,sh(e);const r=e.querySelector("#reset-password-info"),s=e.querySelector("#reset-password-submit"),n=e.querySelector("#reset-password-form"),{data:a}=await w.auth.getSession();let i=!!((l=(o=a==null?void 0:a.session)==null?void 0:o.user)!=null&&l.id);if(i||(i=await ah()),!i){r&&(r.textContent="     .     .",r.className="text-warning small mb-4 text-center"),s&&(s.disabled=!0);return}r&&(r.textContent="     ."),s&&(s.disabled=!1),n==null||n.addEventListener("submit",async c=>{var p,_;c.preventDefault();const d=(((p=e.querySelector("#reset-password"))==null?void 0:p.value)||"").trim(),u=(((_=e.querySelector("#reset-password-confirm"))==null?void 0:_.value)||"").trim();if(!d||!u){v("     .","warning");return}if(d.length<6){v("     6 .","warning");return}const h=/[\u0400-\u04FF]/;if(h.test(d)||h.test(u)){v("     .","warning");return}if(d!==u){v("  .","warning");return}const m=(s==null?void 0:s.innerHTML)||"  ";s&&(s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{error:f}=await w.auth.updateUser({password:d});if(s&&(s.disabled=!1,s.innerHTML=m),f){v(f.message||"   .","error");return}v("   .","success"),window.history.pushState({},"","/login"),window.dispatchEvent(new PopStateEvent("popstate"))})}const oh=3e4;let Is=null,Fr=null;function qi(){Is&&(window.clearInterval(Is),Is=null),Fr&&(window.removeEventListener("route:changed",Fr),Fr=null)}function Ti(){window.location.pathname==="/pending-access"&&window.dispatchEvent(new PopStateEvent("popstate"))}async function lh(e){qi();const t=await ue("../pending-access.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("#pending-access-refresh"),s=e.querySelector("#pending-access-logout");r==null||r.addEventListener("click",()=>{Ti()}),s==null||s.addEventListener("click",async()=>{const{error:n}=await w.auth.signOut();if(n){v(n.message,"error");return}v("   .","success"),window.history.replaceState({},"","/login"),window.dispatchEvent(new PopStateEvent("popstate"))}),Is=window.setInterval(()=>{Ti()},oh),Fr=()=>{window.location.pathname!=="/pending-access"&&qi()},window.addEventListener("route:changed",Fr)}function Sn(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const Ei=new Map;function ch(e,t){const r=Ei.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){fr(a);return}}};Ei.set(e,s),document.addEventListener("keydown",s)}function fr(e){var t,r;e.classList.add("d-none"),(t=document.querySelector("#schedule-key-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#schedule-key-delete-modal"))!=null&&r.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function Be(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const he={rows:[],filters:{name:"",type:"",crewRole:"",isActive:"",validFrom:"",validTo:""}};async function va(e){const{data:t,error:r}=await w.from("schedule_keys").select("id, name, is_active, type, crew_role, valid_from, valid_to").order("valid_from",{ascending:!1});if(r){v(r.message,"error"),he.rows=[],et(e,"    -.");return}he.rows=t||[],et(e)}function et(e,t){const r=e.querySelector("#schedule-keys-table-body"),s=e.querySelector("#schedule-keys-empty"),n=he.rows.filter(a=>{const i=!he.filters.name||(a.name||"").toLowerCase().includes(he.filters.name),o=!he.filters.type||a.type===he.filters.type,l=!he.filters.crewRole||a.crew_role===he.filters.crewRole,c=!he.filters.isActive||String(!!a.is_active)===he.filters.isActive,d=!he.filters.validFrom||a.valid_from===he.filters.validFrom,u=!he.filters.validTo||a.valid_to===he.filters.validTo;return i&&o&&l&&c&&d&&u});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"    .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>`
        <tr>
          <td>${Be(a.name??"-")}</td>
          <td>${Be(a.type??"-")}</td>
          <td>${Be(a.crew_role??"-")}</td>
          <td>${a.is_active?"":""}</td>
          <td>${Be(a.valid_from??"-")}</td>
          <td>${Be(a.valid_to??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-name="${Be(a.name??"")}"
                data-type="${Be(a.type??"seasonal")}"
                data-crew-role="${Be(a.crew_role??"")}"
                data-active="${a.is_active?"true":"false"}"
                data-valid-from="${Be(a.valid_from??"")}"
                data-valid-to="${Be(a.valid_to??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="duties"
                data-id="${a.id}"
                data-name="${Be(a.name??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `).join("")}async function dh(e){const t=await ue("../schedule-keys.html",import.meta.url);e.innerHTML=t,uh(e),await va(e)}function uh(e){const t=e.querySelector("#open-create-schedule-key"),r=e.querySelector("#schedule-keys-form"),s=e.querySelector("#schedule-key-cancel-btn"),n=e.querySelector("#schedule-keys-table-body"),a=e.querySelector("#schedule-key-modal"),i=e.querySelector("#schedule-key-delete-modal"),o=e.querySelector("#schedule-key-modal-close"),l=e.querySelector("#schedule-key-delete-confirm"),c=e.querySelector("#schedule-key-delete-cancel"),d=e.querySelector("#filter-name"),u=e.querySelector("#filter-type"),h=e.querySelector("#filter-crew-role"),m=e.querySelector("#filter-active"),f=e.querySelector("#filter-valid-from"),p=e.querySelector("#filter-valid-to"),_=e.querySelector("#filter-reset");t==null||t.addEventListener("click",()=>{ba(e),Sn(a)}),r==null||r.addEventListener("submit",async y=>{y.preventDefault(),await hh(e)}),s==null||s.addEventListener("click",()=>{fr(a)}),o==null||o.addEventListener("click",()=>{fr(a)}),c==null||c.addEventListener("click",()=>{fr(i)}),d==null||d.addEventListener("input",y=>{he.filters.name=y.target.value.trim().toLowerCase(),et(e)}),u==null||u.addEventListener("change",y=>{he.filters.type=y.target.value,et(e)}),h==null||h.addEventListener("change",y=>{he.filters.crewRole=y.target.value,et(e)}),m==null||m.addEventListener("change",y=>{he.filters.isActive=y.target.value,et(e)}),f==null||f.addEventListener("change",y=>{he.filters.validFrom=y.target.value,et(e)}),p==null||p.addEventListener("change",y=>{he.filters.validTo=y.target.value,et(e)}),_==null||_.addEventListener("click",()=>{he.filters={name:"",type:"",crewRole:"",isActive:"",validFrom:"",validTo:""},d&&(d.value=""),u&&(u.value=""),h&&(h.value=""),m&&(m.value=""),f&&(f.value=""),p&&(p.value=""),et(e)}),ch("schedule-keys",[i,a]),l==null||l.addEventListener("click",async()=>{const y=e.querySelector("#schedule-key-delete-id").value;await mh(y,e)}),n==null||n.addEventListener("click",async y=>{const b=y.target.closest("button[data-action]");if(!b)return;const g=b.getAttribute("data-action");if(g==="edit"){fh(e,{id:b.getAttribute("data-id"),name:b.getAttribute("data-name"),type:b.getAttribute("data-type"),crewRole:b.getAttribute("data-crew-role")||"",isActive:b.getAttribute("data-active")==="true",validFrom:b.getAttribute("data-valid-from"),validTo:b.getAttribute("data-valid-to")}),Sn(a);return}if(g==="delete"){const S=b.getAttribute("data-id");e.querySelector("#schedule-key-delete-id").value=S,Sn(i);return}if(g==="duties"){const S=b.getAttribute("data-id"),k=b.getAttribute("data-name")||"",E=new URLSearchParams({scheduleKeyId:S,scheduleKeyName:k});window.history.pushState({},"",`/schedule-key-duties?${E.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}})}async function hh(e){var g;const t=e.querySelector("#schedule-key-id"),r=e.querySelector("#schedule-key-name"),s=e.querySelector("#schedule-key-type"),n=e.querySelector("#schedule-key-crew-role"),a=e.querySelector("#schedule-key-active"),i=e.querySelector("#schedule-key-valid-from"),o=e.querySelector("#schedule-key-valid-to"),l=e.querySelector("#schedule-key-save-btn"),c=r.value.trim(),d=s.value,u=n.value,h=a.checked,m=i.value,f=o.value,p=t.value;if(!c||!d||!u||!m||!f){v(",    .","warning");return}if(![" ",""].includes(u)){v("   .","warning");return}if(f<m){v(' " "     " ".',"warning");return}const _=l.innerHTML;l.disabled=!0,l.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const y={name:c,type:d,crew_role:u,is_active:h,valid_from:m,valid_to:f};let b;if(p)({error:b}=await w.from("schedule_keys").update(y).eq("id",p));else{const{data:S}=await w.auth.getUser(),k=((g=S==null?void 0:S.user)==null?void 0:g.email)??"web_app";({error:b}=await w.from("schedule_keys").insert({...y,created_from:k}))}if(l.disabled=!1,l.innerHTML=_,b){v(Bo(b),"error");return}v(p?"  .":"  .","success"),fr(e.querySelector("#schedule-key-modal")),ba(e),await va(e)}function fh(e,t){e.querySelector("#schedule-key-id").value=t.id,e.querySelector("#schedule-key-name").value=t.name??"",e.querySelector("#schedule-key-type").value=t.type??"seasonal",e.querySelector("#schedule-key-crew-role").value=t.crewRole??"",e.querySelector("#schedule-key-active").checked=!!t.isActive,e.querySelector("#schedule-key-valid-from").value=t.validFrom??"",e.querySelector("#schedule-key-valid-to").value=t.validTo??"",e.querySelector("#schedule-keys-form-title").textContent="  -",e.querySelector("#schedule-key-save-btn").textContent="",e.querySelector("#schedule-key-cancel-btn").classList.remove("d-none")}function ba(e){e.querySelector("#schedule-key-id").value="",e.querySelector("#schedule-key-name").value="",e.querySelector("#schedule-key-type").value="seasonal",e.querySelector("#schedule-key-crew-role").value="",e.querySelector("#schedule-key-active").checked=!0,e.querySelector("#schedule-key-valid-from").value="",e.querySelector("#schedule-key-valid-to").value="",e.querySelector("#schedule-keys-form-title").textContent=" -",e.querySelector("#schedule-key-save-btn").textContent="",e.querySelector("#schedule-key-cancel-btn").classList.add("d-none")}async function mh(e,t){const r=t.querySelector("#schedule-key-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await w.from("schedule_keys").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){v(Bo(n),"error");return}v("  .","success"),fr(t.querySelector("#schedule-key-delete-modal")),ba(t),await va(t)}function Bo(e){const t=String((e==null?void 0:e.message)||"").trim(),r=t.toLowerCase();return String((e==null?void 0:e.code)||"").trim()==="23503"||r.includes("foreign key constraint")||r.includes("duties_schedule_key_id_fkey")?" -       ,     .":t||"  ."}function Ko({duty:e,scheduleKeyNames:t,trainNumbers:r,attachmentEntries:s,escapeHtml:n,intervalToTimeInput:a,formatInterval:i}){var u;const o=((e==null?void 0:e.start_time)||"-").slice(0,5)||"-",l=((e==null?void 0:e.end_time)||"-").slice(0,5)||"-",c=(a((e==null?void 0:e.break_start_time)||"00:00:00")||"-").slice(0,5)||"-",d=(a((e==null?void 0:e.break_end_time)||"00:00:00")||"-").slice(0,5)||"-";return`
    <div class="row g-3">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${n((e==null?void 0:e.name)||"-")}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${n(((u=e==null?void 0:e.duty_types)==null?void 0:u.name)||"-")}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">-</div>
          <div class="fw-semibold">${n(t!=null&&t.length?t.join(", "):"-")}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${n(r!=null&&r.length?r.join(", "):"-")}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${n(o)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${n(l)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"> </div>
          <div class="fw-semibold">${e!=null&&e.second_day?"":""}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">  </div>
          <div class="fw-semibold">${n(c)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">  </div>
          <div class="fw-semibold">${n(d)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${n(i(e==null?void 0:e.break_duration_interval))}</div>
        </div>
      </div>
      <div class="col-md-12">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${n(i(e==null?void 0:e.duration_interval))}</div>
        </div>
      </div>
      <div class="col-md-12">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small mb-2"> </div>
          <div class="fw-semibold">
            ${(s||[]).length?(s||[]).map(h=>{const m=(h==null?void 0:h.label)||"",f=(h==null?void 0:h.url)||"#";return`
          <div class="d-flex align-items-center gap-2 mb-1">
            <button
              type="button"
              class="btn btn-link btn-sm p-0 lh-1 text-decoration-none"
              data-duty-profile-action="preview-attachment"
              data-url="${n(f)}"
              data-label="${n(m)}"
              title=": ${n(m)}"
              aria-label=": ${n(m)}"
            >
              
            </button>
            <a href="${n(f)}" target="_blank" rel="noopener noreferrer">${n(m)}</a>
          </div>
        `}).join(""):"-"}
          </div>
        </div>
      </div>
    </div>
  `}function zn({idPrefix:e}){return`
    <div class="col-md-6">
      <label for="${e}-name" class="form-label"></label>
      <input id="${e}-name" class="form-control" type="text" required />
    </div>

    <div class="col-md-6">
      <label for="${e}-type" class="form-label">  </label>
      <select id="${e}-type" class="form-select" required>
        <option value=""> </option>
      </select>
    </div>

    <div class="col-md-6">
      <label for="${e}-schedule-keys" class="form-label">-</label>
      <select id="${e}-schedule-keys" class="form-select" multiple required size="5"></select>
      <div class="form-text">      -.</div>
    </div>

    <div class="col-md-6">
      <label for="${e}-trains" class="form-label"></label>
      <select id="${e}-trains" class="form-select" multiple size="5"></select>
      <div class="form-text">       .</div>
    </div>

    <div class="col-md-6">
      <label for="${e}-start" class="form-label"></label>
      <input id="${e}-start" class="form-control" type="time" required />
    </div>

    <div class="col-md-6">
      <label for="${e}-end" class="form-label"></label>
      <input id="${e}-end" class="form-control" type="time" required />
    </div>

    <div class="col-md-6 d-flex align-items-end">
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="${e}-second-day" />
        <label class="form-check-label" for="${e}-second-day"> </label>
      </div>
    </div>

    <div class="col-md-6">
      <label for="${e}-break-start" class="form-label">  </label>
      <input id="${e}-break-start" class="form-control" type="time" value="00:00" required />
    </div>

    <div class="col-md-6">
      <label for="${e}-break-end" class="form-label">  </label>
      <input id="${e}-break-end" class="form-control" type="time" value="00:00" required />
    </div>

    <div class="col-12">
      <label for="${e}-notes" class="form-label"></label>
      <textarea id="${e}-notes" class="form-control" rows="3" placeholder="  ( )"></textarea>
    </div>
  `}function Ht(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const $i=new Map;function ph(e,t){const r=$i.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Ve(a);return}}};$i.set(e,s),document.addEventListener("keydown",s)}function Ve(e){var t,r,s,n;e.classList.add("d-none"),(t=document.querySelector("#duty-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#duty-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#duty-profile-modal"))!=null&&s.classList.contains("d-none"))&&((n=document.querySelector("#duty-attachment-preview-modal"))!=null&&n.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function Ai(e){return e?typeof e=="string"?e.replace(".000000",""):String(e):"-"}function de(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const Ts=8,Z={allDuties:[],searchQuery:"",scheduleKeyFilter:"",dutyTypeFilter:"",currentPage:1,draggedDutyId:null};async function sn(e){const{data:t,error:r}=await w.from("duties").select("id, name, notes, duty_files, duty_type_id, start_time, end_time, second_day, break_start_time, break_end_time, break_duration_interval, duration_interval, display_order, duty_types(name), schedule_key_duties(schedule_key_id, schedule_keys(name)), duty_trains(train_id, sequence_order, trains(number))").order("display_order",{ascending:!0}).order("name",{ascending:!0});if(r){v(r.message,"error"),Z.allDuties=[],tt(e,"    .");return}Z.allDuties=t||[],tt(e)}async function yh(){const e=Z.allDuties.map((s,n)=>w.from("duties").update({display_order:n+1}).eq("id",s.id)),r=(await Promise.all(e)).find(s=>s.error);return r!=null&&r.error?(v(r.error.message,"error"),!1):(Z.allDuties=Z.allDuties.map((s,n)=>({...s,display_order:n+1})),!0)}function tt(e,t){const r=e.querySelector("#duties-table-body"),s=e.querySelector("#duties-empty"),n=e.querySelector("#duties-pagination"),a=e.querySelector("#duties-page-info"),i=e.querySelector("#duties-prev-page"),o=e.querySelector("#duties-next-page");Sh(e),wh(e);const l=Z.allDuties.filter(m=>{var k;const f=(m.name||"").toLowerCase(),p=(((k=m.duty_types)==null?void 0:k.name)||"").toLowerCase(),_=Vn(m).map(E=>E.toLowerCase()),y=vh(m).join(" ").toLowerCase(),b=!Z.searchQuery||f.includes(Z.searchQuery)||y.includes(Z.searchQuery),g=!Z.scheduleKeyFilter||_.includes(Z.scheduleKeyFilter),S=!Z.dutyTypeFilter||p===Z.dutyTypeFilter;return b&&g&&S});if(!l.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .",n.classList.add("d-none");return}s.classList.add("d-none");const c=Math.max(1,Math.ceil(l.length/Ts));Z.currentPage>c&&(Z.currentPage=c),Z.currentPage<1&&(Z.currentPage=1);const d=(Z.currentPage-1)*Ts,u=d+Ts,h=l.slice(d,u);if(r.innerHTML=h.map(m=>{var g;const f=Vn(m),p=gh(m);bh(m);const _=_h(m),y=`<span class="badge text-bg-info" title="${de(f.join(", "))}">${p.length} -</span>`,b=_>0?`<span class="badge text-bg-secondary" title=" ">${_} .</span>`:"";return`
        <tr data-duty-id="${m.id}" draggable="true">
          <td class="text-secondary"></td>
          <td>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              ${y}
              ${b}
              <span class="duties-name-ellipsis" title="${de(m.name??"-")}">${de(m.name??"-")}</span>
            </div>
          </td>
          <td>${de(((g=m.duty_types)==null?void 0:g.name)??"-")}</td>
          <td>${de(m.start_time??"-")}</td>
          <td>${de(m.end_time??"-")}</td>
          <td>${de(Ai(m.break_duration_interval))}</td>
          <td>${de(Ai(m.duration_interval))}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="profile"
                data-id="${m.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${m.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="duplicate"
                data-id="${m.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${m.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join(""),l.length<=Ts){n.classList.add("d-none");return}n.classList.remove("d-none"),a.textContent=` ${Z.currentPage}  ${c}`,i.disabled=Z.currentPage<=1,o.disabled=Z.currentPage>=c}function Wo(e){return Array.isArray(e.schedule_key_duties)?e.schedule_key_duties:e.schedule_key_duties?[e.schedule_key_duties]:[]}function zo(e){return Array.isArray(e.duty_trains)?e.duty_trains:e.duty_trains?[e.duty_trains]:[]}function Vn(e){const t=Wo(e).map(r=>{var s;return(s=r==null?void 0:r.schedule_keys)==null?void 0:s.name}).filter(Boolean);return[...new Set(t)]}function gh(e){const t=Wo(e).map(r=>r==null?void 0:r.schedule_key_id).filter(Boolean);return[...new Set(t)]}function vh(e){const t=zo(e).map(r=>{var s;return(s=r==null?void 0:r.trains)==null?void 0:s.number}).filter(Boolean);return[...new Set(t)]}function bh(e){const t=zo(e).map(r=>({trainId:r==null?void 0:r.train_id,sequenceOrder:Number.isFinite(Number(r==null?void 0:r.sequence_order))?Number(r.sequence_order):Number.MAX_SAFE_INTEGER})).filter(r=>!!r.trainId).sort((r,s)=>r.sequenceOrder-s.sequenceOrder);return[...new Set(t.map(r=>r.trainId))]}function _h(e){const t=String((e==null?void 0:e.duty_files)||"").trim();if(!t)return 0;if(t.startsWith("["))try{const r=JSON.parse(t);if(Array.isArray(r))return r.filter(s=>String((s==null?void 0:s.url)||"").trim()).length}catch{return 1}return t.split(`
`).map(r=>r.trim()).filter(Boolean).length}function Sh(e){const t=e.querySelector("#duties-type-filter");if(!t)return;const r=Z.dutyTypeFilter||"",s=[...new Set(Z.allDuties.map(n=>{var a;return String(((a=n==null?void 0:n.duty_types)==null?void 0:a.name)||"").trim()}).filter(Boolean))].sort((n,a)=>n.localeCompare(a,"bg"));t.innerHTML=`
    <option value=""></option>
    ${s.map(n=>`<option value="${de(n.toLowerCase())}">${de(n)}</option>`).join("")}
  `,t.value=r}function wh(e){const t=e.querySelector("#duties-schedule-key-filter");if(!t)return;const r=Z.scheduleKeyFilter||"",s=[...new Set(Z.allDuties.flatMap(n=>Vn(n)).map(n=>String(n||"").trim()).filter(Boolean))].sort((n,a)=>n.localeCompare(a,"bg"));t.innerHTML=`
    <option value=""></option>
    ${s.map(n=>`<option value="${de(n.toLowerCase())}">${de(n)}</option>`).join("")}
  `,t.value=r}const Yr="duty-files",Xr=5;async function kh(e){const t=await ue("../duties.html",import.meta.url);e.innerHTML=t,Lh(e),Eh(e),await Th(e),await $h(e),await qh(e),await sn(e)}function Lh(e){const t=e.querySelector("#duty-form-fields");t&&(t.innerHTML=`
    ${zn({idPrefix:"duty"})}

    <div class="col-12">
      <label for="duty-attachment-file" class="form-label"></label>
      <input id="duty-attachment-file" class="form-control" type="file" multiple />
      <div class="form-text">    ${Xr}  .</div>
    </div>

    <div id="duty-current-attachments-wrap" class="col-12 d-none">
      <label class="form-label"> </label>
      <div id="duty-current-attachments-links" class="d-flex flex-column gap-2"></div>
    </div>

    <input type="hidden" id="duty-existing-attachments" />
    <input type="hidden" id="duty-draft-attachments" />
  `)}async function qh(e){const t=e.querySelector("#duty-trains"),{data:r,error:s}=await w.from("trains").select("id, number, origin_station, destination_station").order("number",{ascending:!0});if(s){v(jh(s),"error");return}const n=(r||[]).map(a=>{const i=`${a.origin_station||"-"} - ${a.destination_station||"-"}`;return`<option value="${a.id}">${de(a.number||"-")} (${de(i)})</option>`}).join("");t.innerHTML=n}async function Th(e){const t=e.querySelector("#duty-type"),{data:r,error:s}=await w.from("duty_types").select("id, name").order("name",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${de(a.name)}</option>`).join("");t.innerHTML='<option value=""> </option>'+n}function Eh(e){var $,q;const t=e.querySelector("#open-create-duty"),r=e.querySelector("#duty-form"),s=e.querySelector("#duty-cancel-btn"),n=e.querySelector("#duties-table-body"),a=e.querySelector("#duty-modal"),i=e.querySelector("#duty-delete-modal"),o=e.querySelector("#duty-profile-modal"),l=e.querySelector("#duty-attachment-preview-modal"),c=e.querySelector("#duty-modal-close"),d=e.querySelector("#duty-delete-confirm"),u=e.querySelector("#duty-delete-cancel"),h=e.querySelector("#duty-profile-close"),m=e.querySelector("#duty-profile-close-secondary"),f=e.querySelector("#duty-profile-duplicate"),p=e.querySelector("#duty-profile-edit"),_=e.querySelector("#duties-search"),y=e.querySelector("#duties-schedule-key-filter"),b=e.querySelector("#duties-type-filter"),g=e.querySelector("#duties-filter-reset"),S=e.querySelector("#duties-prev-page"),k=e.querySelector("#duties-next-page"),E=e.querySelector("#duty-attachment-file"),L=e.querySelector("#duty-current-attachments-links");t==null||t.addEventListener("click",()=>{_a(e),Ht(a)}),r==null||r.addEventListener("submit",async T=>{T.preventDefault(),await Ah(e)}),s==null||s.addEventListener("click",()=>{Ve(a)}),c==null||c.addEventListener("click",()=>{Ve(a)}),u==null||u.addEventListener("click",()=>{Ve(i)}),h==null||h.addEventListener("click",()=>{Ve(o)}),m==null||m.addEventListener("click",()=>{Ve(o)}),($=e.querySelector("#duty-profile-content"))==null||$.addEventListener("click",T=>{const C=T.target.closest('button[data-duty-profile-action="preview-attachment"]');if(!C)return;const A=String(C.getAttribute("data-url")||"").trim(),x=String(C.getAttribute("data-label")||"").trim();xi(e,A,x)}),(q=e.querySelector("#duty-attachment-preview-close"))==null||q.addEventListener("click",()=>{Dh(e)}),p==null||p.addEventListener("click",()=>{var C;const T=((C=o==null?void 0:o.dataset)==null?void 0:C.dutyId)||"";T&&(Ve(o),Ci(e,T))}),f==null||f.addEventListener("click",()=>{var C;const T=((C=o==null?void 0:o.dataset)==null?void 0:C.dutyId)||"";T&&(Ve(o),Ri(e,T))}),_==null||_.addEventListener("input",T=>{Z.searchQuery=T.target.value.trim().toLowerCase(),Z.currentPage=1,tt(e)}),b==null||b.addEventListener("change",T=>{Z.dutyTypeFilter=T.target.value||"",Z.currentPage=1,tt(e)}),y==null||y.addEventListener("change",T=>{Z.scheduleKeyFilter=T.target.value||"",Z.currentPage=1,tt(e)}),g==null||g.addEventListener("click",()=>{Z.searchQuery="",Z.scheduleKeyFilter="",Z.dutyTypeFilter="",Z.currentPage=1,_&&(_.value=""),y&&(y.value=""),b&&(b.value=""),tt(e)}),S==null||S.addEventListener("click",()=>{Z.currentPage-=1,tt(e)}),k==null||k.addEventListener("click",()=>{Z.currentPage+=1,tt(e)}),E==null||E.addEventListener("change",()=>{var T;(T=E.files)!=null&&T.length&&E.files.length>Xr&&(v(`    ${Xr}  .`,"warning"),E.value="")}),L==null||L.addEventListener("input",T=>{const C=T.target.closest(".duty-existing-attachment-label");if(!C)return;const A=Number(C.getAttribute("data-index"));if(!Number.isInteger(A)||A<0)return;const x=e.querySelector("#duty-draft-attachments"),D=Ut((x==null?void 0:x.value)||"");D[A]&&(D[A].label=C.value,x&&(x.value=Zr(D)||""))}),L==null||L.addEventListener("click",T=>{const C=T.target.closest(".duty-existing-attachment-preview");if(C){const U=String(C.getAttribute("data-url")||"").trim(),W=String(C.getAttribute("data-label")||"").trim();xi(e,U,W);return}const A=T.target.closest(".duty-existing-attachment-remove");if(!A)return;const x=Number(A.getAttribute("data-index"));if(!Number.isInteger(x)||x<0)return;const D=e.querySelector("#duty-draft-attachments"),P=Ut((D==null?void 0:D.value)||"");P[x]&&(P.splice(x,1),Sa(e,P))}),ph("duties",[l,o,i,a]),d==null||d.addEventListener("click",async()=>{const T=e.querySelector("#duty-delete-id").value;await xh(T,e)}),n==null||n.addEventListener("click",async T=>{const C=T.target.closest("button[data-action]");if(!C)return;const A=C.getAttribute("data-action");if(A==="profile"){const x=C.getAttribute("data-id");Hh(e,x);return}if(A==="edit"){const x=C.getAttribute("data-id");Ci(e,x);return}if(A==="duplicate"){const x=C.getAttribute("data-id");Ri(e,x);return}if(A==="delete"){const x=C.getAttribute("data-id");e.querySelector("#duty-delete-id").value=x,Ht(i)}}),n==null||n.addEventListener("dragstart",T=>{const C=T.target.closest("tr[data-duty-id]");C&&(Z.draggedDutyId=C.getAttribute("data-duty-id"),C.classList.add("table-active"))}),n==null||n.addEventListener("dragend",T=>{const C=T.target.closest("tr[data-duty-id]");C&&C.classList.remove("table-active"),Z.draggedDutyId=null}),n==null||n.addEventListener("dragover",T=>{T.preventDefault()}),n==null||n.addEventListener("drop",async T=>{T.preventDefault();const C=T.target.closest("tr[data-duty-id]"),A=Z.draggedDutyId;if(!C||!A)return;const x=C.getAttribute("data-duty-id");if(!x||x===A)return;const D=Z.allDuties.findIndex(z=>z.id===A),P=Z.allDuties.findIndex(z=>z.id===x);if(D<0||P<0)return;const[U]=Z.allDuties.splice(D,1);if(Z.allDuties.splice(P,0,U),tt(e),!await yh()){await sn(e);return}v("    .","success")})}async function $h(e){const t=e.querySelector("#duty-schedule-keys"),{data:r,error:s}=await w.from("schedule_keys").select("id, name").order("name",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${de(a.name)}</option>`).join("");t.innerHTML=n}async function Ah(e){var Y,te;const t=e.querySelector("#duty-id"),r=e.querySelector("#duty-name"),s=e.querySelector("#duty-type"),n=e.querySelector("#duty-schedule-keys"),a=e.querySelector("#duty-trains"),i=Pr(e,"#duty-start","#duty-start-time"),o=Pr(e,"#duty-end","#duty-end-time"),l=e.querySelector("#duty-second-day"),c=Pr(e,"#duty-break-start","#duty-break-start-time"),d=Pr(e,"#duty-break-end","#duty-break-end-time"),u=e.querySelector("#duty-notes"),h=e.querySelector("#duty-attachment-file"),m=e.querySelector("#duty-existing-attachments"),f=e.querySelector("#duty-draft-attachments"),p=e.querySelector("#duty-save-btn"),_=r.value.trim(),y=s.value||null,b=Array.from(n.selectedOptions||[]).map(j=>j.value).filter(Boolean),g=Array.from(a.selectedOptions||[]).map(j=>j.value).filter(Boolean),S=b[0]||null,k=(i==null?void 0:i.value)||"",E=(o==null?void 0:o.value)||"",L=l.checked,$=(c==null?void 0:c.value)||"00:00",q=(d==null?void 0:d.value)||"00:00",T=u.value.trim()||null,C=Ut((m==null?void 0:m.value)||""),A=Ut((f==null?void 0:f.value)||""),x=Array.from((h==null?void 0:h.files)||[]),D=t.value;if(!_||!y||!k||!E){v(",    .","warning");return}if(!b.length){v("   -.","warning");return}const P=Ie(k,E);if(Ie($,q)>P){v("     -    .","warning");return}const W=p.innerHTML;p.disabled=!0,p.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const z=D||crypto.randomUUID(),H=Bs(A),K=[];if(H.length+x.length>Xr){p.disabled=!1,p.innerHTML=W,v(` ${Xr} /   .`,"warning");return}if(x.length){const j=await Ih(x,z);if(!j){p.disabled=!1,p.innerHTML=W;return}j.forEach(J=>{J!=null&&J.url&&H.push({url:J.url,label:J.label||es(J.url,H.length)}),J!=null&&J.objectPath&&K.push(J.objectPath)})}const R=Bs(H),O={name:_,duty_type_id:y,schedule_key_id:S,start_time:k,end_time:E,second_day:L,break_start_time:$,break_end_time:q,notes:T,duty_files:Zr(R)};let N,B=D||null;if(D)({error:N}=await w.from("duties").update(O).eq("id",D));else{const{data:j}=await w.auth.getUser(),J=((Y=j==null?void 0:j.user)==null?void 0:Y.id)??((te=j==null?void 0:j.user)==null?void 0:te.email)??"web_app",ie=Z.allDuties.reduce((ke,I)=>Math.max(ke,Number(I.display_order)||0),0),{data:oe,error:me}=await w.from("duties").insert({...O,id:z,created_from:J,display_order:ie+1}).select("id").single();N=me,B=(oe==null?void 0:oe.id)??null}if(!N&&B&&(N=await Ch(B,b)),!N&&B&&(N=await Rh(B,g)),p.disabled=!1,p.innerHTML=W,N){K.length&&await ts(K),v(N.message,"error");return}if(D){const j=C.map(me=>Gn(me.url)).filter(Boolean),J=R.map(me=>Gn(me.url)).filter(Boolean),ie=new Set(J),oe=j.filter(me=>!ie.has(me));oe.length&&await ts(oe)}v(D?"  .":"  .","success"),Ve(e.querySelector("#duty-modal")),_a(e),await sn(e)}function Vo(e,t){const r=Ut(t.dutyFiles);e.querySelector("#duty-id").value=t.id,e.querySelector("#duty-name").value=t.name??"",e.querySelector("#duty-type").value=t.dutyTypeId??"";const s=e.querySelector("#duty-schedule-keys"),n=t.scheduleKeyIds||[];Array.from(s.options).forEach(o=>{o.selected=n.includes(o.value)});const a=e.querySelector("#duty-trains"),i=t.trainIds||[];Array.from(a.options).forEach(o=>{o.selected=i.includes(o.value)}),yt(e,t.startTime??"","#duty-start","#duty-start-time"),yt(e,t.endTime??"","#duty-end","#duty-end-time"),e.querySelector("#duty-second-day").checked=!!t.secondDay,yt(e,jt(t.breakStartTime),"#duty-break-start","#duty-break-start-time"),yt(e,jt(t.breakEndTime),"#duty-break-end","#duty-break-end-time"),e.querySelector("#duty-notes").value=t.notes??"",e.querySelector("#duty-existing-attachments").value=Zr(r)||"",e.querySelector("#duty-draft-attachments").value=Zr(r)||"",e.querySelector("#duty-attachment-file").value="",Sa(e,r),e.querySelector("#duty-form-title").textContent="  ",e.querySelector("#duty-save-btn").textContent=""}function _a(e){e.querySelector("#duty-id").value="",e.querySelector("#duty-name").value="",e.querySelector("#duty-type").value="";const t=e.querySelector("#duty-schedule-keys");Array.from(t.options).forEach(s=>{s.selected=!1});const r=e.querySelector("#duty-trains");Array.from(r.options).forEach(s=>{s.selected=!1}),yt(e,"","#duty-start","#duty-start-time"),yt(e,"","#duty-end","#duty-end-time"),e.querySelector("#duty-second-day").checked=!1,yt(e,"00:00","#duty-break-start","#duty-break-start-time"),yt(e,"00:00","#duty-break-end","#duty-break-end-time"),e.querySelector("#duty-notes").value="",e.querySelector("#duty-existing-attachments").value="",e.querySelector("#duty-draft-attachments").value="",e.querySelector("#duty-attachment-file").value="",Sa(e,[]),e.querySelector("#duty-form-title").textContent=" ",e.querySelector("#duty-save-btn").textContent=""}async function xh(e,t){const r=t.querySelector("#duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:n,error:a}=await w.from("duties").select("duty_files").eq("id",e).maybeSingle();if(a){r.disabled=!1,r.innerHTML=s,v(a.message,"error");return}const{error:i}=await w.from("duties").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,i){v(i.message,"error");return}const o=Ut(n==null?void 0:n.duty_files).map(l=>Gn(l.url)).filter(Boolean);o.length&&await ts(o),v("  .","success"),Ve(t.querySelector("#duty-delete-modal")),_a(t),await sn(t)}async function Ch(e,t){const{error:r}=await w.from("schedule_key_duties").delete().eq("duty_id",e);if(r)return r;const s=t.map(a=>({duty_id:e,schedule_key_id:a})),{error:n}=await w.from("schedule_key_duties").insert(s);return n}async function Rh(e,t){const{error:r}=await w.from("duty_trains").delete().eq("duty_id",e);if(r)return r;if(!t.length)return null;const s=t.map((a,i)=>({duty_id:e,train_id:a,sequence_order:i+1})),{error:n}=await w.from("duty_trains").insert(s);return n}function Sa(e,t){const r=e.querySelector("#duty-current-attachments-wrap"),s=e.querySelector("#duty-current-attachments-links"),n=e.querySelector("#duty-draft-attachments");if(!r||!s||!n)return;const a=Bs(t);if(n.value=Zr(a)||"",!a.length){r.classList.add("d-none"),s.innerHTML="";return}r.classList.remove("d-none"),s.innerHTML=a.map((i,o)=>{const l=i.label||es(i.url,o);return`
        <div class="border rounded p-2 w-100">
          <div class="mb-2 d-flex align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <a href="${de(i.url)}" target="_blank" rel="noopener noreferrer"></a>
              <button
                type="button"
                class="btn btn-link btn-sm p-0 lh-1 text-decoration-none duty-existing-attachment-preview"
                data-url="${de(i.url)}"
                data-label="${de(l)}"
                title=""
                aria-label=""
              >
                
              </button>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger duty-existing-attachment-remove"
              data-index="${o}"
            >
              
            </button>
          </div>
          <input
            type="text"
            class="form-control form-control-sm duty-existing-attachment-label"
            data-index="${o}"
            value="${de(l)}"
            placeholder="  /"
          />
        </div>
      `}).join("")}function Ut(e){if(Array.isArray(e))return e.map((r,s)=>Ds(r,s)).filter(r=>r.url);const t=String(e||"").trim();if(!t)return[];if(t.startsWith("["))try{const r=JSON.parse(t);if(Array.isArray(r))return r.map((s,n)=>Ds(s,n)).filter(s=>s.url)}catch{return[{url:t,label:es(t,0)}]}return t.split(`
`).map((r,s)=>Ds(r,s)).filter(r=>r.url)}function Ds(e,t){if(e&&typeof e=="object"&&!Array.isArray(e)){const s=String(e.url||"").trim(),n=String(e.label||"").trim()||es(s,t);return{url:s,label:n}}const r=String(e||"").trim();return{url:r,label:es(r,t)}}function Zr(e){const t=Bs(e);return t.length?JSON.stringify(t):""}function Bs(e){const t=[],r=new Set;for(const s of e||[]){const n=Ds(s,t.length);if(!n.url)continue;const a=n.url.toLowerCase();r.has(a)||(r.add(a),t.push(n))}return t}function es(e,t){const r=String(e||"").trim();if(!r)return` ${t+1}`;try{const n=new URL(r).pathname.split("/").pop()||"",a=decodeURIComponent(n);if(a)return a}catch{}return` ${t+1}`}async function Ih(e,t){var s;if(!Array.isArray(e)||!e.length||!t)return[];const r=[];for(const n of e){const i=(((s=n.name)==null?void 0:s.split(".").pop())||"pdf").toLowerCase().replace(/[^a-z0-9]/g,"")||"pdf",o=Math.random().toString(36).slice(2,10),l=`${t}/${Date.now()}-${o}.${i}`,{error:c}=await w.storage.from(Yr).upload(l,n,{upsert:!0,contentType:n.type||void 0});if(c)return r.length&&await ts(r.map(u=>u.objectPath)),v(c.message,"error"),null;const{data:d}=w.storage.from(Yr).getPublicUrl(l);if(!(d!=null&&d.publicUrl))return await ts([l,...r.map(u=>u.objectPath)]),v("  ,       .","error"),null;r.push({url:d.publicUrl,label:n.name||"",objectPath:l})}return r}function Gn(e){const t=String(e||"").trim();if(!t)return"";if(!/^https?:\/\//i.test(t)){const r=t.replace(/^\/+/,""),s=`${Yr}/`;return r.startsWith(s)?r.slice(s.length):""}try{const r=new URL(t),s=`/storage/v1/object/public/${Yr}/`,n=r.pathname.indexOf(s);return n===-1?"":decodeURIComponent(r.pathname.slice(n+s.length))}catch{return""}}async function ts(e){const t=Array.from(new Set((e||[]).filter(Boolean)));t.length&&await w.storage.from(Yr).remove(t)}function xi(e,t,r){const s=e.querySelector("#duty-attachment-preview-modal"),n=e.querySelector("#duty-attachment-preview-frame"),a=e.querySelector("#duty-attachment-preview-text-wrap"),i=e.querySelector("#duty-attachment-preview-text"),o=e.querySelector("#duty-attachment-preview-csv-wrap"),l=e.querySelector("#duty-attachment-preview-csv-note"),c=e.querySelector("#duty-attachment-preview-csv-head"),d=e.querySelector("#duty-attachment-preview-csv-body"),u=e.querySelector("#duty-attachment-preview-title"),h=e.querySelector("#duty-attachment-preview-fallback"),m=e.querySelector("#duty-attachment-preview-open");if(!s||!n||!a||!i||!o||!l||!c||!d||!u||!h||!m)return;const f=String(t||"").trim();if(!f){v("   .","warning");return}const p=Nh(f),_=Jn(f),y=_==="csv",b=["txt","csv","json"].includes(_);u.textContent=r?`: ${r}`:"  ",m.setAttribute("href",f),h.classList.add("d-none"),a.classList.add("d-none"),o.classList.add("d-none"),l.textContent="",c.innerHTML="",d.innerHTML="",i.textContent="",n.classList.remove("d-none"),n.src="about:blank",y?(o.classList.remove("d-none"),n.classList.add("d-none"),Oh(f,c,d,l,h)):b?(a.classList.remove("d-none"),n.classList.add("d-none"),i.textContent="...",Mh(f,i,h)):(n.src=p,n.onload=()=>{if(p!==f){h.classList.add("d-none");return}const g=Jn(f),S=["doc","docx","xls","xlsx","ppt","pptx"].includes(g);h.classList.toggle("d-none",!S)},n.onerror=()=>{h.classList.remove("d-none")}),Ht(s)}function Dh(e){const t=e.querySelector("#duty-attachment-preview-modal"),r=e.querySelector("#duty-attachment-preview-frame"),s=e.querySelector("#duty-attachment-preview-text-wrap"),n=e.querySelector("#duty-attachment-preview-text"),a=e.querySelector("#duty-attachment-preview-csv-wrap"),i=e.querySelector("#duty-attachment-preview-csv-note"),o=e.querySelector("#duty-attachment-preview-csv-head"),l=e.querySelector("#duty-attachment-preview-csv-body"),c=e.querySelector("#duty-attachment-preview-fallback"),d=e.querySelector("#duty-attachment-preview-open");!t||!r||!s||!n||!a||!i||!o||!l||!c||!d||(r.src="about:blank",r.classList.remove("d-none"),s.classList.add("d-none"),a.classList.add("d-none"),n.textContent="",i.textContent="",o.innerHTML="",l.innerHTML="",d.setAttribute("href","#"),c.classList.add("d-none"),Ve(t))}async function Oh(e,t,r,s,n){try{const a=await fetch(e,{cache:"no-store"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const i=await a.text(),o=Ph(i);if(!o.length){t.innerHTML="",r.innerHTML="",s.textContent="  .",n.classList.add("d-none");return}const l=200,c=o.slice(0,l),d=c[0]||[],u=c.slice(1);t.innerHTML=`
      <tr>${d.map(h=>`<th>${de(h)}</th>`).join("")}</tr>
    `,r.innerHTML=u.map(h=>`<tr>${h.map(m=>`<td>${de(m)}</td>`).join("")}</tr>`).join(""),o.length>l?s.textContent=`   ${l}    ${o.length}.`:s.textContent=`: ${o.length}.`,n.classList.add("d-none")}catch{t.innerHTML="",r.innerHTML="",s.textContent="",n.classList.remove("d-none")}}function Ph(e){const t=[];let r=[],s="",n=!1;for(let a=0;a<e.length;a+=1){const i=e[a],o=e[a+1];if(i==='"'){n&&o==='"'?(s+='"',a+=1):n=!n;continue}if(!n&&i===","){r.push(s),s="";continue}if(!n&&(i===`
`||i==="\r")){i==="\r"&&o===`
`&&(a+=1),r.push(s),t.push(r),r=[],s="";continue}s+=i}return(s.length||r.length)&&(r.push(s),t.push(r)),t}async function Mh(e,t,r){try{const s=await fetch(e,{cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);const n=await s.text();t.textContent=n||"( )",r.classList.add("d-none")}catch{t.textContent="    .",r.classList.remove("d-none")}}function Nh(e){const t=Jn(e);return["doc","docx","xls","xlsx","ppt","pptx"].includes(t)?`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(e)}`:e}function Jn(e){const t=String(e||"").trim();if(!t)return"";try{const s=new URL(t).pathname.split("/").pop()||"",n=s.includes(".")?s.split(".").pop():"";return String(n||"").toLowerCase()}catch{return""}}function jh(e){const t=String((e==null?void 0:e.message)||"").trim(),r=t.toLowerCase(),s=r.includes("row-level security")||r.includes("violates row-level security policy")||String((e==null?void 0:e.code)||"")==="42501";return s&&r.includes("duty_trains")?"      .    .":s&&r.includes("duties")?"      .    .":s?"       (RLS).":t||"  ."}function Hh(e,t){const r=Z.allDuties.find(d=>d.id===t),s=e.querySelector("#duty-profile-content"),n=e.querySelector("#duty-profile-modal"),a=e.querySelector("#duty-profile-duplicate"),i=e.querySelector("#duty-profile-edit");if(!s||!n)return;if(!r){n.dataset.dutyId="",i&&(i.disabled=!0),a&&(a.disabled=!0),s.innerHTML='<p class="text-secondary mb-0">    .</p>',Ht(n);return}n.dataset.dutyId=r.id,i&&(i.disabled=!1),a&&(a.disabled=!1);const o=Uh(r),l=Fh(r),c=Ut(r==null?void 0:r.duty_files);s.innerHTML=Ko({duty:r,scheduleKeyNames:o,trainNumbers:l,attachmentEntries:c,escapeHtml:de,intervalToTimeInput:jt,formatInterval:Bh}),Ht(n)}function Ci(e,t){const r=Z.allDuties.find(s=>s.id===t);if(!r){v("     .","warning");return}Vo(e,{id:r.id,name:r.name||"",dutyTypeId:r.duty_type_id||"",scheduleKeyIds:Go(r),trainIds:Jo(r),startTime:Ks(r.start_time),endTime:Ks(r.end_time),secondDay:!!r.second_day,breakStartTime:r.break_start_time||"00:00:00",breakEndTime:r.break_end_time||"00:00:00",notes:r.notes||"",dutyFiles:r.duty_files||""}),Ht(e.querySelector("#duty-modal"))}function Ri(e,t){const r=Z.allDuties.find(s=>s.id===t);if(!r){v("     .","warning");return}Vo(e,{id:"",name:r.name?`${r.name} ()`:"",dutyTypeId:r.duty_type_id||"",scheduleKeyIds:Go(r),trainIds:Jo(r),startTime:Ks(r.start_time),endTime:Ks(r.end_time),secondDay:!!r.second_day,breakStartTime:r.break_start_time||"00:00:00",breakEndTime:r.break_end_time||"00:00:00",notes:r.notes||"",dutyFiles:r.duty_files||""}),e.querySelector("#duty-id").value="",e.querySelector("#duty-form-title").textContent="  ()",e.querySelector("#duty-save-btn").textContent="",Ht(e.querySelector("#duty-modal"))}function Uh(e){const r=(Array.isArray(e==null?void 0:e.schedule_key_duties)?e.schedule_key_duties:e!=null&&e.schedule_key_duties?[e.schedule_key_duties]:[]).map(s=>{var n;return(n=s==null?void 0:s.schedule_keys)==null?void 0:n.name}).filter(Boolean);return[...new Set(r)]}function Go(e){const r=(Array.isArray(e==null?void 0:e.schedule_key_duties)?e.schedule_key_duties:e!=null&&e.schedule_key_duties?[e.schedule_key_duties]:[]).map(s=>s==null?void 0:s.schedule_key_id).filter(Boolean);return[...new Set(r)]}function Fh(e){return(Array.isArray(e==null?void 0:e.duty_trains)?e.duty_trains:e!=null&&e.duty_trains?[e.duty_trains]:[]).map(r=>{var s;return{number:(s=r==null?void 0:r.trains)==null?void 0:s.number,sequenceOrder:Number.isFinite(Number(r==null?void 0:r.sequence_order))?Number(r.sequence_order):Number.MAX_SAFE_INTEGER}}).filter(r=>!!r.number).sort((r,s)=>r.sequenceOrder-s.sequenceOrder).map(r=>r.number).filter((r,s,n)=>n.indexOf(r)===s)}function Jo(e){return(Array.isArray(e==null?void 0:e.duty_trains)?e.duty_trains:e!=null&&e.duty_trains?[e.duty_trains]:[]).map(r=>({id:r==null?void 0:r.train_id,sequenceOrder:Number.isFinite(Number(r==null?void 0:r.sequence_order))?Number(r.sequence_order):Number.MAX_SAFE_INTEGER})).filter(r=>!!r.id).sort((r,s)=>r.sequenceOrder-s.sequenceOrder).map(r=>r.id).filter((r,s,n)=>n.indexOf(r)===s)}function Ks(e){return e?String(e).slice(0,5):""}function Pr(e,...t){for(const r of t){const s=e.querySelector(r);if(s)return s}return null}function yt(e,t,...r){const s=Pr(e,...r);s&&(s.value=t)}function Bh(e){return e?String(e).replace(".000000",""):"-"}function Os(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const Ii=new Map;function Kh(e,t){const r=Ii.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){pt(a);return}}};Ii.set(e,s),document.addEventListener("keydown",s)}function pt(e){var t,r,s;e.classList.add("d-none"),(t=document.querySelector("#employee-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#employee-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#employee-profile-modal"))!=null&&s.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function Oe(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const we={rows:[],searchQuery:"",positionFilter:"",activeFilter:""};async function wa(e){const{data:t,error:r}=await w.from("employees").select("id, first_name, last_name, position_id, is_active, photo_url, psychological_assessment_expiry, medical_certificate_expiry, license_expiry, positions(title), user_profiles(id, username)").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(r){v(r.message,"error"),we.rows=[],ar(e,"    .");return}we.rows=t||[],ar(e)}function ar(e,t){const r=e.querySelector("#employees-table-body"),s=e.querySelector("#employees-empty");Wh(e);const n=we.rows.filter(a=>{var u;const i=`${a.first_name||""} ${a.last_name||""}`.toLowerCase(),o=(((u=a.positions)==null?void 0:u.title)||"").toLowerCase(),l=!we.searchQuery||i.includes(we.searchQuery)||o.includes(we.searchQuery),c=!we.positionFilter||o===we.positionFilter,d=!we.activeFilter||String(!!a.is_active)===we.activeFilter;return l&&c&&d});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{var l;const i=Array.isArray(a.user_profiles)?a.user_profiles:a.user_profiles?[a.user_profiles]:[],o=i.length?i.map(c=>{const d=(c==null?void 0:c.username)||(c==null?void 0:c.id)||"";return d||""}).filter(Boolean).join(", "):"-";return`
        <tr data-employee-id="${a.id}">
          <td>${Oe(a.first_name??"")} ${Oe(a.last_name??"")}</td>
          <td>${Oe(o)}</td>
          <td>${Oe(((l=a.positions)==null?void 0:l.title)??"-")}</td>
          <td>${a.is_active?"":""}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="profile"
                data-id="${a.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-first-name="${Oe(a.first_name??"")}"
                data-last-name="${Oe(a.last_name??"")}"
                data-position-id="${a.position_id??""}"
                data-active="${a.is_active?"true":"false"}"
                data-photo-url="${Oe(a.photo_url??"")}"
                data-psych-expiry="${Oe(a.psychological_assessment_expiry??"")}"
                data-medical-expiry="${Oe(a.medical_certificate_expiry??"")}"
                data-license-expiry="${Oe(a.license_expiry??"")}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}function Wh(e){const t=e.querySelector("#employees-position-filter");if(!t)return;const r=we.positionFilter||"",s=[...new Set(we.rows.map(n=>{var a;return String(((a=n==null?void 0:n.positions)==null?void 0:a.title)||"").trim()}).filter(Boolean))].sort((n,a)=>n.localeCompare(a,"bg"));t.innerHTML=`
    <option value=""></option>
    ${s.map(n=>`<option value="${Oe(n.toLowerCase())}">${Oe(n)}</option>`).join("")}
  `,t.value=r}const Di="employee-photos";let Lr=null;async function zh(e){const t=await ue("../employees.html",import.meta.url);e.innerHTML=t,Gh(e),await Jh(e),await wa(e);const r=Vh();r&&await Qo(e,r)}function Vh(){return new URLSearchParams(window.location.search).get("profile")||""}function Gh(e){const t=e.querySelector("#open-create-employee"),r=e.querySelector("#employee-form"),s=e.querySelector("#employee-cancel-btn"),n=e.querySelector("#employees-table-body"),a=e.querySelector("#employee-modal"),i=e.querySelector("#employee-delete-modal"),o=e.querySelector("#employee-profile-modal"),l=e.querySelector("#employee-modal-close"),c=e.querySelector("#employee-profile-close"),d=e.querySelector("#employee-profile-close-btn"),u=e.querySelector("#employee-delete-confirm"),h=e.querySelector("#employee-delete-cancel"),m=e.querySelector("#employees-search"),f=e.querySelector("#employees-position-filter"),p=e.querySelector("#employees-active-filter"),_=e.querySelector("#employees-filter-reset"),y=e.querySelector("#employee-photo-file"),b=e.querySelector("#employee-photo-remove-btn");t==null||t.addEventListener("click",()=>{ka(e),Os(a)}),r==null||r.addEventListener("submit",async g=>{g.preventDefault(),await Qh(e)}),s==null||s.addEventListener("click",()=>{pt(a)}),l==null||l.addEventListener("click",()=>{pt(a)}),h==null||h.addEventListener("click",()=>{pt(i)}),c==null||c.addEventListener("click",()=>{pt(o)}),d==null||d.addEventListener("click",()=>{pt(o)}),m==null||m.addEventListener("input",g=>{we.searchQuery=g.target.value.trim().toLowerCase(),ar(e)}),f==null||f.addEventListener("change",g=>{we.positionFilter=g.target.value||"",ar(e)}),p==null||p.addEventListener("change",g=>{we.activeFilter=g.target.value||"",ar(e)}),_==null||_.addEventListener("click",()=>{we.searchQuery="",we.positionFilter="",we.activeFilter="",m&&(m.value=""),f&&(f.value=""),p&&(p.value=""),ar(e)}),y==null||y.addEventListener("change",()=>{var S,k,E,L;const g=((S=y.files)==null?void 0:S[0])??null;if(!g){const $=((k=e.querySelector("#employee-photo-path"))==null?void 0:k.value)||"";ir(e,$);return}if(!((E=g.type)!=null&&E.startsWith("image/"))){v("    .","warning"),y.value="";const $=((L=e.querySelector("#employee-photo-path"))==null?void 0:L.value)||"";ir(e,$);return}ir(e,g)}),b==null||b.addEventListener("click",()=>{const g=e.querySelector("#employee-photo-path");g&&(g.value=""),y&&(y.value=""),ir(e,null)}),Kh("employees",[i,o,a]),u==null||u.addEventListener("click",async()=>{const g=e.querySelector("#employee-delete-id").value;await Xh(g,e)}),n==null||n.addEventListener("click",async g=>{const S=g.target.closest("button[data-action]");if(!S)return;const k=S.getAttribute("data-action");if(k==="profile"){const E=S.getAttribute("data-id");await Qo(e,E);return}if(k==="edit"){Yh(e,{id:S.getAttribute("data-id"),firstName:S.getAttribute("data-first-name"),lastName:S.getAttribute("data-last-name"),positionId:S.getAttribute("data-position-id"),isActive:S.getAttribute("data-active")==="true",psychExpiry:S.getAttribute("data-psych-expiry"),medicalExpiry:S.getAttribute("data-medical-expiry"),licenseExpiry:S.getAttribute("data-license-expiry"),photoUrl:S.getAttribute("data-photo-url")}),Os(a);return}if(k==="delete"){const E=S.getAttribute("data-id");e.querySelector("#employee-delete-id").value=E,Os(i)}})}async function Qo(e,t){var d;const{data:r,error:s}=await w.from("employees").select("id, first_name, last_name, is_active, photo_url, psychological_assessment_expiry, medical_certificate_expiry, license_expiry, other_certificates, positions(title), user_profiles(id, username)").eq("id",t).maybeSingle();if(s||!r){v((s==null?void 0:s.message)||"   .","error");return}const n=Array.isArray(r.user_profiles)?r.user_profiles:r.user_profiles?[r.user_profiles]:[],a=n.length?n.map(u=>{const h=(u==null?void 0:u.username)||(u==null?void 0:u.id)||"";return h||""}).filter(Boolean).join(", "):"-",i=r.other_certificates?JSON.stringify(r.other_certificates,null,2):"-",o=Yo(r.photo_url),l=e.querySelector("#employee-profile-photo"),c=e.querySelector("#employee-profile-photo-empty");l&&c&&(o?(l.src=o,l.classList.remove("d-none"),c.classList.add("d-none")):(l.src="",l.classList.add("d-none"),c.classList.remove("d-none"))),e.querySelector("#employee-profile-name").textContent=`${r.first_name??""} ${r.last_name??""}`.trim()||"-",e.querySelector("#employee-profile-position").textContent=((d=r.positions)==null?void 0:d.title)||"-",e.querySelector("#employee-profile-active").textContent=r.is_active?"":"",e.querySelector("#employee-profile-linked-profiles").textContent=a,e.querySelector("#employee-profile-psych").textContent=r.psychological_assessment_expiry||"-",e.querySelector("#employee-profile-medical").textContent=r.medical_certificate_expiry||"-",e.querySelector("#employee-profile-license").textContent=r.license_expiry||"-",e.querySelector("#employee-profile-certificates").textContent=i,Os(e.querySelector("#employee-profile-modal"))}function Yo(e){if(!e)return null;const t=String(e).trim();if(!t)return null;if(/^https?:\/\//i.test(t))return t;const r=t.replace(/^\/+/,""),s=["employee-photos","employees","employee_photos"],n=[],a=r.split("/");if(a.length>1){const o=a[0],l=a.slice(1).join("/");n.push({bucket:o,objectPath:l})}s.forEach(o=>{n.push({bucket:o,objectPath:r})});const i=new Set;for(const o of n){const l=`${o.bucket}/${o.objectPath}`;if(i.has(l)||!o.bucket||!o.objectPath)continue;i.add(l);const{data:c}=w.storage.from(o.bucket).getPublicUrl(o.objectPath);if(c!=null&&c.publicUrl)return c.publicUrl}return null}async function Jh(e){const t=e.querySelector("#employee-position"),{data:r,error:s}=await w.from("positions").select("id, title").order("title",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${Oe(a.title)}</option>`).join("");t.innerHTML='<option value=""> </option>'+n}async function Qh(e){var C,A,x;const t=e.querySelector("#employee-id"),r=e.querySelector("#employee-first-name"),s=e.querySelector("#employee-last-name"),n=e.querySelector("#employee-position"),a=e.querySelector("#employee-active"),i=e.querySelector("#employee-psych-expiry"),o=e.querySelector("#employee-medical-expiry"),l=e.querySelector("#employee-license-expiry"),c=e.querySelector("#employee-photo-file"),d=e.querySelector("#employee-photo-path"),u=e.querySelector("#employee-save-btn"),h=r.value.trim(),m=s.value.trim(),f=n.value||null,p=a.checked,_=i.value||null,y=o.value||null,b=l.value||null,g=((C=c.files)==null?void 0:C[0])??null,S=d.value.trim()||null,k=t.value;if(!h||!m){v(",    .","warning");return}const E=u.innerHTML;u.disabled=!0,u.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const L={first_name:h,last_name:m,position_id:f,is_active:p,psychological_assessment_expiry:_,medical_certificate_expiry:y,license_expiry:b,updated_at:new Date().toISOString()};if(g&&!((A=g.type)!=null&&A.startsWith("image/"))){u.disabled=!1,u.innerHTML=E,v("    .","warning");return}let $,q=k||null,T=S;if(k){if(g){const D=await Oi(g,k);if(!D){u.disabled=!1,u.innerHTML=E;return}T=D}L.photo_url=T,{error:$}=await w.from("employees").update(L).eq("id",k)}else{const{data:D}=await w.auth.getUser(),P=((x=D==null?void 0:D.user)==null?void 0:x.email)??"web_app",{data:U,error:W}=await w.from("employees").insert({...L,created_from:P}).select("id").single();if($=W,q=(U==null?void 0:U.id)??null,!$&&q&&g){const z=await Oi(g,q);if(!z){u.disabled=!1,u.innerHTML=E;return}const{error:H}=await w.from("employees").update({photo_url:z,updated_at:new Date().toISOString()}).eq("id",q);$=H,T=z}}if(u.disabled=!1,u.innerHTML=E,$){v($.message,"error");return}v(k?"  .":"  .","success"),pt(e.querySelector("#employee-modal")),ka(e),await wa(e)}function Yh(e,t){e.querySelector("#employee-id").value=t.id,e.querySelector("#employee-first-name").value=t.firstName??"",e.querySelector("#employee-last-name").value=t.lastName??"",e.querySelector("#employee-position").value=t.positionId??"",e.querySelector("#employee-active").checked=!!t.isActive,e.querySelector("#employee-psych-expiry").value=t.psychExpiry??"",e.querySelector("#employee-medical-expiry").value=t.medicalExpiry??"",e.querySelector("#employee-license-expiry").value=t.licenseExpiry??"",e.querySelector("#employee-photo-path").value=t.photoUrl??"",e.querySelector("#employee-photo-file").value="",ir(e,t.photoUrl??null),e.querySelector("#employee-form-title").textContent="  ",e.querySelector("#employee-save-btn").textContent=""}function ka(e){e.querySelector("#employee-id").value="",e.querySelector("#employee-first-name").value="",e.querySelector("#employee-last-name").value="",e.querySelector("#employee-position").value="",e.querySelector("#employee-active").checked=!0,e.querySelector("#employee-psych-expiry").value="",e.querySelector("#employee-medical-expiry").value="",e.querySelector("#employee-license-expiry").value="",e.querySelector("#employee-photo-path").value="",e.querySelector("#employee-photo-file").value="",ir(e,null),e.querySelector("#employee-form-title").textContent=" ",e.querySelector("#employee-save-btn").textContent=""}async function Xh(e,t){const r=t.querySelector("#employee-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await w.from("employees").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){v(n.message,"error");return}v("  .","success"),pt(t.querySelector("#employee-delete-modal")),ka(t),await wa(t)}async function Oi(e,t){var o;if(!e||!t)return null;const s=(((o=e.name)==null?void 0:o.split(".").pop())||"jpg").toLowerCase().replace(/[^a-z0-9]/g,"")||"jpg",n=Math.random().toString(36).slice(2,10),a=`${t}/${Date.now()}-${n}.${s}`,{error:i}=await w.storage.from(Di).upload(a,e,{upsert:!0,contentType:e.type||void 0});return i?(v(i.message,"error"),null):`${Di}/${a}`}function ir(e,t){const r=e.querySelector("#employee-photo-preview"),s=e.querySelector("#employee-photo-preview-empty");if(!r||!s)return;if(Lr&&(URL.revokeObjectURL(Lr),Lr=null),!t){r.src="",r.classList.add("d-none"),s.classList.remove("d-none");return}if(t instanceof File){Lr=URL.createObjectURL(t),r.src=Lr,r.classList.remove("d-none"),s.classList.add("d-none");return}const n=Yo(t);if(!n){r.src="",r.classList.add("d-none"),s.classList.remove("d-none");return}r.src=n,r.classList.remove("d-none"),s.classList.add("d-none")}function wn(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const Pi=new Map;function Zh(e,t){const r=Pi.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){mr(a);return}}};Pi.set(e,s),document.addEventListener("keydown",s)}function mr(e){var t,r;e.classList.add("d-none"),(t=document.querySelector("#employee-absence-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#employee-absence-delete-modal"))!=null&&r.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function Qe(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const be={rows:[],searchQuery:"",dateFrom:"",dateTo:""};function Mi(e){return e&&`${e.first_name??""} ${e.last_name??""}`.trim()||"-"}async function La(e){const{data:t,error:r}=await w.from("employee_absences").select("id, employee_id, reason_id, start_date, end_date, notes, employees(first_name, last_name), absence_reasons(name)").order("start_date",{ascending:!1}).order("end_date",{ascending:!1});if(r){v(r.message,"error"),be.rows=[],or(e,"    .");return}be.rows=t||[],or(e)}function or(e,t){const r=e.querySelector("#employee-absences-table-body"),s=e.querySelector("#employee-absences-empty"),n=be.rows.filter(a=>{var f;const i=Mi(a.employees).toLowerCase(),o=(((f=a.absence_reasons)==null?void 0:f.name)||"").toLowerCase(),l=String(a.start_date||"").toLowerCase(),c=String(a.end_date||"").toLowerCase(),d=String(a.notes||"").toLowerCase(),u=!be.searchQuery||i.includes(be.searchQuery)||o.includes(be.searchQuery)||l.includes(be.searchQuery)||c.includes(be.searchQuery)||d.includes(be.searchQuery),h=!be.dateFrom||String(a.end_date||"")>=be.dateFrom,m=!be.dateTo||String(a.start_date||"")<=be.dateTo;return u&&h&&m});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{var i;return`
        <tr>
          <td>${Qe(Mi(a.employees))}</td>
          <td>${Qe(((i=a.absence_reasons)==null?void 0:i.name)??"-")}</td>
          <td>${Qe(a.start_date??"-")}</td>
          <td>${Qe(a.end_date??"-")}</td>
          <td>${Qe(a.notes??"")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-employee-id="${a.employee_id??""}"
                data-reason-id="${a.reason_id??""}"
                data-start-date="${Qe(a.start_date??"")}"
                data-end-date="${Qe(a.end_date??"")}"
                data-notes="${Qe(a.notes??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}async function ef(e){const t=await ue("../employee-absences.html",import.meta.url);e.innerHTML=t,tf(e),await rf(e),await sf(e),await La(e)}function tf(e){const t=e.querySelector("#open-create-employee-absence"),r=e.querySelector("#employee-absence-form"),s=e.querySelector("#employee-absence-cancel-btn"),n=e.querySelector("#employee-absences-table-body"),a=e.querySelector("#employee-absence-modal"),i=e.querySelector("#employee-absence-delete-modal"),o=e.querySelector("#employee-absence-modal-close"),l=e.querySelector("#employee-absence-delete-confirm"),c=e.querySelector("#employee-absence-delete-cancel"),d=e.querySelector("#employee-absences-search"),u=e.querySelector("#employee-absences-date-from"),h=e.querySelector("#employee-absences-date-to"),m=e.querySelector("#employee-absences-filter-reset");t==null||t.addEventListener("click",()=>{qa(e),wn(a)}),r==null||r.addEventListener("submit",async f=>{f.preventDefault(),await nf(e)}),s==null||s.addEventListener("click",()=>{mr(a)}),o==null||o.addEventListener("click",()=>{mr(a)}),c==null||c.addEventListener("click",()=>{mr(i)}),d==null||d.addEventListener("input",f=>{be.searchQuery=f.target.value.trim().toLowerCase(),or(e)}),u==null||u.addEventListener("change",f=>{be.dateFrom=f.target.value||"",or(e)}),h==null||h.addEventListener("change",f=>{be.dateTo=f.target.value||"",or(e)}),m==null||m.addEventListener("click",()=>{be.searchQuery="",be.dateFrom="",be.dateTo="",d&&(d.value=""),u&&(u.value=""),h&&(h.value=""),or(e)}),Zh("employee-absences",[i,a]),l==null||l.addEventListener("click",async()=>{const f=e.querySelector("#employee-absence-delete-id").value;await of(f,e)}),n==null||n.addEventListener("click",f=>{const p=f.target.closest("button[data-action]");if(!p)return;const _=p.getAttribute("data-action");if(_==="edit"){af(e,{id:p.getAttribute("data-id"),employeeId:p.getAttribute("data-employee-id"),reasonId:p.getAttribute("data-reason-id"),startDate:p.getAttribute("data-start-date"),endDate:p.getAttribute("data-end-date"),notes:p.getAttribute("data-notes")}),wn(a);return}if(_==="delete"){const y=p.getAttribute("data-id");e.querySelector("#employee-absence-delete-id").value=y,wn(i)}})}async function rf(e){const t=e.querySelector("#employee-absence-employee"),{data:r,error:s}=await w.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>{const i=`${a.first_name??""} ${a.last_name??""}`.trim()||"-";return`<option value="${a.id}">${Qe(i)}</option>`}).join("");t.innerHTML='<option value=""> </option>'+n}async function sf(e){const t=e.querySelector("#employee-absence-reason"),{data:r,error:s}=await w.from("absence_reasons").select("id, name").order("name",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${Qe(a.name??"-")}</option>`).join("");t.innerHTML='<option value=""> </option>'+n}async function nf(e){var y;const t=e.querySelector("#employee-absence-id"),r=e.querySelector("#employee-absence-employee"),s=e.querySelector("#employee-absence-reason"),n=e.querySelector("#employee-absence-start-date"),a=e.querySelector("#employee-absence-end-date"),i=e.querySelector("#employee-absence-notes"),o=e.querySelector("#employee-absence-save-btn"),l=r.value||null,c=s.value||null,d=n.value,u=a.value,h=i.value.trim()||null,m=t.value;if(!l||!c||!d||!u){v(",    .","warning");return}if(u<d){v(' " "        " ".',"warning");return}const f=o.innerHTML;o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const p={employee_id:l,reason_id:c,start_date:d,end_date:u,notes:h};let _;if(m)({error:_}=await w.from("employee_absences").update(p).eq("id",m));else{const{data:b}=await w.auth.getUser(),g=((y=b==null?void 0:b.user)==null?void 0:y.email)??"web_app";({error:_}=await w.from("employee_absences").insert({...p,created_from:g}))}if(o.disabled=!1,o.innerHTML=f,_){v(_.message,"error");return}v(m?"  .":"  .","success"),mr(e.querySelector("#employee-absence-modal")),qa(e),await La(e)}function af(e,t){e.querySelector("#employee-absence-id").value=t.id,e.querySelector("#employee-absence-employee").value=t.employeeId??"",e.querySelector("#employee-absence-reason").value=t.reasonId??"",e.querySelector("#employee-absence-start-date").value=t.startDate??"",e.querySelector("#employee-absence-end-date").value=t.endDate??"",e.querySelector("#employee-absence-notes").value=t.notes??"",e.querySelector("#employee-absence-form-title").textContent="  ",e.querySelector("#employee-absence-save-btn").textContent=""}function qa(e){e.querySelector("#employee-absence-id").value="",e.querySelector("#employee-absence-employee").value="",e.querySelector("#employee-absence-reason").value="",e.querySelector("#employee-absence-start-date").value="",e.querySelector("#employee-absence-end-date").value="",e.querySelector("#employee-absence-notes").value="",e.querySelector("#employee-absence-form-title").textContent=" ",e.querySelector("#employee-absence-save-btn").textContent=""}async function of(e,t){const r=t.querySelector("#employee-absence-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await w.from("employee_absences").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){v(n.message,"error");return}v("  .","success"),mr(t.querySelector("#employee-absence-delete-modal")),qa(t),await La(t)}function Mr(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const Ni=new Map;function lf(e,t){const r=Ni.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Ue(a);return}}};Ni.set(e,s),document.addEventListener("keydown",s)}function Ue(e){var t,r,s,n;e.classList.add("d-none"),(t=document.querySelector("#planned-duty-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#planned-duty-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#planned-duty-auto-modal"))!=null&&s.classList.contains("d-none"))&&((n=document.querySelector("#planned-duty-bulk-delete-modal"))!=null&&n.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function st(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const G={rows:[],searchQuery:"",dateFilter:"",roleFilter:"",selectedIds:[],visibleRowIds:[]};function ji(e){return e&&`${e.first_name??""} ${e.last_name??""}`.trim()||"-"}async function pr(e){const{data:t,error:r}=await w.from("planned_duties").select("id, date, employee_id, duty_id, assignment_role, employees(first_name, last_name), duties(name, schedule_key_duties(schedule_key_id))").order("date",{ascending:!1});if(r){v(r.message,"error"),G.rows=[],lt(e,"     .");return}G.rows=t||[],lt(e)}function lt(e,t){const r=e.querySelector("#planned-duties-table-body"),s=e.querySelector("#planned-duties-empty"),n=e.querySelector("#planned-duties-select-all"),a=e.querySelector("#open-bulk-delete-planned-duty"),i=e.querySelector("#add-selected-to-actual-duty");G.selectedIds=G.selectedIds.filter(c=>G.rows.some(d=>d.id===c));const o=G.rows.filter(c=>{var _;const d=ji(c.employees).toLowerCase(),u=(((_=c.duties)==null?void 0:_.name)||"").toLowerCase(),h=(c.date||"").toLowerCase(),m=!G.searchQuery||d.includes(G.searchQuery)||u.includes(G.searchQuery)||h.includes(G.searchQuery),f=!G.dateFilter||c.date===G.dateFilter,p=!G.roleFilter||c.assignment_role===G.roleFilter;return m&&f&&p});if(!o.length){G.visibleRowIds=[],r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .",n&&(n.checked=!1,n.indeterminate=!1,n.disabled=!0),a&&(a.disabled=G.selectedIds.length===0,a.textContent=G.selectedIds.length?`  (${G.selectedIds.length})`:" "),i&&(i.disabled=G.selectedIds.length===0,i.textContent=G.selectedIds.length?`  (${G.selectedIds.length})`:" ");return}G.visibleRowIds=o.map(c=>c.id),s.classList.add("d-none"),r.innerHTML=o.map(c=>{var h;const d=cf(c),u=G.selectedIds.includes(c.id);return`
        <tr>
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              data-select-id="${c.id}"
              ${u?"checked":""}
              aria-label=" "
            />
          </td>
          <td>${st(c.date??"-")}</td>
          <td>${st(ji(c.employees))}</td>
          <td>${st(df(c.assignment_role))}</td>
          <td>${st(((h=c.duties)==null?void 0:h.name)??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${c.id}"
                data-date="${st(c.date??"")}"
                data-employee-id="${c.employee_id??""}"
                data-duty-id="${c.duty_id??""}"
                data-assignment-role="${c.assignment_role??"conductor"}"
                data-duty-schedule-key-id="${d}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${c.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("");const l=o.filter(c=>G.selectedIds.includes(c.id)).length;n&&(n.disabled=!1,n.checked=l>0&&l===o.length,n.indeterminate=l>0&&l<o.length),a&&(a.disabled=G.selectedIds.length===0,a.textContent=G.selectedIds.length?`  (${G.selectedIds.length})`:" "),i&&(i.disabled=G.selectedIds.length===0,i.textContent=G.selectedIds.length?`  (${G.selectedIds.length})`:" ")}function cf(e){var r,s,n;return((n=(Array.isArray((r=e==null?void 0:e.duties)==null?void 0:r.schedule_key_duties)?e.duties.schedule_key_duties:(s=e==null?void 0:e.duties)!=null&&s.schedule_key_duties?[e.duties.schedule_key_duties]:[]).find(a=>a==null?void 0:a.schedule_key_id))==null?void 0:n.schedule_key_id)||""}function df(e){return e==="chief"?" ":""}let Ta=[];async function uf(e){const t=e.querySelector("#planned-duty-employee"),r=e.querySelector("#planned-duty-auto-employee"),{data:s,error:n}=await w.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(n){v(n.message,"error");return}const i='<option value=""> </option>'+(s||[]).map(o=>{const l=`${o.first_name??""} ${o.last_name??""}`.trim()||"-";return`<option value="${o.id}">${st(l)}</option>`}).join("");t.innerHTML=i,r.innerHTML=i}async function hf(e){const t=e.querySelector("#planned-duty-schedule-key"),r=e.querySelector("#planned-duty-auto-schedule-key"),{data:s,error:n}=await w.from("schedule_keys").select("id, name, crew_role").order("name",{ascending:!0});if(n){v(n.message,"error");return}const i='<option value=""> -</option>'+(s||[]).map(o=>{const l=ff(o.crew_role),c=l?`${o.name??"-"} (${l})`:o.name??"-";return`<option value="${o.id}">${st(c)}</option>`}).join("");t.innerHTML=i,r.innerHTML=i}function ff(e){return e===" "?" ":e===""?"":""}async function mf(e){const{data:t,error:r}=await w.from("schedule_key_duties").select("schedule_key_id, duty_id, duties(id, name)");if(r){v(r.message,"error");return}const s=new Map;(t||[]).forEach(n=>{const a=n==null?void 0:n.duties;if(!(a!=null&&a.id))return;const i=s.get(a.id)||{id:a.id,name:a.name||"-",scheduleKeyIds:[]};n.schedule_key_id&&!i.scheduleKeyIds.includes(n.schedule_key_id)&&i.scheduleKeyIds.push(n.schedule_key_id),s.set(a.id,i)}),Ta=Array.from(s.values()).sort((n,a)=>String(n.name||"").localeCompare(String(a.name||""),"bg")),nn(e,"","")}function nn(e,t,r){const s=e.querySelector("#planned-duty-duty");if(!s)return;if(!t){s.innerHTML='<option value="">  -</option>',s.value="";return}const n=Ta.filter(a=>{var i;return(i=a.scheduleKeyIds)==null?void 0:i.includes(t)}).map(a=>{const i=a.id===r?"selected":"";return`<option value="${a.id}" ${i}>${st(a.name??"-")}</option>`}).join("");s.innerHTML='<option value=""> </option>'+n,r&&(s.value=r)}function pf(e,t){var s;const r=Ta.find(n=>n.id===e);return!!(r&&((s=r.scheduleKeyIds)!=null&&s.includes(t)))}const kn=new Map;async function Hi(e,t,r){const s=e.querySelector("#planned-duty-auto-start-duty");if(!s)return;if(!t){s.innerHTML='<option value="">  -</option>',s.value="";return}const n=await Zo(t);if(!n.length){s.innerHTML='<option value="">    -</option>',s.value="";return}const a=n.map(i=>{const o=i.id===r?"selected":"";return`<option value="${i.id}" ${o}>${st(i.name??"-")}</option>`}).join("");s.innerHTML='<option value="">  </option>'+a}function Xo(e){e.querySelector("#planned-duty-auto-employee").value="",e.querySelector("#planned-duty-auto-assignment-role").value="conductor",e.querySelector("#planned-duty-auto-date-from").value="",e.querySelector("#planned-duty-auto-date-to").value="",e.querySelector("#planned-duty-auto-schedule-key").value="",e.querySelector("#planned-duty-auto-overwrite").checked=!1,e.querySelector("#planned-duty-auto-start-duty").innerHTML='<option value="">  -</option>'}async function yf(e,t){var $;const r=e.querySelector("#planned-duty-auto-employee").value||null,s=e.querySelector("#planned-duty-auto-assignment-role").value||"",n=e.querySelector("#planned-duty-auto-date-from").value,a=e.querySelector("#planned-duty-auto-date-to").value,i=e.querySelector("#planned-duty-auto-schedule-key").value||null,o=e.querySelector("#planned-duty-auto-start-duty").value||null,l=e.querySelector("#planned-duty-auto-overwrite").checked,c=e.querySelector("#planned-duty-auto-save-btn");if(!r||!s||!n||!a||!i||!o){v(",      .","warning");return}if(!["chief","conductor"].includes(s)){v(" .     .","warning");return}if(a<n){v(' " "        " ".',"warning");return}const d=await Zo(i);if(!d.length){v("    -.","warning");return}const u=d.findIndex(q=>q.id===o);if(u<0){v("   .","warning");return}const h=gf(n,a);if(!h.length){v(" .","warning");return}const m=c.innerHTML;c.disabled=!0,c.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:f}=await w.auth.getUser(),p=(($=f==null?void 0:f.user)==null?void 0:$.email)??"web_app",{data:_,error:y}=await w.from("planned_duties").select("date").eq("employee_id",r).gte("date",n).lte("date",a);if(y){c.disabled=!1,c.innerHTML=m,v(y.message,"error");return}const b=new Set((_||[]).map(q=>q.date)),g=b.size,S=[];let k=0;if(h.forEach((q,T)=>{if(!l&&b.has(q)){k+=1;return}const C=d[(u+T)%d.length];S.push({date:q,employee_id:r,assignment_role:s,duty_id:C.id,created_from:p})}),!S.length){c.disabled=!1,c.innerHTML=m,v("    .       .","warning");return}if(l){const{error:q}=await w.from("planned_duties").delete().eq("employee_id",r).gte("date",n).lte("date",a);if(q){c.disabled=!1,c.innerHTML=m,v(q.message,"error");return}}let E=null;for(let q=0;q<S.length;q+=200){const T=S.slice(q,q+200),{error:C}=await w.from("planned_duties").insert(T);if(C){E=C;break}}if(c.disabled=!1,c.innerHTML=m,E){v(E.message,"error");return}Ue(e.querySelector("#planned-duty-auto-modal")),Xo(e),await t();const L=S.length;if(l){v(` : ${L}.  : ${g}.`,"success");return}if(k>0){v(`: ${L}.  (   ): ${k}.`,"success");return}v(` : ${L}.`,"success")}async function Zo(e){if(!e)return[];if(kn.has(e))return kn.get(e);const{data:t,error:r}=await w.from("schedule_key_duties").select("duty_id, duties(id, name, display_order)").eq("schedule_key_id",e);if(r)return v(r.message,"error"),[];const s=(t||[]).map(n=>{var a,i,o;return{id:(a=n==null?void 0:n.duties)==null?void 0:a.id,name:((i=n==null?void 0:n.duties)==null?void 0:i.name)||"-",displayOrder:Number((o=n==null?void 0:n.duties)==null?void 0:o.display_order)||0}}).filter(n=>n.id).sort((n,a)=>n.displayOrder!==a.displayOrder?n.displayOrder-a.displayOrder:String(n.name||"").localeCompare(String(a.name||""),"bg"));return kn.set(e,s),s}function gf(e,t){const r=[],s=new Date(`${e}T00:00:00`),n=new Date(`${t}T00:00:00`);if(Number.isNaN(s.getTime())||Number.isNaN(n.getTime())||s>n)return r;for(let a=new Date(s);a<=n;a.setDate(a.getDate()+1)){const i=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),l=String(a.getDate()).padStart(2,"0");r.push(`${i}-${o}-${l}`)}return r}function vf(e){if(!G.selectedIds.length){v("     .","warning");return}const t=e.querySelector("#planned-duty-bulk-delete-count");t&&(t.textContent=String(G.selectedIds.length)),Mr(e.querySelector("#planned-duty-bulk-delete-modal"))}function bf(e){const t=G.visibleRowIds||[];if(e){const r=new Set(G.selectedIds);t.forEach(s=>r.add(s)),G.selectedIds=Array.from(r);return}G.selectedIds=G.selectedIds.filter(r=>!t.includes(r))}function _f(e,t){if(e){if(t){G.selectedIds.includes(e)||(G.selectedIds=[...G.selectedIds,e]);return}G.selectedIds=G.selectedIds.filter(r=>r!==e)}}async function Sf(e,t){const r=e.querySelector("#planned-duty-bulk-delete-confirm"),s=[...G.selectedIds];if(!s.length){Ue(e.querySelector("#planned-duty-bulk-delete-modal"));return}const n=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let a=null;for(let o=0;o<s.length;o+=200){const l=s.slice(o,o+200),{error:c}=await w.from("planned_duties").delete().in("id",l);if(c){a=c;break}}if(r.disabled=!1,r.innerHTML=n,a){v(a.message,"error");return}const i=s.length;G.selectedIds=[],Ue(e.querySelector("#planned-duty-bulk-delete-modal")),await t(),v(` : ${i}.`,"success")}async function wf(e,t){const r=e.querySelector("#add-selected-to-actual-duty"),s=[...G.selectedIds];if(!s.length){v("       .","warning");return}const n=new Set(s),a=G.rows.filter(d=>n.has(d.id));if(!a.length){v("     .","warning");return}const i=a.filter(d=>(d==null?void 0:d.date)&&(d==null?void 0:d.employee_id)&&(d==null?void 0:d.duty_id)).map(d=>({date:d.date,employee_id:d.employee_id,duty_id:d.duty_id,assignment_role:d.assignment_role||"conductor"}));if(!i.length){v("     .","warning");return}const o=(r==null?void 0:r.innerHTML)||" ";r&&(r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');let l=null;for(let d=0;d<i.length;d+=200){const u=i.slice(d,d+200),{error:h}=await w.from("actual_duties").upsert(u,{onConflict:"date,employee_id,duty_id",ignoreDuplicates:!0});if(h){l=h;break}}if(r&&(r.disabled=!1,r.innerHTML=o),l){v(l.message,"error");return}const c=i.length;G.selectedIds=[],await t(),v(`  : ${c}.   .`,"success")}async function kf(e){const t=await ue("../planned-duties.html",import.meta.url);e.innerHTML=t,Lf(e),await uf(e),await hf(e),await mf(e),await pr(e)}function Lf(e){const t=e.querySelector("#open-create-planned-duty"),r=e.querySelector("#open-bulk-delete-planned-duty"),s=e.querySelector("#add-selected-to-actual-duty"),n=e.querySelector("#go-to-plan-schedule"),a=e.querySelector("#open-auto-plan-duty"),i=e.querySelector("#planned-duty-form"),o=e.querySelector("#planned-duty-auto-form"),l=e.querySelector("#planned-duty-cancel-btn"),c=e.querySelector("#planned-duty-auto-cancel-btn"),d=e.querySelector("#planned-duties-table-body"),u=e.querySelector("#planned-duty-modal"),h=e.querySelector("#planned-duty-auto-modal"),m=e.querySelector("#planned-duty-delete-modal"),f=e.querySelector("#planned-duty-bulk-delete-modal"),p=e.querySelector("#planned-duty-modal-close"),_=e.querySelector("#planned-duty-auto-modal-close"),y=e.querySelector("#planned-duty-delete-confirm"),b=e.querySelector("#planned-duty-delete-cancel"),g=e.querySelector("#planned-duty-bulk-delete-confirm"),S=e.querySelector("#planned-duty-bulk-delete-cancel"),k=e.querySelector("#planned-duties-select-all"),E=e.querySelector("#planned-duties-search"),L=e.querySelector("#planned-duties-date-filter"),$=e.querySelector("#planned-duties-role-filter"),q=e.querySelector("#planned-duties-filter-reset"),T=e.querySelector("#planned-duty-schedule-key"),C=e.querySelector("#planned-duty-auto-schedule-key");t==null||t.addEventListener("click",()=>{Ea(e),Mr(u)}),r==null||r.addEventListener("click",()=>{vf(e)}),s==null||s.addEventListener("click",async()=>{await wf(e,async()=>{await pr(e)})}),a==null||a.addEventListener("click",async()=>{Xo(e),Mr(h),await Hi(e,(C==null?void 0:C.value)||"","")}),i==null||i.addEventListener("submit",async A=>{A.preventDefault(),await qf(e)}),o==null||o.addEventListener("submit",async A=>{A.preventDefault(),await yf(e,async()=>{await pr(e)})}),l==null||l.addEventListener("click",()=>{Ue(u)}),p==null||p.addEventListener("click",()=>{Ue(u)}),_==null||_.addEventListener("click",()=>{Ue(h)}),c==null||c.addEventListener("click",()=>{Ue(h)}),b==null||b.addEventListener("click",()=>{Ue(m)}),S==null||S.addEventListener("click",()=>{Ue(f)}),E==null||E.addEventListener("input",A=>{G.searchQuery=A.target.value.trim().toLowerCase(),lt(e)}),L==null||L.addEventListener("change",A=>{G.dateFilter=A.target.value||"",Ln(n,G.dateFilter),lt(e)}),$==null||$.addEventListener("change",A=>{G.roleFilter=A.target.value||"",lt(e)}),q==null||q.addEventListener("click",()=>{G.searchQuery="",G.dateFilter="",G.roleFilter="",E&&(E.value=""),L&&(L.value=""),$&&($.value=""),Ln(n,G.dateFilter),lt(e)}),n==null||n.addEventListener("click",()=>{const A=G.dateFilter||(L==null?void 0:L.value)||"";if(!A){v("   ,    -.","warning");return}const x=new URLSearchParams({date:A});window.history.pushState({},"",`/plan-schedule?${x.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}),Ln(n,G.dateFilter||(L==null?void 0:L.value)||""),T==null||T.addEventListener("change",()=>{nn(e,T.value||"","")}),C==null||C.addEventListener("change",async()=>{await Hi(e,C.value||"","")}),k==null||k.addEventListener("change",()=>{bf(k.checked),lt(e)}),lf("planned-duties",[m,f,h,u]),y==null||y.addEventListener("click",async()=>{const A=e.querySelector("#planned-duty-delete-id").value;await Ef(A,e)}),g==null||g.addEventListener("click",async()=>{await Sf(e,async()=>{await pr(e)})}),d==null||d.addEventListener("change",A=>{const x=A.target.closest("input[data-select-id]");if(!x)return;const D=x.getAttribute("data-select-id");_f(D,x.checked),lt(e)}),d==null||d.addEventListener("click",A=>{const x=A.target.closest("button[data-action]");if(!x)return;const D=x.getAttribute("data-action");if(D==="edit"){Tf(e,{id:x.getAttribute("data-id"),date:x.getAttribute("data-date"),employeeId:x.getAttribute("data-employee-id"),assignmentRole:x.getAttribute("data-assignment-role")||"conductor",dutyId:x.getAttribute("data-duty-id"),dutyScheduleKeyId:x.getAttribute("data-duty-schedule-key-id")}),Mr(u);return}if(D==="delete"){const P=x.getAttribute("data-id");e.querySelector("#planned-duty-delete-id").value=P,Mr(m)}})}async function qf(e){var y;const t=e.querySelector("#planned-duty-id"),r=e.querySelector("#planned-duty-date"),s=e.querySelector("#planned-duty-employee"),n=e.querySelector("#planned-duty-assignment-role"),a=e.querySelector("#planned-duty-schedule-key"),i=e.querySelector("#planned-duty-duty"),o=e.querySelector("#planned-duty-save-btn"),l=r.value,c=s.value||null,d=n.value||"",u=a.value||null,h=i.value||null,m=t.value;if(!l||!c||!d||!u||!h){v(",   .","warning");return}if(!["chief","conductor"].includes(d)){v(" .     .","warning");return}if(!pf(h,u)){v("    -.","warning");return}const f=o.innerHTML;o.disabled=!0,o.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const p={date:l,employee_id:c,assignment_role:d,duty_id:h};let _;if(m)({error:_}=await w.from("planned_duties").update(p).eq("id",m));else{const{data:b}=await w.auth.getUser(),g=((y=b==null?void 0:b.user)==null?void 0:y.email)??"web_app";({error:_}=await w.from("planned_duties").insert({...p,created_from:g}))}if(o.disabled=!1,o.innerHTML=f,_){if(_.code==="23505"){v("      .","warning");return}v(_.message,"error");return}v(m?"  .":"  .","success"),Ue(e.querySelector("#planned-duty-modal")),Ea(e),await pr(e)}function Tf(e,t){e.querySelector("#planned-duty-id").value=t.id,e.querySelector("#planned-duty-date").value=t.date??"",e.querySelector("#planned-duty-employee").value=t.employeeId??"",e.querySelector("#planned-duty-assignment-role").value=t.assignmentRole??"conductor",e.querySelector("#planned-duty-schedule-key").value=t.dutyScheduleKeyId??"",nn(e,t.dutyScheduleKeyId??"",t.dutyId??""),e.querySelector("#planned-duty-form-title").textContent="  ",e.querySelector("#planned-duty-save-btn").textContent=""}function Ea(e){e.querySelector("#planned-duty-id").value="",e.querySelector("#planned-duty-date").value="",e.querySelector("#planned-duty-employee").value="",e.querySelector("#planned-duty-assignment-role").value="conductor",e.querySelector("#planned-duty-schedule-key").value="",nn(e,"",""),e.querySelector("#planned-duty-form-title").textContent=" ",e.querySelector("#planned-duty-save-btn").textContent=""}async function Ef(e,t){const r=t.querySelector("#planned-duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await w.from("planned_duties").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){v(n.message,"error");return}v("  .","success"),G.selectedIds=G.selectedIds.filter(a=>a!==e),Ue(t.querySelector("#planned-duty-delete-modal")),Ea(t),await pr(t)}function Ln(e,t){e&&(e.disabled=!t)}function It(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const Ui=new Map;function $f(e,t){const r=Ui.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Re(a);return}}};Ui.set(e,s),document.addEventListener("keydown",s)}function Re(e){var t,r,s,n,a;e.classList.add("d-none"),(t=document.querySelector("#actual-duty-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#actual-duty-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#actual-duty-bulk-delete-modal"))!=null&&s.classList.contains("d-none"))&&((n=document.querySelector("#actual-duty-bulk-add-modal"))!=null&&n.classList.contains("d-none"))&&((a=document.querySelector("#actual-duty-profile-modal"))!=null&&a.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function ne(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const M={rows:[],searchQuery:"",dateFilter:"",roleFilter:"",selectedIds:[],visibleRowIds:[],plannedRows:[],plannedSearchQuery:"",plannedDateFilter:"",plannedSelectedIds:[],plannedVisibleRowIds:[]};function Fi(e){return e&&`${e.first_name??""} ${e.last_name??""}`.trim()||"-"}async function cs(e){const{data:t,error:r}=await w.from("actual_duties").select("id, date, employee_id, duty_id, assignment_role, start_time_override, end_time_override, break_start_time_override, break_end_time_override, employees(first_name, last_name), duties(name, start_time, end_time, break_start_time, break_end_time, schedule_key_duties(schedule_key_id))").order("date",{ascending:!1});if(r){v(r.message,"error"),M.rows=[],ct(e,"     .");return}M.rows=t||[],ct(e)}function ct(e,t){const r=e.querySelector("#actual-duties-table-body"),s=e.querySelector("#actual-duties-empty"),n=e.querySelector("#actual-duties-select-all"),a=e.querySelector("#open-bulk-delete-actual-duty");M.selectedIds=M.selectedIds.filter(l=>M.rows.some(c=>c.id===l));const i=M.rows.filter(l=>{var p;const c=Fi(l.employees).toLowerCase(),d=(((p=l.duties)==null?void 0:p.name)||"").toLowerCase(),u=(l.date||"").toLowerCase(),h=!M.searchQuery||c.includes(M.searchQuery)||d.includes(M.searchQuery)||u.includes(M.searchQuery),m=!M.dateFilter||l.date===M.dateFilter,f=!M.roleFilter||l.assignment_role===M.roleFilter;return h&&m&&f});if(!i.length){M.visibleRowIds=[],r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"    .",n&&(n.checked=!1,n.indeterminate=!1,n.disabled=!0),a&&(a.disabled=M.selectedIds.length===0,a.textContent=M.selectedIds.length?`  (${M.selectedIds.length})`:" ");return}M.visibleRowIds=i.map(l=>l.id),s.classList.add("d-none"),r.innerHTML=i.map(l=>{var u,h,m,f,p;const c=Af(l),d=M.selectedIds.includes(l.id);return`
        <tr>
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              data-select-id="${l.id}"
              ${d?"checked":""}
              aria-label=" "
            />
          </td>
          <td>${ne(l.date??"-")}</td>
          <td>${ne(Fi(l.employees))}</td>
          <td>${ne(xf(l.assignment_role))}</td>
          <td>${ne(((u=l.duties)==null?void 0:u.name)??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-action="profile"
                data-id="${l.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${l.id}"
                data-date="${ne(l.date??"")}"
                data-employee-id="${l.employee_id??""}"
                data-duty-id="${l.duty_id??""}"
                data-assignment-role="${l.assignment_role??"conductor"}"
                data-duty-schedule-key-id="${c}"
                data-start-time-override="${ne((l.start_time_override||"").slice(0,5))}"
                data-end-time-override="${ne((l.end_time_override||"").slice(0,5))}"
                data-break-start-time-override="${ne((l.break_start_time_override||"").slice(0,5))}"
                data-break-end-time-override="${ne((l.break_end_time_override||"").slice(0,5))}"
                data-duty-start-time="${ne((((h=l.duties)==null?void 0:h.start_time)||"").slice(0,5))}"
                data-duty-end-time="${ne((((m=l.duties)==null?void 0:m.end_time)||"").slice(0,5))}"
                data-duty-break-start-time="${ne((((f=l.duties)==null?void 0:f.break_start_time)||"").slice(0,5))}"
                data-duty-break-end-time="${ne((((p=l.duties)==null?void 0:p.break_end_time)||"").slice(0,5))}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${l.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("");const o=i.filter(l=>M.selectedIds.includes(l.id)).length;n&&(n.disabled=!1,n.checked=o>0&&o===i.length,n.indeterminate=o>0&&o<i.length),a&&(a.disabled=M.selectedIds.length===0,a.textContent=M.selectedIds.length?`  (${M.selectedIds.length})`:" ")}function Af(e){var r,s,n;return((n=(Array.isArray((r=e==null?void 0:e.duties)==null?void 0:r.schedule_key_duties)?e.duties.schedule_key_duties:(s=e==null?void 0:e.duties)!=null&&s.schedule_key_duties?[e.duties.schedule_key_duties]:[]).find(a=>a==null?void 0:a.schedule_key_id))==null?void 0:n.schedule_key_id)||""}function xf(e){return e==="chief"?" ":""}let an=[];async function Cf(e){const t=await ue("../actual-duties.html",import.meta.url);e.innerHTML=t;const r=Wf(),s=e.querySelector("#actual-duties-date-filter");r&&s&&(s.value=r,M.dateFilter=r),Rf(e),await If(e),await Df(e),await Of(e),await cs(e)}function Rf(e){const t=e.querySelector("#open-create-actual-duty"),r=e.querySelector("#go-to-schedule"),s=e.querySelector("#open-bulk-delete-actual-duty"),n=e.querySelector("#open-bulk-add-actual-duty"),a=e.querySelector("#actual-duty-form"),i=e.querySelector("#actual-duties-table-body"),o=e.querySelector("#actual-duty-modal"),l=e.querySelector("#actual-duty-delete-modal"),c=e.querySelector("#actual-duty-bulk-delete-modal"),d=e.querySelector("#actual-duty-bulk-add-modal"),u=e.querySelector("#actual-duty-profile-modal"),h=e.querySelector("#actual-duty-modal-close"),m=e.querySelector("#actual-duty-cancel-btn"),f=e.querySelector("#actual-duty-profile-close"),p=e.querySelector("#actual-duty-profile-close-secondary"),_=e.querySelector("#actual-duty-delete-confirm"),y=e.querySelector("#actual-duty-delete-cancel"),b=e.querySelector("#actual-duty-bulk-delete-confirm"),g=e.querySelector("#actual-duty-bulk-delete-cancel"),S=e.querySelector("#actual-duty-bulk-add-modal-close"),k=e.querySelector("#actual-duty-bulk-add-cancel"),E=e.querySelector("#actual-duty-bulk-add-confirm"),L=e.querySelector("#actual-duty-bulk-add-search"),$=e.querySelector("#actual-duty-bulk-add-date-filter"),q=e.querySelector("#actual-duty-bulk-add-filter-reset"),T=e.querySelector("#actual-duty-bulk-add-select-all"),C=e.querySelector("#actual-duty-bulk-add-table-body"),A=e.querySelector("#actual-duties-search"),x=e.querySelector("#actual-duties-date-filter"),D=e.querySelector("#actual-duties-role-filter"),P=e.querySelector("#actual-duties-filter-reset"),U=e.querySelector("#actual-duty-schedule-key"),W=e.querySelector("#actual-duties-select-all");t==null||t.addEventListener("click",()=>{el(e),It(o)}),s==null||s.addEventListener("click",()=>{if(!M.selectedIds.length){v("     .","warning");return}const H=e.querySelector("#actual-duty-bulk-delete-count");H&&(H.textContent=String(M.selectedIds.length)),It(c)}),n==null||n.addEventListener("click",async()=>{Wi(e),await Bf(e),It(d)}),a==null||a.addEventListener("submit",async H=>{H.preventDefault(),await jf(e)}),h==null||h.addEventListener("click",()=>{Re(o)}),m==null||m.addEventListener("click",()=>{Re(o)}),f==null||f.addEventListener("click",()=>{Re(u)}),p==null||p.addEventListener("click",()=>{Re(u)}),y==null||y.addEventListener("click",()=>{Re(l)}),g==null||g.addEventListener("click",()=>{Re(c)}),S==null||S.addEventListener("click",()=>{Re(d)}),k==null||k.addEventListener("click",()=>{Re(d)}),A==null||A.addEventListener("input",H=>{M.searchQuery=H.target.value.trim().toLowerCase(),ct(e)}),x==null||x.addEventListener("change",H=>{M.dateFilter=H.target.value||"",qn(r,M.dateFilter),ct(e)}),D==null||D.addEventListener("change",H=>{M.roleFilter=H.target.value||"",ct(e)}),P==null||P.addEventListener("click",()=>{M.searchQuery="",M.dateFilter="",M.roleFilter="",A&&(A.value=""),x&&(x.value=""),D&&(D.value=""),qn(r,M.dateFilter),ct(e)}),r==null||r.addEventListener("click",()=>{const H=M.dateFilter||(x==null?void 0:x.value)||"";if(!H){v("   ,    .","warning");return}const K=new URLSearchParams({date:H});window.history.pushState({},"",`/schedule?${K.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}),qn(r,M.dateFilter||(x==null?void 0:x.value)||""),U==null||U.addEventListener("change",()=>{on(e,U.value||"",""),Ki(e)});const z=e.querySelector("#actual-duty-duty");z==null||z.addEventListener("change",()=>{Ki(e)}),W==null||W.addEventListener("change",()=>{const H=M.visibleRowIds||[];if(W.checked){const K=new Set(M.selectedIds);H.forEach(ee=>K.add(ee)),M.selectedIds=Array.from(K)}else M.selectedIds=M.selectedIds.filter(K=>!H.includes(K));ct(e)}),_==null||_.addEventListener("click",async()=>{const H=e.querySelector("#actual-duty-delete-id").value;await Uf(H,e)}),b==null||b.addEventListener("click",async()=>{await Ff(e)}),E==null||E.addEventListener("click",async()=>{await Kf(e)}),L==null||L.addEventListener("input",H=>{M.plannedSearchQuery=H.target.value.trim().toLowerCase(),Dt(e)}),$==null||$.addEventListener("change",H=>{M.plannedDateFilter=H.target.value||"",Dt(e)}),q==null||q.addEventListener("click",()=>{Wi(e),Dt(e)}),T==null||T.addEventListener("change",()=>{const H=M.plannedVisibleRowIds||[];if(T.checked){const K=new Set(M.plannedSelectedIds);H.forEach(ee=>K.add(ee)),M.plannedSelectedIds=Array.from(K)}else M.plannedSelectedIds=M.plannedSelectedIds.filter(K=>!H.includes(K));Dt(e)}),C==null||C.addEventListener("change",H=>{const K=H.target.closest("input[data-planned-select-id]");if(!K)return;const ee=K.getAttribute("data-planned-select-id");ee&&(K.checked?M.plannedSelectedIds.includes(ee)||(M.plannedSelectedIds=[...M.plannedSelectedIds,ee]):M.plannedSelectedIds=M.plannedSelectedIds.filter(R=>R!==ee),Dt(e))}),i==null||i.addEventListener("change",H=>{const K=H.target.closest("input[data-select-id]");if(!K)return;const ee=K.getAttribute("data-select-id");ee&&(K.checked?M.selectedIds.includes(ee)||(M.selectedIds=[...M.selectedIds,ee]):M.selectedIds=M.selectedIds.filter(R=>R!==ee),ct(e))}),i==null||i.addEventListener("click",H=>{const K=H.target.closest("button[data-action]");if(!K)return;const ee=K.getAttribute("data-action");if(ee==="profile"){const R=K.getAttribute("data-id");zf(e,R);return}if(ee==="edit"){Hf(e,{id:K.getAttribute("data-id"),date:K.getAttribute("data-date"),employeeId:K.getAttribute("data-employee-id"),assignmentRole:K.getAttribute("data-assignment-role")||"conductor",dutyId:K.getAttribute("data-duty-id"),dutyScheduleKeyId:K.getAttribute("data-duty-schedule-key-id"),startTimeOverride:K.getAttribute("data-start-time-override")||"",endTimeOverride:K.getAttribute("data-end-time-override")||"",breakStartTimeOverride:K.getAttribute("data-break-start-time-override")||"",breakEndTimeOverride:K.getAttribute("data-break-end-time-override")||"",dutyStartTime:K.getAttribute("data-duty-start-time")||"",dutyEndTime:K.getAttribute("data-duty-end-time")||"",dutyBreakStartTime:K.getAttribute("data-duty-break-start-time")||"",dutyBreakEndTime:K.getAttribute("data-duty-break-end-time")||""}),It(o);return}if(ee==="delete"){const R=K.getAttribute("data-id");e.querySelector("#actual-duty-delete-id").value=R,It(l)}}),$f("actual-duties",[u,l,c,d,o])}async function If(e){const t=e.querySelector("#actual-duty-employee"),{data:r,error:s}=await w.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>{const i=`${a.first_name??""} ${a.last_name??""}`.trim()||"-";return`<option value="${a.id}">${ne(i)}</option>`}).join("");t.innerHTML='<option value=""> </option>'+n}async function Df(e){const t=e.querySelector("#actual-duty-schedule-key"),{data:r,error:s}=await w.from("schedule_keys").select("id, name").order("name",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>`<option value="${a.id}">${ne(a.name??"-")}</option>`).join("");t.innerHTML='<option value=""> -</option>'+n}async function Of(e){const{data:t,error:r}=await w.from("schedule_key_duties").select("schedule_key_id, duty_id, duties(id, name, start_time, end_time, break_start_time, break_end_time)");if(r){v(r.message,"error");return}const s=new Map;(t||[]).forEach(n=>{const a=n==null?void 0:n.duties;if(!(a!=null&&a.id))return;const i=s.get(a.id)||{id:a.id,name:a.name||"-",scheduleKeyIds:[],startTime:gt(a.start_time),endTime:gt(a.end_time),breakStartTime:gt(a.break_start_time),breakEndTime:gt(a.break_end_time)};n.schedule_key_id&&!i.scheduleKeyIds.includes(n.schedule_key_id)&&i.scheduleKeyIds.push(n.schedule_key_id),s.set(a.id,i)}),an=Array.from(s.values()).sort((n,a)=>String(n.name||"").localeCompare(String(a.name||""),"bg")),on(e,"","")}function on(e,t,r){const s=e.querySelector("#actual-duty-duty");if(!s)return;if(!t){s.innerHTML='<option value="">  -</option>',s.value="";return}const n=an.filter(a=>{var i;return(i=a.scheduleKeyIds)==null?void 0:i.includes(t)}).map(a=>{const i=a.id===r?"selected":"";return`<option value="${a.id}" ${i}>${ne(a.name??"-")}</option>`}).join("");s.innerHTML='<option value=""> </option>'+n,r&&(s.value=r)}function Pf(e,t){var s;const r=an.find(n=>n.id===e);return!!(r&&((s=r.scheduleKeyIds)!=null&&s.includes(t)))}function Mf(e){return an.find(t=>t.id===e)||null}function gt(e){return e?String(e).slice(0,5):""}function Te(e,t=""){const r=String(e||"").slice(0,5);return/^\d{2}:\d{2}$/.test(r)?r:t}function Es(e){const t=Te(e,"");return t?`${t}:00`:null}function Bi(e){const t=Number(e);if(!Number.isFinite(t)||t<0)return"-";const r=Math.floor(t/60),s=t%60;return`${String(r).padStart(2,"0")}:${String(s).padStart(2,"0")}`}function Nf(e,t,r,s){const n=Te(e,""),a=Te(t,""),i=Te(r,"00:00"),o=Te(s,"00:00"),l=n&&a?Ie(n,a):null,c=Ie(i,o),d=Number.isFinite(l)?Math.max(0,l-c):null;return{startTime:n||"-",endTime:a||"-",breakStartTime:i||"-",breakEndTime:o||"-",breakDuration:Bi(c),duration:d===null?"-":Bi(d)}}function Ki(e){var o;const t=((o=e.querySelector("#actual-duty-duty"))==null?void 0:o.value)||"",r=Mf(t);if(!r)return;const s=e.querySelector("#actual-duty-start-time"),n=e.querySelector("#actual-duty-end-time"),a=e.querySelector("#actual-duty-break-start-time"),i=e.querySelector("#actual-duty-break-end-time");s&&(s.value=r.startTime||""),n&&(n.value=r.endTime||""),a&&(a.value=r.breakStartTime||"00:00"),i&&(i.value=r.breakEndTime||"00:00")}async function jf(e){const t=e.querySelector("#actual-duty-id"),r=e.querySelector("#actual-duty-date"),s=e.querySelector("#actual-duty-employee"),n=e.querySelector("#actual-duty-schedule-key"),a=e.querySelector("#actual-duty-duty"),i=e.querySelector("#actual-duty-assignment-role"),o=e.querySelector("#actual-duty-start-time"),l=e.querySelector("#actual-duty-end-time"),c=e.querySelector("#actual-duty-break-start-time"),d=e.querySelector("#actual-duty-break-end-time"),u=e.querySelector("#actual-duty-save-btn"),h=r.value,m=s.value||null,f=n.value||null,p=a.value||null,_=i.value||"conductor",y=Te((o==null?void 0:o.value)||"",""),b=Te((l==null?void 0:l.value)||"",""),g=Te((c==null?void 0:c.value)||"","00:00"),S=Te((d==null?void 0:d.value)||"","00:00"),k=t.value;if(!h||!m||!f||!p||!y||!b){v(",   .","warning");return}if(!Pf(p,f)){v("    -.","warning");return}if(!["chief","conductor"].includes(_)){v(" .     .","warning");return}const E=Ie(y,b);if(Ie(g,S)>E){v("     -    .","warning");return}const $=u.innerHTML;u.disabled=!0,u.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const q={date:h,employee_id:m,duty_id:p,assignment_role:_,start_time_override:Es(y),end_time_override:Es(b),break_start_time_override:Es(g),break_end_time_override:Es(S)};let T;if(k?{error:T}=await w.from("actual_duties").update(q).eq("id",k):{error:T}=await w.from("actual_duties").insert(q),u.disabled=!1,u.innerHTML=$,T){if(T.code==="23505"){v("      .","warning");return}v(T.message,"error");return}v(k?"  .":"  .","success"),Re(e.querySelector("#actual-duty-modal")),el(e),await cs(e)}function Hf(e,t){e.querySelector("#actual-duty-id").value=t.id,e.querySelector("#actual-duty-date").value=t.date??"",e.querySelector("#actual-duty-employee").value=t.employeeId??"",e.querySelector("#actual-duty-assignment-role").value=t.assignmentRole??"conductor",e.querySelector("#actual-duty-schedule-key").value=t.dutyScheduleKeyId??"",on(e,t.dutyScheduleKeyId??"",t.dutyId??""),e.querySelector("#actual-duty-start-time").value=Te(t.startTimeOverride,t.dutyStartTime||""),e.querySelector("#actual-duty-end-time").value=Te(t.endTimeOverride,t.dutyEndTime||""),e.querySelector("#actual-duty-break-start-time").value=Te(t.breakStartTimeOverride,t.dutyBreakStartTime||"00:00"),e.querySelector("#actual-duty-break-end-time").value=Te(t.breakEndTimeOverride,t.dutyBreakEndTime||"00:00"),e.querySelector("#actual-duty-form-title").textContent="  ",e.querySelector("#actual-duty-save-btn").textContent=""}function el(e){e.querySelector("#actual-duty-id").value="",e.querySelector("#actual-duty-date").value="",e.querySelector("#actual-duty-employee").value="",e.querySelector("#actual-duty-assignment-role").value="conductor",e.querySelector("#actual-duty-schedule-key").value="",on(e,"",""),e.querySelector("#actual-duty-start-time").value="",e.querySelector("#actual-duty-end-time").value="",e.querySelector("#actual-duty-break-start-time").value="00:00",e.querySelector("#actual-duty-break-end-time").value="00:00",e.querySelector("#actual-duty-form-title").textContent=" ",e.querySelector("#actual-duty-save-btn").textContent=""}async function Uf(e,t){const r=t.querySelector("#actual-duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await w.from("actual_duties").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,n){v(n.message,"error");return}M.selectedIds=M.selectedIds.filter(a=>a!==e),Re(t.querySelector("#actual-duty-delete-modal")),await cs(t),v("  .","success")}async function Ff(e){const t=e.querySelector("#actual-duty-bulk-delete-confirm"),r=[...M.selectedIds];if(!r.length){Re(e.querySelector("#actual-duty-bulk-delete-modal"));return}const s=t.innerHTML;t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let n=null;for(let i=0;i<r.length;i+=200){const o=r.slice(i,i+200),{error:l}=await w.from("actual_duties").delete().in("id",o);if(l){n=l;break}}if(t.disabled=!1,t.innerHTML=s,n){v(n.message,"error");return}const a=r.length;M.selectedIds=[],Re(e.querySelector("#actual-duty-bulk-delete-modal")),await cs(e),v(` : ${a}.`,"success")}async function Bf(e){const{data:t,error:r}=await w.from("planned_duties").select("id, date, employee_id, duty_id, assignment_role, employees(first_name, last_name), duties(name)").order("date",{ascending:!1});if(r){v(r.message,"error"),M.plannedRows=[],Dt(e,"     .");return}M.plannedRows=t||[],M.plannedSelectedIds=[],Dt(e)}function Dt(e,t){const r=e.querySelector("#actual-duty-bulk-add-table-body"),s=e.querySelector("#actual-duty-bulk-add-empty"),n=e.querySelector("#actual-duty-bulk-add-select-all"),a=e.querySelector("#actual-duty-bulk-add-confirm");M.plannedSelectedIds=M.plannedSelectedIds.filter(l=>M.plannedRows.some(c=>c.id===l));const i=M.plannedRows.filter(l=>{var f,p,_;const c=`${((f=l.employees)==null?void 0:f.first_name)??""} ${((p=l.employees)==null?void 0:p.last_name)??""}`.trim().toLowerCase(),d=(((_=l.duties)==null?void 0:_.name)||"").toLowerCase(),u=(l.date||"").toLowerCase(),h=!M.plannedSearchQuery||c.includes(M.plannedSearchQuery)||d.includes(M.plannedSearchQuery)||u.includes(M.plannedSearchQuery),m=!M.plannedDateFilter||l.date===M.plannedDateFilter;return h&&m});if(!i.length){M.plannedVisibleRowIds=[],r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"   .",n.checked=!1,n.indeterminate=!1,n.disabled=!0,a.disabled=M.plannedSelectedIds.length===0,a.textContent=M.plannedSelectedIds.length?`  (${M.plannedSelectedIds.length})`:" ";return}M.plannedVisibleRowIds=i.map(l=>l.id),s.classList.add("d-none"),r.innerHTML=i.map(l=>{var u,h,m;const c=M.plannedSelectedIds.includes(l.id),d=`${((u=l.employees)==null?void 0:u.first_name)??""} ${((h=l.employees)==null?void 0:h.last_name)??""}`.trim()||"-";return`
        <tr>
          <td>
            <input
              type="checkbox"
              class="form-check-input"
              data-planned-select-id="${l.id}"
              ${c?"checked":""}
              aria-label=" "
            />
          </td>
          <td>${ne(l.date??"-")}</td>
          <td>${ne(d)}</td>
          <td>${ne(tl(l.assignment_role))}</td>
          <td>${ne(((m=l.duties)==null?void 0:m.name)??"-")}</td>
        </tr>
      `}).join("");const o=i.filter(l=>M.plannedSelectedIds.includes(l.id)).length;n.disabled=!1,n.checked=o>0&&o===i.length,n.indeterminate=o>0&&o<i.length,a.disabled=M.plannedSelectedIds.length===0,a.textContent=M.plannedSelectedIds.length?`  (${M.plannedSelectedIds.length})`:" "}function Wi(e){M.plannedSearchQuery="",M.plannedDateFilter="";const t=e.querySelector("#actual-duty-bulk-add-search"),r=e.querySelector("#actual-duty-bulk-add-date-filter");t&&(t.value=""),r&&(r.value="")}async function Kf(e){const t=e.querySelector("#actual-duty-bulk-add-confirm"),r=[...M.plannedSelectedIds];if(!r.length){v("      .","warning");return}const s=new Set(r),n=M.plannedRows.filter(c=>s.has(c.id));if(!n.length){v("    .","warning");return}const a=n.map(c=>({date:c.date,employee_id:c.employee_id,duty_id:c.duty_id,assignment_role:c.assignment_role||"conductor"})),i=t.innerHTML;t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let o=null;for(let c=0;c<a.length;c+=200){const d=a.slice(c,c+200),{error:u}=await w.from("actual_duties").upsert(d,{onConflict:"date,employee_id,duty_id",ignoreDuplicates:!0});if(u){o=u;break}}if(t.disabled=!1,t.innerHTML=i,o){v(o.message,"error");return}const l=a.length;Re(e.querySelector("#actual-duty-bulk-add-modal")),await cs(e),v(` : ${l}.   .`,"success")}function qn(e,t){e&&(e.disabled=!t)}function Wf(){const t=new URLSearchParams(window.location.search).get("date")||"";return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:""}function tl(e){return e==="chief"?" ":""}function zf(e,t){var m,f,p,_,y,b,g;const r=e.querySelector("#actual-duty-profile-modal"),s=e.querySelector("#actual-duty-profile-content");if(!r||!s)return;const n=(M.rows||[]).find(S=>S.id===t);if(!n){s.innerHTML='<p class="text-secondary mb-0">    .</p>',It(r);return}const a=`${((m=n.employees)==null?void 0:m.first_name)??""} ${((f=n.employees)==null?void 0:f.last_name)??""}`.trim()||"-",i=((p=n.duties)==null?void 0:p.name)||"-",o=tl(n.assignment_role),l=Te(n.start_time_override,gt((_=n.duties)==null?void 0:_.start_time)),c=Te(n.end_time_override,gt((y=n.duties)==null?void 0:y.end_time)),d=Te(n.break_start_time_override,gt((b=n.duties)==null?void 0:b.break_start_time)||"00:00"),u=Te(n.break_end_time_override,gt((g=n.duties)==null?void 0:g.break_end_time)||"00:00"),h=Nf(l,c,d,u);s.innerHTML=`
    <div class="row g-3">
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(n.date||"-")}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(a)}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(o)}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(i)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(h.startTime)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(h.endTime)}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(h.breakDuration)}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">  </div>
          <div class="fw-semibold">${ne(h.breakStartTime)}</div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small">  </div>
          <div class="fw-semibold">${ne(h.breakEndTime)}</div>
        </div>
      </div>
      <div class="col-12">
        <div class="border rounded p-3 h-100">
          <div class="text-secondary small"></div>
          <div class="fw-semibold">${ne(h.duration)}</div>
        </div>
      </div>
    </div>
  `,It(r)}const Vf=" -  ";function rl(e,t){const r=e==null?void 0:e.querySelector(t);r&&(r.textContent=Vf)}const zi="id, name, notes, schedule_key_id, display_order, start_time, end_time, second_day, duty_types(name)";async function sl(e){const{data:t,error:r}=await w.from("schedule_keys").select("id").lte("valid_from",e).gte("valid_to",e);if(r)return{data:[],error:r};const s=(t||[]).map(h=>h==null?void 0:h.id).filter(Boolean);if(!s.length)return{data:[],error:null};const{data:n,error:a}=await w.from("duties").select(zi).in("schedule_key_id",s);if(a)return{data:[],error:a};const{data:i,error:o}=await w.from("schedule_key_duties").select("duty_id").in("schedule_key_id",s);if(o)return{data:[],error:o};const l=new Set((n||[]).map(h=>h==null?void 0:h.id).filter(Boolean)),c=[...new Set((i||[]).map(h=>h==null?void 0:h.duty_id).filter(Boolean))].filter(h=>!l.has(h));if(!c.length)return{data:n||[],error:null};const{data:d,error:u}=await w.from("duties").select(zi).in("id",c);return u?{data:[],error:u}:{data:[...n||[],...d||[]],error:null}}function Gf(e){const t=String(e||"").trim().toLowerCase();return t==="chief"||t==="conductor"?t:""}function nl(e){const t=(e==null?void 0:e.first_name)??"",r=(e==null?void 0:e.last_name)??"";return`${t} ${r}`.trim()}function Jf(e){var r;const t=e==null?void 0:e.positions;return Array.isArray(t)?((r=t[0])==null?void 0:r.title)??"":t&&typeof t=="object"?t.title??"":""}function Qf(e){var r;const t=e==null?void 0:e.duty_types;return Array.isArray(t)?((r=t[0])==null?void 0:r.name)??"":t&&typeof t=="object"?t.name??"":""}function Yf(e){var r;const t=Array.isArray(e)?(r=e[0])==null?void 0:r.name:e&&typeof e=="object"?e.name:"";return String(t||"").trim()}function Xf(e){const t=e==null?void 0:e.duties;return Array.isArray(t)?t[0]||null:t&&typeof t=="object"?t:null}function Vi(e){const t=String(e||"").trim();if(!t)return"99:99:99";const r=t.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);if(!r)return"99:99:99";const s=String(Number(r[1])).padStart(2,"0"),n=r[2],a=r[3]||"00";return`${s}:${n}:${a}`}function Zf(){const t=new URLSearchParams(window.location.search).get("date")||"";return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:""}function Ae(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const Gi=96/25.4;function em(e,{orientation:t,compact:r,fitOnePage:s}){const n=document.documentElement,a=e.querySelector(".plan-schedule-sheet");if(n.classList.add("print-preparing"),n.classList.toggle("print-compact",r),n.classList.toggle("print-fit-one-page",s),a&&(a.classList.toggle("print-landscape-page",t==="landscape"),a.classList.toggle("print-portrait-page",t==="portrait")),!s||!a){n.style.setProperty("--plan-print-scale","1");return}n.style.setProperty("--plan-print-scale","1");const i=a.getBoundingClientRect(),o=t==="portrait"?210:297,l=t==="portrait"?297:210,c=(o-20)*Gi,d=(l-20)*Gi,u=c/Math.max(i.width,1),h=d/Math.max(i.height,1),m=Math.min(u,h,1);n.style.setProperty("--plan-print-scale",String(Math.max(.6,m)))}function tm(){const e=document.documentElement;e.classList.remove("print-preparing","print-compact","print-fit-one-page","print-hide-second-day"),e.style.setProperty("--plan-print-scale","1"),document.querySelectorAll(".plan-schedule-sheet").forEach(t=>{t.classList.remove("print-landscape-page","print-portrait-page")})}function rm(e){const t=new Map;return(e||[]).forEach(r=>{const s=r==null?void 0:r.employee_id;if(!s)return;const n=t.get(s)||{employeeId:s,employeeName:nl(r.employees),reasons:[]},a=Yf(r.absence_reasons);a&&!n.reasons.includes(a)&&n.reasons.push(a),t.set(s,n)}),t}function sm(e){const t={train:[],businessTrip:[],dayOff:[]},r=new Map;return(e||[]).forEach(s=>{const n=Xf(s);n!=null&&n.id&&(r.has(n.id)||r.set(n.id,n))}),Array.from(r.values()).forEach(s=>{const n=Qf(s).toLowerCase();if(n.includes(" ")){t.train.push(s);return}if(n.includes("")){t.businessTrip.push(s);return}n.includes(" ")&&t.dayOff.push(s)}),t.train.sort(lm),t.businessTrip.sort(Qn),t.dayOff.sort(Qn),t}function nm(e,t){const r=new Map,s=new Map;return e.forEach(n=>{if(!(n!=null&&n.duty_id)||!(n!=null&&n.employees))return;if(n!=null&&n.employee_id&&(t!=null&&t.has(n.employee_id))){const l=t.get(n.employee_id);l&&!s.has(n.employee_id)&&s.set(n.employee_id,{employeeId:l.employeeId,employeeName:l.employeeName,reason:l.reasons.join(", ")});return}const a=r.get(n.duty_id)||{chiefs:[],conductors:[]},i=nl(n.employees),o=Gf(n.assignment_role);if(o==="chief"&&i&&!a.chiefs.includes(i)&&a.chiefs.push(i),o==="conductor"&&i&&!a.conductors.includes(i)&&a.conductors.push(i),!o){const l=Jf(n.employees).toLowerCase();l.includes("")&&l.includes("")&&i&&!a.chiefs.includes(i)&&a.chiefs.push(i),l.includes("")&&i&&!a.conductors.includes(i)&&a.conductors.push(i)}r.set(n.duty_id,a)}),{assignmentsByDuty:r,absentAssignments:Array.from(s.values()).sort((n,a)=>String((n==null?void 0:n.employeeName)||"").localeCompare(String((a==null?void 0:a.employeeName)||""),"bg"))}}function qr(e,t,r){Tn(e.querySelector("#plan-schedule-train"),t.train,r,{conductorRows:2,showHours:!0,separateSecondDay:!0,minPanels:2,printAsCards:!0}),Tn(e.querySelector("#plan-schedule-business-trip"),t.businessTrip,r,{conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0,printAsCards:!0}),Tn(e.querySelector("#plan-schedule-day-off"),t.dayOff,r,{conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0,printAsCards:!0})}function Tr(e,t){if(!e)return;if(!t.length){e.innerHTML='<p class="text-secondary mb-0">   .</p>';return}const r=t.map(s=>`
      <tr>
        <td>${Ae(s.employeeName||"")}</td>
        <td>${Ae(s.reason||"")}</td>
      </tr>
    `).join("");e.innerHTML=`
    <table class="table table-bordered align-middle mb-0 plan-schedule-table">
      <thead>
        <tr>
          <th scope="col"></th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        ${r}
      </tbody>
    </table>
  `}function Er(e,{hint:t,error:r,empty:s}){const n=e.querySelector("#plan-schedule-hint"),a=e.querySelector("#plan-schedule-error"),i=e.querySelector("#plan-schedule-empty");n&&(n.textContent=t||"",n.classList.toggle("d-none",!t)),a&&(a.textContent=r||"",a.classList.toggle("d-none",!r)),i&&(i.textContent=s||"",i.classList.toggle("d-none",!s))}function am(e){const t=new Date(`${e}T00:00:00`);return Number.isNaN(t.getTime())?e:new Intl.DateTimeFormat("bg-BG",{day:"2-digit",month:"long",year:"numeric"}).format(t)}function Tn(e,t,r,s={}){if(!e)return;if(!t.length){e.innerHTML='<p class="text-secondary mb-0">    .</p>';return}const n=s.separateSecondDay?cm(t):t,a=Number.isInteger(s.conductorRows)&&s.conductorRows>=0?s.conductorRows:3,i=5,o=om(n,i),l=Number.isInteger(s.minPanels)&&s.minPanels>0?s.minPanels:1;for(;o.length<l;)o.push([]);e.innerHTML=o.map(c=>{const d=[...c];for(;d.length<i;)d.push(null);const u=d.map(g=>{const S=As(g,"text-center"),k=dt(g)?"":(g==null?void 0:g.name)??"";if(!k)return`<th scope="col"${S}></th>`;const E=String((g==null?void 0:g.notes)||"").trim(),L=E?`<div class="schedule-duty-note" title="${Ae(E)}">${Ae(E)}</div>`:"";return`<th scope="col"${S}><span class="schedule-duty-name-wrap">${$s("","train")}<span class="schedule-duty-name-ellipsis" title="${Ae(k)}">${Ae(k)}</span></span>${L}</th>`}).join(""),h=d.map(g=>{const S=As(g),k=g&&!dt(g)?al(g):"";return!g||dt(g)?`<td${S}></td>`:`<td${S}>${$s("","hours")}${Ae(k)}</td>`}).join(""),m=d.map(g=>{if(!g)return"<td></td>";const S=As(g);if(dt(g))return`<td${S}></td>`;const k=r.get(g.id)||{chiefs:[]},E=k.chiefs.length?k.chiefs.join(", "):"";return`<td${S}>${$s("","chief")}${Ae(E)}</td>`}).join("");let f=a;if(s.hideEmptyConductorRows){const g=d.reduce((S,k)=>{if(!k||dt(k))return S;const E=r.get(k.id)||{conductors:[]},L=Array.isArray(E.conductors)?E.conductors.length:0;return Math.max(S,L)},0);f=Math.min(a,g)}const p=f>0?Array.from({length:f},(g,S)=>`
            <tr>
              ${d.map(E=>{if(!E)return"<td></td>";const L=As(E);if(dt(E))return`<td${L}></td>`;const q=(r.get(E.id)||{conductors:[]}).conductors[S]||"";return`<td${L}>${$s("-","conductor")}${Ae(q)}</td>`}).join("")}
            </tr>
          `).join(""):"",_=s.showHours===!1?"":`
            <tr>
              ${h}
            </tr>
          `,y=`
        <table class="table table-bordered align-middle mb-3 plan-schedule-table">
          <thead>
            <tr>
              ${u}
            </tr>
          </thead>
          <tbody>
            ${_}
            <tr>
              ${m}
            </tr>
            ${p}
          </tbody>
        </table>
      `;if(!s.printAsCards)return y;const b=im(d,r,f,s);return`
        <div class="print-as-cards">
          ${y}
          <div class="print-only-duty-cards mb-3">${b}</div>
        </div>
      `}).join("")}function im(e,t,r,s={}){return`<div class="print-duty-cards-grid">${e.map(a=>{const i=s.showHours!==!1,o=i?`
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
          `:"";if(!a||dt(a)){const u=Array.from({length:r},()=>`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value"></span>
          </div>
        `).join("");return`
          <article class="print-duty-card">
            <div class="print-duty-card-title"></div>
            <div class="print-duty-card-note"></div>
            ${o}
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
            ${u}
          </article>
        `}const l=t.get(a.id)||{chiefs:[],conductors:[]},c=Array.isArray(l.chiefs)?l.chiefs.join(", "):"",d=Array.from({length:r},(u,h)=>{const m=Array.isArray(l.conductors)&&l.conductors[h]||"";return`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value">${Ae(m)}</span>
          </div>
        `}).join("");return`
        <article class="print-duty-card">
          <div class="print-duty-card-title">${Ae(a.name||"")}</div>
          <div class="print-duty-card-note">${Ae(String(a.notes||"").trim())}</div>
          ${i?`
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value">${Ae(al(a))}</span>
            </div>
          `:""}
          <div class="print-duty-card-line">
            <span class="print-duty-card-key"></span>
            <span class="print-duty-card-value">${Ae(c)}</span>
          </div>
          ${d}
        </article>
      `}).join("")}</div>`}function om(e,t){const r=[];for(let s=0;s<e.length;s+=t)r.push(e.slice(s,s+t));return r}function al(e){const t=((e==null?void 0:e.start_time)||"").slice(0,5),r=((e==null?void 0:e.end_time)||"").slice(0,5);return!t&&!r?"":t&&r?`${t} - ${r}`:t||r}function $s(e,t){return`<span class="${t?`schedule-cell-key-badge schedule-cell-key-badge-${t}`:"schedule-cell-key-badge"}">${Ae(e)}</span>`}function Qn(e,t){const r=(e==null?void 0:e.schedule_key_id)||"",s=(t==null?void 0:t.schedule_key_id)||"";if(r!==s)return String(r).localeCompare(String(s),"bg");const n=Number.isFinite(Number(e==null?void 0:e.display_order))?Number(e.display_order):Number.MAX_SAFE_INTEGER,a=Number.isFinite(Number(t==null?void 0:t.display_order))?Number(t.display_order):Number.MAX_SAFE_INTEGER;return n!==a?n-a:String((e==null?void 0:e.name)||"").localeCompare(String((t==null?void 0:t.name)||""),"bg")}function lm(e,t){const r=!!(e!=null&&e.second_day),s=!!(t!=null&&t.second_day);if(r!==s)return r?1:-1;const n=Vi(e==null?void 0:e.start_time),a=Vi(t==null?void 0:t.start_time);return n!==a?n.localeCompare(a,"bg"):Qn(e,t)}function cm(e){const t=[],r=[];return e.forEach(a=>{if(a!=null&&a.second_day){r.push(a);return}t.push(a)}),!t.length||!r.length?e:t.length%5!==0?[...t,{__separator:!0},...r]:[...t,...r]}function dt(e){return!!(e&&e.__separator)}function As(e,t=""){const r=[];return t&&r.push(t),dt(e)?r.push("separator-col"):e!=null&&e.second_day&&r.push("second-day-col"),r.length?` class="${r.join(" ")}"`:""}async function dm(e){const t=await ue("../plan-schedule.html",import.meta.url);e.innerHTML=t,rl(e,"#plan-schedule-print-left-label");const r=e.querySelector("#plan-schedule-date"),s=e.querySelector("#plan-schedule-print"),n=e.querySelector("#plan-schedule-print-orientation"),a=e.querySelector("#plan-schedule-print-compact"),i=e.querySelector("#plan-schedule-print-fit-one-page"),o=Zf();r&&o?r.value=o:r&&!r.value&&(r.value=new Date().toISOString().split("T")[0]),r==null||r.addEventListener("change",async()=>{await Ji(e)}),s==null||s.addEventListener("click",()=>{const l=(n==null?void 0:n.value)==="portrait"?"portrait":"landscape",c=(a==null?void 0:a.checked)??!0,d=(i==null?void 0:i.checked)??!0;em(e,{orientation:l,compact:c,fitOnePage:d}),window.addEventListener("afterprint",tm,{once:!0}),window.print()}),await Ji(e)}async function Ji(e){const t=e.querySelector("#plan-schedule-date"),r=t==null?void 0:t.value,s=e.querySelector("#plan-schedule-sheet-date");if(s&&(s.textContent=r?am(r):""),!r){qr(e,{train:[],businessTrip:[],dayOff:[]},new Map),Tr(e.querySelector("#plan-schedule-absence"),[]),Er(e,{hint:" .",error:"",empty:""});return}const{data:n,error:a}=await w.from("planned_duties").select("employee_id, duty_id, assignment_role, employees(first_name, last_name, positions(title)), duties(id, name, schedule_key_id, display_order, start_time, end_time, second_day, duty_types(name))").eq("date",r);if(a){v(a.message,"error"),qr(e,{train:[],businessTrip:[],dayOff:[]},new Map),Tr(e.querySelector("#plan-schedule-absence"),[]),Er(e,{hint:"",error:"     .",empty:""});return}const{data:i,error:o}=await sl(r);if(o){v(o.message,"error"),qr(e,{train:[],businessTrip:[],dayOff:[]},new Map),Tr(e.querySelector("#plan-schedule-absence"),[]),Er(e,{hint:"",error:"    .",empty:""});return}const{data:l,error:c}=await w.from("employee_absences").select("employee_id, start_date, end_date, employees(first_name, last_name), absence_reasons(name)").lte("start_date",r).gte("end_date",r);if(c){v(c.message,"error"),qr(e,{train:[],businessTrip:[],dayOff:[]},new Map),Tr(e.querySelector("#plan-schedule-absence"),[]),Er(e,{hint:"",error:"    .",empty:""});return}const d=rm(l||[]),u=sm((i||[]).map(p=>({duties:p}))),{assignmentsByDuty:h,absentAssignments:m}=nm(n||[],d);qr(e,u,h),Tr(e.querySelector("#plan-schedule-absence"),m);const f=u.train.length+u.businessTrip.length+u.dayOff.length;Er(e,{hint:"",error:"",empty:f||m.length?"":"      ."})}const Qi=new Map;function Yi(e){const t=String(e||"").trim();if(!t)return"99:99:99";const r=t.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);if(!r)return"99:99:99";const s=String(Number(r[1])).padStart(2,"0"),n=r[2],a=r[3]||"00";return`${s}:${n}:${a}`}function um(e){const t=(e==null?void 0:e.first_name)??"",r=(e==null?void 0:e.last_name)??"";return`${t} ${r}`.trim()}function hm(e){var r;const t=e==null?void 0:e.positions;return Array.isArray(t)?((r=t[0])==null?void 0:r.title)??"":t&&typeof t=="object"?t.title??"":""}function Yn(e){const t=String((e==null?void 0:e.assignment_role)||"").trim().toLowerCase();if(t==="chief"||t==="conductor")return t;const r=hm(e==null?void 0:e.employees).toLowerCase();return r.includes("")&&r.includes("")?"chief":"conductor"}function Mt(e){var r;const t=e==null?void 0:e.duty_types;return Array.isArray(t)?((r=t[0])==null?void 0:r.name)??"":t&&typeof t=="object"?t.name??"":""}function Ws(e){const t=e==null?void 0:e.duties;return Array.isArray(t)?t[0]||null:t&&typeof t=="object"?t:null}function fm(){const t=new URLSearchParams(window.location.search).get("date")||"";return/^\d{4}-\d{2}-\d{2}$/.test(t)?t:""}function _e(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function mm(e){e==null||e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}function Ps(e){e==null||e.classList.add("d-none"),!!document.querySelector("#schedule-actual-edit-modal:not(.d-none)")||document.body.classList.remove("overflow-hidden")}function pm(e,t){const r=Qi.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Ps(a);return}}};Qi.set(e,s),document.addEventListener("keydown",s)}const Xi=96/25.4;function ym(e,{orientation:t,compact:r,fitOnePage:s}){const n=document.documentElement,a=e.querySelector(".plan-schedule-sheet");if(n.classList.add("print-preparing"),n.classList.add("print-hide-second-day"),n.classList.toggle("print-compact",r),n.classList.toggle("print-fit-one-page",s),a&&(a.classList.toggle("print-landscape-page",t==="landscape"),a.classList.toggle("print-portrait-page",t==="portrait")),!s||!a){n.style.setProperty("--plan-print-scale","1");return}n.style.setProperty("--plan-print-scale","1");const i=a.getBoundingClientRect(),o=t==="portrait"?210:297,l=t==="portrait"?297:210,c=(o-20)*Xi,d=(l-20)*Xi,u=c/Math.max(i.width,1),h=d/Math.max(i.height,1),m=Math.min(u,h,1);n.style.setProperty("--plan-print-scale",String(Math.max(.6,m)))}function gm(){const e=document.documentElement;e.classList.remove("print-preparing","print-compact","print-fit-one-page","print-hide-second-day"),e.style.setProperty("--plan-print-scale","1"),document.querySelectorAll(".plan-schedule-sheet").forEach(t=>{t.classList.remove("print-landscape-page","print-portrait-page")})}function vm(e,t){const r=new Map;return e.forEach(s=>{var l;if(!(s!=null&&s.duty_id)||!(s!=null&&s.employees)||!(s!=null&&s.id)||s!=null&&s.employee_id&&(t!=null&&t.has(s.employee_id)))return;const n=r.get(s.duty_id)||{chiefs:[],conductors:[]},a=um(s.employees),i=Yn(s),o={id:s.id,employeeId:s.employee_id,role:i,name:a,dutyName:((l=Ws(s))==null?void 0:l.name)||"",date:s.date||""};i==="chief"?a&&!n.chiefs.some(c=>c.id===o.id)&&n.chiefs.push(o):i==="conductor"&&a&&!n.conductors.some(c=>c.id===o.id)&&n.conductors.push(o),r.set(s.duty_id,n)}),r}function $r(e,t,r,s){En(e.querySelector("#schedule-train"),t.train,r,s,{allowAdd:!0,allowEdit:!0,conductorRows:2,printConductorRows:3,printExtraCardRows:1,showHours:!0,separateSecondDay:!0,minPanels:2,printAsCards:!0,printHideSecondDay:!0}),En(e.querySelector("#schedule-business-trip"),t.businessTrip,r,s,{allowAdd:!0,allowEdit:!0,conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0}),En(e.querySelector("#schedule-day-off"),t.dayOff,r,s,{allowAdd:!0,allowEdit:!0,conductorRows:3,showHours:!1,minPanels:1,hideEmptyConductorRows:!0})}function Ar(e,{hint:t,error:r,empty:s}){const n=e.querySelector("#schedule-hint"),a=e.querySelector("#schedule-error"),i=e.querySelector("#schedule-empty");n&&(n.textContent=t||"",n.classList.toggle("d-none",!t)),a&&(a.textContent=r||"",a.classList.toggle("d-none",!r)),i&&(i.textContent=s||"",i.classList.toggle("d-none",!s))}function bm(e){const t=new Date(`${e}T00:00:00`);return Number.isNaN(t.getTime())?e:new Intl.DateTimeFormat("bg-BG",{day:"2-digit",month:"long",year:"numeric"}).format(t)}function Xn(e,t){const r=(e==null?void 0:e.schedule_key_id)||"",s=(t==null?void 0:t.schedule_key_id)||"";if(r!==s)return String(r).localeCompare(String(s),"bg");const n=Number.isFinite(Number(e==null?void 0:e.display_order))?Number(e.display_order):Number.MAX_SAFE_INTEGER,a=Number.isFinite(Number(t==null?void 0:t.display_order))?Number(t.display_order):Number.MAX_SAFE_INTEGER;return n!==a?n-a:String((e==null?void 0:e.name)||"").localeCompare(String((t==null?void 0:t.name)||""),"bg")}function _m(e,t){const r=!!(e!=null&&e.second_day),s=!!(t!=null&&t.second_day);if(r!==s)return r?1:-1;const n=Yi(e==null?void 0:e.start_time),a=Yi(t==null?void 0:t.start_time);return n!==a?n.localeCompare(a,"bg"):Xn(e,t)}function En(e,t,r,s,n={}){if(!e)return;if(!t.length){e.innerHTML='<p class="text-secondary mb-0">    .</p>';return}const a=n.separateSecondDay?wm(t):t,i=Number.isInteger(n.conductorRows)&&n.conductorRows>=0?n.conductorRows:3,o=5,l=km(a,o),c=Number.isInteger(n.minPanels)&&n.minPanels>0?n.minPanels:1,d=Number.isInteger(n.printConductorRows)&&n.printConductorRows>0?n.printConductorRows:i;for(;l.length<c;)l.push([]);const u=l.map(f=>{const p=[...f];for(;p.length<o;)p.push(null);const _=p.map($=>{const q=Cs($,"text-center"),T=ut($)?"":($==null?void 0:$.name)??"";if(!T)return`<th scope="col"${q}></th>`;const C=String(($==null?void 0:$.notes)||"").trim(),A=C?`<div class="schedule-duty-note" title="${_e(C)}">${_e(C)}</div>`:"";return`<th scope="col"${q}><span class="schedule-duty-name-wrap">${xs("","train")}<span class="schedule-duty-name-ellipsis" title="${_e(T)}">${_e(T)}</span></span>${A}</th>`}).join(""),y=p.map($=>{const q=Cs($),T=$&&!ut($)?ll($):"";return!$||ut($)?`<td${q}></td>`:`<td${q}>${xs("","hours")}${_e(T)}</td>`}).join(""),b=p.map($=>{if(!$)return"<td></td>";const q=Cs($);if(ut($))return`<td${q}></td>`;const T=r.get($.id)||{chiefs:[]},C=Mt($).toLowerCase();return`<td${q} data-drop-duty-id="${$.id}" data-drop-duty-name="${_e(($==null?void 0:$.name)||"")}" data-drop-date="${s}" data-drop-role="chief" data-drop-duty-type="${_e(C)}">${xs("","chief")}${Sm(T.chiefs,$,s,n)}</td>`}).join("");let g=i;if(n.hideEmptyConductorRows){const $=p.reduce((q,T)=>{if(!T||ut(T))return q;const C=r.get(T.id)||{conductors:[]},A=Array.isArray(C.conductors)?C.conductors.length:0;return Math.max(q,A)},0);g=Math.min(i,$)}const S=g>0?Array.from({length:g},($,q)=>`
          <tr>
            ${p.map(C=>{if(!C)return"<td></td>";const A=Cs(C);if(ut(C))return`<td${A}></td>`;const x=r.get(C.id)||{conductors:[]},D=Number.isInteger(n.conductorRowOffset)&&n.conductorRowOffset>0?n.conductorRowOffset:0,P=q-D,U=P>=0&&Array.isArray(x.conductors)?x.conductors[P]:void 0,W=Mt(C).toLowerCase();return`<td${A} data-drop-duty-id="${C.id}" data-drop-duty-name="${_e((C==null?void 0:C.name)||"")}" data-drop-date="${s}" data-drop-role="conductor" data-drop-duty-type="${_e(W)}">${xs("-","conductor")}${il(U,C,s,n)}</td>`}).join("")}
          </tr>
        `).join(""):"",k=n.showHours===!1?"":`
            <tr>
              ${y}
            </tr>
          `,E=`
        <table class="table table-bordered align-middle mb-3 plan-schedule-table">
          <thead>
            <tr>
              ${_}
            </tr>
          </thead>
          <tbody>
            ${k}
            <tr>
              ${b}
            </tr>
            ${S}
          </tbody>
        </table>
      `;if(!n.printAsCards)return E;const L=Zi(p,r,d,n);return`
        <div class="print-as-cards">
          ${E}
          <div class="print-only-duty-cards mb-3">${L}</div>
        </div>
      `}).join(""),h=Number.isInteger(n.printExtraCardRows)&&n.printExtraCardRows>0?n.printExtraCardRows:0,m=n.printAsCards&&h>0?Array.from({length:h},()=>`
        <div class="print-as-cards">
          <div class="print-only-duty-cards mb-3">${Zi(Array.from({length:o},()=>null),new Map,d,n)}</div>
        </div>
      `).join(""):"";e.innerHTML=u+m}function Zi(e,t,r,s={}){return`<div class="print-duty-cards-grid">${e.map(a=>{const i=s.printHideSecondDay&&(a!=null&&a.second_day)?null:a;if(!i||ut(i))return`
          <article class="print-duty-card">
            <div class="print-duty-card-title"></div>
            <div class="print-duty-card-note"></div>
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
            <div class="print-duty-card-line">
              <span class="print-duty-card-key"></span>
              <span class="print-duty-card-value"></span>
            </div>
            ${Array.from({length:r},()=>`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value"></span>
          </div>
        `).join("")}
          </article>
        `;const o=t.get(i.id)||{chiefs:[],conductors:[]},l=Array.isArray(o.chiefs)?o.chiefs.map(d=>(d==null?void 0:d.name)||"").filter(Boolean).join(", "):"",c=Array.from({length:r},(d,u)=>{var p;const h=Number.isInteger(s.conductorRowOffset)&&s.conductorRowOffset>0?s.conductorRowOffset:0,m=u-h,f=Array.isArray(o.conductors)&&m>=0&&((p=o.conductors[m])==null?void 0:p.name)||"";return`
          <div class="print-duty-card-line">
            <span class="print-duty-card-key">-</span>
            <span class="print-duty-card-value">${_e(f)}</span>
          </div>
        `}).join("");return`
        <article class="print-duty-card">
          <div class="print-duty-card-title">${_e(i.name||"")}</div>
          <div class="print-duty-card-note">${_e(String(i.notes||"").trim())}</div>
          <div class="print-duty-card-line">
            <span class="print-duty-card-key"></span>
            <span class="print-duty-card-value">${_e(ll(i))}</span>
          </div>
          <div class="print-duty-card-line">
            <span class="print-duty-card-key"></span>
            <span class="print-duty-card-value">${_e(l)}</span>
          </div>
          ${c}
        </article>
      `}).join("")}</div>`}function Sm(e,t,r,s={}){return e!=null&&e.length?e.map(n=>il(n,t,r,s)).join("<br>"):ol(t,r,s)}function il(e,t,r,s={}){return e!=null&&e.id?s.allowEdit!==!1?`<button type="button" class="btn btn-link p-0 text-decoration-none align-baseline" draggable="true" data-actual-edit-id="${e.id}" data-actual-drag-id="${e.id}">${_e(e.name||"")}</button>`:_e(e.name||""):ol(t,r,s)}function ol(e,t,r={}){return!(r.allowAdd!==!1)||!(e!=null&&e.id)||!t?"":`<button type="button" class="btn btn-link p-0 text-decoration-none no-print" data-actual-add-duty-id="${e.id}" data-actual-add-date="${t}" data-actual-add-duty-name="${_e(e.name||"")}"></button>`}function xs(e,t){return`<span class="${t?`schedule-cell-key-badge schedule-cell-key-badge-${t}`:"schedule-cell-key-badge"}">${_e(e)}</span>`}function ll(e){const t=((e==null?void 0:e.start_time)||"").slice(0,5),r=((e==null?void 0:e.end_time)||"").slice(0,5);return!t&&!r?"":t&&r?`${t} - ${r}`:t||r}function wm(e){const t=[],r=[];return e.forEach(a=>{if(a!=null&&a.second_day){r.push(a);return}t.push(a)}),!t.length||!r.length?e:t.length%5!==0?[...t,{__separator:!0},...r]:[...t,...r]}function ut(e){return!!(e&&e.__separator)}function Cs(e,t=""){const r=[];return t&&r.push(t),ut(e)?r.push("separator-col"):e!=null&&e.second_day&&r.push("second-day-col"),r.length?` class="${r.join(" ")}"`:""}function km(e,t){const r=[];for(let s=0;s<e.length;s+=t)r.push(e.slice(s,s+t));return r}function Lm({actualRowsById:e,supabase:t,showToast:r,getDutyFromRow:s,resolveActualDutyRole:n,openModal:a,closeModal:i,loadScheduleData:o,removeEmployeeTripAndDayOffEntries:l}){function c(y){return y==="chief"?" ":""}function d(y){var S,k;const b=((S=y==null?void 0:y.employees)==null?void 0:S.first_name)??"",g=((k=y==null?void 0:y.employees)==null?void 0:k.last_name)??"";return`${b} ${g}`.trim()||"-"}function u(y,b){const g=y.querySelector("#schedule-actual-edit-employee");if(!g||!b)return"-";const S=Array.from(g.options||[]).find(k=>(k==null?void 0:k.value)===b);return String((S==null?void 0:S.textContent)||"").trim()||"-"}function h({employeeName:y,dutyName:b,date:g,role:S}){return`${y||"-"} | ${b||"-"} | ${g||"-"} | ${c(S)}`}function m(y){if(!Array.isArray(y)||!y.length)return"";const b=y.map(g=>String((g==null?void 0:g.dutyName)||(g==null?void 0:g.dutyTypeName)||"").trim()).filter(Boolean);return b.length?` : ${b.join(", ")}.`:"     ."}function f(y,b){const g=e.get(b);if(!g){r("   .","warning");return}const S=s(g);y.querySelector("#schedule-actual-edit-title").textContent="   ",y.querySelector("#schedule-actual-edit-id").value=g.id,y.querySelector("#schedule-actual-edit-duty-id").value=g.duty_id||(S==null?void 0:S.id)||"",y.querySelector("#schedule-actual-edit-date-value").value=g.date||"",y.querySelector("#schedule-actual-edit-date").value=g.date||"",y.querySelector("#schedule-actual-edit-duty").value=(S==null?void 0:S.name)||"",y.querySelector("#schedule-actual-edit-employee").value=g.employee_id||"",y.querySelector("#schedule-actual-edit-assignment-role").value=n(g),y.querySelector("#schedule-actual-edit-save").textContent="",a(y.querySelector("#schedule-actual-edit-modal"))}function p(y,{dutyId:b,date:g,dutyName:S}){y.querySelector("#schedule-actual-edit-title").textContent="  ",y.querySelector("#schedule-actual-edit-id").value="",y.querySelector("#schedule-actual-edit-duty-id").value=b,y.querySelector("#schedule-actual-edit-date-value").value=g,y.querySelector("#schedule-actual-edit-date").value=g,y.querySelector("#schedule-actual-edit-duty").value=S||"",y.querySelector("#schedule-actual-edit-employee").value="",y.querySelector("#schedule-actual-edit-assignment-role").value="conductor",y.querySelector("#schedule-actual-edit-save").textContent="",a(y.querySelector("#schedule-actual-edit-modal"))}async function _(y){var O;const b=y.querySelector("#schedule-actual-edit-id"),g=y.querySelector("#schedule-actual-edit-duty-id"),S=y.querySelector("#schedule-actual-edit-date-value"),k=y.querySelector("#schedule-actual-edit-employee"),E=y.querySelector("#schedule-actual-edit-assignment-role"),L=y.querySelector("#schedule-actual-edit-save"),$=(b==null?void 0:b.value)||"",q=(g==null?void 0:g.value)||"",T=(S==null?void 0:S.value)||"",C=(k==null?void 0:k.value)||"",A=(E==null?void 0:E.value)||"conductor";if(!C){r(" .","warning");return}if(!$&&(!q||!T)){r("      .","warning");return}if(!["chief","conductor"].includes(A)){r(" .     .","warning");return}const x=L.innerHTML;L.disabled=!0,L.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let D,P=$;const U=$?e.get($):null,W=s(U),z=U?{employeeName:d(U),dutyName:(W==null?void 0:W.name)||"",date:(U==null?void 0:U.date)||T,role:n(U)}:null;if($)({error:D}=await t.from("actual_duties").update({employee_id:C,assignment_role:A}).eq("id",$));else{const{data:N,error:B}=await t.from("actual_duties").insert({date:T,duty_id:q,employee_id:C,assignment_role:A}).select("id").single();D=B,P=(N==null?void 0:N.id)||""}if(L.disabled=!1,L.innerHTML=x,D){if(D.code==="23505"){r("       .","warning");return}r(D.message,"error");return}const H=await l(C,T,q,P);if(H!=null&&H.error){r(H.error.message,"error");return}const K=(W==null?void 0:W.name)||((O=y.querySelector("#schedule-actual-edit-duty"))==null?void 0:O.value)||"",ee={employeeName:u(y,C),dutyName:K,date:T,role:A},R=m((H==null?void 0:H.removedEntries)||[]);if(i(y.querySelector("#schedule-actual-edit-modal")),$&&z){const N=h(z),B=h(ee);r(`: ${N}  ${B}.${R}`,"success")}else{const N=h(ee);r(` : ${N}.${R}`,"success")}await o(y)}return{openEditActualDutyModal:f,openCreateActualDutyModal:p,saveEditedActualDuty:_}}let Xe=null;function qm({actualRowsById:e,supabase:t,showToast:r,resolveActualDutyRole:s,getDutyFromRow:n,getDutyTypeName:a,loadScheduleData:i,removeEmployeeTripAndDayOffEntries:o}){function l(y){return y==="chief"?" ":""}function c(y){var S,k;const b=((S=y==null?void 0:y.employees)==null?void 0:S.first_name)??"",g=((k=y==null?void 0:y.employees)==null?void 0:k.last_name)??"";return`${b} ${g}`.trim()||"-"}function d({employeeName:y,dutyName:b,date:g,role:S}){return`${y||"-"} | ${b||"-"} | ${g||"-"} | ${l(S)}`}function u(y){if(!Array.isArray(y)||!y.length)return"";const b=y.map(g=>String((g==null?void 0:g.dutyName)||(g==null?void 0:g.dutyTypeName)||"").trim()).filter(Boolean);return b.length?` : ${b.join(", ")}.`:"     ."}function h(y){const b=String(y||"").toLowerCase();return b.includes(" ")?"train":b.includes("")?"business-trip":b.includes(" ")?"day-off":""}function m(y){y.querySelectorAll(".schedule-drop-target, .schedule-drop-target-business-trip, .schedule-drop-target-preferred, .schedule-drop-target-hover").forEach(b=>{b.classList.remove("schedule-drop-target","schedule-drop-target-business-trip","schedule-drop-target-preferred","schedule-drop-target-hover")}),Xe=null}function f(y,b){if(m(y),!b)return;const g=e.get(b),S=n(g),k=h(a(S));y.querySelectorAll("td[data-drop-duty-id]").forEach(E=>{const L=h(E.getAttribute("data-drop-duty-type")||"");E.classList.add("schedule-drop-target"),L==="business-trip"&&E.classList.add("schedule-drop-target-business-trip"),k&&L===k&&E.classList.add("schedule-drop-target-preferred")})}function p(y){const b=y.target.closest("td[data-drop-duty-id]");if(!b){Xe&&(Xe.classList.remove("schedule-drop-target-hover"),Xe=null);return}y.preventDefault(),Xe&&Xe!==b&&Xe.classList.remove("schedule-drop-target-hover"),Xe=b,Xe.classList.add("schedule-drop-target-hover"),y.dataTransfer&&(y.dataTransfer.dropEffect="move")}async function _(y,b,g,S,k,E=""){var K;const L=e.get(b);if(!L)return;const $=L.duty_id===g,q=L.date===S,T=k==="chief"||k==="conductor"?k:"",C=s(L);if($&&q&&(!T||C===T))return;const x={duty_id:g,date:S},D=((K=n(L))==null?void 0:K.name)||"",P={employeeName:c(L),dutyName:D,date:L.date||"",role:C};T&&(x.assignment_role=T);const{error:U}=await t.from("actual_duties").update(x).eq("id",b);if(U){if(U.code==="23505"){r("       .","warning");return}r(U.message,"error");return}const W=await o(L.employee_id,S,g,b);if(W!=null&&W.error){r(W.error.message,"error");return}const z={employeeName:c(L),dutyName:E||D,date:S,role:T||C},H=u((W==null?void 0:W.removedEntries)||[]);await i(y),r(`: ${d(P)}  ${d(z)}.${H}`,"success")}return{applyDropTargetHighlights:f,clearDropTargetHighlights:m,handleDragOver:p,moveDraggedActualDuty:_}}const ht=new Map;let Jt="";function Tm(e){if(!e)return"";const t=new Date(e);return Number.isNaN(t.getTime())?"":new Intl.DateTimeFormat("bg-BG",{dateStyle:"medium",timeStyle:"short"}).format(t)}function $n(e,t){const r=e.querySelector("#schedule-publication-status"),s=e.querySelector("#schedule-confirm-required-badge");if(!r)return;if(!!!(t!=null&&t.is_confirmed)){const l=!!t;s==null||s.classList.toggle("d-none",!l),t?r.textContent=":    ,      ":r.textContent=":   ",r.classList.remove("text-success"),r.classList.add("text-warning");return}s==null||s.classList.add("d-none");const a=String((t==null?void 0:t.source)||"timetable").trim(),i=a==="timetable"?"":a,o=Tm(t==null?void 0:t.confirmed_at);r.textContent=o?`:   ${i} (${o})`:`:   ${i}`,r.classList.remove("text-warning"),r.classList.add("text-success")}async function Zt(e,t){if(!t)return $n(e,null),null;const{data:r,error:s}=await w.from("schedule_publications").select("schedule_date, is_confirmed, source, confirmed_at").eq("schedule_date",t).maybeSingle();return s?($n(e,null),null):($n(e,r||null),r||null)}async function Em(e,t){var i;if(!t){v("   .","warning");return}const{data:r}=await w.auth.getUser(),s=((i=r==null?void 0:r.user)==null?void 0:i.id)||null,n=new Date().toISOString(),{error:a}=await w.from("schedule_publications").upsert({schedule_date:t,is_confirmed:!0,source:"timetable",confirmed_at:n,confirmed_by:s,created_from:s},{onConflict:"schedule_date"});if(a){v(a.message,"error");return}await Zt(e,t),v("    .","success")}async function $m(e){const t=await ue("../schedule.html",import.meta.url);e.innerHTML=t,rl(e,"#schedule-print-left-label");const r=e.querySelector("#schedule-date"),s=e.querySelector("#schedule-confirm-from-timetable"),n=e.querySelector("#schedule-go-to-actual"),a=e.querySelector("#schedule-print"),i=e.querySelector("#schedule-print-orientation"),o=e.querySelector("#schedule-print-compact"),l=e.querySelector("#schedule-print-fit-one-page"),c=fm();r&&c?r.value=c:r&&!r.value&&(r.value=new Date().toISOString().split("T")[0]),Am(e),await xm(e),r==null||r.addEventListener("change",async()=>{await zs(e)}),s==null||s.addEventListener("click",async()=>{const d=(r==null?void 0:r.value)||"";s.disabled=!0,await Em(e,d),s.disabled=!1}),n==null||n.addEventListener("click",()=>{const d=(r==null?void 0:r.value)||"";if(!d){v(" ,     .","warning");return}const u=new URLSearchParams({date:d});window.history.pushState({},"",`/actual-duties?${u.toString()}`),window.dispatchEvent(new PopStateEvent("popstate"))}),a==null||a.addEventListener("click",()=>{const d=(i==null?void 0:i.value)==="portrait"?"portrait":"landscape",u=(o==null?void 0:o.checked)??!0,h=(l==null?void 0:l.checked)??!0;ym(e,{orientation:d,compact:u,fitOnePage:h}),window.addEventListener("afterprint",gm,{once:!0}),window.print()}),await zs(e)}function Am(e){const t=e.querySelector("#schedule-actual-edit-modal"),r=e.querySelector("#schedule-actual-edit-modal-close"),s=e.querySelector("#schedule-actual-edit-cancel"),n=e.querySelector("#schedule-actual-edit-form"),a=Lm({actualRowsById:ht,supabase:w,showToast:v,getDutyFromRow:Ws,resolveActualDutyRole:Yn,openModal:mm,closeModal:Ps,loadScheduleData:zs,removeEmployeeTripAndDayOffEntries:eo}),i=qm({actualRowsById:ht,supabase:w,showToast:v,resolveActualDutyRole:Yn,getDutyFromRow:Ws,getDutyTypeName:Mt,loadScheduleData:zs,removeEmployeeTripAndDayOffEntries:eo});r==null||r.addEventListener("click",()=>Ps(t)),s==null||s.addEventListener("click",()=>Ps(t)),n==null||n.addEventListener("submit",async o=>{o.preventDefault(),await a.saveEditedActualDuty(e)}),e.addEventListener("click",o=>{const l=o.target.closest("button[data-actual-edit-id]");if(l){const m=l.getAttribute("data-actual-edit-id")||"";if(!m)return;a.openEditActualDutyModal(e,m);return}const c=o.target.closest("button[data-actual-add-duty-id]");if(!c)return;const d=c.getAttribute("data-actual-add-duty-id")||"",u=c.getAttribute("data-actual-add-date")||"",h=c.getAttribute("data-actual-add-duty-name")||"";!d||!u||a.openCreateActualDutyModal(e,{dutyId:d,date:u,dutyName:h})}),e.addEventListener("dragstart",o=>{const l=o.target.closest("button[data-actual-drag-id]");l&&(Jt=l.getAttribute("data-actual-drag-id")||"",Jt&&(xr(!0),l.classList.add("opacity-50"),o.dataTransfer&&(o.dataTransfer.effectAllowed="move",o.dataTransfer.setData("text/plain",Jt)),i.applyDropTargetHighlights(e,Jt)))}),e.addEventListener("dragend",o=>{const l=o.target.closest("button[data-actual-drag-id]");l==null||l.classList.remove("opacity-50"),i.clearDropTargetHighlights(e),Jt="",xr(!1)}),e.addEventListener("dragover",o=>{i.handleDragOver(o)}),e.addEventListener("drop",async o=>{var p;const l=o.target.closest("td[data-drop-duty-id]");if(!l){i.clearDropTargetHighlights(e),xr(!1);return}o.preventDefault();const c=l.getAttribute("data-drop-duty-id")||"",d=l.getAttribute("data-drop-duty-name")||"",u=l.getAttribute("data-drop-date")||"",h=l.getAttribute("data-drop-role")||"",f=((p=o.dataTransfer)==null?void 0:p.getData("text/plain"))||""||Jt;if(!c||!u||!f){i.clearDropTargetHighlights(e),xr(!1);return}i.clearDropTargetHighlights(e),await i.moveDraggedActualDuty(e,f,c,u,h,d),xr(!1)}),pm("schedule",[t])}async function xm(e){const t=e.querySelector("#schedule-actual-edit-employee"),{data:r,error:s}=await w.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0});if(s){v(s.message,"error");return}const n=(r||[]).map(a=>{const i=`${a.first_name??""} ${a.last_name??""}`.trim()||"-";return`<option value="${a.id}">${_e(i)}</option>`}).join("");t&&(t.innerHTML='<option value=""> </option>'+n)}async function zs(e){const t=e.querySelector("#schedule-date"),r=t==null?void 0:t.value,s=e.querySelector("#schedule-sheet-date");if(s&&(s.textContent=r?bm(r):""),!r){ht.clear(),$r(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ar(e,{hint:" .",error:"",empty:""}),await Zt(e,"");return}const{data:n,error:a}=await w.from("actual_duties").select("id, date, duty_id, employee_id, assignment_role, employees(first_name, last_name, positions(title)), duties(id, name, schedule_key_id, display_order, start_time, end_time, second_day, duty_types(name))").eq("date",r);if(a){v(a.message,"error"),ht.clear(),$r(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ar(e,{hint:"",error:"     .",empty:""}),await Zt(e,r);return}const{data:i,error:o}=await w.from("employee_absences").select("employee_id").lte("start_date",r).gte("end_date",r);if(o){v(o.message,"error"),ht.clear(),$r(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ar(e,{hint:"",error:"    .",empty:""}),await Zt(e,r);return}const{data:l,error:c}=await sl(r);if(c){v(c.message,"error"),ht.clear(),$r(e,{train:[],businessTrip:[],dayOff:[]},new Map),Ar(e,{hint:"",error:"    .",empty:""}),await Zt(e,r);return}const d=new Set((i||[]).map(f=>f==null?void 0:f.employee_id).filter(Boolean));ht.clear(),(n||[]).forEach(f=>{f!=null&&f.id&&ht.set(f.id,f)});const u={train:[],businessTrip:[],dayOff:[]};(l||[]).forEach(f=>{const p=Mt(f).toLowerCase();if(p.includes(" ")){u.train.push(f);return}if(p.includes("")){u.businessTrip.push(f);return}p.includes(" ")&&u.dayOff.push(f)}),u.train.sort(_m),u.businessTrip.sort(Xn),u.dayOff.sort(Xn);const h=vm(n||[],d);$r(e,u,h,r);const m=u.train.length+u.businessTrip.length+u.dayOff.length;Ar(e,{hint:"",error:"",empty:m?"":"      ."}),await Zt(e,r)}async function eo(e,t,r,s){const n={error:null,removedEntries:[]};if(!e||!t||!r)return n;const{data:a,error:i}=await w.from("duties").select("id, duty_types(name)").eq("id",r).single();if(i)return{error:i,removedEntries:[]};if(!Mt(a).toLowerCase().includes(" "))return n;const{data:l,error:c}=await w.from("duties").select("id, duty_types(name)");if(c)return{error:c,removedEntries:[]};const d=(l||[]).filter(y=>{const b=Mt(y).toLowerCase();return b.includes("")||b.includes(" ")}).map(y=>y.id).filter(Boolean);if(!d.length)return n;let u=w.from("actual_duties").select("id, date, duties(name, duty_types(name))").eq("employee_id",e).eq("date",t).in("duty_id",d);s&&(u=u.neq("id",s));const{data:h,error:m}=await u;if(m)return{error:m,removedEntries:[]};const f=(h||[]).map(y=>y==null?void 0:y.id).filter(Boolean);if(!f.length)return n;const{error:p}=await w.from("actual_duties").delete().in("id",f);return p?{error:p,removedEntries:[]}:{error:null,removedEntries:(h||[]).map(y=>{const b=Ws(y);return{dutyName:String((b==null?void 0:b.name)||"").trim(),dutyTypeName:String(Mt(b)||"").trim(),date:String((y==null?void 0:y.date)||"").trim()}})}}function xr(e){document.body.classList.toggle("schedule-dragging",!!e)}function An(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const to=new Map;function Cm(e,t){const r=to.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){yr(a);return}}};to.set(e,s),document.addEventListener("keydown",s)}function yr(e){var t,r;e.classList.add("d-none"),(t=document.querySelector("#duty-type-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#duty-type-delete-modal"))!=null&&r.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function ro(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const gr={rows:[],searchQuery:""};async function $a(e){const{data:t,error:r}=await w.from("duty_types").select("id, name").order("name",{ascending:!0});if(r){v(r.message,"error"),gr.rows=[],Zn(e,"     .");return}gr.rows=t||[],Zn(e)}function Zn(e,t){const r=e.querySelector("#duty-types-table-body"),s=e.querySelector("#duty-types-empty"),n=gr.rows.filter(a=>gr.searchQuery?(a.name||"").toLowerCase().includes(gr.searchQuery):!0);if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"   .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>`
        <tr>
          <td>${ro(a.name??"-")}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-name="${ro(a.name??"")}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `).join("")}async function Rm(e){const t=await ue("../duty-types.html",import.meta.url);e.innerHTML=t,Im(e),await $a(e)}function Im(e){const t=e.querySelector("#open-create-duty-type"),r=e.querySelector("#duty-type-form"),s=e.querySelector("#duty-type-cancel-btn"),n=e.querySelector("#duty-types-table-body"),a=e.querySelector("#duty-type-modal"),i=e.querySelector("#duty-type-delete-modal"),o=e.querySelector("#duty-type-modal-close"),l=e.querySelector("#duty-type-delete-confirm"),c=e.querySelector("#duty-type-delete-cancel"),d=e.querySelector("#duty-types-search");t==null||t.addEventListener("click",()=>{Aa(e),An(a)}),r==null||r.addEventListener("submit",async u=>{u.preventDefault(),await Dm(e)}),s==null||s.addEventListener("click",()=>{yr(a)}),o==null||o.addEventListener("click",()=>{yr(a)}),c==null||c.addEventListener("click",()=>{yr(i)}),d==null||d.addEventListener("input",u=>{gr.searchQuery=u.target.value.trim().toLowerCase(),Zn(e)}),Cm("duty-types",[i,a]),l==null||l.addEventListener("click",async()=>{const u=e.querySelector("#duty-type-delete-id").value;await Pm(u,e)}),n==null||n.addEventListener("click",u=>{const h=u.target.closest("button[data-action]");if(!h)return;const m=h.getAttribute("data-action");if(m==="edit"){Om(e,{id:h.getAttribute("data-id"),name:h.getAttribute("data-name")}),An(a);return}if(m==="delete"){const f=h.getAttribute("data-id");e.querySelector("#duty-type-delete-id").value=f,An(i)}})}async function Dm(e){var l;const t=e.querySelector("#duty-type-id"),r=e.querySelector("#duty-type-name"),s=e.querySelector("#duty-type-save-btn"),n=r.value.trim(),a=t.value;if(!n){v(",  .","warning");return}const i=s.innerHTML;s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let o;if(a)({error:o}=await w.from("duty_types").update({name:n}).eq("id",a));else{const{data:c}=await w.auth.getUser(),d=((l=c==null?void 0:c.user)==null?void 0:l.email)??"web_app";({error:o}=await w.from("duty_types").insert({name:n,created_from:d}))}if(s.disabled=!1,s.innerHTML=i,o){if(o.code==="23505"){v("   .","warning");return}v(o.message,"error");return}v(a?"  .":"  .","success"),yr(e.querySelector("#duty-type-modal")),Aa(e),await $a(e)}function Om(e,t){e.querySelector("#duty-type-id").value=t.id,e.querySelector("#duty-type-name").value=t.name??"",e.querySelector("#duty-type-form-title").textContent="  ",e.querySelector("#duty-type-save-btn").textContent=""}function Aa(e){e.querySelector("#duty-type-id").value="",e.querySelector("#duty-type-name").value="",e.querySelector("#duty-type-form-title").textContent=" ",e.querySelector("#duty-type-save-btn").textContent=""}async function Pm(e,t){const r=t.querySelector("#duty-type-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{count:n,error:a}=await w.from("duties").select("id",{count:"exact",head:!0}).eq("duty_type_id",e);if(a){r.disabled=!1,r.innerHTML=s,v(a.message,"error");return}if((n||0)>0){r.disabled=!1,r.innerHTML=s,v("     ,     .","warning");return}const{error:i}=await w.from("duty_types").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,i){if(i.code==="23503"){v("     ,     .","warning");return}v(i.message,"error");return}v("  .","success"),yr(t.querySelector("#duty-type-delete-modal")),Aa(t),await $a(t)}function Ge(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function so(e){return e?typeof e=="string"?e.replace(".000000",""):String(e):"-"}function Mm(){return new URLSearchParams(window.location.search).get("scheduleKeyId")||""}function Nm(){return new URLSearchParams(window.location.search).get("scheduleKeyName")||""}function rs(e){e==null||e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const no=new Map;function jm(e,t){const r=no.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){He(a);return}}};no.set(e,s),document.addEventListener("keydown",s)}function He(e){var a,i,o,l;e==null||e.classList.add("d-none");const t=(a=document.querySelector("#schedule-key-duty-create-modal"))==null?void 0:a.classList.contains("d-none"),r=(i=document.querySelector("#schedule-key-duty-edit-modal"))==null?void 0:i.classList.contains("d-none"),s=(o=document.querySelector("#schedule-key-duty-delete-modal"))==null?void 0:o.classList.contains("d-none"),n=(l=document.querySelector("#schedule-key-duty-profile-modal"))==null?void 0:l.classList.contains("d-none");t&&r&&s&&n&&document.body.classList.remove("overflow-hidden")}const se={scheduleKeyId:"",scheduleKeyName:"",duties:[],draggedDutyId:null,lastCreatedDutyTypeId:"",lastCreatedScheduleKeyIds:[]},ao="id, name, notes, duty_type_id, schedule_key_id, start_time, end_time, second_day, break_start_time, break_end_time, break_duration_interval, duration_interval, display_order, duty_types(name), schedule_key_duties(schedule_key_id, schedule_keys(name)), duty_trains(train_id, sequence_order, trains(number))";async function ds(e){const t=se.scheduleKeyId,{data:r,error:s}=await w.from("duties").select(ao).eq("schedule_key_id",t).order("display_order",{ascending:!0}).order("name",{ascending:!0});if(s){se.duties=[],lr(e,"    ."),v(s.message,"error");return}const{data:n,error:a}=await w.from("schedule_key_duties").select("duty_id").eq("schedule_key_id",t);if(a){se.duties=[],lr(e,"    ."),v(a.message,"error");return}const i=r||[],o=new Set(i.map(d=>d==null?void 0:d.id).filter(Boolean)),l=[...new Set((n||[]).map(d=>d==null?void 0:d.duty_id).filter(Boolean))].filter(d=>!o.has(d));let c=[];if(l.length){const{data:d,error:u}=await w.from("duties").select(ao).in("id",l);if(u){se.duties=[],lr(e,"    ."),v(u.message,"error");return}c=d||[]}se.duties=[...i,...c].sort((d,u)=>{const h=Number.isFinite(Number(d==null?void 0:d.display_order))?Number(d.display_order):Number.MAX_SAFE_INTEGER,m=Number.isFinite(Number(u==null?void 0:u.display_order))?Number(u.display_order):Number.MAX_SAFE_INTEGER;return h!==m?h-m:String((d==null?void 0:d.name)||"").localeCompare(String((u==null?void 0:u.name)||""),"bg")}),lr(e)}function lr(e,t){const r=e.querySelector("#schedule-key-duties-body"),s=e.querySelector("#schedule-key-duties-empty");if(!se.duties.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"    -.";return}s.classList.add("d-none"),r.innerHTML=se.duties.map(n=>{const a=Um(n),i=Fm(n),o=`<span class="badge text-bg-info" title="${Ge(i.join(", "))}">${a.length} -</span>`;return`
        <tr data-duty-id="${n.id}" draggable="true">
          <td class="text-secondary"></td>
          <td>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              ${o}
              <span>${Ge(n.name??"-")}</span>           
            </div>
          </td>
          <td>${Ge(n.start_time??"-")}</td>
          <td>${Ge(n.end_time??"-")}</td>
          <td>${n.second_day?"":""}</td>
          <td>${Ge(so(n.break_duration_interval))}</td>
          <td>${Ge(so(n.duration_interval))}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-duty-action="profile"
                data-id="${n.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-duty-action="edit"
                data-id="${n.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-duty-action="delete"
                data-id="${n.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}async function Hm(){const e=se.duties.map((s,n)=>w.from("duties").update({display_order:n+1}).eq("id",s.id)),r=(await Promise.all(e)).find(s=>s.error);return r!=null&&r.error?(v(r.error.message,"error"),!1):(se.duties=se.duties.map((s,n)=>({...s,display_order:n+1})),!0)}function cl(e){return Array.isArray(e.schedule_key_duties)?e.schedule_key_duties:e.schedule_key_duties?[e.schedule_key_duties]:[]}function Um(e){const t=cl(e).map(s=>s==null?void 0:s.schedule_key_id).filter(Boolean),r=t.length?t:e.schedule_key_id?[e.schedule_key_id]:[];return[...new Set(r)]}function Fm(e){const t=cl(e).map(r=>{var s;return(s=r==null?void 0:r.schedule_keys)==null?void 0:s.name}).filter(Boolean);return[...new Set(t)]}async function Bm(e){const t=await ue("../schedule-key-duties.html",import.meta.url);e.innerHTML=t,Km(e),Wm(e),await Vm(e),await Gm(e),await Jm(e),await zm(e)}function Km(e){const t=e.querySelector("#schedule-key-duty-create-form-fields");t&&(t.innerHTML=zn({idPrefix:"schedule-key-duty-create"}));const r=e.querySelector("#schedule-key-duty-edit-form-fields");r&&(r.innerHTML=zn({idPrefix:"schedule-key-duty-edit"}))}function Wm(e){const t=e.querySelector("#open-create-schedule-key-duty"),r=e.querySelector("#schedule-key-duty-create-modal"),s=e.querySelector("#schedule-key-duty-create-form"),n=e.querySelector("#schedule-key-duty-create-modal-close"),a=e.querySelector("#schedule-key-duty-create-cancel"),i=e.querySelector("#schedule-key-duties-body"),o=e.querySelector("#schedule-key-duty-edit-modal"),l=e.querySelector("#schedule-key-duty-delete-modal"),c=e.querySelector("#schedule-key-duty-edit-form"),d=e.querySelector("#schedule-key-duty-edit-modal-close"),u=e.querySelector("#schedule-key-duty-edit-cancel"),h=e.querySelector("#schedule-key-duty-delete-cancel"),m=e.querySelector("#schedule-key-duty-delete-confirm"),f=e.querySelector("#schedule-key-duty-profile-modal"),p=e.querySelector("#schedule-key-duty-profile-close"),_=e.querySelector("#schedule-key-duty-profile-close-secondary"),y=e.querySelector("#schedule-key-duty-profile-edit");t==null||t.addEventListener("click",()=>{xa(e),rs(r)}),n==null||n.addEventListener("click",()=>{He(r)}),a==null||a.addEventListener("click",()=>{He(r)}),s==null||s.addEventListener("submit",async b=>{b.preventDefault(),await Qm(e)}),c==null||c.addEventListener("submit",async b=>{b.preventDefault(),await Ym(e)}),d==null||d.addEventListener("click",()=>{He(o)}),u==null||u.addEventListener("click",()=>{He(o)}),h==null||h.addEventListener("click",()=>{He(l)}),m==null||m.addEventListener("click",async()=>{const b=e.querySelector("#schedule-key-duty-delete-id").value;await ap(e,b)}),p==null||p.addEventListener("click",()=>{He(f)}),_==null||_.addEventListener("click",()=>{He(f)}),y==null||y.addEventListener("click",()=>{var g;const b=((g=f==null?void 0:f.dataset)==null?void 0:g.dutyId)||"";b&&(He(f),io(e,b))}),jm("schedule-key-duties",[f,l,o,r]),i==null||i.addEventListener("dragstart",b=>{const g=b.target.closest("tr[data-duty-id]");g&&(se.draggedDutyId=g.getAttribute("data-duty-id"),g.classList.add("table-active"))}),i==null||i.addEventListener("dragend",b=>{const g=b.target.closest("tr[data-duty-id]");g&&g.classList.remove("table-active"),se.draggedDutyId=null}),i==null||i.addEventListener("dragover",b=>{b.preventDefault()}),i==null||i.addEventListener("drop",async b=>{b.preventDefault();const g=b.target.closest("tr[data-duty-id]"),S=se.draggedDutyId;if(!g||!S)return;const k=g.getAttribute("data-duty-id");if(!k||k===S)return;const E=se.duties.findIndex(T=>T.id===S),L=se.duties.findIndex(T=>T.id===k);if(E<0||L<0)return;const[$]=se.duties.splice(E,1);if(se.duties.splice(L,0,$),lr(e),!await Hm()){await ds(e);return}v("    .","success")}),i==null||i.addEventListener("click",async b=>{const g=b.target.closest("button[data-duty-action]");if(!g)return;const S=g.getAttribute("data-duty-action");if(S==="profile"){const k=g.getAttribute("data-id");Xm(e,k);return}if(S==="edit"){const k=g.getAttribute("data-id");io(e,k);return}if(S==="delete"){const k=g.getAttribute("data-id");np(e,k)}})}async function zm(e){if(se.scheduleKeyId=Mm(),se.scheduleKeyName=Nm(),!se.scheduleKeyId){lr(e,"  -.     ."),e.querySelector("#open-create-schedule-key-duty").classList.add("d-none");return}if(!se.scheduleKeyName){const{data:t,error:r}=await w.from("schedule_keys").select("name").eq("id",se.scheduleKeyId).single();r&&v(r.message,"error"),se.scheduleKeyName=(t==null?void 0:t.name)||se.scheduleKeyId}e.querySelector("#schedule-key-duties-title").textContent=se.scheduleKeyName,xa(e),await ds(e)}async function Vm(e){const t=e.querySelector("#schedule-key-duty-create-type"),r=e.querySelector("#schedule-key-duty-edit-type"),{data:s,error:n}=await w.from("duty_types").select("id, name").order("name",{ascending:!0});if(n){v(n.message,"error");return}const a=(s||[]).map(i=>`<option value="${i.id}">${Ge(i.name)}</option>`).join("");t.innerHTML='<option value=""> </option>'+a,r.innerHTML='<option value=""> </option>'+a}async function Gm(e){const t=e.querySelector("#schedule-key-duty-create-schedule-keys"),r=e.querySelector("#schedule-key-duty-edit-schedule-keys"),{data:s,error:n}=await w.from("schedule_keys").select("id, name").order("name",{ascending:!0});if(n){v(n.message,"error");return}const a=(s||[]).map(i=>`<option value="${i.id}">${Ge(i.name)}</option>`).join("");t.innerHTML=a,r.innerHTML=a}async function Jm(e){const t=e.querySelector("#schedule-key-duty-create-trains"),r=e.querySelector("#schedule-key-duty-edit-trains"),{data:s,error:n}=await w.from("trains").select("id, number, origin_station, destination_station").order("number",{ascending:!0});if(n){v(n.message,"error");return}const a=(s||[]).map(i=>{const o=`${i.origin_station||"-"} - ${i.destination_station||"-"}`;return`<option value="${i.id}">${Ge(i.number||"-")} (${Ge(o)})</option>`}).join("");t&&(t.innerHTML=a),r&&(r.innerHTML=a)}async function Qm(e){var U,W;const t=e.querySelector("#schedule-key-duty-create-name"),r=e.querySelector("#schedule-key-duty-create-type"),s=e.querySelector("#schedule-key-duty-create-schedule-keys"),n=nt(e,"#schedule-key-duty-create-start","#schedule-key-duty-create-start-time"),a=nt(e,"#schedule-key-duty-create-end","#schedule-key-duty-create-end-time"),i=e.querySelector("#schedule-key-duty-create-second-day"),o=nt(e,"#schedule-key-duty-create-break-start","#schedule-key-duty-create-break-start-time"),l=nt(e,"#schedule-key-duty-create-break-end","#schedule-key-duty-create-break-end-time"),c=e.querySelector("#schedule-key-duty-create-trains"),d=e.querySelector("#schedule-key-duty-create-save"),u=t.value.trim(),h=r.value||null,m=Array.from(s.selectedOptions||[]).map(z=>z.value).filter(Boolean),f=m[0]||null,p=(n==null?void 0:n.value)||"",_=(a==null?void 0:a.value)||"",y=i.checked,b=(o==null?void 0:o.value)||"00:00",g=(l==null?void 0:l.value)||"00:00",S=e.querySelector("#schedule-key-duty-create-notes").value.trim()||null,k=Array.from(c.selectedOptions||[]).map(z=>z.value).filter(Boolean);if(!se.scheduleKeyId||!u||!h||!p||!_){v(",     .","warning");return}if(!m.length){v("   -.","warning");return}const E=Ie(p,_);if(Ie(b,g)>E){v("     -    .","warning");return}const $=d.innerHTML;d.disabled=!0,d.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:q}=await w.auth.getUser(),T=((U=q==null?void 0:q.user)==null?void 0:U.id)??((W=q==null?void 0:q.user)==null?void 0:W.email)??"web_app",C=se.duties.reduce((z,H)=>Math.max(z,Number(H.display_order)||0),0),{data:A,error:x}=await w.from("duties").insert({schedule_key_id:f,duty_type_id:h,name:u,start_time:p,end_time:_,second_day:y,break_start_time:b,break_end_time:g,notes:S,created_from:T,display_order:C+1}).select("id").single(),D=x?null:await dl(A==null?void 0:A.id,m),P=x||D?null:await ul(A==null?void 0:A.id,k);if(d.disabled=!1,d.innerHTML=$,x||D||P){v((x||D||P).message,"error");return}se.lastCreatedDutyTypeId=h,se.lastCreatedScheduleKeyIds=[...m],He(e.querySelector("#schedule-key-duty-create-modal")),xa(e),v("    -.","success"),await ds(e)}function io(e,t){const r=se.duties.find(o=>o.id===t);if(!r){v("   .","warning");return}e.querySelector("#schedule-key-duty-edit-id").value=r.id,e.querySelector("#schedule-key-duty-edit-name").value=r.name??"",e.querySelector("#schedule-key-duty-edit-type").value=r.duty_type_id??"";const s=e.querySelector("#schedule-key-duty-edit-schedule-keys"),n=ep(r);Array.from(s.options).forEach(o=>{o.selected=n.includes(o.value)});const a=e.querySelector("#schedule-key-duty-edit-trains"),i=rp(r);Array.from(a.options).forEach(o=>{o.selected=i.includes(o.value)}),vt(e,(r.start_time||"").slice(0,5),"#schedule-key-duty-edit-start","#schedule-key-duty-edit-start-time"),vt(e,(r.end_time||"").slice(0,5),"#schedule-key-duty-edit-end","#schedule-key-duty-edit-end-time"),e.querySelector("#schedule-key-duty-edit-second-day").checked=!!r.second_day,vt(e,jt(r.break_start_time),"#schedule-key-duty-edit-break-start","#schedule-key-duty-edit-break-start-time"),vt(e,jt(r.break_end_time),"#schedule-key-duty-edit-break-end","#schedule-key-duty-edit-break-end-time"),e.querySelector("#schedule-key-duty-edit-notes").value=r.notes??"",rs(e.querySelector("#schedule-key-duty-edit-modal"))}function xa(e){var n;e.querySelector("#schedule-key-duty-create-name").value="",e.querySelector("#schedule-key-duty-create-type").value=se.lastCreatedDutyTypeId||"";const t=(n=se.lastCreatedScheduleKeyIds)!=null&&n.length?se.lastCreatedScheduleKeyIds:[se.scheduleKeyId],r=e.querySelector("#schedule-key-duty-create-schedule-keys");Array.from(r.options).forEach(a=>{a.selected=t.includes(a.value)}),vt(e,"","#schedule-key-duty-create-start","#schedule-key-duty-create-start-time"),vt(e,"","#schedule-key-duty-create-end","#schedule-key-duty-create-end-time"),e.querySelector("#schedule-key-duty-create-second-day").checked=!1,vt(e,"00:00","#schedule-key-duty-create-break-start","#schedule-key-duty-create-break-start-time"),vt(e,"00:00","#schedule-key-duty-create-break-end","#schedule-key-duty-create-break-end-time"),e.querySelector("#schedule-key-duty-create-notes").value="";const s=e.querySelector("#schedule-key-duty-create-trains");Array.from(s.options).forEach(a=>{a.selected=!1})}async function Ym(e){var S,k,E,L;const t=e.querySelector("#schedule-key-duty-edit-id").value,r=e.querySelector("#schedule-key-duty-edit-name").value.trim(),s=e.querySelector("#schedule-key-duty-edit-type").value||null,n=Array.from(e.querySelector("#schedule-key-duty-edit-schedule-keys").selectedOptions||[]).map($=>$.value).filter(Boolean),a=n[0]||null,i=((S=nt(e,"#schedule-key-duty-edit-start","#schedule-key-duty-edit-start-time"))==null?void 0:S.value)||"",o=((k=nt(e,"#schedule-key-duty-edit-end","#schedule-key-duty-edit-end-time"))==null?void 0:k.value)||"",l=e.querySelector("#schedule-key-duty-edit-second-day").checked,c=((E=nt(e,"#schedule-key-duty-edit-break-start","#schedule-key-duty-edit-break-start-time"))==null?void 0:E.value)||"00:00",d=((L=nt(e,"#schedule-key-duty-edit-break-end","#schedule-key-duty-edit-break-end-time"))==null?void 0:L.value)||"00:00",u=e.querySelector("#schedule-key-duty-edit-notes").value.trim()||null,h=Array.from(e.querySelector("#schedule-key-duty-edit-trains").selectedOptions||[]).map($=>$.value).filter(Boolean),m=e.querySelector("#schedule-key-duty-edit-save");if(!t||!r||!s||!i||!o){v(",     .","warning");return}if(!n.length){v("   -.","warning");return}const f=Ie(i,o);if(Ie(c,d)>f){v("     -    .","warning");return}const _=m.innerHTML;m.disabled=!0,m.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:y}=await w.from("duties").update({name:r,duty_type_id:s,schedule_key_id:a,start_time:i,end_time:o,second_day:l,break_start_time:c,break_end_time:d,notes:u}).eq("id",t),b=y?null:await dl(t,n),g=y||b?null:await ul(t,h);if(m.disabled=!1,m.innerHTML=_,y||b||g){v((y||b||g).message,"error");return}He(e.querySelector("#schedule-key-duty-edit-modal")),v("  .","success"),await ds(e)}async function dl(e,t){if(!e)return{message:"       -."};const{error:r}=await w.from("schedule_key_duties").delete().eq("duty_id",e);if(r)return r;const s=t.map(a=>({duty_id:e,schedule_key_id:a})),{error:n}=await w.from("schedule_key_duties").insert(s);return n}async function ul(e,t){if(!e)return{message:"       ."};const{error:r}=await w.from("duty_trains").delete().eq("duty_id",e);if(r)return r;if(!t.length)return null;const s=t.map((a,i)=>({duty_id:e,train_id:a,sequence_order:i+1})),{error:n}=await w.from("duty_trains").insert(s);return n}function Xm(e,t){const r=se.duties.find(l=>l.id===t),s=e.querySelector("#schedule-key-duty-profile-content"),n=e.querySelector("#schedule-key-duty-profile-modal"),a=e.querySelector("#schedule-key-duty-profile-edit");if(!s||!n)return;if(!r){n.dataset.dutyId="",a&&(a.disabled=!0),s.innerHTML='<p class="text-secondary mb-0">    .</p>',rs(n);return}n.dataset.dutyId=r.id,a&&(a.disabled=!1);const i=tp(r),o=sp(r);s.innerHTML=Ko({duty:r,scheduleKeyNames:i,trainNumbers:o,escapeHtml:Ge,intervalToTimeInput:jt,formatInterval:Zm}),rs(n)}function Zm(e){return e?String(e).replace(".000000",""):"-"}function nt(e,...t){for(const r of t){const s=e.querySelector(r);if(s)return s}return null}function vt(e,t,...r){const s=nt(e,...r);s&&(s.value=t)}function hl(e){return Array.isArray(e==null?void 0:e.schedule_key_duties)?e.schedule_key_duties:e!=null&&e.schedule_key_duties?[e.schedule_key_duties]:[]}function ep(e){const t=hl(e).map(s=>s==null?void 0:s.schedule_key_id).filter(Boolean),r=t.length?t:e!=null&&e.schedule_key_id?[e.schedule_key_id]:[];return[...new Set(r)]}function tp(e){const t=hl(e).map(r=>{var s;return(s=r==null?void 0:r.schedule_keys)==null?void 0:s.name}).filter(Boolean);return[...new Set(t)]}function fl(e){return Array.isArray(e==null?void 0:e.duty_trains)?e.duty_trains:e!=null&&e.duty_trains?[e.duty_trains]:[]}function rp(e){return fl(e).map(t=>({id:t==null?void 0:t.train_id,sequenceOrder:Number.isFinite(Number(t==null?void 0:t.sequence_order))?Number(t.sequence_order):Number.MAX_SAFE_INTEGER})).filter(t=>!!t.id).sort((t,r)=>t.sequenceOrder-r.sequenceOrder).map(t=>t.id).filter((t,r,s)=>s.indexOf(t)===r)}function sp(e){return fl(e).map(t=>{var r;return{number:(r=t==null?void 0:t.trains)==null?void 0:r.number,sequenceOrder:Number.isFinite(Number(t==null?void 0:t.sequence_order))?Number(t.sequence_order):Number.MAX_SAFE_INTEGER}}).filter(t=>!!t.number).sort((t,r)=>t.sequenceOrder-r.sequenceOrder).map(t=>t.number).filter((t,r,s)=>s.indexOf(t)===r)}function np(e,t){e.querySelector("#schedule-key-duty-delete-id").value=t,rs(e.querySelector("#schedule-key-duty-delete-modal"))}async function ap(e,t){const r=e.querySelector("#schedule-key-duty-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{error:n}=await w.from("duties").delete().eq("id",t).eq("schedule_key_id",se.scheduleKeyId);if(r.disabled=!1,r.innerHTML=s,n){v(n.message,"error");return}He(e.querySelector("#schedule-key-duty-delete-modal")),v("  .","success"),await ds(e)}function Ms(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const oo=new Map;function ip(e,t){const r=oo.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Nt(a);return}}};oo.set(e,s),document.addEventListener("keydown",s)}function Nt(e){var t,r,s;e.classList.add("d-none"),(t=document.querySelector("#train-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#train-delete-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#train-timetable-preview-modal"))!=null&&s.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function ve(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function lo(e){const t=String(e||"").trim();if(!t)return"";const r=t.match(/^(\d{1,2}:\d{2})/);return r?r[1]:t.slice(0,5)}const Se={rows:[],searchQuery:"",originFilter:"",destinationFilter:""};async function Ca(e){const{data:t,error:r}=await w.from("trains").select("id, number, origin_station, destination_station, departure_time, arrival_time, timetable_url").order("number",{ascending:!0});if(r){v(r.message,"error"),Se.rows=[],cr(e,"    .");return}Se.rows=t||[],cr(e)}function cr(e,t){const r=e.querySelector("#trains-table-body"),s=e.querySelector("#trains-empty");lp(e);const n=Se.rows.filter(a=>{const i=`${a.number||""} ${a.origin_station||""} ${a.destination_station||""}`.toLowerCase(),o=String(a.origin_station||"").trim().toLowerCase(),l=String(a.destination_station||"").trim().toLowerCase(),c=!Se.searchQuery||i.includes(Se.searchQuery),d=!Se.originFilter||o===Se.originFilter,u=!Se.destinationFilter||l===Se.destinationFilter;return c&&d&&u});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{const i=op(a.timetable_url),o=i.length?`<div class="d-flex flex-column gap-0">${i.map((l,c)=>{const d=l.label||` ${c+1}`,u=encodeURIComponent(l.url),h=encodeURIComponent(d);return`
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <a class="text-decoration-none" href="${ve(l.url)}" target="_blank" rel="noopener noreferrer">${ve(d)}</a>
                <button
                  type="button"
                  class="btn btn-link btn-sm p-0 lh-1 text-decoration-none"
                  data-action="preview-timetable"
                  data-preview-url="${ve(u)}"
                  data-preview-label="${ve(h)}"
                  title=""
                  aria-label=""
                >
                  
                </button>
              </div>
            `}).join("")}</div>`:'<span class="text-secondary">-</span>';return`
        <tr>
          <td>${ve(a.number??"-")}</td>
          <td>${ve(a.origin_station??"-")}</td>
          <td>${ve(a.destination_station??"-")}</td>
          <td>${ve((a.departure_time||"").slice(0,5)||"-")}</td>
          <td>${ve((a.arrival_time||"").slice(0,5)||"-")}</td>
          <td>${o}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-action="edit"
                data-id="${a.id}"
                data-number="${ve(a.number??"")}"
                data-origin-station="${ve(a.origin_station??"")}"
                data-destination-station="${ve(a.destination_station??"")}"
                data-departure-time="${ve(a.departure_time??"")}"
                data-arrival-time="${ve(a.arrival_time??"")}"
                data-timetable-url="${ve(encodeURIComponent(a.timetable_url??""))}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-action="delete"
                data-id="${a.id}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}function op(e){if(Array.isArray(e))return e.map((r,s)=>xn(r,s)).filter(r=>r.url);const t=String(e||"").trim();if(!t)return[];if(t.startsWith("["))try{const r=JSON.parse(t);if(Array.isArray(r))return r.map((s,n)=>xn(s,n)).filter(s=>s.url)}catch{return[{url:t,label:ea(t,0)}]}return t.split(`
`).map((r,s)=>xn(r,s)).filter(r=>r.url)}function lp(e){const t=e.querySelector("#trains-origin-filter"),r=e.querySelector("#trains-destination-filter");if(!t||!r)return;const s=Se.originFilter||"",n=Se.destinationFilter||"",a=[...new Set(Se.rows.map(o=>String((o==null?void 0:o.origin_station)||"").trim()).filter(Boolean))].sort((o,l)=>o.localeCompare(l,"bg")),i=[...new Set(Se.rows.map(o=>String((o==null?void 0:o.destination_station)||"").trim()).filter(Boolean))].sort((o,l)=>o.localeCompare(l,"bg"));t.innerHTML=`
    <option value=""></option>
    ${a.map(o=>`<option value="${ve(o.toLowerCase())}">${ve(o)}</option>`).join("")}
  `,r.innerHTML=`
    <option value=""></option>
    ${i.map(o=>`<option value="${ve(o.toLowerCase())}">${ve(o)}</option>`).join("")}
  `,t.value=s,r.value=n}function xn(e,t){if(e&&typeof e=="object"&&!Array.isArray(e)){const s=String(e.url||"").trim(),n=String(e.label||"").trim()||ea(s,t);return{url:s,label:n}}const r=String(e||"").trim();return{url:r,label:ea(r,t)}}function ea(e,t){const r=String(e||"").trim();if(!r)return` ${t+1}`;try{const n=new URL(r).pathname.split("/").pop()||"",a=decodeURIComponent(n);if(a)return a}catch{}return` ${t+1}`}const ss="train-timetables",Vs=5;async function cp(e){const t=await ue("../trains.html",import.meta.url);e.innerHTML=t,dp(e),await Ca(e)}function dp(e){const t=e.querySelector("#open-create-train"),r=e.querySelector("#train-form"),s=e.querySelector("#train-cancel-btn"),n=e.querySelector("#trains-table-body"),a=e.querySelector("#train-modal"),i=e.querySelector("#train-delete-modal"),o=e.querySelector("#train-timetable-preview-modal"),l=e.querySelector("#train-modal-close"),c=e.querySelector("#train-delete-confirm"),d=e.querySelector("#train-delete-cancel"),u=e.querySelector("#train-timetable-preview-close"),h=e.querySelector("#trains-search"),m=e.querySelector("#trains-origin-filter"),f=e.querySelector("#trains-destination-filter"),p=e.querySelector("#trains-filter-reset"),_=e.querySelector("#train-timetable-url"),y=e.querySelector("#train-timetable-label"),b=e.querySelector("#train-timetable-file"),g=e.querySelector("#train-current-timetable-links");t==null||t.addEventListener("click",()=>{Ra(e),Ms(a)}),r==null||r.addEventListener("submit",async S=>{S.preventDefault(),await up(e)}),s==null||s.addEventListener("click",()=>{Nt(a)}),l==null||l.addEventListener("click",()=>{Nt(a)}),d==null||d.addEventListener("click",()=>{Nt(i)}),u==null||u.addEventListener("click",()=>{pp(e)}),h==null||h.addEventListener("input",S=>{Se.searchQuery=S.target.value.trim().toLowerCase(),cr(e)}),m==null||m.addEventListener("change",S=>{Se.originFilter=S.target.value||"",cr(e)}),f==null||f.addEventListener("change",S=>{Se.destinationFilter=S.target.value||"",cr(e)}),p==null||p.addEventListener("click",()=>{Se.searchQuery="",Se.originFilter="",Se.destinationFilter="",h&&(h.value=""),m&&(m.value=""),f&&(f.value=""),cr(e)}),_==null||_.addEventListener("input",()=>{}),y==null||y.addEventListener("input",()=>{}),b==null||b.addEventListener("change",()=>{var S;if((S=b.files)!=null&&S.length&&b.files.length>Vs){v(`    ${Vs}  .`,"warning"),b.value="";return}}),g==null||g.addEventListener("input",S=>{const k=S.target.closest(".train-existing-timetable-label");if(!k)return;const E=Number(k.getAttribute("data-index"));if(!Number.isInteger(E)||E<0)return;const L=e.querySelector("#train-draft-timetable-url"),$=vr((L==null?void 0:L.value)||"");$[E]&&($[E].label=k.value,L&&(L.value=as($)||""))}),g==null||g.addEventListener("click",S=>{const k=S.target.closest(".train-existing-timetable-preview");if(k){const T=String(k.getAttribute("data-url")||"").trim(),C=String(k.getAttribute("data-label")||"").trim();co(e,T,C);return}const E=S.target.closest(".train-existing-timetable-remove");if(!E)return;const L=Number(E.getAttribute("data-index"));if(!Number.isInteger(L)||L<0)return;const $=e.querySelector("#train-draft-timetable-url"),q=vr(($==null?void 0:$.value)||"");q[L]&&(q.splice(L,1),Ia(e,q))}),ip("trains",[o,i,a]),c==null||c.addEventListener("click",async()=>{const S=e.querySelector("#train-delete-id").value;await mp(S,e)}),n==null||n.addEventListener("click",S=>{const k=S.target.closest("button[data-action]");if(!k)return;const E=k.getAttribute("data-action");if(E==="edit"){hp(e,{id:k.getAttribute("data-id"),number:k.getAttribute("data-number"),originStation:k.getAttribute("data-origin-station"),destinationStation:k.getAttribute("data-destination-station"),departureTime:k.getAttribute("data-departure-time"),arrivalTime:k.getAttribute("data-arrival-time"),timetableUrl:decodeURIComponent(k.getAttribute("data-timetable-url")||"")}),Ms(a);return}if(E==="delete"){const L=k.getAttribute("data-id");e.querySelector("#train-delete-id").value=L,Ms(i);return}if(E==="preview-timetable"){const L=decodeURIComponent(k.getAttribute("data-preview-url")||""),$=decodeURIComponent(k.getAttribute("data-preview-label")||"");co(e,L,$)}})}async function up(e){var U;const t=e.querySelector("#train-id"),r=e.querySelector("#train-number"),s=e.querySelector("#train-origin-station"),n=e.querySelector("#train-destination-station"),a=e.querySelector("#train-departure-time"),i=e.querySelector("#train-arrival-time"),o=e.querySelector("#train-timetable-url"),l=e.querySelector("#train-timetable-label"),c=e.querySelector("#train-timetable-file"),d=e.querySelector("#train-existing-timetable-url"),u=e.querySelector("#train-draft-timetable-url"),h=e.querySelector("#train-save-btn"),m=r.value.trim(),f=s.value.trim(),p=n.value.trim(),_=a.value,y=i.value,b=vr(d.value),g=vr(u.value),S=o.value.trim()||"",k=l.value.trim()||"",E=Array.from((c==null?void 0:c.files)||[]),L=t.value;if(!m||!f||!p||!_||!y){v(",    .","warning");return}if(k&&!S){v("   ,   .","warning");return}const $=h.innerHTML;h.disabled=!0,h.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const q=L||crypto.randomUUID(),T=Gs(g),C=[];if(S&&T.push({url:S,label:k||br(S,T.length)}),T.length+E.length>Vs){h.disabled=!1,h.innerHTML=$,v(` ${Vs} /   .`,"warning");return}if(E.length){const W=await fp(E,q);if(!W){h.disabled=!1,h.innerHTML=$;return}W.forEach(z=>{z!=null&&z.url&&T.push({url:z.url,label:z.label||br(z.url,T.length)}),z!=null&&z.objectPath&&C.push(z.objectPath)})}const x=Gs(T),D={number:m,origin_station:f,destination_station:p,departure_time:_,arrival_time:y,timetable_url:as(x)};let P;if(L)({error:P}=await w.from("trains").update(D).eq("id",L));else{const{data:W}=await w.auth.getUser(),z=((U=W==null?void 0:W.user)==null?void 0:U.email)??"web_app";({error:P}=await w.from("trains").insert({...D,id:q,created_from:z}))}if(h.disabled=!1,h.innerHTML=$,P){C.length&&await ns(C),v(P.message,"error");return}if(L){const W=b.map(ee=>ta(ee.url)).filter(Boolean),z=x.map(ee=>ta(ee.url)).filter(Boolean),H=new Set(z),K=W.filter(ee=>!H.has(ee));K.length&&await ns(K)}v(L?"  .":"  .","success"),Nt(e.querySelector("#train-modal")),Ra(e),await Ca(e)}function hp(e,t){const r=vr(t.timetableUrl);e.querySelector("#train-id").value=t.id,e.querySelector("#train-existing-timetable-url").value=as(r)||"",e.querySelector("#train-draft-timetable-url").value=as(r)||"",e.querySelector("#train-number").value=t.number??"",e.querySelector("#train-origin-station").value=t.originStation??"",e.querySelector("#train-destination-station").value=t.destinationStation??"",e.querySelector("#train-departure-time").value=lo(t.departureTime),e.querySelector("#train-arrival-time").value=lo(t.arrivalTime),e.querySelector("#train-timetable-file").value="",e.querySelector("#train-timetable-url").value="",e.querySelector("#train-timetable-label").value="",Ia(e,r),e.querySelector("#train-form-title").textContent="  ",e.querySelector("#train-save-btn").textContent=""}function Ra(e){e.querySelector("#train-id").value="",e.querySelector("#train-existing-timetable-url").value="",e.querySelector("#train-draft-timetable-url").value="",e.querySelector("#train-number").value="",e.querySelector("#train-origin-station").value="",e.querySelector("#train-destination-station").value="",e.querySelector("#train-departure-time").value="",e.querySelector("#train-arrival-time").value="",e.querySelector("#train-timetable-file").value="",e.querySelector("#train-timetable-url").value="",e.querySelector("#train-timetable-label").value="",Ia(e,[]),e.querySelector("#train-form-title").textContent=" ",e.querySelector("#train-save-btn").textContent=""}async function fp(e,t){var s;if(!Array.isArray(e)||!e.length||!t)return[];const r=[];for(const n of e){const i=(((s=n.name)==null?void 0:s.split(".").pop())||"pdf").toLowerCase().replace(/[^a-z0-9]/g,"")||"pdf",o=Math.random().toString(36).slice(2,10),l=`${t}/${Date.now()}-${o}.${i}`,{error:c}=await w.storage.from(ss).upload(l,n,{upsert:!0,contentType:n.type||void 0});if(c)return r.length&&await ns(r.map(u=>u.objectPath)),v(c.message,"error"),null;const{data:d}=w.storage.from(ss).getPublicUrl(l);if(!(d!=null&&d.publicUrl))return await ns([l,...r.map(u=>u.objectPath)]),v("  ,       .","error"),null;r.push({url:d.publicUrl,label:n.name||"",objectPath:l})}return r}function ta(e){const t=String(e||"").trim();if(!t)return"";if(!/^https?:\/\//i.test(t)){const r=t.replace(/^\/+/,""),s=`${ss}/`;return r.startsWith(s)?r.slice(s.length):""}try{const r=new URL(t),s=`/storage/v1/object/public/${ss}/`,n=r.pathname.indexOf(s);return n===-1?"":decodeURIComponent(r.pathname.slice(n+s.length))}catch{return""}}async function ns(e){const t=Array.from(new Set((e||[]).filter(Boolean)));t.length&&await w.storage.from(ss).remove(t)}async function mp(e,t){const r=t.querySelector("#train-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{count:n,error:a}=await w.from("duty_trains").select("duty_id",{count:"exact",head:!0}).eq("train_id",e);if(a){r.disabled=!1,r.innerHTML=s,v(a.message,"error");return}if((n||0)>0){r.disabled=!1,r.innerHTML=s,v("     ,     .","warning");return}const{data:i,error:o}=await w.from("trains").select("timetable_url").eq("id",e).maybeSingle();if(o){r.disabled=!1,r.innerHTML=s,v(o.message,"error");return}const{error:l}=await w.from("trains").delete().eq("id",e);if(r.disabled=!1,r.innerHTML=s,l){if(l.code==="23503"){v("     ,     .","warning");return}v(l.message,"error");return}const d=vr(i==null?void 0:i.timetable_url).map(u=>ta(u.url)).filter(Boolean);d.length&&await ns(d),v("  .","success"),Nt(t.querySelector("#train-delete-modal")),Ra(t),await Ca(t)}function Ia(e,t){const r=e.querySelector("#train-current-timetable-wrap"),s=e.querySelector("#train-current-timetable-links"),n=e.querySelector("#train-draft-timetable-url");if(!r||!s||!n)return;const a=Gs(t);if(n.value=as(a)||"",!a.length){r.classList.add("d-none"),s.innerHTML="";return}r.classList.remove("d-none"),s.innerHTML=a.map((i,o)=>{const l=i.label||br(i.url,o);return`
        <div class="border rounded p-2 w-100">
          <div class="mb-2 d-flex align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <a href="${dr(i.url)}" target="_blank" rel="noopener noreferrer"></a>
              <button
                type="button"
                class="btn btn-link btn-sm p-0 lh-1 text-decoration-none train-existing-timetable-preview"
                data-url="${dr(i.url)}"
                data-label="${dr(l)}"
                title=""
                aria-label=""
              >
                
              </button>
            </div>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger train-existing-timetable-remove"
              data-index="${o}"
            >
              
            </button>
          </div>
          <input
            type="text"
            class="form-control form-control-sm train-existing-timetable-label"
            data-index="${o}"
            value="${dr(l)}"
            placeholder="  /"
          />
        </div>
      `}).join("")}function vr(e){if(Array.isArray(e))return e.map((r,s)=>Ns(r,s)).filter(r=>r.url);const t=String(e||"").trim();if(!t)return[];if(t.startsWith("["))try{const r=JSON.parse(t);if(Array.isArray(r))return r.map((s,n)=>Ns(s,n)).filter(s=>s.url)}catch{return[{url:t,label:br(t,0)}]}return t.split(`
`).map((r,s)=>Ns(r,s)).filter(r=>r.url)}function Ns(e,t){if(e&&typeof e=="object"&&!Array.isArray(e)){const s=String(e.url||"").trim(),n=String(e.label||"").trim()||br(s,t);return{url:s,label:n}}const r=String(e||"").trim();return{url:r,label:br(r,t)}}function Gs(e){const t=new Set;return(e||[]).map((r,s)=>Ns(r,s)).filter(r=>!r.url||t.has(r.url)?!1:(t.add(r.url),!0))}function as(e){const t=Gs(e);return t.length?JSON.stringify(t):null}function br(e,t){const r=String(e||"").trim();if(!r)return` ${t+1}`;try{const n=new URL(r).pathname.split("/").pop()||"",a=decodeURIComponent(n);if(a)return a}catch{}return` ${t+1}`}function dr(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function co(e,t,r){const s=e.querySelector("#train-timetable-preview-modal"),n=e.querySelector("#train-timetable-preview-frame"),a=e.querySelector("#train-timetable-preview-text-wrap"),i=e.querySelector("#train-timetable-preview-text"),o=e.querySelector("#train-timetable-preview-csv-wrap"),l=e.querySelector("#train-timetable-preview-csv-note"),c=e.querySelector("#train-timetable-preview-csv-head"),d=e.querySelector("#train-timetable-preview-csv-body"),u=e.querySelector("#train-timetable-preview-title"),h=e.querySelector("#train-timetable-preview-fallback"),m=e.querySelector("#train-timetable-preview-open");if(!s||!n||!a||!i||!o||!l||!c||!d||!u||!h||!m)return;const f=String(t||"").trim();if(!f){v("   .","warning");return}const p=bp(f),_=ra(f),y=_==="csv",b=["txt","csv","json"].includes(_);u.textContent=r?`: ${r}`:"  ",m.setAttribute("href",f),h.classList.add("d-none"),a.classList.add("d-none"),o.classList.add("d-none"),l.textContent="",c.innerHTML="",d.innerHTML="",i.textContent="",n.classList.remove("d-none"),n.src="about:blank",y?(o.classList.remove("d-none"),n.classList.add("d-none"),yp(f,c,d,l,h)):b?(a.classList.remove("d-none"),n.classList.add("d-none"),i.textContent="...",vp(f,i,h)):(n.src=p,n.onload=()=>{if(p!==f){h.classList.add("d-none");return}const g=ra(f),S=["doc","docx","xls","xlsx","ppt","pptx"].includes(g);h.classList.toggle("d-none",!S)},n.onerror=()=>{h.classList.remove("d-none")}),Ms(s)}function pp(e){const t=e.querySelector("#train-timetable-preview-modal"),r=e.querySelector("#train-timetable-preview-frame"),s=e.querySelector("#train-timetable-preview-text-wrap"),n=e.querySelector("#train-timetable-preview-text"),a=e.querySelector("#train-timetable-preview-csv-wrap"),i=e.querySelector("#train-timetable-preview-csv-note"),o=e.querySelector("#train-timetable-preview-csv-head"),l=e.querySelector("#train-timetable-preview-csv-body"),c=e.querySelector("#train-timetable-preview-fallback"),d=e.querySelector("#train-timetable-preview-open");!t||!r||!s||!n||!a||!i||!o||!l||!c||!d||(r.src="about:blank",r.classList.remove("d-none"),s.classList.add("d-none"),a.classList.add("d-none"),n.textContent="",i.textContent="",o.innerHTML="",l.innerHTML="",d.setAttribute("href","#"),c.classList.add("d-none"),Nt(t))}async function yp(e,t,r,s,n){try{const a=await fetch(e,{cache:"no-store"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const i=await a.text(),o=gp(i);if(!o.length){t.innerHTML="",r.innerHTML="",s.textContent="  .",n.classList.add("d-none");return}const l=200,c=o.slice(0,l),d=c[0]||[],u=c.slice(1);t.innerHTML=`
      <tr>${d.map(h=>`<th>${dr(h)}</th>`).join("")}</tr>
    `,r.innerHTML=u.map(h=>`<tr>${h.map(m=>`<td>${dr(m)}</td>`).join("")}</tr>`).join(""),o.length>l?s.textContent=`   ${l}    ${o.length}.`:s.textContent=`: ${o.length}.`,n.classList.add("d-none")}catch{t.innerHTML="",r.innerHTML="",s.textContent="",n.classList.remove("d-none")}}function gp(e){const t=[];let r=[],s="",n=!1;for(let a=0;a<e.length;a+=1){const i=e[a],o=e[a+1];if(i==='"'){n&&o==='"'?(s+='"',a+=1):n=!n;continue}if(!n&&i===","){r.push(s),s="";continue}if(!n&&(i===`
`||i==="\r")){i==="\r"&&o===`
`&&(a+=1),r.push(s),t.push(r),r=[],s="";continue}s+=i}return(s.length||r.length)&&(r.push(s),t.push(r)),t}async function vp(e,t,r){try{const s=await fetch(e,{cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);const n=await s.text();t.textContent=n||"( )",r.classList.add("d-none")}catch{t.textContent="    .",r.classList.remove("d-none")}}function bp(e){const t=ra(e);return["doc","docx","xls","xlsx","ppt","pptx"].includes(t)?`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(e)}`:e}function ra(e){const t=String(e||"").trim();if(!t)return"";try{const s=new URL(t).pathname.split("/").pop()||"",n=s.includes(".")?s.split(".").pop():"";return String(n||"").toLowerCase()}catch{return""}}const F={profiles:[],employees:[],roleCatalog:[],availableRoles:[],roles:[],roleAuditLogs:[],currentUserId:"",currentUserProtectedAdminIds:[],permissionsRole:"admin",permissions:[]},_p={admin:"",crew_manager:" ",head_of_transport:" ",crew_instructor:" ",instructor:"",crew:"",crew_member:" ",user:""};function pe(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#39;")}function ml(e){const t=String((e==null?void 0:e.username)||"").trim(),r=String((e==null?void 0:e.id)||"").trim(),s=(e==null?void 0:e.is_active)===!1;if(t&&r)return`${t} (${r})${s?" ()":""}`;const n=t||r||"-";return s&&n!=="-"?`${n} ()`:n}function pl(e){const t=String((e==null?void 0:e.first_name)||"").trim(),r=String((e==null?void 0:e.last_name)||"").trim(),s=`${t} ${r}`.trim();return s?(e==null?void 0:e.is_active)===!1?`${s} ()`:s:"-"}function is(e){const t=String(e||"").trim().toLowerCase();return t?_p[t]||e:"-"}const yl=[{value:"none",label:" "},{value:"all",label:""},{value:"own",label:""},{value:"role_attached_employees",label:"    "}],Sp=[{value:"none",label:""},{value:"all",label:""}],wp=[{value:"none",label:""},{value:"all",label:""}];function sa(e){const t=e.querySelector("#admin-role-profile-id"),r=e.querySelector("#admin-profile-link-id"),s=e.querySelector("#admin-profile-link-employee-id"),n=(t==null?void 0:t.value)||"",a=(r==null?void 0:r.value)||"",i=(s==null?void 0:s.value)||"",o=F.profiles.map(c=>{const d=ml(c);return`<option value="${c.id}">${pe(d)}</option>`}).join("");t&&(t.innerHTML=`<option value=""> </option>${o}`,t.value=F.profiles.some(c=>c.id===n)?n:""),r&&(r.innerHTML=`<option value=""> </option>${o}`,r.value=F.profiles.some(c=>c.id===a)?a:"");const l=F.employees.map(c=>{const d=pl(c);return`<option value="${c.id}">${pe(d)}</option>`}).join("");s&&(s.innerHTML=`<option value=""> </option>${l}`,s.value=F.employees.some(c=>c.id===i)?i:"")}function na(e,t){const r=e.querySelector("#admin-roles-body"),s=e.querySelector("#admin-roles-empty");if(!r||!s)return;if(!F.roles.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none");const n=F.roles.filter(a=>String((a==null?void 0:a.role)||"").trim().toLowerCase()==="admin").length;r.innerHTML=F.roles.map(a=>{const i=(a==null?void 0:a.username)||(a==null?void 0:a.user_id)||"-",o=a!=null&&a.role?kp(a.role):"-",l=(a==null?void 0:a.granted_by_username)||(a==null?void 0:a.granted_by_user_id)||"-",c=(a==null?void 0:a.user_id)||"",d=!!(a!=null&&a.role),u=String((a==null?void 0:a.role)||"").trim().toLowerCase()==="admin",h=u&&n<=1,m=u&&c&&F.currentUserProtectedAdminIds.includes(c),f=!d||h||m,p=[d?`<span class="badge text-bg-secondary">${pe(o)}</span>`:'<span class="text-secondary">-</span>',m?'<span class="badge text-bg-info"> grantor lineage</span>':""].filter(Boolean).join(" "),_=h?"      .":m?"        grantor .":"";return`
        <tr>
          <td>${pe(i)}</td>
          <td>${p}</td>
          <td>${d?pe(l):'<span class="text-secondary">-</span>'}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-admin-action="add-role"
                data-user-id="${c}"
                data-username="${pe(i)}"
              >
                 
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-admin-action="remove-role"
                data-role-id="${a.id||""}"
                ${f?"disabled":""}
                title="${_}"
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}function aa(e,t){const r=e.querySelector("#admin-role-catalog-body"),s=e.querySelector("#admin-role-catalog-empty");if(!(!r||!s)){if(!F.roleCatalog.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=F.roleCatalog.map(n=>{const a=String((n==null?void 0:n.name)||"").trim(),i=String((n==null?void 0:n.display_name_bg)||"").trim()||is(a),o=a==="admin";return`
        <tr>
          <td>${pe(a)}</td>
          <td>${pe(i)}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-admin-action="edit-catalog-role"
                data-role-name="${pe(a)}"
                data-role-bg="${pe(i)}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                data-admin-action="delete-catalog-role"
                data-role-name="${pe(a)}"
                ${o?"disabled":""}
              >
                
              </button>
            </div>
          </td>
        </tr>
      `}).join("")}}function ia(e,t){const r=e.querySelector("#admin-profiles-body"),s=e.querySelector("#admin-profiles-empty");if(!(!r||!s)){if(!F.profiles.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=F.profiles.map(n=>{const a=ml(n),i=(n==null?void 0:n.is_active)!==!1,o=i?'<span class="badge text-bg-success"></span>':'<span class="badge text-bg-secondary"></span>',l=n!=null&&n.employees?pl(n.employees):"-",c=!!(n!=null&&n.employee_id),d=String((n==null?void 0:n.id)||"")===String(F.currentUserId||""),u=!i||d,h=i,m=d;return`
        <tr>
          <td>${pe(a)}</td>
          <td>${o}</td>
          <td>${pe(l)}</td>
          <td class="text-end">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary me-2"
              data-admin-action="link-profile"
              data-profile-id="${n.id}"
            >
              
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger me-2"
              data-admin-action="unlink-profile"
              data-profile-id="${n.id}"
              ${c?"":"disabled"}
            >
              
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-warning me-2"
              data-admin-action="deactivate-profile"
              data-profile-id="${n.id}"
              ${u?"disabled":""}
              title="${d?"      .":""}"
            >
              
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-success"
              data-admin-action="restore-profile"
              data-profile-id="${n.id}"
              ${h?"disabled":""}
            >
              
            </button>
            <button
              type="button"
              class="btn btn-sm btn-danger ms-2"
              data-admin-action="hard-delete-user"
              data-profile-id="${n.id}"
              ${m?"disabled":""}
              title="${d?"      .":"  (Auth +  + )."}"
            >
              
            </button>
          </td>
        </tr>
      `}).join("")}}function oa(e,t){const r=e.querySelector("#admin-permissions-body"),s=e.querySelector("#admin-permissions-empty");if(!(!r||!s)){if(!F.permissions.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"   .";return}s.classList.add("d-none"),r.innerHTML=F.permissions.map(n=>{const a=String((n==null?void 0:n.resource)||"-"),i=String((n==null?void 0:n.display_name_bg)||"").trim()||tn(a),o=Rr(n==null?void 0:n.view_screen_scope),l=Rr(n==null?void 0:n.view_records_scope),c=Rr(n==null?void 0:n.create_records_scope),d=Rr(n==null?void 0:n.edit_records_scope),u=Rr(n==null?void 0:n.delete_records_scope);return`
        <tr data-resource="${pe(a)}">
          <td>${pe(i)}</td>
          <td class="text-center">
            ${Cr("view_screen_scope",o)}
          </td>
          <td class="text-center">
            ${Cr("view_records_scope",l)}
          </td>
          <td class="text-center">
            ${Cr("create_records_scope",c)}
          </td>
          <td class="text-center">
            ${Cr("edit_records_scope",d)}
          </td>
          <td class="text-center">
            ${Cr("delete_records_scope",u)}
          </td>
        </tr>
      `}).join("")}}function la(e,t){const r=e.querySelector("#admin-role-audit-body"),s=e.querySelector("#admin-role-audit-empty");if(!(!r||!s)){if(!F.roleAuditLogs.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"    .";return}s.classList.add("d-none"),r.innerHTML=F.roleAuditLogs.map(n=>{const a=String((n==null?void 0:n.action)||"").trim(),i=a==="grant"?"":a==="revoke"?"":"",o=(n==null?void 0:n.role_label)||"-",l=(n==null?void 0:n.actor_label)||"-",c=(n==null?void 0:n.target_label)||"-",d=Lp(n==null?void 0:n.occurred_at);return`
        <tr>
          <td>${pe(d)}</td>
          <td>${pe(i)}</td>
          <td>${pe(o)}</td>
          <td>${pe(l)}</td>
          <td>${pe(c)}</td>
        </tr>
      `}).join("")}}function Cr(e,t){const s=(e==="view_screen_scope"?Sp:e==="create_records_scope"?wp:yl).map(n=>{const a=n.value===t?"selected":"";return`<option value="${n.value}" ${a}>${pe(n.label)}</option>`}).join("");return`<select class="form-select form-select-sm" data-permission-field="${e}">${s}</select>`}function Rr(e){const t=String(e||"").trim();return yl.some(r=>r.value===t)?t:"none"}function kp(e){const t=String(e||"").trim();if(!t)return"-";const r=F.roleCatalog.find(n=>(n==null?void 0:n.name)===t);return r&&String((r==null?void 0:r.display_name_bg)||"").trim()||is(t)}function Lp(e){if(!e)return"-";const t=new Date(e);return Number.isNaN(t.getTime())?"-":t.toLocaleString("bg-BG")}const qp=["admin","head_of_transport","instructor","crew","user"],uo={admin:10,crew_manager:20,head_of_transport:30,crew_instructor:40,instructor:50,crew:60,crew_member:70,user:80};let er=null;async function Tp(e){const t=await ue("../admin.html",import.meta.url);e.innerHTML=t;const r=e.querySelector("#admin-permissions-banner-toggle"),s=e.querySelector("#admin-permissions-role");r&&(r.checked=Ho()),s&&(s.value=F.permissionsRole),Js(e),jp(e),Ep(e),await Da(e),await us(e,F.permissionsRole)}function Ep(e){const t=e.querySelector("#admin-assign-role-modal"),r=e.querySelector("#admin-assign-role-modal-close"),s=e.querySelector("#admin-assign-role-modal-cancel"),n=e.querySelector("#admin-profile-link-modal"),a=e.querySelector("#admin-profile-link-modal-close"),i=e.querySelector("#admin-profile-link-modal-cancel"),o=e.querySelector("#open-admin-role-modal"),l=e.querySelector("#admin-role-modal"),c=e.querySelector("#admin-role-modal-form"),d=e.querySelector("#admin-role-modal-close"),u=e.querySelector("#admin-role-modal-cancel"),h=e.querySelector("#admin-role-warning-modal"),m=e.querySelector("#admin-role-warning-close"),f=e.querySelector("#admin-role-warning-cancel"),p=e.querySelector("#admin-role-warning-confirm"),_=e.querySelector("#admin-role-form"),y=e.querySelector("#admin-profile-link-form"),b=e.querySelector("#admin-profile-link-clear"),g=e.querySelector("#admin-permissions-form"),S=e.querySelector("#admin-permissions-role"),k=e.querySelector("#admin-permissions-banner-toggle"),E=e.querySelector("#admin-roles-body"),L=e.querySelector("#admin-role-catalog-body"),$=e.querySelector("#admin-profiles-body");r==null||r.addEventListener("click",()=>{Pe(t)}),s==null||s.addEventListener("click",()=>{Pe(t)}),a==null||a.addEventListener("click",()=>{Pe(n)}),i==null||i.addEventListener("click",()=>{Pe(n)}),o==null||o.addEventListener("click",()=>{fo(e,{mode:"create"})}),c==null||c.addEventListener("submit",async q=>{q.preventDefault(),await Cp(e)}),d==null||d.addEventListener("click",()=>{Pe(l),Js(e)}),u==null||u.addEventListener("click",()=>{Pe(l),Js(e)}),m==null||m.addEventListener("click",()=>{Pe(h),er=null}),f==null||f.addEventListener("click",()=>{Pe(h),er=null}),p==null||p.addEventListener("click",async()=>{if(!er){Pe(h);return}const q=er;er=null,Pe(h),await q()}),_==null||_.addEventListener("submit",async q=>{q.preventDefault(),await Rp(e)}),y==null||y.addEventListener("submit",async q=>{q.preventDefault(),await Dp(e)}),b==null||b.addEventListener("click",async()=>{var T;const q=((T=e.querySelector("#admin-profile-link-id"))==null?void 0:T.value)||"";if(!q){v("   .","warning");return}ft(e,{message:"  ,       ?",confirmLabel:"",onConfirm:()=>ca(e,q,null)})}),g==null||g.addEventListener("submit",async q=>{q.preventDefault(),await Up(e)}),S==null||S.addEventListener("change",async q=>{const T=q.target.value||"admin";F.permissionsRole=T,await us(e,T)}),k==null||k.addEventListener("change",q=>{var T;pu(!!((T=q.target)!=null&&T.checked)),v("    .","success")}),E==null||E.addEventListener("click",async q=>{const T=q.target.closest('button[data-admin-action="add-role"]');if(T){const x=T.getAttribute("data-user-id")||"";if(!x)return;xp(e,x);return}const C=q.target.closest('button[data-admin-action="remove-role"]');if(!C)return;const A=C.getAttribute("data-role-id")||"";A&&ft(e,{message:"  ,        ?",confirmLabel:"",onConfirm:()=>Ip(e,A)})}),L==null||L.addEventListener("click",async q=>{const T=q.target.closest('button[data-admin-action="edit-catalog-role"]');if(T){const x=T.getAttribute("data-role-name")||"",D=T.getAttribute("data-role-bg")||"";fo(e,{mode:"edit",roleName:x,roleNameBg:D});return}const C=q.target.closest('button[data-admin-action="delete-catalog-role"]');if(!C)return;const A=C.getAttribute("data-role-name")||"";A&&await Np(e,A)}),$==null||$.addEventListener("click",async q=>{const T=q.target.closest('button[data-admin-action="link-profile"]');if(T){const U=T.getAttribute("data-profile-id")||"";U&&Ap(e,U);return}const C=q.target.closest('button[data-admin-action="unlink-profile"]');if(C){const U=C.getAttribute("data-profile-id")||"";if(!U)return;ft(e,{message:"  ,       ?",confirmLabel:"",onConfirm:()=>ca(e,U,null)});return}const A=q.target.closest('button[data-admin-action="deactivate-profile"]');if(A){const U=A.getAttribute("data-profile-id")||"";if(!U)return;if(U===F.currentUserId){v("      .","warning");return}ft(e,{message:"  ,      ?      .",confirmLabel:"",onConfirm:()=>ho(e,U,!1)});return}const x=q.target.closest('button[data-admin-action="restore-profile"]');if(x){const U=x.getAttribute("data-profile-id")||"";if(!U)return;ft(e,{message:"  ,      ?",confirmLabel:"",onConfirm:()=>ho(e,U,!0)});return}const D=q.target.closest('button[data-admin-action="hard-delete-user"]');if(!D)return;const P=D.getAttribute("data-profile-id")||"";if(P){if(P===F.currentUserId){v("      .","warning");return}ft(e,{message:"  ?   :    Auth ,   .",confirmLabel:"",onConfirm:()=>$p(e,P)})}})}async function $p(e,t){if(!t)return;const r=async()=>{var f,p;const{data:d,error:u}=await w.auth.refreshSession();if(!u&&((f=d==null?void 0:d.session)!=null&&f.access_token))return d.session.access_token;const{data:h,error:m}=await w.auth.getSession();return m||!((p=h==null?void 0:h.session)!=null&&p.access_token)?"":h.session.access_token};let s=await r();if(!s){v("  .     .","warning");return}const n="https://ujxczpaupfqaiqrcoykl.supabase.co",a="sb_publishable_EJ7wzzBh1hnKE0j_j7E1mQ_9TAJvRoO",i="admin-hard-delete-user-v2",o=async d=>fetch(`${n}/functions/v1/${i}`,{method:"POST",headers:{"Content-Type":"application/json",apikey:a,Authorization:`Bearer ${d}`},body:JSON.stringify({userId:t,reason:"admin_panel"})});let l;try{l=await o(s)}catch{v("   Edge .","error");return}let c=null;try{c=await l.json()}catch{c=null}if(l.status===401&&(s=await r(),s))try{l=await o(s),c=null;try{c=await l.json()}catch{c=null}}catch{v("   Edge .","error");return}if(!l.ok){const d=String((c==null?void 0:c.error)||(c==null?void 0:c.message)||l.statusText||"   .");if(l.status===401){v("    Edge .  logout/login.","warning");return}if(String(d).toLowerCase().includes("last admin")){v("      .","warning");return}v(d,"error");return}if(!(c!=null&&c.ok)){v("   .","error");return}v("  .","success"),await Da(e)}function Ap(e,t){const r=e.querySelector("#admin-profile-link-modal"),s=e.querySelector("#admin-profile-link-id"),n=e.querySelector("#admin-profile-link-employee-id"),a=F.profiles.find(i=>i.id===t);s&&(s.value=t),n&&(n.value=(a==null?void 0:a.employee_id)||""),ln(r)}function xp(e,t){const r=e.querySelector("#admin-assign-role-modal"),s=e.querySelector("#admin-role-profile-id"),n=e.querySelector("#admin-role-value");s&&(s.value=t),n&&(n.value=""),ln(r)}async function Da(e){var h;const{data:t}=await w.auth.getUser();F.currentUserId=((h=t==null?void 0:t.user)==null?void 0:h.id)||"";const[{data:r,error:s},{data:n,error:a},{data:i,error:o},{data:l,error:c},{data:d,error:u}]=await Promise.all([w.from("user_profiles").select("id, username, is_active, employee_id, employees(id, first_name, last_name, is_active)").order("username",{ascending:!0}),w.from("employees").select("id, first_name, last_name, is_active").order("last_name",{ascending:!0}).order("first_name",{ascending:!0}),w.from("user_roles").select("id, user_id, role, granted_by_user_id").order("role",{ascending:!0}).order("created_at",{ascending:!1}),w.from("roles").select("name, display_name_bg").order("name",{ascending:!0}),w.from("user_role_audit_logs").select("id, action, role, actor_user_id, target_user_id, occurred_at").order("occurred_at",{ascending:!1}).limit(100)]);if(s||a||o||c||u){v((s==null?void 0:s.message)||(a==null?void 0:a.message)||(o==null?void 0:o.message)||(c==null?void 0:c.message)||(u==null?void 0:u.message)||"     .","error"),F.profiles=[],F.employees=[],F.roleCatalog=[],F.availableRoles=[],F.roles=[],F.roleAuditLogs=[],F.currentUserProtectedAdminIds=[],sa(e),aa(e,"  ."),na(e,"   ."),la(e,"    ."),ia(e,"   .");return}F.profiles=r||[],F.employees=n||[],F.roleCatalog=l||[],F.roles=Pp(i||[],F.profiles),F.roleAuditLogs=vl(d||[],F.profiles),F.currentUserProtectedAdminIds=bl(F.roles),F.availableRoles=_l(l||[],i||[]),Sl(e),sa(e),aa(e),na(e),la(e),ia(e)}async function Cp(e){var p,_;const t=e.querySelector("#admin-role-modal-original-name"),r=e.querySelector("#admin-role-modal-name"),s=e.querySelector("#admin-role-modal-name-bg"),n=e.querySelector("#admin-role-modal-save"),a=((p=t==null?void 0:t.value)==null?void 0:p.trim())||"",i=(r==null?void 0:r.value)||"",o=(s==null?void 0:s.value)||"",l=i.trim().toLowerCase(),c=o.trim();if(!l){v("   .","warning");return}if(!c){v("     .","warning");return}if(!/^[a-z0-9_]+$/.test(l)){v("       ,   _.","warning");return}const d=(n==null?void 0:n.innerHTML)||"";n&&(n.disabled=!0,n.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{data:u}=await w.auth.getUser();let h=null;if(a){const{error:y}=await w.from("roles").update({name:l,display_name_bg:c||l}).eq("name",a);h=y}else{const{error:y}=await w.from("roles").insert({name:l,display_name_bg:c||l,created_from:((_=u==null?void 0:u.user)==null?void 0:_.email)||"admin_panel"});h=y}if(h){n&&(n.disabled=!1,n.innerHTML=d),v(h.message,"error");return}const m=[...new Map(F.permissions.map(y=>[y.resource,y]).filter(([y])=>!!y)).values()];if(m.length){const y=m.map(g=>({role:l,resource:g.resource,display_name_bg:g.display_name_bg||tn(g.resource),view_screen_scope:"none",view_records_scope:"none",create_records_scope:"none",edit_records_scope:"none",delete_records_scope:"none"})),{error:b}=await w.from("role_permissions").upsert(y,{onConflict:"role,resource"});if(b){n&&(n.disabled=!1,n.innerHTML=d),v(b.message,"error");return}}r&&(r.value=""),s&&(s.value=""),t&&(t.value=""),n&&(n.disabled=!1,n.innerHTML=d),v(a?"  .":"  .","success"),await wl(e);const f=e.querySelector("#admin-permissions-role");f&&(f.value=l),F.permissionsRole=l,await us(e,l),Pe(e.querySelector("#admin-role-modal")),Js(e)}async function Rp(e){var c,d,u,h;const t=((c=e.querySelector("#admin-role-profile-id"))==null?void 0:c.value)||"",r=((d=e.querySelector("#admin-role-value"))==null?void 0:d.value)||"",s=e.querySelector("#admin-role-add");if(!t||!r){v("   .","warning");return}const n=(s==null?void 0:s.innerHTML)||"";s&&(s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{data:a}=await w.auth.getUser(),{error:i}=await w.from("user_roles").insert({user_id:t,role:r,granted_by_user_id:((u=a==null?void 0:a.user)==null?void 0:u.id)||null,created_from:((h=a==null?void 0:a.user)==null?void 0:h.email)||"admin_panel"});if(s&&(s.disabled=!1,s.innerHTML=n),i){v(i.message,"error");return}v("  .","success"),Pe(e.querySelector("#admin-assign-role-modal"));const o=e.querySelector("#admin-role-profile-id"),l=e.querySelector("#admin-role-value");o&&(o.value=""),l&&(l.value=""),await Promise.all([Oa(e),gl(e)])}async function Ip(e,t){const{error:r}=await w.from("user_roles").delete().eq("id",t);if(r){if(String(r.message||"").toLowerCase().includes("last admin")){v("       .","warning");return}if(String(r.message||"").toLowerCase().includes("grantor")){v("        grantor .","warning");return}v(r.message,"error");return}v("  .","success"),await Promise.all([Oa(e),gl(e)])}async function Dp(e){var s,n;const t=((s=e.querySelector("#admin-profile-link-id"))==null?void 0:s.value)||"",r=((n=e.querySelector("#admin-profile-link-employee-id"))==null?void 0:n.value)||"";if(!t||!r){v("   .","warning");return}await ca(e,t,r)}async function ca(e,t,r){const s=e.querySelector("#admin-profile-link-save"),n=(s==null?void 0:s.innerHTML)||"";if(s&&(s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...'),r){const{error:l}=await w.from("user_profiles").update({employee_id:null,updated_at:new Date().toISOString()}).eq("employee_id",r).neq("id",t);if(l){s&&(s.disabled=!1,s.innerHTML=n),v(l.message,"error");return}}const{error:a}=await w.from("user_profiles").update({employee_id:r,updated_at:new Date().toISOString()}).eq("id",t);if(s&&(s.disabled=!1,s.innerHTML=n),a){v(a.message,"error");return}v(r?"    .":"    .","success"),Pe(e.querySelector("#admin-profile-link-modal"));const i=e.querySelector("#admin-profile-link-id"),o=e.querySelector("#admin-profile-link-employee-id");i&&(i.value=""),o&&(o.value=""),await Hp(e)}async function ho(e,t,r){if(!t)return;const s=F.profiles.find(i=>String((i==null?void 0:i.id)||"")===String(t));if((s==null?void 0:s.is_active)!==!1===r){v(r?"   .":"   .","warning");return}const{error:a}=await w.from("user_profiles").update({is_active:r,updated_at:new Date().toISOString()}).eq("id",t);if(a){if(String(a.message||"").toLowerCase().includes("last active admin")){v("      .","warning");return}v(a.message,"error");return}v(r?"  .":"  .","success"),await Da(e)}async function Oa(e){const{data:t,error:r}=await w.from("user_roles").select("id, user_id, role, granted_by_user_id").order("created_at",{ascending:!1});if(r){v(r.message,"error");return}F.roles=Op(t||[],F.profiles),F.currentUserProtectedAdminIds=bl(F.roles),na(e)}async function gl(e){const{data:t,error:r}=await w.from("user_role_audit_logs").select("id, action, role, actor_user_id, target_user_id, occurred_at").order("occurred_at",{ascending:!1}).limit(100);if(r){v(r.message,"error");return}F.roleAuditLogs=vl(t||[],F.profiles),la(e)}function vl(e,t){const r=new Map((t||[]).map(s=>[s.id,s]));return(e||[]).map(s=>{const n=r.get(s.actor_user_id),a=r.get(s.target_user_id),i=String((s==null?void 0:s.role)||"").trim();return{...s,role_label:i?is(i):"-",actor_label:(n==null?void 0:n.username)||(s==null?void 0:s.actor_user_id)||"-",target_label:(a==null?void 0:a.username)||(s==null?void 0:s.target_user_id)||"-"}})}function bl(e){const t=String(F.currentUserId||"").trim();if(!t)return[];const r=(e||[]).filter(c=>String((c==null?void 0:c.role)||"").trim().toLowerCase()==="admin"),s=new Map(r.map(c=>[String((c==null?void 0:c.user_id)||"").trim(),String((c==null?void 0:c.granted_by_user_id)||"").trim()])),n=(e||[]).find(c=>String((c==null?void 0:c.user_id)||"").trim()===t&&String((c==null?void 0:c.role)||"").trim().toLowerCase()==="admin"),a=String((n==null?void 0:n.granted_by_user_id)||"").trim();if(!a)return[];const i=[],o=new Set([t]);let l=a;for(;l&&!o.has(l);){i.push(l),o.add(l);const c=String(s.get(l)||"").trim();if(!c||c===l)break;l=c}return i}function Op(e,t){const r=new Map((t||[]).map(s=>[s.id,s]));return(e||[]).map(s=>{var n,a;return{...s,username:((n=r.get(s.user_id))==null?void 0:n.username)||"",granted_by_username:((a=r.get(s.granted_by_user_id))==null?void 0:a.username)||""}})}function Pp(e,t){const r=new Map((t||[]).map(a=>[a.id,a])),s=new Map;(e||[]).forEach(a=>{s.has(a.user_id)||s.set(a.user_id,[]),s.get(a.user_id).push(a)});const n=[];return(t||[]).forEach(a=>{const i=s.get(a.id)||[];i.length>0?i.forEach(o=>{var l;n.push({...o,username:a.username,user_id:a.id,granted_by_username:((l=r.get(o.granted_by_user_id))==null?void 0:l.username)||""})}):n.push({id:null,user_id:a.id,role:null,username:a.username,granted_by_user_id:null,granted_by_username:""})}),n}function _l(e,t){const r=(e||[]).map(a=>String((a==null?void 0:a.name)||"").trim()).filter(Boolean),s=(t||[]).map(a=>String((a==null?void 0:a.role)||"").trim()).filter(Boolean);return[...new Set([...qp,...r,...s])].sort((a,i)=>{const o=String(a||"").trim().toLowerCase(),l=String(i||"").trim().toLowerCase(),c=uo[o]??999,d=uo[l]??999;return c!==d?c-d:o.localeCompare(l,"en")})}function Sl(e){const t=e.querySelector("#admin-role-value"),r=e.querySelector("#admin-permissions-role"),s=(t==null?void 0:t.value)||"",n=(r==null?void 0:r.value)||F.permissionsRole||"",a=F.availableRoles.map(i=>{const o=kl(i);return`<option value="${i}">${o}</option>`}).join("");if(t&&(t.innerHTML=`<option value=""> </option>${a}`,t.value=F.availableRoles.includes(s)?s:""),r){r.innerHTML=a;const i=F.availableRoles.includes("admin")?"admin":F.availableRoles[0]||"",o=F.availableRoles.includes(n)?n:i;r.value=o,F.permissionsRole=o}}async function wl(e){const{data:t,error:r}=await w.from("roles").select("name, display_name_bg").order("name",{ascending:!0});if(r){v(r.message,"error");return}F.roleCatalog=t||[],F.availableRoles=_l(t||[],F.roles),Sl(e),aa(e)}function kl(e){const t=F.roleCatalog.find(s=>(s==null?void 0:s.name)===e),r=String((t==null?void 0:t.display_name_bg)||"").trim();return r||is(e)}async function Mp(e,t){if(!t)return;if(t==="admin"){v(" admin     .","warning");return}const{error:r}=await w.from("role_permissions").delete().eq("role",t);if(r){v(r.message,"error");return}const{error:s}=await w.from("roles").delete().eq("name",t);if(s){v(s.message,"error");return}if(v("  .","success"),await wl(e),await Oa(e),F.permissionsRole===t){const n=F.availableRoles.includes("admin")?"admin":F.availableRoles[0]||"";F.permissionsRole=n,n?await us(e,n):(F.permissions=[],oa(e,"   ."))}}function fo(e,{mode:t,roleName:r="",roleNameBg:s=""}){const n=e.querySelector("#admin-role-modal"),a=e.querySelector("#admin-role-modal-title"),i=e.querySelector("#admin-role-modal-original-name"),o=e.querySelector("#admin-role-modal-name"),l=e.querySelector("#admin-role-modal-name-bg"),c=e.querySelector("#admin-role-modal-save");i&&(i.value=t==="edit"?r:""),o&&(o.value=t==="edit"?r:""),l&&(l.value=t==="edit"?s||r:""),a&&(a.textContent=t==="edit"?"  ":" "),c&&(c.textContent=t==="edit"?"":""),ln(n)}function Js(e){const t=e.querySelector("#admin-role-modal-original-name"),r=e.querySelector("#admin-role-modal-name"),s=e.querySelector("#admin-role-modal-name-bg"),n=e.querySelector("#admin-role-modal-title"),a=e.querySelector("#admin-role-modal-save");t&&(t.value=""),r&&(r.value=""),s&&(s.value=""),n&&(n.textContent=" "),a&&(a.textContent="")}function ft(e,{message:t,confirmLabel:r,onConfirm:s}){const n=e.querySelector("#admin-role-warning-modal"),a=e.querySelector("#admin-role-warning-message"),i=e.querySelector("#admin-role-warning-confirm");er=typeof s=="function"?s:null,a&&(a.textContent=t||"  ?"),i&&(i.textContent=r||""),ln(n)}async function Np(e,t){const{count:r,error:s}=await w.from("user_roles").select("id",{count:"exact",head:!0}).eq("role",t);if(s){v(s.message,"error");return}const n=kl(t),a=Number(r||0);if(a>0){ft(e,{message:` "${n}"     ,     ${a} ().      .`,confirmLabel:"",onConfirm:null});return}ft(e,{message:`  ,      "${n}"?         .`,confirmLabel:"",onConfirm:()=>Mp(e,t)})}function ln(e){e&&e.classList.remove("d-none")}function Pe(e){e&&e.classList.add("d-none")}function jp(e){var a,i;const t=[...e.querySelectorAll("[data-admin-tab]")],r=[...e.querySelectorAll("[data-admin-tab-pane]")];if(!t.length||!r.length)return;const s=o=>{t.forEach(l=>{const c=l.getAttribute("data-admin-tab")===o;l.classList.toggle("active",c),l.setAttribute("aria-selected",c?"true":"false")}),r.forEach(l=>{const c=l.getAttribute("data-admin-tab-pane")===o;l.classList.toggle("active",c),l.classList.toggle("d-none",!c)})};t.forEach(o=>{o.addEventListener("click",()=>{const l=o.getAttribute("data-admin-tab")||"";l&&s(l)})});const n=((a=t.find(o=>o.classList.contains("active")))==null?void 0:a.getAttribute("data-admin-tab"))||((i=t[0])==null?void 0:i.getAttribute("data-admin-tab"))||"";n&&s(n)}async function Hp(e){const{data:t,error:r}=await w.from("user_profiles").select("id, username, is_active, employee_id, employees(id, first_name, last_name, is_active)").order("username",{ascending:!0});if(r){v(r.message,"error");return}F.profiles=t||[],sa(e),ia(e)}async function us(e,t){const r=t||"admin",{data:s,error:n}=await w.from("role_permissions").select("role, resource, display_name_bg, view_screen_scope, view_records_scope, create_records_scope, edit_records_scope, delete_records_scope").eq("role",r).order("resource",{ascending:!0});if(n){v(n.message,"error"),F.permissions=[],oa(e,"   .");return}F.permissions=s||[],oa(e)}async function Up(e){const t=e.querySelector("#admin-permissions-save"),r=e.querySelector("#admin-permissions-role"),s=(r==null?void 0:r.value)||"admin",n=[...e.querySelectorAll("#admin-permissions-body tr[data-resource]")];if(!n.length){v("   .","warning");return}const a=n.map(l=>{const c=l.getAttribute("data-resource")||"",d=F.permissions.find(h=>h.resource===c),u=h=>{var f;const m=((f=l.querySelector(`[data-permission-field="${h}"]`))==null?void 0:f.value)||"none";return h==="view_screen_scope"||h==="create_records_scope"?["none","all"].includes(m)?m:"none":["none","all","own","role_attached_employees"].includes(m)?m:"none"};return{role:s,resource:c,display_name_bg:(d==null?void 0:d.display_name_bg)||tn(c),view_screen_scope:u("view_screen_scope"),view_records_scope:u("view_records_scope"),create_records_scope:u("create_records_scope"),edit_records_scope:u("edit_records_scope"),delete_records_scope:u("delete_records_scope"),updated_at:new Date().toISOString()}}),i=(t==null?void 0:t.innerHTML)||"";t&&(t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const{error:o}=await w.from("role_permissions").upsert(a,{onConflict:"role,resource"});if(t&&(t.disabled=!1,t.innerHTML=i),o){v(o.message,"error");return}v("  .","success"),await us(e,s)}function Et(e){e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const mo=new Map;function Fp(e,t){const r=mo.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){Fe(a);return}}};mo.set(e,s),document.addEventListener("keydown",s)}function Fe(e){var t,r,s,n,a;e.classList.add("d-none"),(t=document.querySelector("#document-category-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#document-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#document-category-delete-modal"))!=null&&s.classList.contains("d-none"))&&((n=document.querySelector("#document-delete-modal"))!=null&&n.classList.contains("d-none"))&&((a=document.querySelector("#document-preview-modal"))!=null&&a.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function je(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const xe={categories:[],documents:[],searchQuery:"",categoryFilter:""};async function Bp(e){const{data:t,error:r}=await w.from("document_categories").select("id, name").order("name",{ascending:!0});if(r){v(r.message,"error"),xe.categories=[],po(e,"    .");return}xe.categories=t||[],po(e),Pa(e)}async function Kp(e){const{data:t,error:r}=await w.from("documents").select("id, title, document_url, storage_path, notes, category_id, document_categories(name)").order("title",{ascending:!0});if(r){v(r.message,"error"),xe.documents=[],Qs(e,"    .");return}xe.documents=t||[],Qs(e)}function Pa(e){const t=e.querySelector("#documents-category-filter"),r=e.querySelector("#document-category"),s=(xe.categories||[]).map(n=>`<option value="${n.id}">${je(n.name||"-")}</option>`).join("");t&&(t.innerHTML='<option value=""></option>'+s,t.value=xe.categoryFilter||""),r&&(r.innerHTML='<option value=""> </option>'+s)}function po(e,t){const r=e.querySelector("#document-categories-table-body"),s=e.querySelector("#document-categories-empty"),n=xe.categories||[];if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>`
      <tr>
        <td>${je(a.name||"-")}</td>
        <td class="text-end">
          <div class="d-inline-flex gap-2">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              data-category-action="edit"
              data-id="${a.id}"
              data-name="${je(a.name||"")}"
            >
              
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              data-category-action="delete"
              data-id="${a.id}"
            >
              
            </button>
          </div>
        </td>
      </tr>
    `).join("")}function Qs(e,t){const r=e.querySelector("#documents-table-body"),s=e.querySelector("#documents-empty"),n=(xe.documents||[]).filter(a=>{const i=!xe.searchQuery||String((a==null?void 0:a.title)||"").toLowerCase().includes(xe.searchQuery),o=!xe.categoryFilter||String((a==null?void 0:a.category_id)||"")===String(xe.categoryFilter||"");return i&&o});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{var i;return`
      <tr>
        <td>${je(a.title||"-")}</td>
        <td>${je(((i=a.document_categories)==null?void 0:i.name)||"-")}</td>
        <td>
          <div class="d-inline-flex gap-2 align-items-center">
            <button
              type="button"
              class="btn btn-link btn-sm p-0 lh-1 text-decoration-none"
              data-document-action="preview"
              data-title="${je(a.title||"")}"
              data-url="${je(a.document_url||"")}"
              title=""
              aria-label=""
            >
              
            </button>
            <a href="${je(a.document_url||"#")}" target="_blank" rel="noopener noreferrer"></a>
          </div>
        </td>
        <td class="text-end">
          <div class="d-inline-flex gap-2">
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              data-document-action="edit"
              data-id="${a.id}"
              data-title="${je(a.title||"")}"
              data-category-id="${a.category_id||""}"
              data-url="${je(a.document_url||"")}"
              data-storage-path="${je(a.storage_path||"")}"
              data-notes="${je(a.notes||"")}"
            >
              
            </button>
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              data-document-action="delete"
              data-id="${a.id}"
            >
              
            </button>
          </div>
        </td>
      </tr>
    `}).join("")}const os="documents-files";async function Wp(e){const t=await ue("../documents.html",import.meta.url);e.innerHTML=t,zp(e),await hs(e)}async function hs(e){await Bp(e),await Kp(e)}function zp(e){var f,p,_,y,b,g,S,k,E;const t=e.querySelector("#open-create-document-category"),r=e.querySelector("#open-create-document"),s=e.querySelector("#document-category-modal"),n=e.querySelector("#document-modal"),a=e.querySelector("#document-category-delete-modal"),i=e.querySelector("#document-delete-modal"),o=e.querySelector("#document-preview-modal"),l=e.querySelector("#document-category-form"),c=e.querySelector("#document-form"),d=e.querySelector("#document-categories-table-body"),u=e.querySelector("#documents-table-body"),h=e.querySelector("#documents-search"),m=e.querySelector("#documents-category-filter");t==null||t.addEventListener("click",()=>{Ll(e),Et(s)}),r==null||r.addEventListener("click",()=>{if(!(xe.categories||[]).length){v("  .","warning");return}ql(e),Pa(e),Et(n)}),l==null||l.addEventListener("submit",async L=>{L.preventDefault(),await Vp(e)}),c==null||c.addEventListener("submit",async L=>{L.preventDefault(),await Gp(e)}),(f=e.querySelector("#document-category-modal-close"))==null||f.addEventListener("click",()=>Fe(s)),(p=e.querySelector("#document-category-cancel-btn"))==null||p.addEventListener("click",()=>Fe(s)),(_=e.querySelector("#document-modal-close"))==null||_.addEventListener("click",()=>Fe(n)),(y=e.querySelector("#document-cancel-btn"))==null||y.addEventListener("click",()=>Fe(n)),(b=e.querySelector("#document-category-delete-cancel"))==null||b.addEventListener("click",()=>Fe(a)),(g=e.querySelector("#document-delete-cancel"))==null||g.addEventListener("click",()=>Fe(i)),(S=e.querySelector("#document-preview-close"))==null||S.addEventListener("click",()=>ty(e)),(k=e.querySelector("#document-category-delete-confirm"))==null||k.addEventListener("click",async()=>{const L=e.querySelector("#document-category-delete-id").value;await Jp(e,L)}),(E=e.querySelector("#document-delete-confirm"))==null||E.addEventListener("click",async()=>{const L=e.querySelector("#document-delete-id").value;await Qp(e,L)}),d==null||d.addEventListener("click",L=>{const $=L.target.closest("button[data-category-action]");if(!$)return;const q=$.getAttribute("data-category-action");if(q==="edit"){Yp(e,{id:$.getAttribute("data-id"),name:$.getAttribute("data-name")}),Et(s);return}q==="delete"&&(e.querySelector("#document-category-delete-id").value=$.getAttribute("data-id")||"",Et(a))}),u==null||u.addEventListener("click",L=>{const $=L.target.closest("button[data-document-action]");if(!$)return;const q=$.getAttribute("data-document-action");if(q==="edit"){Xp(e,{id:$.getAttribute("data-id"),title:$.getAttribute("data-title"),categoryId:$.getAttribute("data-category-id"),url:$.getAttribute("data-url"),storagePath:$.getAttribute("data-storage-path"),notes:$.getAttribute("data-notes")}),Et(n);return}if(q==="delete"){e.querySelector("#document-delete-id").value=$.getAttribute("data-id")||"",Et(i);return}if(q==="preview"){const T=String($.getAttribute("data-url")||"").trim(),C=String($.getAttribute("data-title")||"").trim();ey(e,T,C)}}),h==null||h.addEventListener("input",L=>{xe.searchQuery=L.target.value.trim().toLowerCase(),Qs(e)}),m==null||m.addEventListener("change",L=>{xe.categoryFilter=L.target.value||"",Qs(e)}),Fp("documents-page",[o,i,a,n,s])}async function Vp(e){var o,l;const t=e.querySelector("#document-category-id").value,r=e.querySelector("#document-category-name"),s=e.querySelector("#document-category-save-btn"),n=r.value.trim();if(!n){v("   .","warning");return}const a=s.innerHTML;s.disabled=!0,s.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let i=null;if(t)({error:i}=await w.from("document_categories").update({name:n,updated_at:new Date().toISOString()}).eq("id",t));else{const{data:c}=await w.auth.getUser(),d=((o=c==null?void 0:c.user)==null?void 0:o.id)??((l=c==null?void 0:c.user)==null?void 0:l.email)??"web_app";({error:i}=await w.from("document_categories").insert({name:n,created_from:d}))}if(s.disabled=!1,s.innerHTML=a,i){if(i.code==="23505"){v("     .","warning");return}v(i.message,"error");return}Fe(e.querySelector("#document-category-modal")),Ll(e),await hs(e),v(t?"  .":"  .","success")}async function Gp(e){var f,p,_,y,b,g;const t=e.querySelector("#document-id").value,r=e.querySelector("#document-title").value.trim(),s=e.querySelector("#document-category").value||null,n=((f=e.querySelector("#document-current-file-link"))==null?void 0:f.getAttribute("href"))||"",a=((_=(p=e.querySelector("#document-current-file-link"))==null?void 0:p.dataset)==null?void 0:_.storagePath)||"",i=e.querySelector("#document-file"),o=((y=i==null?void 0:i.files)==null?void 0:y[0])||null,l=e.querySelector("#document-notes").value.trim()||null,c=e.querySelector("#document-save-btn");if(!r||!s){v("   .","warning");return}if(!t&&!o){v("   .","warning");return}const d=c.innerHTML;c.disabled=!0,c.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';let u=null,h=n,m=a;if(o){const S=await Zp(o);if(S.error){c.disabled=!1,c.innerHTML=d,v(S.error.message||"     .","error");return}h=S.publicUrl,m=S.path}if(t)({error:u}=await w.from("documents").update({title:r,category_id:s,document_url:h,storage_path:m,notes:l,updated_at:new Date().toISOString()}).eq("id",t));else{const{data:S}=await w.auth.getUser(),k=((b=S==null?void 0:S.user)==null?void 0:b.id)??((g=S==null?void 0:S.user)==null?void 0:g.email)??"web_app";({error:u}=await w.from("documents").insert({title:r,category_id:s,document_url:h,storage_path:m,notes:l,created_from:k}))}if(c.disabled=!1,c.innerHTML=d,u){o&&m&&await w.storage.from(os).remove([m]),v(u.message,"error");return}t&&o&&a&&a!==m&&await w.storage.from(os).remove([a]),Fe(e.querySelector("#document-modal")),ql(e),await hs(e),v(t?"  .":"  .","success")}async function Jp(e,t){const r=e.querySelector("#document-category-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{count:n,error:a}=await w.from("documents").select("id",{count:"exact",head:!0}).eq("category_id",t);if(a){r.disabled=!1,r.innerHTML=s,v(a.message,"error");return}if((n||0)>0){r.disabled=!1,r.innerHTML=s,v("     ,   .","warning");return}const{error:i}=await w.from("document_categories").delete().eq("id",t);if(r.disabled=!1,r.innerHTML=s,i){v(i.message,"error");return}Fe(e.querySelector("#document-category-delete-modal")),await hs(e),v("  .","success")}async function Qp(e,t){const r=e.querySelector("#document-delete-confirm"),s=r.innerHTML;r.disabled=!0,r.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...';const{data:n}=await w.from("documents").select("storage_path").eq("id",t).maybeSingle(),{error:a}=await w.from("documents").delete().eq("id",t);if(r.disabled=!1,r.innerHTML=s,a){v(a.message,"error");return}n!=null&&n.storage_path&&await w.storage.from(os).remove([n.storage_path]),Fe(e.querySelector("#document-delete-modal")),await hs(e),v("  .","success")}function Yp(e,t){e.querySelector("#document-category-id").value=t.id||"",e.querySelector("#document-category-name").value=t.name||"",e.querySelector("#document-category-form-title").textContent="  ",e.querySelector("#document-category-save-btn").textContent=""}function Ll(e){e.querySelector("#document-category-id").value="",e.querySelector("#document-category-name").value="",e.querySelector("#document-category-form-title").textContent=" ",e.querySelector("#document-category-save-btn").textContent=""}function Xp(e,t){Pa(e);const r=e.querySelector("#document-file"),s=e.querySelector("#document-file-help"),n=e.querySelector("#document-current-file-wrap"),a=e.querySelector("#document-current-file-link");e.querySelector("#document-id").value=t.id||"",e.querySelector("#document-title").value=t.title||"",e.querySelector("#document-category").value=t.categoryId||"",e.querySelector("#document-notes").value=t.notes||"",r&&(r.value="",r.required=!1),s&&(s.textContent=" :   ,    ."),n&&a&&t.url&&(n.classList.remove("d-none"),a.setAttribute("href",t.url),a.dataset.storagePath=t.storagePath||""),e.querySelector("#document-form-title").textContent="  ",e.querySelector("#document-save-btn").textContent=""}function ql(e){const t=e.querySelector("#document-file"),r=e.querySelector("#document-file-help"),s=e.querySelector("#document-current-file-wrap"),n=e.querySelector("#document-current-file-link");e.querySelector("#document-id").value="",e.querySelector("#document-title").value="",e.querySelector("#document-category").value="",e.querySelector("#document-notes").value="",t&&(t.value="",t.required=!0),r&&(r.textContent="   ."),s&&s.classList.add("d-none"),n&&(n.setAttribute("href","#"),n.dataset.storagePath=""),e.querySelector("#document-form-title").textContent=" ",e.querySelector("#document-save-btn").textContent=""}async function Zp(e){var l,c;const{data:t}=await w.auth.getSession(),r=((c=(l=t==null?void 0:t.session)==null?void 0:l.user)==null?void 0:c.id)||"anonymous",s=Date.now(),n=String((e==null?void 0:e.name)||"document").replace(/[^a-zA-Z0-9._-]/g,"_"),a=`${r}/${s}_${n}`,{error:i}=await w.storage.from(os).upload(a,e,{upsert:!1});if(i)return{error:i};const{data:o}=w.storage.from(os).getPublicUrl(a);return{path:a,publicUrl:(o==null?void 0:o.publicUrl)||"",error:null}}function ey(e,t,r){const s=e.querySelector("#document-preview-modal"),n=e.querySelector("#document-preview-frame"),a=e.querySelector("#document-preview-text-wrap"),i=e.querySelector("#document-preview-text"),o=e.querySelector("#document-preview-csv-wrap"),l=e.querySelector("#document-preview-csv-note"),c=e.querySelector("#document-preview-csv-head"),d=e.querySelector("#document-preview-csv-body"),u=e.querySelector("#document-preview-title"),h=e.querySelector("#document-preview-fallback"),m=e.querySelector("#document-preview-open");if(!s||!n||!a||!i||!o||!l||!c||!d||!u||!h||!m)return;const f=String(t||"").trim();if(!f){v("   .","warning");return}const p=ay(f),_=da(f),y=_==="csv",b=["txt","csv","json"].includes(_);u.textContent=r?`: ${r}`:"  ",m.setAttribute("href",f),h.classList.add("d-none"),a.classList.add("d-none"),o.classList.add("d-none"),l.textContent="",c.innerHTML="",d.innerHTML="",i.textContent="",n.classList.remove("d-none"),n.src="about:blank",y?(o.classList.remove("d-none"),n.classList.add("d-none"),ry(f,c,d,l,h)):b?(a.classList.remove("d-none"),n.classList.add("d-none"),i.textContent="...",ny(f,i,h)):(n.src=p,n.onload=()=>{if(p!==f){h.classList.add("d-none");return}const g=da(f),S=["doc","docx","xls","xlsx","ppt","pptx"].includes(g);h.classList.toggle("d-none",!S)},n.onerror=()=>{h.classList.remove("d-none")}),Et(s)}function ty(e){const t=e.querySelector("#document-preview-modal"),r=e.querySelector("#document-preview-frame"),s=e.querySelector("#document-preview-text-wrap"),n=e.querySelector("#document-preview-text"),a=e.querySelector("#document-preview-csv-wrap"),i=e.querySelector("#document-preview-csv-note"),o=e.querySelector("#document-preview-csv-head"),l=e.querySelector("#document-preview-csv-body"),c=e.querySelector("#document-preview-fallback"),d=e.querySelector("#document-preview-open");!t||!r||!s||!n||!a||!i||!o||!l||!c||!d||(r.src="about:blank",r.classList.remove("d-none"),s.classList.add("d-none"),a.classList.add("d-none"),n.textContent="",i.textContent="",o.innerHTML="",l.innerHTML="",d.setAttribute("href","#"),c.classList.add("d-none"),Fe(t))}async function ry(e,t,r,s,n){try{const a=await fetch(e,{cache:"no-store"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const i=await a.text(),o=sy(i);if(!o.length){t.innerHTML="",r.innerHTML="",s.textContent="  .",n.classList.add("d-none");return}const l=200,c=o.slice(0,l),d=c[0]||[],u=c.slice(1);t.innerHTML=`
      <tr>${d.map(h=>`<th>${yo(h)}</th>`).join("")}</tr>
    `,r.innerHTML=u.map(h=>`<tr>${h.map(m=>`<td>${yo(m)}</td>`).join("")}</tr>`).join(""),o.length>l?s.textContent=`   ${l}    ${o.length}.`:s.textContent=`: ${o.length}.`,n.classList.add("d-none")}catch{t.innerHTML="",r.innerHTML="",s.textContent="",n.classList.remove("d-none")}}function sy(e){const t=[];let r=[],s="",n=!1;for(let a=0;a<e.length;a+=1){const i=e[a],o=e[a+1];if(i==='"'){n&&o==='"'?(s+='"',a+=1):n=!n;continue}if(!n&&i===","){r.push(s),s="";continue}if(!n&&(i===`
`||i==="\r")){i==="\r"&&o===`
`&&(a+=1),r.push(s),t.push(r),r=[],s="";continue}s+=i}return(s.length||r.length)&&(r.push(s),t.push(r)),t}async function ny(e,t,r){try{const s=await fetch(e,{cache:"no-store"});if(!s.ok)throw new Error(`HTTP ${s.status}`);const n=await s.text();t.textContent=n||"( )",r.classList.add("d-none")}catch{t.textContent="    .",r.classList.remove("d-none")}}function ay(e){const t=da(e);return["doc","docx","xls","xlsx","ppt","pptx"].includes(t)?`https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(e)}`:e}function da(e){const t=String(e||"").trim();if(!t)return"";try{const s=new URL(t).pathname.split("/").pop()||"",n=s.includes(".")?s.split(".").pop():"";return String(n||"").toLowerCase()}catch{return""}}function yo(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function Ma(e){e==null||e.classList.remove("d-none"),document.body.classList.add("overflow-hidden")}const go=new Map;function iy(e,t){const r=go.get(e);r&&document.removeEventListener("keydown",r);const s=n=>{if(n.key==="Escape"){for(const a of t)if(a&&!a.classList.contains("d-none")){bt(a);return}}};go.set(e,s),document.addEventListener("keydown",s)}function bt(e){var t,r,s;e==null||e.classList.add("d-none"),(t=document.querySelector("#user-profile-view-modal"))!=null&&t.classList.contains("d-none")&&((r=document.querySelector("#user-profile-edit-modal"))!=null&&r.classList.contains("d-none"))&&((s=document.querySelector("#user-profile-reset-confirm-modal"))!=null&&s.classList.contains("d-none"))&&document.body.classList.remove("overflow-hidden")}function Nr(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function ua(e){var n,a;const t=String(((n=e==null?void 0:e.employees)==null?void 0:n.first_name)||"").trim(),r=String(((a=e==null?void 0:e.employees)==null?void 0:a.last_name)||"").trim();return`${t} ${r}`.trim()||"-"}const ae={rows:[],employees:[],searchQuery:"",isAdmin:!1,currentUserId:"",resetConfirmResolver:null};function ha(e,t){const r=e.querySelector("#user-profiles-table-body"),s=e.querySelector("#user-profiles-empty"),n=(ae.rows||[]).filter(a=>{const i=[a==null?void 0:a.username,a==null?void 0:a.email,a==null?void 0:a.first_name,a==null?void 0:a.last_name,ua(a)].map(o=>String(o||"").toLowerCase()).join(" ");return!ae.searchQuery||i.includes(ae.searchQuery)});if(!n.length){r.innerHTML="",s.classList.remove("d-none"),s.textContent=t||"  .";return}s.classList.add("d-none"),r.innerHTML=n.map(a=>{const i=`${String((a==null?void 0:a.first_name)||"").trim()} ${String((a==null?void 0:a.last_name)||"").trim()}`.trim()||"-",o=ua(a);return`
        <tr>
          <td>${Nr((a==null?void 0:a.username)||"-")}</td>
          <td>${Nr((a==null?void 0:a.email)||"-")}</td>
          <td>${Nr(i)}</td>
          <td>${Nr(o)}</td>
          <td class="text-end">
            <div class="d-inline-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-user-profile-action="view"
                data-id="${a.id}"
              >
                
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-primary"
                data-user-profile-action="edit"
                data-id="${a.id}"
              >
                
              </button>
              ${ae.isAdmin?`
                <button
                  type="button"
                  class="btn btn-sm btn-outline-warning"
                  data-user-profile-action="reset-password"
                  data-id="${a.id}"
                >
                  Reset 
                </button>
              `:""}
            </div>
          </td>
        </tr>
      `}).join("")}function oy(e){const t=e.querySelector("#user-profile-edit-employee-id");if(!t)return;const r=(ae.employees||[]).map(s=>{const n=`${String((s==null?void 0:s.first_name)||"").trim()} ${String((s==null?void 0:s.last_name)||"").trim()}`.trim()||"-";return`<option value="${s.id}">${Nr(n)}</option>`}).join("");t.innerHTML='<option value="">  </option>'+r}async function ly(e){const t=await ue("../user-profiles.html",import.meta.url);e.innerHTML=t,cy(e),hy(e),await fa(e)}function cy(e){e.querySelectorAll("button[data-toggle-password]").forEach(t=>{t.addEventListener("click",()=>{const r=t.getAttribute("data-toggle-password")||"",s=e.querySelector(`#${r}`);if(!s)return;const n=s.type==="password";s.type=n?"text":"password",t.textContent=n?"":"";const a=r.includes("confirm"),i=a?"    ":"  ",o=a?"    ":"  ";t.setAttribute("aria-label",n?o:i)})})}function dy(){return`${window.location.origin}/reset-password`}function Rs(e,t){const r=ae.resetConfirmResolver;r&&(ae.resetConfirmResolver=null,bt(e.querySelector("#user-profile-reset-confirm-modal")),r(!!t))}function uy(e,t){const r=e.querySelector("#user-profile-reset-confirm-modal"),s=e.querySelector("#user-profile-reset-confirm-message");if(!r||!s)return Promise.resolve(!1);if(ae.resetConfirmResolver){const n=ae.resetConfirmResolver;ae.resetConfirmResolver=null,n(!1)}return s.textContent=`          ${t}?`,Ma(r),new Promise(n=>{ae.resetConfirmResolver=n})}function hy(e){var i,o,l,c,d,u,h,m;const t=e.querySelector("#user-profiles-search"),r=e.querySelector("#user-profiles-table-body"),s=e.querySelector("#user-profile-view-modal"),n=e.querySelector("#user-profile-edit-modal"),a=e.querySelector("#user-profile-reset-confirm-modal");t==null||t.addEventListener("input",f=>{var p;ae.searchQuery=String(((p=f.target)==null?void 0:p.value)||"").trim().toLowerCase(),ha(e)}),r==null||r.addEventListener("click",f=>{const p=f.target.closest("button[data-user-profile-action]");if(!p)return;const _=p.getAttribute("data-user-profile-action"),y=p.getAttribute("data-id")||"";if(_==="view"){my(e,y);return}if(_==="edit"){py(e,y);return}_==="reset-password"&&fy(e,y,p)}),(i=e.querySelector("#user-profile-view-close"))==null||i.addEventListener("click",()=>bt(s)),(o=e.querySelector("#user-profile-view-close-secondary"))==null||o.addEventListener("click",()=>bt(s)),(l=e.querySelector("#user-profile-edit-close"))==null||l.addEventListener("click",()=>bt(n)),(c=e.querySelector("#user-profile-edit-cancel"))==null||c.addEventListener("click",()=>bt(n)),(d=e.querySelector("#user-profile-reset-confirm-close"))==null||d.addEventListener("click",()=>Rs(e,!1)),(u=e.querySelector("#user-profile-reset-confirm-cancel"))==null||u.addEventListener("click",()=>Rs(e,!1)),(h=e.querySelector("#user-profile-reset-confirm-accept"))==null||h.addEventListener("click",()=>Rs(e,!0)),a==null||a.addEventListener("click",f=>{f.target===a&&Rs(e,!1)}),(m=e.querySelector("#user-profile-edit-form"))==null||m.addEventListener("submit",async f=>{f.preventDefault(),await yy(e)}),iy("user-profiles",[a,n,s])}async function fy(e,t,r){if(!ae.isAdmin){v("    .","warning");return}const s=ae.rows.find(d=>d.id===t);if(!s){v("   .","warning");return}const n=String(s.email||"").trim();if(!n){v("   .","warning");return}const i=`${String(s.first_name||"").trim()} ${String(s.last_name||"").trim()}`.trim()||s.username||n;if(!await uy(e,i))return;const l=(r==null?void 0:r.innerHTML)||"Reset ";r&&(r.disabled=!0,r.innerHTML="...");const{error:c}=await w.auth.resetPasswordForEmail(n,{redirectTo:dy()});if(r&&(r.disabled=!1,r.innerHTML=l),c){v(c.message||"       .","error");return}v("        .","success")}async function fa(e){var c,d;const t=await hr(),r=((c=t==null?void 0:t.user)==null?void 0:c.id)||"";ae.currentUserId=r,ae.isAdmin=await cu();const s=e.querySelector("#user-profiles-search");s&&(s.classList.toggle("d-none",!ae.isAdmin),(d=s.previousElementSibling)==null||d.classList.toggle("d-none",!ae.isAdmin));const n=w.from("user_profiles").select("id, username, email, first_name, last_name, employee_id, employees(id, first_name, last_name)").order("username",{ascending:!0});!ae.isAdmin&&r&&n.eq("id",r);const[{data:a,error:i},{data:o,error:l}]=await Promise.all([n,ae.isAdmin?w.from("employees").select("id, first_name, last_name").order("last_name",{ascending:!0}).order("first_name",{ascending:!0}):Promise.resolve({data:[],error:null})]);if(i||l){v((i==null?void 0:i.message)||(l==null?void 0:l.message)||"    .","error"),ae.rows=[],ae.employees=[],ha(e,"   .");return}ae.rows=a||[],ae.employees=o||[],oy(e),ha(e)}function my(e,t){const r=ae.rows.find(s=>s.id===t);if(!r){v("   .","warning");return}e.querySelector("#user-profile-view-username").textContent=r.username||"-",e.querySelector("#user-profile-view-email").textContent=r.email||"-",e.querySelector("#user-profile-view-first-name").textContent=r.first_name||"-",e.querySelector("#user-profile-view-last-name").textContent=r.last_name||"-",e.querySelector("#user-profile-view-employee").textContent=ua(r),Ma(e.querySelector("#user-profile-view-modal"))}function py(e,t){const r=ae.rows.find(l=>l.id===t);if(!r){v("   .","warning");return}const s=e.querySelector("#user-profile-edit-employee-wrap"),n=e.querySelector("#user-profile-password-wrap"),a=e.querySelector("#user-profile-edit-new-password"),i=e.querySelector("#user-profile-edit-confirm-password");s&&s.classList.toggle("d-none",!ae.isAdmin);const o=r.id===ae.currentUserId;n&&n.classList.toggle("d-none",!o),a&&(a.value=""),i&&(i.value=""),e.querySelector("#user-profile-edit-id").value=r.id,e.querySelector("#user-profile-edit-username").value=r.username||"",e.querySelector("#user-profile-edit-email").value=r.email||"",e.querySelector("#user-profile-edit-first-name").value=r.first_name||"",e.querySelector("#user-profile-edit-last-name").value=r.last_name||"",e.querySelector("#user-profile-edit-employee-id").value=r.employee_id||"",Ma(e.querySelector("#user-profile-edit-modal"))}async function yy(e){var p,_,y,b,g,S,k,E;const t=(((p=e.querySelector("#user-profile-edit-id"))==null?void 0:p.value)||"").trim(),r=(((_=e.querySelector("#user-profile-edit-username"))==null?void 0:_.value)||"").trim(),s=(((y=e.querySelector("#user-profile-edit-email"))==null?void 0:y.value)||"").trim(),n=(((b=e.querySelector("#user-profile-edit-first-name"))==null?void 0:b.value)||"").trim(),a=(((g=e.querySelector("#user-profile-edit-last-name"))==null?void 0:g.value)||"").trim(),i=((S=e.querySelector("#user-profile-edit-new-password"))==null?void 0:S.value)||"",o=((k=e.querySelector("#user-profile-edit-confirm-password"))==null?void 0:k.value)||"",l=((E=e.querySelector("#user-profile-edit-employee-id"))==null?void 0:E.value)||null,c=e.querySelector("#user-profile-edit-save"),d=t===ae.currentUserId;if(!t||!r||!s||!n||!a){v("   .","warning");return}if(!/^[A-Za-z0-9_]{3,30}$/.test(r)){v("     3-30       ,   _.","warning");return}if((i||o)&&!d){v("        .","warning");return}if(d&&(i||o)){if(i.length<6){v("      6 .","warning");return}const L=/[\u0400-\u04FF]/;if(L.test(i)||L.test(o)){v("     .","warning");return}if(i!==o){v("     .","warning");return}}const h=(c==null?void 0:c.innerHTML)||"";c&&(c.disabled=!0,c.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>...');const m={username:r,email:s,first_name:n,last_name:a,updated_at:new Date().toISOString()};ae.isAdmin&&(m.employee_id=l||null);const{error:f}=await w.from("user_profiles").update(m).eq("id",t);if(c&&(c.disabled=!1,c.innerHTML=h),f){if(f.code==="23505"){v("     .","warning");return}v(f.message,"error");return}if(d&&i){const{error:L}=await w.auth.updateUser({password:i});if(L){v(L.message||"  ,     .","warning"),await fa(e),bt(e.querySelector("#user-profile-edit-modal"));return}}bt(e.querySelector("#user-profile-edit-modal")),await fa(e),v(d&&i?"    .":"  .","success")}const vo={"/":{render:zu,title:"TrainCrewHub"},"/login":{render:Gu,title:"TrainCrewHub / Sign In"},"/register":{render:Yu,title:"TrainCrewHub / Register"},"/forgot-password":{render:rh,title:"TrainCrewHub / Forgot Password"},"/reset-password":{render:ih,title:"TrainCrewHub / Reset Password"},"/pending-access":{render:lh,title:"TrainCrewHub /  "},"/schedule-keys":{render:dh,title:"TrainCrewHub / -",resource:"schedule_keys"},"/duties":{render:kh,title:"TrainCrewHub / ",resource:"duties"},"/duty-types":{render:Rm,title:"TrainCrewHub /  ",resource:"duty_types"},"/trains":{render:cp,title:"TrainCrewHub / ",resource:"trains"},"/employees":{render:zh,title:"TrainCrewHub / ",resource:"employees"},"/employee-absences":{render:ef,title:"TrainCrewHub / ",resource:"employee_absences"},"/planned-duties":{render:kf,title:"TrainCrewHub /  ",resource:"planned_duties"},"/actual-duties":{render:Cf,title:"TrainCrewHub /  ",resource:"actual_duties"},"/plan-schedule":{render:dm,title:"TrainCrewHub /  ",screenResource:"page_plan_schedule",resource:"planned_duties"},"/schedule":{render:$m,title:"TrainCrewHub / ",screenResource:"page_schedule",resource:"actual_duties"},"/schedule-key-duties":{render:Bm,title:"TrainCrewHub /   -",resource:"duties"},"/documents":{render:Wp,title:"TrainCrewHub / ",resource:"documents"},"/user-profiles":{render:ly,title:"TrainCrewHub /  "},"/admin":{render:Tp,title:"TrainCrewHub /  ",requiresAdmin:!0}},gy="page-content",vy={none:" ",all:"",own:"",role_attached_employees:"    "};function by(e){return e==="all"?"text-bg-success":e==="own"||e==="role_attached_employees"?"text-bg-warning":"text-bg-secondary"}async function _y(e,t){if(!e||!t||!Ho())return;const r=await hu(t),s=tn(t),a=[{label:"",key:"view_screen"},{label:" ",key:"view_records"},{label:"",key:"create_records"},{label:"",key:"edit_records"},{label:"",key:"delete_records"}].map(({label:o,key:l})=>{const c=r[l]||"none",d=vy[c]||c,u=by(c);return`
        <span class="me-3 mb-2 d-inline-flex align-items-center gap-2">
          <span class="text-secondary small">${o}:</span>
          <span class="badge ${u}">${d}</span>
        </span>
      `}).join(""),i=document.createElement("div");i.className="alert alert-light border d-flex flex-wrap align-items-center gap-1 mb-3",i.innerHTML=`
    <span class="fw-semibold me-2">  ${s}</span>
    ${a}
  `,e.prepend(i)}function bo(e){return vo[e]??vo["/"]}async function Sy(e,t){var a,i,o,l;const r=new Set(["/login","/register","/forgot-password","/reset-password"]);let s=null;if(!r.has(e)){const c=await pi();if(!c.allowed)return c.reason==="inactive-profile"&&v("  .    .","warning"),"/login";if(s=await hr(),!((a=s==null?void 0:s.user)!=null&&a.id))return"/login";if(!await Un(s.user.id))return e==="/pending-access"?e:(v("     .","warning"),"/pending-access")}if(e==="/pending-access"){if(!((i=s==null?void 0:s.user)!=null&&i.id)){const d=await pi();if(!d.allowed)return d.reason==="inactive-profile"&&v("  .    .","warning"),"/login";s=await hr()}return(o=s==null?void 0:s.user)!=null&&o.id?await Un(s.user.id)?"/":e:"/login"}if(!(t!=null&&t.requiresAdmin)){const c=(t==null?void 0:t.screenResource)||(t==null?void 0:t.resource)||"";return!c||await No(c)?e:(v("      .","warning"),"/")}return s=s||await hr(),(l=s==null?void 0:s.user)!=null&&l.id?await ga(s.user.id)?e:(v("      .","warning"),"/"):"/login"}async function ma(){const e=document.getElementById(gy);mu();const t=window.location.pathname,r=bo(t),s=await Sy(t,r);s!==t&&window.history.replaceState({},"",s);const n=bo(s);document.title=n.title,await n.render(e),n.resource&&(await _y(e,n.resource),await fu(e,n.resource)),window.dispatchEvent(new CustomEvent("route:changed",{detail:{pathname:s}}))}function wy(e){const t=e.target.closest("a[data-link]");if(!t)return;e.preventDefault();const r=t.getAttribute("href");r!==window.location.pathname&&(window.history.pushState({},"",r),ma())}function ky(){jo(),window.addEventListener("popstate",ma),document.addEventListener("click",wy),ma()}const Ly=document.getElementById("app");async function qy(){await vu(Ly),ky()}qy();
